From no-reply at zwischenwelt.org  Tue Jul  1 01:43:21 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 30 Jun 2008 23:43:21 -0000
Subject: [Iris-commit] [IRIS] r2274 - in /trunk: data/base/main.material
 lua/gui/gui.gumpparser.lua lua/lib.gump.samples.lua
 widgets/widget.uoimage.lua widgets/widget.uotext.lua
Message-ID: <20080630234321.7BA5F1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Jul  1 01:43:21 2008
New Revision: 2274

Log:
uoimage : checker-workaround, uotext : startet html-parser

Modified:
    trunk/data/base/main.material
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.gump.samples.lua
    trunk/widgets/widget.uoimage.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/data/base/main.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/main.material (original)
+++ trunk/data/base/main.material Tue Jul  1 01:43:21 2008
@@ -30,10 +30,34 @@
 				filtering point point none
 				tex_address_mode clamp
 				=

-				texture guibase.png 2d 0
+				//texture guibase.png 2d 0
 				//colour_op_ex modulate src_texture src_diffuse =

 				//alpha_op_ex  source1 src_texture src_texture
 			}
+		}
+	}
+}
+
+material guibasemat_plaincolor
+{
+	technique
+	{
+		pass
+		{
+			ambient  1.0 1.0 1.0 1.0
+			specular 0.0 0.0 0.0 1.0
+			=

+			// ambient vertexcolour
+			// diffuse vertexcolour
+			=

+			cull_hardware none
+			cull_software none
+
+			scene_blend alpha_blend
+			=

+			// lighting off
+			depth_write off
+			depth_check off
 		}
 	}
 }

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Tue Jul  1 01:43:21 2008
@@ -33,9 +33,10 @@
 	kClientSideGump_Skill			=3D skillGump			-- the big skill list dialog with=
 up/down/lock boxes, grab icons and scrollbar
 	kClientSideGump_Journal			=3D journalGump	-- a very simple message log in=
 papyrus-scroll look
 	]]--
-	-- kGumpSample_RuneBook kGumpSample_ChangeLog kGumpSample_Reward
+	local testgump,x,y =3D kGumpSample_ChangeLog,400,00
+	--~ local testgump,x,y =3D kGumpSample_ChangeLog_Text,400,00
 	--~ local testgump,x,y =3D kGumpSample_RuneBook,0,240
-	local testgump,x,y =3D kGumpSample_Reward,0,140
+	--~ local testgump,x,y =3D kGumpSample_Reward,0,140
 	local profiler =3D MakeProfiler("gumpparser")
 	profiler:StartSection("font:preload")
 	GetUOFont(gUniFontLoaderList[1],true):PreLoad()
@@ -378,13 +379,13 @@
 kGumpParser_CommandTypes["page"]				=3D {paramformat=3D"pagenum"}
 kGumpParser_CommandTypes["xmfhtmlgump"]			=3D {paramformat=3D"x,y,width,he=
ight,cliloc_id,background,scrollbar,[ctrlname]"}
 kGumpParser_CommandTypes["xmfhtmlgumpcolor"]	=3D {paramformat=3D"x,y,width=
,height,cliloc_id,background,scrollbar,hue,[ctrlname]"}
-kGumpParser_CommandTypes["croppedtext"]			=3D {paramformat=3D"x,y,width,he=
ight,hue,textline_id,[ctrlname]",paramadd=3D{bold =3D true}}
+kGumpParser_CommandTypes["croppedtext"]			=3D {paramformat=3D"x,y,width,he=
ight,hue,textline_id,[ctrlname]",paramadd=3D{bold=3Dtrue,crop=3Dtrue}}
 kGumpParser_CommandTypes["htmlgump"]			=3D {paramformat=3D"x,y,width,heigh=
t,textline_id,background,scrollbar,[ctrlname]"}
 kGumpParser_CommandTypes["text"]				=3D {paramformat=3D"x,y,hue,textline_i=
d,[ctrlname]"}
 kGumpParser_CommandTypes["tooltip"]				=3D {paramformat=3D"cliloc_id,[ctrl=
name]"}
-kGumpParser_CommandTypes["resizepic"]			=3D {paramformat=3D"x,y,gump_id,wi=
dth,height,[ctrlname]",paramadd=3D{multipart =3D true}}
-kGumpParser_CommandTypes["gumppictiled"]		=3D {paramformat=3D"x,y,width,he=
ight,gump_id,[ctrlname]",paramadd=3D{tiled =3D true}}
-kGumpParser_CommandTypes["checkertrans"]		=3D {paramformat=3D"x,y,width,he=
ight,[ctrlname]",paramadd=3D{checker =3D true}}
+kGumpParser_CommandTypes["resizepic"]			=3D {paramformat=3D"x,y,gump_id,wi=
dth,height,[ctrlname]",paramadd=3D{multipart=3Dtrue}}
+kGumpParser_CommandTypes["gumppictiled"]		=3D {paramformat=3D"x,y,width,he=
ight,gump_id,[ctrlname]",paramadd=3D{tiled=3Dtrue}}
+kGumpParser_CommandTypes["checkertrans"]		=3D {paramformat=3D"x,y,width,he=
ight,[ctrlname]",paramadd=3D{checker=3Dtrue}}
 kGumpParser_CommandTypes["tilepic"]				=3D {paramformat=3D"x,y,art_id,[ctr=
lname]"}
 kGumpParser_CommandTypes["tilepichue"]			=3D {paramformat=3D"x,y,art_id,hu=
e,[ctrlname]"}
 kGumpParser_CommandTypes["button"]				=3D {paramformat=3D"x,y,gump_id_norm=
al,gump_id_pressed,quit,page_id,[return_value],[ctrlname]"}

Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Tue Jul  1 01:43:21 2008
@@ -9,6 +9,7 @@
 	Data=3D"{ page 0 }{ resizepic 0 0 9270 350 272 }{ resizepic 10 35 9270 33=
0 227 }{ button 298 15 22153 22155 1 0 1 }{ button 319 15 22150 22152 1 0 0=
 }{ resizepic 81 10 9270 188 35 }{ text 91 17 2101 0 }{ resizepic 91 45 927=
0 168 35 }{ croppedtext 160 52 29 16 2101 1 }{ gumppictiled 30 81 290 162 2=
624 }{ checkertrans 30 81 290 162 }{ button 30 55 5603 5607 1 0 11 }{ butto=
n 304 55 5601 5605 1 0 11 }{ htmlgump 30 81 290 162 2 0 1 }",
 	textline=3D{
 		[1]=3D"News",
+		--~ [2]=3D"A\n\nB\nC",
 		[2]=3D"<CENTER><BIG>28.06.2008 by Lumberman<BR>-------------------------=
---------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Forum unter www=
.vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BIG>23.06.200=
8 by Lumberman<BR>----------------------------------</BIG></CENTER>Patch ei=
ngespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder im Changel=
og (Pfeil rechts)<BR><CENTER><BIG>15.06.2008 by Lumberman<BR>--------------=
--------------------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Foru=
m unter www.vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BI=
G>14.06.2008 by Lumberman<BR>----------------------------------</BIG></CENT=
ER>Patch eingespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder=
 im Changelog (Pfeil rechts)",
 		[0]=3D"Message of the Day - Main",
 		}

Modified: trunk/widgets/widget.uoimage.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoimage.lua (original)
+++ trunk/widgets/widget.uoimage.lua Tue Jul  1 01:43:21 2008
@@ -44,7 +44,7 @@
 	else
 		local matname,u0,v0,uvw,uvh,origw,origh,bitmask
 		if (params.gump_id	) then matname,u0,v0,uvw,uvh,origw,origh,bitmask =3D =
LoadGump(	"guibasemat",params.gump_id			,params.hue) end
-		if (params.art_id	) then matname,u0,v0,uvw,uvh,origw,origh,bitmask =3D L=
oadArt(	"guibasemat",params.art_id + 0x4000	,params.hue) end
+		if (params.art_id	) then matname,u0,v0,uvw,uvh,origw,origh,bitmask =3D L=
oadArt(		"guibasemat",params.art_id + 0x4000	,params.hue) end
 		if (params.checker	) then matname,u0,v0,uvw,uvh,origw,origh,bitmask =3D =
self:LoadChecker() end
 		self.origw =3D origw
 		self.origh =3D origh
@@ -83,9 +83,9 @@
 function gWidgetPrototype.UOImage:LoadChecker 	() =

 	local matname =3D gWidgetPrototype.UOImage.checker_matname
 	if (not matname) then =

-		local g =3D 0.3 -- grey
-		local r,g,b,a =3D g,g,g,0.5
-		matname =3D GetHuedMat("guibasemat",r,g,b,r,g,b,a)
+		local gray =3D 0.3 -- grey
+		local r,g,b,a =3D gray,gray,gray,0.5
+		matname =3D GetHuedMat("guibasemat_plaincolor",r,g,b,r,g,b,a)
 		gWidgetPrototype.UOImage.checker_matname =3D matname
 	end
 	return matname,0,0,1,1,32,32

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Tue Jul  1 01:43:21 2008
@@ -4,11 +4,12 @@
 =

 RegisterWidgetClass("UOText","Text")
 =

--- param : x,y,width,height,cliloc_id/textline_id,background=3D0/1=3Dtrans=
parent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse
+-- param : x,y,width,height,cliloc_id/textline_id,background=3D0/1=3Dtrans=
parent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse,crop=3Dfalse
 -- bold=3Doutlined_font: false for xmfhtmlgump,htmlgump, true for croppedt=
ext, example : runebook gump : kGumpSample_RuneBook
+-- crop : disables autowrap
 function gWidgetPrototype.UOText:Init (parentwidget, params, textlines)
 	--~ print("TODO:widget.UOText  : height,w/h-clip,background,scrollbar",pa=
rentwidget:GetClassName(),parentwidget.pagenum)
-	params.autowrap_w =3D params.width
+	if (not params.crop) then params.autowrap_w =3D params.width end
 	gWidgetPrototype.Text.Init(self,parentwidget,params)
 	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"))
 	self:SetLeftTop(params.x-1,params.y-22)
@@ -18,20 +19,54 @@
 	self.uohtml =3D uohtml
 	local font =3D GetUOFont(gUniFontLoaderList[1],self.params.bold)
 	local fontsize =3D nil
-	local textparam =3D {}
-	textparam.r,textparam.g,textparam.b =3D 1,1,1
-	if (not self.params.bold) then textparam.r,textparam.g,textparam.b =3D 0,=
0,0 end -- default:black
+	local textparam_white =3D {r=3D1,g=3D1,b=3D1}
+	local textparam_black =3D {r=3D0,g=3D0,b=3D0}
+	local textparam =3D textparam_black
+	if (not self.params.bold) then textparam =3D textparam_white end -- defau=
lt:black
 	if (self.params.hue) then textparam.r,textparam.g,textparam.b =3D gHueLoa=
der:GetColor(self.params.hue,31) end
 	-- uohtml =3D UnicodeFix(uohtml)  =C3=B6 -> oe  hack =

 	-- warning, uohtml might be an array of ints for unicode (textline) inste=
ad of text
 	-- see also HtmlParser in lib.gumpparser.lua
 	-- TODO : font hueing ? or just rgb vertexcolor
 	=

+	local bBig =3D false
+	local bCenter =3D false
+	local glyphlist =3D self.glyphlist
 	=

-	local text =3D uohtml
-	self.glyphlist:AddText(font,fontsize,text,textparam)
+	glyphlist:Clear()
+	=

+	print("uohtml start")
+	for plaintext,tag in string.gfind(uohtml, "([^<]*)(<?[^>]*>?)") do =

+		if (plaintext ~=3D "") then =

+			-- plain text
+			print("uohtml plain",plaintext)
+			glyphlist:AddText(font,fontsize,plaintext,textparam)
+		end
+		if (tag ~=3D "") then
+			-- html-tag
+			if (tag =3D=3D "<CENTER>") then end -- todo =

+			if (tag =3D=3D "</CENTER>") then end -- todo =

+			if (tag =3D=3D "<BIG>") then font =3D GetUOFont(gUniFontLoaderList[1],t=
rue) textparam =3D textparam_white glyphlist:AddNewLine() end
+			if (tag =3D=3D "</BIG>") then font =3D GetUOFont(gUniFontLoaderList[1],=
false) textparam =3D textparam_black glyphlist:AddNewLine() end
+			if (tag =3D=3D "<BR>") then glyphlist:AddNewLine() end
+			=

+			--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
+			--~ for token in string.gfind(textstring, "%w+") do table.insert(bToken=
,token) end
+			--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
+			=

+			print("uohtml tag",tag)
+		end
+	end
 	self:UpdateGeometry()
 end
+--[[
+<CENTER></CENTER>
+<BIG></BIG>
+<b></b>  // =3D big=3Dbold
+<BR>
+?basefont color size
+]]--
+
 --[[
 --xmfhtmlgump	<x> <y> <width> <height> <cliloc_id> <background> <scrollbar>
 --HtmlGump		<x> <y> <width> <height> <textline_id> <background> <scrollbar>



From no-reply at zwischenwelt.org  Tue Jul  1 01:57:16 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 30 Jun 2008 23:57:16 -0000
Subject: [Iris-commit] [IRIS] r2275 - /trunk/widgets/widget.uotext.lua
Message-ID: <20080630235717.627AE1C180A2@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Jul  1 01:57:13 2008
New Revision: 2275

Log:
improved uotext html parser

Modified:
    trunk/widgets/widget.uotext.lua

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Tue Jul  1 01:57:13 2008
@@ -1,6 +1,7 @@
 -- see also lib.gui.widget.lua
 -- see also lib.gui.widget.text.lua
 -- see also lib.glyphlist.lua
+-- TODO : font hueing needed ? so far rgb vertexcolor of the primary hue c=
olor seems to be enough
 =

 RegisterWidgetClass("UOText","Text")
 =

@@ -15,39 +16,43 @@
 	self:SetLeftTop(params.x-1,params.y-22)
 end
 =

+-- TODO : uohtml might be an array of ints for unicode (textline) instead =
of text (no html then)
+-- see also HtmlParser in lib.gumpparser.lua
 function gWidgetPrototype.UOText:SetUOHtml (uohtml,font)
 	self.uohtml =3D uohtml
-	local font =3D GetUOFont(gUniFontLoaderList[1],self.params.bold)
 	local fontsize =3D nil
-	local textparam_white =3D {r=3D1,g=3D1,b=3D1}
-	local textparam_black =3D {r=3D0,g=3D0,b=3D0}
-	local textparam =3D textparam_black
-	if (not self.params.bold) then textparam =3D textparam_white end -- defau=
lt:black
-	if (self.params.hue) then textparam.r,textparam.g,textparam.b =3D gHueLoa=
der:GetColor(self.params.hue,31) end
-	-- uohtml =3D UnicodeFix(uohtml)  =C3=B6 -> oe  hack =

-	-- warning, uohtml might be an array of ints for unicode (textline) inste=
ad of text
-	-- see also HtmlParser in lib.gumpparser.lua
-	-- TODO : font hueing ? or just rgb vertexcolor
+	local fontid =3D 1
+	local bold =3D self.params.bold
+	local col_white =3D {r=3D1,g=3D1,b=3D1}
+	local col_black =3D {r=3D0,g=3D0,b=3D0}
+	local col =3D bold and col_black or col_white
+	if (self.params.hue) then local r,g,b =3D gHueLoader:GetColor(self.params=
.hue,31) col =3D {r=3Dr,g=3Dg,b=3Db} end
 	=

 	local bBig =3D false
 	local bCenter =3D false
 	local glyphlist =3D self.glyphlist
 	=

+	local statestack =3D {}
+	table.insert(statestack,{fontid,bold,col})
+	=

+	=

 	glyphlist:Clear()
 	=

 	print("uohtml start")
 	for plaintext,tag in string.gfind(uohtml, "([^<]*)(<?[^>]*>?)") do =

+		local fontid,bold,col =3D unpack(statestack[#statestack])
 		if (plaintext ~=3D "") then =

 			-- plain text
 			print("uohtml plain",plaintext)
-			glyphlist:AddText(font,fontsize,plaintext,textparam)
+			local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
+			glyphlist:AddText(font,fontsize,plaintext,col)
 		end
 		if (tag ~=3D "") then
 			-- html-tag
-			if (tag =3D=3D "<CENTER>") then end -- todo =

-			if (tag =3D=3D "</CENTER>") then end -- todo =

-			if (tag =3D=3D "<BIG>") then font =3D GetUOFont(gUniFontLoaderList[1],t=
rue) textparam =3D textparam_white glyphlist:AddNewLine() end
-			if (tag =3D=3D "</BIG>") then font =3D GetUOFont(gUniFontLoaderList[1],=
false) textparam =3D textparam_black glyphlist:AddNewLine() end
+			if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

+			if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

+			if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end =
-- fontchange
+			if (tag =3D=3D "</BIG>") then table.remove(statestack) end
 			if (tag =3D=3D "<BR>") then glyphlist:AddNewLine() end
 			=

 			--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
@@ -60,6 +65,7 @@
 	self:UpdateGeometry()
 end
 --[[
+-- vetus-mundus changelog : big text =3D htmlgump.. todo : clip
 <CENTER></CENTER>
 <BIG></BIG>
 <b></b>  // =3D big=3Dbold



From no-reply at zwischenwelt.org  Tue Jul  1 02:21:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 01 Jul 2008 00:21:58 -0000
Subject: [Iris-commit] [IRIS] r2276 - /trunk/data/desktop/
Message-ID: <20080701002158.7260E1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Jul  1 02:21:58 2008
New Revision: 2276

Log:
added svn ignore for data/desktop/ contents (saved dialog/icon positions)

Modified:
    trunk/data/desktop/   (props changed)



From no-reply at zwischenwelt.org  Tue Jul  1 03:07:27 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 01 Jul 2008 01:07:27 -0000
Subject: [Iris-commit] [IRIS] r2277 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/lib.gump.samples.lua widgets/widget.uotext.lua
Message-ID: <20080701010727.946BD1C180A4@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Jul  1 03:07:26 2008
New Revision: 2277

Log:
uotext : fixed clipping and default colors

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.gump.samples.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Tue Jul  1 03:07:26 2008
@@ -44,9 +44,12 @@
 	profiler:StartSection("old")
 	GumpParser(testgump,false)
 	profiler:StartSection("new")
-	local dialog =3D GumpParser_New(testgump,false) dialog:SetLeftTop(x,y)
+	local dialog =3D GumpParser_New(testgump,false) dialog:SetPos(x,y)
 	profiler:Finish()
 	profiler:PrintTotalTime()
+	=

+	local testgump,x,y =3D kGumpSample_RuneBook,0,300
+	GumpParser_New(testgump,false):SetPos(x,y)
 	=

 	=

 	=

@@ -375,13 +378,14 @@
 	end
 end
 =

+
 kGumpParser_CommandTypes =3D {}
 kGumpParser_CommandTypes["page"]				=3D {paramformat=3D"pagenum"}
-kGumpParser_CommandTypes["xmfhtmlgump"]			=3D {paramformat=3D"x,y,width,he=
ight,cliloc_id,background,scrollbar,[ctrlname]"}
+kGumpParser_CommandTypes["xmfhtmlgump"]			=3D {paramformat=3D"x,y,width,he=
ight,cliloc_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=
=3Dtrue}} =

 kGumpParser_CommandTypes["xmfhtmlgumpcolor"]	=3D {paramformat=3D"x,y,width=
,height,cliloc_id,background,scrollbar,hue,[ctrlname]"}
 kGumpParser_CommandTypes["croppedtext"]			=3D {paramformat=3D"x,y,width,he=
ight,hue,textline_id,[ctrlname]",paramadd=3D{bold=3Dtrue,crop=3Dtrue}}
-kGumpParser_CommandTypes["htmlgump"]			=3D {paramformat=3D"x,y,width,heigh=
t,textline_id,background,scrollbar,[ctrlname]"}
-kGumpParser_CommandTypes["text"]				=3D {paramformat=3D"x,y,hue,textline_i=
d,[ctrlname]"}
+kGumpParser_CommandTypes["htmlgump"]			=3D {paramformat=3D"x,y,width,heigh=
t,textline_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=3D=
true}} =

+kGumpParser_CommandTypes["text"]				=3D {paramformat=3D"x,y,hue,textline_i=
d,[ctrlname]",paramadd=3D{bold=3Dtrue}}
 kGumpParser_CommandTypes["tooltip"]				=3D {paramformat=3D"cliloc_id,[ctrl=
name]"}
 kGumpParser_CommandTypes["resizepic"]			=3D {paramformat=3D"x,y,gump_id,wi=
dth,height,[ctrlname]",paramadd=3D{multipart=3Dtrue}}
 kGumpParser_CommandTypes["gumppictiled"]		=3D {paramformat=3D"x,y,width,he=
ight,gump_id,[ctrlname]",paramadd=3D{tiled=3Dtrue}}

Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Tue Jul  1 03:07:26 2008
@@ -14,6 +14,14 @@
 		[0]=3D"Message of the Day - Main",
 		}
 	}
+kGumpSample_RuneBook_part0 =3D {
+	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ xmfhtmlgump 140 40 80 18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }=
",
+	textline=3D{
+		[1]=3D"10",
+		[0]=3D"6",
+	}
+}
+	=

 	=

 kGumpSample_RuneBook =3D {
 	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ button 130 187 2225 2225 0 2 0 }{ button 165 187 2226 2226 0 3 0 }{ b=
utton 200 187 2227 2227 0 4 0 }{ button 235 187 2228 2228 0 5 0 }{ button 3=
00 187 2229 2229 0 6 0 }{ button 335 187 2230 2230 0 7 0 }{ button 370 187 =
2231 2231 0 8 0 }{ button 405 187 2232 2232 0 9 0 }{ xmfhtmlgump 140 40 80 =
18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }{ xmfhtmlgump 300 40 100 18 =
1011297 0 0 }{ htmlgump 400 40 30 18 1 0 0 }{ page 1 }{ button 125 15 2472 =
2473 1 0 1 }{ xmfhtmlgump 158 22 100 18 1011299 0 0 }{ button 130 65 2103 2=
104 1 0 2 }{ croppedtext 145 60 115 17 49 2 }{ button 130 80 2103 2104 1 0 =
8 }{ croppedtext 145 75 115 17 1153 3 }{ button 130 95 2103 2104 1 0 14 }{ =
croppedtext 145 90 115 17 1153 4 }{ button 130 110 2103 2104 1 0 20 }{ crop=
pedtext 145 105 115 17 1101 5 }{ button 130 125 2103 2104 1 0 26 }{ cropped=
text 145 120 115 17 1101 6 }{ button 130 140 2103 2104 1 0 32 }{ croppedtex=
t 145 135 115 17 1101 7 }{ button 130 155 2103 2104 1 0 38 }{ croppedtext 1=
45 150 115 17 1101 8 }{ button 130 170 2103 2104 1 0 44 }{ croppedtext 145 =
165 115 17 49 9 }{ button 290 65 2103 2104 1 0 50 }{ croppedtext 305 60 115=
 17 1150 10 }{ button 290 80 2103 2104 1 0 56 }{ croppedtext 305 75 115 17 =
49 11 }{ button 290 95 2103 2104 1 0 62 }{ croppedtext 305 90 115 17 49 12 =
}{ button 290 110 2103 2104 1 0 68 }{ croppedtext 305 105 115 17 1153 13 }{=
 button 290 125 2103 2104 1 0 74 }{ croppedtext 305 120 115 17 1101 14 }{ b=
utton 290 140 2103 2104 1 0 80 }{ croppedtext 305 135 115 17 1101 14 }{ but=
ton 290 155 2103 2104 1 0 86 }{ croppedtext 305 150 115 17 1101 14 }{ butto=
n 290 170 2103 2104 1 0 92 }{ croppedtext 305 165 115 17 1101 14 }{ button =
393 14 2206 2206 0 2 0 }{ page 2 }{ button 125 14 2205 2205 0 1 0 }{ button=
 393 14 2206 2206 0 3 0 }{ button 130 65 2103 2104 1 0 2 }{ text 135 80 0 1=
5 }{ text 135 95 0 16 }{ button 135 115 2437 2438 1 0 3 }{ xmfhtmlgump 150 =
115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 4 }{ xmfhtmlgump 175 =
15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 5 }{ xmfhtmlgump 150 =
136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 6 }{ xmfhtmlgump 150=
 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 7 }{ xmfhtmlgump 15=
0 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 49 2 }{ button 290 65=
 2103 2104 1 0 8 }{ text 295 80 0 17 }{ text 295 95 0 18 }{ button 295 115 =
2437 2438 1 0 9 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 =
2361 2361 1 0 10 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140=
 2103 2104 1 0 11 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 1=
58 2103 2104 1 0 12 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295=
 176 2103 2104 1 0 13 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedt=
ext 305 60 115 17 1153 3 }{ page 3 }{ button 125 14 2205 2205 0 2 0 }{ butt=
on 393 14 2206 2206 0 4 0 }{ button 130 65 2103 2104 1 0 14 }{ text 135 80 =
0 19 }{ text 135 95 0 20 }{ button 135 115 2437 2438 1 0 15 }{ xmfhtmlgump =
150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 16 }{ xmfhtmlgump=
 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 17 }{ xmfhtmlgum=
p 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 18 }{ xmfhtmlg=
ump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 19 }{ xmfhtm=
lgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 1153 4 }{ but=
ton 290 65 2103 2104 1 0 20 }{ text 295 80 0 21 }{ text 295 95 0 22 }{ butt=
on 295 115 2437 2438 1 0 21 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ bu=
tton 300 20 2361 2361 1 0 22 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ bu=
tton 295 140 2103 2104 1 0 23 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ =
button 295 158 2103 2104 1 0 24 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }=
{ button 295 176 2103 2104 1 0 25 }{ xmfhtmlgump 310 172 110 20 1062724 0 0=
 }{ croppedtext 305 60 115 17 1101 5 }{ page 4 }{ button 125 14 2205 2205 0=
 3 0 }{ button 393 14 2206 2206 0 5 0 }{ button 130 65 2103 2104 1 0 26 }{ =
text 135 80 0 23 }{ text 135 95 0 24 }{ button 135 115 2437 2438 1 0 27 }{ =
xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 28 }{=
 xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 29 }=
{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 30=
 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 =
31 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 1=
101 6 }{ button 290 65 2103 2104 1 0 32 }{ text 295 80 0 25 }{ text 295 95 =
0 26 }{ button 295 115 2437 2438 1 0 33 }{ xmfhtmlgump 310 115 100 18 10112=
98 0 0 }{ button 295 140 2103 2104 1 0 35 }{ xmfhtmlgump 310 136 110 20 106=
2722 0 0 }{ button 295 158 2103 2104 1 0 36 }{ xmfhtmlgump 310 154 110 20 1=
062723 0 0 }{ button 295 176 2103 2104 1 0 37 }{ xmfhtmlgump 310 172 110 20=
 1062724 0 0 }{ croppedtext 305 60 115 17 1101 7 }{ page 5 }{ button 125 14=
 2205 2205 0 4 0 }{ button 393 14 2206 2206 0 6 0 }{ button 130 65 2103 210=
4 1 0 38 }{ text 135 80 0 27 }{ text 135 95 0 28 }{ button 135 115 2437 243=
8 1 0 39 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 20 2361 23=
61 1 0 40 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2=
104 1 0 41 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 135 158 2103=
 2104 1 0 42 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button 135 176 21=
03 2104 1 0 43 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145=
 60 115 17 1101 8 }{ button 290 65 2103 2104 1 0 44 }{ text 295 80 0 29 }{ =
text 295 95 0 30 }{ button 295 115 2437 2438 1 0 45 }{ xmfhtmlgump 310 115 =
100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 46 }{ xmfhtmlgump 315 15 =
100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 47 }{ xmfhtmlgump 310 13=
6 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 48 }{ xmfhtmlgump 310 =
154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 49 }{ xmfhtmlgump 31=
0 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 49 9 }{ page 6 }{ but=
ton 125 14 2205 2205 0 5 0 }{ button 393 14 2206 2206 0 7 0 }{ button 130 6=
5 2103 2104 1 0 50 }{ text 135 80 0 31 }{ text 135 95 0 32 }{ button 135 11=
5 2437 2438 1 0 51 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 =
20 2361 2361 1 0 52 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 =
140 2103 2104 1 0 53 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 13=
5 158 2103 2104 1 0 54 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button =
135 176 2103 2104 1 0 55 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ cropp=
edtext 145 60 115 17 1150 10 }{ button 290 65 2103 2104 1 0 56 }{ text 295 =
80 0 33 }{ text 295 95 0 34 }{ button 295 115 2437 2438 1 0 57 }{ xmfhtmlgu=
mp 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 58 }{ xmfhtmlg=
ump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 59 }{ xmfhtml=
gump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 60 }{ xmfht=
mlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 61 }{ xmf=
htmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 49 11 }{ p=
age 7 }{ button 125 14 2205 2205 0 6 0 }{ button 393 14 2206 2206 0 8 0 }{ =
button 130 65 2103 2104 1 0 62 }{ text 135 80 0 35 }{ text 135 95 0 36 }{ b=
utton 135 115 2437 2438 1 0 63 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{=
 button 160 20 2361 2361 1 0 64 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{=
 button 135 140 2103 2104 1 0 65 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 =
}{ button 135 158 2103 2104 1 0 66 }{ xmfhtmlgump 150 154 110 20 1062723 0 =
0 }{ button 135 176 2103 2104 1 0 67 }{ xmfhtmlgump 150 172 110 20 1062724 =
0 0 }{ croppedtext 145 60 115 17 49 12 }{ button 290 65 2103 2104 1 0 68 }{=
 text 295 80 0 37 }{ text 295 95 0 38 }{ button 295 115 2437 2438 1 0 69 }{=
 xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 70 }=
{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 71 =
}{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 7=
2 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0=
 73 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 =
1153 13 }{ page 8 }{ button 125 14 2205 2205 0 7 0 }{ button 393 14 2206 22=
06 0 9 0 }{ button 130 65 2103 2104 1 0 74 }{ text 135 80 0 39 }{ text 135 =
95 0 40 }{ button 135 115 2437 2438 1 0 75 }{ xmfhtmlgump 150 115 100 18 10=
11298 0 0 }{ button 160 20 2361 2361 1 0 76 }{ xmfhtmlgump 175 15 100 18 10=
11300 0 0 }{ button 135 140 2103 2104 1 0 77 }{ xmfhtmlgump 150 136 110 20 =
1062722 0 0 }{ button 135 158 2103 2104 1 0 78 }{ xmfhtmlgump 150 154 110 2=
0 1062723 0 0 }{ button 135 176 2103 2104 1 0 79 }{ xmfhtmlgump 150 172 110=
 20 1062724 0 0 }{ croppedtext 145 60 115 17 1101 14 }{ button 290 65 2103 =
2104 1 0 80 }{ text 295 80 0 39 }{ text 295 95 0 40 }{ button 295 115 2437 =
2438 1 0 81 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361=
 2361 1 0 82 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 210=
3 2104 1 0 83 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2=
103 2104 1 0 84 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176=
 2103 2104 1 0 85 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext =
305 60 115 17 1101 14 }{ page 9 }{ button 125 14 2205 2205 0 8 0 }{ button =
130 65 2103 2104 1 0 86 }{ text 135 80 0 39 }{ text 135 95 0 40 }{ button 1=
35 115 2437 2438 1 0 87 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button=
 160 20 2361 2361 1 0 88 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button=
 135 140 2103 2104 1 0 89 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ butt=
on 135 158 2103 2104 1 0 90 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ bu=
tton 135 176 2103 2104 1 0 91 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ =
croppedtext 145 60 115 17 1101 14 }{ button 290 65 2103 2104 1 0 92 }{ text=
 295 80 0 39 }{ text 295 95 0 40 }{ button 295 115 2437 2438 1 0 93 }{ xmfh=
tmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 94 }{ xmf=
htmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 95 }{ xm=
fhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 96 }{ =
xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 97 }=
{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 1101 =
14 }",

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Tue Jul  1 03:07:26 2008
@@ -2,6 +2,12 @@
 -- see also lib.gui.widget.text.lua
 -- see also lib.glyphlist.lua
 -- TODO : font hueing needed ? so far rgb vertexcolor of the primary hue c=
olor seems to be enough
+
+-- xmfhtmlgump	runebook	"rename book"			black,nonbold
+-- htmlgump		runebook	[chargenum]				black,nonbold		{ htmlgump 220 40 30 1=
8 0 0 0 }		-- scrollbar=3D0->black
+-- htmlgump 	changelog	[maintext]				white,nonbold		{ htmlgump 30 81 290 1=
62 2 0 1 }	-- scrollbar=3D1->white
+-- text 		changelog	"Message of the Day"	white,bold
+-- croppedtext 	changelog	"News"					white,bold	=

 =

 RegisterWidgetClass("UOText","Text")
 =

@@ -10,10 +16,22 @@
 -- crop : disables autowrap
 function gWidgetPrototype.UOText:Init (parentwidget, params, textlines)
 	--~ print("TODO:widget.UOText  : height,w/h-clip,background,scrollbar",pa=
rentwidget:GetClassName(),parentwidget.pagenum)
+	if (params.scrollbar =3D=3D 0) then params.scrollbar =3D false end
+	if (params.scrollbar) then params.default_black =3D false end -- when scr=
ollbar is on, default to white (probably on dark background?)
 	if (not params.crop) then params.autowrap_w =3D params.width end
 	gWidgetPrototype.Text.Init(self,parentwidget,params)
 	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"))
-	self:SetLeftTop(params.x-1,params.y-22)
+	--~ self:SetPos(params.x,params.y)
+	local xoff,yoff =3D -1,-22
+	self:SetLeftTop(params.x+xoff,params.y+yoff)
+	=

+	-- clip
+	-- { checkertrans 30 81 290 162 }
+	-- { htmlgump     30 81 290 162 2 0 1 }
+	--~ if (params.width) then local l,t,r,b =3D self:GetRelBounds() self:Set=
Clip(0,0,params.width,params.height) end
+	=

+	local w,h =3D params.width,params.height
+	if (w) then local l,t,r,b =3D self:GetRelBounds() print("uotext",w,h,l,t,=
r,b) self:SetClip(l-xoff,t-yoff,l-xoff+params.width,t+params.height-yoff) e=
nd
 end
 =

 -- TODO : uohtml might be an array of ints for unicode (textline) instead =
of text (no html then)
@@ -25,7 +43,7 @@
 	local bold =3D self.params.bold
 	local col_white =3D {r=3D1,g=3D1,b=3D1}
 	local col_black =3D {r=3D0,g=3D0,b=3D0}
-	local col =3D bold and col_black or col_white
+	local col =3D self.params.default_black and col_black or col_white
 	if (self.params.hue) then local r,g,b =3D gHueLoader:GetColor(self.params=
.hue,31) col =3D {r=3Dr,g=3Dg,b=3Db} end
 	=

 	local bBig =3D false
@@ -38,13 +56,13 @@
 	=

 	glyphlist:Clear()
 	=

-	print("uohtml start")
+	print("uohtml start",self.params.scrollbar)
 	for plaintext,tag in string.gfind(uohtml, "([^<]*)(<?[^>]*>?)") do =

 		local fontid,bold,col =3D unpack(statestack[#statestack])
+		local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
 		if (plaintext ~=3D "") then =

 			-- plain text
 			print("uohtml plain",plaintext)
-			local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
 			glyphlist:AddText(font,fontsize,plaintext,col)
 		end
 		if (tag ~=3D "") then
@@ -53,7 +71,7 @@
 			if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

 			if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end =
-- fontchange
 			if (tag =3D=3D "</BIG>") then table.remove(statestack) end
-			if (tag =3D=3D "<BR>") then glyphlist:AddNewLine() end
+			if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
 			=

 			--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
 			--~ for token in string.gfind(textstring, "%w+") do table.insert(bToken=
,token) end



From no-reply at zwischenwelt.org  Tue Jul  1 03:19:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 01 Jul 2008 01:19:03 -0000
Subject: [Iris-commit] [IRIS] r2278 - in /trunk: lua/lib.gump.samples.lua
 widgets/widget.uobutton.lua widgets/widget.uotext.lua
Message-ID: <20080701011903.5A0BC1C180A3@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Jul  1 03:19:02 2008
New Revision: 2278

Log:
bugfix : uobutton

Modified:
    trunk/lua/lib.gump.samples.lua
    trunk/widgets/widget.uobutton.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Tue Jul  1 03:19:02 2008
@@ -9,11 +9,13 @@
 	Data=3D"{ page 0 }{ resizepic 0 0 9270 350 272 }{ resizepic 10 35 9270 33=
0 227 }{ button 298 15 22153 22155 1 0 1 }{ button 319 15 22150 22152 1 0 0=
 }{ resizepic 81 10 9270 188 35 }{ text 91 17 2101 0 }{ resizepic 91 45 927=
0 168 35 }{ croppedtext 160 52 29 16 2101 1 }{ gumppictiled 30 81 290 162 2=
624 }{ checkertrans 30 81 290 162 }{ button 30 55 5603 5607 1 0 11 }{ butto=
n 304 55 5601 5605 1 0 11 }{ htmlgump 30 81 290 162 2 0 1 }",
 	textline=3D{
 		[1]=3D"News",
-		--~ [2]=3D"A\n\nB\nC",
 		[2]=3D"<CENTER><BIG>28.06.2008 by Lumberman<BR>-------------------------=
---------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Forum unter www=
.vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BIG>23.06.200=
8 by Lumberman<BR>----------------------------------</BIG></CENTER>Patch ei=
ngespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder im Changel=
og (Pfeil rechts)<BR><CENTER><BIG>15.06.2008 by Lumberman<BR>--------------=
--------------------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Foru=
m unter www.vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BI=
G>14.06.2008 by Lumberman<BR>----------------------------------</BIG></CENT=
ER>Patch eingespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder=
 im Changelog (Pfeil rechts)",
 		[0]=3D"Message of the Day - Main",
 		}
 	}
+	=

+	=

+	=

 kGumpSample_RuneBook_part0 =3D {
 	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ xmfhtmlgump 140 40 80 18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }=
",
 	textline=3D{

Modified: trunk/widgets/widget.uobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uobutton.lua (original)
+++ trunk/widgets/widget.uobutton.lua Tue Jul  1 03:19:02 2008
@@ -16,6 +16,7 @@
 		self.gfx_icon =3D self:CreateChild("UOImage",{x=3Dparams.art_x,y=3Dparam=
s.art_y,art_id=3Dparams.art_id,hue=3Dparams.hue})
 	end
 	self:SetPos(params.x,params.y)
+	self:UpdateGfx()
 end
 =

 function gWidgetPrototype.UOButton:on_mouse_left_down	() self.bMouseDown =
=3D true		self:UpdateGfx() end

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Tue Jul  1 03:19:02 2008
@@ -31,7 +31,7 @@
 	--~ if (params.width) then local l,t,r,b =3D self:GetRelBounds() self:Set=
Clip(0,0,params.width,params.height) end
 	=

 	local w,h =3D params.width,params.height
-	if (w) then local l,t,r,b =3D self:GetRelBounds() print("uotext",w,h,l,t,=
r,b) self:SetClip(l-xoff,t-yoff,l-xoff+params.width,t+params.height-yoff) e=
nd
+	if (w) then local l,t,r,b =3D self:GetRelBounds() self:SetClip(l-xoff,t-y=
off,l-xoff+params.width,t+params.height-yoff) end
 end
 =

 -- TODO : uohtml might be an array of ints for unicode (textline) instead =
of text (no html then)
@@ -56,13 +56,13 @@
 	=

 	glyphlist:Clear()
 	=

-	print("uohtml start",self.params.scrollbar)
+	--~ print("uohtml start",self.params.scrollbar)
 	for plaintext,tag in string.gfind(uohtml, "([^<]*)(<?[^>]*>?)") do =

 		local fontid,bold,col =3D unpack(statestack[#statestack])
 		local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
 		if (plaintext ~=3D "") then =

 			-- plain text
-			print("uohtml plain",plaintext)
+			--~ print("uohtml plain",plaintext)
 			glyphlist:AddText(font,fontsize,plaintext,col)
 		end
 		if (tag ~=3D "") then
@@ -77,7 +77,7 @@
 			--~ for token in string.gfind(textstring, "%w+") do table.insert(bToken=
,token) end
 			--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
 			=

-			print("uohtml tag",tag)
+			--~ print("uohtml tag",tag)
 		end
 	end
 	self:UpdateGeometry()



From no-reply at zwischenwelt.org  Tue Jul  1 23:53:07 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 01 Jul 2008 21:53:07 -0000
Subject: [Iris-commit] [IRIS] r2279 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/lib.gump.samples.lua lua/net/net.other.lua
 widgets/widget.gumpdialog.lua widgets/widget.uobutton.lua
 widgets/widget.uotext.lua
Message-ID: <20080701215307.E09B21524030@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Jul  1 23:53:07 2008
New Revision: 2279

Log:
guisys: bugfix:textcolor default-hue, gump-page-change buttons work with gu=
i2 now, started real unicode-extraction for gump textline-parameters

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.gump.samples.lua
    trunk/lua/net/net.other.lua
    trunk/widgets/widget.gumpdialog.lua
    trunk/widgets/widget.uobutton.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Tue Jul  1 23:53:07 2008
@@ -38,19 +38,20 @@
 	--~ local testgump,x,y =3D kGumpSample_RuneBook,0,240
 	--~ local testgump,x,y =3D kGumpSample_Reward,0,140
 	local profiler =3D MakeProfiler("gumpparser")
-	profiler:StartSection("font:preload")
-	GetUOFont(gUniFontLoaderList[1],true):PreLoad()
-	GetUOFont(gUniFontLoaderList[1],false):PreLoad()
-	profiler:StartSection("old")
-	GumpParser(testgump,false)
-	profiler:StartSection("new")
-	local dialog =3D GumpParser_New(testgump,false) dialog:SetPos(x,y)
-	profiler:Finish()
-	profiler:PrintTotalTime()
-	=

-	local testgump,x,y =3D kGumpSample_RuneBook,0,300
-	GumpParser_New(testgump,false):SetPos(x,y)
-	=

+	if (1 =3D=3D 1) then
+		profiler:StartSection("font:preload")
+		GetUOFont(gUniFontLoaderList[1],true):PreLoad()
+		GetUOFont(gUniFontLoaderList[1],false):PreLoad()
+		profiler:StartSection("old")
+		GumpParser(testgump,false)
+		profiler:StartSection("new")
+		local dialog =3D GumpParser_New(testgump,false) dialog:SetPos(x,y)
+		profiler:Finish()
+		profiler:PrintTotalTime()
+	end
+		=

+		local testgump,x,y =3D kGumpSample_RuneBook,0,300
+		GumpParser_New(testgump,false):SetPos(x,y)
 	=

 	=

 	--~ local dialog =3D GumpParser_New(kClientSideGump_Paperdoll_Own,true) d=
ialog:SetLeftTop(400,100)
@@ -385,7 +386,7 @@
 kGumpParser_CommandTypes["xmfhtmlgumpcolor"]	=3D {paramformat=3D"x,y,width=
,height,cliloc_id,background,scrollbar,hue,[ctrlname]"}
 kGumpParser_CommandTypes["croppedtext"]			=3D {paramformat=3D"x,y,width,he=
ight,hue,textline_id,[ctrlname]",paramadd=3D{bold=3Dtrue,crop=3Dtrue}}
 kGumpParser_CommandTypes["htmlgump"]			=3D {paramformat=3D"x,y,width,heigh=
t,textline_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=3D=
true}} =

-kGumpParser_CommandTypes["text"]				=3D {paramformat=3D"x,y,hue,textline_i=
d,[ctrlname]",paramadd=3D{bold=3Dtrue}}
+kGumpParser_CommandTypes["text"]				=3D {paramformat=3D"x,y,hue,textline_i=
d,[ctrlname]",paramadd=3D{bold=3Dfalse,default_black=3Dtrue}}
 kGumpParser_CommandTypes["tooltip"]				=3D {paramformat=3D"cliloc_id,[ctrl=
name]"}
 kGumpParser_CommandTypes["resizepic"]			=3D {paramformat=3D"x,y,gump_id,wi=
dth,height,[ctrlname]",paramadd=3D{multipart=3Dtrue}}
 kGumpParser_CommandTypes["gumppictiled"]		=3D {paramformat=3D"x,y,width,he=
ight,gump_id,[ctrlname]",paramadd=3D{tiled=3Dtrue}}

Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Tue Jul  1 23:53:07 2008
@@ -13,17 +13,6 @@
 		[0]=3D"Message of the Day - Main",
 		}
 	}
-	=

-	=

-	=

-kGumpSample_RuneBook_part0 =3D {
-	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ xmfhtmlgump 140 40 80 18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }=
",
-	textline=3D{
-		[1]=3D"10",
-		[0]=3D"6",
-	}
-}
-	=

 	=

 kGumpSample_RuneBook =3D {
 	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ button 130 187 2225 2225 0 2 0 }{ button 165 187 2226 2226 0 3 0 }{ b=
utton 200 187 2227 2227 0 4 0 }{ button 235 187 2228 2228 0 5 0 }{ button 3=
00 187 2229 2229 0 6 0 }{ button 335 187 2230 2230 0 7 0 }{ button 370 187 =
2231 2231 0 8 0 }{ button 405 187 2232 2232 0 9 0 }{ xmfhtmlgump 140 40 80 =
18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }{ xmfhtmlgump 300 40 100 18 =
1011297 0 0 }{ htmlgump 400 40 30 18 1 0 0 }{ page 1 }{ button 125 15 2472 =
2473 1 0 1 }{ xmfhtmlgump 158 22 100 18 1011299 0 0 }{ button 130 65 2103 2=
104 1 0 2 }{ croppedtext 145 60 115 17 49 2 }{ button 130 80 2103 2104 1 0 =
8 }{ croppedtext 145 75 115 17 1153 3 }{ button 130 95 2103 2104 1 0 14 }{ =
croppedtext 145 90 115 17 1153 4 }{ button 130 110 2103 2104 1 0 20 }{ crop=
pedtext 145 105 115 17 1101 5 }{ button 130 125 2103 2104 1 0 26 }{ cropped=
text 145 120 115 17 1101 6 }{ button 130 140 2103 2104 1 0 32 }{ croppedtex=
t 145 135 115 17 1101 7 }{ button 130 155 2103 2104 1 0 38 }{ croppedtext 1=
45 150 115 17 1101 8 }{ button 130 170 2103 2104 1 0 44 }{ croppedtext 145 =
165 115 17 49 9 }{ button 290 65 2103 2104 1 0 50 }{ croppedtext 305 60 115=
 17 1150 10 }{ button 290 80 2103 2104 1 0 56 }{ croppedtext 305 75 115 17 =
49 11 }{ button 290 95 2103 2104 1 0 62 }{ croppedtext 305 90 115 17 49 12 =
}{ button 290 110 2103 2104 1 0 68 }{ croppedtext 305 105 115 17 1153 13 }{=
 button 290 125 2103 2104 1 0 74 }{ croppedtext 305 120 115 17 1101 14 }{ b=
utton 290 140 2103 2104 1 0 80 }{ croppedtext 305 135 115 17 1101 14 }{ but=
ton 290 155 2103 2104 1 0 86 }{ croppedtext 305 150 115 17 1101 14 }{ butto=
n 290 170 2103 2104 1 0 92 }{ croppedtext 305 165 115 17 1101 14 }{ button =
393 14 2206 2206 0 2 0 }{ page 2 }{ button 125 14 2205 2205 0 1 0 }{ button=
 393 14 2206 2206 0 3 0 }{ button 130 65 2103 2104 1 0 2 }{ text 135 80 0 1=
5 }{ text 135 95 0 16 }{ button 135 115 2437 2438 1 0 3 }{ xmfhtmlgump 150 =
115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 4 }{ xmfhtmlgump 175 =
15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 5 }{ xmfhtmlgump 150 =
136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 6 }{ xmfhtmlgump 150=
 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 7 }{ xmfhtmlgump 15=
0 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 49 2 }{ button 290 65=
 2103 2104 1 0 8 }{ text 295 80 0 17 }{ text 295 95 0 18 }{ button 295 115 =
2437 2438 1 0 9 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 =
2361 2361 1 0 10 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140=
 2103 2104 1 0 11 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 1=
58 2103 2104 1 0 12 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295=
 176 2103 2104 1 0 13 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedt=
ext 305 60 115 17 1153 3 }{ page 3 }{ button 125 14 2205 2205 0 2 0 }{ butt=
on 393 14 2206 2206 0 4 0 }{ button 130 65 2103 2104 1 0 14 }{ text 135 80 =
0 19 }{ text 135 95 0 20 }{ button 135 115 2437 2438 1 0 15 }{ xmfhtmlgump =
150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 16 }{ xmfhtmlgump=
 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 17 }{ xmfhtmlgum=
p 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 18 }{ xmfhtmlg=
ump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 19 }{ xmfhtm=
lgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 1153 4 }{ but=
ton 290 65 2103 2104 1 0 20 }{ text 295 80 0 21 }{ text 295 95 0 22 }{ butt=
on 295 115 2437 2438 1 0 21 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ bu=
tton 300 20 2361 2361 1 0 22 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ bu=
tton 295 140 2103 2104 1 0 23 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ =
button 295 158 2103 2104 1 0 24 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }=
{ button 295 176 2103 2104 1 0 25 }{ xmfhtmlgump 310 172 110 20 1062724 0 0=
 }{ croppedtext 305 60 115 17 1101 5 }{ page 4 }{ button 125 14 2205 2205 0=
 3 0 }{ button 393 14 2206 2206 0 5 0 }{ button 130 65 2103 2104 1 0 26 }{ =
text 135 80 0 23 }{ text 135 95 0 24 }{ button 135 115 2437 2438 1 0 27 }{ =
xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 28 }{=
 xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 29 }=
{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 30=
 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 =
31 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 1=
101 6 }{ button 290 65 2103 2104 1 0 32 }{ text 295 80 0 25 }{ text 295 95 =
0 26 }{ button 295 115 2437 2438 1 0 33 }{ xmfhtmlgump 310 115 100 18 10112=
98 0 0 }{ button 295 140 2103 2104 1 0 35 }{ xmfhtmlgump 310 136 110 20 106=
2722 0 0 }{ button 295 158 2103 2104 1 0 36 }{ xmfhtmlgump 310 154 110 20 1=
062723 0 0 }{ button 295 176 2103 2104 1 0 37 }{ xmfhtmlgump 310 172 110 20=
 1062724 0 0 }{ croppedtext 305 60 115 17 1101 7 }{ page 5 }{ button 125 14=
 2205 2205 0 4 0 }{ button 393 14 2206 2206 0 6 0 }{ button 130 65 2103 210=
4 1 0 38 }{ text 135 80 0 27 }{ text 135 95 0 28 }{ button 135 115 2437 243=
8 1 0 39 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 20 2361 23=
61 1 0 40 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2=
104 1 0 41 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 135 158 2103=
 2104 1 0 42 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button 135 176 21=
03 2104 1 0 43 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145=
 60 115 17 1101 8 }{ button 290 65 2103 2104 1 0 44 }{ text 295 80 0 29 }{ =
text 295 95 0 30 }{ button 295 115 2437 2438 1 0 45 }{ xmfhtmlgump 310 115 =
100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 46 }{ xmfhtmlgump 315 15 =
100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 47 }{ xmfhtmlgump 310 13=
6 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 48 }{ xmfhtmlgump 310 =
154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 49 }{ xmfhtmlgump 31=
0 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 49 9 }{ page 6 }{ but=
ton 125 14 2205 2205 0 5 0 }{ button 393 14 2206 2206 0 7 0 }{ button 130 6=
5 2103 2104 1 0 50 }{ text 135 80 0 31 }{ text 135 95 0 32 }{ button 135 11=
5 2437 2438 1 0 51 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 =
20 2361 2361 1 0 52 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 =
140 2103 2104 1 0 53 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 13=
5 158 2103 2104 1 0 54 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button =
135 176 2103 2104 1 0 55 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ cropp=
edtext 145 60 115 17 1150 10 }{ button 290 65 2103 2104 1 0 56 }{ text 295 =
80 0 33 }{ text 295 95 0 34 }{ button 295 115 2437 2438 1 0 57 }{ xmfhtmlgu=
mp 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 58 }{ xmfhtmlg=
ump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 59 }{ xmfhtml=
gump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 60 }{ xmfht=
mlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 61 }{ xmf=
htmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 49 11 }{ p=
age 7 }{ button 125 14 2205 2205 0 6 0 }{ button 393 14 2206 2206 0 8 0 }{ =
button 130 65 2103 2104 1 0 62 }{ text 135 80 0 35 }{ text 135 95 0 36 }{ b=
utton 135 115 2437 2438 1 0 63 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{=
 button 160 20 2361 2361 1 0 64 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{=
 button 135 140 2103 2104 1 0 65 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 =
}{ button 135 158 2103 2104 1 0 66 }{ xmfhtmlgump 150 154 110 20 1062723 0 =
0 }{ button 135 176 2103 2104 1 0 67 }{ xmfhtmlgump 150 172 110 20 1062724 =
0 0 }{ croppedtext 145 60 115 17 49 12 }{ button 290 65 2103 2104 1 0 68 }{=
 text 295 80 0 37 }{ text 295 95 0 38 }{ button 295 115 2437 2438 1 0 69 }{=
 xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 70 }=
{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 71 =
}{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 7=
2 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0=
 73 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 =
1153 13 }{ page 8 }{ button 125 14 2205 2205 0 7 0 }{ button 393 14 2206 22=
06 0 9 0 }{ button 130 65 2103 2104 1 0 74 }{ text 135 80 0 39 }{ text 135 =
95 0 40 }{ button 135 115 2437 2438 1 0 75 }{ xmfhtmlgump 150 115 100 18 10=
11298 0 0 }{ button 160 20 2361 2361 1 0 76 }{ xmfhtmlgump 175 15 100 18 10=
11300 0 0 }{ button 135 140 2103 2104 1 0 77 }{ xmfhtmlgump 150 136 110 20 =
1062722 0 0 }{ button 135 158 2103 2104 1 0 78 }{ xmfhtmlgump 150 154 110 2=
0 1062723 0 0 }{ button 135 176 2103 2104 1 0 79 }{ xmfhtmlgump 150 172 110=
 20 1062724 0 0 }{ croppedtext 145 60 115 17 1101 14 }{ button 290 65 2103 =
2104 1 0 80 }{ text 295 80 0 39 }{ text 295 95 0 40 }{ button 295 115 2437 =
2438 1 0 81 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361=
 2361 1 0 82 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 210=
3 2104 1 0 83 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2=
103 2104 1 0 84 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176=
 2103 2104 1 0 85 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext =
305 60 115 17 1101 14 }{ page 9 }{ button 125 14 2205 2205 0 8 0 }{ button =
130 65 2103 2104 1 0 86 }{ text 135 80 0 39 }{ text 135 95 0 40 }{ button 1=
35 115 2437 2438 1 0 87 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button=
 160 20 2361 2361 1 0 88 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button=
 135 140 2103 2104 1 0 89 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ butt=
on 135 158 2103 2104 1 0 90 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ bu=
tton 135 176 2103 2104 1 0 91 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ =
croppedtext 145 60 115 17 1101 14 }{ button 290 65 2103 2104 1 0 92 }{ text=
 295 80 0 39 }{ text 295 95 0 40 }{ button 295 115 2437 2438 1 0 93 }{ xmfh=
tmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 94 }{ xmf=
htmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 95 }{ xm=
fhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 96 }{ =
xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 97 }=
{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 1101 =
14 }",
@@ -72,24 +61,6 @@
 		}
 	}
 	=

-kGumpSample_RuneBook_Simple =3D {
-	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ button 130 187 2225 2225 0 2 0 }{ button 165 187 2226 2226 0 3 0 }{ b=
utton 200 187 2227 2227 0 4 0 }{ button 235 187 2228 2228 0 5 0 }{ button 3=
00 187 2229 2229 0 6 0 }{ button 335 187 2230 2230 0 7 0 }{ button 370 187 =
2231 2231 0 8 0 }{ button 405 187 2232 2232 0 9 0 }{ xmfhtmlgump 140 40 80 =
18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }{ xmfhtmlgump 300 40 100 18 =
1011297 0 0 }{ htmlgump 400 40 30 18 1 0 0 }{ page 1 }{ button 125 15 2472 =
2473 1 0 1 }{ xmfhtmlgump 158 22 100 18 1011299 0 0 }{ button 130 65 2103 2=
104 1 0 2 }{ croppedtext 145 60 115 17 49 2 }{ button 130 80 2103 2104 1 0 =
8 }{ croppedtext 145 75 115 17 1153 3 }{ button 130 95 2103 2104 1 0 14 }{ =
croppedtext 145 90 115 17 1153 4 }{ button 130 110 2103 2104 1 0 20 }{ crop=
pedtext 145 105 115 17 1101 5 }{ button 130 125 2103 2104 1 0 26 }{ cropped=
text 145 120 115 17 1101 6 }{ button 130 140 2103 2104 1 0 32 }{ croppedtex=
t 145 135 115 17 1101 7 }{ button 130 155 2103 2104 1 0 38 }{ croppedtext 1=
45 150 115 17 1101 8 }{ button 130 170 2103 2104 1 0 44 }{ croppedtext 145 =
165 115 17 49 9 }{ button 290 65 2103 2104 1 0 50 }{ croppedtext 305 60 115=
 17 1150 10 }{ button 290 80 2103 2104 1 0 56 }{ croppedtext 305 75 115 17 =
49 11 }{ button 290 95 2103 2104 1 0 62 }{ croppedtext 305 90 115 17 49 12 =
}{ button 290 110 2103 2104 1 0 68 }{ croppedtext 305 105 115 17 1153 13 }{=
 button 290 125 2103 2104 1 0 74 }{ croppedtext 305 120 115 17 1101 14 }{ b=
utton 290 140 2103 2104 1 0 80 }{ croppedtext 305 135 115 17 1101 14 }{ but=
ton 290 155 2103 2104 1 0 86 }{ croppedtext 305 150 115 17 1101 14 }{ butto=
n 290 170 2103 2104 1 0 92 }{ croppedtext 305 165 115 17 1101 14 }{ button =
393 14 2206 2206 0 2 0 }",
-	textline=3D{
-		[1]=3D"10",
-		[2]=3D"FFHQ",
-		[3]=3D"TokunoTamer",
-		[4]=3D"TokunoHealer",
-		[5]=3D"Unicorn",
-		[6]=3D"Kirin",
-		[7]=3D"HomeNew",
-		[8]=3D"LunaBank",
-		[9]=3D"HavenBank",
-		[10]=3D"dev null",
-		[11]=3D"TinkerJhelom",
-		[12]=3D"Moongate",
-		[13]=3D"TokuMage",
-		[14]=3D"x",
-		[0]=3D"6",
-		}
-	}
+	=

+	=

 	=


Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Tue Jul  1 23:53:07 2008
@@ -511,7 +511,7 @@
 	local unitext_font =3D input:PopNetUint16()
 	local unitext_lang =3D input:PopNetUint32()
 	local unitext_name =3D input:PopFilledString(30)
-	local unitext_message =3D input:PopUnicodeString((unitext_size-48)/2)
+	local unitext_message,unitext_message_unicode_charcodes =3D UniCodeDualPo=
p(input,(unitext_size-48)/2)
 =

 	local show_below =3D true	-- display as fadeline
 	local show_journal =3D true	-- display in journal
@@ -718,17 +718,35 @@
 	=

 	local textlen =3D 0
 	newgump.textline =3D {}
+	newgump.textline_unicode =3D {}
 	--Index 0 because Serverside Gump Commands use this Index as textline ref=
erences
 	for i =3D 0,newgump.numTextLines-1 do
-		textlen =3D input:PopNetUint16()
+		textlen =3D input:PopNetUint16() -- =3D number_of_unicode_chars
 		printdebug("gump","reading text line ",i," with length ",textlen)
-		newgump.textline[i] =3D input:PopUnicodeString(textlen) -- warning, data=
 is sent as unicode, we only interpret the asci part at the moment
-		-- TODO : maybe textlen / 2 ?
+		newgump.textline[i],newgump.textline_unicode[i] =3D UniCodeDualPop(input=
,textlen)
 		printdebug("gump",sprintf("newgump.textline[%d](len=3D%d)=3D\n",i,textle=
n),newgump.textline[i])
 	end
 =

 	GumpParser(newgump)
 end
+
+function UniCodeDualPop (fifo,number_of_unicode_chars)
+	--~ return input:PopUnicodeString(textlen) -- old, only asci part , TODO =
: see also PopUnicodeLEString
+	local ascipart =3D ""
+	local unicode_charcodes =3D {}
+	for i =3D 1,number_of_unicode_chars do
+		local head =3D fifo:PopUint8()
+		local data =3D fifo:PopUint8()
+		if (head ~=3D 0) then
+			ascipart =3D ascipart .. "?" .. (data ~=3D 0 and string.format("%c",dat=
a) or "")
+			table.insert(unicode_charcodes,head*256 + data)
+		else
+			ascipart =3D ascipart .. string.format("%c",data)
+		end
+	end
+	return ascipart,unicode_charcodes
+end
+
 =

 -- compressed Gump
 function gPacketHandler.kPacket_Compressed_Gump ()	--0xDD
@@ -783,12 +801,12 @@
 		=

 		local textlen =3D 0
 		newgump.textline =3D {}
+		newgump.textline_unicode =3D {}
 		--Index 0 because Serverside Gump Commands use this Index as textline re=
ferences
 		for i =3D 0,newgump.numTextLines-1 do
 			textlen =3D decompressed:PopNetUint16()
 			printdebug("gump","reading text line ",i," with length ",textlen)
-			newgump.textline[i] =3D decompressed:PopUnicodeString(textlen) -- warni=
ng, data is sent as unicode, we only interpret the asci part at the moment
-			-- TODO : maybe textlen / 2 ?
+			newgump.textline[i],newgump.textline_unicode[i] =3D UniCodeDualPop(deco=
mpressed,textlen)
 			printdebug("gump",sprintf("newgump.textline[%d](len=3D%d)=3D\n",i,textl=
en),newgump.textline[i])
 		end
 	end

Modified: trunk/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.gumpdialog.lua (original)
+++ trunk/widgets/widget.gumpdialog.lua Tue Jul  1 23:53:07 2008
@@ -31,6 +31,8 @@
 	]]--
 end
 =

+function gWidgetPrototype.GumpDialog:GetDialog	() return self end -- overr=
ide, normaly parent:GetDialog(), so this ends recursion
+
 function gWidgetPrototype.GumpDialog:on_destroy	() =

 	print("TODO : GumpDialog:on_destroy")
 	-- gGumpPosition[dialog.dialogId] =3D { x=3Ddialog.rootwidget.gfx:GetDeri=
vedLeft() , y=3Ddialog.rootwidget.gfx:GetDerivedTop() }

Modified: trunk/widgets/widget.uobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uobutton.lua (original)
+++ trunk/widgets/widget.uobutton.lua Tue Jul  1 23:53:07 2008
@@ -10,6 +10,7 @@
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
 	=

+	self.params			=3D params
 	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_normal})
 	self.gfx_pressed	=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_pressed})
 	if (params.art_id) then
@@ -30,3 +31,17 @@
 	self.gfx_pressed:SetVisible(bPressed)
 end
 =

+
+function gWidgetPrototype.UOButton:on_button_click	()
+	local dialog =3D self:GetDialog()
+	local page_id =3D self.params.page_id
+	local return_value =3D self.params.return_value
+	--~ print("UOButton:on_button_click",dialog,page_id,return_value)
+	if (page_id and page_id > 0) then
+		if (dialog) then dialog:ShowPage(page_id) end
+	elseif (return_value) then
+		print("TODO : UOButton:on_button_click return_value",return_value)
+		--~ CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg)
+	end
+end
+

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Tue Jul  1 23:53:07 2008
@@ -6,7 +6,8 @@
 -- xmfhtmlgump	runebook	"rename book"			black,nonbold
 -- htmlgump		runebook	[chargenum]				black,nonbold		{ htmlgump 220 40 30 1=
8 0 0 0 }		-- scrollbar=3D0->black
 -- htmlgump 	changelog	[maintext]				white,nonbold		{ htmlgump 30 81 290 1=
62 2 0 1 }	-- scrollbar=3D1->white
--- text 		changelog	"Message of the Day"	white,bold
+-- text 		changelog	"Message of the Day"	white,bold			{ text 91 17 hue=3D2=
101 0 } hue-dependant !
+-- text 		runebook	coords					black,nonbold		{ text 135 80 0 15 }
 -- croppedtext 	changelog	"News"					white,bold	=

 =

 RegisterWidgetClass("UOText","Text")



From no-reply at zwischenwelt.org  Wed Jul  2 00:16:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 01 Jul 2008 22:16:49 -0000
Subject: [Iris-commit] [IRIS] r2280 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/lib.gump.samples.lua lua/net/net.other.lua widgets/widget.uotext.lua
Message-ID: <20080701221649.A54971C18068@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Jul  2 00:16:48 2008
New Revision: 2280

Log:
guisys : first unicode experiment, runebook coords, successful

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.gump.samples.lua
    trunk/lua/net/net.other.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Wed Jul  2 00:16:48 2008
@@ -50,7 +50,7 @@
 		profiler:PrintTotalTime()
 	end
 		=

-		local testgump,x,y =3D kGumpSample_RuneBook,0,300
+		local testgump,x,y =3D kGumpSample_RuneBook2,0,300
 		GumpParser_New(testgump,false):SetPos(x,y)
 	=

 	=

@@ -481,19 +481,19 @@
 		-- but the text is cropped to the defined area.
 		-- text is automatically bold/outlined
 		elseif (command =3D=3D "croppedtext") then
-			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline)
+			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline_unicode o=
r Gumpdata.textline)
 			=

 		--HtmlGump <x> <y> <width> <height> <textline_id> <background> <scrollba=
r>
 		--Description:  Defines a text-area where Html-commands are allowed.
 		--				<background> and <scrollbar> can be 0 or 1 and define whether the =
background is transparent and a scrollbar is displayed.
 		--{ htmlgump 10 8 100 20 0 0 0 }
 		elseif (command =3D=3D "htmlgump") then
-			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline)
+			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline_unicode o=
r Gumpdata.textline)
 			=

 		--text <x> <y> <hue> <textline_id>
 		--Description:  Defines the position and hue of a text (data) entry.
 		elseif (command =3D=3D "text") then
-			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline)
+			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline_unicode o=
r Gumpdata.textline)
 =

 		--tooltip <cliloc_id>
 		--Description:  Adds to the previous layoutarray entry a Tooltip with th=
e in [cliloc-nr] defined Cliloc entry
@@ -610,7 +610,19 @@
 	if (not gGumpLoader) then return end
 =

 	=

-	--~ if (not Clientsidemode) then print("\n\n##### GUMP #####\n\n"..Gumpda=
ta.Data.."\n\ntextline=3D{") for k,v in pairs(Gumpdata.textline or {}) do p=
rint(k.."=3D\""..v.."\"\n") end print("}\n#######\n\n") end
+	if (1 =3D=3D 2 and (not Clientsidemode)) then =

+		print("\n\n##### GUMP #####\n\n"..Gumpdata.Data.."\n\ntextline=3D{") =

+		for k,v in pairs(Gumpdata.textline or {}) do print("["..k.."]=3D\""..v..=
"\",") end =

+		print("},")
+		print("textline_unicode=3D{")
+		for k,unicode_arr in pairs(Gumpdata.textline_unicode or {}) do =

+			printf("["..k.."]=3D{") =

+			for k2,unicode_charcode in pairs(unicode_arr) do printf("%d,",unicode_c=
harcode) end
+			printf("},\n") =

+		end =

+		print("},")
+		print("#######\n\n") =

+	end
 	=

 	local htext_correction=3D5
 =


Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Wed Jul  2 00:16:48 2008
@@ -63,4 +63,85 @@
 	=

 	=

 	=

+	=

+	=

+	=

+kGumpSample_RuneBook2 =3D {
+	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ button 130 187 2225 2225 0 2 0 }{ button 165 187 2226 2226 0 3 0 }{ b=
utton 200 187 2227 2227 0 4 0 }{ button 235 187 2228 2228 0 5 0 }{ button 3=
00 187 2229 2229 0 6 0 }{ button 335 187 2230 2230 0 7 0 }{ button 370 187 =
2231 2231 0 8 0 }{ button 405 187 2232 2232 0 9 0 }{ xmfhtmlgump 140 40 80 =
18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }{ xmfhtmlgump 300 40 100 18 =
1011297 0 0 }{ htmlgump 400 40 30 18 1 0 0 }{ page 1 }{ button 125 15 2472 =
2473 1 0 1 }{ xmfhtmlgump 158 22 100 18 1011299 0 0 }{ button 130 65 2103 2=
104 1 0 2 }{ croppedtext 145 60 115 17 49 2 }{ button 130 80 2103 2104 1 0 =
8 }{ croppedtext 145 75 115 17 1101 3 }{ button 130 95 2103 2104 1 0 14 }{ =
croppedtext 145 90 115 17 49 4 }{ button 130 110 2103 2104 1 0 20 }{ croppe=
dtext 145 105 115 17 49 5 }{ button 130 125 2103 2104 1 0 26 }{ croppedtext=
 145 120 115 17 49 6 }{ button 130 140 2103 2104 1 0 32 }{ croppedtext 145 =
135 115 17 1101 7 }{ button 130 155 2103 2104 1 0 38 }{ croppedtext 145 150=
 115 17 49 8 }{ button 130 170 2103 2104 1 0 44 }{ croppedtext 145 165 115 =
17 49 9 }{ button 290 65 2103 2104 1 0 50 }{ croppedtext 305 60 115 17 49 1=
0 }{ button 290 80 2103 2104 1 0 56 }{ croppedtext 305 75 115 17 1101 11 }{=
 button 290 95 2103 2104 1 0 62 }{ croppedtext 305 90 115 17 1101 12 }{ but=
ton 290 110 2103 2104 1 0 68 }{ croppedtext 305 105 115 17 1101 13 }{ butto=
n 290 125 2103 2104 1 0 74 }{ croppedtext 305 120 115 17 0 14 }{ button 290=
 140 2103 2104 1 0 80 }{ croppedtext 305 135 115 17 0 14 }{ button 290 155 =
2103 2104 1 0 86 }{ croppedtext 305 150 115 17 0 14 }{ button 290 170 2103 =
2104 1 0 92 }{ croppedtext 305 165 115 17 0 14 }{ button 393 14 2206 2206 0=
 2 0 }{ page 2 }{ button 125 14 2205 2205 0 1 0 }{ button 393 14 2206 2206 =
0 3 0 }{ button 130 65 2103 2104 1 0 2 }{ text 135 80 0 15 }{ text 135 95 0=
 16 }{ button 135 115 2437 2438 1 0 3 }{ xmfhtmlgump 150 115 100 18 1011298=
 0 0 }{ button 160 20 2361 2361 1 0 4 }{ xmfhtmlgump 175 15 100 18 1011300 =
0 0 }{ button 135 140 2103 2104 1 0 5 }{ xmfhtmlgump 150 136 110 20 1062722=
 0 0 }{ button 135 158 2103 2104 1 0 6 }{ xmfhtmlgump 150 154 110 20 106272=
3 0 0 }{ button 135 176 2103 2104 1 0 7 }{ xmfhtmlgump 150 172 110 20 10627=
24 0 0 }{ croppedtext 145 60 115 17 49 2 }{ button 290 65 2103 2104 1 0 8 }=
{ text 295 80 0 17 }{ text 295 95 0 18 }{ button 295 115 2437 2438 1 0 9 }{=
 xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 10 }=
{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 11 =
}{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 1=
2 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0=
 13 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 =
1101 3 }{ page 3 }{ button 125 14 2205 2205 0 2 0 }{ button 393 14 2206 220=
6 0 4 0 }{ button 130 65 2103 2104 1 0 14 }{ text 135 80 0 19 }{ text 135 9=
5 0 20 }{ button 135 115 2437 2438 1 0 15 }{ xmfhtmlgump 150 115 100 18 101=
1298 0 0 }{ button 160 20 2361 2361 1 0 16 }{ xmfhtmlgump 175 15 100 18 101=
1300 0 0 }{ button 135 140 2103 2104 1 0 17 }{ xmfhtmlgump 150 136 110 20 1=
062722 0 0 }{ button 135 158 2103 2104 1 0 18 }{ xmfhtmlgump 150 154 110 20=
 1062723 0 0 }{ button 135 176 2103 2104 1 0 19 }{ xmfhtmlgump 150 172 110 =
20 1062724 0 0 }{ croppedtext 145 60 115 17 49 4 }{ button 290 65 2103 2104=
 1 0 20 }{ button 295 115 2437 2438 1 0 21 }{ xmfhtmlgump 310 115 100 18 10=
11298 0 0 }{ button 300 20 2361 2361 1 0 22 }{ xmfhtmlgump 315 15 100 18 10=
11300 0 0 }{ button 295 140 2103 2104 1 0 23 }{ xmfhtmlgump 310 136 110 20 =
1062722 0 0 }{ button 295 158 2103 2104 1 0 24 }{ xmfhtmlgump 310 154 110 2=
0 1062723 0 0 }{ button 295 176 2103 2104 1 0 25 }{ xmfhtmlgump 310 172 110=
 20 1062724 0 0 }{ croppedtext 305 60 115 17 49 5 }{ page 4 }{ button 125 1=
4 2205 2205 0 3 0 }{ button 393 14 2206 2206 0 5 0 }{ button 130 65 2103 21=
04 1 0 26 }{ button 135 115 2437 2438 1 0 27 }{ xmfhtmlgump 150 115 100 18 =
1011298 0 0 }{ button 160 20 2361 2361 1 0 28 }{ xmfhtmlgump 175 15 100 18 =
1011300 0 0 }{ button 135 140 2103 2104 1 0 29 }{ xmfhtmlgump 150 136 110 2=
0 1062722 0 0 }{ button 135 158 2103 2104 1 0 30 }{ xmfhtmlgump 150 154 110=
 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 31 }{ xmfhtmlgump 150 172 1=
10 20 1062724 0 0 }{ croppedtext 145 60 115 17 49 6 }{ button 290 65 2103 2=
104 1 0 32 }{ text 295 80 0 21 }{ text 295 95 0 22 }{ button 295 115 2437 2=
438 1 0 33 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 =
2361 1 0 34 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103=
 2104 1 0 35 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 21=
03 2104 1 0 36 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 =
2103 2104 1 0 37 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 3=
05 60 115 17 1101 7 }{ page 5 }{ button 125 14 2205 2205 0 4 0 }{ button 39=
3 14 2206 2206 0 6 0 }{ button 130 65 2103 2104 1 0 38 }{ text 135 80 0 23 =
}{ text 135 95 0 24 }{ button 135 115 2437 2438 1 0 39 }{ xmfhtmlgump 150 1=
15 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 40 }{ xmfhtmlgump 175 =
15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 41 }{ xmfhtmlgump 150=
 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 42 }{ xmfhtmlgump 1=
50 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 43 }{ xmfhtmlgump=
 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 49 8 }{ button 290=
 65 2103 2104 1 0 44 }{ text 295 80 0 25 }{ text 295 95 0 26 }{ button 295 =
115 2437 2438 1 0 45 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 30=
0 20 2361 2361 1 0 46 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 29=
5 140 2103 2104 1 0 47 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button =
295 158 2103 2104 1 0 48 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ butto=
n 295 176 2103 2104 1 0 49 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ cro=
ppedtext 305 60 115 17 49 9 }{ page 6 }{ button 125 14 2205 2205 0 5 0 }{ b=
utton 393 14 2206 2206 0 7 0 }{ button 130 65 2103 2104 1 0 50 }{ text 135 =
80 0 27 }{ text 135 95 0 28 }{ button 135 115 2437 2438 1 0 51 }{ xmfhtmlgu=
mp 150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 52 }{ xmfhtmlg=
ump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 53 }{ xmfhtml=
gump 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 54 }{ xmfht=
mlgump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 55 }{ xmf=
htmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 49 10 }{ b=
utton 290 65 2103 2104 1 0 56 }{ text 295 80 0 29 }{ text 295 95 0 30 }{ bu=
tton 295 115 2437 2438 1 0 57 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ =
button 300 20 2361 2361 1 0 58 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ =
button 295 140 2103 2104 1 0 59 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }=
{ button 295 158 2103 2104 1 0 60 }{ xmfhtmlgump 310 154 110 20 1062723 0 0=
 }{ button 295 176 2103 2104 1 0 61 }{ xmfhtmlgump 310 172 110 20 1062724 0=
 0 }{ croppedtext 305 60 115 17 1101 11 }{ page 7 }{ button 125 14 2205 220=
5 0 6 0 }{ button 393 14 2206 2206 0 8 0 }{ button 130 65 2103 2104 1 0 62 =
}{ text 135 80 0 31 }{ text 135 95 0 32 }{ button 135 115 2437 2438 1 0 63 =
}{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 64=
 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 6=
5 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0=
 66 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1=
 0 67 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 1=
7 1101 12 }{ button 290 65 2103 2104 1 0 68 }{ text 295 80 0 33 }{ text 295=
 95 0 34 }{ button 295 115 2437 2438 1 0 69 }{ xmfhtmlgump 310 115 100 18 1=
011298 0 0 }{ button 300 20 2361 2361 1 0 70 }{ xmfhtmlgump 315 15 100 18 1=
011300 0 0 }{ button 295 140 2103 2104 1 0 71 }{ xmfhtmlgump 310 136 110 20=
 1062722 0 0 }{ button 295 158 2103 2104 1 0 72 }{ xmfhtmlgump 310 154 110 =
20 1062723 0 0 }{ button 295 176 2103 2104 1 0 73 }{ xmfhtmlgump 310 172 11=
0 20 1062724 0 0 }{ croppedtext 305 60 115 17 1101 13 }{ page 8 }{ button 1=
25 14 2205 2205 0 7 0 }{ button 393 14 2206 2206 0 9 0 }{ button 130 65 210=
3 2104 1 0 74 }{ croppedtext 145 60 115 17 0 14 }{ button 290 65 2103 2104 =
1 0 80 }{ croppedtext 305 60 115 17 0 14 }{ page 9 }{ button 125 14 2205 22=
05 0 8 0 }{ button 130 65 2103 2104 1 0 86 }{ croppedtext 145 60 115 17 0 1=
4 }{ button 290 65 2103 2104 1 0 92 }{ croppedtext 305 60 115 17 0 14 }",
+	textline=3D{
+		[1]=3D"10",
+		[2]=3D"NewHaven",
+		[3]=3D"LunaGate",
+		[4]=3D"BritainBank",
+		[5]=3D"BritainSewers",
+		[6]=3D"DespiseDungeon",
+		[7]=3D"LunaLibary",
+		[8]=3D"BritainFriedhof",
+		[9]=3D"TinkMinoc",
+		[10]=3D"TinkeMagi",
+		[11]=3D"Platin1",
+		[12]=3D"Platin2",
+		[13]=3D"Platin3",
+		[14]=3D"Empty",
+		[15]=3D"83? 3'S",
+		[16]=3D"154? 3'E",
+		[17]=3D"96? 35'N",
+		[18]=3D"21? 52'W",
+		[19]=3D"6? 56'S",
+		[20]=3D"8? 0'E",
+		[21]=3D"93? 9'N",
+		[22]=3D"27? 33'W",
+		[23]=3D"10? 1'N",
+		[24]=3D"4? 0'E",
+		[25]=3D"102? 44'N",
+		[26]=3D"80? 0'E",
+		[27]=3D"44? 17'S",
+		[28]=3D"168? 32'E",
+		[29]=3D"95? 21'N",
+		[30]=3D"66? 56'E",
+		[31]=3D"94? 18'N",
+		[32]=3D"59? 45'E",
+		[33]=3D"23? 49'N",
+		[34]=3D"42? 57'E",
+		[0]=3D"0",
+		},
+	textline_unicode=3D{
+		[1]=3D{49,48,},
+		[2]=3D{78,101,119,72,97,118,101,110,},
+		[3]=3D{76,117,110,97,71,97,116,101,},
+		[4]=3D{66,114,105,116,97,105,110,66,97,110,107,},
+		[5]=3D{66,114,105,116,97,105,110,83,101,119,101,114,115,},
+		[6]=3D{68,101,115,112,105,115,101,68,117,110,103,101,111,110,},
+		[7]=3D{76,117,110,97,76,105,98,97,114,121,},
+		[8]=3D{66,114,105,116,97,105,110,70,114,105,101,100,104,111,102,},
+		[9]=3D{84,105,110,107,77,105,110,111,99,},
+		[10]=3D{84,105,110,107,101,77,97,103,105,},
+		[11]=3D{80,108,97,116,105,110,49,},
+		[12]=3D{80,108,97,116,105,110,50,},
+		[13]=3D{80,108,97,116,105,110,51,},
+		[14]=3D{69,109,112,116,121,},
+		[15]=3D{56,51,176,32,51,39,83,},
+		[16]=3D{49,53,52,176,32,51,39,69,},
+		[17]=3D{57,54,176,32,51,53,39,78,},
+		[18]=3D{50,49,176,32,53,50,39,87,},
+		[19]=3D{54,176,32,53,54,39,83,},
+		[20]=3D{56,176,32,48,39,69,},
+		[21]=3D{57,51,176,32,57,39,78,},
+		[22]=3D{50,55,176,32,51,51,39,87,},
+		[23]=3D{49,48,176,32,49,39,78,},
+		[24]=3D{52,176,32,48,39,69,},
+		[25]=3D{49,48,50,176,32,52,52,39,78,},
+		[26]=3D{56,48,176,32,48,39,69,},
+		[27]=3D{52,52,176,32,49,55,39,83,},
+		[28]=3D{49,54,56,176,32,51,50,39,69,},
+		[29]=3D{57,53,176,32,50,49,39,78,},
+		[30]=3D{54,54,176,32,53,54,39,69,},
+		[31]=3D{57,52,176,32,49,56,39,78,},
+		[32]=3D{53,57,176,32,52,53,39,69,},
+		[33]=3D{50,51,176,32,52,57,39,78,},
+		[34]=3D{52,50,176,32,53,55,39,69,},
+		[0]=3D{48,},
+		},
+}
+	=

 	=


Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Wed Jul  2 00:16:48 2008
@@ -739,10 +739,10 @@
 		local data =3D fifo:PopUint8()
 		if (head ~=3D 0) then
 			ascipart =3D ascipart .. "?" .. (data ~=3D 0 and string.format("%c",dat=
a) or "")
-			table.insert(unicode_charcodes,head*256 + data)
 		else
 			ascipart =3D ascipart .. string.format("%c",data)
 		end
+		table.insert(unicode_charcodes,head*256 + data)
 	end
 	return ascipart,unicode_charcodes
 end

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Wed Jul  2 00:16:48 2008
@@ -58,27 +58,39 @@
 	glyphlist:Clear()
 	=

 	--~ print("uohtml start",self.params.scrollbar)
-	for plaintext,tag in string.gfind(uohtml, "([^<]*)(<?[^>]*>?)") do =

+	if (type(uohtml) =3D=3D "table") then
+		-- unicode glyphs, but no html
 		local fontid,bold,col =3D unpack(statestack[#statestack])
 		local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
-		if (plaintext ~=3D "") then =

-			-- plain text
-			--~ print("uohtml plain",plaintext)
-			glyphlist:AddText(font,fontsize,plaintext,col)
+		local fontsize =3D fontsize or font:GetDefaultFontSize()
+		for k,unicode_charcode in pairs(uohtml) do =

+			--~ print("uohtml:unicode",unicode_charcode)
+			glyphlist:AddFontGlyph(font,fontsize,unicode_charcode,col)
 		end
-		if (tag ~=3D "") then
-			-- html-tag
-			if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

-			if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

-			if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end =
-- fontchange
-			if (tag =3D=3D "</BIG>") then table.remove(statestack) end
-			if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
-			=

-			--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
-			--~ for token in string.gfind(textstring, "%w+") do table.insert(bToken=
,token) end
-			--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
-			=

-			--~ print("uohtml tag",tag)
+	else
+		-- non-unicode
+		for plaintext,tag in string.gfind(uohtml, "([^<]*)(<?[^>]*>?)") do =

+			local fontid,bold,col =3D unpack(statestack[#statestack])
+			local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
+			if (plaintext ~=3D "") then =

+				-- plain text
+				--~ print("uohtml plain",plaintext)
+				glyphlist:AddText(font,fontsize,plaintext,col)
+			end
+			if (tag ~=3D "") then
+				-- html-tag
+				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

+				if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

+				if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end=
 -- fontchange
+				if (tag =3D=3D "</BIG>") then table.remove(statestack) end
+				if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
+				=

+				--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
+				--~ for token in string.gfind(textstring, "%w+") do table.insert(bToke=
n,token) end
+				--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
+				=

+				--~ print("uohtml tag",tag)
+			end
 		end
 	end
 	self:UpdateGeometry()



From no-reply at zwischenwelt.org  Wed Jul  2 16:40:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 02 Jul 2008 14:40:08 -0000
Subject: [Iris-commit] [IRIS] r2281 - in /trunk: lua/gui/gui.gumpparser.lua
 widgets/widget.gumpdialog.lua widgets/widget.uocheckbox.lua
 widgets/widget.uoedittext.lua widgets/widget.uoradiobutton.lua
 widgets/widget.uotext.lua
Message-ID: <20080702144008.7FF351C180A8@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Jul  2 16:40:07 2008
New Revision: 2281

Log:
gumpparser-guisys2 : started radiobutton,checkbox and edittext code

Added:
    trunk/widgets/widget.uocheckbox.lua
    trunk/widgets/widget.uoedittext.lua
    trunk/widgets/widget.uoradiobutton.lua
Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/widgets/widget.gumpdialog.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Wed Jul  2 16:40:07 2008
@@ -247,129 +247,6 @@
 	return GetDesktopWidget():CreateChild("GumpDialog",{dialogId=3DdialogId,b=
ClientSideMode=3DbClientSideMode})
 end
 =

--- returns widget
--- param : x,y,gump_id/art_id,width,height,hue=3D0,tiled=3Dfalse(strech),c=
hecker=3Dfalse(gray-transparent-background),multipart=3Dfalse(true for resi=
zepic)
--- either art_id or gump_id is used
-function GumpParser_MakeImage (parent,param) return parent:CreateChild("UO=
Image",param) end
---~ function GumpParser_MakeImage (parent,param)  end
-
--- returns widget
--- param : x,y,width,height,cliloc_id/textline_id,background,scrollbar,hue=
  : background=3D0/1=3Dtransparent?  scrollbar=3D0/1=3Ddisplayed
-function GumpParser_MakeText (parent,param,textlines) return parent:Create=
Child("UOText",param,textlines) end
---~ function GumpParser_MakeText (parent,param,textlines)  end
-
--- returns widget
--- param : x,y,gump_id_normal,gump_id_pressed,quit,page_id,return_value
--- optionally : art_id,hue,art_x,art_y    if an art-image is used as butto=
n label
-function GumpParser_MakeButton (parent,param) return parent:CreateChild("U=
OButton",param,textlines) end
---~ function GumpParser_MakeButton (parent,param)  end
-
-
-				=

--- returns widget
--- param : x,y,width,height,hue,return_value,textline_id_default
-function GumpParser_MakeEditText (parent,param) end
-	print("TODO:GumpParser_MakeEditText")
-				--[[
-				widget =3D CreatePlainEditText (parent, x,y,width,height, {1.0,1.0,1.0=
,1.0})
-				local text =3D Gumpdata.textline[textline_id_default] or "No textentry"
-				widget:SetText(UnicodeFix(text))
-
-				widget.mbIgnoreMouseOver =3D false
-				widget.returnmsg =3D return_value
-				widget.returndefid =3D textline_id_default
-
-				widget.onMouseLeave =3D function (widget) widget:Deactivate() end
-				table.insert(dialog.uo_text,widget)
-				]]--
-				=

--- returns widget
--- param : x,y,gump_id_normal,gump_id_pressed,status,return_value
-function GumpParser_MakeRadioButton (parent,param,groupnumber) end
-	print("TODO:GumpParser_MakeRadioButton")
-				--[[
-				widget =3D MakeRadioButton(parent,param)
-				local radio_x =3D x
-				local radio_y =3D y
-				local radio_norm =3D gump_id_normal
-				local radio_down =3D gump_id_pressed
-				local radio_state =3D tonumber(param.status)
-				local radio_rtn =3D tonumber(return_value)
-				if (radio_state=3D=3D0) then
-					widget =3D MakeBorderGumpPart(parent, radio_norm, radio_x, radio_y)
-				else
-					widget =3D MakeBorderGumpPart(parent, radio_down, radio_x, radio_y)
-				end
-				widget.state=3Dradio_state
-				widget.returnmsg=3Dradio_rtn
-				widget.mbIgnoreMouseOver =3D false
-				widget.mat_normal 	=3D GetGumpMat(radio_norm)
-				widget.mat_pressed 	=3D GetGumpMat(radio_down)
-
-				widget.onMouseDown	=3D function (widget,mousebutton)
-										if (mousebutton =3D=3D 1) then
-											if (widget.state=3D=3D0) then
-												widget.gfx:SetMaterial(widget.mat_pressed)
-												widget.state=3D1
-											else
-												widget.gfx:SetMaterial(widget.mat_normal)
-												widget.state=3D0
-											end
-											printdebug("gump","RadioButton changed : id=3D"..widget.returnm=
sg.." state=3D"..widget.state)
-										end
-									   end
-				table.insert(dialog.uo_radio,widget)
-				]]--
-				=

-				=

--- returns widget
--- param : x,y,gump_id_normal,gump_id_pressed,status,return_value
-function GumpParser_MakeCheckBox (parent,param) end
-	print("TODO:GumpParser_MakeCheckBox")
-				--[[
-				widget =3D MakeCheckBox(parent,param)
-				local check_x =3D x
-				local check_y =3D y
-				local check_norm =3D gump_id_normal
-				local check_down =3D gump_id_pressed
-				local check_state =3D tonumber(param.status)
-				local check_rtn	=3D return_value
-
-				widget =3D MakeGumpCheckBox(parent, check_state > 0, check_norm, check=
_down, check_x, check_y)
-				=

-				if (false) then
-					if (check_state=3D=3D0) then
-						widget =3D MakeBorderGumpPart(parent, check_norm, check_x, check_y)
-					else
-						widget =3D MakeBorderGumpPart(parent, check_down, check_x, check_y)
-					end
-					widget.state=3Dcheck_state
-					widget.returnmsg=3Dcheck_rtn
-					widget.mbIgnoreMouseOver =3D false
-					widget.mat_normal 	=3D GetGumpMat(check_norm)
-					widget.mat_pressed 	=3D GetGumpMat(check_down)
-
-					widget.onMouseDown	=3D function (widget,mousebutton)
-											if (mousebutton =3D=3D 1) then
-												if (widget.state=3D=3D0) then
-													widget.gfx:SetMaterial(widget.mat_pressed)
-													widget.state=3D1
-												else
-													widget.gfx:SetMaterial(widget.mat_normal)
-													widget.state=3D0
-												end
-												printdebug("gump","Checkbox changed : id=3D"..widget.returnmsg=
.." state=3D"..widget.state)
-											end
-										  end
-				end
-				=

-				table.insert(dialog.uo_check,widget)
-				]]--
-				=

-function GumpParser_SetToolTipp	(widget,cliloc_id)
-	print("TODO:GumpParser_SetToolTipp")
-end
-
 =

 -- close already existing dialog with the same id
 function GumpParser_CloseOldDialog	(dialogId,playerid,bClientSideMode)
@@ -469,36 +346,36 @@
 		--xmfhtmlgump <x> <y> <width> <height> <cliloc_id> <background> <scrollb=
ar>
 		--Description:	background=3D0/1=3Dtransparent?  scrollbar=3D0/1=3Ddispla=
yed
 		elseif (command =3D=3D "xmfhtmlgump") then
-			widget =3D GumpParser_MakeText(parent,param)
+			widget =3D parent:CreateChild("UOText",param)
 			=

 		--xmfhtmlgumpcolor <x> <y> <width> <height> <cliloc_id> <background> <sc=
rollbar> <hue>
 		--Description:	background=3D0/1=3Dtransparent?  scrollbar=3D0/1=3Ddispla=
yed
 		elseif (command =3D=3D "xmfhtmlgumpcolor") then
-			widget =3D GumpParser_MakeText(parent,param)
+			widget =3D parent:CreateChild("UOText",param)
 			=

 		-- croppedtext <x> <y> <width> <height> <hue> <textline_id>
 		-- Description:  Adds a text field to the gump. This is similar to the t=
ext command,
 		-- but the text is cropped to the defined area.
 		-- text is automatically bold/outlined
 		elseif (command =3D=3D "croppedtext") then
-			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline_unicode o=
r Gumpdata.textline)
+			widget =3D parent:CreateChild("UOText",param,Gumpdata.textline_unicode =
or Gumpdata.textline)
 			=

 		--HtmlGump <x> <y> <width> <height> <textline_id> <background> <scrollba=
r>
 		--Description:  Defines a text-area where Html-commands are allowed.
 		--				<background> and <scrollbar> can be 0 or 1 and define whether the =
background is transparent and a scrollbar is displayed.
 		--{ htmlgump 10 8 100 20 0 0 0 }
 		elseif (command =3D=3D "htmlgump") then
-			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline_unicode o=
r Gumpdata.textline)
+			widget =3D parent:CreateChild("UOText",param,Gumpdata.textline_unicode =
or Gumpdata.textline)
 			=

 		--text <x> <y> <hue> <textline_id>
 		--Description:  Defines the position and hue of a text (data) entry.
 		elseif (command =3D=3D "text") then
-			widget =3D GumpParser_MakeText(parent,param,Gumpdata.textline_unicode o=
r Gumpdata.textline)
+			widget =3D parent:CreateChild("UOText",param,Gumpdata.textline_unicode =
or Gumpdata.textline)
 =

 		--tooltip <cliloc_id>
 		--Description:  Adds to the previous layoutarray entry a Tooltip with th=
e in [cliloc-nr] defined Cliloc entry
 		elseif (command =3D=3D "tooltip") then
-			if (widget) then GumpParser_SetToolTipp(widget,param.cliloc_id) end
+			print("TODO:GumpParser_SetToolTipp",widget,param.cliloc_id)
 			=

 			=

 			=

@@ -511,33 +388,33 @@
 		--consists of multiple(9) parts, for which gump_id is the base-id, a bor=
der-frame like thing, dialog background for example. tiled
 		-- multipart=3Dtrue : the gump_id is just the base id, the border tiles =
have different ids, calculated from it
 		elseif (command =3D=3D "resizepic") then
-			widget =3D GumpParser_MakeImage(parent,param)
+			widget =3D parent:CreateChild("UOImage",param)
 			=

 		--gumppic <x> <y> <gump_id> [hue=3D353]
 		--Description:  Adds a graphic to the gump, where <id> ist the graphic i=
d of an item.
 		--				Optionaly there is a color parameter. =

 		elseif (command =3D=3D "gumppic") then
-			widget =3D GumpParser_MakeImage(parent,param)
+			widget =3D parent:CreateChild("UOImage",param)
 =

 		--gumppictiled <x> <y> <width> <height> <gump_id>
 		--Description:  Similar to GumpPic, but the gumppic is tiled to the give=
n <height> and <width>.
 		elseif (command =3D=3D "gumppictiled") then
-			widget =3D GumpParser_MakeImage(parent,param)
+			widget =3D parent:CreateChild("UOImage",param)
 =

 		--checkertrans <x> <y> <width> <height>
 		--Description:  Creates a transparent rectangle on position <x,y> using =
<width> and <height>.
 		elseif (command =3D=3D "checkertrans") then
-			widget =3D GumpParser_MakeImage(parent,param)
+			widget =3D parent:CreateChild("UOImage",param)
 =

 		--tilepic <x> <y> <art_id>
 		--Description:  Adds a Tilepicture to the gump. <id> defines the tile gr=
aphic-id.
 		elseif (command =3D=3D "tilepic") then
-			widget =3D GumpParser_MakeImage(parent,param)
+			widget =3D parent:CreateChild("UOImage",param)
 =

 		--TilePicHue <x> <y> <art_id> <hue>
 		--Description:  Similar to the tilepic command, but with an additional h=
ue parameter.
 		elseif (command =3D=3D "tilepichue") then
-			widget =3D GumpParser_MakeImage(parent,param)
+			widget =3D parent:CreateChild("UOImage",param)
 		=

 		=

 		=

@@ -551,7 +428,7 @@
 		--				Use <page-id> to switch between pages and <quit>=3D1/0 to close th=
e gump.
 		--  return_value is optional on pol
 		elseif (command =3D=3D "button") then
-			widget =3D GumpParser_MakeButton(parent,param)
+			widget =3D parent:CreateChild("UOButton",param)
 =

 		--buttontileart <x> <y> <gump_id_normal> <gump_id_pressed> <quit> <page_=
id> <return_value> <art_id> <hue> <art_x> <art_y>
 		--Client introduced: between 4.0.4d and 5.0.2b
@@ -559,18 +436,18 @@
 		--				<tile-x> and <tile-y> define the coordinates of the tile graphic a=
nd are relative to <x> and <y>.
 		--{ buttontileart 432 248 9010 9010 1 0 33 1352 0 100 20 }
 		elseif (command =3D=3D "buttontileart") then
-			widget =3D GumpParser_MakeButton(parent,param)
+			widget =3D parent:CreateChild("UOButton",param)
 			=

 		--checkbox <x> <y> <gump_id_normal> <gump_id_pressed> <status> <return_v=
alue>
 		--Description:  Adds a CheckBox to the gump. Multiple CheckBoxes can be =
pressed at the same time.
 		--				Check the <return-value> if you want to know which CheckBoxes were=
 selected.
 		elseif (command =3D=3D "checkbox") then
-			widget =3D GumpParser_MakeCheckBox(parent,param)
+			widget =3D parent:CreateChild("UOCheckBox",param)
 			=

 		--radio <x> <y> <gump_id_normal> <gump_id_pressed> <status> <return_valu=
e>
 		--Description:  Same as Checkbox, but only one Radiobutton can be presse=
d at the same time, except they are per linked via the 'Group' command.
 		elseif (command =3D=3D "radio") then
-			widget =3D GumpParser_MakeRadioButton(parent,param,groupnumber)
+			widget =3D parent:CreateChild("UORadioButton",param,groupnumber)
 			=

 		--Group <groupnumber>
 		--Description:  Links radio buttons to a group. Group is send before rad=
iobuttons. Seems only to work on page 0 and 1.  =

@@ -581,7 +458,8 @@
 		--Description:  Defines an area where the <default-text-id> is displayed.
 		--				The player can modify this data. To get this data check the <retur=
n-value>
 		elseif (command =3D=3D "textentry") then
-			widget =3D GumpParser_MakeEditText(parent,param)
+			widget =3D parent:CreateChild("UOEditText",param,Gumpdata.textline_unic=
ode or Gumpdata.textline)
+			=

 			=

 			=

 			=


Modified: trunk/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.gumpdialog.lua (original)
+++ trunk/widgets/widget.gumpdialog.lua Wed Jul  2 16:40:07 2008
@@ -14,6 +14,7 @@
 	self.uo_radio	=3D {} -- for return-message
 	self.uo_check	=3D {} -- for return-message
 	self.uo_text	=3D {} -- for return-message
+	self.radiogroups =3D {} -- see widget.uoradiobutton.lua
 	self.pages		=3D {}
 	=

 	-- old : guimaker.MakeSortedDialog()

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Wed Jul  2 16:40:07 2008
@@ -37,7 +37,8 @@
 =

 -- TODO : uohtml might be an array of ints for unicode (textline) instead =
of text (no html then)
 -- see also HtmlParser in lib.gumpparser.lua
-function gWidgetPrototype.UOText:SetUOHtml (uohtml,font)
+function gWidgetPrototype.UOText:GetUOHtml () return self.uohtml end
+function gWidgetPrototype.UOText:SetUOHtml (uohtml)
 	self.uohtml =3D uohtml
 	local fontsize =3D nil
 	local fontid =3D 1



From no-reply at zwischenwelt.org  Wed Jul  2 19:40:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 02 Jul 2008 17:40:36 -0000
Subject: [Iris-commit] [IRIS] r2283 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/lib.gump.samples.lua widgets/widget.gumpdialog.lua
 widgets/widget.uobutton.lua widgets/widget.uoedittext.lua
Message-ID: <20080702180007.1A1571C1800F@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Jul  2 19:40:36 2008
New Revision: 2283

Log:
gumpdialog : sendclose message

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.gump.samples.lua
    trunk/widgets/widget.gumpdialog.lua
    trunk/widgets/widget.uobutton.lua
    trunk/widgets/widget.uoedittext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Wed Jul  2 19:40:36 2008
@@ -10,6 +10,10 @@
 ]]--
 dofile(libpath .. "lib.gump.samples.lua")
 =

+function GumpParser (Gumpdata, Clientsidemode)
+	--~ if (not Clientsidemode) then return GumpParser_New(Gumpdata, Clientsi=
demode) end
+	return GumpParser_Old(Gumpdata, Clientsidemode)
+end
 =

 function GumpParserTest ()
 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
@@ -33,17 +37,18 @@
 	kClientSideGump_Skill			=3D skillGump			-- the big skill list dialog with=
 up/down/lock boxes, grab icons and scrollbar
 	kClientSideGump_Journal			=3D journalGump	-- a very simple message log in=
 papyrus-scroll look
 	]]--
-	local testgump,x,y =3D kGumpSample_ChangeLog,400,00
+	--~ local testgump,x,y =3D kGumpSample_ChangeLog,400,00
 	--~ local testgump,x,y =3D kGumpSample_ChangeLog_Text,400,00
 	--~ local testgump,x,y =3D kGumpSample_RuneBook,0,240
 	--~ local testgump,x,y =3D kGumpSample_Reward,0,140
+	local testgump,x,y =3D kGumpSample_MoongateMenu,0,140
 	local profiler =3D MakeProfiler("gumpparser")
 	if (1 =3D=3D 1) then
 		profiler:StartSection("font:preload")
 		GetUOFont(gUniFontLoaderList[1],true):PreLoad()
 		GetUOFont(gUniFontLoaderList[1],false):PreLoad()
 		profiler:StartSection("old")
-		GumpParser(testgump,false)
+		--~ GumpParser_Old(testgump,false)
 		profiler:StartSection("new")
 		local dialog =3D GumpParser_New(testgump,false) dialog:SetPos(x,y)
 		profiler:Finish()
@@ -59,8 +64,6 @@
 	=

 	--~ local p =3D dialog:GetPage(0)
 	--~ local cl =3D p:ForAllChilds(function (child,k) print("ordered_childli=
st_page0:",k,child:GetClassName()) end)
-	=

-	-- TODO : html-center : glyphlist : glyphs to change h-alignment during p=
arsing ? needs line width.. and full text width (unless wrap specified !)
 	=

 	GUITest_MainLoop()
 	os.exit(0)
@@ -212,7 +215,8 @@
 =

 	local dialog =3D gServerSideGump[dialogId]
 	if (not dialog) then printdebug("gump","CloseServerSideGump : dialog not =
found=3D",dialogId) return end
-
+	if (dialog.SendClose) then dialog:SendClose(buttonId) return end
+	=

 	local params =3D ServerSideGump_GetParams(dialogId)
 	GumpReturnMsg(playerId, dialogId, buttonId, params)
 =

@@ -240,11 +244,6 @@
 		res[fieldname] =3D tokenval
 	end
 	return res
-end
-
--- returns dialog-widget
-function GumpParser_CreateDialog	(dialogId,bClientSideMode)
-	return GetDesktopWidget():CreateChild("GumpDialog",{dialogId=3DdialogId,b=
ClientSideMode=3DbClientSideMode})
 end
 =

 =

@@ -279,12 +278,31 @@
 kGumpParser_CommandTypes["gumppic"]				=3D {paramformat=3D"x,y,gump_id,...=
"}
 				=

 =

+function GumpParser_DebugDumpGump (Gumpdata)
+	-- debug dump
+	if (1 =3D=3D 1 and (not Clientsidemode)) then =

+		print("\n\n##### GUMP #####\n\n\""..Gumpdata.Data.."\",\n\ntextline=3D{"=
) =

+		for k,v in pairs(Gumpdata.textline or {}) do print("["..k.."]=3D\""..v..=
"\",") end =

+		print("},")
+		print("textline_unicode=3D{")
+		for k,unicode_arr in pairs(Gumpdata.textline_unicode or {}) do =

+			printf("["..k.."]=3D{") =

+			for k2,unicode_charcode in pairs(unicode_arr) do printf("%d,",unicode_c=
harcode) end
+			printf("},\n") =

+		end =

+		print("},")
+		print("#######\n\n") =

+	end
+end
+
+
 function GumpParser_New (Gumpdata, bClientSideMode)
 	-- if there is a dialog with the same id, close it
 	GumpParser_CloseOldDialog(Gumpdata.dialogId,Gumpdata.playerid,bClientSide=
Mode)
+	--~ GumpParser_DebugDumpGump(Gumpdata)
 	=

 	-- setup
-	local dialog =3D GumpParser_CreateDialog(Gumpdata.dialogId,bClientSideMod=
e)
+	local dialog =3D GetDesktopWidget():CreateChild("GumpDialog",{dialogId=3D=
Gumpdata.dialogId,bClientSideMode=3DbClientSideMode,Gumpdata=3DGumpdata})
 	dialog.gumpdata =3D Gumpdata -- for debugging
 	local parent =3D dialog:GetPage(0)
 	local groupnumber =3D -1 -- for radiobuttons
@@ -484,23 +502,10 @@
 end
 =

 =

-function GumpParser(Gumpdata, Clientsidemode)
+	=

+function GumpParser_Old (Gumpdata, Clientsidemode)
 	if (not gGumpLoader) then return end
 =

-	=

-	if (1 =3D=3D 2 and (not Clientsidemode)) then =

-		print("\n\n##### GUMP #####\n\n"..Gumpdata.Data.."\n\ntextline=3D{") =

-		for k,v in pairs(Gumpdata.textline or {}) do print("["..k.."]=3D\""..v..=
"\",") end =

-		print("},")
-		print("textline_unicode=3D{")
-		for k,unicode_arr in pairs(Gumpdata.textline_unicode or {}) do =

-			printf("["..k.."]=3D{") =

-			for k2,unicode_charcode in pairs(unicode_arr) do printf("%d,",unicode_c=
harcode) end
-			printf("},\n") =

-		end =

-		print("},")
-		print("#######\n\n") =

-	end
 	=

 	local htext_correction=3D5
 =


Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Wed Jul  2 19:40:36 2008
@@ -1,18 +1,6 @@
 -- a few recorded example gumps for testing
 =

-kGumpSample_Reward =3D {
-	Data=3D"{ page 0 }{ resizepic 10 10 2600 500 135 }{ xmfhtmlgump 52 35 420=
 55 1006046 1 1 }{ button 60 95 4005 4007 1 0 1 }{ xmfhtmlgump 95 96 150 35=
 1006044 0 0 }{ button 285 95 4017 4019 1 0 0 }{ xmfhtmlgump 320 96 150 35 =
1006045 0 0 }",
-	textline=3D{}
-	}
 =

-kGumpSample_ChangeLog =3D {
-	Data=3D"{ page 0 }{ resizepic 0 0 9270 350 272 }{ resizepic 10 35 9270 33=
0 227 }{ button 298 15 22153 22155 1 0 1 }{ button 319 15 22150 22152 1 0 0=
 }{ resizepic 81 10 9270 188 35 }{ text 91 17 2101 0 }{ resizepic 91 45 927=
0 168 35 }{ croppedtext 160 52 29 16 2101 1 }{ gumppictiled 30 81 290 162 2=
624 }{ checkertrans 30 81 290 162 }{ button 30 55 5603 5607 1 0 11 }{ butto=
n 304 55 5601 5605 1 0 11 }{ htmlgump 30 81 290 162 2 0 1 }",
-	textline=3D{
-		[1]=3D"News",
-		[2]=3D"<CENTER><BIG>28.06.2008 by Lumberman<BR>-------------------------=
---------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Forum unter www=
.vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BIG>23.06.200=
8 by Lumberman<BR>----------------------------------</BIG></CENTER>Patch ei=
ngespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder im Changel=
og (Pfeil rechts)<BR><CENTER><BIG>15.06.2008 by Lumberman<BR>--------------=
--------------------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Foru=
m unter www.vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BI=
G>14.06.2008 by Lumberman<BR>----------------------------------</BIG></CENT=
ER>Patch eingespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder=
 im Changelog (Pfeil rechts)",
-		[0]=3D"Message of the Day - Main",
-		}
-	}
 	=

 kGumpSample_RuneBook =3D {
 	Data=3D"{ page 0 }{ gumppic 100 10 2201 }{ gumppic 125 50 57 }{ gumppic 1=
45 50 58 }{ gumppic 160 50 58 }{ gumppic 175 50 58 }{ gumppic 190 50 58 }{ =
gumppic 205 50 58 }{ gumppic 220 50 58 }{ gumppic 230 50 59 }{ gumppic 290 =
50 57 }{ gumppic 310 50 58 }{ gumppic 325 50 58 }{ gumppic 340 50 58 }{ gum=
ppic 355 50 58 }{ gumppic 370 50 58 }{ gumppic 385 50 58 }{ gumppic 395 50 =
59 }{ button 130 187 2225 2225 0 2 0 }{ button 165 187 2226 2226 0 3 0 }{ b=
utton 200 187 2227 2227 0 4 0 }{ button 235 187 2228 2228 0 5 0 }{ button 3=
00 187 2229 2229 0 6 0 }{ button 335 187 2230 2230 0 7 0 }{ button 370 187 =
2231 2231 0 8 0 }{ button 405 187 2232 2232 0 9 0 }{ xmfhtmlgump 140 40 80 =
18 1011296 0 0 }{ htmlgump 220 40 30 18 0 0 0 }{ xmfhtmlgump 300 40 100 18 =
1011297 0 0 }{ htmlgump 400 40 30 18 1 0 0 }{ page 1 }{ button 125 15 2472 =
2473 1 0 1 }{ xmfhtmlgump 158 22 100 18 1011299 0 0 }{ button 130 65 2103 2=
104 1 0 2 }{ croppedtext 145 60 115 17 49 2 }{ button 130 80 2103 2104 1 0 =
8 }{ croppedtext 145 75 115 17 1153 3 }{ button 130 95 2103 2104 1 0 14 }{ =
croppedtext 145 90 115 17 1153 4 }{ button 130 110 2103 2104 1 0 20 }{ crop=
pedtext 145 105 115 17 1101 5 }{ button 130 125 2103 2104 1 0 26 }{ cropped=
text 145 120 115 17 1101 6 }{ button 130 140 2103 2104 1 0 32 }{ croppedtex=
t 145 135 115 17 1101 7 }{ button 130 155 2103 2104 1 0 38 }{ croppedtext 1=
45 150 115 17 1101 8 }{ button 130 170 2103 2104 1 0 44 }{ croppedtext 145 =
165 115 17 49 9 }{ button 290 65 2103 2104 1 0 50 }{ croppedtext 305 60 115=
 17 1150 10 }{ button 290 80 2103 2104 1 0 56 }{ croppedtext 305 75 115 17 =
49 11 }{ button 290 95 2103 2104 1 0 62 }{ croppedtext 305 90 115 17 49 12 =
}{ button 290 110 2103 2104 1 0 68 }{ croppedtext 305 105 115 17 1153 13 }{=
 button 290 125 2103 2104 1 0 74 }{ croppedtext 305 120 115 17 1101 14 }{ b=
utton 290 140 2103 2104 1 0 80 }{ croppedtext 305 135 115 17 1101 14 }{ but=
ton 290 155 2103 2104 1 0 86 }{ croppedtext 305 150 115 17 1101 14 }{ butto=
n 290 170 2103 2104 1 0 92 }{ croppedtext 305 165 115 17 1101 14 }{ button =
393 14 2206 2206 0 2 0 }{ page 2 }{ button 125 14 2205 2205 0 1 0 }{ button=
 393 14 2206 2206 0 3 0 }{ button 130 65 2103 2104 1 0 2 }{ text 135 80 0 1=
5 }{ text 135 95 0 16 }{ button 135 115 2437 2438 1 0 3 }{ xmfhtmlgump 150 =
115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 4 }{ xmfhtmlgump 175 =
15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 5 }{ xmfhtmlgump 150 =
136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 6 }{ xmfhtmlgump 150=
 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 7 }{ xmfhtmlgump 15=
0 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 49 2 }{ button 290 65=
 2103 2104 1 0 8 }{ text 295 80 0 17 }{ text 295 95 0 18 }{ button 295 115 =
2437 2438 1 0 9 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 =
2361 2361 1 0 10 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140=
 2103 2104 1 0 11 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 1=
58 2103 2104 1 0 12 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295=
 176 2103 2104 1 0 13 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedt=
ext 305 60 115 17 1153 3 }{ page 3 }{ button 125 14 2205 2205 0 2 0 }{ butt=
on 393 14 2206 2206 0 4 0 }{ button 130 65 2103 2104 1 0 14 }{ text 135 80 =
0 19 }{ text 135 95 0 20 }{ button 135 115 2437 2438 1 0 15 }{ xmfhtmlgump =
150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 16 }{ xmfhtmlgump=
 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 17 }{ xmfhtmlgum=
p 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 18 }{ xmfhtmlg=
ump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 19 }{ xmfhtm=
lgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 1153 4 }{ but=
ton 290 65 2103 2104 1 0 20 }{ text 295 80 0 21 }{ text 295 95 0 22 }{ butt=
on 295 115 2437 2438 1 0 21 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ bu=
tton 300 20 2361 2361 1 0 22 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ bu=
tton 295 140 2103 2104 1 0 23 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ =
button 295 158 2103 2104 1 0 24 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }=
{ button 295 176 2103 2104 1 0 25 }{ xmfhtmlgump 310 172 110 20 1062724 0 0=
 }{ croppedtext 305 60 115 17 1101 5 }{ page 4 }{ button 125 14 2205 2205 0=
 3 0 }{ button 393 14 2206 2206 0 5 0 }{ button 130 65 2103 2104 1 0 26 }{ =
text 135 80 0 23 }{ text 135 95 0 24 }{ button 135 115 2437 2438 1 0 27 }{ =
xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 20 2361 2361 1 0 28 }{=
 xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2104 1 0 29 }=
{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 135 158 2103 2104 1 0 30=
 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button 135 176 2103 2104 1 0 =
31 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145 60 115 17 1=
101 6 }{ button 290 65 2103 2104 1 0 32 }{ text 295 80 0 25 }{ text 295 95 =
0 26 }{ button 295 115 2437 2438 1 0 33 }{ xmfhtmlgump 310 115 100 18 10112=
98 0 0 }{ button 295 140 2103 2104 1 0 35 }{ xmfhtmlgump 310 136 110 20 106=
2722 0 0 }{ button 295 158 2103 2104 1 0 36 }{ xmfhtmlgump 310 154 110 20 1=
062723 0 0 }{ button 295 176 2103 2104 1 0 37 }{ xmfhtmlgump 310 172 110 20=
 1062724 0 0 }{ croppedtext 305 60 115 17 1101 7 }{ page 5 }{ button 125 14=
 2205 2205 0 4 0 }{ button 393 14 2206 2206 0 6 0 }{ button 130 65 2103 210=
4 1 0 38 }{ text 135 80 0 27 }{ text 135 95 0 28 }{ button 135 115 2437 243=
8 1 0 39 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 20 2361 23=
61 1 0 40 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 140 2103 2=
104 1 0 41 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 135 158 2103=
 2104 1 0 42 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button 135 176 21=
03 2104 1 0 43 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ croppedtext 145=
 60 115 17 1101 8 }{ button 290 65 2103 2104 1 0 44 }{ text 295 80 0 29 }{ =
text 295 95 0 30 }{ button 295 115 2437 2438 1 0 45 }{ xmfhtmlgump 310 115 =
100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 46 }{ xmfhtmlgump 315 15 =
100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 47 }{ xmfhtmlgump 310 13=
6 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 48 }{ xmfhtmlgump 310 =
154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 49 }{ xmfhtmlgump 31=
0 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 49 9 }{ page 6 }{ but=
ton 125 14 2205 2205 0 5 0 }{ button 393 14 2206 2206 0 7 0 }{ button 130 6=
5 2103 2104 1 0 50 }{ text 135 80 0 31 }{ text 135 95 0 32 }{ button 135 11=
5 2437 2438 1 0 51 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button 160 =
20 2361 2361 1 0 52 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button 135 =
140 2103 2104 1 0 53 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ button 13=
5 158 2103 2104 1 0 54 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ button =
135 176 2103 2104 1 0 55 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ cropp=
edtext 145 60 115 17 1150 10 }{ button 290 65 2103 2104 1 0 56 }{ text 295 =
80 0 33 }{ text 295 95 0 34 }{ button 295 115 2437 2438 1 0 57 }{ xmfhtmlgu=
mp 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 58 }{ xmfhtmlg=
ump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 59 }{ xmfhtml=
gump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 60 }{ xmfht=
mlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 61 }{ xmf=
htmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 49 11 }{ p=
age 7 }{ button 125 14 2205 2205 0 6 0 }{ button 393 14 2206 2206 0 8 0 }{ =
button 130 65 2103 2104 1 0 62 }{ text 135 80 0 35 }{ text 135 95 0 36 }{ b=
utton 135 115 2437 2438 1 0 63 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{=
 button 160 20 2361 2361 1 0 64 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{=
 button 135 140 2103 2104 1 0 65 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 =
}{ button 135 158 2103 2104 1 0 66 }{ xmfhtmlgump 150 154 110 20 1062723 0 =
0 }{ button 135 176 2103 2104 1 0 67 }{ xmfhtmlgump 150 172 110 20 1062724 =
0 0 }{ croppedtext 145 60 115 17 49 12 }{ button 290 65 2103 2104 1 0 68 }{=
 text 295 80 0 37 }{ text 295 95 0 38 }{ button 295 115 2437 2438 1 0 69 }{=
 xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 70 }=
{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 71 =
}{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 7=
2 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0=
 73 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 =
1153 13 }{ page 8 }{ button 125 14 2205 2205 0 7 0 }{ button 393 14 2206 22=
06 0 9 0 }{ button 130 65 2103 2104 1 0 74 }{ text 135 80 0 39 }{ text 135 =
95 0 40 }{ button 135 115 2437 2438 1 0 75 }{ xmfhtmlgump 150 115 100 18 10=
11298 0 0 }{ button 160 20 2361 2361 1 0 76 }{ xmfhtmlgump 175 15 100 18 10=
11300 0 0 }{ button 135 140 2103 2104 1 0 77 }{ xmfhtmlgump 150 136 110 20 =
1062722 0 0 }{ button 135 158 2103 2104 1 0 78 }{ xmfhtmlgump 150 154 110 2=
0 1062723 0 0 }{ button 135 176 2103 2104 1 0 79 }{ xmfhtmlgump 150 172 110=
 20 1062724 0 0 }{ croppedtext 145 60 115 17 1101 14 }{ button 290 65 2103 =
2104 1 0 80 }{ text 295 80 0 39 }{ text 295 95 0 40 }{ button 295 115 2437 =
2438 1 0 81 }{ xmfhtmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361=
 2361 1 0 82 }{ xmfhtmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 210=
3 2104 1 0 83 }{ xmfhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2=
103 2104 1 0 84 }{ xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176=
 2103 2104 1 0 85 }{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext =
305 60 115 17 1101 14 }{ page 9 }{ button 125 14 2205 2205 0 8 0 }{ button =
130 65 2103 2104 1 0 86 }{ text 135 80 0 39 }{ text 135 95 0 40 }{ button 1=
35 115 2437 2438 1 0 87 }{ xmfhtmlgump 150 115 100 18 1011298 0 0 }{ button=
 160 20 2361 2361 1 0 88 }{ xmfhtmlgump 175 15 100 18 1011300 0 0 }{ button=
 135 140 2103 2104 1 0 89 }{ xmfhtmlgump 150 136 110 20 1062722 0 0 }{ butt=
on 135 158 2103 2104 1 0 90 }{ xmfhtmlgump 150 154 110 20 1062723 0 0 }{ bu=
tton 135 176 2103 2104 1 0 91 }{ xmfhtmlgump 150 172 110 20 1062724 0 0 }{ =
croppedtext 145 60 115 17 1101 14 }{ button 290 65 2103 2104 1 0 92 }{ text=
 295 80 0 39 }{ text 295 95 0 40 }{ button 295 115 2437 2438 1 0 93 }{ xmfh=
tmlgump 310 115 100 18 1011298 0 0 }{ button 300 20 2361 2361 1 0 94 }{ xmf=
htmlgump 315 15 100 18 1011300 0 0 }{ button 295 140 2103 2104 1 0 95 }{ xm=
fhtmlgump 310 136 110 20 1062722 0 0 }{ button 295 158 2103 2104 1 0 96 }{ =
xmfhtmlgump 310 154 110 20 1062723 0 0 }{ button 295 176 2103 2104 1 0 97 }=
{ xmfhtmlgump 310 172 110 20 1062724 0 0 }{ croppedtext 305 60 115 17 1101 =
14 }",
@@ -144,4 +132,41 @@
 		},
 }
 	=

+	=

+kGumpSample_Reward =3D {
+	Data=3D"{ page 0 }{ resizepic 10 10 2600 500 135 }{ xmfhtmlgump 52 35 420=
 55 1006046 1 1 }{ button 60 95 4005 4007 1 0 1 }{ xmfhtmlgump 95 96 150 35=
 1006044 0 0 }{ button 285 95 4017 4019 1 0 0 }{ xmfhtmlgump 320 96 150 35 =
1006045 0 0 }",
+
+	textline=3D{
+	},
+	textline_unicode=3D{
+	},
+}
+
+kGumpSample_ChangeLog =3D {
+	Data=3D"{ page 0 }{ resizepic 0 0 9270 350 272 }{ resizepic 10 35 9270 33=
0 227 }{ button 298 15 22153 22155 1 0 1 }{ button 319 15 22150 22152 1 0 0=
 }{ resizepic 81 10 9270 188 35 }{ text 91 17 2101 0 }{ resizepic 91 45 927=
0 168 35 }{ croppedtext 160 52 29 16 2101 1 }{ gumppictiled 30 81 290 162 2=
624 }{ checkertrans 30 81 290 162 }{ button 30 55 5603 5607 1 0 11 }{ butto=
n 304 55 5601 5605 1 0 11 }{ htmlgump 30 81 290 162 2 0 1 }",
+
+	textline=3D{
+	[1]=3D"News",
+	[2]=3D"<CENTER><BIG>28.06.2008 by Lumberman<BR>--------------------------=
--------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Forum unter www.=
vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BIG>23.06.2008=
 by Lumberman<BR>----------------------------------</BIG></CENTER>Patch ein=
gespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder im Changelo=
g (Pfeil rechts)<BR><CENTER><BIG>15.06.2008 by Lumberman<BR>---------------=
-------------------</BIG></CENTER>Patch eingespielt.<BR>mehr siehe im Forum=
 unter www.vetus-mundus.de oder im Changelog (Pfeil rechts)<BR><CENTER><BIG=
>14.06.2008 by Lumberman<BR>----------------------------------</BIG></CENTE=
R>Patch eingespielt.<BR>mehr siehe im Forum unter www.vetus-mundus.de oder =
im Changelog (Pfeil rechts)",
+	[0]=3D"Message of the Day - Main",
+	},
+	textline_unicode=3D{
+	[1]=3D{78,101,119,115,},
+	[2]=3D{60,67,69,78,84,69,82,62,60,66,73,71,62,50,56,46,48,54,46,50,48,48,=
56,32,98,121,32,76,117,109,98,101,114,109,97,110,60,66,82,62,45,45,45,45,45=
,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45=
,45,45,45,45,60,47,66,73,71,62,60,47,67,69,78,84,69,82,62,80,97,116,99,104,=
32,101,105,110,103,101,115,112,105,101,108,116,46,60,66,82,62,109,101,104,1=
14,32,115,105,101,104,101,32,105,109,32,70,111,114,117,109,32,117,110,116,1=
01,114,32,119,119,119,46,118,101,116,117,115,45,109,117,110,100,117,115,46,=
100,101,32,111,100,101,114,32,105,109,32,67,104,97,110,103,101,108,111,103,=
32,40,80,102,101,105,108,32,114,101,99,104,116,115,41,60,66,82,62,60,67,69,=
78,84,69,82,62,60,66,73,71,62,50,51,46,48,54,46,50,48,48,56,32,98,121,32,76=
,117,109,98,101,114,109,97,110,60,66,82,62,45,45,45,45,45,45,45,45,45,45,45=
,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,60,47=
,66,73,71,62,60,47,67,69,78,84,69,82,62,80,97,116,99,104,32,101,105,110,103=
,101,115,112,105,101,108,116,46,60,66,82,62,109,101,104,114,32,115,105,101,=
104,101,32,105,109,32,70,111,114,117,109,32,117,110,116,101,114,32,119,119,=
119,46,118,101,116,117,115,45,109,117,110,100,117,115,46,100,101,32,111,100=
,101,114,32,105,109,32,67,104,97,110,103,101,108,111,103,32,40,80,102,101,1=
05,108,32,114,101,99,104,116,115,41,60,66,82,62,60,67,69,78,84,69,82,62,60,=
66,73,71,62,49,53,46,48,54,46,50,48,48,56,32,98,121,32,76,117,109,98,101,11=
4,109,97,110,60,66,82,62,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45=
,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,60,47,66,73,71,62,60,47=
,67,69,78,84,69,82,62,80,97,116,99,104,32,101,105,110,103,101,115,112,105,1=
01,108,116,46,60,66,82,62,109,101,104,114,32,115,105,101,104,101,32,105,109=
,32,70,111,114,117,109,32,117,110,116,101,114,32,119,119,119,46,118,101,116=
,117,115,45,109,117,110,100,117,115,46,100,101,32,111,100,101,114,32,105,10=
9,32,67,104,97,110,103,101,108,111,103,32,40,80,102,101,105,108,32,114,101,=
99,104,116,115,41,60,66,82,62,60,67,69,78,84,69,82,62,60,66,73,71,62,49,52,=
46,48,54,46,50,48,48,56,32,98,121,32,76,117,109,98,101,114,109,97,110,60,66=
,82,62,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45=
,45,45,45,45,45,45,45,45,45,45,45,60,47,66,73,71,62,60,47,67,69,78,84,69,82=
,62,80,97,116,99,104,32,101,105,110,103,101,115,112,105,101,108,116,46,60,6=
6,82,62,109,101,104,114,32,115,105,101,104,101,32,105,109,32,70,111,114,117=
,109,32,117,110,116,101,114,32,119,119,119,46,118,101,116,117,115,45,109,11=
7,110,100,117,115,46,100,101,32,111,100,101,114,32,105,109,32,67,104,97,110=
,103,101,108,111,103,32,40,80,102,101,105,108,32,114,101,99,104,116,115,41,=
},
+	[0]=3D{77,101,115,115,97,103,101,32,111,102,32,116,104,101,32,68,97,121,3=
2,45,32,77,97,105,110,},
+	},
+}
+
+
+kGumpSample_MoongateMenu =3D {
+	Data=3D"{ page 0 }{ resizepic 0 0 5054 380 280 }{ button 10 185 4005 4007=
 1 0 2 }{ htmlgump 45 185 140 25 0 0 0 }{ button 10 210 4005 4007 1 0 1 }{ =
xmfhtmlgump 45 210 140 25 1011036 0 0 }{ button 10 235 4005 4007 1 0 0 }{ x=
mfhtmlgump 45 235 140 25 1011012 0 0 }{ xmfhtmlgump 5 5 200 20 1012011 0 0 =
}{ button 10 35 2117 2118 0 1 0 }{ xmfhtmlgump 30 35 150 20 1012000 0 0 }{ =
button 10 60 2117 2118 0 2 0 }{ xmfhtmlgump 30 60 150 20 1012001 0 0 }{ but=
ton 10 85 2117 2118 0 3 0 }{ xmfhtmlgump 30 85 150 20 1012002 0 0 }{ button=
 10 110 2117 2118 0 4 0 }{ xmfhtmlgump 30 110 150 20 1060643 0 0 }{ button =
10 135 2117 2118 0 5 0 }{ xmfhtmlgump 30 135 150 20 1063258 0 0 }{ page 1 }=
{ button 10 35 2117 2118 0 1 0 }{ xmfhtmlgump 30 35 150 20 1012012 0 0 }{ r=
adio 200 35 210 211 0 0 }{ xmfhtmlgump 225 35 150 20 1012003 0 0 }{ radio 2=
00 60 210 211 0 1 }{ xmfhtmlgump 225 60 150 20 1012004 0 0 }{ radio 200 85 =
210 211 0 2 }{ xmfhtmlgump 225 85 150 20 1012005 0 0 }{ radio 200 110 210 2=
11 0 3 }{ xmfhtmlgump 225 110 150 20 1012006 0 0 }{ radio 200 135 210 211 0=
 4 }{ xmfhtmlgump 225 135 150 20 1012007 0 0 }{ radio 200 160 210 211 0 5 }=
{ xmfhtmlgump 225 160 150 20 1012008 0 0 }{ radio 200 185 210 211 0 6 }{ xm=
fhtmlgump 225 185 150 20 1012009 0 0 }{ radio 200 210 210 211 0 7 }{ xmfhtm=
lgump 225 210 150 20 1012010 0 0 }{ radio 200 235 210 211 0 8 }{ xmfhtmlgum=
p 225 235 150 20 1046259 0 0 }{ page 2 }{ button 10 60 2117 2118 0 2 0 }{ x=
mfhtmlgump 30 60 150 20 1012013 0 0 }{ radio 200 35 210 211 0 100 }{ xmfhtm=
lgump 225 35 150 20 1012003 0 0 }{ radio 200 60 210 211 0 101 }{ xmfhtmlgum=
p 225 60 150 20 1012004 0 0 }{ radio 200 85 210 211 0 102 }{ xmfhtmlgump 22=
5 85 150 20 1012005 0 0 }{ radio 200 110 210 211 0 103 }{ xmfhtmlgump 225 1=
10 150 20 1012006 0 0 }{ radio 200 135 210 211 0 104 }{ xmfhtmlgump 225 135=
 150 20 1012007 0 0 }{ radio 200 160 210 211 0 105 }{ xmfhtmlgump 225 160 1=
50 20 1012008 0 0 }{ radio 200 185 210 211 0 106 }{ xmfhtmlgump 225 185 150=
 20 1012009 0 0 }{ radio 200 210 210 211 0 107 }{ xmfhtmlgump 225 210 150 2=
0 1012010 0 0 }{ radio 200 235 210 211 0 108 }{ xmfhtmlgump 225 235 150 20 =
1019001 0 0 }{ page 3 }{ button 10 85 2117 2118 0 3 0 }{ xmfhtmlgump 30 85 =
150 20 1012014 0 0 }{ radio 200 35 210 211 0 200 }{ xmfhtmlgump 225 35 150 =
20 1012015 0 0 }{ radio 200 60 210 211 0 201 }{ xmfhtmlgump 225 60 150 20 1=
012016 0 0 }{ radio 200 85 210 211 0 202 }{ xmfhtmlgump 225 85 150 20 10120=
17 0 0 }{ radio 200 110 210 211 0 203 }{ xmfhtmlgump 225 110 150 20 1012018=
 0 0 }{ radio 200 135 210 211 0 204 }{ xmfhtmlgump 225 135 150 20 1012019 0=
 0 }{ radio 200 160 210 211 0 205 }{ xmfhtmlgump 225 160 150 20 1012020 0 0=
 }{ radio 200 185 210 211 0 206 }{ xmfhtmlgump 225 185 150 20 1012021 0 0 }=
{ radio 200 210 210 211 0 207 }{ xmfhtmlgump 225 210 150 20 1012022 0 0 }{ =
radio 200 235 210 211 0 208 }{ xmfhtmlgump 225 235 150 20 1019000 0 0 }{ pa=
ge 4 }{ button 10 110 2117 2118 0 4 0 }{ xmfhtmlgump 30 110 150 20 1062039 =
0 0 }{ radio 200 35 210 211 0 300 }{ xmfhtmlgump 225 35 150 20 1060641 0 0 =
}{ radio 200 60 210 211 0 301 }{ xmfhtmlgump 225 60 150 20 1060642 0 0 }{ p=
age 5 }{ button 10 135 2117 2118 0 5 0 }{ xmfhtmlgump 30 135 150 20 1063415=
 0 0 }{ radio 200 35 210 211 0 400 }{ xmfhtmlgump 225 35 150 20 1063412 0 0=
 }{ radio 200 60 210 211 0 401 }{ xmfhtmlgump 225 60 150 20 1063413 0 0 }{ =
radio 200 85 210 211 0 402 }{ xmfhtmlgump 225 85 150 20 1063414 0 0 }",
+	textline=3D{
+		[0]=3D"Player City Menu",
+	},
+	textline_unicode=3D{
+		[0]=3D{80,108,97,121,101,114,32,67,105,116,121,32,77,101,110,117,},
+	},
+}
+	=

+	=

 	=


Modified: trunk/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.gumpdialog.lua (original)
+++ trunk/widgets/widget.gumpdialog.lua Wed Jul  2 19:40:36 2008
@@ -3,6 +3,9 @@
 =

 RegisterWidgetClass("GumpDialog")
 =

+-- old : guimaker.MakeSortedDialog()
+-- old : guimaker.MakePage(pagenum)
+	=

 function gWidgetPrototype.GumpDialog:Init (parentwidget, params)
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
@@ -16,28 +19,28 @@
 	self.uo_text	=3D {} -- for return-message
 	self.radiogroups =3D {} -- see widget.uoradiobutton.lua
 	self.pages		=3D {}
+	self.Gumpdata	=3D params.Gumpdata
 	=

-	-- old : guimaker.MakeSortedDialog()
-	=

-	print("TODO : GumpDialog:Init : gumpposition, use uo_radio etc for widget=
s")
-	-- TODO : set gumpposition
+	-- set gumpposition
 	-- TODO : limit to screen in case of resolution change ?
-	--[[ old gui
-	local gumpposition =3D gGumpPosition[dialogId]
-	if (gumpposition) then
-		dialog.rootwidget.gfx:SetPos(gumpposition.x or 0, gumpposition.y or 0)
-	else
-		dialog.rootwidget.gfx:SetPos(Gumpdata.x or 0, Gumpdata.y or 0)
+	if (self.dialogId) then
+		local gumpposition =3D gGumpPosition[self.dialogId]
+		if (gumpposition) then
+			self:SetPos(gumpposition.x or 0, gumpposition.y or 0)
+		else
+			self:SetPos(Gumpdata and Gumpdata.x or 0, Gumpdata and Gumpdata.y or 0)
+		end
 	end
-	]]--
 end
 =

 function gWidgetPrototype.GumpDialog:GetDialog	() return self end -- overr=
ide, normaly parent:GetDialog(), so this ends recursion
 =

-function gWidgetPrototype.GumpDialog:on_destroy	() =

-	print("TODO : GumpDialog:on_destroy")
-	-- gGumpPosition[dialog.dialogId] =3D { x=3Ddialog.rootwidget.gfx:GetDeri=
vedLeft() , y=3Ddialog.rootwidget.gfx:GetDerivedTop() }
-	-- gServerSideGump[dialog.dialogId] =3D nil
+function gWidgetPrototype.GumpDialog:on_destroy	()
+	if (self.dialogId) then
+		local x,y =3D self:GetPos()
+		gGumpPosition[self.dialogId] =3D {x=3Dx,y=3Dy}
+		gServerSideGump[self.dialogId] =3D nil
+	end
 end
 =

 -- shows pages 0 and pagenum
@@ -45,7 +48,24 @@
 	for k,page in pairs(self.pages) do page:SetVisible(k =3D=3D 0 or k =3D=3D=
 pagenum) end
 end
 =

--- guimaker.MakePage(pagenum)
+function gWidgetPrototype.GumpDialog:on_mouse_left_down		() print("GumpDia=
log:on_mouse_left_down") self:BringToFront() self:StartMouseMove() end
+function gWidgetPrototype.GumpDialog:on_mouse_right_down	() self:SendClose=
(0) end
+
+function gWidgetPrototype.GumpDialog:SendClose	(return_value)
+	-- old : CloseServerSideGump(self.Gumpdata.playerid, self.dialogId,return=
_value)
+	-- old : ServerSideGump_GetParams
+	local params =3D {}
+	params.switches =3D {}
+	params.texts =3D {}
+	for k,widget in pairs(self.uo_radio) do if (widget:GetState()) then table=
.insert(params.switches,widget:GetReturnVal()) end end
+	for k,widget in pairs(self.uo_check) do if (widget:GetState()) then table=
.insert(params.switches,widget:GetReturnVal()) end end
+	for k,widget in pairs(self.uo_text) do =

+		table.insert(params.texts,{id=3Dwidget:GetReturnVal(),text=3Dwidget:GetP=
lainText()})
+	end
+	GumpReturnMsg(self.Gumpdata.playerid, self.Gumpdata.dialogId, return_valu=
e, params)
+	self:Destroy()
+end
+	=

 function gWidgetPrototype.GumpDialog:GetPage	(pagenum) =

 	local page =3D self.pages[pagenum]
 	if (page) then return page end

Modified: trunk/widgets/widget.uobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uobutton.lua (original)
+++ trunk/widgets/widget.uobutton.lua Wed Jul  2 19:40:36 2008
@@ -20,7 +20,7 @@
 	self:UpdateGfx()
 end
 =

-function gWidgetPrototype.UOButton:on_mouse_left_down	() self.bMouseDown =
=3D true		self:UpdateGfx() end
+function gWidgetPrototype.UOButton:on_mouse_left_down	() self.bMouseDown =
=3D true		self:UpdateGfx() print("UOButton:on_mouse_left_down") end
 function gWidgetPrototype.UOButton:on_mouse_left_up		() self.bMouseDown =
=3D false		self:UpdateGfx() end
 function gWidgetPrototype.UOButton:on_mouse_enter		() self.bMouseInside =
=3D true		self:UpdateGfx() end
 function gWidgetPrototype.UOButton:on_mouse_leave		() self.bMouseInside =
=3D false	self:UpdateGfx() end
@@ -31,17 +31,17 @@
 	self.gfx_pressed:SetVisible(bPressed)
 end
 =

+function gWidgetPrototype.UOButton:GetReturnVal	() return self.params.retu=
rn_value end
 =

 function gWidgetPrototype.UOButton:on_button_click	()
 	local dialog =3D self:GetDialog()
 	local page_id =3D self.params.page_id
 	local return_value =3D self.params.return_value
-	--~ print("UOButton:on_button_click",dialog,page_id,return_value)
+	print("UOButton:on_button_click",dialog,page_id,return_value)
 	if (page_id and page_id > 0) then
 		if (dialog) then dialog:ShowPage(page_id) end
 	elseif (return_value) then
-		print("TODO : UOButton:on_button_click return_value",return_value)
-		--~ CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg)
+		if (dialog) then dialog:SendClose(return_value) end
 	end
 end
 =


Modified: trunk/widgets/widget.uoedittext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoedittext.lua (original)
+++ trunk/widgets/widget.uoedittext.lua Wed Jul  2 19:40:36 2008
@@ -24,7 +24,18 @@
 =

 function gWidgetPrototype.UOEditText:GetReturnVal	() return self.params.re=
turn_value end
 =

-function gWidgetPrototype.UOEditText:GetText ()		return self.text end
+function gWidgetPrototype.UOEditText:GetPlainText ()
+	if (type(self.text) =3D=3D "table") then
+		local plaintext =3D ""
+		for k,unicode_charcode in ipairs(self.text) do =

+			plaintext =3D plaintext .. string.format("%c",unicode_charcode) -- non-=
asci specifics are lost
+		end
+		return plaintext
+	end
+	return self.text
+end
+
+function gWidgetPrototype.UOEditText:GetText ()		return self.text end -- w=
arning ! might be an array of unicode charcodes (usually)
 function gWidgetPrototype.UOEditText:SetText (text)	self.text =3D text sel=
f:UpdateTextDisplay() end
 =

 function gWidgetPrototype.UOEditText:UpdateTextDisplay () self.textwidget:=
SetUOHtml(self.text) end



From no-reply at zwischenwelt.org  Wed Jul  2 19:37:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 02 Jul 2008 17:37:38 -0000
Subject: [Iris-commit] [IRIS] r2282 - /trunk/widgets/widget.uotext.lua
Message-ID: <20080702180006.D97161C180A0@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Jul  2 19:37:38 2008
New Revision: 2282

Log:
uotext : html-parser and unicode currently don't work at the same time, so =
check if tags are present

Modified:
    trunk/widgets/widget.uotext.lua

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Wed Jul  2 19:37:38 2008
@@ -58,6 +58,16 @@
 	=

 	glyphlist:Clear()
 	=

+	if (type(uohtml) =3D=3D "table") then
+		local plaintext =3D ""
+		for k,unicode_charcode in ipairs(uohtml) do =

+			plaintext =3D plaintext .. string.format("%c",unicode_charcode) -- non-=
asci specifics are lost
+		end
+		if (string.find(plaintext,"<",1,true)) then
+			uohtml =3D plaintext -- TODO : dirty hack, disable unicode when at leas=
t a tag is present.. unicode and html-parsing don't work together currently
+		end
+	end
+	=

 	--~ print("uohtml start",self.params.scrollbar)
 	if (type(uohtml) =3D=3D "table") then
 		-- unicode glyphs, but no html
@@ -82,6 +92,8 @@
 				-- html-tag
 				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

 				if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

+				-- TODO : html-center : glyphlist : glyphs to change h-alignment durin=
g parsing ? needs line width.. and full text width (unless wrap specified !)
+	=

 				if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end=
 -- fontchange
 				if (tag =3D=3D "</BIG>") then table.remove(statestack) end
 				if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end



From no-reply at zwischenwelt.org  Thu Jul  3 00:57:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 02 Jul 2008 22:57:58 -0000
Subject: [Iris-commit] [IRIS] r2284 - in /trunk: lua/gui/gui.gumpparser.lua
 widgets/widget.gumpdialog.lua widgets/widget.uobutton.lua
 widgets/widget.uocheckbox.lua widgets/widget.uoedittext.lua
 widgets/widget.uoimage.lua widgets/widget.uoradiobutton.lua
Message-ID: <20080702225758.600C61C180A8@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul  3 00:57:49 2008
New Revision: 2284

Log:
guisys : pixelexact hittest (bitmask) for gumps, bugfix:sendclose data coll=
ection (radio,check,text), bugfix:uoradio and uocheck initial state param, =
bugfix:uoimage bitmask

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/widgets/widget.gumpdialog.lua
    trunk/widgets/widget.uobutton.lua
    trunk/widgets/widget.uocheckbox.lua
    trunk/widgets/widget.uoedittext.lua
    trunk/widgets/widget.uoimage.lua
    trunk/widgets/widget.uoradiobutton.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Thu Jul  3 00:57:49 2008
@@ -37,11 +37,11 @@
 	kClientSideGump_Skill			=3D skillGump			-- the big skill list dialog with=
 up/down/lock boxes, grab icons and scrollbar
 	kClientSideGump_Journal			=3D journalGump	-- a very simple message log in=
 papyrus-scroll look
 	]]--
-	--~ local testgump,x,y =3D kGumpSample_ChangeLog,400,00
-	--~ local testgump,x,y =3D kGumpSample_ChangeLog_Text,400,00
-	--~ local testgump,x,y =3D kGumpSample_RuneBook,0,240
-	--~ local testgump,x,y =3D kGumpSample_Reward,0,140
-	local testgump,x,y =3D kGumpSample_MoongateMenu,0,140
+	--~ local testgump,x,y,kDebugName =3D kGumpSample_ChangeLog,400,00."kGump=
Sample_ChangeLog"
+	--~ local testgump,x,y,kDebugName =3D kGumpSample_ChangeLog_Text,400,0,"k=
GumpSample_ChangeLog_Text"
+	--~ local testgump,x,y,kDebugName =3D kGumpSample_RuneBook,0,240,"kGumpSa=
mple_RuneBook"
+	--~ local testgump,x,y,kDebugName =3D kGumpSample_Reward,0,140,"kGumpSamp=
le_Reward"
+	local testgump,x,y,kDebugName =3D kGumpSample_MoongateMenu,0,140,"kGumpSa=
mple_MoongateMenu"
 	local profiler =3D MakeProfiler("gumpparser")
 	if (1 =3D=3D 1) then
 		profiler:StartSection("font:preload")
@@ -50,13 +50,13 @@
 		profiler:StartSection("old")
 		--~ GumpParser_Old(testgump,false)
 		profiler:StartSection("new")
-		local dialog =3D GumpParser_New(testgump,false) dialog:SetPos(x,y)
+		local dialog =3D GumpParser_New(testgump,false) dialog:SetPos(x,y) dialo=
g.sDebugName =3D kDebugName
 		profiler:Finish()
 		profiler:PrintTotalTime()
 	end
 		=

-		local testgump,x,y =3D kGumpSample_RuneBook2,0,300
-		GumpParser_New(testgump,false):SetPos(x,y)
+	local testgump,x,y,kDebugName =3D kGumpSample_RuneBook2,0,300,"kGumpSampl=
e_RuneBook2"
+	local d2 =3D GumpParser_New(testgump,false) d2:SetPos(x,y) d2.sDebugName =
=3D kDebugName
 	=

 	=

 	--~ local dialog =3D GumpParser_New(kClientSideGump_Paperdoll_Own,true) d=
ialog:SetLeftTop(400,100)
@@ -353,7 +353,7 @@
 		--Description:  Specifies which page to define. Page 0 is already presen=
t and visible with all other Pages (1,2,3,etc) =

 		elseif (command =3D=3D "page") then
 			parent =3D dialog:GetPage(param.pagenum)
-			groupnumber =3D -1 -- start new radio button group on page-switch ? not=
 sure if this is correct  (TODO : test moongate menu)
+			-- NO:groupnumber =3D -1 -- DON'T start new radio button group on page-=
switch ! (moongate menu for example)
 			=

 			=

 			=


Modified: trunk/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.gumpdialog.lua (original)
+++ trunk/widgets/widget.gumpdialog.lua Thu Jul  3 00:57:49 2008
@@ -10,6 +10,7 @@
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
+	self:SetIgnoreHitTest(true)
 	=

 	self.params		=3D params
 	self.dialogId	=3D params.dialogId -- id/serial
@@ -48,7 +49,7 @@
 	for k,page in pairs(self.pages) do page:SetVisible(k =3D=3D 0 or k =3D=3D=
 pagenum) end
 end
 =

-function gWidgetPrototype.GumpDialog:on_mouse_left_down		() print("GumpDia=
log:on_mouse_left_down") self:BringToFront() self:StartMouseMove() end
+function gWidgetPrototype.GumpDialog:on_mouse_left_down		() self:BringToFr=
ont() self:StartMouseMove() end
 function gWidgetPrototype.GumpDialog:on_mouse_right_down	() self:SendClose=
(0) end
 =

 function gWidgetPrototype.GumpDialog:SendClose	(return_value)

Modified: trunk/widgets/widget.uobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uobutton.lua (original)
+++ trunk/widgets/widget.uobutton.lua Thu Jul  3 00:57:49 2008
@@ -9,6 +9,7 @@
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
+	self:SetIgnoreHitTest(true)
 	=

 	self.params			=3D params
 	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_normal})
@@ -20,7 +21,7 @@
 	self:UpdateGfx()
 end
 =

-function gWidgetPrototype.UOButton:on_mouse_left_down	() self.bMouseDown =
=3D true		self:UpdateGfx() print("UOButton:on_mouse_left_down") end
+function gWidgetPrototype.UOButton:on_mouse_left_down	() self.bMouseDown =
=3D true		self:UpdateGfx() end
 function gWidgetPrototype.UOButton:on_mouse_left_up		() self.bMouseDown =
=3D false		self:UpdateGfx() end
 function gWidgetPrototype.UOButton:on_mouse_enter		() self.bMouseInside =
=3D true		self:UpdateGfx() end
 function gWidgetPrototype.UOButton:on_mouse_leave		() self.bMouseInside =
=3D false	self:UpdateGfx() end
@@ -37,7 +38,6 @@
 	local dialog =3D self:GetDialog()
 	local page_id =3D self.params.page_id
 	local return_value =3D self.params.return_value
-	print("UOButton:on_button_click",dialog,page_id,return_value)
 	if (page_id and page_id > 0) then
 		if (dialog) then dialog:ShowPage(page_id) end
 	elseif (return_value) then

Modified: trunk/widgets/widget.uocheckbox.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uocheckbox.lua (original)
+++ trunk/widgets/widget.uocheckbox.lua Thu Jul  3 00:57:49 2008
@@ -7,22 +7,23 @@
 =

 -- param : x,y,gump_id_normal,gump_id_pressed,status,return_value
 function gWidgetPrototype.UOCheckBox:Init (parentwidget, params, groupnumb=
er)
-	if (params.state =3D=3D 0) then params.status =3D false end
-	if (params.state =3D=3D 1) then params.status =3D true end
+	if (params.status =3D=3D 0) then params.status =3D false end
+	if (params.status =3D=3D 1) then params.status =3D true end
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
+	self:SetIgnoreHitTest(true)
 	=

 	=

 	self.params			=3D params
 	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_normal})
 	self.gfx_pressed	=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_pressed})
 	=

-	local dialog =3D self:GetDialog()
+	local dialog =3D parentwidget:GetDialog()
 	if (dialog) then table.insert(dialog.uo_check,self) end
 =

 	self:SetPos(params.x,params.y)
-	self:SetState(params.state)
+	self:SetState(params.status)
 	self:UpdateGfx()
 end
 =

@@ -31,7 +32,7 @@
 function gWidgetPrototype.UOCheckBox:on_mouse_enter		() self.bMouseInside =
=3D true		end
 function gWidgetPrototype.UOCheckBox:on_mouse_leave		() self.bMouseInside =
=3D false	end
 =

-function gWidgetPrototype.UOCheckBox:on_button_click		() self:SetState(not=
 self:GetState()) end
+function gWidgetPrototype.UOCheckBox:on_button_click	() self:SetState(not =
self:GetState()) end
 =

 function gWidgetPrototype.UOCheckBox:UpdateGfx	()
 	self.gfx_normal:SetVisible(not self.state)

Modified: trunk/widgets/widget.uoedittext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoedittext.lua (original)
+++ trunk/widgets/widget.uoedittext.lua Thu Jul  3 00:57:49 2008
@@ -13,7 +13,7 @@
 	self:AddToDestroyList(self.rendergroup2d)
 	self.params =3D params
 	=

-	local dialog =3D self:GetDialog()
+	local dialog =3D parentwidget:GetDialog()
 	if (dialog) then table.insert(dialog.uo_text,self) end
 	=

 	local p =3D params
@@ -51,6 +51,7 @@
 	end
 	self:UpdateTextDisplay()
 end
+
 function gWidgetPrototype.UOEditText:AppendChar			(char) =

 	if (type(self.text) =3D=3D "table") then
 		table.insert(self.text,string.byte(char,1))

Modified: trunk/widgets/widget.uoimage.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoimage.lua (original)
+++ trunk/widgets/widget.uoimage.lua Thu Jul  3 00:57:49 2008
@@ -15,6 +15,7 @@
 		self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGrou=
p2D())
 		self:SetRenderGroup2D(self.rendergroup2d)
 		self:AddToDestroyList(self.rendergroup2d)
+		self:SetIgnoreHitTest(true)
 		local gump_id_base =3D params.gump_id
 		=

 		self.gfx_LT		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,tiled=3Dfalse,g=
ump_id=3Dgump_id_base+kBorderGumpIndexAdd.LT})
@@ -69,10 +70,10 @@
 		self:SetRenderGroup2D(spritepanel:CastToRenderGroup2D())
 		self:AddToDestroyList(spritepanel) -- don't add spritelist here, will be=
 destroyed in spritepanel destructor
 		self.spritepanel =3D spritepanel
+		if (bitmask) then self:SetBitMask(bitmask) end
 	end
 	self.params =3D params
 	if (params.x) then self:SetPos(params.x,params.y) end
-	if (bitmask) then self:SetBitMask(bitmask) end
 end
 =

 -- returns the original size of the gump image

Modified: trunk/widgets/widget.uoradiobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoradiobutton.lua (original)
+++ trunk/widgets/widget.uoradiobutton.lua Thu Jul  3 00:57:49 2008
@@ -7,22 +7,23 @@
 =

 -- param : x,y,gump_id_normal,gump_id_pressed,status,return_value
 function gWidgetPrototype.UORadioButton:Init (parentwidget, params, groupn=
umber)
-	if (params.state =3D=3D 0) then params.status =3D false end
-	if (params.state =3D=3D 1) then params.status =3D true end
+	if (params.status =3D=3D 0) then params.status =3D false end
+	if (params.status =3D=3D 1) then params.status =3D true end
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
+	self:SetIgnoreHitTest(true)
 	=

 	self.groupnumber	=3D groupnumber
 	self.params			=3D params
 	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_normal})
 	self.gfx_pressed	=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_pressed})
 	=

-	local dialog =3D self:GetDialog()
+	local dialog =3D parentwidget:GetDialog()
 	if (dialog) then table.insert(dialog.uo_radio,self) end
 	=

 	self:SetPos(params.x,params.y)
-	self:SetState(params.state)
+	self:SetState(params.status)
 	self:UpdateGfx()
 end
 =




From no-reply at zwischenwelt.org  Thu Jul  3 01:04:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 02 Jul 2008 23:04:49 -0000
Subject: [Iris-commit] [IRIS] r2285 - /trunk/bin/iris2.exe
Message-ID: <20080703000007.84B411C1800D@zwischenwelt.org>

Author: sience
Date: Thu Jul  3 01:04:49 2008
New Revision: 2285

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Thu Jul  3 01:59:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 02 Jul 2008 23:59:38 -0000
Subject: [Iris-commit] [IRIS] r2286 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/lib.gump.samples.lua widgets/widget.uotext.lua
Message-ID: <20080703000009.795EE1C1800D@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul  3 01:59:37 2008
New Revision: 2286

Log:
enabled new gui system for serverside gumps, uohtml : added BASEFONT COLOR =
support

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.gump.samples.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Thu Jul  3 01:59:37 2008
@@ -11,9 +11,11 @@
 dofile(libpath .. "lib.gump.samples.lua")
 =

 function GumpParser (Gumpdata, Clientsidemode)
-	--~ if (not Clientsidemode) then return GumpParser_New(Gumpdata, Clientsi=
demode) end
+	if (not Clientsidemode) then return GumpParser_New(Gumpdata, Clientsidemo=
de) end
 	return GumpParser_Old(Gumpdata, Clientsidemode)
 end
+
+kGumpParser_DebugDump =3D false
 =

 function GumpParserTest ()
 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
@@ -43,7 +45,7 @@
 	--~ local testgump,x,y,kDebugName =3D kGumpSample_Reward,0,140,"kGumpSamp=
le_Reward"
 	local testgump,x,y,kDebugName =3D kGumpSample_MoongateMenu,0,140,"kGumpSa=
mple_MoongateMenu"
 	local profiler =3D MakeProfiler("gumpparser")
-	if (1 =3D=3D 1) then
+	if (1 =3D=3D 2) then
 		profiler:StartSection("font:preload")
 		GetUOFont(gUniFontLoaderList[1],true):PreLoad()
 		GetUOFont(gUniFontLoaderList[1],false):PreLoad()
@@ -55,7 +57,7 @@
 		profiler:PrintTotalTime()
 	end
 		=

-	local testgump,x,y,kDebugName =3D kGumpSample_RuneBook2,0,300,"kGumpSampl=
e_RuneBook2"
+	local testgump,x,y,kDebugName =3D kGumpSample_VM_ChatMenu,0,300,"kGumpSam=
ple_RuneBook2"
 	local d2 =3D GumpParser_New(testgump,false) d2:SetPos(x,y) d2.sDebugName =
=3D kDebugName
 	=

 	=

@@ -299,7 +301,7 @@
 function GumpParser_New (Gumpdata, bClientSideMode)
 	-- if there is a dialog with the same id, close it
 	GumpParser_CloseOldDialog(Gumpdata.dialogId,Gumpdata.playerid,bClientSide=
Mode)
-	--~ GumpParser_DebugDumpGump(Gumpdata)
+	if (kGumpParser_DebugDump) then GumpParser_DebugDumpGump(Gumpdata) end
 	=

 	-- setup
 	local dialog =3D GetDesktopWidget():CreateChild("GumpDialog",{dialogId=3D=
Gumpdata.dialogId,bClientSideMode=3DbClientSideMode,Gumpdata=3DGumpdata})

Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Thu Jul  3 01:59:37 2008
@@ -169,4 +169,60 @@
 }
 	=

 	=

-	=

+kGumpSample_VM_ChatMenu =3D {
+	Data=3D"{ resizepic 0 0 3600 250 420 }{ button 5 5 22153 22153 1 0 1013 }=
{ button 30 9 2435 2435 1 0 6725 }{ button 40 9 2437 2437 1 0 7616 }{ butto=
n 170 5 1896 1896 1 0 4143 }{ text 175 5 1150 0 }{ button 185 5 1896 1896 1=
 0 13096 }{ text 190 5 52 1 }{ button 200 5 1896 1896 1 0 19311 }{ text 204=
 5 1150 2 }{ button 215 5 1896 1896 1 0 959 }{ text 220 5 1150 3 }{ button =
125 7 9704 9705 1 0 44 }{ gumppic 53 34 2501 }{ htmlgump 0 35 250 21 4 0 0 =
}{ htmlgump 0 55 250 21 5 0 0 }{ htmlgump 35 80 215 21 6 0 0 }{ button 20 8=
3 10006 10006 1 0 16563 }{ button 220 83 5032 5032 1 0 880 }{ text 223 78 1=
150 7 }{ button 208 83 5032 5032 1 0 19419 }{ text 213 79 38 8 }{ button 19=
6 83 5032 5032 1 0 18306 }{ text 199 80 38 9 }{ htmlgump 35 100 215 21 10 0=
 0 }{ button 20 103 10006 10006 1 0 15072 }{ button 220 103 5032 5032 1 0 1=
1198 }{ text 223 98 1150 7 }{ button 208 103 5032 5032 1 0 7821 }{ text 213=
 99 38 8 }{ button 196 103 5032 5032 1 0 6271 }{ text 199 100 38 9 }{ htmlg=
ump 35 120 215 21 11 0 0 }{ button 20 123 10006 10006 1 0 9849 }{ button 22=
0 123 5032 5032 1 0 15578 }{ text 223 118 1150 7 }{ button 208 123 5032 503=
2 1 0 14434 }{ text 213 119 38 8 }{ button 196 123 5032 5032 1 0 7809 }{ te=
xt 199 120 38 9 }{ htmlgump 35 140 215 21 12 0 0 }{ button 20 143 10006 100=
06 1 0 16656 }{ button 220 143 5032 5032 1 0 12571 }{ text 223 138 1150 7 }=
{ button 208 143 5032 5032 1 0 1410 }{ text 213 139 38 8 }{ button 196 143 =
5032 5032 1 0 10977 }{ text 199 140 38 9 }{ htmlgump 35 160 215 21 13 0 0 }=
{ button 20 163 10006 10006 1 0 19005 }{ button 220 163 5032 5032 1 0 15312=
 }{ text 223 158 1150 7 }{ button 208 163 5032 5032 1 0 6120 }{ text 213 15=
9 38 8 }{ button 196 163 5032 5032 1 0 8452 }{ text 199 160 38 9 }{ htmlgum=
p 35 180 215 21 14 0 0 }{ button 20 183 10006 10006 1 0 13331 }{ button 220=
 183 5032 5032 1 0 10560 }{ text 223 178 1150 7 }{ button 208 183 5032 5032=
 1 0 14689 }{ text 213 179 38 8 }{ button 196 183 5032 5032 1 0 15301 }{ te=
xt 199 180 38 9 }{ htmlgump 35 200 215 21 15 0 0 }{ button 20 203 10006 100=
06 1 0 6746 }{ button 220 203 5032 5032 1 0 14129 }{ text 223 198 1150 7 }{=
 button 208 203 5032 5032 1 0 16934 }{ text 213 199 38 8 }{ button 196 203 =
5032 5032 1 0 14902 }{ text 199 200 38 9 }{ htmlgump 35 220 215 21 16 0 0 }=
{ button 20 223 10006 10006 1 0 17998 }{ button 220 223 5032 5032 1 0 3628 =
}{ text 223 218 1150 7 }{ button 208 223 5032 5032 1 0 9818 }{ text 213 219=
 38 8 }{ button 196 223 5032 5032 1 0 19824 }{ text 199 220 38 9 }{ htmlgum=
p 35 240 215 21 17 0 0 }{ button 20 243 10006 10006 1 0 16375 }{ button 220=
 243 5032 5032 1 0 17447 }{ text 223 238 1150 7 }{ button 208 243 5032 5032=
 1 0 18206 }{ text 213 239 38 8 }{ button 196 243 5032 5032 1 0 15132 }{ te=
xt 199 240 38 9 }{ htmlgump 35 260 215 21 18 0 0 }{ button 20 263 10006 100=
06 1 0 14828 }{ button 220 263 5032 5032 1 0 13390 }{ text 223 258 1150 7 }=
{ button 208 263 5032 5032 1 0 8526 }{ text 213 259 38 8 }{ button 196 263 =
5032 5032 1 0 57 }{ text 199 260 38 9 }{ htmlgump 35 280 215 21 19 0 0 }{ b=
utton 20 283 10006 10006 1 0 4115 }{ button 220 283 5032 5032 1 0 1288 }{ t=
ext 223 278 1150 7 }{ button 208 283 5032 5032 1 0 13012 }{ text 213 279 38=
 8 }{ button 196 283 5032 5032 1 0 9465 }{ text 199 280 38 9 }{ htmlgump 35=
 300 215 21 20 0 0 }{ button 20 303 10006 10006 1 0 5572 }{ button 220 303 =
5032 5032 1 0 9594 }{ text 223 298 1150 7 }{ button 208 303 5032 5032 1 0 1=
4462 }{ text 213 299 38 8 }{ button 196 303 5032 5032 1 0 8442 }{ text 199 =
300 38 9 }{ htmlgump 35 320 215 21 21 0 0 }{ button 20 323 10006 10006 1 0 =
5314 }{ button 220 323 5032 5032 1 0 16638 }{ text 223 318 1150 7 }{ button=
 208 323 5032 5032 1 0 5137 }{ text 213 319 38 8 }{ button 196 323 5032 503=
2 1 0 17783 }{ text 199 320 38 9 }{ htmlgump 35 340 215 21 22 0 0 }{ button=
 20 343 10006 10006 1 0 13191 }{ button 220 343 5032 5032 1 0 12507 }{ text=
 223 338 1150 7 }{ button 208 343 5032 5032 1 0 6713 }{ text 213 339 38 8 }=
{ button 196 343 5032 5032 1 0 6003 }{ text 199 340 38 9 }{ gumppic 93 368 =
2444 }{ htmlgump 0 370 250 21 23 0 0 }{ button 75 373 10006 10006 1 0 6191 =
}{ button 165 373 10006 10006 1 0 4118 }{ page 0 }{ gumppic 250 420 10460 h=
ue=3D903 }{ button 260 424 2362 2362 1 0 11559 }{ button 260 435 2360 2360 =
1 0 943 }{ button 245 422 9766 9767 1 0 14264 }{ button 269 422 9762 9763 1=
 0 12919 }{ button 245 433 9766 9767 1 0 8273 }{ button 269 433 9762 9763 1=
 0 6220 }",
+	textline=3D{
+	[1]=3D"Q",
+	[2]=3D"M",
+	[3]=3D"S",
+	[4]=3D"<BASEFONT COLOR=3D#FFFF00><CENTER>Public",
+	[5]=3D"<BASEFONT COLOR=3D#FFFF00><CENTER>66 Online",
+	[6]=3D"<BASEFONT COLOR=3D#FFFF00>America",
+	[7]=3D"m",
+	[8]=3D"i",
+	[9]=3D"f",
+	[10]=3D"<BASEFONT COLOR=3D#FFFF00>Anjin san",
+	[11]=3D"<BASEFONT COLOR=3D#FFFF00>Athea",
+	[12]=3D"<BASEFONT COLOR=3D#FFFF00>Ava Noe",
+	[13]=3D"<BASEFONT COLOR=3D#FFFF00>Baxter Morgan",
+	[14]=3D"<BASEFONT COLOR=3D#FFFF00>BlizZ ThE DragoN",
+	[15]=3D"<BASEFONT COLOR=3D#FFFF00>Calvin Klein",
+	[16]=3D"<BASEFONT COLOR=3D#FFFF00>Canam Renegade",
+	[17]=3D"<BASEFONT COLOR=3D#FFFF00>Dafydd ap Gwilym",
+	[18]=3D"<BASEFONT COLOR=3D#FFFF00>Danrid",
+	[19]=3D"<BASEFONT COLOR=3D#FFFF00>Dein Tod",
+	[20]=3D"<BASEFONT COLOR=3D#FFFF00>Die Pferdefluesterin",
+	[21]=3D"<BASEFONT COLOR=3D#FFFF00>Dino Dompteur",
+	[22]=3D"<BASEFONT COLOR=3D#FFFF00>Emi",
+	[23]=3D"<BASEFONT COLOR=3D#FFFF00><CENTER>Online",
+	[0]=3D"P",
+	},
+	textline_unicode=3D{
+	[1]=3D{81,},
+	[2]=3D{77,},
+	[3]=3D{83,},
+	[4]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48,=
48,62,60,67,69,78,84,69,82,62,80,117,98,108,105,99,},
+	[5]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48,=
48,62,60,67,69,78,84,69,82,62,54,54,32,79,110,108,105,110,101,},
+	[6]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48,=
48,62,65,109,101,114,105,99,97,},
+	[7]=3D{109,},
+	[8]=3D{105,},
+	[9]=3D{102,},
+	[10]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,65,110,106,105,110,32,115,97,110,},
+	[11]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,65,116,104,101,97,},
+	[12]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,65,118,97,32,78,111,101,},
+	[13]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,66,97,120,116,101,114,32,77,111,114,103,97,110,},
+	[14]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,66,108,105,122,90,32,84,104,69,32,68,114,97,103,111,78,},
+	[15]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,67,97,108,118,105,110,32,75,108,101,105,110,},
+	[16]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,67,97,110,97,109,32,82,101,110,101,103,97,100,101,},
+	[17]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,68,97,102,121,100,100,32,97,112,32,71,119,105,108,121,109,},
+	[18]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,68,97,110,114,105,100,},
+	[19]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,68,101,105,110,32,84,111,100,},
+	[20]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,68,105,101,32,80,102,101,114,100,101,102,108,117,101,115,116,101,114=
,105,110,},
+	[21]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,68,105,110,111,32,68,111,109,112,116,101,117,114,},
+	[22]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,69,109,105,},
+	[23]=3D{60,66,65,83,69,70,79,78,84,32,67,79,76,79,82,61,35,70,70,70,70,48=
,48,62,60,67,69,78,84,69,82,62,79,110,108,105,110,101,},
+	[0]=3D{80,},
+	},
+}
+	=

+	=


Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Thu Jul  3 01:59:37 2008
@@ -90,6 +90,13 @@
 			end
 			if (tag ~=3D "") then
 				-- html-tag
+				if (string.find(tag,"</BASEFONT")) then table.remove(statestack) end
+				if (string.find(tag,"<BASEFONT")) then
+					local a,b,colhex =3D string.find(tag,"<BASEFONT.*COLOR=3D#([0-9a-fA-F=
]+)")
+					if (colhex) then local r,g,b =3D ColFromHex(colhex) col =3D {r=3Dr,g=
=3Dg,b=3Db} end
+					table.insert(statestack,{0,bold,col})
+				end
+				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

 				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

 				if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

 				-- TODO : html-center : glyphlist : glyphs to change h-alignment durin=
g parsing ? needs line width.. and full text width (unless wrap specified !)



From no-reply at zwischenwelt.org  Thu Jul  3 02:33:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 03 Jul 2008 00:33:38 -0000
Subject: [Iris-commit] [IRIS] r2287 - /trunk/widgets/widget.uotext.lua
Message-ID: <20080703003338.5ECD61C1800F@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul  3 02:33:38 2008
New Revision: 2287

Log:
uotext-widget : fixed basefont tag

Modified:
    trunk/widgets/widget.uotext.lua

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Thu Jul  3 02:33:38 2008
@@ -21,6 +21,7 @@
 	if (params.scrollbar) then params.default_black =3D false end -- when scr=
ollbar is on, default to white (probably on dark background?)
 	if (not params.crop) then params.autowrap_w =3D params.width end
 	gWidgetPrototype.Text.Init(self,parentwidget,params)
+	self:SetIgnoreHitTest(true)
 	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"))
 	--~ self:SetPos(params.x,params.y)
 	local xoff,yoff =3D -1,-22
@@ -94,7 +95,7 @@
 				if (string.find(tag,"<BASEFONT")) then
 					local a,b,colhex =3D string.find(tag,"<BASEFONT.*COLOR=3D#([0-9a-fA-F=
]+)")
 					if (colhex) then local r,g,b =3D ColFromHex(colhex) col =3D {r=3Dr,g=
=3Dg,b=3Db} end
-					table.insert(statestack,{0,bold,col})
+					table.insert(statestack,{fontid,bold,col})
 				end
 				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

 				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =




From no-reply at zwischenwelt.org  Thu Jul  3 07:43:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 03 Jul 2008 05:43:32 -0000
Subject: [Iris-commit] [IRIS] r2288 - /trunk/bin/iris2.exe
Message-ID: <20080703054332.3BE591C1800F@zwischenwelt.org>

Author: sience
Date: Thu Jul  3 07:43:30 2008
New Revision: 2288

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Thu Jul  3 19:45:40 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 03 Jul 2008 17:45:40 -0000
Subject: [Iris-commit] [IRIS] r2289 - /trunk/widgets/widget.uotext.lua
Message-ID: <20080703180005.ACF4F1C1800D@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul  3 19:45:40 2008
New Revision: 2289

Log:
uotext : unicode and uohtml work together now

Modified:
    trunk/widgets/widget.uotext.lua

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Thu Jul  3 19:45:40 2008
@@ -59,59 +59,49 @@
 	=

 	glyphlist:Clear()
 	=

-	if (type(uohtml) =3D=3D "table") then
-		local plaintext =3D ""
-		for k,unicode_charcode in ipairs(uohtml) do =

-			plaintext =3D plaintext .. string.format("%c",unicode_charcode) -- non-=
asci specifics are lost
-		end
-		if (string.find(plaintext,"<",1,true)) then
-			uohtml =3D plaintext -- TODO : dirty hack, disable unicode when at leas=
t a tag is present.. unicode and html-parsing don't work together currently
-		end
-	end
+	local bIsUniCode =3D type(uohtml) =3D=3D "table"
+	local plaintext =3D bIsUniCode and UnicodeToPlainText_KeepLength(uohtml) =
or uohtml
+	local readerpos =3D 1
 	=

-	--~ print("uohtml start",self.params.scrollbar)
-	if (type(uohtml) =3D=3D "table") then
-		-- unicode glyphs, but no html
+	-- non-unicode
+	for textchunk,tag in string.gfind(plaintext, "([^<]*)(<?[^>]*>?)") do =

 		local fontid,bold,col =3D unpack(statestack[#statestack])
 		local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
 		local fontsize =3D fontsize or font:GetDefaultFontSize()
-		for k,unicode_charcode in pairs(uohtml) do =

-			--~ print("uohtml:unicode",unicode_charcode)
-			glyphlist:AddFontGlyph(font,fontsize,unicode_charcode,col)
+		if (textchunk ~=3D "") then =

+			-- text-chunk without tags
+			if (bIsUniCode) then =

+				local len =3D #textchunk
+				local readerend =3D readerpos + len - 1
+				for i =3D readerpos,readerend do
+					glyphlist:AddFontGlyph(font,fontsize,uohtml[i],col)
+				end
+				readerpos =3D readerpos + len
+			else
+				glyphlist:AddText(font,fontsize,textchunk,col)
+			end
 		end
-	else
-		-- non-unicode
-		for plaintext,tag in string.gfind(uohtml, "([^<]*)(<?[^>]*>?)") do =

-			local fontid,bold,col =3D unpack(statestack[#statestack])
-			local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
-			if (plaintext ~=3D "") then =

-				-- plain text
-				--~ print("uohtml plain",plaintext)
-				glyphlist:AddText(font,fontsize,plaintext,col)
+		if (tag ~=3D "") then
+			readerpos =3D readerpos + #tag
+			-- html-tag
+			if (string.find(tag,"</BASEFONT")) then table.remove(statestack) end
+			if (string.find(tag,"<BASEFONT")) then
+				local a,b,colhex =3D string.find(tag,"<BASEFONT.*COLOR=3D#([0-9a-fA-F]=
+)")
+				if (colhex) then local r,g,b =3D ColFromHex(colhex) col =3D {r=3Dr,g=
=3Dg,b=3Db} end
+				table.insert(statestack,{fontid,bold,col})
 			end
-			if (tag ~=3D "") then
-				-- html-tag
-				if (string.find(tag,"</BASEFONT")) then table.remove(statestack) end
-				if (string.find(tag,"<BASEFONT")) then
-					local a,b,colhex =3D string.find(tag,"<BASEFONT.*COLOR=3D#([0-9a-fA-F=
]+)")
-					if (colhex) then local r,g,b =3D ColFromHex(colhex) col =3D {r=3Dr,g=
=3Dg,b=3Db} end
-					table.insert(statestack,{fontid,bold,col})
-				end
-				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

-				if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

-				if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

-				-- TODO : html-center : glyphlist : glyphs to change h-alignment durin=
g parsing ? needs line width.. and full text width (unless wrap specified !)
-	=

-				if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end=
 -- fontchange
-				if (tag =3D=3D "</BIG>") then table.remove(statestack) end
-				if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
-				=

-				--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
-				--~ for token in string.gfind(textstring, "%w+") do table.insert(bToke=
n,token) end
-				--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
-				=

-				--~ print("uohtml tag",tag)
-			end
+			if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

+			if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

+			if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

+			-- TODO : html-center : glyphlist : glyphs to change h-alignment during=
 parsing ? needs line width.. and full text width (unless wrap specified !)
+
+			if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end =
-- fontchange
+			if (tag =3D=3D "</BIG>") then table.remove(statestack) end
+			if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
+			=

+			--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
+			--~ for token in string.gfind(textstring, "%w+") do table.insert(bToken=
,token) end
+			--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
 		end
 	end
 	self:UpdateGeometry()



From no-reply at zwischenwelt.org  Fri Jul  4 18:46:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 04 Jul 2008 16:46:49 -0000
Subject: [Iris-commit] [IRIS] r2290 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/gui/gui.healthbar.lua lua/net/net.other.lua lua/obj/obj.container.lua
 widgets/widget.uotext.lua
Message-ID: <20080704164650.1F5121C180E6@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Jul  4 18:46:49 2008
New Revision: 2290

Log:
uotext : html-parsing optional (can be switched off), support for center tag

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/net/net.other.lua
    trunk/lua/obj/obj.container.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Fri Jul  4 18:46:49 2008
@@ -11,7 +11,7 @@
 dofile(libpath .. "lib.gump.samples.lua")
 =

 function GumpParser (Gumpdata, Clientsidemode)
-	if (not Clientsidemode) then return GumpParser_New(Gumpdata, Clientsidemo=
de) end
+	if ((not Clientsidemode) or Gumpdata.bSupportsGuiSys2) then return GumpPa=
rser_New(Gumpdata, Clientsidemode) end
 	return GumpParser_Old(Gumpdata, Clientsidemode)
 end
 =

@@ -260,10 +260,10 @@
 =

 kGumpParser_CommandTypes =3D {}
 kGumpParser_CommandTypes["page"]				=3D {paramformat=3D"pagenum"}
-kGumpParser_CommandTypes["xmfhtmlgump"]			=3D {paramformat=3D"x,y,width,he=
ight,cliloc_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=
=3Dtrue}} =

-kGumpParser_CommandTypes["xmfhtmlgumpcolor"]	=3D {paramformat=3D"x,y,width=
,height,cliloc_id,background,scrollbar,hue,[ctrlname]"}
+kGumpParser_CommandTypes["xmfhtmlgump"]			=3D {paramformat=3D"x,y,width,he=
ight,cliloc_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=
=3Dtrue,html=3Dtrue}} =

+kGumpParser_CommandTypes["xmfhtmlgumpcolor"]	=3D {paramformat=3D"x,y,width=
,height,cliloc_id,background,scrollbar,hue,[ctrlname]",paramadd=3D{html=3Dt=
rue}}
 kGumpParser_CommandTypes["croppedtext"]			=3D {paramformat=3D"x,y,width,he=
ight,hue,textline_id,[ctrlname]",paramadd=3D{bold=3Dtrue,crop=3Dtrue}}
-kGumpParser_CommandTypes["htmlgump"]			=3D {paramformat=3D"x,y,width,heigh=
t,textline_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=3D=
true}} =

+kGumpParser_CommandTypes["htmlgump"]			=3D {paramformat=3D"x,y,width,heigh=
t,textline_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=3D=
true,html=3Dtrue}} =

 kGumpParser_CommandTypes["text"]				=3D {paramformat=3D"x,y,hue,textline_i=
d,[ctrlname]",paramadd=3D{bold=3Dfalse,default_black=3Dtrue}}
 kGumpParser_CommandTypes["tooltip"]				=3D {paramformat=3D"cliloc_id,[ctrl=
name]"}
 kGumpParser_CommandTypes["resizepic"]			=3D {paramformat=3D"x,y,gump_id,wi=
dth,height,[ctrlname]",paramadd=3D{multipart=3Dtrue}}

Modified: trunk/lua/gui/gui.healthbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.healthbar.lua (original)
+++ trunk/lua/gui/gui.healthbar.lua Fri Jul  4 18:46:49 2008
@@ -10,6 +10,7 @@
 kStatBar_BarGreen	=3D 2056
 kStatBar_BarGolden	=3D 2057
  =

+--~ healthbarGump.bSupportsGuiSys2 =3D true
 healthbarGump.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2051 healthbar }" ..

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Fri Jul  4 18:46:49 2008
@@ -29,7 +29,7 @@
 kPacket_Generic_SubCommand_RevisionCustomHouse	=3D hex2num("0x1D")	-- Send=
s a house Revision number for handling client multi cache.
 																	-- If revision is newer than what client has it asks for =
the new multi packets to cache it.
 kPacket_Generic_SubCommand_HouseSerial			=3D hex2num("0x1E")
-kPacket_Generic_SubCommand_Ability_Icon			=3D hex2num("0x21")	-- nodata ju=
st (bf 00 05 21)
+kPacket_Generic_SubCommand_Ability_Icon			=3D hex2num("0x21")	-- nodata ju=
st (bf 00 05 21) , used together with weapon abilities / combat skills
 kPacket_Generic_SubCommand_OldDamage			=3D hex2num("0x22")	-- Done!
 kPacket_Generic_SubCommand_UnknownSE			=3D hex2num("0x24")	-- Client -> Se=
rver packet
 kPacket_Generic_SubCommand_EnableSESpellIcons	=3D hex2num("0x25")

Modified: trunk/lua/obj/obj.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.container.lua (original)
+++ trunk/lua/obj/obj.container.lua Fri Jul  4 18:46:49 2008
@@ -49,7 +49,7 @@
 	local widget =3D nil
 =

 	-- If it's not an ART-gfx to display -> Display GUMP-gfx
-	if (item.usegump=3D=3Dtrue) then
+	if (item.usegump=3D=3Dtrue) then -- true for gold pieces and similar, see=
 obj.dynamic.lua ApplyArtidStackManipulation
 		widget =3D MakeBorderGumpPart (parent,item.artid,item.xloc,item.yloc + i=
tem.gumpyoffset)
 =

 		widget.mbIgnoreMouseOver =3D false

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Fri Jul  4 18:46:49 2008
@@ -12,17 +12,19 @@
 =

 RegisterWidgetClass("UOText","Text")
 =

--- param : x,y,width,height,cliloc_id/textline_id,background=3D0/1=3Dtrans=
parent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse,crop=3Dfalse
+-- param : x,y,width,height,cliloc_id/textline_id,background=3D0/1=3Dtrans=
parent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse,crop=3Dfalse,html=3Dfa=
lse
 -- bold=3Doutlined_font: false for xmfhtmlgump,htmlgump, true for croppedt=
ext, example : runebook gump : kGumpSample_RuneBook
 -- crop : disables autowrap
+-- html : parse uo html like <BASEFONT> <BIG>....
 function gWidgetPrototype.UOText:Init (parentwidget, params, textlines)
 	--~ print("TODO:widget.UOText  : height,w/h-clip,background,scrollbar",pa=
rentwidget:GetClassName(),parentwidget.pagenum)
 	if (params.scrollbar =3D=3D 0) then params.scrollbar =3D false end
 	if (params.scrollbar) then params.default_black =3D false end -- when scr=
ollbar is on, default to white (probably on dark background?)
 	if (not params.crop) then params.autowrap_w =3D params.width end
+	local bParseHTML =3D params.html
 	gWidgetPrototype.Text.Init(self,parentwidget,params)
 	self:SetIgnoreHitTest(true)
-	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"))
+	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"),bParse=
HTML)
 	--~ self:SetPos(params.x,params.y)
 	local xoff,yoff =3D -1,-22
 	self:SetLeftTop(params.x+xoff,params.y+yoff)
@@ -39,7 +41,7 @@
 -- TODO : uohtml might be an array of ints for unicode (textline) instead =
of text (no html then)
 -- see also HtmlParser in lib.gumpparser.lua
 function gWidgetPrototype.UOText:GetUOHtml () return self.uohtml end
-function gWidgetPrototype.UOText:SetUOHtml (uohtml)
+function gWidgetPrototype.UOText:SetUOHtml (uohtml,bParseHTML)
 	self.uohtml =3D uohtml
 	local fontsize =3D nil
 	local fontid =3D 1
@@ -49,59 +51,64 @@
 	local col =3D self.params.default_black and col_black or col_white
 	if (self.params.hue) then local r,g,b =3D gHueLoader:GetColor(self.params=
.hue,31) col =3D {r=3Dr,g=3Dg,b=3Db} end
 	=

-	local bBig =3D false
-	local bCenter =3D false
 	local glyphlist =3D self.glyphlist
-	=

-	local statestack =3D {}
-	table.insert(statestack,{fontid,bold,col})
-	=

+	local bIsUniCode =3D type(uohtml) =3D=3D "table"
+	local plaintext =3D bIsUniCode and UnicodeToPlainText_KeepLength(uohtml) =
or uohtml
 	=

 	glyphlist:Clear()
 	=

-	local bIsUniCode =3D type(uohtml) =3D=3D "table"
-	local plaintext =3D bIsUniCode and UnicodeToPlainText_KeepLength(uohtml) =
or uohtml
-	local readerpos =3D 1
-	=

-	-- non-unicode
-	for textchunk,tag in string.gfind(plaintext, "([^<]*)(<?[^>]*>?)") do =

-		local fontid,bold,col =3D unpack(statestack[#statestack])
+	-- parse uo html
+	if (bParseHTML) then
+		local readerpos =3D 1
+		local statestack =3D {}
+		table.insert(statestack,{fontid,bold,col})
+		for textchunk,tag in string.gfind(plaintext, "([^<]*)(<?[^>]*>?)") do =

+			local fontid,bold,col =3D unpack(statestack[#statestack])
+			local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
+			local fontsize =3D fontsize or font:GetDefaultFontSize()
+			if (textchunk ~=3D "") then =

+				-- text-chunk without tags
+				if (bIsUniCode) then =

+					local len =3D #textchunk
+					local readerend =3D readerpos + len - 1
+					for i =3D readerpos,readerend do
+						glyphlist:AddFontGlyph(font,fontsize,uohtml[i],col)
+					end
+					readerpos =3D readerpos + len
+				else
+					glyphlist:AddText(font,fontsize,textchunk,col)
+				end
+			end
+			if (tag ~=3D "") then
+				readerpos =3D readerpos + #tag
+				-- html-tag
+				if (string.find(tag,"</BASEFONT")) then table.remove(statestack) end
+				if (string.find(tag,"<BASEFONT")) then
+					local a,b,colhex =3D string.find(tag,"<BASEFONT.*COLOR=3D#([0-9a-fA-F=
]+)")
+					if (colhex) then local r,g,b =3D ColFromHex(colhex) col =3D {r=3Dr,g=
=3Dg,b=3Db} end
+					table.insert(statestack,{fontid,bold,col})
+				end
+				if (tag =3D=3D  "<CENTER>") then glyphlist:AddHAlign(kGlyphList_HAlign=
_Center) glyphlist:AddNewLine() end -- todo =

+				if (tag =3D=3D "</CENTER>") then glyphlist:AddHAlign(kGlyphList_HAlign=
_Left  ) glyphlist:AddNewLine() end -- todo =

+				-- TODO : html-center : glyphlist : glyphs to change h-alignment durin=
g parsing ? needs line width.. and full text width (unless wrap specified !)
+
+				if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end=
 -- fontchange
+				if (tag =3D=3D "</BIG>") then table.remove(statestack) end
+				if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
+				=

+				--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
+				--~ for token in string.gfind(textstring, "%w+") do table.insert(bToke=
n,token) end
+				--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
+			end
+		end
+	else
+		-- don't parse html
 		local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
 		local fontsize =3D fontsize or font:GetDefaultFontSize()
-		if (textchunk ~=3D "") then =

-			-- text-chunk without tags
-			if (bIsUniCode) then =

-				local len =3D #textchunk
-				local readerend =3D readerpos + len - 1
-				for i =3D readerpos,readerend do
-					glyphlist:AddFontGlyph(font,fontsize,uohtml[i],col)
-				end
-				readerpos =3D readerpos + len
-			else
-				glyphlist:AddText(font,fontsize,textchunk,col)
-			end
-		end
-		if (tag ~=3D "") then
-			readerpos =3D readerpos + #tag
-			-- html-tag
-			if (string.find(tag,"</BASEFONT")) then table.remove(statestack) end
-			if (string.find(tag,"<BASEFONT")) then
-				local a,b,colhex =3D string.find(tag,"<BASEFONT.*COLOR=3D#([0-9a-fA-F]=
+)")
-				if (colhex) then local r,g,b =3D ColFromHex(colhex) col =3D {r=3Dr,g=
=3Dg,b=3Db} end
-				table.insert(statestack,{fontid,bold,col})
-			end
-			if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

-			if (tag =3D=3D "<CENTER>") then glyphlist:AddNewLine() end -- todo =

-			if (tag =3D=3D "</CENTER>") then glyphlist:AddNewLine() end -- todo =

-			-- TODO : html-center : glyphlist : glyphs to change h-alignment during=
 parsing ? needs line width.. and full text width (unless wrap specified !)
-
-			if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end =
-- fontchange
-			if (tag =3D=3D "</BIG>") then table.remove(statestack) end
-			if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
-			=

-			--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
-			--~ for token in string.gfind(textstring, "%w+") do table.insert(bToken=
,token) end
-			--~ local iStart,iEnd,a,b,c =3D string.match(part,"")
+		if (bIsUniCode) then =

+			for k,unicode_charcode in ipairs(uohtml) do glyphlist:AddFontGlyph(font=
,fontsize,unicode_charcode,col) end
+		else
+			glyphlist:AddText(font,fontsize,uohtml,col)
 		end
 	end
 	self:UpdateGeometry()



From no-reply at zwischenwelt.org  Sun Jul  6 17:41:04 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 06 Jul 2008 15:41:04 -0000
Subject: [Iris-commit] [IRIS] r2291 - /trunk/data/base/ui/tabbed.png
Message-ID: <20080706154104.EA4101C180B0@zwischenwelt.org>

Author: hagish
Date: Sun Jul  6 17:41:04 2008
New Revision: 2291

Log:
tabpane image

Added:
    trunk/data/base/ui/tabbed.png



From no-reply at zwischenwelt.org  Tue Jul  8 10:54:09 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 08 Jul 2008 08:54:09 -0000
Subject: [Iris-commit] [IRIS] r2292 - in /trunk: data/base/ui/ lua/ lua/gui/
	lua/net/
Message-ID: <20080708085411.B24FA1524030@zwischenwelt.org>

Author: hagish
Date: Tue Jul  8 10:54:07 2008
New Revision: 2292

Log:
*first tabbed chat window
*weapon abilities work-in-progress

Modified:
    trunk/data/base/ui/tabbed.png
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.main.lua
    trunk/lua/gui/gui.skill.lua
    trunk/lua/lib.3d.cam.lua
    trunk/lua/lib.3d.walksmooth.lua
    trunk/lua/lib.compass.lua
    trunk/lua/lib.cursor.lua
    trunk/lua/lib.debugmenu.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.pathfind.lua
    trunk/lua/lib.protocol.lua
    trunk/lua/lib.static.lua
    trunk/lua/lib.uodragdrop.lua
    trunk/lua/main.lua
    trunk/lua/net.popup.lua
    trunk/lua/net.walk.lua
    trunk/lua/net/net.aoscommand.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/net/net.other.lua

Modified: trunk/data/base/ui/tabbed.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/ui/tabbed.png (original)
+++ trunk/data/base/ui/tabbed.png Tue Jul  8 10:54:07 2008
@@ -1,6 +1,10 @@
 =C2=89PNG
 =1A
-=00=00=00
IHDR=00=00=00=C2=80=00=00=00=C2=80=08=06=00=00=00=C3=83>a=C3=8B=00=00=00=01=
sRGB=00=C2=AE=C3=8E=1C=C3=A9=00=00=00=06bKGD=00=C3=BF=00=C3=BF=00=C3=BF=C2=
=A0=C2=BD=C2=A7=C2=93=00=00=00	pHYs=00=00=0B=10=00=00=0B=10=01=C2=AD#=C2=BD=
u=00=00=00=07tIME=07=C3=98=07=06=0F=0B8eX=C2=91F=00=00=00=19tEXtComment=00C=
reated with GIMPW=C2=81=0E=17=00=00=05=0EIDATx=C3=9A=C3=AD=C2=9D=C2=BFO=14A=
=14=C3=87=C3=9F^=08=05=C2=9D=C2=89=C2=9A=10=C2=88=C2=9D=C2=95=164=C3=84=C2=
=86F=C3=BF=03!t=C2=B4(=C2=94JB=C2=A21 =14=C2=9A=C2=90=00%=08-=1D=01=C3=BE=
=03m=C2=AE=C2=B9=C3=90Xheg0&j=C3=A2=7F=C3=80Y=C2=90=3D=C3=A7=C3=B6=C3=97=C3=
=8C=C3=AC=C3=AC=C3=AC=C3=AC=C3=9D}>	=C2=B9;=C2=B8=C3=99]=C3=B6}g=C3=B6=C3=
=8D=C3=9B=C2=B7oDD=C2=A4+=C3=92=15K\=C3=9B=C2=84=C3=98'=C2=A4i=C3=95}=C2=82=
=C2=BA"=C3=9D=10=C3=BB=C3=84=C3=94=C3=99=C2=8CE"=C2=91=C2=88=C3=88=C3=ACt=
=C2=AB=C3=B0$]^]G=C3=AA=C3=A7=C2=B8=C2=9D=C2=8An=1BQb=1B=0F=C3=AE=16=7F=C3=
=BF=C3=AB/=C3=BD>u=C3=9B=C2=88=12=C3=9B=C2=80=C2=84=00=C3=94=0Fg=C2=A7=C3=
=BB=C2=B9_\X|=C2=A1=C3=ADE=C2=9A=C3=B6=C2=99=C2=BF=C3=9F=C3=99y=C2=99=C3=9B=
f}}O=C2=BBOM{,l#=00=11=C2=91=C2=95=C3=95=C3=8D=C3=94=C2=97=0E=0F=C2=B6
-=C2=8Dk=C3=92=C2=BE=C2=88w=C3=AF?=C2=A4~=C3=B7=C3=BA=C3=95=C3=B3B=C3=A3=C2=
=9A=C2=B4=C2=87=12=02=10=11=C2=B9?9=C3=95=C3=B7yw=C3=BB=C2=A8=C3=B7~m=C3=A3=
=C2=99=C3=ACn=1F=C2=A5^=C3=B3=C3=9A~=C3=BB=C3=B9=C3=83=C3=A8@=C3=AE=C3=9D=
=C2=BE=C3=93=C3=B7=C3=B9=C3=A4=C3=B8=C2=BC=C3=B7~iy^N=C2=8E=C3=8FS=C2=AFym=
=C2=BF=C3=BF=C3=B9=C2=8De]=04 "=C3=B2h=C3=AE=C3=BFI=C2=9D{=C3=B2=C2=B4=C3=
=AFok=1B=C3=8F2_ED=C3=9A=1F/z=C3=AF;m;C<=C2=9C=C2=B9=C3=95{?3=C3=BB=C2=B8=
=C3=AFoK=C3=8B=C3=B3=C2=99=C2=AF""=C2=9F/?=C3=B5=C3=9E=7F=C3=B9=C3=BC=17=C2=
=ABV!=C2=80,=C3=83=C2=9B=10=C2=B7Q=C2=85`C=C3=92=C3=B06mT!=C2=80=C3=A14=C2=
=90S=C2=80=002=1D=C2=B62=C2=BD?k$=C3=909=C2=80=C2=AA=C3=83V=C2=A6=C3=B7g=C2=
=8D=048=C2=80%=04pyu=1D=C3=A5M=C3=95\YX|=C2=91=C2=8A#=C3=84=C3=B3|_S=C2=B5=
=C3=B5=C3=B5=C2=BDT=1C=01=C2=B8=04=C2=80=C2=89=00T=C2=AF=C3=9E=05=C2=9B=C3=
=AD=C2=A8^=C2=BD=0BUmg=C2=A4=05=C2=A0=C3=8E=C3=AB]=C2=B0=C3=99=C2=8E:=C2=AF=
w=C2=A1=C2=AA=C3=AD=C2=8C=C3=8C40=C2=BEQ=C2=A2=C3=86=C3=99}=C2=8D=00=C3=89=
=C2=9B2=C3=AA>}=C2=8D=00Y=C3=BF=1F(=02=C3=88:1q=C2=84=C2=AF=C2=8A=11@=C3=9D=
Nr_=C3=B1=C3=8D=C2=A3=C2=B7o=C2=AAw=04'=C3=86o=C2=B6=1F]=C3=A1=08=16
- =C2=84=0F=C3=90=C3=AB=C2=95=C2=96=C3=86=C3=A9=C2=8Atm{2#@=03}=C2=80=C2=BA=
=C2=8D=C2=81=C3=B1=C2=99=06=C2=82N=00=C2=B3=C3=93=C2=AD=C2=AE=C3=A9-_[=C3=
=8EN=C3=B7=C3=BB=C2=92E=C3=88=08j=C2=B0=0F=C2=B0=C2=B2=C2=BA)=C3=B7'=C2=A7=
=C2=A4=C3=BD=C3=B1=C3=82)=1C=1C=C3=9F=0CZY=C3=9DL=C2=85=C2=83Cf!=C2=81=C2=
=81=13X'!=C2=B2=C2=90=C3=80P=00q/=C2=B6=19	=C3=8A=C3=9C=06=0E=C2=91=C2=85=
=04=1A=01=C2=A8=C3=89=1C=C2=9D=C2=B6yFPYBd!A=C2=8E=00=C2=92'0=C3=99=C2=9B=
=C2=8A2=C2=82=C2=B2z=C2=A3)!=C2=B2=C2=90=10=C2=80=C3=A1=C3=90ir=3D=3D;=C3=
=9Dw=1EzCd!!=00=03#_=1Ax=C3=93&N=1B4L=00U=C2=86eu"=C3=89=0B=C3=8B=1E=1El=C3=
=89=C3=AE=C3=B6Q%YH=C2=9D=C3=B6=11=0E=C2=A0=05=C2=AD=C2=90a=C3=99=10YH=C2=
=90=10@^=C2=80=C3=85=C3=86=C2=90>=C3=9B@
=02h=02!=C2=B2=C2=90=C2=A0A=02=08=C2=91=C2=85=04=C2=81=04=C2=90=C3=B5=C2=88=
=C2=B8=C3=8F,$n=065L=00=C2=91H=14=C2=89D=C2=BA=1B9=C2=AE=C3=8CN=C2=B7=C2=BA=
=C3=B1=C2=BE0u=C2=83(=C3=9B+=C3=8B=C2=B6a=04h=C3=A0=080=C3=8C=C3=BB=03=18=
=18=C2=ACz=C2=86mI=C2=97=10=C3=A8=C2=8Eqb=C2=BC=C2=B8}=13=C2=82G=C2=B6=C2=
=892.X'=C2=84=C2=B8=C2=96t=C3=B1=C2=8DI=C3=89=18=C3=97$=14=C3=9F=C3=94=C2=
=99=C3=A4R*#=C3=88=C2=B5=C2=A4=C2=8BoLJ=C3=86=C2=B8&=C2=A1=C3=B8=C2=A6=C2=
=AE$=C2=97=C3=92)a=C2=A6%]|=C3=A3R2=C3=864	=C3=857!=C2=93\=C2=9Cr=02MJ=C2=
=BA=C3=B8=C3=86=C2=B5d=C2=8CI=12=C2=8AoB&=C2=B98'=C2=85=C2=BA=16u=C3=B0=C2=
=81m=C3=89=18=C3=97=C3=9B=C3=90>=C2=A8+=C3=89=C2=85=07CF=C2=9CR=02=C2=A8=C2=
=AA=C2=A4K]#AV=C3=89=C2=98=C2=AAJ=C3=A1=C3=945=12=C3=B8Jr=C2=B1=12=C2=80=C3=
=8F=C2=92.=C2=BE=C2=89K=C3=86=C3=B8LB=C3=B1=C2=8D=C2=8F$=17.=01\=02=C3=9C=
=C2=BC=C3=AF=C2=A6St=C2=9C=C2=83=C2=92<=C3=A2=C3=B38["7=C2=A1=C3=87=C2=A2=
=C2=9F=C2=BC=C3=B9=C3=B7 Pt=C2=9C=C2=83=C2=92<br=C2=9Cel(=C2=A2<=C2=A49j=C3=
=8F=C3=985%=C3=A2g=C3=AB=03=C2=94=C3=B9=7F=C2=8A|=C2=87=C2=BE8@=C3=93=C3=83=
=C2=A3=C2=A3=C2=8E=C3=8E=0Ee=C3=82=C3=87=C2=A9 at PS=C3=82=C2=A3=C2=A0=C2=BF,T=
=11>=C3=8E=C2=8C=046!<
-f=C2=8E=C2=A1k=C3=B8xL=17=C2=80=C2=80=C3=81=C2=A1L=C3=B8=C2=988=00q=C2=80=
=C2=B4=C3=83@=C3=AF=1F=C2=8E=C2=91=C3=80$|=C3=9C=12=C3=B1=C3=BB=C2=8C=1E=C2=
=84=C2=9F:=16=C2=85=C2=8F=C2=B9=04p	=10=C2=BC=C3=BC!=C2=9E%X=0B=C2=80g=C3=
=AB=C2=86'N=C3=80=08=C3=80=08=C3=804=10=10=00 =00@=00=C2=80=00=00=01=00=02=
=00=04=00=08=00=10=00 =00@=00=08=00=10=00 =00@=00=C2=80=00=00=01=00=02=00=
=04=00=08=00=10=00 =00@=00=C2=80=00=00=01=00=02=00=04=00=08=00=10=00 =00@=
=00=C2=80=00`=C3=A8=04@=C2=89=C2=98=C3=A1=C2=80=121#=0EE=C2=A2=18=01=C3=B0=
=01=C3=80P=00=C2=BA=05#`p9;=C3=9D/\=C2=8C=C2=BAo=04=C2=88=17=1C=C3=B0=C2=BD=
X!=C3=B8%=C2=B6_=C3=96=02=12\=02=C2=A0=C2=8F1=C2=9D=C2=8A=C2=A8=1C>x=3D=C3=
=9FY=00=C3=AAj=13=C2=9D6K=C3=864=C3=95=C3=8BO.=19S=C3=89=08=C2=90\g&Ys=1E=
=C3=A37k=C2=9E=C2=AF=C3=9A=C3=83=C3=A4=C2=9A_(=C2=80=C2=BC=05=06XK`0=C2=BC=
=C3=BD2=C3=AB=0B=C3=B7=C3=96
,=C3=BAR=C3=95=C3=AB=C3=95B=C3=B5`C=00=00=00=00=00=00=00=00=00=00=00=00=00=
=00=00=00=00=00=00=00=C2=80Q=C3=A5=1F=C2=91 =C2=8C=C3=95=C3=9D9 =C2=88=00=
=00=00=00IEND=C2=AEB`=C2=82
+=00=00=00
IHDR=00=00=00=C2=80=00=00=00=C2=80=08=06=00=00=00=C3=83>a=C3=8B=00=00=00=01=
sRGB=00=C2=AE=C3=8E=1C=C3=A9=00=00=00=06bKGD=00=C3=BF=00=C3=BF=00=C3=BF=C2=
=A0=C2=BD=C2=A7=C2=93=00=00=00	pHYs=00=00=0B=10=00=00=0B=10=01=C2=AD#=C2=BD=
u=00=00=00=07tIME=07=C3=98=07=07	=08=1A'$=C2=98=C2=B6=00=00=00=19tEXtCommen=
t=00Created with GIMPW=C2=81=0E=17=00=00=06<IDATx=C3=9A=C3=AD=C2=9DOh=14W=
=1C=C3=87=7Fo	=1E=C2=84=C2=A2=C2=85=C2=B6"=06=C2=A1=C2=A0Ph=0F=C3=B6=10JA
+=C3=8D=C2=B9=14=C3=AA=C2=92S{=C2=A8=C2=8869=C2=95T=08=C2=B4=16S=03=C2=B6 =
=C3=84%'5"zHN=C3=8B*=C2=84=C3=9E=C2=84=08=C2=B2=10B=0E=C3=B1P!=C3=90=C2=85=
=C3=82b)=C3=95B[z=C3=8F=C3=B4=C2=B0=C2=BEu=C3=BE=C2=BCy=7F=C3=A7=C3=AD=C3=
=8C=C2=BC=C3=BD~ =C3=AC=C3=AC=C3=AE=C2=BC=C2=99=C3=99y=C3=9F=C3=B7=C3=9E=C3=
=AF=C3=BD=C3=A6=C2=97=C3=9F#"=C2=A2=C2=88("C\=C3=8B=C2=94qN=C2=90=C2=A51=C3=
=AA=1B=14=11Ee=C2=9C=13U-f=C2=82=111"=C2=A2=C2=A9=C3=89=C2=86=C3=B4&=C3=AD<=
=C3=9Bg=C3=B1=C3=B7=C2=BC\=1C=C3=951X=C3=AA=18=C3=AF=C2=BE%=C3=9F=C3=BF=C3=
=A9s=C3=B59U=C3=87`=C2=A9c=C3=98=C3=BCV=C3=93=C3=BDk%=C2=80=C3=B8=C2=9BN=C2=
=BB=C2=95=C2=BBcsf^=C3=99=C2=8A=14=C3=A5=C2=85=C2=9F_=C2=BB=C3=B6Mn=C2=99=
=C2=85=C2=85=C3=AB=C3=8As*=C3=8A=C3=9B^k=C3=A4=C3=BA=C2=BBj)=00"=C2=A2=C3=
=99=C2=B9=C3=85=C3=8CN7o\=C2=91=C3=9E=04=C2=9D=C3=B22~=C3=BC=C3=A9V=C3=A6=
=C2=B3=C3=AF=C2=BE=C3=BDJZ=C2=B9:=C3=A5U=C2=AC=C2=ADod>=C3=BB=C3=A2=C3=B3O=
=C2=85=C2=BF5o=C3=9F=C3=9A=0F=01=C2=A2=0FO=1E=3D=C2=96x=C2=BF=C2=BC=C2=B4:=
=C3=9C=C2=BEx=C3=B9=02-/=C2=ADf^=C3=B3=C3=8A=C3=BE=C3=BA=C3=87=C3=AFZ=17r=
=C3=BC=C2=8D7=C2=937=C3=BC=C3=B6=C3=BDW7=C3=BA=C3=BC=19Z=C2=BB}?=C3=B3=C2=
=9AW=C2=B6=C3=BF=C3=97=0B=C3=AD=1Bp=C3=A4=C3=90=C3=A1=C3=84=C3=BB=C2=87??=
=C3=96=C3=9A=C3=AF=C3=8F=7F=C3=BF	=C3=83=06=C3=88=C3=BB=C3=A2=C2=83=C3=93=
=C2=AFn=C3=AA=C3=A9=C3=A9=C3=8F=12=C3=9F]=C2=BC|A=C3=B8JD=C3=94=C3=9D|0=C3=
=9C=C3=9E=C3=AE=C2=BE0=C2=BA=C2=98=C3=B7N=C2=BD>=C3=9C>5=C3=B5q=C2=B2=C2=B5=
=C2=9D?#|%"z=C2=B2=C3=B3h=C2=B8=C3=BD=C3=8B=C2=93=C2=BF=C2=8Do=C3=82=C3=9B'=
^=1Bn=C2=9Fx=C3=A7}=C3=A1>=C2=BD=C2=BD=C3=9D=C3=A1=C3=B6o=C2=BD=C3=BF=C3=82=
1=02e_=C2=A6+^=07^&.=04=13=C3=92=15oR&.=04Sx=C3=85=1F=C3=BF=C3=B0k=C3=A1=C3=
=B7=C3=BD=C2=AD=C2=95=C2=8C=10=C2=82=17=C3=808=C3=81+>=C2=8A=C3=84v'c=03C=
=7F=C3=B3=C3=AE=C2=97a=C3=B9=01=C3=B2=0C6=C2=9B=C3=96/=C3=AA	T=06`=C3=9C`=
=C2=B3i=C3=BD=C2=A2=C2=9E@=C3=87=00=C2=8C=1Bq=C3=93g=C3=AFQ=14E=C2=B9=C2=95=
=C3=8F=C2=85=11E=11M=C2=9F=C2=BD=17=C2=8C=01=C2=98=10=C3=80=C3=8E=C2=B3}=C3=
=A6kJ=C3=93=C2=9C=C2=99=17=C3=8E=C2=95=C2=9F>=C3=9Fg=C2=B2=C2=A9=C2=9A=0B=
=0B=0B=C3=973~=C2=84=C2=A2=7Fk=C3=9E=C3=AF=C3=82=10P#=C3=8E]=C3=ADH[=C2=BE=
=C2=A8'`=C2=8CQ=C3=BF=C2=93=C2=8F=C3=82=1C=02=C3=92V=C2=BD=0B&=C3=87=C2=89[=
=C3=B5.=14u=C2=9CqA(=C2=80=C3=B8=C2=BC=C3=9E=05=C2=93=C3=A3=C3=84=C3=A7=C3=
=B5.=C2=98=1E=C3=A7=C3=8E=C2=A5=C3=A6=C3=90=C3=80=C3=93=C2=811Fw.5=C3=83=11=
=C2=80=C3=A8=C3=A1=C2=8C=C2=AF=1E=C2=80=C2=9FKtN_=3D=C2=80=C3=A8\S=C2=93=C2=
=8D(=C3=AE=C3=AD=C3=ABo=C2=AD(E=C3=80=18=1Bt=C3=BD/=C2=A7=C2=83D=03=17=C2=
=B1=C3=AA9A=C3=A5m=00=C3=91=03=16=C3=AE=C3=A1+=C2=A2=07=C2=88=1F'}.~=C3=B3~=
=C3=B8=C2=BExC=C3=B0=C3=A0=C2=81=C3=81=C3=B1=C2=99=C3=84H[[=C3=9F=C2=A0#=C2=
=87=0ESoo7!=C2=82=C2=B8M=C3=80?K=C3=BB=01=C3=96=C3=967=C3=82u=05=C3=BB=C2=
=B6=01x=C2=8Bd=C2=86=16tD=14=C2=89=04=C2=AB*#=12_=C2=9E=C2=B3=C2=87=C3=BB=
=03=C3=92=15=0F=1B=C2=A0@=1B=C3=80=C2=B4=12]=C3=919_oo7Q=C3=B9=C3=BD=C2=AD=
=C2=95D=C3=A5=C3=B7=C3=B6v=C2=83=C3=B3=02b=1A=C3=B8=12=C3=AE=C3=9B=C2=8F=1B=
wy=0F=C2=85=C2=82=15@=C3=9A0*=C2=92N=C2=BBE=C3=8D=C2=99=C3=B9=C2=88;M=C3=8A=
=C2=88=08=C3=8A=C3=AB=05=C3=92O=C3=B5=C3=B2=C3=86u=C3=91=C3=A3=C3=A0 {=C2=
=80=C3=99=C2=B9E:y=C3=B4=18u7=1F8=C2=B9=C2=83=C3=B9=C3=83=C2=A0=C3=99=C2=B9=
=C3=85=C2=8C;=C2=B8=C3=8C($=C2=9D=C3=8AN{	;=C3=ADV0=C2=AE=C3=9F=C3=8A
=01eD!=C2=A9=C2=BEK=0BO=C3=A7:=C2=82=14=00o=C3=85&=3D=C2=81=C3=8Dc=C3=A0QG!=
=C2=99=C3=BA=C3=AF=C3=AB=C3=AE=C3=AF=C2=B7=12@<=C2=98c=C2=BB=C2=AB=1F=11dK=
=19QH G=00=C3=A9=1B=C2=98nM=C2=B2=C2=88 Qk=C3=94=C2=A5=C2=8C($=08@=C2=B3=C3=
=AB=C3=94y|=C3=9Ai=C2=B7=C2=B4=C2=9E=C3=BF=C3=8B(#
+	=02=C2=B00=C2=8Cl=C2=8D6P1=01=14=C3=A9=C2=96U=C2=89$=C3=8F-{=C3=B3=C3=86=
=15Z^Z-$
+i=C2=BB=C2=BB=C3=AA=C3=9C=0B=C2=8D=13=C2=8D2=C3=9D=C2=B2eD!=C2=81=C2=94=00=
=C3=B2=1C,&=15=C3=A9=C2=B3=0C=18=C2=81=00=C2=AA@=19QH=C2=A0B=02(#
+	=C2=94$=C2=802=C2=A2=C2=90P=C3=95=15=12=00#b=C2=8C=C2=88=C3=B9=0E=C2=A7=
=C2=9A=C2=9AlD=C3=BC\=C2=A8=C3=AA
+a=C3=9B*m=C3=8B=C2=A0=07=C2=A8`=0F=10=C3=B2=C3=B9=00=C2=A8
F-=C3=834=C2=A5K=19=C2=A8=C2=AE=C3=B1=C3=A0=01y=C3=B9*8=C2=8FF=C2=99=C2=92=
=C3=868 =C3=845=C2=A5=C2=8BotR=C3=86=C2=B8=06=C2=A1=C3=B8f=C2=94)i=C2=AC"=
=C2=82\S=C2=BA=C3=B8F'e=C2=8Ck=10=C2=8AolR=C3=AD=C2=8CL=00D=C3=BA)]|=C3=A3=
=C2=922F7=08=C3=857e=06=C2=B98=C3=85=04=C3=AA=C2=A4t=C3=B1=C2=8Dk=C3=8A=18=
=C2=9D =14=C3=9F=C2=94=19=C3=A4=C3=A2=1C=14=C3=AA=C2=9A=C3=94=C3=81=07=C2=
=A6)c\=1FC=C3=BB`TA.
=02c=C2=8D=C2=95=00=C2=8AJ=C3=A92=C2=AA=C2=9E@=C2=942=C2=A6=C2=A8T8=C2=A3=
=C3=AA	|=05=C2=B9=18	=C3=80gJ=17=C3=9F=C3=B0=C2=941>=C2=83P|=C3=A3#=C3=88=
=05C=00=C2=86=007=C3=AB=C2=BB=C3=AA=C3=88=C2=AE=C2=B3.=C3=81#>=C2=AF=C2=B3A=
4p=3D=C3=8A=C3=BE=C3=B2=C3=A6=C3=9Fu at v=C2=9Du	=1E=C3=91=C2=B9N=C2=9B:$=C2=
=8A=C3=BD=C2=93f=C3=88=19=C2=B1ET=C3=85=C3=A3gj=03=C3=98=C3=BC=1E=C2=99=C3=
=AD=C2=90=C3=B0=03T=C3=9D=3D:=C3=AE=C2=A8=C3=AA=C3=81=C3=86}=C2=9Cq=04U=C3=
=85=3D
+=C3=94=C3=83B=11=C3=AEc=C2=A1'=C2=B0
+=C3=AEQ=C2=A0g=18=C2=BA=C2=BA=C2=8F'T=0E=08P=1Fl=C3=9C=C3=87=C3=B0=03=C3=
=80=0F=C2=905=18=C3=90=C3=BA=C3=83=C3=A8	t=C3=9C=C3=87
"=C2=BF=C3=BF=C2=A3=07=C3=8A=C2=9F:=C3=8A=C3=9C=C3=87=18=020=04=10=C2=AC=C3=
=BC=C2=80g	=C3=86=02=C3=80=C3=BF=C3=96=C2=85=C3=A3'@=0F=C2=80=1E=00=C3=93@=
=00=01=00=08=00@=00=00=02=00=10=00=C2=80=00=00=04=00 =00=00=01=00=08=00@=00=
=10=00=C2=80=00=00=04=00 =00=00=01=00=08=00@=00=00=02=00=10=00=C2=80=00=00=
=04=00 =00=00=01=00=08=00@=00=00=02=00=10=00=C2=80=00=00=04=00 =00=00=01=C2=
=80=C3=A0=04=C2=80=141a=C2=80=141c=0E=C2=92D=C2=A1=07=C2=80
=004=05=C2=A0Z0=02=C3=94=C2=97N=C2=BB%]=C2=8C:=C3=91=03=C3=B0=05=07|/V=08=
=C3=BC=C3=82=C3=ABO=C2=B4=C2=80=04=C2=86=00=C2=90`B=C2=A5"d=0E=C2=AF_=C3=8B=
w=16@|=C2=B5=C2=89=C3=AD.=C2=96=C2=8C=C2=A9=C2=AA=C2=95=C2=9F^2=C2=A6=C2=90=
=1E =C2=BD=C3=8EL:=C3=A7<*=C2=BFZ=C3=B3=C3=BCx}=C3=A8=C2=8C=C3=B9R=01=C3=A4=
-0=C2=80=C2=B5=04=C3=AAa=C3=AD=C3=9B=C2=AC/<\7P=C2=B6S=C3=91=C3=AB=C3=95=C2=
=82=C3=A2A=1D=02=00=00=00=00=00=00=00=00=00=00=00=00=00=00=00=00=00=00=00=
=00=00=00=00=00=000=C2=AE=C3=BC=0Fnn7=05e=3D=1F=C3=83=00=00=00=00IEND=C2=AE=
B`=C2=82

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Tue Jul  8 10:54:07 2008
@@ -889,7 +889,7 @@
 			-- TODO : display tooltip
 			elseif ((command =3D=3D "tooltip") and (table.getn(bToken)>=3D 2)) then
 				local msg =3D HtmlParser( gClilocLoader and gClilocLoader:Get(bToken[2=
]) or "no_cliloc" )
-				AddFadeLines("HtmlGumpparser - tooltip (TODO):"..msg.text)
+				GuiAddChatLine("HtmlGumpparser - tooltip (TODO):"..msg.text)
 			else
 				printdebug("gump","UNKNOWN Generic Gump Command: "..command)
 			end

Modified: trunk/lua/gui/gui.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.main.lua (original)
+++ trunk/lua/gui/gui.main.lua Tue Jul  8 10:54:07 2008
@@ -12,3 +12,4 @@
 dofile(libpath .. "gui/gui.skill.lua")
 dofile(libpath .. "gui/gui.spellbook.lua")
 dofile(libpath .. "gui/gui.trade.lua")
+dofile(libpath .. "gui/gui.chat.lua")

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Tue Jul  8 10:54:07 2008
@@ -76,7 +76,7 @@
 	-- print("SKILL DEBUG",value,last_value,base_value,last_base_value)
 	if value and last_value and (last_value ~=3D value) then
 		-- display change
-		AddFadeLines("Skill "..name.." is now "..sprintf("%3.1f",value / 10).." =
-> "..sprintf("%3.1f",(value-last_value) / 10),gStatsInfoFadeLineColor)
+		GuiAddChatLine("Skill "..name.." is now "..sprintf("%3.1f",value / 10)..=
" -> "..sprintf("%3.1f",(value-last_value) / 10),gStatsInfoFadeLineColor)
 	end
 	=

 	-- update entry

Modified: trunk/lua/lib.3d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.cam.lua (original)
+++ trunk/lua/lib.3d.cam.lua Tue Jul  8 10:54:07 2008
@@ -116,9 +116,9 @@
 	self.gCamLookAheadDist =3D self.gCamLookAheadDistList[self.gCamMode]
 	self.gbCamRotChanged =3D true
 	if (self.gCamMode =3D=3D self.kCamMode_Ego) then self.gfCamAngV =3D 0.0 s=
elf.gfCamAngH =3D kPi - 0 end
-	if (self.gCamMode =3D=3D self.kCamMode_Ego) then AddFadeLines("CamMode:Eg=
o") end
-	if (self.gCamMode =3D=3D self.kCamMode_Third) then AddFadeLines("CamMode:=
ThirdPerson") end
-	if (self.gCamMode =3D=3D self.kCamMode_FreeMove) then AddFadeLines("CamMo=
de:Free") end
+	if (self.gCamMode =3D=3D self.kCamMode_Ego) then GuiAddChatLine("CamMode:=
Ego") end
+	if (self.gCamMode =3D=3D self.kCamMode_Third) then GuiAddChatLine("CamMod=
e:ThirdPerson") end
+	if (self.gCamMode =3D=3D self.kCamMode_FreeMove) then GuiAddChatLine("Cam=
Mode:Free") end
 	=

 	self:BlendOutLayersAbovePlayer()
 end

Modified: trunk/lua/lib.3d.walksmooth.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.walksmooth.lua (original)
+++ trunk/lua/lib.3d.walksmooth.lua Tue Jul  8 10:54:07 2008
@@ -25,7 +25,7 @@
 		mobile.gfx3d_walksmooth_last_dir  =3D mobile.dir =

 		mobile.gfx3d_walksmooth_last_time =3D gMyTicks
 		local timediff =3D mobile.gfx3d_walksmooth_last_time - (mobile.gfx3d_wal=
ksmooth_prelast_time or 0)
-		--AddFadeLines("walksmooth"..":"..timediff..","..mobile.xloc..","..mobil=
e.yloc..","..sprintf("0x%02x",mobile.dir))
+		--GuiAddChatLine("walksmooth"..":"..timediff..","..mobile.xloc..","..mob=
ile.yloc..","..sprintf("0x%02x",mobile.dir))
 	end
 	=

 end

Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Tue Jul  8 10:54:07 2008
@@ -410,7 +410,7 @@
 	=

 	gfCompassCurrentZoomFactor =3D math.min(1, gfCompassCurrentZoomFactor / f=
actor)
 	=

-	--AddFadeLines("visrad=3D"..gCompassVisibleRad)
+	--GuiAddChatLine("visrad=3D"..gCompassVisibleRad)
 	gCompassVisibleRad =3D max(gCompassVisibleRad,giCompassDetailLimit)
 	local bRough =3D IsRoughCompassActive()
 	gIrisCompassDialog.detailcompass.gfx:SetVisible( not bRough )

Modified: trunk/lua/lib.cursor.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.cursor.lua (original)
+++ trunk/lua/lib.cursor.lua Tue Jul  8 10:54:07 2008
@@ -99,7 +99,7 @@
 end
 =

 function StartTargetMode ()
-	AddFadeLines("please pick a Target")
+	GuiAddChatLine("please pick a Target")
 	SetUOCursor(kCursorIndex_Target)
 	gTargetModeActive =3D true
 	if (gAutoTargetMobile) then
@@ -112,7 +112,7 @@
 =

 -- client side cancel
 function CancelTargetMode ()
-	AddFadeLines("Target Mode canceled")
+	GuiAddChatLine("Target Mode canceled")
 	CleanupTargetMode()
 end
 =


Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Tue Jul  8 10:54:07 2008
@@ -602,7 +602,7 @@
 		local mobile =3D gDebugMenuModelTable[index]
 		if (not mobile) then return end
 		RepairEquipIndex(mobile.content)
-		AddFadeLines(sprintf("DebugMenuShowModel model=3D%04x(=3D%d) anim=3D%d[%=
s] %s",mobile.artid,mobile.artid,gDebugMenuAnimIndex,GetAnimName(mobile.art=
id,gDebugMenuAnimIndex) or "", gDebugMenuModelName or ""))
+		GuiAddChatLine(sprintf("DebugMenuShowModel model=3D%04x(=3D%d) anim=3D%d=
[%s] %s",mobile.artid,mobile.artid,gDebugMenuAnimIndex,GetAnimName(mobile.a=
rtid,gDebugMenuAnimIndex) or "", gDebugMenuModelName or ""))
 =

 		gDebugBodyGfx =3D CreateBodyGfx(gDebugRootGfx)
 		gDebugBodyGfx:MarkForUpdate(mobile.artid,mobile.hue,mobile.content)
@@ -628,7 +628,7 @@
 		if gDebugLastMeshName then ReloadMesh(gDebugLastMeshName) end
 		gDebugLastMeshName =3D meshname
 		local tricount =3D meshname and CountMeshTriangles(meshname) or 0
-		AddFadeLines(sprintf("static %04x(=3D%d) hue=3D%d tricount=3D%d %s",iTil=
eType,iTileType,iHue,tricount,GetStaticTileTypeName(iTileType) or ""))
+		GuiAddChatLine(sprintf("static %04x(=3D%d) hue=3D%d tricount=3D%d %s",iT=
ileType,iTileType,iHue,tricount,GetStaticTileTypeName(iTileType) or ""))
 		if (meshname and meshname ~=3D false) then
 			gDebugRootGfx:SetMesh(meshname)
 			gDebugRootGfx:SetOrientation(GetStaticMeshOrientation(iTileType))
@@ -869,7 +869,7 @@
 			if (gEnableSVNRemoveInStaticDebug) then -- BE CAREFUL WITH THAT !!!!  g=
EnableSVNRemoveInStaticDebug
 				local i =3D gDebugMenuModelIndex
 				os.execute("svn rm " .. GetModelPath(i))
-				AddFadeLines(sprintf("SVN REMOVE 0x%04x(=3D%d) %s",i,i,GetModelPath(i)=
))
+				GuiAddChatLine(sprintf("SVN REMOVE 0x%04x(=3D%d) %s",i,i,GetModelPath(=
i)))
 			end	=

 		end	=

 		end end end)
@@ -889,7 +889,7 @@
 			local i =3D gDebugMenuModelIndex
 			local notepath =3D "debugstatic.txt"
 			local text =3D sprintf("DebugStaticNOTE 0x%04x(=3D%d) %s %s",i,i,GetMod=
elPath(i),GetStaticTileTypeName(i) or "")
-			AddFadeLines(notepath..":"..text)
+			GuiAddChatLine(notepath..":"..text)
 			local f =3D io.open(notepath,"a")
 			f:write(text.."\n")
 			f:close()

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Tue Jul  8 10:54:07 2008
@@ -141,7 +141,7 @@
 	print("MacroCmd_ItemSlot_Set",slotnumber,itemserial)
 	local item =3D itemserial and GetObjectBySerial(itemserial)
 	local itemname =3D item and GetStaticTileTypeName(item.artid) or "empty"
-	AddFadeLines("ItemSlot "..tostring(slotnumber).." set to "..tostring(item=
name))
+	GuiAddChatLine("ItemSlot "..tostring(slotnumber).." set to "..tostring(it=
emname))
 	gMacroItemSlots[slotnumber] =3D itemserial
 end
 =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Tue Jul  8 10:54:07 2008
@@ -27,12 +27,12 @@
 	=

 	if ((not gLoginname) or gLoginname =3D=3D "" or (not gPassword) or gPassw=
ord =3D=3D "") then
 		local text =3D "cannot connect to shard '"..shardname.."', no username/p=
assword specified"
-		AddFadeLines(text)
+		GuiAddChatLine(text)
 		PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
 		return
 	end
 	=

-	AddFadeLines("connecting to shard '"..shardname.."' on "..gLoginServerIP.=
.":"..gLoginServerPort)
+	GuiAddChatLine("connecting to shard '"..shardname.."' on "..gLoginServerI=
P..":"..gLoginServerPort)
 	=

 	-- todo : move to gui ?
 	gDialog_IrisLogo:SetVisible(false)
@@ -41,7 +41,7 @@
 	gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServerS=
eed)
 	if (not gNet_State) then =

 		local text =3D "connecting to shard '"..shardname.."' on "..gLoginServer=
IP..":"..gLoginServerPort.." FAILED !"
-		AddFadeLines(text)
+		GuiAddChatLine(text)
 		PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
 		return
 	end
@@ -206,7 +206,7 @@
 --gameserverlist selection
 function MainMenuShowServerList (serverlist)
 	local MySelectServer =3D function(server) =

-		AddFadeLines(sprintf("connecting to server %s[%d]",server.name or "???",=
server.index or 0))
+		GuiAddChatLine(sprintf("connecting to server %s[%d]",server.name or "???=
",server.index or 0))
 		=

 --		Send_SystemSpecs()
 		=


Modified: trunk/lua/lib.pathfind.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.pathfind.lua (original)
+++ trunk/lua/lib.pathfind.lua Tue Jul  8 10:54:07 2008
@@ -128,7 +128,7 @@
 end
 	=

 function Pathfinding_FromTo	(sx,sy,sz, dx,dy,dz)
-	AddFadeLines("pathfinding...")
+	GuiAddChatLine("pathfinding...")
 	sz =3D sz
 	dz =3D dz
 	job.create(function()
@@ -202,10 +202,10 @@
 	end,function(a,b) =

 		-- print("FINISHED",a,b)
 		if a and countarr(b) > 0 then =

-			AddFadeLines("path found :)")
+			GuiAddChatLine("path found :)")
 			gWalkPathToGo =3D b
 		else
-			AddFadeLines("no path found :(")
+			GuiAddChatLine("no path found :(")
 		end
 	end)
 end

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Tue Jul  8 10:54:07 2008
@@ -65,7 +65,7 @@
 		for k,v in pairs(gNoLogPackets) do if (v =3D=3D iId) then bDoLog =3D fal=
se end end
 		if (bDoLog) then =

 			printdebug("net",sprintf("NET: ProtocolPacketRecvHandler "..packet_debu=
ginfo))
-			if (gbPacketLogToFadeLines) then AddFadeLines("recv "..packet_debuginfo=
) end
+			if (gbPacketLogToFadeLines) then GuiAddChatLine("recv "..packet_debugin=
fo) end
 		end
 		=

 		if (sPacketTypeName) then =


Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Tue Jul  8 10:54:07 2008
@@ -124,6 +124,8 @@
 	-- TODO currently just ignores the art atlas lockkeeper
 	local sMatName,iWidth,iHeight,iCenterX,iCenterY,u0,v0,u1,v1 =3D ArtAtlasL=
oadAndLockDirect(iTileTypeID+0x4000,0,nil)
 	-- print("###", iTileTypeID, sMatName,iWidth,iHeight,iCenterX,iCenterY,u0=
,v0,u1,v1)
+	=

+	if not sMatName then return nil end
 	=

 	gFallbackModelCacheGfx:SetSimpleRenderable()
 	gFallbackModelCacheGfx:SetMaterial(sMatName)

Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Tue Jul  8 10:54:07 2008
@@ -211,7 +211,7 @@
 end
 =

 function PrepareUODragDrop (item,widget,matname,w,h,offx,offy)
-	--AddFadeLines("dragdrop : prepare")
+	--GuiAddChatLine("dragdrop : prepare")
 	CancelUODragDrop() -- cancel last ? shouldn't happen
 	gDragDrop =3D {}
 	gDragDrop.item =3D item
@@ -263,7 +263,7 @@
 end
 =

 function StartUODragDrop ()
-	AddFadeLines("dragdrop : start")
+	GuiAddChatLine("dragdrop : start")
 	gDragDrop.started =3D true
 	if (gDragDrop.widget and gDragDrop.widget:IsAlive()) then gDragDrop.widge=
t.gfx:SetVisible(false) end
 	SetDragIcon(gDragDrop.matname,gDragDrop.w,gDragDrop.h,gDragDrop.offx,gDra=
gDrop.offy)
@@ -296,7 +296,7 @@
 -- end A : nothing happened, client side cancel
 function CancelUODragDrop ()
 	if (not gDragDrop) then return end
-	--AddFadeLines("dragdrop : cancel")
+	--GuiAddChatLine("dragdrop : cancel")
 	if (gDragDrop.started) then UODragDropToOldPosition() end
 	CleanUpUODragDrop()
 end
@@ -311,7 +311,7 @@
 -- end B : something happened
 function CompleteUODragDrop () =

 	if (not gDragDrop) then return end
-	--AddFadeLines("dragdrop : complete")
+	--GuiAddChatLine("dragdrop : complete")
 =

 	gCurrentRenderer:MousePick()
 	=

@@ -395,7 +395,7 @@
 			-- TODO : if layer is not empty, drop dragged item to backpack, take it=
em from layer to backpack, equip dragged item
 			-- NOTE : if layer is not empty and it's not possible to put item to ba=
ckpack -> check and solve this problem!
 			--		  (for now i added "or 0" for x and y to function "UODragDropToOldP=
osition()" )
-			AddFadeLines("you already have something equipped there !")
+			GuiAddChatLine("you already have something equipped there !")
 			CancelUODragDrop()
 		else
 			-- success ! (hopefully)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Jul  8 10:54:07 2008
@@ -377,6 +377,8 @@
 =

 	gInGameStarted =3D true
 	=

+	GuiInitChat()
+	=

 	NotifyListener("Hook_StartInGame")
 end
 =


Modified: trunk/lua/net.popup.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.popup.lua (original)
+++ trunk/lua/net.popup.lua Tue Jul  8 10:54:07 2008
@@ -131,7 +131,7 @@
 		if (mousebutton =3D=3D 2) then widget.dialog.uoPopupMenu:Cancel() end
 	end
 =

-	--AddFadeLines(sprintf("display popup serial=3D%08x numentries=3D%d",popu=
pmenu.serial,popupmenu.numentries))
+	--GuiAddChatLine(sprintf("display popup serial=3D%08x numentries=3D%d",po=
pupmenu.serial,popupmenu.numentries))
 	for k,entry in pairs(popupmenu.entries) do		=

 		local i =3D k - 1
 		entry.widget_text =3D guimaker.MakeText(dialog.rootwidget, entryoffx, en=
tryoffy + i * entryheight,
@@ -151,7 +151,7 @@
 		end
 		-- local w,h =3D entry.widget_text.gfx:GetTextBounds() -- TODO : so far =
useless, as parent cannot be resized ... =

 		=

-		--AddFadeLines(sprintf(" entry tag=3D%04x flags=3D%04x color=3D%04x text=
=3D%s",entry.tag,entry.flags,entry.color,entry.text))
+		--GuiAddChatLine(sprintf(" entry tag=3D%04x flags=3D%04x color=3D%04x te=
xt=3D%s",entry.tag,entry.flags,entry.color,entry.text))
 	end
 	=

 	--[[

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Tue Jul  8 10:54:07 2008
@@ -60,7 +60,7 @@
 	local tdiff =3D gLastLogTime and (gMyTicks-gLastLogTime) or 0
 	local prefix =3D sprintf("WalkLog t=3D%5d k=3D%2d r=3D%2d",tdiff,FastWalk=
_CountKeys(),countarr(gWalkRequests))
 	print(prefix,unpack(arg)) =

-	--~ AddFadeLines(prefix..arrdump(arg))
+	--~ GuiAddChatLine(prefix..arrdump(arg))
 	gLastLogTime =3D gMyTicks
 end
 =


Modified: trunk/lua/net/net.aoscommand.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.aoscommand.lua (original)
+++ trunk/lua/net/net.aoscommand.lua Tue Jul  8 10:54:07 2008
@@ -79,3 +79,9 @@
 	out:SendPacket()
 	printdebug("mobile",sprintf("NET: kPacket_AOS_Command: mobile_serial=3D0x=
%08x ability=3D%d\n",mobile_serial,weaponabilitytype))
 end
+
+
+
+function Send_AOSCommand_WeaponAbility	(mobile_serial, weaponability)
+	Send_AOSCommand(kPacket_AOS_Command_WeaponAbilityRequest, mobile_serial, =
weaponability)
+end

Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Tue Jul  8 10:54:07 2008
@@ -178,11 +178,11 @@
 		-- overload check
 		if stats.curWeight and stats.maxWeight then
 			if stats.curWeight > stats.maxWeight and gPlayerLastOverloadCheckWeight=
 ~=3D stats.curWeight then
-				AddFadeLines("You carry to much!!!! "..stats.curWeight.. " / "..stats.=
maxWeight,gStatsInfoFadeLineColor)
+				GuiAddChatLine("You carry to much!!!! "..stats.curWeight.. " / "..stat=
s.maxWeight,gStatsInfoFadeLineColor)
 				gPlayerLastOverloadCheckWeight =3D stats.curWeight
 			end
 			if stats.curWeight < stats.maxWeight and gPlayerLastOverloadCheckWeight=
 then
-				AddFadeLines("Weight is normal! "..stats.curWeight.. " / "..stats.maxW=
eight,gStatsInfoFadeLineColor)
+				GuiAddChatLine("Weight is normal! "..stats.curWeight.. " / "..stats.ma=
xWeight,gStatsInfoFadeLineColor)
 				gPlayerLastOverloadCheckWeight =3D nil
 			end
 		end

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Tue Jul  8 10:54:07 2008
@@ -282,6 +282,21 @@
 		Open_Spellbook(spellbook)
 	end
 =

+	--Enable/Disable SE Spell Icons
+	--OnCastSuccessful(spellid), OnEffectEnd (spellid), ClearCurrentMove, Cle=
arAllMoves, SetCurrentMove
+	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableSESpellIcons) then -- =
0x25
+		local temp =3D input:PopNetUint8()		--always 1
+		local abilityID =3D input:PopNetUint8()	--abilityID
+		local active =3D input:PopNetUint8()		--0/1 On/Off
+		printf("ABILITY\tSE Spell Icons abilityID: 0x%02x active: 0x%02x\n", abi=
lityID, active)
+	end
+
+	-- Subcommand 0x21: (AOS) Ability icon confirm.
+	-- Note: no data, just (bf 00 05 21) =

+	if (subcmd =3D=3D kPacket_Generic_SubCommand_Ability_Icon) then	-- 0x21
+		print("ABILITY","kPacket_Generic_SubCommand_Ability_Icon")
+	end
+
 	-- Receives a CustomHouse Serial & Revision Hash Number
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_RevisionCustomHouse) then	--=
 0x1D
 		local customhouseserial =3D input:PopNetUint32()
@@ -312,23 +327,14 @@
 		local olddamage_amount =3D input:PopNetUint8()
 --		printf("NET: Generic_SubCommand_OldDamage: mobile-serial: 0x%08x Damag=
e_Amount: %i\n",olddamage_serial,olddamage_amount)
 		if (olddamage_serial =3D=3D gPlayerBodySerial) then
-			AddFadeLines(sprintf("%s",olddamage_amount).." Damage received")
+			GuiAddChatLine(sprintf("%s",olddamage_amount).." Damage received")
 		else
-			AddFadeLines(sprintf("%s",olddamage_amount).." Damage done")
+			GuiAddChatLine(sprintf("%s",olddamage_amount).." Damage done")
 		end
 		=

 		-- show fading damage over the mobile
 		-- TODO totally untested
 		gCurrentRenderer:NotifyDamage(olddamage_serial,olddamage_amount)
-	end
-
-	--Enable/Disable SE Spell Icons
-	--OnCastSuccessful(spellid), OnEffectEnd (spellid), ClearCurrentMove, Cle=
arAllMoves, SetCurrentMove
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableSESpellIcons) then -- =
0x25
-		local temp =3D input:PopNetUint8()		--always 1
-		local abilityID =3D input:PopNetUint8()	--abilityID
-		local active =3D input:PopNetUint8()		--0/1 On/Off
-		--printf("NET: SE Spell Icons abilityID: 0x%02x active: 0x%02x\n", abili=
tyID, active)
 	end
 =

 	--Speed Mode: 0x0 =3D Normal movement, 0x1 =3D Fast movement, 0x2 =3D Slo=
w movement, 0x3 and above =3D Hybrid movement
@@ -432,7 +438,7 @@
 	printdebug("net",sprintf("NET: Text id: 0x%08x model id: 0x%08x Message: =
%s\n",mobile_serial,text_item_model,text_message) )
 	local plaintext =3D string.gsub(text_message,"<br>","\n")
 	plaintext =3D UnicodeFix(plaintext)
-	AddFadeLines(sprintf("%s: %s",text_charname,plaintext)) -- TODO : color,f=
ont,...
+	GuiAddChatLine(sprintf("%s: %s",text_charname,plaintext)) -- TODO : color=
,font,...
 	JournalAddText(text_charname,plaintext)
 	NotifyListener("Hook_Text",text_charname,plaintext)
 	=

@@ -484,9 +490,9 @@
 	=

 	if show_below then
 		if string.len(text_charname) > 0 then =

-			AddFadeLines(sprintf("%s: %s",text_charname,plaintext)) -- TODO : color=
,font,...
+			GuiAddChatLine(sprintf("%s: %s",text_charname,plaintext)) -- TODO : col=
or,font,...
 		else
-			AddFadeLines(plaintext) -- TODO : color,font,...
+			GuiAddChatLine(plaintext) -- TODO : color,font,...
 		end
 	end
 	=

@@ -549,7 +555,7 @@
 	printdebug("net",sprintf("NET: UnicodeText speakerid: %i name: %s txtsize=
: %i msg: %s\n",mobile_serial,unitext_name,(unitext_size-48)/2,unitext_mess=
age) )
 =

 	if show_below then =

-		AddFadeLines(unitext_name..": "..string.gsub(unitext_message,"<br>","\n"=
),{r,g,b,1}) -- TODO : unicode
+		GuiAddChatLine(unitext_name..": "..string.gsub(unitext_message,"<br>","\=
n"),{r,g,b,1}) -- TODO : unicode
 	end
 	if show_journal then
 		JournalAddText(unitext_name,unitext_message)



From no-reply at zwischenwelt.org  Tue Jul  8 10:54:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 08 Jul 2008 08:54:34 -0000
Subject: [Iris-commit] [IRIS] r2293 - /trunk/lua/gui/gui.chat.lua
Message-ID: <20080708085435.195A91524030@zwischenwelt.org>

Author: hagish
Date: Tue Jul  8 10:54:34 2008
New Revision: 2293

Log:
forgot to add file

Added:
    trunk/lua/gui/gui.chat.lua



From no-reply at zwischenwelt.org  Thu Jul 10 00:11:01 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 09 Jul 2008 22:11:01 -0000
Subject: [Iris-commit] [IRIS] r2294 - in /trunk/bin: iris2.exe plugins.cfg
Message-ID: <20080709221101.CBF951C1852E@zwischenwelt.org>

Author: sience
Date: Thu Jul 10 00:11:01 2008
New Revision: 2294

Log:
-new win32 binary
-opengl activated again for win32

Modified:
    trunk/bin/iris2.exe
    trunk/bin/plugins.cfg

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/plugins.cfg
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/bin/plugins.cfg (original)
+++ trunk/bin/plugins.cfg Thu Jul 10 00:11:01 2008
@@ -5,7 +5,7 @@
 =

 # Define plugins
 Plugin=3DRenderSystem_Direct3D9
-#Plugin=3DRenderSystem_GL
+Plugin=3DRenderSystem_GL
 Plugin=3DPlugin_ParticleFX
 #Plugin=3DPlugin_BSPSceneManager
 #Plugin=3DPlugin_OctreeSceneManager



From no-reply at zwischenwelt.org  Sat Jul 12 01:50:18 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 11 Jul 2008 23:50:18 -0000
Subject: [Iris-commit] [IRIS] r2295 - in /trunk: lua/lib.unifont.lua
	widgets/widget.uotext.lua
Message-ID: <20080712000004.3B63F152403A@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Jul 12 01:50:18 2008
New Revision: 2295

Log:
uofont offset correction

Modified:
    trunk/lua/lib.unifont.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Sat Jul 12 01:50:18 2008
@@ -149,7 +149,7 @@
 		res.matname	=3D matname
 		res.xmove	=3D w - overlapx*s + xoff*s
 		res.xoff	=3D xoff
-		res.yoff	=3D yoff
+		res.yoff	=3D yoff - 1*self.defaultlineh
 		res.w	=3D w
 		res.h	=3D h
 		res.u0	=3D u0

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Sat Jul 12 01:50:18 2008
@@ -26,7 +26,7 @@
 	self:SetIgnoreHitTest(true)
 	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"),bParse=
HTML)
 	--~ self:SetPos(params.x,params.y)
-	local xoff,yoff =3D -1,-22
+	local xoff,yoff =3D -1,-2
 	self:SetLeftTop(params.x+xoff,params.y+yoff)
 	=

 	-- clip



From no-reply at zwischenwelt.org  Sat Jul 12 19:53:20 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 12 Jul 2008 17:53:20 -0000
Subject: [Iris-commit] [IRIS] r2296 - in /trunk/widgets:
 widget.gumpdialog.lua widget.uoimage.lua widget.uotext.lua
Message-ID: <20080712175321.0DEE11C18042@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Jul 12 19:53:20 2008
New Revision: 2296

Log:
uotext pos fixed, uoimage widget accepts change now

Modified:
    trunk/widgets/widget.gumpdialog.lua
    trunk/widgets/widget.uoimage.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.gumpdialog.lua (original)
+++ trunk/widgets/widget.gumpdialog.lua Sat Jul 12 19:53:20 2008
@@ -33,6 +33,8 @@
 		end
 	end
 end
+
+function gWidgetPrototype.GumpDialog:GetCtrlByName	(name) return self.cont=
rols[name] end -- see gumpparser
 =

 function gWidgetPrototype.GumpDialog:GetDialog	() return self end -- overr=
ide, normaly parent:GetDialog(), so this ends recursion
 =


Modified: trunk/widgets/widget.uoimage.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoimage.lua (original)
+++ trunk/widgets/widget.uoimage.lua Sat Jul 12 19:53:20 2008
@@ -11,37 +11,46 @@
 -- params : x,y,gump_id/art_id,width,height,hue=3D0,tiled=3Dfalse(strech),=
checker=3Dfalse(gray-transparent-background),multipart=3Dfalse(true for res=
izepic)
 -- either art_id or gump_id or checker is used
 function gWidgetPrototype.UOImage:Init 	(parentwidget, params)
+	local bVertexBufferDynamic,bVertexCol =3D false,false
+	local spritepanel =3D CreateSpritePanel(parentwidget:CastToRenderGroup2D(=
),nil,bVertexBufferDynamic,bVertexCol)
+	self:SetRenderGroup2D(spritepanel:CastToRenderGroup2D())
+	self:AddToDestroyList(spritepanel)
+	self.spritepanel =3D spritepanel	=

+	self.components =3D {}
+	self:SetParams(params)
+end
+
+function gWidgetPrototype.UOImage:SetParams 	(params)
+	-- clear components if it was multipart before
+	for k,child in pairs(self.components) do child:Destroy() end self.compone=
nts =3D {}
+	=

 	if (params.multipart) then =

-		self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGrou=
p2D())
-		self:SetRenderGroup2D(self.rendergroup2d)
-		self:AddToDestroyList(self.rendergroup2d)
-		self:SetIgnoreHitTest(true)
+		self.spritepanel:ClearGeometry()
 		local gump_id_base =3D params.gump_id
 		=

-		self.gfx_LT		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,tiled=3Dfalse,g=
ump_id=3Dgump_id_base+kBorderGumpIndexAdd.LT})
-		self.gfx_RB		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,tiled=3Dfalse,g=
ump_id=3Dgump_id_base+kBorderGumpIndexAdd.RB})
-		local w1,h1 =3D self.gfx_LT:GetOrigSize()
-		local w3,h3 =3D self.gfx_RB:GetOrigSize()
+		self.components.gfx_LT		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,tile=
d=3Dfalse,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.LT})
+		self.components.gfx_RB		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,tile=
d=3Dfalse,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.RB})
+		=

+		local w1,h1 =3D self.components.gfx_LT:GetOrigSize()
+		local w3,h3 =3D self.components.gfx_RB:GetOrigSize()
 		local w2,h2 =3D params.width - w3 - w1,params.height - h3 - h1
 		local x1,y1 =3D 0,0
 		local x2,y2 =3D w1,h1
 		local x3,y3 =3D w1+w2,h1+h2
-		self.gfx_RB:SetPos(x3,y3)
+		self.components.gfx_RB:SetPos(x3,y3)
 		=

 		-- multiple child widgets for bitmasks, and because of different materia=
ls
 		-- skip_rows_from_top =3D 1 for middle : widget.gfx:SetUV()
 		=

-		self.gfx_T		=3D self:CreateChild("UOImage",{x=3Dx2,y=3Dy1,width=3Dw2,hei=
ght=3Dh1,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.T })
-		self.gfx_RT		=3D self:CreateChild("UOImage",{x=3Dx3,y=3Dy1,width=3Dw3,he=
ight=3Dh1,tiled=3Dfalse,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.RT})
+		self.components.gfx_T		=3D self:CreateChild("UOImage",{x=3Dx2,y=3Dy1,wid=
th=3Dw2,height=3Dh1,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd=
.T })
+		self.components.gfx_RT		=3D self:CreateChild("UOImage",{x=3Dx3,y=3Dy1,wi=
dth=3Dw3,height=3Dh1,tiled=3Dfalse,gump_id=3Dgump_id_base+kBorderGumpIndexA=
dd.RT})
 		=

-		self.gfx_L		=3D self:CreateChild("UOImage",{x=3Dx1,y=3Dy2,width=3Dw1,hei=
ght=3Dh2,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.L})
-		self.gfx_M		=3D self:CreateChild("UOImage",{x=3Dx2,y=3Dy2,width=3Dw2,hei=
ght=3Dh2,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.M ,skip_ro=
ws_from_top=3D1})
-		self.gfx_R		=3D self:CreateChild("UOImage",{x=3Dx3,y=3Dy2,width=3Dw3,hei=
ght=3Dh2,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.R})
+		self.components.gfx_L		=3D self:CreateChild("UOImage",{x=3Dx1,y=3Dy2,wid=
th=3Dw1,height=3Dh2,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd=
.L})
+		self.components.gfx_M		=3D self:CreateChild("UOImage",{x=3Dx2,y=3Dy2,wid=
th=3Dw2,height=3Dh2,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd=
.M ,skip_rows_from_top=3D1})
+		self.components.gfx_R		=3D self:CreateChild("UOImage",{x=3Dx3,y=3Dy2,wid=
th=3Dw3,height=3Dh2,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd=
.R})
 		                                                                =

-		self.gfx_LB		=3D self:CreateChild("UOImage",{x=3Dx1,y=3Dy3,width=3Dw1,he=
ight=3Dh3,tiled=3Dfalse,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.LB})
-		self.gfx_B		=3D self:CreateChild("UOImage",{x=3Dx2,y=3Dy3,width=3Dw2,hei=
ght=3Dh3,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd.B })
-		=

-	=

+		self.components.gfx_LB		=3D self:CreateChild("UOImage",{x=3Dx1,y=3Dy3,wi=
dth=3Dw1,height=3Dh3,tiled=3Dfalse,gump_id=3Dgump_id_base+kBorderGumpIndexA=
dd.LB})
+		self.components.gfx_B		=3D self:CreateChild("UOImage",{x=3Dx2,y=3Dy3,wid=
th=3Dw2,height=3Dh3,tiled=3Dtrue,gump_id=3Dgump_id_base+kBorderGumpIndexAdd=
.B })
 	else
 		local matname,u0,v0,uvw,uvh,origw,origh,bitmask
 		if (params.gump_id	) then matname,u0,v0,uvw,uvh,origw,origh,bitmask =3D =
LoadGump(	"guibasemat",params.gump_id			,params.hue) end
@@ -64,12 +73,7 @@
 		local gfxparam_init	=3D matname and (	(params.tiled) and
 											MakeSpritePanelParam_TiledSingleSprite(	matname,w,h,0,0, u0,v0,=
uvw,uvh, 1,1, origw,origh) or
 											MakeSpritePanelParam_SingleSprite(		matname,w,h,0,0, u0,v0,uvw,=
uvh))
-		=

-		local bVertexBufferDynamic,bVertexCol =3D false,false
-		local spritepanel =3D CreateSpritePanel(parentwidget:CastToRenderGroup2D=
(),gfxparam_init,bVertexBufferDynamic,bVertexCol)
-		self:SetRenderGroup2D(spritepanel:CastToRenderGroup2D())
-		self:AddToDestroyList(spritepanel) -- don't add spritelist here, will be=
 destroyed in spritepanel destructor
-		self.spritepanel =3D spritepanel
+		if (gfxparam_init) then self.spritepanel:Update(gfxparam_init) end
 		if (bitmask) then self:SetBitMask(bitmask) end
 	end
 	self.params =3D params

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Sat Jul 12 19:53:20 2008
@@ -27,7 +27,7 @@
 	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"),bParse=
HTML)
 	--~ self:SetPos(params.x,params.y)
 	local xoff,yoff =3D -1,-2
-	self:SetLeftTop(params.x+xoff,params.y+yoff)
+	self:SetPos(params.x+xoff,params.y+yoff)
 	=

 	-- clip
 	-- { checkertrans 30 81 290 162 }



From no-reply at zwischenwelt.org  Sat Jul 12 22:55:18 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 12 Jul 2008 20:55:18 -0000
Subject: [Iris-commit] [IRIS] r2297 - in /trunk: lua/ lua/gui/ lua/obj/
	plugins/ widgets/
Message-ID: <20080712205518.E33851C180E2@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Jul 12 22:55:17 2008
New Revision: 2297

Log:
gui.healthbar.lua ported to new gui system. uoimage : change params helper,=
 IsWarModeActive helper, kHealthBarGump_ constants

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/obj/obj.player.lua
    trunk/plugins/hudenemylist.lua
    trunk/widgets/widget.gumpdialog.lua
    trunk/widgets/widget.uoimage.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sat Jul 12 22:55:17 2008
@@ -56,9 +56,20 @@
 		profiler:Finish()
 		profiler:PrintTotalTime()
 	end
-		=

-	local testgump,x,y,kDebugName =3D kGumpSample_VM_ChatMenu,0,300,"kGumpSam=
ple_RuneBook2"
-	local d2 =3D GumpParser_New(testgump,false) d2:SetPos(x,y) d2.sDebugName =
=3D kDebugName
+	=

+	if (1 =3D=3D 1) then
+		gPlayerBodySerial =3D 123
+		local dialog =3D GumpParser_New(kClientSideGump_HealthBar_Own,true)
+		gHealthbarDialogs[gPlayerBodySerial] =3D dialog
+		dialog.SendClose =3D function (self) end
+		=

+		SetHitpoints(0.3)
+		SetMana		(0.5)
+		SetStamina	(0.7)
+		gActWarmode =3D gWarmode_Combat
+		StatBar_UpdateMobileFlags({serial=3DgPlayerBodySerial,flag=3DkMobileFlag=
_Poisoned})
+		HealthBarSetWarMode()
+	end
 	=

 	=

 	--~ local dialog =3D GumpParser_New(kClientSideGump_Paperdoll_Own,true) d=
ialog:SetLeftTop(400,100)

Modified: trunk/lua/gui/gui.healthbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.healthbar.lua (original)
+++ trunk/lua/gui/gui.healthbar.lua Sat Jul 12 22:55:17 2008
@@ -5,12 +5,8 @@
 healthbarGump.x =3D 0
 healthbarGump.y =3D 0
 =

-kStatBar_BarRed		=3D 2053
-kStatBar_BarBlue	=3D 2054
-kStatBar_BarGreen	=3D 2056
-kStatBar_BarGolden	=3D 2057
  =

---~ healthbarGump.bSupportsGuiSys2 =3D true
+healthbarGump.bSupportsGuiSys2 =3D true
 healthbarGump.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2051 healthbar }" ..
@@ -27,6 +23,7 @@
 -- Created 09.03.2008 16:52:23, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local npchealthGump =3D {}
+npchealthGump.bSupportsGuiSys2 =3D true
 npchealthGump.dialogId =3D 2000002
 npchealthGump.x =3D 0
 npchealthGump.y =3D 60
@@ -47,107 +44,38 @@
 -- list of all open stats dialogs serial->dialog
 gHealthbarDialogs =3D {}
 =

--- sets the current stats bar in %, dont use this directly
-local function SetStatsBar(name,x)
-	-- only if status dialog available
-	if gHealthbarDialogs[gPlayerBodySerial] then
-		-- find player status dialog
-		local dialog =3D gHealthbarDialogs[gPlayerBodySerial]
-		-- TODO : ugly, because the image is shrinked, anjust uvmap or use clipp=
ing
-		local w =3D 109	--fixed because "w" can't be changed and mul with %
-		local h =3D dialog.controls and dialog.controls[name].gfx:GetHeight()
-		if (x > 1.0) then
-			x =3D 1.0
-		elseif (x < 0.0) then
-			x =3D 0.0
-		end
-		if (dialog.controls) then dialog.controls[name].gfx:SetDimensions(w*x,h)=
 end
-	end
+--- sets the hitpoints in percentage if the mobile npc dialog is opened
+function SetNpcHealthbarHitpoints (mobile, hitpoints) HealthBar_ChangePara=
ms(mobile.serial,"hitsbar",{tiled=3Dtrue,width=3DkHealthBarGump_FullWidth *=
 max(0,min(1,hitpoints))}) end
+
+function HealthBar_SetPlayerBar	(name,x) HealthBar_ChangeParams(gPlayerBod=
ySerial,name,{tiled=3Dtrue,width=3DkHealthBarGump_FullWidth * max(0,min(1,x=
))}) end
+
+-- sets the current hitpoints (in %), x is between 0.0 and 1.0
+function SetHitpoints	(x) HealthBar_SetPlayerBar("hitsbar",x) end
+function SetMana		(x) HealthBar_SetPlayerBar("manabar",x) end
+function SetStamina		(x) HealthBar_SetPlayerBar("stambar",x) end
+
+
+function HealthBar_ChangeBackground (serial,back_gump_id,hue) HealthBar_Ch=
angeParams(serial,"healthbar",{gump_id=3Dback_gump_id,hue=3Dhue}) end
+
+function HealthBar_ChangeParams (serial,ctrlname,changearr) =

+	local dialog =3D gHealthbarDialogs[serial] if (not dialog) then return end
+	local widget =3D dialog:GetCtrlByName(ctrlname) if (not widget) then retu=
rn end
+	widget:ChangeParams(changearr)
 end
 =

 -- color healthbar for poison/golden effect, called from mobile:UpdateFlag=
s()
 function StatBar_UpdateMobileFlags (mobile)
-	local dialog =3D gHealthbarDialogs[mobile.serial]
-	if (not dialog) then return end
 	local bPoisoned	=3D TestBit(mobile.flag,kMobileFlag_Poisoned) =

 	local bGolden	=3D TestBit(mobile.flag,kMobileFlag_GoldenHealth) =

-	local iGumpID =3D kStatBar_BarBlue
-	local hueid =3D 0
-	if (bPoisoned)	then iGumpID =3D kStatBar_BarGreen end
-	if (bGolden)	then iGumpID =3D kStatBar_BarGolden end
-	local mat =3D GetGumpMat(iGumpID,hueid)
-	local widget =3D dialog.controls["hitsbar"]
-	widget.gfx:SetMaterial(mat)
-
-	--[[ =

-	gui.gumpparser.lua:148:function GumpParser(Gumpdata, Clientsidemode)
-	{ gumppic 35 38 2054 hitsbar }
-	 { gumppic 35 11 2054 hitsbar }
-	 -- MakeBorderGumpPart( curparent, bToken[4], bToken[2], bToken[3], 0, 0,=
 0, tonumber(huenumber) )
-	local mat =3D GetGumpMat(iGumpID,hueid)
-	function gMobilePrototype:UpdateHealth (curvalue,maxvalue)
-			gCurrentRenderer:NotifyHPChange(self.serial, old, curvalue)
-			self.stats.curHits =3D curvalue
-			self.stats.maxHits =3D maxvalue
-			self:NotifyListener("Mobile_UpdateStats")
-		mobile:UpdateFlags
-			SetHitpoints(self.stats.curHits/self.stats.maxHits)
-			SetNpcHealthbarHitpoints(self, self.stats.curHits / self.stats.maxHits)
-	]]--
-end
-
--- sets the current hitpoints (in %), x is between 0.0 and 1.0
-function SetHitpoints (x)
-	SetStatsBar("hitsbar",x)
-end
-
--- sets the current hitpoints (in %), x is between 0.0 and 1.0
-function SetMana (x)
-	SetStatsBar("manabar",x)
-end
-
--- sets the current hitpoints (in %), x is between 0.0 and 1.0
-function SetStamina (x)
-	SetStatsBar("stambar",x)
+	local iGumpID =3D kHealthBarGump_Bar_Blue
+	if (bPoisoned)	then iGumpID =3D kHealthBarGump_Bar_Green end
+	if (bGolden)	then iGumpID =3D kHealthBarGump_Bar_Golden end
+	HealthBar_ChangeParams(mobile.serial,"hitsbar",{hue=3D0,gump_id=3DiGumpID=
})
 end
 =

 -- sets the warmode visual on statsbar
-function SetWarmode (warmode)
-	-- only if status dialog available
-	if gHealthbarDialogs[gPlayerBodySerial] then
-		-- find player status dialog
-		local dialog =3D gHealthbarDialogs[gPlayerBodySerial]
+function HealthBarSetWarMode () HealthBar_ChangeBackground(gPlayerBodySeri=
al,IsWarModeActive() and kHealthBarGump_Background_Warmode or kHealthBarGum=
p_Background_Normal) end
 =

-		local widget =3D dialog.controls and dialog.controls["healthbar"]
-		if (widget) then
-			local mat =3D GetGumpMat(warmode =3D=3D gWarmode_Normal and gWargump_No=
rmal or gWargump_Combat)
-			widget.mat_over =3D mat
-			widget.mat_normal =3D mat
-			widget.mat_pressed =3D mat
-			widget.gfx:SetMaterial(mat)
-		end
-	end
-end
-
---- sets the hitpoints in percentage if the mobile npc dialog is opened
-function SetNpcHealthbarHitpoints (mobile, hitpoints)
-	if mobile and gHealthbarDialogs[mobile.serial] then
-		-- get dialog and data
-		local dialog =3D gHealthbarDialogs[mobile.serial]
-		local x =3D hitpoints
-		local w =3D 109	--fixed because "w" can't be changed and mul with %
-		local h =3D dialog.controls["hitsbar"].gfx:GetHeight()
-
-		-- limit the percentage value
-		if (x > 1.0) then
-			x =3D 1.0
-		elseif (x < 0.0) then
-			x =3D 0.0
-		end
-		-- and resize the bar
-		dialog.controls["hitsbar"].gfx:SetDimensions(w*x,h)
-	end
-end
 =

 -- removes all this fancy gui stuff :)
 function RemoveAllHealthbars ()
@@ -208,65 +136,46 @@
 		if x =3D=3D nil or y =3D=3D nil then x =3D 0 y =3D 0 end
 	end
 	=

-	if (gHealthbarDialogs[mobile.serial]) then =

-		-- only update position
-		local d =3D gHealthbarDialogs[mobile.serial]
-		if d and d.rootwidget and d.rootwidget.gfx then
-			d.rootwidget.gfx:SetPos(x, y)
-		end
-		return
-	end -- already open =

+	local d =3D gHealthbarDialogs[mobile.serial]
+	if (d) then d:SetPos(x, y) return end -- already open, only update positi=
on
 	=

 	local dialog =3D GumpParser( IsPlayerMobile(mobile) and healthbarGump or =
npchealthGump, true )
+	gHealthbarDialogs[mobile.serial] =3D dialog
 =

 	-- save mobile info to dialog
 	dialog.mobile =3D mobile
 =

 	-- overwrite the dialog close function from gumpparser
-	dialog.Close =3D function (dialog)
-					CloseHealthbar(dialog.mobile)
-				   end
+	dialog.SendClose =3D function (self) CloseHealthbar(self.mobile) end
 	-- overwrite the onMouseDown function from gumpparser
-	dialog.on_mouse_left_down =3D function ()
-		dialog:BringToFront() =

+	dialog.on_mouse_left_down =3D function (self)
+		self:BringToFront() =

 		if IsTargetModeActive() then =

-			CompleteTargetModeWithTargetMobile(mobile) =

+			CompleteTargetModeWithTargetMobile(self.mobile) =

 		else =

-			-- not needed because it get called already
-			-- gui.StartMoveDialog(dialog.rootwidget) =

+			self:StartMouseMove()
 		end =

 	end
-	dialog.on_mouse_right_down =3D function ()
-		dialog:Close()
-	end
-	dialog.on_mouse_left_click_double =3D function ()
-		if (gActWarmode =3D=3D gWarmode_Combat) then
-			Send_AttackReq(mobile.serial)
+	dialog.on_mouse_left_click_double =3D function (self)
+		if (IsWarModeActive()) then
+			Send_AttackReq(self.mobile.serial)
 		else
-			Send_DoubleClick(mobile.serial)
+			Send_DoubleClick(self.mobile.serial)
 		end
 	end
 =

-	local r,g,b =3D GetNotorietyColor(mobile.notoriety)
-
 	if not(IsPlayerMobile(mobile)) then
-		dialog.controls["npcname"].gfx:SetCharHeight(gFontDefs["Gump"].size)
-		dialog.controls["npcname"].gfx:SetColour({r,g,b,1.0})
-		dialog.controls["npcname"].gfx:SetFont(gFontDefs["Gump"].name)
-		dialog.controls["npcname"].gfx:SetText(mobile.name or "unknown")
+		dialog:GetCtrlByName("npcname"):SetUOHtml(mobile.name or "unknown",false)
+		--~ HealthBar_ChangeBackground(mobile.serial,kHealthBarGump_Background_N=
ameEntry,GetNotorietyHueID(mobile.notoriety)) -- GetNotorietyColor
 	end
-
-	gHealthbarDialogs[mobile.serial] =3D dialog
 =

 	-- store mobile serial for item drop
 	dialog.dropOnMobileSerial =3D mobile.serial
 	=

-	if x and y then
-		if dialog.rootwidget and dialog.rootwidget.gfx then dialog.rootwidget.gf=
x:SetPos(x,y) end
-	end
+	if x and y then dialog:SetPos(x,y) end
 	=

 	-- if this was the player status bar, also show warmode
-	if IsPlayerMobile(mobile) then SetWarmode(gActWarmode) end	=

+	if IsPlayerMobile(mobile) then HealthBarSetWarMode() end	=

 	=

 	NotifyListener("Hook_OpenHealthbar",dialog, mobile.serial)
 end

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Sat Jul 12 22:55:17 2008
@@ -59,7 +59,7 @@
  -- peace
  [7]	=3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 1) then
-				if (gActWarmode=3D=3DgWarmode_Normal) then
+				if (IsWarModeActive()) then
 					Send_CombatMode(gWarmode_Combat)
 					widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
 					widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
@@ -313,7 +313,7 @@
 	end
 =

 	-- visually change the Peace/Warmode Button when opening the Paperdoll wh=
en in combat mode
-	if (gActWarmode=3D=3DgWarmode_Combat) then
+	if (IsWarModeActive()) then
 		local widget =3D dialog.controls["btnpeace"]
 		if (widget) then
 			widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Jul 12 22:55:17 2008
@@ -42,7 +42,7 @@
 function MacroCmd_SelectNearestMobile	()		if (gInGameStarted) then SelectN=
earestMobile() end end
 function MacroCmd_SelectNextMobile		()		if (gInGameStarted) then SelectNex=
tMobile() end end
 function MacroCmd_AttackSelectedMobile	()		if (gInGameStarted) then if giS=
electedMobile then AttackMobile(giSelectedMobile) end end end
-function MacroCmd_ToggleWarmode			()		if (gInGameStarted) then Send_Combat=
Mode((gActWarmode=3D=3DgWarmode_Normal) and gWarmode_Combat or gWarmode_Nor=
mal) end end
+function MacroCmd_ToggleWarmode			()		if (gInGameStarted) then Send_Combat=
Mode(IsWarModeActive() and gWarmode_Normal or gWarmode_Combat) end end
 function MacroCmd_Open					(dialogtype)
 	if (not gInGameStarted) then return end
 	local f =3D gMacroOpenCommands[dialogtype] =

@@ -410,7 +410,7 @@
 				SetAutoWalkTo(dx,dy)
 				]]
 				=

-				if (gActWarmode =3D=3D gWarmode_Combat) then
+				if (IsWarModeActive()) then
 					if not reqsend then
 						print("REQUEST SEND")
 						Send_AttackReq(gAttackMobile)

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Sat Jul 12 22:55:17 2008
@@ -35,13 +35,13 @@
 		local pm =3D GetPlayerMobile()
 		local othermobile =3D gMobiles[iSerial]
 		=

-		if (gActWarmode =3D=3D gWarmode_Normal or (pm and iSerial =3D=3D pm.seri=
al) or not othermobile) then
+		if ((not IsWarModeActive()) or (pm and iSerial =3D=3D pm.serial) or not =
othermobile) then
 			if (iSerial and iSerial ~=3D 0) then
 				printdebug("net",sprintf("IrisDoubleClick: serial=3D0x%08x\n",iSerial))
 				Send_DoubleClick(iSerial)
 			end
 		end
-		if (gActWarmode =3D=3D gWarmode_Combat) then
+		if (IsWarModeActive()) then
 			if (iSerial and iSerial ~=3D 0) then
 				printdebug("net",sprintf("IrisDoubleClickAttack: serial=3D0x%08x\n",iS=
erial))
 				Send_AttackReq(iSerial)

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sat Jul 12 22:55:17 2008
@@ -44,8 +44,14 @@
 gWarmode_Combat	=3D 1	-- 0x01
 =

 --Warmode Status_Bar GumpIDs
-gWargump_Normal	=3D hex2num("0x803")
-gWargump_Combat	=3D hex2num("0x807")
+kHealthBarGump_Background_Normal	=3D 0x803
+kHealthBarGump_Background_NameEntry	=3D 0x804 -- top:big text field, botto=
m : health, for npcs
+kHealthBarGump_Bar_Red				=3D 0x805
+kHealthBarGump_Bar_Blue				=3D 0x806
+kHealthBarGump_Background_Warmode	=3D 0x807
+kHealthBarGump_Bar_Green			=3D 0x808
+kHealthBarGump_Bar_Golden			=3D 0x809
+kHealthBarGump_FullWidth 			=3D 109
 =

 --Walk Limits
 --gPersonHeight =3D 16

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Sat Jul 12 22:55:17 2008
@@ -72,6 +72,7 @@
 	end
 end
 =

+function IsWarModeActive () return gActWarmode =3D=3D gWarmode_Combat end
 =

 -- TODO : move to obj.player.lua ?
 -- called from kPacket_SetPlayerWarmode
@@ -88,7 +89,7 @@
 		JournalAddText("","You go into War!")
 		--printf("NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: combat\n",i=
d)
 	end
-	SetWarmode(gActWarmode)
+	HealthBarSetWarMode()
 end
 =

 =


Modified: trunk/plugins/hudenemylist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/hudenemylist.lua (original)
+++ trunk/plugins/hudenemylist.lua Sat Jul 12 22:55:17 2008
@@ -85,7 +85,7 @@
 		OpenHealthbarAtMouse(body)
 	end
 	bar.widget_bg.on_mouse_left_click_double =3D function ()
-		if (gActWarmode =3D=3D gWarmode_Combat) then
+		if (IsWarModeActive()) then
 			Send_AttackReq(body.serial)
 		else
 			Send_DoubleClick(body.serial)

Modified: trunk/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.gumpdialog.lua (original)
+++ trunk/widgets/widget.gumpdialog.lua Sat Jul 12 22:55:17 2008
@@ -55,6 +55,7 @@
 function gWidgetPrototype.GumpDialog:on_mouse_right_down	() self:SendClose=
(0) end
 =

 function gWidgetPrototype.GumpDialog:SendClose	(return_value)
+	if (self.bClientSideMode) then return end
 	-- old : CloseServerSideGump(self.Gumpdata.playerid, self.dialogId,return=
_value)
 	-- old : ServerSideGump_GetParams
 	local params =3D {}

Modified: trunk/widgets/widget.uoimage.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoimage.lua (original)
+++ trunk/widgets/widget.uoimage.lua Sat Jul 12 22:55:17 2008
@@ -20,6 +20,12 @@
 	self:SetParams(params)
 end
 =

+function gWidgetPrototype.UOImage:ChangeParams 	(changearr) =

+	local params =3D self:GetParams()
+	for k,v in pairs(changearr) do params[k] =3D v end
+	self:SetParams(params)
+end
+function gWidgetPrototype.UOImage:GetParams 	() return self.params end
 function gWidgetPrototype.UOImage:SetParams 	(params)
 	-- clear components if it was multipart before
 	for k,child in pairs(self.components) do child:Destroy() end self.compone=
nts =3D {}



From no-reply at zwischenwelt.org  Sat Jul 12 23:01:43 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 12 Jul 2008 21:01:43 -0000
Subject: [Iris-commit] [IRIS] r2298 - /trunk/lua/lib.desktop.lua
Message-ID: <20080712210143.748501C180E2@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Jul 12 23:01:43 2008
New Revision: 2298

Log:
desktop_remember_dialog_pos code fixed for healthbar widget in guisys2

Modified:
    trunk/lua/lib.desktop.lua

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Sat Jul 12 23:01:43 2008
@@ -77,13 +77,13 @@
 	checkpos =3D function(e, widget) =

 		local d =3D widget.dialog
 		local p =3D gHealthbarDialogs[e.param]
-		if p and d and p =3D=3D d then e.x,e.y =3D widget.gfx:GetPos() return tr=
ue end
+		if p and d and p =3D=3D d then e.x,e.y =3D widget:GetPos() return true e=
nd
 	end,
 }
 RegisterListener("Hook_CloseHealthbar",function(dialog,serial) RemoveDeskt=
opElement("healthbar",serial) SaveDesktop() end)
 RegisterListener("Hook_OpenHealthbar",function(dialog,serial) =

 	if dialog and dialog.rootwidget and dialog.rootwidget.gfx then
-		local x,y =3D dialog.rootwidget.gfx:GetPos()
+		local x,y =3D dialog:GetPos()
 		ReplaceDesktopElement("healthbar",x,y,serial) 	=

 		SaveDesktop()
 	end
@@ -227,7 +227,7 @@
 	ReplaceDesktopElementIn(name,x,y,param,gDesktopPositions)
 end
 =

-RegisterListener("Gui_StopMoveDialog",function(widget,x,y)
+RegisterListener("Gui_StopMouseMoveWidget",function(widget,x,y) -- new gui=
 system
 	for k,v in pairs(gDesktop) do
 		if gDesktopElementFactory[v.name] and gDesktopElementFactory[v.name].che=
ckpos then
 			if gDesktopElementFactory[v.name].checkpos(v,widget) then =

@@ -238,6 +238,17 @@
 	end
 end)
 =

+RegisterListener("Gui_StopMoveDialog",function(widget,x,y) -- old gui syst=
em
+	for k,v in pairs(gDesktop) do
+		if gDesktopElementFactory[v.name] and gDesktopElementFactory[v.name].che=
ckpos then
+			if gDesktopElementFactory[v.name].checkpos(v,widget) then =

+				ReplaceDesktopElementIn(v.name,x,y,v.param,gDesktopPositions)
+				SaveDesktop() =

+			end
+		end
+	end
+end)
+
 RegisterListener("Hook_StartInGame",function() =

 	gSelectedShardName =3D gSelectedShardName or "unknown"
 	gSelectedCharName =3D gSelectedCharName or "unknown"



From no-reply at zwischenwelt.org  Sun Jul 13 00:56:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 12 Jul 2008 22:56:55 -0000
Subject: [Iris-commit] [IRIS] r2299 - in /trunk: lua/gui/gui.gumpparser.lua
 widgets/widget.gumpdialog.lua widgets/widget.uobutton.lua
 widgets/widget.uocheckbox.lua widgets/widget.uoradiobutton.lua
 widgets/widget.uotext.lua
Message-ID: <20080712225655.A2E321C180E2@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Jul 13 00:56:55 2008
New Revision: 2299

Log:
SetIgnoreHitTest to SetIgnoreBBoxHit

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/widgets/widget.gumpdialog.lua
    trunk/widgets/widget.uobutton.lua
    trunk/widgets/widget.uocheckbox.lua
    trunk/widgets/widget.uoradiobutton.lua
    trunk/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sun Jul 13 00:56:55 2008
@@ -57,7 +57,7 @@
 		profiler:PrintTotalTime()
 	end
 	=

-	if (1 =3D=3D 1) then
+	if (2 =3D=3D 1) then
 		gPlayerBodySerial =3D 123
 		local dialog =3D GumpParser_New(kClientSideGump_HealthBar_Own,true)
 		gHealthbarDialogs[gPlayerBodySerial] =3D dialog
@@ -71,6 +71,8 @@
 		HealthBarSetWarMode()
 	end
 	=

+	local testgump,x,y,kDebugName =3D kGumpSample_VM_ChatMenu,0,300,"kGumpSam=
ple_RuneBook2"
+	local d2 =3D GumpParser_New(testgump,false) -- d2:SetPos(x,y) d2.sDebugNa=
me =3D kDebugName
 	=

 	--~ local dialog =3D GumpParser_New(kClientSideGump_Paperdoll_Own,true) d=
ialog:SetLeftTop(400,100)
 	--~ GumpParser(kClientSideGump_Paperdoll_Own,true)

Modified: trunk/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.gumpdialog.lua (original)
+++ trunk/widgets/widget.gumpdialog.lua Sun Jul 13 00:56:55 2008
@@ -10,7 +10,7 @@
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
-	self:SetIgnoreHitTest(true)
+	self:SetIgnoreBBoxHit(true)
 	=

 	self.params		=3D params
 	self.dialogId	=3D params.dialogId -- id/serial

Modified: trunk/widgets/widget.uobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uobutton.lua (original)
+++ trunk/widgets/widget.uobutton.lua Sun Jul 13 00:56:55 2008
@@ -9,7 +9,7 @@
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
-	self:SetIgnoreHitTest(true)
+	self:SetIgnoreBBoxHit(true)
 	=

 	self.params			=3D params
 	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_normal})

Modified: trunk/widgets/widget.uocheckbox.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uocheckbox.lua (original)
+++ trunk/widgets/widget.uocheckbox.lua Sun Jul 13 00:56:55 2008
@@ -12,7 +12,7 @@
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
-	self:SetIgnoreHitTest(true)
+	self:SetIgnoreBBoxHit(true)
 	=

 	=

 	self.params			=3D params

Modified: trunk/widgets/widget.uoradiobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uoradiobutton.lua (original)
+++ trunk/widgets/widget.uoradiobutton.lua Sun Jul 13 00:56:55 2008
@@ -12,7 +12,7 @@
 	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
 	self:SetRenderGroup2D(self.rendergroup2d)
 	self:AddToDestroyList(self.rendergroup2d)
-	self:SetIgnoreHitTest(true)
+	self:SetIgnoreBBoxHit(true)
 	=

 	self.groupnumber	=3D groupnumber
 	self.params			=3D params

Modified: trunk/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/widgets/widget.uotext.lua (original)
+++ trunk/widgets/widget.uotext.lua Sun Jul 13 00:56:55 2008
@@ -23,7 +23,7 @@
 	if (not params.crop) then params.autowrap_w =3D params.width end
 	local bParseHTML =3D params.html
 	gWidgetPrototype.Text.Init(self,parentwidget,params)
-	self:SetIgnoreHitTest(true)
+	self:SetIgnoreBBoxHit(true)
 	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"),bParse=
HTML)
 	--~ self:SetPos(params.x,params.y)
 	local xoff,yoff =3D -1,-2



From no-reply at zwischenwelt.org  Sun Jul 13 11:32:13 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 13 Jul 2008 09:32:13 -0000
Subject: [Iris-commit] [IRIS] r2300 - in /trunk: data/config.lua.dist
	lua/lib.uodragdrop.lua
Message-ID: <20080713093214.1CEA01C184AC@zwischenwelt.org>

Author: hagish
Date: Sun Jul 13 11:32:13 2008
New Revision: 2300

Log:
holding left shift while dropping an item into a container tries to stack t=
he item if there is already one the the dropped type in the container.
warning: if you want to split the amount of a stack using shift in the curr=
ent version you need to release the shift button prior to dropping the
item. otherwise you whould split and stack the amount.

Modified:
    trunk/data/config.lua.dist
    trunk/lua/lib.uodragdrop.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Sun Jul 13 11:32:13 2008
@@ -279,6 +279,7 @@
 gDebugCategories.player		=3D false
 gDebugCategories.equip		=3D false
 gDebugCategories.effect		=3D false
+gDebugCategories.dragdrop	=3D false
 =

 gLogPackets =3D false
 =


Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Sun Jul 13 11:32:13 2008
@@ -319,7 +319,7 @@
 	local dialog_under_mouse =3D GetDialogUnderMouse()
 	local x,y,z =3D 0,0,0
 	=

-	print("MouseUpUODragDrop",dialog_under_mouse,dialog_under_mouse and dialo=
g_under_mouse.debugname)
+	printdebug("dragdrop","MouseUpUODragDrop",dialog_under_mouse,dialog_under=
_mouse and dialog_under_mouse.debugname)
 	=

 	if (dialog_under_mouse) then
 		if (dialog_under_mouse.rootwidget) then
@@ -332,7 +332,7 @@
 	if (dialog_under_mouse and dialog_under_mouse.uoContainer) then
 		-- drop on container
 		local container =3D dialog_under_mouse.uoContainer
-		print("MouseUpUODragDrop: drop on container ",item.serial,item.amount,x,=
y,z,container.serial)
+		printdebug("dragdrop","MouseUpUODragDrop: drop on container ",item.seria=
l,item.amount,x,y,z,container.serial)
 		=

 		-- default target is container
 		local target =3D container.serial
@@ -362,6 +362,20 @@
 			]]--
 		end
 		=

+		-- stack items of same type in the container if shift is pressed
+		if (gKeyPressed[key_lshift] and container) then
+			printdebug("dragdrop","stack same items")
+			for k,i in pairs(container:GetContent()) do =

+				if =

+					i.serial ~=3D item.serial and =

+					i.artid =3D=3D item.artid and =

+					(not item.hue or i.hue =3D=3D item.hue) =

+				then
+					target =3D i.serial
+				end
+			end
+		end
+		=

 		Send_Drop_Object(item.serial,x,y,z,target)
 	elseif (dialog_under_mouse and dialog_under_mouse.dropOnMobileSerial) then
 		-- support drop of stuff onto dialogs
@@ -369,7 +383,7 @@
 	elseif (dialog_under_mouse and dialog_under_mouse.uoSecureTrade) then
 		-- drop on secure trade container
 		local mysectrade =3D dialog_under_mouse.uoSecureTrade
-		print("#### MouseUpUODragDrop: drop on secure trade container ",item.ser=
ial,item.amount,x,y,z,mysectrade.myContainerID)
+		printdebug("dragdrop","#### MouseUpUODragDrop: drop on secure trade cont=
ainer ",item.serial,item.amount,x,y,z,mysectrade.myContainerID)
 		=

 		-- default target is container
 		local target =3D mysectrade.myContainerID
@@ -383,15 +397,15 @@
 		local layer =3D GetPaperdollLayerFromTileType(iTileTypeID)
 		local mobileserial =3D paperdoll.mobileserial
 		local mobile =3D GetMobile(mobileserial)
-		print("MouseUpUODragDrop: drop on paperdoll ",item.serial,item.amount,iT=
ileTypeID,layer,paperdoll.mobileserial)
+		printdebug("dragdrop","MouseUpUODragDrop: drop on paperdoll ",item.seria=
l,item.amount,iTileTypeID,layer,paperdoll.mobileserial)
 		if (not layer) then
-			print("CompleteUODragDrop : item is not wearable",vardump(item))
+			printdebug("dragdrop","CompleteUODragDrop : item is not wearable",vardu=
mp(item))
 			CancelUODragDrop()
 		elseif (not mobile) then
-			print("CompleteUODragDrop : paperdoll mobile not found",vardump(item))
+			printdebug("dragdrop","CompleteUODragDrop : paperdoll mobile not found"=
,vardump(item))
 			CancelUODragDrop()
 		elseif (GetMobileEquipmentItem(mobile,layer)) then
-			print("CompleteUODragDrop : layer already full",vardump(item))
+			printdebug("dragdrop","CompleteUODragDrop : layer already full",vardump=
(item))
 			-- TODO : if layer is not empty, drop dragged item to backpack, take it=
em from layer to backpack, equip dragged item
 			-- NOTE : if layer is not empty and it's not possible to put item to ba=
ckpack -> check and solve this problem!
 			--		  (for now i added "or 0" for x and y to function "UODragDropToOldP=
osition()" )
@@ -406,7 +420,7 @@
 		local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
 		if (iSerial and iSerial ~=3D 0) then =

 			-- drop on mobile,dynamic etc =

-			print("MouseUpUODragDrop: drop on worlobject : ",item.serial,item.amoun=
t,x,y,z,iSerial)
+			printdebug("dragdrop","MouseUpUODragDrop: drop on worlobject : ",item.s=
erial,item.amount,x,y,z,iSerial)
 			Send_Drop_Object(item.serial,x,y,z,iSerial)
 		else
 			-- drop on world



From no-reply at zwischenwelt.org  Sun Jul 13 20:01:30 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 13 Jul 2008 18:01:30 -0000
Subject: [Iris-commit] [IRIS] r2301 - /tools/installer/Iris_Setup.iss
 /tools/updater/updater.vcproj /trunk/bin/iris2.exe
Message-ID: <20080713180130.8E6521C184AC@zwischenwelt.org>

Author: sience
Date: Sun Jul 13 20:01:29 2008
New Revision: 2301

Log:
-win32 binary updated
-some installer options updated

Modified:
    tools/installer/Iris_Setup.iss
    tools/updater/updater.vcproj
    trunk/bin/iris2.exe

Modified: tools/installer/Iris_Setup.iss
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- tools/installer/Iris_Setup.iss (original)
+++ tools/installer/Iris_Setup.iss Sun Jul 13 20:01:29 2008
@@ -63,6 +63,7 @@
 [Run]
 Filename: {app}\bin\{#UpdaterExeName}; WorkingDir: {app}\bin\; Flags: post=
install; Description: {cm:ConfigureIris}
 Filename: {app}\vcredist_x86.exe; WorkingDir: {app}; StatusMsg: Installing=
 Visual C++ 8 SP1 Runtime
+; maybe with Option vcredist_x86.exe /Q
 ; Flags: runhidden
 ;Filename: {app}\{#AppExeName}; Description: {cm:LaunchProgram,{#AppName}}=
; Flags: nowait postinstall skipifsilent
 =


Modified: tools/updater/updater.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- tools/updater/updater.vcproj (original)
+++ tools/updater/updater.vcproj Sun Jul 13 20:01:29 2008
@@ -118,7 +118,7 @@
 			/>
 			<Tool
 				Name=3D"VCCLCompilerTool"
-				AdditionalIncludeDirectories=3D"./;&quot;svn-win32-1.4.3\include&quot;=
;&quot;svn-win32-1.4.3\include\apr&quot;;&quot;svn-win32-1.4.3\include\apr-=
util&quot;;&quot;wxMSW-2.8.3\include\&quot;;&quot;wxMSW-2.8.3\include\msvc\=
&quot;;&quot;C:\Programme\Microsoft Platform SDK\Include\&quot;"
+				AdditionalIncludeDirectories=3D"&quot;$(INCLUDE)&quot;;./;&quot;svn-wi=
n32-1.4.3\include&quot;;&quot;svn-win32-1.4.3\include\apr&quot;;&quot;svn-w=
in32-1.4.3\include\apr-util&quot;;&quot;wxMSW-2.8.3\include\&quot;;&quot;wx=
MSW-2.8.3\include\msvc\&quot;;&quot;C:\Programme\Microsoft Platform SDK\Inc=
lude\&quot;"
 				PreprocessorDefinitions=3D"NDEBUG;WIN32;_WINDOWS;__WINDOWS__;__WXMSW__=
;__WIN95__;__WIN32__;WINVER=3D0x0400;STRICT"
 				RuntimeLibrary=3D"2"
 				UsePrecompiledHeader=3D"0"
@@ -131,7 +131,7 @@
 			/>
 			<Tool
 				Name=3D"VCResourceCompilerTool"
-				AdditionalIncludeDirectories=3D"&quot;wxMSW-2.8.3\include\&quot;;&quot=
;C:\Programme\Microsoft Platform SDK\Include\&quot;"
+				AdditionalIncludeDirectories=3D"&quot;$(INCLUDE)&quot;;&quot;wxMSW-2.8=
.3\include\&quot;;&quot;C:\Programme\Microsoft Platform SDK\Include\&quot;"
 			/>
 			<Tool
 				Name=3D"VCPreLinkEventTool"
@@ -141,7 +141,7 @@
 				AdditionalDependencies=3D"kernel32.lib user32.lib gdi32.lib winspool.l=
ib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib co=
mctl32.lib rpcrt4.lib wsock32.lib winmm.lib wxbase28.lib wxmsw28_core.lib w=
xpng.lib wxzlib.lib wxjpeg.lib wxtiff.lib wxmsw28_html.lib wxbase28_net.lib=
 wxmsw28_media.lib"
 				OutputFile=3D"$(SolutionDir)\$(ProjectName).exe"
 				LinkIncremental=3D"1"
-				AdditionalLibraryDirectories=3D"&quot;C:\Programme\Microsoft Platform =
SDK\Lib\&quot;;&quot;wxMSW-2.8.3\lib\vc_lib\&quot;;&quot;svn-win32-1.4.3\li=
b\apr\&quot;;&quot;svn-win32-1.4.3\lib\apr-util\&quot;;&quot;svn-win32-1.4.=
3\lib\&quot;;&quot;svn-win32-libintl\lib\&quot;;&quot;db4-win32-4.4.20\lib\=
&quot;;&quot;svn-win32-1.4.3\lib\neon\&quot;"
+				AdditionalLibraryDirectories=3D"&quot;$(LIB)&quot;;&quot;C:\Programme\=
Microsoft Platform SDK\Lib\&quot;;&quot;wxMSW-2.8.3\lib\vc_lib\&quot;;&quot=
;svn-win32-1.4.3\lib\apr\&quot;;&quot;svn-win32-1.4.3\lib\apr-util\&quot;;&=
quot;svn-win32-1.4.3\lib\&quot;;&quot;svn-win32-libintl\lib\&quot;;&quot;db=
4-win32-4.4.20\lib\&quot;;&quot;svn-win32-1.4.3\lib\neon\&quot;"
 				IgnoreAllDefaultLibraries=3D"false"
 				IgnoreDefaultLibraryNames=3D"LIBCMT.lib"
 				GenerateDebugInformation=3D"false"

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Fri Jul 18 00:25:21 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 17 Jul 2008 22:25:21 -0000
Subject: [Iris-commit] [IRIS] r2302 - /trunk/lua/lib.test.lua
Message-ID: <20080717222524.A81A91C180E6@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Jul 18 00:25:20 2008
New Revision: 2302

Log:
lib.test.lua, commented out BitwiseHexDumpTest, used method was obsoleted a=
nd removed

Modified:
    trunk/lua/lib.test.lua

Modified: trunk/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.test.lua (original)
+++ trunk/lua/lib.test.lua Fri Jul 18 00:25:20 2008
@@ -222,9 +222,10 @@
 function LuaBitwiseTest_FIFO (a)
 	local fifo =3D CreateFIFO()
 	fifo:PushNetUint32(hex2num(a))
-	if (gEnableBitwiseHexDumpTest) then
-		print("LuaBitwiseTest_FIFO : the following dump should contain "..a)
-		fifo:HexDump()
+	if (gEnableBitwiseHexDumpTest) then =

+		--~ print("LuaBitwiseTest_FIFO : the following dump should contain "..a)
+		--~ fifo:HexDump() -- no longer available, see FIFOHexDump
+		local hexdump =3D FIFOHexDump(fifo) -- todo . format convert from "ff aa=
 12 00 01 " to 0x123
 	end
 	local b =3D fifo:PopNetUint32()
 	if (sprintf("0x%08x",b) ~=3D a) then



From no-reply at zwischenwelt.org  Fri Jul 18 22:32:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 18 Jul 2008 20:32:06 -0000
Subject: [Iris-commit] [IRIS] r2303 - /trunk/bin/iris2.exe
Message-ID: <20080718203207.014451524030@zwischenwelt.org>

Author: sience
Date: Fri Jul 18 22:32:05 2008
New Revision: 2303

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Wed Jul 23 23:00:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 23 Jul 2008 21:00:08 -0000
Subject: [Iris-commit] [IRIS] r2305 - /trunk/data/base/scrollbar.png
Message-ID: <20080723210008.75FCE1C180A2@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Jul 23 23:00:08 2008
New Revision: 2305

Log:
updated scrollbar image

Modified:
    trunk/data/base/scrollbar.png

Modified: trunk/data/base/scrollbar.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Wed Jul 23 22:35:24 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 23 Jul 2008 20:35:24 -0000
Subject: [Iris-commit] [IRIS] r2304 - /trunk/data/base/scrollbar.png
Message-ID: <20080723210005.472521C180A1@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Jul 23 22:35:24 2008
New Revision: 2304

Log:
added scrollbar gfx

Added:
    trunk/data/base/scrollbar.png   (with props)



From no-reply at zwischenwelt.org  Thu Jul 24 02:41:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 24 Jul 2008 00:41:28 -0000
Subject: [Iris-commit] [IRIS] r2306 - /trunk/bin/iris2.exe
Message-ID: <20080724004128.A790F1C184A7@zwischenwelt.org>

Author: sience
Date: Thu Jul 24 02:41:28 2008
New Revision: 2306

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Thu Jul 24 02:51:56 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 24 Jul 2008 00:51:56 -0000
Subject: [Iris-commit] [IRIS] r2308 - /trunk/lua/net/net.login.lua
Message-ID: <20080724005156.A9D351C184A7@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul 24 02:51:56 2008
New Revision: 2308

Log:
login packet workaround for Tabris on Forgotten Lore shard (pol) : too many=
 cities

Modified:
    trunk/lua/net/net.login.lua

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Thu Jul 24 02:51:56 2008
@@ -160,6 +160,7 @@
 		charlist.citynumber =3D min(charlist.citynumber,iTransmittedCityNumber)
 	end
 	for i =3D 0,charlist.citynumber-1 do
+		iBytesLeft =3D iBytesLeft - iBytesPerCity
 		gCities[i] =3D {}
 		gCities[i].index=3Dinput:PopNetUint8()
 		gCities[i].name=3Dinput:PopFilledString(30)
@@ -172,8 +173,13 @@
 	charlist.cities =3D gCities
 =

 	-- TODO : Serverspecific handling for Revelation Emu
+	iBytesLeft =3D iBytesLeft - 4
 	charlist.flags =3D input:PopNetUint32()
 	printdebug("login",sprintf("ServerFlag: 0x%08x\n",charlist.flags))
+	if (iBytesLeft > 0) then =

+		print("kPacket_Character_List WARNING, bytes left, dumping",iBytesLeft)
+		input:PopRaw(iBytesLeft)
+	end
 =

 	--Flags list: =

 	--0x02 =3D send config/req logout (IGR?) =




From no-reply at zwischenwelt.org  Thu Jul 24 02:49:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 24 Jul 2008 00:49:11 -0000
Subject: [Iris-commit] [IRIS] r2307 - /trunk/lua/net/net.login.lua
Message-ID: <20080724004916.E4D2A1C183FE@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul 24 02:49:10 2008
New Revision: 2307

Log:
login packet workaround for Tabris on Forgotten Lore shard

Modified:
    trunk/lua/net/net.login.lua

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Thu Jul 24 02:49:10 2008
@@ -133,7 +133,9 @@
 	local id =3D input:PopNetUint8()
 	local charlist =3D {}
 	charlist.size =3D input:PopNetUint16()
+	local iBytesLeft =3D charlist.size - 3
 	charlist.charnumber =3D input:PopNetUint8()
+	iBytesLeft =3D iBytesLeft - 1
 =

 	--TODO: ?? check, because POL and Lonewolf sends current charnumber, not =
the number of slots
 =

@@ -143,12 +145,20 @@
 		gCharacterList[i] =3D {}
 		gCharacterList[i].name=3Dinput:PopFilledString(30)
 		gCharacterList[i].pw=3Dinput:PopFilledString(30)
+		iBytesLeft =3D iBytesLeft - 2*30
 		printdebug("login",sprintf("NET: CharacterID: %i Name: %s Password: %s\n=
",i,gCharacterList[i].name,gCharacterList[i].pw))
 	end
 	charlist.chars =3D gCharacterList
 	=

 	charlist.citynumber =3D input:PopNetUint8()
+	iBytesLeft =3D iBytesLeft - 1
 	printdebug("login",sprintf("NET: Citynumber: %d\n",charlist.citynumber))
+	local iBytesPerCity =3D 1+30+1+30+1
+	local iTransmittedCityNumber =3D math.floor((iBytesLeft - 4) / iBytesPerC=
ity)
+	if (iTransmittedCityNumber ~=3D charlist.citynumber) then
+		print("kPacket_Character_List WARNING : city number mismatch : num,real =
=3D ",charlist.citynumber,iTransmittedCityNumber)
+		charlist.citynumber =3D min(charlist.citynumber,iTransmittedCityNumber)
+	end
 	for i =3D 0,charlist.citynumber-1 do
 		gCities[i] =3D {}
 		gCities[i].index=3Dinput:PopNetUint8()



From no-reply at zwischenwelt.org  Thu Jul 24 03:30:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 24 Jul 2008 01:30:35 -0000
Subject: [Iris-commit] [IRIS] r2310 - /trunk/lua/net/net.login.lua
Message-ID: <20080724020008.379921C18016@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul 24 03:30:35 2008
New Revision: 2310

Log:
charcount =3D max(5,charcount), hope this fixes login problems on some pol =
servers

Modified:
    trunk/lua/net/net.login.lua

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Thu Jul 24 03:30:35 2008
@@ -145,6 +145,7 @@
 =

 	print("login:charlist:hexdump" )
 	print(FIFOHexDump(input,0,iBytesLeft))
+	charlist.charnumber =3D math.max(5,charlist.charnumber)
 	=

 	for i =3D 0, charlist.charnumber-1 do
 		gCharacterList[i] =3D {}



From no-reply at zwischenwelt.org  Thu Jul 24 03:14:20 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 24 Jul 2008 01:14:20 -0000
Subject: [Iris-commit] [IRIS] r2309 - /trunk/lua/net/net.login.lua
Message-ID: <20080724020007.8E9F41C1800F@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul 24 03:14:19 2008
New Revision: 2309

Log:
login packet debug (charlist)

Modified:
    trunk/lua/net/net.login.lua

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Thu Jul 24 03:14:19 2008
@@ -136,11 +136,16 @@
 	local iBytesLeft =3D charlist.size - 3
 	charlist.charnumber =3D input:PopNetUint8()
 	iBytesLeft =3D iBytesLeft - 1
+	=

+	=

 =

 	--TODO: ?? check, because POL and Lonewolf sends current charnumber, not =
the number of slots
 =

 	printdebug("login",sprintf("NET: character list: size=3D%d charlist.charn=
umber=3D%d\n",charlist.size,charlist.charnumber))
 =

+	print("login:charlist:hexdump" )
+	print(FIFOHexDump(input,0,iBytesLeft))
+	=

 	for i =3D 0, charlist.charnumber-1 do
 		gCharacterList[i] =3D {}
 		gCharacterList[i].name=3Dinput:PopFilledString(30)



From no-reply at zwischenwelt.org  Thu Jul 24 03:40:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 24 Jul 2008 01:40:19 -0000
Subject: [Iris-commit] [IRIS] r2311 - /trunk/lua/gui/gui.paperdoll.lua
Message-ID: <20080724020008.7589A1C18012@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul 24 03:40:18 2008
New Revision: 2311

Log:
paperdoll without mobile fix

Modified:
    trunk/lua/gui/gui.paperdoll.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Thu Jul 24 03:40:18 2008
@@ -332,7 +332,7 @@
 	end
 =

 	-- update paperdoll name and color
-	local r,g,b =3D GetNotorietyColor(paperdoll.mobile.notoriety)
+	local r,g,b =3D GetNotorietyColor(paperdoll.mobile and paperdoll.mobile.n=
otoriety or 0)
 	dialog.controls["paperdollname"].gfx:SetCharHeight(gFontDefs["Gump"].size=
 + 2)
 	dialog.controls["paperdollname"].gfx:SetColour( {r,g,b,1.0} )
 	dialog.controls["paperdollname"].gfx:SetFont(gFontDefs["Gump"].name)



From no-reply at zwischenwelt.org  Thu Jul 24 15:08:40 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 24 Jul 2008 13:08:40 -0000
Subject: [Iris-commit] [IRIS] r2312 - /trunk/lua/net/net.login.lua
Message-ID: <20080724130840.7C5171C18018@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Jul 24 15:08:39 2008
New Revision: 2312

Log:
prevent uname/pass output when using debug-login

Modified:
    trunk/lua/net/net.login.lua

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Thu Jul 24 15:08:39 2008
@@ -2,6 +2,7 @@
 -- see also lib.packet.lua and lib.protocol.lua
 =

 gTooltipSupport =3D false
+gPWReplace =3D "??????" -- prevent username/password appearing in debug du=
mp
 =

 -- TODO : write Set_ClientFeatures function !!
 function gPacketHandler.kPacket_Server_List () --0xa8 - Recieve Serverlist=
 from LoginServer
@@ -317,7 +318,7 @@
 -- send login server request 0x80
 -- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
 function Send_Account_Login_Request	(sName,sPassword,iSeed)
-	printdebug("login",sprintf("NET: Account_Login_Request: Name: %s Password=
: %s\n",sName,sPassword))
+	printdebug("login",sprintf("NET: Account_Login_Request: Name: %s Password=
: %s\n",gPWReplace or sName,gPWReplace or sPassword))
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Account_Login_Request)
 	out:PushFilledString(sName,30)
@@ -341,7 +342,7 @@
 -- something is wrong...runuo & wolfpack detects invalid client
 -- answered by kPacket_Features 0xB9 and  kPacket_Character_List 0xA9
 function Send_GameServer_PostLogin(sName,sPassword,iAccount)
-	printdebug("login",sprintf("NET: GameServer_PostLogin: Name: %s Password:=
 %s AccountNr.: 0x%08x\n",sName,sPassword,iAccount))
+	printdebug("login",sprintf("NET: GameServer_PostLogin: Name: %s Password:=
 %s AccountNr.: 0x%08x\n",gPWReplace or sName,gPWReplace or sPassword,iAcco=
unt))
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Post_Login)
 	out:PushNetUint32(iAccount)



From no-reply at zwischenwelt.org  Sun Jul 27 10:41:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 27 Jul 2008 08:41:06 -0000
Subject: [Iris-commit] [IRIS] r2313 - in /trunk: bin/iris2.exe
 data/config.lua.dist lua/lib.3d.renderer.lua lua/main.lua vc8/iris.vcproj
Message-ID: <20080727084106.511A61C18528@zwischenwelt.org>

Author: sience
Date: Sun Jul 27 10:41:05 2008
New Revision: 2313

Log:
-new caelum works (but not rotated yet), set gUseCaelumSkysystem =3D true i=
n config.lua

Modified:
    trunk/bin/iris2.exe
    trunk/data/config.lua.dist
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/main.lua
    trunk/vc8/iris.vcproj

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Sun Jul 27 10:41:05 2008
@@ -507,3 +507,5 @@
 gTileFreeWalkDiagonalOptimization =3D false
 =

 gUseStaticFallbacks =3D true
+
+gUseCaelumSkysystem =3D false

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Sun Jul 27 10:41:05 2008
@@ -113,48 +113,69 @@
 			if (gCaelumSystem) then return end
 =

 			-- if not create a new Skysystem
---			gCaelumSystem=3DCreateCaelumSystem()
-			gCaelumSystem=3DCreateCaelumSystem(CAELUM_COMPONENT_SKY_COLOUR_MODEL + =
CAELUM_COMPONENT_SKY_DOME + CAELUM_COMPONENT_SUN + CAELUM_COMPONENT_STARFIE=
LD)
-			gSunPositionmodel=3DCreateCaelumSimpleSunPositionModel(13)
-	=

-			-- Setup sun options.
+			gCaelumSystem =3D CreateCaelumCaelumSystem(
+				CAELUM_COMPONENT_SUN + =

+				CAELUM_COMPONENT_MOON +
+		        CAELUM_COMPONENT_SKY_DOME +
+		        CAELUM_COMPONENT_POINT_STARFIELD +
+		        CAELUM_COMPONENT_CLOUDS +
+		        CAELUM_COMPONENT_PRECIPITATION +
+		        0
+			)
+			=

+			gCaelumSystem:SetManageSceneFog(true)
+			gCaelumSystem:SetSceneFogDensityMultiplier(0.0015)
+			gCaelumSystem:SetManageAmbientLight(true)
+			=

 			local sun =3D gCaelumSystem:GetSun()
-			if (sun) then
-				sun:SetAmbientMultiplier(0.5, 0.5, 0.5, 1.0);
-				sun:SetDiffuseMultiplier(3.0, 3.0, 2.7, 1.0);
-				--For green terrain:
-				--sun:setDiffuseMultiplier(0.1, 3, 0.1);
-				sun:SetSpecularMultiplier(5.0, 5.0, 5.0, 1.0);
-				sun:SetSunPositionModel(gSunPositionmodel);
-				sun:SetManageAmbientLight (true);
+		    if sun then
+		    	print("SUN")
+		        sun:SetAmbientMultiplier(0.5, 0.5, 0.5, 1)
+		        sun:SetDiffuseMultiplier(3, 3, 2.7, 1)
+		        sun:SetSpecularMultiplier(5, 5, 5, 1)
+		        sun:SetAutoDisable(true)
+		        sun:SetAutoDisableThreshold(0.1)
+		    end
+		=

+			local moon =3D gCaelumSystem:GetMoon()
+		    if moon then
+		    	print("MOON")
+		        moon:SetAutoDisable(true)
+		        moon:SetAutoDisableThreshold(0.1)
+		    end
+		=

+			local clouds =3D gCaelumSystem:GetCloudSystem()
+		    if clouds then
+		    	print("CLOUDS")
+		        clouds:CreateLayerAtHeight(5000)
+		        clouds:GetLayer(0):SetCloudSpeed(0.000005, -0.000009)
+		        clouds:GetLayer(1):SetCloudSpeed(0.0000045, -0.0000085)
+		    end
+		=

+			local prec =3D gCaelumSystem:GetPrecipitationController()
+			if prec then
+		    	print("PREC")
+			    prec:SetCoverage(0)
+		    end
+		=

+		    -- Sunrise with visible moon.
+		    local cl =3D gCaelumSystem:GetUniversalClock()
+		    cl:SetGregorianDateTime(2007, 4, 9, 9, 33, 10)
+		    cl:SetTimeScale(512)
+--[[
+			function rotate(gfx,w,x,y,z)
+				local ww,xx,yy,zz =3D gfx:GetOrientation()
+				gfx:SetOrientation(Quaternion.Mul(w,x,y,z, ww,xx,yy,zz))
 			end
-	=

-			-- Setup fog options.
-			gCaelumSystem:SetManageSceneFog(true)
-			gCaelumSystem:SetSceneFogDensityMultiplier(0.02)
-	=

-			-- Setup cloud options.
-			-- Tweak these settings to make the demo look pretty.
---			local clouds=3DgCaelumSystem:GetClouds()
-			if (clouds) then
-				clouds:SetCloudSpeed(0.000005, -0.000009);
-				clouds:SetCloudBlendTime(3600 * 24);
-				clouds:SetCloudCover(0.3);
-			end
-	=

-			local starfield =3D gCaelumSystem:GetStarfield()
-			-- Setup starfield options
-			if (starfield) then
-				starfield:SetInclination(13);
-			end
-	=

-			local universalclock =3D gCaelumSystem:GetUniversalClock ()
-			if (universalclock) then
-				universalclock:SetTimeScale (512);
-				universalclock:SetCurrentTime (18000);	--Jan 1st, 5am
-			end
-
-			gCaelumSystem:AddAsListener()
+			=

+			local w,x,y,z =3D Quaternion.fromAngleAxis(90 * gfDeg2Rad, 0,0,1)
+			rotate(gCaelumSystem:GetCaelumGroundNode(), w,x,y,z)
+			rotate(gCaelumSystem:GetCaelumCameraNode(), w,x,y,z)
+			TurnCam(w,x,y,z)
+]]--
+--[[
+    		gCaelumSystem:AddAsListener()
+]]--
 		end
 	else
 		-- black background when underground

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Jul 27 10:41:05 2008
@@ -214,6 +214,8 @@
 	=

 	OgreAddResLoc(gUOPath..CorrectPath("Models/Maps")				,"FileSystem","Gener=
al")
 =

+	OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/caelum/resources"),=
"FileSystem","Caelum")
+
 	--~ OgreAddResLoc(kObjTypePreviewDir.."."			,"FileSystem","General")
 	OgreInitResLocs()
 end

Modified: trunk/vc8/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc8/iris.vcproj (original)
+++ trunk/vc8/iris.vcproj Sun Jul 27 10:41:05 2008
@@ -1078,6 +1078,10 @@
 						>
 					</File>
 					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\BrightStarCatalogue.cpp"
+						>
+					</File>
+					<File
 						RelativePath=3D"..\lugre\lib\caelum\src\CaelumPrecompiled.cpp"
 						>
 					</File>
@@ -1090,6 +1094,14 @@
 						>
 					</File>
 					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\CloudSystem.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\FlatCloudLayer.cpp"
+						>
+					</File>
+					<File
 						RelativePath=3D"..\lugre\lib\caelum\src\GeometryFactory.cpp"
 						>
 					</File>
@@ -1102,7 +1114,7 @@
 						>
 					</File>
 					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\LayeredClouds.cpp"
+						RelativePath=3D"..\lugre\lib\caelum\src\ImageStarfield.cpp"
 						>
 					</File>
 					<File
@@ -1110,7 +1122,11 @@
 						>
 					</File>
 					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\SkyColourModel.cpp"
+						RelativePath=3D"..\lugre\lib\caelum\src\PointStarfield.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\PrecipitationController.cpp"
 						>
 					</File>
 					<File
@@ -1119,14 +1135,6 @@
 					</File>
 					<File
 						RelativePath=3D"..\lugre\lib\caelum\src\SkyLight.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\SolarSystemModel.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\Starfield.cpp"
 						>
 					</File>
 					<File
@@ -1170,6 +1178,14 @@
 						>
 					</File>
 					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\CloudSystem.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\FlatCloudLayer.h"
+						>
+					</File>
+					<File
 						RelativePath=3D"..\lugre\lib\caelum\include\GeometryFactory.h"
 						>
 					</File>
@@ -1182,7 +1198,7 @@
 						>
 					</File>
 					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\LayeredClouds.h"
+						RelativePath=3D"..\lugre\lib\caelum\include\ImageStarfield.h"
 						>
 					</File>
 					<File
@@ -1190,7 +1206,11 @@
 						>
 					</File>
 					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\SkyColourModel.h"
+						RelativePath=3D"..\lugre\lib\caelum\include\PointStarfield.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\PrecipitationController.=
h"
 						>
 					</File>
 					<File
@@ -1199,14 +1219,6 @@
 					</File>
 					<File
 						RelativePath=3D"..\lugre\lib\caelum\include\SkyLight.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\SolarSystemModel.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\Starfield.h"
 						>
 					</File>
 					<File



From no-reply at zwischenwelt.org  Sun Jul 27 13:59:16 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 27 Jul 2008 11:59:16 -0000
Subject: [Iris-commit] [IRIS] r2314 - in /trunk: bin/ data/ lua/ lua/gui/
	lua/net/
Message-ID: <20080727115916.E95AA1524030@zwischenwelt.org>

Author: hagish
Date: Sun Jul 27 13:59:15 2008
New Revision: 2314

Log:
*caelum correctly rotated
*gShowLightDebug =3D true to show light positions
*aura on the ground around a mobile shows the health

Modified:
    trunk/bin/plugins_linux.cfg
    trunk/data/config.lua.dist
    trunk/lua/gui/gui.chat.lua
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/gui/gui.skill.lua
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.mobile.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/main.lua
    trunk/lua/net/net.login.lua

Modified: trunk/bin/plugins_linux.cfg
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/bin/plugins_linux.cfg (original)
+++ trunk/bin/plugins_linux.cfg Sun Jul 27 13:59:15 2008
@@ -1,19 +1,11 @@
-# Defines plugins to load
-
+# Defines plugins to load
+
 # Define plugin folder
 #PluginFolder=3D.
-PluginFolder=3D/usr/local/lib/OGRE =

-
-# Define plugins
-#Plugin=3DRenderSystem_Direct3D9
-#Plugin=3DRenderSystem_GL
-#Plugin=3DPlugin_ParticleFX
-#Plugin=3DPlugin_BSPSceneManager
-#Plugin=3DPlugin_OctreeSceneManager
-#Plugin=3DPlugin_CgProgramManager
-
+PluginFolder=3D/usr/local/lib/OGRE =

+
 Plugin=3DRenderSystem_GL.so 	=

 Plugin=3DPlugin_ParticleFX.so 	=

 Plugin=3DPlugin_BSPSceneManager.so 	=

 Plugin=3DPlugin_OctreeSceneManager.so 	=

-#~ Plugin=3DPlugin_CgProgramManager.so =

+Plugin=3DPlugin_CgProgramManager.so =


Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Sun Jul 27 13:59:15 2008
@@ -326,6 +326,7 @@
 -- activates Lightsources
 gLightsources =3D false
 gLightsCastShadows =3D false
+gShowLightDebug =3D false
 =

 -- activates Particle Effects
 gParticleEffectSystem =3D true

Modified: trunk/lua/gui/gui.chat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.chat.lua (original)
+++ trunk/lua/gui/gui.chat.lua Sun Jul 27 13:59:15 2008
@@ -12,7 +12,7 @@
 =

 gGuiChatFontTextParam =3D {r=3D0,g=3D0,b=3D0}
 =

-gGuiChatLineLimit =3D 6
+gGuiChatLineLimit =3D 8
 =

 gGuiChatChannelFilter =3D {
 	default =3D ".+",

Modified: trunk/lua/gui/gui.healthbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.healthbar.lua (original)
+++ trunk/lua/gui/gui.healthbar.lua Sun Jul 27 13:59:15 2008
@@ -188,3 +188,24 @@
 		OpenHealthbar(GetPlayerMobile()) =

 	end
 end
+
+
+
+-- focused/selection auto health bar
+
+function HealthBarUpdateSelection(mobile)
+	if not gHealthBarSelectionDialog then
+		-- init dialog
+		gHealthBarSelectionDialog =3D GetDesktopWidget():CreateChild("Group",par=
ams)
+		gHealthBarSelectionDialog:SetSize(gGuiChatTabpaneWidth,gGuiChatTabpaneHe=
ight)
+		gHealthBarSelectionDialog:SetLeftTop(x,y)
+	end
+	=

+	-- update
+	if not mobile then
+		gHealthBarSelectionDialog:SetVisible(false) =

+	else
+		gHealthBarSelectionDialog:SetVisible(true)
+				=

+	end
+end

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Sun Jul 27 13:59:15 2008
@@ -99,6 +99,9 @@
 	end
 end
 =

+-- list of numbers assigned to quickcast functions
+glQuickCastHotkeys =3D {}
+
 glQuickCastDialog =3D {}
 -- creates a quickcast button at the given position
 function CreateQuickCastButton (x,y,name,fun,gumpbuttonartid)
@@ -114,6 +117,21 @@
 		dialog.rootwidget.gfx:SetPos(x,y)
 		local spellicon =3D MakeBorderGumpPart(dialog.rootwidget, gumpbuttonarti=
d, 0,0, nil,nil)
 		spellicon.mbIgnoreMouseOver =3D false
+
+		-- focus keybinding
+		spellicon.on_mouse_enter =3D function() print("FOCUS") SetFocusWidget(sp=
ellicon) end
+		spellicon.on_mouse_leave =3D function() print("DEFOCUS") ClearFocusWidge=
t() end
+		spellicon.on_focus_keydown =3D function(widget,key,char)
+			if =

+				(gKeyPressed[key_lcontrol] or gKeyPressed[key_rcontrol]) and =

+				(key ~=3D key_lcontrol and key ~=3D key_rcontrol) =

+			then
+				BindDown(GetKeyName(key),fun)
+				-- print("KeyDown",char,key,GetKeyName(key))
+				return true
+			end
+		end
+		=

 =

 		-- tooltip
 		spellicon.tooltip_offx =3D kUOToolTippOffX -- Both defined at

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Sun Jul 27 13:59:15 2008
@@ -511,8 +511,7 @@
 		local arrtiletype =3D GetStaticTileType(item.artid)
 		if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Light=
Source) ) then
 			local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc+=
arrtiletype.miHeight) * 0.1)
-			item.lightname=3DClient_AddPointLight(x,y,z, 0.3,0.3,0.2, 0.3,0.3,0.2, =
5.0,0.1,0.1,0.0)
-			Light_SetCastShadows(item.lightname, gLightsCastShadows)
+			item.lightname =3D Renderer3D:AddPointLight(x,y,z, 0.3,0.3,0.2, 0.3,0.3=
,0.2, 5.0,0.1,0.1,0.0)
 		end
 	end
 end
@@ -691,7 +690,7 @@
 	end
 	=

 	-- remove lightsource from dynamic
-	if (dynamic.lightname) then Client_RemoveLight(dynamic.lightname) dynamic=
.lightname =3D nil end
+	if (dynamic.lightname) then Renderer3D:RemovePointLight(dynamic.lightname=
) dynamic.lightname =3D nil end
 =

 	-- remove corpsegfx entry
 	if (dynamic.corpsegfx) then

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Sun Jul 27 13:59:15 2008
@@ -362,8 +362,7 @@
 	if (gLightsources) then
 		local arrtiletype =3D GetStaticTileType(iTileTypeID)
 		if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Light=
Source) ) then
-			entity.lightname=3DClient_AddPointLight(entity.x-0.5,entity.y-0.5,entit=
y.z+arrtiletype.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
-			Light_SetCastShadows(entity.lightname, gLightsCastShadows)
+			entity.lightname =3D Renderer3D:AddPointLight(entity.x-0.5,entity.y-0.5=
,entity.z+arrtiletype.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
 		end
 	end
 =

@@ -765,7 +764,7 @@
 		if (chunk.terrain_multitex_gfx) then chunk.terrain_multitex_gfx:Destroy(=
) chunk.terrain_multitex_gfx =3D nil end
 		if (chunk.pTerrainEntity) then chunk.pTerrainEntity:Destroy() chunk.pTer=
rainEntity =3D nil end
 		for k,v in pairs(chunk.lStaticEntities) do
-			if (v.lightname) then Client_RemoveLight(v.lightname) v.lightname =3D n=
il end
+			if (v.lightname) then Renderer3D:RemovePointLight(v.lightname) v.lightn=
ame =3D nil end
 			if (v.staticentity) then v.staticentity:Destroy() v.staticentity =3D ni=
l end
 			if (v.gfx and v.gfx.billboard) then v.gfx.billboard:Destroy() v.gfx.bil=
lboard =3D nil end
 			if (v.gfx) then v.gfx:Destroy() v.gfx =3D nil end

Modified: trunk/lua/lib.3d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mobile.lua (original)
+++ trunk/lua/lib.3d.mobile.lua Sun Jul 27 13:59:15 2008
@@ -18,6 +18,60 @@
 =

 function Renderer3D:UpdateMobileVisibility (mobile) =

 	self:MobileSetVisible(mobile,self:IsZLayerVisible(mobile.zloc))
+end
+
+
+
+function Renderer3D:UpdateAura( mobile, forceupdate )
+	-- aura around the feet
+	if (not mobile.aura) then
+		mobile.aura =3D CreateRootGfx3D()
+		mobile.aura:SetSimpleRenderable()
+		mobile.aura:SetMaterial("mobile/aura_base")
+		mobile.aura.lastn =3D nil
+	end
+	=

+	-- update mobile aura color
+	if =

+		(mobile.aura.lastn ~=3D mobile.notoriety) or =

+		(mobile.aura.lastnhits ~=3D mobile.stats.curHits) or =

+		forceupdate
+	then
+		=

+		mobile.aura.lastn =3D mobile.notoriety
+		mobile.aura.lastnhits =3D mobile.stats.curHits
+		=

+		local nx,ny,nz =3D 0,0,1
+		local r,g,b =3D GetNotorietyColor(mobile.notoriety)
+		local a =3D 0.7
+		local e =3D 0.5
+		local z =3D -0.1
+		=

+		-- read out hp%
+		local p =3D 1
+		if mobile.stats and mobile.stats.curHits and mobile.stats.maxHits then
+			p =3D mobile.stats.curHits / mobile.stats.maxHits
+		end
+		=

+		-- prepare vars
+		local k =3D 11
+		local l =3D math.floor(p*k)
+		local rr =3D 0.5
+		local ax =3D 0
+		=

+		mobile.aura:RenderableBegin(l+2,0,true,false,OT_TRIANGLE_FAN)
+		mobile.aura:RenderableVertex(0,0,z, nx,ny,nz, 0.5,0.5, r,g,b,a)
+		for i =3D 0,l do
+			local a =3D 360*gfDeg2Rad*i/k
+			local x =3D   rr * math.sin(a)
+			local y =3D   rr * math.cos(a)
+			local u =3D 	(1+math.sin(a + ax + gfDeg2Rad*180))*0.5
+			local v =3D 	(1+math.cos(a + ax + gfDeg2Rad*180))*0.5
+			-- mygfx:RenderableVertex((mx + x)/vw * 2.0 - 1.0,(my + y)/vh * (-2.0) =
+ 1.0,z, u,v)
+			mobile.aura:RenderableVertex(x,y,z, nx,ny,nz, u,v, r,g,b,a)
+		end
+		mobile.aura:RenderableEnd()
+	end
 end
 =

 function Renderer3D:UpdateMobile( mobile )
@@ -98,33 +152,7 @@
 	end
 	=

 =

-
-
-	-- aura around the feet
-	if (not mobile.aura) then
-		mobile.aura =3D CreateRootGfx3D()
-		mobile.aura:SetSimpleRenderable()
-		mobile.aura:SetMaterial("mobile/aura_base")
-		mobile.aura.lastn =3D nil
-	end
-	=

-	-- update mobile aura color
-	if (mobile.aura.lastn ~=3D mobile.notoriety) then
-		mobile.aura.lastn =3D mobile.notoriety
-		local nx,ny,nz =3D 0,0,1
-		local r,g,b =3D GetNotorietyColor(mobile.notoriety)
-		local a =3D 0.3
-		local e =3D 0.5
-		mobile.aura:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
-		mobile.aura:RenderableVertex(-e,-e,0, nx,ny,nz, 0,0, r,g,b,a)
-		mobile.aura:RenderableVertex( e,-e,0, nx,ny,nz, 1,0, r,g,b,a)
-		mobile.aura:RenderableVertex(-e, e,0, nx,ny,nz, 0,1, r,g,b,a)
-		mobile.aura:RenderableVertex( e, e,0, nx,ny,nz, 1,1, r,g,b,a)
-		mobile.aura:RenderableIndex3(0,1,2)
-		mobile.aura:RenderableIndex3(1,3,2)
-		mobile.aura:RenderableEnd()
-	end
-
+	self:UpdateAura(mobile)
 	=

 	-- target selection code, based on aura
 	-- TODO is it better to create is on select and destroy on deselect?

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Sun Jul 27 13:59:15 2008
@@ -129,7 +129,7 @@
 			=

 			local sun =3D gCaelumSystem:GetSun()
 		    if sun then
-		    	print("SUN")
+		    	--~ print("SUN")
 		        sun:SetAmbientMultiplier(0.5, 0.5, 0.5, 1)
 		        sun:SetDiffuseMultiplier(3, 3, 2.7, 1)
 		        sun:SetSpecularMultiplier(5, 5, 5, 1)
@@ -139,14 +139,14 @@
 		=

 			local moon =3D gCaelumSystem:GetMoon()
 		    if moon then
-		    	print("MOON")
+		    	--~ print("MOON")
 		        moon:SetAutoDisable(true)
 		        moon:SetAutoDisableThreshold(0.1)
 		    end
 		=

 			local clouds =3D gCaelumSystem:GetCloudSystem()
 		    if clouds then
-		    	print("CLOUDS")
+		    	--~ print("CLOUDS")
 		        clouds:CreateLayerAtHeight(5000)
 		        clouds:GetLayer(0):SetCloudSpeed(0.000005, -0.000009)
 		        clouds:GetLayer(1):SetCloudSpeed(0.0000045, -0.0000085)
@@ -154,28 +154,28 @@
 		=

 			local prec =3D gCaelumSystem:GetPrecipitationController()
 			if prec then
-		    	print("PREC")
+		    	--~ print("PREC")
 			    prec:SetCoverage(0)
 		    end
 		=

 		    -- Sunrise with visible moon.
 		    local cl =3D gCaelumSystem:GetUniversalClock()
 		    cl:SetGregorianDateTime(2007, 4, 9, 9, 33, 10)
-		    cl:SetTimeScale(512)
---[[
+		    --~ cl:SetTimeScale(2500)
+		    --~ cl:SetTimeScale(512)
+		    =

+		    -- to prevent wobbly shadows
+		    -- updates clock and caelum every 30 sec
+		    cl:SetUpdateRate(30)
+		    =

 			function rotate(gfx,w,x,y,z)
 				local ww,xx,yy,zz =3D gfx:GetOrientation()
 				gfx:SetOrientation(Quaternion.Mul(w,x,y,z, ww,xx,yy,zz))
 			end
 			=

-			local w,x,y,z =3D Quaternion.fromAngleAxis(90 * gfDeg2Rad, 0,0,1)
+			local w,x,y,z =3D Quaternion.fromAngleAxis(90 * gfDeg2Rad, 1,0,0)
 			rotate(gCaelumSystem:GetCaelumGroundNode(), w,x,y,z)
 			rotate(gCaelumSystem:GetCaelumCameraNode(), w,x,y,z)
-			TurnCam(w,x,y,z)
-]]--
---[[
-    		gCaelumSystem:AddAsListener()
-]]--
 		end
 	else
 		-- black background when underground
@@ -280,6 +280,40 @@
 end
 =

 =

+-- adds a point light source
+-- Diffuse dr,dg,db
+-- Specular sr,sg,sb
+-- Attenuation ar,ag,ab,aa
+function Renderer3D:AddPointLight	(x,y,z, dr,dg,db, sr,sg,sb, ar,ag,ab,aa)
+	local name =3D Client_AddPointLight(x,y,z, dr,dg,db, sr,sg,sb, ar,ag,ab,a=
a)
+	Light_SetCastShadows(name, gLightsCastShadows)
+	=

+	if gShowLightDebug then
+		-- create mesh and debug marker list
+		if not gLightDebugMesh then
+			local r =3D 0.5
+			gLightDebugMesh =3D MakeSphereMesh(11,11,r,r,r)
+			gLightDebugMeshList =3D {}
+		end
+		=

+		local gfx =3D CreateRootGfx3D()
+		gfx:SetMesh(gLightDebugMesh)	=

+		gfx:SetMeshSubEntityMaterial(0,GetPlainColourMat(dr or 1,dg or 1,db or 0=
))	=

+		gfx:SetPosition(x, y, z)
+		gLightDebugMeshList[name] =3D gfx
+	end
+	=

+	return name
+end
+
+function Renderer3D:RemovePointLight	(name)
+	Client_RemoveLight(name)
+	=

+	if gLightDebugMeshList and gLightDebugMeshList[name] then
+		gLightDebugMeshList[name]:Destroy()
+	end
+end
+
 function Renderer3D:CheckForUpdateMapOrigin()
 	if (self.giLastMapOriginX ~=3D self.giMapOriginX or
 		self.giLastMapOriginY ~=3D self.giMapOriginY) then

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Jul 27 13:59:15 2008
@@ -214,7 +214,9 @@
 	=

 	OgreAddResLoc(gUOPath..CorrectPath("Models/Maps")				,"FileSystem","Gener=
al")
 =

-	OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/caelum/resources"),=
"FileSystem","Caelum")
+	if gUseCaelumSkysystem then =

+		OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/caelum/resources")=
,"FileSystem","Caelum")
+	end
 =

 	--~ OgreAddResLoc(kObjTypePreviewDir.."."			,"FileSystem","General")
 	OgreInitResLocs()

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Sun Jul 27 13:59:15 2008
@@ -144,8 +144,8 @@
 =

 	printdebug("login",sprintf("NET: character list: size=3D%d charlist.charn=
umber=3D%d\n",charlist.size,charlist.charnumber))
 =

-	print("login:charlist:hexdump" )
-	print(FIFOHexDump(input,0,iBytesLeft))
+	--~ print("login:charlist:hexdump" )
+	--~ print(FIFOHexDump(input,0,iBytesLeft))
 	charlist.charnumber =3D math.max(5,charlist.charnumber)
 	=

 	for i =3D 0, charlist.charnumber-1 do



From no-reply at zwischenwelt.org  Mon Jul 28 00:41:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 27 Jul 2008 22:41:59 -0000
Subject: [Iris-commit] [IRIS] r2315 - in /trunk: data/config.lua.dist
 lua/lib.3d.map.lua lua/main.lua
Message-ID: <20080727224159.37D391524030@zwischenwelt.org>

Author: sience
Date: Mon Jul 28 00:41:58 2008
New Revision: 2315

Log:
-cadunetree added as option

Modified:
    trunk/data/config.lua.dist
    trunk/lua/lib.3d.map.lua
    trunk/lua/main.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Mon Jul 28 00:41:58 2008
@@ -510,3 +510,5 @@
 gUseStaticFallbacks =3D true
 =

 gUseCaelumSkysystem =3D false
+
+gUseCaduneTree =3D false

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Mon Jul 28 00:41:58 2008
@@ -296,7 +296,9 @@
 		staticwatertile =3D not gEnableMultiTexTerrain		--on multitexturing filt=
er static water
 	end
 =

-	--Renderer3D:GenerateCaduneTree(entity)
+	if gUseCaduneTree then
+		Renderer3D:GenerateCaduneTree(entity)
+	end
 =

 	local meshname =3D (not gForceFallBackBillboards_Statics) and staticwater=
tile and GetMeshName(iTileTypeID)
 =


Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Jul 28 00:41:58 2008
@@ -218,6 +218,10 @@
 		OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/caelum/resources")=
,"FileSystem","Caelum")
 	end
 =

+	if gUseCaduneTree then =

+		OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/cadune_tree/resour=
ces"),"FileSystem","CaduneTree")
+	end
+
 	--~ OgreAddResLoc(kObjTypePreviewDir.."."			,"FileSystem","General")
 	OgreInitResLocs()
 end



From no-reply at zwischenwelt.org  Mon Jul 28 03:31:02 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 28 Jul 2008 01:31:02 -0000
Subject: [Iris-commit] [IRIS] r2317 - /trunk/lua/net/net.aoscommand.lua
Message-ID: <20080728020005.3200F1524036@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Jul 28 03:31:01 2008
New Revision: 2317

Log:
weaponskills : added link to stratics page

Modified:
    trunk/lua/net/net.aoscommand.lua

Modified: trunk/lua/net/net.aoscommand.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.aoscommand.lua (original)
+++ trunk/lua/net/net.aoscommand.lua Mon Jul 28 03:31:01 2008
@@ -1,4 +1,6 @@
 -- combatskills/weaponskills =

+-- http://uo.stratics.com/content/arms-armor/specialmoves.php
+-- http://uo.stratics.com/content/arms-armor/special_moves_chart.shtml
 =

 kPacket_AOS_Command_WeaponAbilityRequest	=3D hex2num("0x19")	-- Client -> =
Server message
 kPacket_AOS_Command_GuildGumpRequest		=3D hex2num("0x28")	-- Client -> Ser=
ver message



From no-reply at zwischenwelt.org  Mon Jul 28 03:24:02 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 28 Jul 2008 01:24:02 -0000
Subject: [Iris-commit] [IRIS] r2316 - in /trunk/lua: lib.uoanim.lua
	net/net.aoscommand.lua
Message-ID: <20080728020005.038241C18031@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Jul 28 03:24:02 2008
New Revision: 2316

Log:
added weapon ability list, and link to wolfpack client code regarding 2d an=
ims

Modified:
    trunk/lua/lib.uoanim.lua
    trunk/lua/net/net.aoscommand.lua

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Mon Jul 28 03:24:02 2008
@@ -1,5 +1,7 @@
 -- 2d char anim graphics
 -- loads the 2d anim-art, not specific to 2d renderer, might also be used =
in 3d mode for fallbacks
+
+-- TODO : http://svn.berlios.de/viewcvs/wolfpack/trunk/client/  =

 =

 gAnimAtlasCache =3D {}
 kAnimID_Human_Idle =3D 20 =


Modified: trunk/lua/net/net.aoscommand.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.aoscommand.lua (original)
+++ trunk/lua/net/net.aoscommand.lua Mon Jul 28 03:24:02 2008
@@ -1,3 +1,5 @@
+-- combatskills/weaponskills =

+
 kPacket_AOS_Command_WeaponAbilityRequest	=3D hex2num("0x19")	-- Client -> =
Server message
 kPacket_AOS_Command_GuildGumpRequest		=3D hex2num("0x28")	-- Client -> Ser=
ver message
 kPacket_AOS_Command_QuestGumpRequest		=3D hex2num("0x32")	-- Client -> Ser=
ver message
@@ -85,3 +87,166 @@
 function Send_AOSCommand_WeaponAbility	(mobile_serial, weaponability)
 	Send_AOSCommand(kPacket_AOS_Command_WeaponAbilityRequest, mobile_serial, =
weaponability)
 end
+
+--[[
+objectId,primaryAbility,secondaryAbility,primaryId,secondaryId
+0,DISARM,PARALYZING_BLOW,5,11
+3568,WHIRLWIND_STRIKE,PARALYZING_BLOW ,13,11
+3569,WHIRLWIND_STRIKE,PARALYZING_BLOW ,13,11
+3570,DISMOUNT,DISARM ,6,5
+3571,DISMOUNT,DISARM ,6,5
+3572,DISMOUNT,DISARM ,6,5
+3573,DISMOUNT,DISARM ,6,5
+3713,CRUSHING_BLOW,DISARM ,4,5
+3714,CRUSHING_BLOW,DISARM ,4,5
+3717,DOUBLESTRIKE,DISARM ,7,5
+3718,DOUBLESTRIKE,DISARM ,7,5
+3719,BLEED_ATTACK,DISMOUNT ,2,6
+3720,BLEED_ATTACK,DISMOUNT ,2,6
+3721,DOUBLESTRIKE,CONCUSSION_BLOW ,7,3
+3722,DOUBLESTRIKE,CONCUSSION_BLOW ,7,3
+3778,BLEED_ATTACK,INFECTING ,2,8
+3779,BLEED_ATTACK,INFECTING ,2,8
+3780,SHADOWSTRIKE,DISARM ,12,5
+3781,SHADOWSTRIKE,DISARM ,12,5
+3907,ARMOR_IGNORE,DISARM ,1,5
+3908,ARMOR_IGNORE,DISARM ,1,5
+3909,BLEED_ATTACK,MORTALSTRIKE ,2,9
+3910,BLEED_ATTACK,MORTALSTRIKE ,2,9
+3911,BLEED_ATTACK,CONCUSSION_BLOW ,2,3
+3912,BLEED_ATTACK,CONCUSSION_BLOW ,2,3
+3913,CRUSHING_BLOW,DISMOUNT ,4,6
+3914,CRUSHING_BLOW,DISMOUNT ,4,6
+3915,DOUBLESTRIKE,WHIRLWIND_STRIKE ,7,13
+3916,DOUBLESTRIKE,WHIRLWIND_STRIKE ,7,13
+3917,PARALYZING_BLOW,DISMOUNT ,11,6
+3918,PARALYZING_BLOW,DISMOUNT ,11,6
+3919,CONCUSSION_BLOW,MORTALSTRIKE ,3,9
+3920,CONCUSSION_BLOW,MORTALSTRIKE ,3,9
+3921,INFECTING,SHADOWSTRIKE ,8,12
+3922,INFECTING,SHADOWSTRIKE ,8,12
+3932,CONCUSSION_BLOW,DISARM ,3,5
+3933,CONCUSSION_BLOW,DISARM ,3,5
+3934,CRUSHING_BLOW,ARMOR_IGNORE ,4,1
+3935,CRUSHING_BLOW,ARMOR_IGNORE ,4,1
+3936,ARMOR_IGNORE,CONCUSSION_BLOW ,1,3
+3937,ARMOR_IGNORE,CONCUSSION_BLOW ,1,3
+3938,ARMOR_IGNORE,PARALYZING_BLOW ,1,11
+3939,ARMOR_IGNORE,PARALYZING_BLOW ,1,11
+4020,CRUSHING_BLOW,SHADOWSTRIKE ,4,12
+4021,CRUSHING_BLOW,SHADOWSTRIKE ,4,12
+5039,ARMOR_IGNORE,BLEED_ATTACK ,1,2
+5040,ARMOR_IGNORE,BLEED_ATTACK ,1,2
+5041,PARALYZING_BLOW,MORTALSTRIKE ,11,9
+5042,PARALYZING_BLOW,MORTALSTRIKE ,11,9
+5043,SHADOWSTRIKE,DISMOUNT ,12,6
+5044,SHADOWSTRIKE,DISMOUNT ,12,6
+5045,DOUBLESTRIKE,PARALYZING_BLOW ,7,11
+5046,DOUBLESTRIKE,PARALYZING_BLOW ,7,11
+5047,ARMOR_IGNORE,CONCUSSION_BLOW ,1,3
+5048,ARMOR_IGNORE,CONCUSSION_BLOW ,1,3
+5049,CRUSHING_BLOW,PARALYZING_BLOW ,4,11
+5050,CRUSHING_BLOW,PARALYZING_BLOW ,4,11
+5091,CRUSHING_BLOW,SHADOWSTRIKE ,4,12
+5092,CRUSHING_BLOW,SHADOWSTRIKE ,4,12
+5108,CRUSHING_BLOW,DISARM ,4,5
+5109,CRUSHING_BLOW,DISARM ,4,5
+5110,INFECTING,DISARM ,8,5
+5111,INFECTING,DISARM ,8,5
+5112,CONCUSSION_BLOW,PARALYZING_BLOW ,3,11
+5113,CONCUSSION_BLOW,PARALYZING_BLOW ,3,11
+5114,WHIRLWIND_STRIKE,BLEED_ATTACK ,13,2
+5115,WHIRLWIND_STRIKE,BLEED_ATTACK ,13,2
+5116,MOVING_SHOT,DISMOUNT ,10,6
+5117,MOVING_SHOT,DISMOUNT ,10,6
+5118,DOUBLESTRIKE,ARMOR_IGNORE ,7,1
+5119,DOUBLESTRIKE,ARMOR_IGNORE ,7,1
+5120,ARMOR_IGNORE,INFECTING ,1,8
+5121,ARMOR_IGNORE,INFECTING ,1,8
+5122,SHADOWSTRIKE,MORTALSTRIKE ,12,9
+5123,SHADOWSTRIKE,MORTALSTRIKE ,12,9
+5124,BLEED_ATTACK,DISARM ,2,5
+5125,BLEED_ATTACK,DISARM ,2,5
+5126,CRUSHING_BLOW,BLEED_ATTACK ,4,2
+5127,CRUSHING_BLOW,BLEED_ATTACK ,4,2
+5176,WHIRLWIND_STRIKE,CRUSHING_BLOW ,13,4
+5177,WHIRLWIND_STRIKE,CRUSHING_BLOW ,13,4
+5178,CRUSHING_BLOW,CONCUSSION_BLOW ,4,3
+5179,CRUSHING_BLOW,CONCUSSION_BLOW ,4,3
+5180,ARMOR_IGNORE,MORTALSTRIKE ,1,9
+5181,ARMOR_IGNORE,MORTALSTRIKE ,1,9
+5182,WHIRLWIND_STRIKE,CONCUSSION_BLOW ,13,3
+5183,WHIRLWIND_STRIKE,CONCUSSION_BLOW ,13,3
+5184,BLEED_ATTACK,SHADOWSTRIKE ,2,12
+5185,BLEED_ATTACK,SHADOWSTRIKE ,2,12
+5186,DOUBLESTRIKE,SHADOWSTRIKE ,7,12
+5187,DOUBLESTRIKE,SHADOWSTRIKE ,7,12
+9914,BLEED_ATTACK,PARALYZING_BLOW ,2,11
+9915,PARALYZING_BLOW,MORTALSTRIKE ,11,9
+9916,CRUSHING_BLOW,MORTALSTRIKE ,4,9
+9917,ARMOR_IGNORE,DISMOUNT ,1,6
+9918,PARALYZING_BLOW,INFECTING ,11,8
+9919,DOUBLESTRIKE,INFECTING ,7,8
+9920,DISMOUNT,CONCUSSION_BLOW ,6,3
+9921,DOUBLESTRIKE,MORTALSTRIKE ,7,9
+9922,ARMOR_IGNORE,MOVING_SHOT ,1,10
+9923,DOUBLESTRIKE,MOVING_SHOT ,7,10
+9924,BLEED_ATTACK,PARALYZING_BLOW ,2,11
+9925,PARALYZING_BLOW,MORTALSTRIKE ,11,9
+9926,CRUSHING_BLOW,MORTALSTRIKE ,4,9
+9927,ARMOR_IGNORE,DISMOUNT ,1,6
+9928,PARALYZING_BLOW,INFECTING ,11,8
+9929,DOUBLESTRIKE,INFECTING ,7,8
+9930,DISMOUNT,CONCUSSION_BLOW ,6,3
+9931,DOUBLESTRIKE,MORTALSTRIKE ,7,9
+9932,ARMOR_IGNORE,MOVING_SHOT ,1,10
+9933,DOUBLESTRIKE,MOVING_SHOT ,7,10
+10146,CRUSHING_BLOW,RIDINGSWIPE ,4,14
+10147,FEINT,BLOCK ,20,16
+10148,FRENZIEDWHIRLWIND,DOUBLESTRIKE ,15,7
+10149,ARMORPIERCE,DOUBLESHOT ,23,22
+10150,FRENZIEDWHIRLWIND,CRUSHING_BLOW ,15,4
+10151,DEFENSEMASTERY,FRENZIEDWHIRLWIND ,17,15
+10152,FEINT,NERVESTRIKE ,20,18
+10153,FEINT,DOUBLESTRIKE ,20,7
+10155,DUALWIELD,TALONSTRIKE ,21,19
+10157,WHIRLWIND_STRIKE,DEFENSEMASTERY ,13,17
+10158,BLOCK,FEINT ,16,20
+10159,BLOCK,ARMORPIERCE ,16,23
+10221,CRUSHING_BLOW,RIDINGSWIPE ,4,14
+10222,FEINT,BLOCK ,20,16
+10223,FRENZIEDWHIRLWIND,DOUBLESTRIKE ,15,7
+10224,ARMORPIERCE,DOUBLESHOT ,23,22
+10225,FRENZIEDWHIRLWIND,CRUSHING_BLOW ,15,4
+10226,DEFENSEMASTERY,FRENZIEDWHIRLWIND ,17,15
+10227,FEINT,NERVESTRIKE ,20,18
+10228,FEINT,DOUBLESTRIKE ,20,7
+10230,DUALWIELD,TALONSTRIKE ,21,19
+10232,WHIRLWIND_STRIKE,DEFENSEMASTERY ,13,17
+10233,BLOCK,FEINT ,16,20
+10234,BLOCK,ARMORPIERCE ,16,23
+11550,FORCE_ARROW,SERPENT_ARROW ,25,28
+11551,LIGHTNING_ARROW,PSYCHIC_ATTACK ,26,27
+11552,PSYCHIC_ATTACK,BLEED_ATTACK ,27,2
+11553,INFECTING,SHADOWSTRIKE ,8,12
+11554,FEINT,ARMOR_IGNORE ,20,1
+11555,DISARM,BLADEWEAVE ,5,24
+11556,CONCUSSION_BLOW,CRUSHING_BLOW ,3,4
+11557,BLOCK,FORCE_OF_NATURE ,16,29
+11558,DISARM,BLADEWEAVE ,5,24
+11559,WHIRLWIND_STRIKE,BLADEWEAVE ,13,24
+11560,DISARM,CRUSHING_BLOW ,5,4
+11561,DEFENSEMASTERY,BLADEWEAVE ,17,24
+11562,FORCE_ARROW,SERPENT_ARROW ,25,28
+11563,LIGHTNING_ARROW,PSYCHIC_ATTACK ,26,27
+11564,PSYCHIC_ATTACK,BLEED_ATTACK ,27,2
+11565,INFECTING,SHADOWSTRIKE ,8,12
+11566,FEINT,ARMOR_IGNORE ,20,1
+11567,DISARM,BLADEWEAVE ,5,24
+11568,CONCUSSION_BLOW,CRUSHING_BLOW ,3,4
+11569,BLOCK,FORCE_OF_NATURE ,16,29
+11570,DISARM,BLADEWEAVE ,5,24
+11571,WHIRLWIND_STRIKE,BLADEWEAVE ,13,24
+11572,DISARM,CRUSHING_BLOW ,5,4
+11573,DEFENSEMASTERY,BLADEWEAVE,17,24
+]]--



From no-reply at zwischenwelt.org  Mon Jul 28 15:00:10 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 28 Jul 2008 13:00:10 -0000
Subject: [Iris-commit] [IRIS] r2320 - /trunk/data/base/simplebutton.png
Message-ID: <20080728130010.8C65A1C18019@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Jul 28 15:00:10 2008
New Revision: 2320

Log:
simple button gfx : added checkbox sprite

Modified:
    trunk/data/base/simplebutton.png

Modified: trunk/data/base/simplebutton.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Mon Jul 28 14:54:50 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 28 Jul 2008 12:54:50 -0000
Subject: [Iris-commit] [IRIS] r2319 - /trunk/data/base/simplebutton.png
Message-ID: <20080728130007.342F41C18012@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Jul 28 14:54:49 2008
New Revision: 2319

Log:
added simple button gfx

Added:
    trunk/data/base/simplebutton.png   (with props)



From no-reply at zwischenwelt.org  Mon Jul 28 14:00:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 28 Jul 2008 12:00:55 -0000
Subject: [Iris-commit] [IRIS] r2318 - in /trunk/lua: gui/gui.paperdoll.lua
 gui/gui.skill.lua lib.desktop.lua lib.uoids.lua
Message-ID: <20080728130003.580AA1C18258@zwischenwelt.org>

Author: hagish
Date: Mon Jul 28 14:00:53 2008
New Revision: 2318

Log:
weapon abilities working

Modified:
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/gui/gui.skill.lua
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.uoids.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Mon Jul 28 14:00:53 2008
@@ -23,7 +23,9 @@
  "{ button 187 156 2015 2016 1 0 5 btnskills }" ..
  "{ button 187 181 22450 22452 1 0 6 btnguild }" ..
  "{ button 187 205 2021 2022 1 0 7 btnpeace }" ..
- "{ button 187 233 2027 2028 1 0 8 btnstatus }"
+ "{ button 187 233 2027 2028 1 0 8 btnstatus }" ..
+ "{ button 165 210 11060 11060 1 0 9 btnweaponability }"
+
 playerPaperdoll.textline =3D {
  [0] =3D "paperdoll_name",
 }
@@ -78,6 +80,28 @@
  				ToggleStatusAos()
  			end
  		  end,
+ -- weaponability
+ [9]	=3D function (widget,mousebutton)
+ 			if (mousebutton =3D=3D 1) then
+ 				-- get artid of current equipped weapon
+ 				local playermobile =3D GetPlayerMobile()
+ 				local item1 =3D GetMobileEquipmentItem(playermobile,gLayerType.kLayer=
_OneHanded)
+ 				local item2 =3D GetMobileEquipmentItem(playermobile,gLayerType.kLayer=
_TwoHanded)
+ 				local artid =3D (item1 and item1.artid) or (item2 and item2.artid)
+ 				--~ print("artid",artid)
+ 				local skills =3D glWeaponAbilitiesWeapons[artid]
+ 				if skills then
+ 					local first =3D glWeaponAbilities[skills.first]
+ 					local second =3D glWeaponAbilities[skills.second]
+ 					--~ print("first",first.name)
+ 					--~ print("second",second.name)
+ 					=

+ 					local mx,my =3D GetMousePos()
+ 					CreateQuickCastButtonWeaponability(mx-48,my,skills.first)
+ 					CreateQuickCastButtonWeaponability(mx+16,my,skills.second)
+ 				end
+ 			end
+ 		  end,
 }
 =

 -- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Mon Jul 28 14:00:53 2008
@@ -119,8 +119,8 @@
 		spellicon.mbIgnoreMouseOver =3D false
 =

 		-- focus keybinding
-		spellicon.on_mouse_enter =3D function() print("FOCUS") SetFocusWidget(sp=
ellicon) end
-		spellicon.on_mouse_leave =3D function() print("DEFOCUS") ClearFocusWidge=
t() end
+		spellicon.on_mouse_enter =3D function() SetFocusWidget(spellicon) end
+		spellicon.on_mouse_leave =3D function() ClearFocusWidget() end
 		spellicon.on_focus_keydown =3D function(widget,key,char)
 			if =

 				(gKeyPressed[key_lcontrol] or gKeyPressed[key_rcontrol]) and =

@@ -173,6 +173,8 @@
 	dialog.on_mouse_left_click_double =3D function (widget) fun() end
 =

 	table.insert(glQuickCastDialog,dialog)
+
+	dialog:BringToFront()
 =

 	return dialog
 end
@@ -201,6 +203,54 @@
 	NotifyListener("Hook_CreateQuickCastSkill",d,x,y,skillid)
 	return d
 end
+
+
+
+
+
+
+
+
+
+function CreateQuickCastButtonWeaponability(x,y,weaponabilityid)
+	for k,v in pairs(glQuickCastDialog) do
+		if v and v.weaponabilityid and v.weaponabilityid =3D=3D weaponabilityid =
then
+			if v and v.rootwidget and v.rootwidget.gfx and v.rootwidget.gfx:IsAlive=
() then
+				-- reuse existing one
+				v.rootwidget.gfx:SetPos(x,y)
+				return
+			else
+				-- there is a broken one left, so close it
+				if v:IsAlive() then v:Close() end
+				if v:IsAlive() then v:Destroy() end
+				glQuickCastDialog[k] =3D nil
+			end
+		end
+	end
+							=

+	local name =3D glWeaponAbilities[weaponabilityid] and glWeaponAbilities[w=
eaponabilityid].name or "?"
+	local iconid =3D glWeaponAbilities[weaponabilityid] and glWeaponAbilities=
[weaponabilityid].gumpicon or 0x5200
+							=

+	local d =3D CreateQuickCastButton(x,y,name,function () =

+		-- quick cast function
+		-- Send_Spell(weaponabilityid,gSpellbookExpansion["AOS"])
+		--~ print("WEAPON ABILITY",name)
+		local mobile =3D GetPlayerMobile()
+		if mobile and mobile.serial then
+			Send_AOSCommand_WeaponAbility(mobile.serial, weaponabilityid)
+		end
+	end, iconid)
+
+	d.weaponabilityid =3D weaponabilityid
+	NotifyListener("Hook_CreateQuickWeaponAbility",d,x,y,weaponabilityid)
+	return d
+end
+
+
+
+
+
+
 =

 gSkillDialog_LastPositionX =3D nil
 gSkillDialog_LastPositionY =3D nil

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Mon Jul 28 14:00:53 2008
@@ -22,6 +22,29 @@
 		ReplaceDesktopElement("paperdoll",x,y,p.serial) 	=

 		SaveDesktop()
 	end
+end)
+-- ------------------------------------------------------------------------
+-- weaponability
+-- ------------------------------------------------------------------------
+gDesktopElementFactory.weaponability =3D {
+	open =3D function(x,y,param) CreateQuickCastButtonWeaponability(x,y,param=
) end, =

+	checkpos =3D function(e, widget) =

+		local d =3D widget.dialog
+		if d and d.weaponabilityid and d.weaponabilityid =3D=3D e.param then
+			e.x,e.y =3D widget.gfx:GetPos() =

+			return true
+		end
+	end,
+}
+RegisterListener("Hook_CloseQuickCastButton",function(d) =

+	if d.weaponabilityid then =

+		RemoveDesktopElement("weaponability",d.weaponabilityid) =

+		SaveDesktop() =

+	end
+end)
+RegisterListener("Hook_CreateQuickWeaponAbility",function(d,x,y,weaponabil=
ityid) =

+	ReplaceDesktopElement("weaponability",x,y,weaponabilityid) 	=

+	SaveDesktop()
 end)
 -- ------------------------------------------------------------------------
 -- spell

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Mon Jul 28 14:00:53 2008
@@ -425,3 +425,203 @@
 	[54]	=3D 0,
 	[55]	=3D 0
 }
+
+
+
+-- weapon abilities (name + gumpicons)
+-- id id packet id that should be send
+glWeaponAbilities =3D {
+	[1] =3D {name=3D"ARMOR_IGNORE",gumpicon=3D0x5200+1},
+	[2] =3D {name=3D"BLEED_ATTACK",gumpicon=3D0x5200+2},
+	[3] =3D {name=3D"CONCUSSION_BLOW",gumpicon=3D0x5200+3},
+	[4] =3D {name=3D"CRUSHING_BLOW",gumpicon=3D0x5200+4},
+	[5] =3D {name=3D"DISARM",gumpicon=3D0x5200+5},
+	[6] =3D {name=3D"DISMOUNT",gumpicon=3D0x5200+6},
+	[7] =3D {name=3D"DOUBLESTRIKE",gumpicon=3D0x5200+7},
+	[8] =3D {name=3D"INFECTING",gumpicon=3D0x5200+8},
+	[9] =3D {name=3D"MORTALSTRIKE",gumpicon=3D0x5200+9},
+	[10] =3D {name=3D"MOVING_SHOT",gumpicon=3D0x5200+10},
+	[11] =3D {name=3D"PARALYZING_BLOW",gumpicon=3D0x5200+11},
+	[12] =3D {name=3D"SHADOWSTRIKE",gumpicon=3D0x5200+12},
+	[13] =3D {name=3D"WHIRLWIND_STRIKE",gumpicon=3D0x5200+13},
+	[14] =3D {name=3D"RIDINGSWIPE",gumpicon=3D0x5200+14},
+	[15] =3D {name=3D"FRENZIEDWHIRLWIND",gumpicon=3D0x5200+15},
+	[16] =3D {name=3D"BLOCK",gumpicon=3D0x5200+16},
+	[17] =3D {name=3D"DEFENSEMASTERY",gumpicon=3D0x5200+17},
+	[18] =3D {name=3D"NERVESTRIKE",gumpicon=3D0x5200+18},
+	[19] =3D {name=3D"TALONSTRIKE",gumpicon=3D0x5200+19},
+	[20] =3D {name=3D"FEINT",gumpicon=3D0x5200+20},
+	[21] =3D {name=3D"DUALWIELD",gumpicon=3D0x5200+21},
+	[22] =3D {name=3D"DOUBLESHOT",gumpicon=3D0x5200+22},
+	[23] =3D {name=3D"ARMORPIERCE",gumpicon=3D0x5200+23},
+	[24] =3D {name=3D"BLADEWEAVE",gumpicon=3D0x5200+24},
+	[25] =3D {name=3D"FORCE_ARROW",gumpicon=3D0x5200+25},
+	[26] =3D {name=3D"LIGHTNING_ARROW",gumpicon=3D0x5200+26},
+	[27] =3D {name=3D"PSYCHIC_ATTACK",gumpicon=3D0x5200+27},
+	[28] =3D {name=3D"SERPENT_ARROW",gumpicon=3D0x5200+28},
+	[29] =3D {name=3D"FORCE_OF_NATURE",gumpicon=3D0x5200+29},
+}
+
+-- weapons and they assigned weaponabilities
+-- id is the weapon artid
+glWeaponAbilitiesWeapons =3D {
+	[0] =3D {first=3D5,second=3D11},
+	[3568] =3D {first=3D13,second=3D11},
+	[3569] =3D {first=3D13,second=3D11},
+	[3570] =3D {first=3D6,second=3D5},
+	[3571] =3D {first=3D6,second=3D5},
+	[3572] =3D {first=3D6,second=3D5},
+	[3573] =3D {first=3D6,second=3D5},
+	[3713] =3D {first=3D4,second=3D5},
+	[3714] =3D {first=3D4,second=3D5},
+	[3717] =3D {first=3D7,second=3D5},
+	[3718] =3D {first=3D7,second=3D5},
+	[3719] =3D {first=3D2,second=3D6},
+	[3720] =3D {first=3D2,second=3D6},
+	[3721] =3D {first=3D7,second=3D3},
+	[3722] =3D {first=3D7,second=3D3},
+	[3778] =3D {first=3D2,second=3D8},
+	[3779] =3D {first=3D2,second=3D8},
+	[3780] =3D {first=3D12,second=3D5},
+	[3781] =3D {first=3D12,second=3D5},
+	[3907] =3D {first=3D1,second=3D5},
+	[3908] =3D {first=3D1,second=3D5},
+	[3909] =3D {first=3D2,second=3D9},
+	[3910] =3D {first=3D2,second=3D9},
+	[3911] =3D {first=3D2,second=3D3},
+	[3912] =3D {first=3D2,second=3D3},
+	[3913] =3D {first=3D4,second=3D6},
+	[3914] =3D {first=3D4,second=3D6},
+	[3915] =3D {first=3D7,second=3D13},
+	[3916] =3D {first=3D7,second=3D13},
+	[3917] =3D {first=3D11,second=3D6},
+	[3918] =3D {first=3D11,second=3D6},
+	[3919] =3D {first=3D3,second=3D9},
+	[3920] =3D {first=3D3,second=3D9},
+	[3921] =3D {first=3D8,second=3D12},
+	[3922] =3D {first=3D8,second=3D12},
+	[3932] =3D {first=3D3,second=3D5},
+	[3933] =3D {first=3D3,second=3D5},
+	[3934] =3D {first=3D4,second=3D1},
+	[3935] =3D {first=3D4,second=3D1},
+	[3936] =3D {first=3D1,second=3D3},
+	[3937] =3D {first=3D1,second=3D3},
+	[3938] =3D {first=3D1,second=3D11},
+	[3939] =3D {first=3D1,second=3D11},
+	[4020] =3D {first=3D4,second=3D12},
+	[4021] =3D {first=3D4,second=3D12},
+	[5039] =3D {first=3D1,second=3D2},
+	[5040] =3D {first=3D1,second=3D2},
+	[5041] =3D {first=3D11,second=3D9},
+	[5042] =3D {first=3D11,second=3D9},
+	[5043] =3D {first=3D12,second=3D6},
+	[5044] =3D {first=3D12,second=3D6},
+	[5045] =3D {first=3D7,second=3D11},
+	[5046] =3D {first=3D7,second=3D11},
+	[5047] =3D {first=3D1,second=3D3},
+	[5048] =3D {first=3D1,second=3D3},
+	[5049] =3D {first=3D4,second=3D11},
+	[5050] =3D {first=3D4,second=3D11},
+	[5091] =3D {first=3D4,second=3D12},
+	[5092] =3D {first=3D4,second=3D12},
+	[5108] =3D {first=3D4,second=3D5},
+	[5109] =3D {first=3D4,second=3D5},
+	[5110] =3D {first=3D8,second=3D5},
+	[5111] =3D {first=3D8,second=3D5},
+	[5112] =3D {first=3D3,second=3D11},
+	[5113] =3D {first=3D3,second=3D11},
+	[5114] =3D {first=3D13,second=3D2},
+	[5115] =3D {first=3D13,second=3D2},
+	[5116] =3D {first=3D10,second=3D6},
+	[5117] =3D {first=3D10,second=3D6},
+	[5118] =3D {first=3D7,second=3D1},
+	[5119] =3D {first=3D7,second=3D1},
+	[5120] =3D {first=3D1,second=3D8},
+	[5121] =3D {first=3D1,second=3D8},
+	[5122] =3D {first=3D12,second=3D9},
+	[5123] =3D {first=3D12,second=3D9},
+	[5124] =3D {first=3D2,second=3D5},
+	[5125] =3D {first=3D2,second=3D5},
+	[5126] =3D {first=3D4,second=3D2},
+	[5127] =3D {first=3D4,second=3D2},
+	[5176] =3D {first=3D13,second=3D4},
+	[5177] =3D {first=3D13,second=3D4},
+	[5178] =3D {first=3D4,second=3D3},
+	[5179] =3D {first=3D4,second=3D3},
+	[5180] =3D {first=3D1,second=3D9},
+	[5181] =3D {first=3D1,second=3D9},
+	[5182] =3D {first=3D13,second=3D3},
+	[5183] =3D {first=3D13,second=3D3},
+	[5184] =3D {first=3D2,second=3D12},
+	[5185] =3D {first=3D2,second=3D12},
+	[5186] =3D {first=3D7,second=3D12},
+	[5187] =3D {first=3D7,second=3D12},
+	[9914] =3D {first=3D2,second=3D11},
+	[9915] =3D {first=3D11,second=3D9},
+	[9916] =3D {first=3D4,second=3D9},
+	[9917] =3D {first=3D1,second=3D6},
+	[9918] =3D {first=3D11,second=3D8},
+	[9919] =3D {first=3D7,second=3D8},
+	[9920] =3D {first=3D6,second=3D3},
+	[9921] =3D {first=3D7,second=3D9},
+	[9922] =3D {first=3D1,second=3D10},
+	[9923] =3D {first=3D7,second=3D10},
+	[9924] =3D {first=3D2,second=3D11},
+	[9925] =3D {first=3D11,second=3D9},
+	[9926] =3D {first=3D4,second=3D9},
+	[9927] =3D {first=3D1,second=3D6},
+	[9928] =3D {first=3D11,second=3D8},
+	[9929] =3D {first=3D7,second=3D8},
+	[9930] =3D {first=3D6,second=3D3},
+	[9931] =3D {first=3D7,second=3D9},
+	[9932] =3D {first=3D1,second=3D10},
+	[9933] =3D {first=3D7,second=3D10},
+	[10146] =3D {first=3D4,second=3D14},
+	[10147] =3D {first=3D20,second=3D16},
+	[10148] =3D {first=3D15,second=3D7},
+	[10149] =3D {first=3D23,second=3D22},
+	[10150] =3D {first=3D15,second=3D4},
+	[10151] =3D {first=3D17,second=3D15},
+	[10152] =3D {first=3D20,second=3D18},
+	[10153] =3D {first=3D20,second=3D7},
+	[10155] =3D {first=3D21,second=3D19},
+	[10157] =3D {first=3D13,second=3D17},
+	[10158] =3D {first=3D16,second=3D20},
+	[10159] =3D {first=3D16,second=3D23},
+	[10221] =3D {first=3D4,second=3D14},
+	[10222] =3D {first=3D20,second=3D16},
+	[10223] =3D {first=3D15,second=3D7},
+	[10224] =3D {first=3D23,second=3D22},
+	[10225] =3D {first=3D15,second=3D4},
+	[10226] =3D {first=3D17,second=3D15},
+	[10227] =3D {first=3D20,second=3D18},
+	[10228] =3D {first=3D20,second=3D7},
+	[10230] =3D {first=3D21,second=3D19},
+	[10232] =3D {first=3D13,second=3D17},
+	[10233] =3D {first=3D16,second=3D20},
+	[10234] =3D {first=3D16,second=3D23},
+	[11550] =3D {first=3D25,second=3D28},
+	[11551] =3D {first=3D26,second=3D27},
+	[11552] =3D {first=3D27,second=3D2},
+	[11553] =3D {first=3D8,second=3D12},
+	[11554] =3D {first=3D20,second=3D1},
+	[11555] =3D {first=3D5,second=3D24},
+	[11556] =3D {first=3D3,second=3D4},
+	[11557] =3D {first=3D16,second=3D29},
+	[11558] =3D {first=3D5,second=3D24},
+	[11559] =3D {first=3D13,second=3D24},
+	[11560] =3D {first=3D5,second=3D4},
+	[11561] =3D {first=3D17,second=3D24},
+	[11562] =3D {first=3D25,second=3D28},
+	[11563] =3D {first=3D26,second=3D27},
+	[11564] =3D {first=3D27,second=3D2},
+	[11565] =3D {first=3D8,second=3D12},
+	[11566] =3D {first=3D20,second=3D1},
+	[11567] =3D {first=3D5,second=3D24},
+	[11568] =3D {first=3D3,second=3D4},
+	[11569] =3D {first=3D16,second=3D29},
+	[11570] =3D {first=3D5,second=3D24},
+	[11571] =3D {first=3D13,second=3D24},
+	[11572] =3D {first=3D5,second=3D4},
+	[11573] =3D {first=3D17,second=3D24},
+}



From no-reply at zwischenwelt.org  Mon Jul 28 15:28:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 28 Jul 2008 13:28:25 -0000
Subject: [Iris-commit] [IRIS] r2321 - /trunk/lua/lib.uoids.lua
Message-ID: <20080728132825.CEB541524030@zwischenwelt.org>

Author: hagish
Date: Mon Jul 28 15:28:25 2008
New Revision: 2321

Log:
bugfix: wrong weaponability icons

Modified:
    trunk/lua/lib.uoids.lua

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Mon Jul 28 15:28:25 2008
@@ -431,35 +431,35 @@
 -- weapon abilities (name + gumpicons)
 -- id id packet id that should be send
 glWeaponAbilities =3D {
-	[1] =3D {name=3D"ARMOR_IGNORE",gumpicon=3D0x5200+1},
-	[2] =3D {name=3D"BLEED_ATTACK",gumpicon=3D0x5200+2},
-	[3] =3D {name=3D"CONCUSSION_BLOW",gumpicon=3D0x5200+3},
-	[4] =3D {name=3D"CRUSHING_BLOW",gumpicon=3D0x5200+4},
-	[5] =3D {name=3D"DISARM",gumpicon=3D0x5200+5},
-	[6] =3D {name=3D"DISMOUNT",gumpicon=3D0x5200+6},
-	[7] =3D {name=3D"DOUBLESTRIKE",gumpicon=3D0x5200+7},
-	[8] =3D {name=3D"INFECTING",gumpicon=3D0x5200+8},
-	[9] =3D {name=3D"MORTALSTRIKE",gumpicon=3D0x5200+9},
-	[10] =3D {name=3D"MOVING_SHOT",gumpicon=3D0x5200+10},
-	[11] =3D {name=3D"PARALYZING_BLOW",gumpicon=3D0x5200+11},
-	[12] =3D {name=3D"SHADOWSTRIKE",gumpicon=3D0x5200+12},
-	[13] =3D {name=3D"WHIRLWIND_STRIKE",gumpicon=3D0x5200+13},
-	[14] =3D {name=3D"RIDINGSWIPE",gumpicon=3D0x5200+14},
-	[15] =3D {name=3D"FRENZIEDWHIRLWIND",gumpicon=3D0x5200+15},
-	[16] =3D {name=3D"BLOCK",gumpicon=3D0x5200+16},
-	[17] =3D {name=3D"DEFENSEMASTERY",gumpicon=3D0x5200+17},
-	[18] =3D {name=3D"NERVESTRIKE",gumpicon=3D0x5200+18},
-	[19] =3D {name=3D"TALONSTRIKE",gumpicon=3D0x5200+19},
-	[20] =3D {name=3D"FEINT",gumpicon=3D0x5200+20},
-	[21] =3D {name=3D"DUALWIELD",gumpicon=3D0x5200+21},
-	[22] =3D {name=3D"DOUBLESHOT",gumpicon=3D0x5200+22},
-	[23] =3D {name=3D"ARMORPIERCE",gumpicon=3D0x5200+23},
-	[24] =3D {name=3D"BLADEWEAVE",gumpicon=3D0x5200+24},
-	[25] =3D {name=3D"FORCE_ARROW",gumpicon=3D0x5200+25},
-	[26] =3D {name=3D"LIGHTNING_ARROW",gumpicon=3D0x5200+26},
-	[27] =3D {name=3D"PSYCHIC_ATTACK",gumpicon=3D0x5200+27},
-	[28] =3D {name=3D"SERPENT_ARROW",gumpicon=3D0x5200+28},
-	[29] =3D {name=3D"FORCE_OF_NATURE",gumpicon=3D0x5200+29},
+	[1] =3D {name=3D"ARMOR_IGNORE",gumpicon=3D0x51FF+1},
+	[2] =3D {name=3D"BLEED_ATTACK",gumpicon=3D0x51FF+2},
+	[3] =3D {name=3D"CONCUSSION_BLOW",gumpicon=3D0x51FF+3},
+	[4] =3D {name=3D"CRUSHING_BLOW",gumpicon=3D0x51FF+4},
+	[5] =3D {name=3D"DISARM",gumpicon=3D0x51FF+5},
+	[6] =3D {name=3D"DISMOUNT",gumpicon=3D0x51FF+6},
+	[7] =3D {name=3D"DOUBLESTRIKE",gumpicon=3D0x51FF+7},
+	[8] =3D {name=3D"INFECTING",gumpicon=3D0x51FF+8},
+	[9] =3D {name=3D"MORTALSTRIKE",gumpicon=3D0x51FF+9},
+	[10] =3D {name=3D"MOVING_SHOT",gumpicon=3D0x51FF+10},
+	[11] =3D {name=3D"PARALYZING_BLOW",gumpicon=3D0x51FF+11},
+	[12] =3D {name=3D"SHADOWSTRIKE",gumpicon=3D0x51FF+12},
+	[13] =3D {name=3D"WHIRLWIND_STRIKE",gumpicon=3D0x51FF+13},
+	[14] =3D {name=3D"RIDINGSWIPE",gumpicon=3D0x51FF+14},
+	[15] =3D {name=3D"FRENZIEDWHIRLWIND",gumpicon=3D0x51FF+15},
+	[16] =3D {name=3D"BLOCK",gumpicon=3D0x51FF+16},
+	[17] =3D {name=3D"DEFENSEMASTERY",gumpicon=3D0x51FF+17},
+	[18] =3D {name=3D"NERVESTRIKE",gumpicon=3D0x51FF+18},
+	[19] =3D {name=3D"TALONSTRIKE",gumpicon=3D0x51FF+19},
+	[20] =3D {name=3D"FEINT",gumpicon=3D0x51FF+20},
+	[21] =3D {name=3D"DUALWIELD",gumpicon=3D0x51FF+21},
+	[22] =3D {name=3D"DOUBLESHOT",gumpicon=3D0x51FF+22},
+	[23] =3D {name=3D"ARMORPIERCE",gumpicon=3D0x51FF+23},
+	[24] =3D {name=3D"BLADEWEAVE",gumpicon=3D0x51FF+24},
+	[25] =3D {name=3D"FORCE_ARROW",gumpicon=3D0x51FF+25},
+	[26] =3D {name=3D"LIGHTNING_ARROW",gumpicon=3D0x51FF+26},
+	[27] =3D {name=3D"PSYCHIC_ATTACK",gumpicon=3D0x51FF+27},
+	[28] =3D {name=3D"SERPENT_ARROW",gumpicon=3D0x51FF+28},
+	[29] =3D {name=3D"FORCE_OF_NATURE",gumpicon=3D0x51FF+29},
 }
 =

 -- weapons and they assigned weaponabilities



From no-reply at zwischenwelt.org  Tue Jul 29 02:36:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 29 Jul 2008 00:36:59 -0000
Subject: [Iris-commit] [IRIS] r2322 - in /trunk: data/base/main.material
 lua/lib.2d.dynamic.lua lua/lib.2d.map.lua lua/lib.2d.renderer.lua
 lua/lib.artatlas.lua lua/lib.static.lua
Message-ID: <20080729003659.520611524030@zwischenwelt.org>

Author: hagish
Date: Tue Jul 29 02:36:58 2008
New Revision: 2322

Log:
now ArtAtlasLoadMaterial and ArtAtlasLoadAndLockDirect need a base material=
 as additional parameter

Modified:
    trunk/data/base/main.material
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.artatlas.lua
    trunk/lua/lib.static.lua

Modified: trunk/data/base/main.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/main.material (original)
+++ trunk/data/base/main.material Tue Jul 29 02:36:58 2008
@@ -462,6 +462,25 @@
 	}
 }
 =

+material staticfallbackatlas
+{
+	technique
+	{
+		pass
+		{
+			cull_hardware none
+			cull_software none
+
+			scene_blend alpha_blend
+			// alpha_rejection less 128
+			alpha_rejection greater 128
+			lighting off
+			ambient 1.0 1.0 1.0
+			diffuse 1.0 1.0 1.0
+		}
+	}
+}
+
 material tilefreewalk_markerbase
 {
 	technique

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Tue Jul 29 02:36:58 2008
@@ -9,7 +9,7 @@
 	item.gfx2d =3D gfx
 	gfx:SetSimpleRenderable()
 	local iTileTypeID,iHue =3D item.artid+0x4000,item.hue
-	local sMatName,iWidth,iHeight,iCenterX,iCenterY,u0,v0,u1,v1 =3D ArtAtlasL=
oadAndLockDirect(iTileTypeID,iHue,item)
+	local sMatName,iWidth,iHeight,iCenterX,iCenterY,u0,v0,u1,v1 =3D ArtAtlasL=
oadAndLockDirect(iTileTypeID,iHue,item,Renderer2D.kAtlasBaseMaterial)
 	if (not sMatName) then return end
 	local zoom =3D 1
 	local pix2coord =3D zoom * 1 / 44

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Tue Jul 29 02:36:58 2008
@@ -182,7 +182,7 @@
 	-- -so 552,2088
 	-- -so 632,1488
 	for atlas,group in pairs(block.pStaticGroups) do
-		local matname =3D ArtAtlasLoadMaterial(atlas)
+		local matname =3D ArtAtlasLoadMaterial(atlas,Renderer2D.kAtlasBaseMateri=
al)
 		-- TODO : sort by z for blendout upper floors
 		local spritecount =3D table.getn(group)
 		local x,y,z =3D gCurrentRenderer:UOPosToLocal(block.bx*8,block.by*8,0)

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Tue Jul 29 02:36:58 2008
@@ -6,6 +6,8 @@
 -- RegisterListener("Hook_Bla",function (param) end)
 =

 Renderer2D =3D {}
+
+Renderer2D.kAtlasBaseMaterial =3D "renderer2dbillboard"
 =

 dofile(libpath .. "lib.2d.cam.lua")
 dofile(libpath .. "lib.2d.map.lua")

Modified: trunk/lua/lib.artatlas.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.artatlas.lua (original)
+++ trunk/lua/lib.artatlas.lua Tue Jul 29 02:36:58 2008
@@ -8,12 +8,12 @@
 gArtAtlasList =3D {}
 =

 =

--- returns sMatName,iWidth,iHeight,iCenterX,iCenterY,u0,v0,u1,v1 =3D ArtAt=
lasLoadAndLockDirect(iTileTypeID,iHue,pLockKeeper)
+-- returns sMatName,iWidth,iHeight,iCenterX,iCenterY,u0,v0,u1,v1 =3D ArtAt=
lasLoadAndLockDirect(iTileTypeID,iHue,pLockKeeper,basematerial)
 -- immediately load material, useful for dynamics
-function ArtAtlasLoadAndLockDirect (iTileTypeID,iHue,pLockKeeper)
+function ArtAtlasLoadAndLockDirect (iTileTypeID,iHue,pLockKeeper,basemater=
ial)
 	local o =3D ArtAtlasLoadAndLock(iTileTypeID,iHue,pLockKeeper)
 	if (not o) then return end
-	local sMatName =3D ArtAtlasLoadMaterial(o.atlas)
+	local sMatName =3D ArtAtlasLoadMaterial(o.atlas,basematerial)
 	local iCenterX,iCenterY =3D o.w/2,o.h-22
 	return sMatName,o.w,o.h,iCenterX,iCenterY,o.u0,o.v0,o.u1,o.v1
 end
@@ -107,7 +107,7 @@
 -- param : ArtAtlasLoadAndLock(...).atlas
 -- creates/updates texture/material as needed
 -- returns matname
-function ArtAtlasLoadMaterial (atlas) =

+function ArtAtlasLoadMaterial (atlas, basematerial) =

 	if (atlas.bIsDirty) then
 		--~ local startt =3D Client_GetTicks()
 		atlas.bIsDirty =3D false
@@ -120,7 +120,7 @@
 		--~ print("ArtAtlasLoadMaterial t:",startt2-startt)
 	end
 	if (not atlas.matname) then =

-		local matname =3D CloneMaterial("renderer2dbillboard")
+		local matname =3D CloneMaterial(basematerial)
 		SetTexture(matname,atlas.texname)
 		--~ SetSceneBlend(matname,0,0,0)
 		--~ SetDepthWriteEnabled(matname,0,0,1)

Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Tue Jul 29 02:36:58 2008
@@ -1,5 +1,10 @@
 -- used by lib.map.lua
 -- handles static models (walls, trees...)
+
+
+gStaticFallbackAtlasBaseMaterial =3D "staticfallbackatlas"
+
+
 =

 -- returns the model name with the given id
 -- TODO handle custom stuff?
@@ -122,7 +127,7 @@
 	end
 	=

 	-- TODO currently just ignores the art atlas lockkeeper
-	local sMatName,iWidth,iHeight,iCenterX,iCenterY,u0,v0,u1,v1 =3D ArtAtlasL=
oadAndLockDirect(iTileTypeID+0x4000,0,nil)
+	local sMatName,iWidth,iHeight,iCenterX,iCenterY,u0,v0,u1,v1 =3D ArtAtlasL=
oadAndLockDirect(iTileTypeID+0x4000,0,nil,gStaticFallbackAtlasBaseMaterial)
 	-- print("###", iTileTypeID, sMatName,iWidth,iHeight,iCenterX,iCenterY,u0=
,v0,u1,v1)
 	=

 	if not sMatName then return nil end



From no-reply at zwischenwelt.org  Tue Jul 29 14:36:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 29 Jul 2008 12:36:25 -0000
Subject: [Iris-commit] [IRIS] r2323 - in /trunk: data/config.lua.dist
 lua/lib.2d.renderer.lua lua/lib.3d.combat.lua lua/lib.uodragdrop.lua
 lua/obj/obj.mobile.lua
Message-ID: <20080729130011.4726B1C18527@zwischenwelt.org>

Author: hagish
Date: Tue Jul 29 14:36:25 2008
New Revision: 2323

Log:
its possible to display mana changes like the hp changes.

Modified:
    trunk/data/config.lua.dist
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.3d.combat.lua
    trunk/lua/lib.uodragdrop.lua
    trunk/lua/obj/obj.mobile.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Tue Jul 29 14:36:25 2008
@@ -512,3 +512,5 @@
 gUseCaelumSkysystem =3D false
 =

 gUseCaduneTree =3D false
+
+gShow3DManaChanges =3D false

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Tue Jul 29 14:36:25 2008
@@ -134,7 +134,8 @@
 function Renderer2D:MousePick					() end
 function Renderer2D:UpdateTrackingArrow			(...) end -- tracking skill, not=
 yet implemented
 function Renderer2D:NotifyDamage				(olddamage_serial,olddamage_amount) end
-function Renderer2D:NotifyHPChange				(serial, old, curvalue) end
+function Renderer2D:NotifyHPChange				(mobile, value) end
+function Renderer2D:NotifyManaChange			(mobile, value) end
 function Renderer2D:NotifyPlayerTeleported		() end
 function Renderer2D:BlendOutLayersAbovePlayer	() end
 function Renderer2D:ClearMapCache				() self:MapClear() end

Modified: trunk/lua/lib.3d.combat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.combat.lua (original)
+++ trunk/lua/lib.3d.combat.lua Tue Jul 29 14:36:25 2008
@@ -54,18 +54,44 @@
 end
 =

 -- helper to plop hp adds
-function Renderer3D:NotifyHPChange (serial, oldhp, newhp)
-	local mobile =3D GetMobile(serial)
-	if mobile and oldhp and newhp then
+function Renderer3D:NotifyHPChange (mobile, value)
+	if mobile and value then
+		local old =3D value
+		if mobile.old_value_hp_change then old =3D mobile.old_value_hp_change end
+		=

 		local r,g,b,a =3D 0.0, 0.0, 0.0, 0.8
 		local size =3D 0.25
 		local speed =3D 0.1
 		local lifetime =3D 1.5
+
 		-- hp change, d<0 means damage, d>0 hp gain
-		local d =3D newhp - oldhp
+		local d =3D value - old
+		mobile.old_value_hp_change  =3D value
+
 		if (d =3D=3D 0.0) then return end
 		if (d < 0.0) then r =3D 1.0 else g =3D 1.0 end
+
 		Renderer3D:CombatCreateDamageText(math.abs(d), mobile.xloc, mobile.yloc,=
 mobile.zloc, r, g, b, a, size, speed, lifetime)
+	end
+end
+
+-- helper to plop mana changes
+function Renderer3D:NotifyManaChange (mobile, value)
+	if gShow3DManaChanges and mobile and value then
+		local old =3D value
+		if mobile.old_value_mana_change then old =3D mobile.old_value_mana_chang=
e end
+		=

+		local r,g,b,a =3D 0.0, 0.0, 1.0, 0.8
+		local size =3D 0.15
+		local speed =3D 0.1
+		local lifetime =3D 1.5
+		local d =3D value - old
+
+		mobile.old_value_mana_change =3D value
+
+		if (d =3D=3D 0.0) then return end
+
+		Renderer3D:CombatCreateDamageText(d, mobile.xloc, mobile.yloc, mobile.zl=
oc, r, g, b, a, size, speed, lifetime)
 	end
 end
 =


Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Tue Jul 29 14:36:25 2008
@@ -263,7 +263,7 @@
 end
 =

 function StartUODragDrop ()
-	GuiAddChatLine("dragdrop : start")
+	--~ GuiAddChatLine("dragdrop : start")
 	gDragDrop.started =3D true
 	if (gDragDrop.widget and gDragDrop.widget:IsAlive()) then gDragDrop.widge=
t.gfx:SetVisible(false) end
 	SetDragIcon(gDragDrop.matname,gDragDrop.w,gDragDrop.h,gDragDrop.offx,gDra=
gDrop.offy)

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Tue Jul 29 14:36:25 2008
@@ -112,6 +112,7 @@
 -- updates mobile status, and the position of the graphical representation=
 and other things
 function gMobilePrototype:Update (mobiledata,equipmentdata)
 	if (self.bDestructionInProgress) then return end -- avoid updates during =
destruction
+	=

 	if (mobiledata) then for k,v in pairs(mobiledata) do self[k] =3D v end end
 	self:UpdateFlags()
 	=

@@ -126,7 +127,9 @@
 		if (self.serial =3D=3D gPlayerBodySerial) then
 			-- for player
 			SetHitpoints(self.stats.curHits/self.stats.maxHits)
-			if (self.stats.curMana)		then SetMana(	self.stats.curMana		/self.stats.=
maxMana		) end
+			if (self.stats.curMana)		then =

+				SetMana(	self.stats.curMana		/self.stats.maxMana		) =

+			end
 			if (self.stats.curStamina)	then SetStamina(self.stats.curStamina	/self.=
stats.maxStamina	) end
 			-- update big_stats window
 			UpdateStatusAos()
@@ -211,7 +214,7 @@
 	self:NotifyListener("Mobile_UpdateStats")
 	-- not needed due to normal damage packet
 	-- TODO is this ok for every server?
-	-- gCurrentRenderer:NotifyHPChange(self.serial, oldhp, mobile.stats.curHi=
ts)
+	-- gCurrentRenderer:NotifyHPChange(self, mobile.stats.curHits)
 	=

 	if (self.serial =3D=3D gPlayerBodySerial) then
 		local last_value =3D oldstats.str
@@ -245,7 +248,7 @@
 		if self.stats.curHits then
 			-- if there was a change, plop a text
 			local old =3D self.stats.curHits
-			gCurrentRenderer:NotifyHPChange(self.serial, old, curvalue)
+			gCurrentRenderer:NotifyHPChange(self, curvalue)
 		end
 		-- update values
 		self.stats.curHits =3D curvalue
@@ -259,6 +262,13 @@
 function gMobilePrototype:UpdateMana (curvalue,maxvalue)
 	if (self and self.stats) then
 		-- update values
+		=

+		if self.stats.curMana then
+			-- if there was a change, plop a text
+			local old =3D self.stats.curMana
+			gCurrentRenderer:NotifyManaChange(self, curvalue)
+		end
+
 		self.stats.curMana =3D curvalue
 		self.stats.maxMana =3D maxvalue
 =




From no-reply at zwischenwelt.org  Tue Jul 29 19:48:16 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 29 Jul 2008 17:48:16 -0000
Subject: [Iris-commit] [IRIS] r2324 - in /trunk: bin/iris2.exe
 data/config.lua.dist data/models/materials/textures.material
 lua/lib.3d.renderer.lua lua/net/net.world.lua
Message-ID: <20080729180003.1AB041C1852F@zwischenwelt.org>

Author: sience
Date: Tue Jul 29 19:48:15 2008
New Revision: 2324

Log:
-lights activated as standard (for caelum needed)
-new win32 binary
-caelum time is now server time :) (date is local date) (we have to build i=
n lightchange and Seasons!)
-material updated

Modified:
    trunk/bin/iris2.exe
    trunk/data/config.lua.dist
    trunk/data/models/materials/textures.material
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/net/net.world.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Tue Jul 29 19:48:15 2008
@@ -323,8 +323,8 @@
 gDynamicsCastShadows =3D true
 gMobileCastShadows =3D true
 =

--- activates Lightsources
-gLightsources =3D false
+-- activates Lightsources (lights are needed when using caelum)
+gLightsources =3D true
 gLightsCastShadows =3D false
 gShowLightDebug =3D false
 =


Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Tue Jul 29 19:48:15 2008
@@ -54,8 +54,8 @@
 	{
 		pass Decal
 		{
+			scene_blend alpha_blend
 //			alpha_rejection greater_equal 128
-			scene_blend alpha_blend
 			depth_write off
 			depth_check on
 			=

@@ -5636,9 +5636,6 @@
 		{
 			ambient vertexcolour
 			diffuse vertexcolour
-//			ambient 0.5 0.2 0.2
-//			diffuse 1 0 0
-//			specular 1 0.8 0.8 15
 =

 			texture_unit =

 			{ =


Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Tue Jul 29 19:48:15 2008
@@ -160,6 +160,7 @@
 		=

 		    -- Sunrise with visible moon.
 		    local cl =3D gCaelumSystem:GetUniversalClock()
+		    --number year, number month, number day, number hour, number minute,=
 number second
 		    cl:SetGregorianDateTime(2007, 4, 9, 9, 33, 10)
 		    --~ cl:SetTimeScale(2500)
 		    --~ cl:SetTimeScale(512)
@@ -195,6 +196,17 @@
 	end
 end
 =

+function Renderer3D:UpdateMapEnvironment (hour,minute,second)
+	if (gUseCaelumSkysystem) then
+	    -- Sunrise with visible moon.
+	   local cl =3D gCaelumSystem:GetUniversalClock()
+	   --number year, number month, number day, number hour, number minute, n=
umber second
+	   =

+	   local t =3D os.date('*t')
+	   cl:SetGregorianDateTime(t.year or 2007, t.month or 4, t.day or 9, hour=
 or t.hour, minute or t.min, second or t.sec)
+	end
+end
+
 gBuildStencilShadowEdgeList =3D false
 function Renderer3D:SetupShadows ()
 	local shadowfardist=3D5*gSightRange+gFogValue
@@ -205,7 +217,7 @@
 		--OgreShadowTechnique(gShadowTechnique)
 		--gBuildStencilShadowEdgeList=3Dtrue
 	elseif ((gShadowTechnique =3D=3D "texture_modulative") or (gShadowTechniq=
ue =3D=3D "texture_additive")) then
-		OgreSetShadowTextureCount(4)				-- first mention the count (one texture =
for one lightsource)
+		OgreSetShadowTextureCount(5)				-- first mention the count (one texture =
for one lightsource)
 		OgreSetShadowTextureSize(1024)				-- then the texsize
 		OgreSetShadowFarDistance(shadowfardist)
 		OgreSetShadowTextureFadeStart(0.6)

Modified: trunk/lua/net/net.world.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.world.lua (original)
+++ trunk/lua/net/net.world.lua Tue Jul 29 19:48:15 2008
@@ -42,6 +42,9 @@
 	local minute =3D input:PopNetUint8()
 	local second =3D input:PopNetUint8()
 	printdebug("net",sprintf("NET (todo): Game_Time id: %i Hour: %i Min: %i S=
ec: %i\n",id, hour, minute, second))
+	=

+	-- set Caelum Date
+	gCurrentRenderer:UpdateMapEnvironment(hour,minute,second)
 end
 =

 function gPacketHandler.kPacket_Logout()



From no-reply at zwischenwelt.org  Tue Jul 29 19:58:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 29 Jul 2008 17:58:54 -0000
Subject: [Iris-commit] [IRIS] r2325 - /trunk/lua/lib.3d.renderer.lua
Message-ID: <20080729180003.292F51C18556@zwischenwelt.org>

Author: sience
Date: Tue Jul 29 19:58:54 2008
New Revision: 2325

Log:
-Caelum deinit added

Modified:
    trunk/lua/lib.3d.renderer.lua

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Tue Jul 29 19:58:54 2008
@@ -267,7 +267,7 @@
 	-- for 2D/3D renderer switching
 	self.gbActive =3D true
 =

-	-- disable Worldlight only when Caelum is enabled
+	-- only Worldlight when Caelum is disabled
 	if (not(gUseCaelumSkysystem)) then
 		-- initialize Worldlight for normal SkyBox=C2=B4
 		SetupWorldLight_Default()
@@ -288,6 +288,8 @@
 	self:ClearMapCache()
 	Client_SetFog()
 	Client_SetSkybox()
+	-- DeInit Caelum here
+	gCaelumSystem:Shutdown()
 	self.gbActive =3D false
 end
 =




From no-reply at zwischenwelt.org  Tue Jul 29 20:00:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 29 Jul 2008 18:00:53 -0000
Subject: [Iris-commit] [IRIS] r2326 - /trunk/lua/lib.2d.renderer.lua
Message-ID: <20080729180053.777241C18050@zwischenwelt.org>

Author: sience
Date: Tue Jul 29 20:00:51 2008
New Revision: 2326

Log:
-2d dummy function UpdateMapEnvironment added

Modified:
    trunk/lua/lib.2d.renderer.lua

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Tue Jul 29 20:00:51 2008
@@ -108,8 +108,9 @@
 function Renderer2D:SetMapEnvironment			() =

 	GetMainViewport():SetBackCol(0,0,0)
 	Client_SetSkybox()
-	=

 end
+
+function Renderer2D:UpdateMapEnvironment (hour,minute,second) end -- updat=
e time, lightscale and season
 =

 function Renderer2D:SetLastConfirmedUOPos(xloc,yloc,zloc) end -- walk
 function Renderer2D:SetLastRequestedUOPos(xloc,yloc,zloc) end -- walk



From no-reply at zwischenwelt.org  Tue Jul 29 20:28:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 29 Jul 2008 18:28:44 -0000
Subject: [Iris-commit] [IRIS] r2327 - /trunk/lua/lib.3d.renderer.lua
Message-ID: <20080729182844.5C0461C1852D@zwischenwelt.org>

Author: sience
Date: Tue Jul 29 20:28:43 2008
New Revision: 2327

Log:
-clouds are now visible

Modified:
    trunk/lua/lib.3d.renderer.lua

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Tue Jul 29 20:28:43 2008
@@ -124,7 +124,7 @@
 			)
 			=

 			gCaelumSystem:SetManageSceneFog(true)
-			gCaelumSystem:SetSceneFogDensityMultiplier(0.0015)
+			gCaelumSystem:SetSceneFogDensityMultiplier(0.0115)
 			gCaelumSystem:SetManageAmbientLight(true)
 			=

 			local sun =3D gCaelumSystem:GetSun()
@@ -147,7 +147,7 @@
 			local clouds =3D gCaelumSystem:GetCloudSystem()
 		    if clouds then
 		    	--~ print("CLOUDS")
-		        clouds:CreateLayerAtHeight(5000)
+		        clouds:CreateLayerAtHeight(120)
 		        clouds:GetLayer(0):SetCloudSpeed(0.000005, -0.000009)
 		        clouds:GetLayer(1):SetCloudSpeed(0.0000045, -0.0000085)
 		    end



From no-reply at zwischenwelt.org  Wed Jul 30 00:18:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 29 Jul 2008 22:18:49 -0000
Subject: [Iris-commit] [IRIS] r2328 - in /trunk/data: config.lua.dist
 profiles/gfx_high.lua profiles/gfx_med.lua profiles/gfx_ultrahigh.lua
Message-ID: <20080729230008.8C3091524036@zwischenwelt.org>

Author: sience
Date: Wed Jul 30 00:18:49 2008
New Revision: 2328

Log:
-some profile optimizations

Modified:
    trunk/data/config.lua.dist
    trunk/data/profiles/gfx_high.lua
    trunk/data/profiles/gfx_med.lua
    trunk/data/profiles/gfx_ultrahigh.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Wed Jul 30 00:18:49 2008
@@ -505,7 +505,7 @@
 gMarkFile =3D "../data/uoam/mark.uoam"
 =

 -- experimental code for faster diagonal movement (tries to avoid stair ef=
fect)
-gTileFreeWalkDiagonalOptimization =3D false
+gTileFreeWalkDiagonalOptimization =3D true
 =

 gUseStaticFallbacks =3D true
 =


Modified: trunk/data/profiles/gfx_high.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/profiles/gfx_high.lua (original)
+++ trunk/data/profiles/gfx_high.lua Wed Jul 30 00:18:49 2008
@@ -7,6 +7,8 @@
 gDynamicsCastShadows =3D true
 gMobileCastShadows =3D true
 =

+gUseCaelumSkysystem =3D true
+
 gSightRange	=3D 6
 =

 -- update the map not every frame, decrease for free-flight-videos

Modified: trunk/data/profiles/gfx_med.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/profiles/gfx_med.lua (original)
+++ trunk/data/profiles/gfx_med.lua Wed Jul 30 00:18:49 2008
@@ -9,3 +9,5 @@
 gMobileCastShadows =3D false
 =

 gSightRange	=3D 4
+
+gUseStaticFallbacks =3D false

Modified: trunk/data/profiles/gfx_ultrahigh.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/profiles/gfx_ultrahigh.lua (original)
+++ trunk/data/profiles/gfx_ultrahigh.lua Wed Jul 30 00:18:49 2008
@@ -7,17 +7,23 @@
 gDynamicsCastShadows =3D true
 gMobileCastShadows =3D true
 =

-gUseHumanSkinShader =3D true -- currently doesn't work
+gUseCaelumSkysystem =3D true
 =

 gSightRange	=3D 8
---gEnableLowDetailTerrainFarSight =3D true
---gEnableLowDetailTerrainFarSightRangeAdd =3D 2
 =

 -- update the map not every frame, decrease for free-flight-videos
 Renderer3D.gMapUpdateInterval =3D 20
 -- increase for free-flight-videos
 Renderer3D.gMaxMapBlocksLoadedPerUpdate =3D 2
 =

-gPreloadStaticMesh =3D true
+gArtMapLoaderType	=3D "FullFile"
 =

-gArtMapLoaderType	=3D "FullFile"
+-- currently doesn't work
+--gUseHumanSkinShader =3D true
+
+-- currently doesn't work
+--gEnableLowDetailTerrainFarSight =3D true
+--gEnableLowDetailTerrainFarSightRangeAdd =3D 2
+
+-- currently doesn't work because of gUseStaticFallbacks
+--gPreloadStaticMesh =3D true



From no-reply at zwischenwelt.org  Wed Jul 30 13:21:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 30 Jul 2008 11:21:54 -0000
Subject: [Iris-commit] [IRIS] r2329 - /trunk/lua/lib.3d.cam.lua
Message-ID: <20080730112154.324501C1857B@zwischenwelt.org>

Author: hagish
Date: Wed Jul 30 13:21:53 2008
New Revision: 2329

Log:
45 degree cam movement (3d, 3rd person cam) with numpad, 5 to reset 3rd per=
son cam

Modified:
    trunk/lua/lib.3d.cam.lua

Modified: trunk/lua/lib.3d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.cam.lua (original)
+++ trunk/lua/lib.3d.cam.lua Wed Jul 30 13:21:53 2008
@@ -15,6 +15,13 @@
 Renderer3D.gCamKeyCode.Down	=3D GetNamedKey("f")
 Renderer3D.gCamKeyCode.Slow	=3D GetNamedKey("lshift")
 Renderer3D.gCamKeyCode.Fast	=3D GetNamedKey("lalt")
+
+Renderer3D.gCamKeyCode.CamCenter		=3D GetNamedKey("np5")
+Renderer3D.gCamKeyCode.CamRotateLeft	=3D GetNamedKey("np4")
+Renderer3D.gCamKeyCode.CamRotateRight	=3D GetNamedKey("np6")
+Renderer3D.gCamKeyCode.CamRotateUp		=3D GetNamedKey("np8")
+Renderer3D.gCamKeyCode.CamRotateDown	=3D GetNamedKey("np2")
+
 Renderer3D.gCamKeyName =3D {}
 for k,v in pairs(Renderer3D.gCamKeyCode) do Renderer3D.gCamKeyName[v] =3D =
k end
 Renderer3D.gCamKeyDown =3D {}
@@ -53,6 +60,32 @@
 		if (camkeyname) then self.gCamKeyDown[camkeyname] =3D true end
 		--printf("CamKeyDown(%s)\n",GetKeyName(key))
 		-- key_mouse1
+	end
+	=

+	=

+	local lrd =3D 0.25*kPi
+	local udd =3D 0.25*kPi/2
+	-- 45 degree cam rotations
+	if key =3D=3D self.gCamKeyCode.CamCenter then
+		self.gfCamAngH =3D -3*0.25*kPi  -- default to original iso angle
+		self.gfCamAngV =3D -0.25*kPi
+		self:CamApplyAngHV()
+	end
+	if key =3D=3D self.gCamKeyCode.CamRotateLeft then
+		self.gfCamAngH =3D self.gfCamAngH - lrd
+		self:CamApplyAngHV()
+	end
+	if key =3D=3D self.gCamKeyCode.CamRotateRight then
+		self.gfCamAngH =3D self.gfCamAngH + lrd
+		self:CamApplyAngHV()
+	end
+	if key =3D=3D self.gCamKeyCode.CamRotateUp then
+		self.gfCamAngV =3D self.gfCamAngV - udd
+		self:CamApplyAngHV()
+	end
+	if key =3D=3D self.gCamKeyCode.CamRotateDown then
+		self.gfCamAngV =3D self.gfCamAngV + udd
+		self:CamApplyAngHV()
 	end
 end
 =




From no-reply at zwischenwelt.org  Wed Jul 30 16:08:23 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 30 Jul 2008 14:08:23 -0000
Subject: [Iris-commit] [IRIS] r2330 - in /trunk: data/config.lua.dist
 lua/lib.3d.dynamic.lua lua/net/net.corpse.lua lua/net/net.mobile.lua
Message-ID: <20080730140823.A35351C1805A@zwischenwelt.org>

Author: hagish
Date: Wed Jul 30 16:08:23 2008
New Revision: 2330

Log:
random corpse rotation

Modified:
    trunk/data/config.lua.dist
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/net/net.corpse.lua
    trunk/lua/net/net.mobile.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Wed Jul 30 16:08:23 2008
@@ -280,6 +280,7 @@
 gDebugCategories.equip		=3D false
 gDebugCategories.effect		=3D false
 gDebugCategories.dragdrop	=3D false
+gDebugCategories.corpse		=3D false
 =

 gLogPackets =3D false
 =


Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Wed Jul 30 16:08:23 2008
@@ -126,8 +126,18 @@
 	end
 end
 =

-function Renderer3D:UpdateDynamicItemPos ( dynamic )
-	if (dynamic.gfx) then dynamic.gfx:SetPosition(self:UOPosToLocal(dynamic.x=
loc + dynamic.xadd,dynamic.yloc + dynamic.yadd,dynamic.zloc * 0.1 + dynamic=
.zadd)) end	=

+function Renderer3D:UpdateDynamicItemPos ( dynamic, randomRotation )
+	if (dynamic.gfx) then =

+		dynamic.gfx:SetPosition(self:UOPosToLocal(dynamic.xloc + dynamic.xadd,dy=
namic.yloc + dynamic.yadd,dynamic.zloc * 0.1 + dynamic.zadd)) =

+		=

+		if randomRotation then
+			local x,y,z =3D dynamic.gfx:GetPosition()
+			local r =3D math.mod(math.floor(math.abs(x)+math.abs(y)+math.abs(z)) * =
10,360)
+			print("####",x,y,z,r)
+			dynamic.gfx:SetOrientation( QuaternionFromString("x:0,y:0,z:"..r) )
+		end
+		=

+	end	=

 end
 =

 function Renderer3D:UpdateDynamicVisibility	(dynamic) =

@@ -342,7 +352,7 @@
 	local bCorpseGFX =3D false
 	if (bCorpse) then
 		-- corpse
-		-- print("CORPSECODE,CreateDynamicGfx corpse",item.amount)
+		printdebug("corpse","CreateDynamicGfx corpse",item.amount)
 		bCorpseGFX =3D true
 		=

 		local bodyid =3D item.amount
@@ -362,7 +372,7 @@
 		=

 		item.gfx:SetRenderingDistance(self.gDynamicMaxRenderDist)
 		-- set's position and add's xadd,yadd,zadd corrections
-		self:UpdateDynamicItemPos(item)
+		self:UpdateDynamicItemPos(item, true)
 		-- updates the layer-visibility
 		self:UpdateDynamicVisibility(item)
 	end

Modified: trunk/lua/net/net.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.corpse.lua (original)
+++ trunk/lua/net/net.corpse.lua Wed Jul 30 16:08:23 2008
@@ -29,15 +29,14 @@
 	local container_serial =3D input:PopNetUint32()
 =

 	printdebug("equip",sprintf("NET: kPacket_Corpse_Equipment: blocksize: %i =
container_serial=3D0x%08x\n",blocksize,container_serial))
-
 	=

 	blocksize=3Dblocksize-7
 	=

-	print("CORPSECODE,kPacket_Corpse_Equipment",(blocksize - 1)/5)
+	printdebug("corpse","CORPSECODE,kPacket_Corpse_Equipment",(blocksize - 1)=
/5)
 	while (blocksize >=3D 5) do
 		local item_layer =3D input:PopNetUint8()
 		local item_serial =3D input:PopNetUint32()
-		print("CORPSECODE,kPacket_Corpse_Equipment + ",item_layer,item_serial)
+		printdebug("corpse","CORPSECODE,kPacket_Corpse_Equipment + ",item_layer,=
item_serial)
 		printdebug("equip",sprintf("NET: kPacket_Corpse_Equipment_Items: item_la=
yer: %i item_serial=3D0x%08x\n",item_layer,item_serial))
 		blocksize=3Dblocksize-5
 	end
@@ -54,7 +53,7 @@
 	local player_serial =3D input:PopNetUint32()
 	local corpse_serial =3D input:PopNetUint32()
 	local terminator =3D input:PopNetUint32()
-	print("CORPSECODE,kPacket_Death_Animation",player_serial,corpse_serial,te=
rminator)
+	printdebug("corpse","CORPSECODE,kPacket_Death_Animation",player_serial,co=
rpse_serial,terminator)
 	printdebug("animation",sprintf("NET: kPacket_Death_Animation: player_seri=
al: 0x%08x corpse_serial=3D0x%08x\n",player_serial,corpse_serial))
 	=

 	-- TODO : really hide the mobile for a sec or so, as an naked-mob ubdate =
packet arrives in the same frame and it's not destroyed

Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Wed Jul 30 16:08:23 2008
@@ -15,7 +15,7 @@
 	mobiledata.notoriety	=3D input:PopNetUint8()
 	=

 	if (mobiledata.serial =3D=3D 0x001b5369) then
-		print("CORPSECODE kPacket_Naked_MOB",mobiledata.artid,mobiledata.flag,mo=
biledata.notoriety)
+		printdebug("corpse","CORPSECODE kPacket_Naked_MOB",mobiledata.artid,mobi=
ledata.flag,mobiledata.notoriety)
 	end
 	=

 	CreateOrUpdateMobile(mobiledata)



From no-reply at zwischenwelt.org  Wed Jul 30 17:42:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 30 Jul 2008 15:42:35 -0000
Subject: [Iris-commit] [IRIS] r2331 - in /trunk:
 data/particles/particles/Fields.particle lua/lib.3d.dynamic.lua
 lua/lib.3d.map.lua lua/lib.3d.renderer.lua
Message-ID: <20080730154235.4FC0D1C1857B@zwischenwelt.org>

Author: hagish
Date: Wed Jul 30 17:42:34 2008
New Revision: 2331

Log:
added particle effect to moongate

Modified:
    trunk/data/particles/particles/Fields.particle
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.renderer.lua

Modified: trunk/data/particles/particles/Fields.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/Fields.particle (original)
+++ trunk/data/particles/particles/Fields.particle Wed Jul 30 17:42:34 2008
@@ -140,3 +140,70 @@
 	}
 }
 =

+
+Moongate
+{
+	quota	100
+	material	Particles/FlarePointSprite
+	particle_width	1
+	particle_height	1
+	cull_each	false
+	renderer	billboard
+	sorted	false
+	local_space	false
+	iteration_interval	0
+	nonvisible_update_timeout	0
+	billboard_type	point
+	billboard_origin	center
+	billboard_rotation_type	texcoord
+	common_up_vector	0 1 0
+	point_rendering	false
+	accurate_facing	false
+
+	emitter Point
+	{
+		angle	180
+		colour	0 0 1 1
+		colour_range_start	0 0 1 1
+		colour_range_end	0.501961 0 1 1
+		direction	0 -1 0
+		emission_rate	10
+		position	0 0 0
+		velocity	1
+		velocity_min	1
+		velocity_max	1
+		time_to_live	3
+		time_to_live_min	3
+		time_to_live_max	3
+		duration	0
+		duration_min	0
+		duration_max	0
+		repeat_delay	0
+		repeat_delay_min	0
+		repeat_delay_max	0
+	}
+
+	emitter Point
+	{
+		angle	180
+		colour	1 1 1 1
+		colour_range_start	1 1 1 1
+		colour_range_end	1 0 0.501961 1
+		direction	0 -1 0
+		emission_rate	10
+		position	0 0 0
+		velocity	0.2
+		velocity_min	0.2
+		velocity_max	0.5
+		time_to_live	1
+		time_to_live_min	1
+		time_to_live_max	1
+		duration	0
+		duration_min	0
+		duration_max	0
+		repeat_delay	0
+		repeat_delay_min	0
+		repeat_delay_max	0
+	}
+}
+

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Wed Jul 30 17:42:34 2008
@@ -516,13 +516,18 @@
 		end
 	end
 =

+	local arrtiletype =3D GetStaticTileType(item.artid)
+
 	-- creates a light if lights are enabled and static is a lightsource
 	if (gLightsources) then
-		local arrtiletype =3D GetStaticTileType(item.artid)
 		if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Light=
Source) ) then
 			local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc+=
arrtiletype.miHeight) * 0.1)
 			item.lightname =3D Renderer3D:AddPointLight(x,y,z, 0.3,0.3,0.2, 0.3,0.3=
,0.2, 5.0,0.1,0.1,0.0)
 		end
+	end
+	=

+	if arrtiletype then =

+		item.particle =3D Renderer3D:Hook_ItemAddParticle(item.artid, Renderer3D=
:UOPosToLocal(item.xloc,item.yloc,(item.zloc+arrtiletype.miHeight) * 0.1))
 	end
 end
 =

@@ -701,6 +706,9 @@
 	=

 	-- remove lightsource from dynamic
 	if (dynamic.lightname) then Renderer3D:RemovePointLight(dynamic.lightname=
) dynamic.lightname =3D nil end
+	=

+	-- remove particle system
+	if (dynamic.particle and dynamic.particle:IsAlive()) then dynamic.particl=
e:Destroy() dynamic.particle =3D nil end
 =

 	-- remove corpsegfx entry
 	if (dynamic.corpsegfx) then

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Wed Jul 30 17:42:34 2008
@@ -370,6 +370,7 @@
 =

 	self:UpdateStaticVisibility(entity)
 =

+	entity.particle =3D Renderer3D:Hook_ItemAddParticle(iTileTypeID, entity.x=
,entity.y,entity.z)
 end
 =

 -- coords in chunks
@@ -767,6 +768,7 @@
 		if (chunk.pTerrainEntity) then chunk.pTerrainEntity:Destroy() chunk.pTer=
rainEntity =3D nil end
 		for k,v in pairs(chunk.lStaticEntities) do
 			if (v.lightname) then Renderer3D:RemovePointLight(v.lightname) v.lightn=
ame =3D nil end
+			if (v.particle and v.particle:IsAlive()) then v.particle:Destroy() v.pa=
rticle =3D nil end
 			if (v.staticentity) then v.staticentity:Destroy() v.staticentity =3D ni=
l end
 			if (v.gfx and v.gfx.billboard) then v.gfx.billboard:Destroy() v.gfx.bil=
lboard =3D nil end
 			if (v.gfx) then v.gfx:Destroy() v.gfx =3D nil end

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Jul 30 17:42:34 2008
@@ -320,6 +320,22 @@
 	return name
 end
 =

+-- hook to add artid based particle effects
+function Renderer3D:Hook_ItemAddParticle	(artid, x, y, z)
+	-- moongate
+	if artid =3D=3D 3948 then
+		local gfx =3D CreateRootGfx3D()
+		gfx:SetParticleSystem("Moongate")
+		gfx:SetPosition(x-0.5,y+0.5,z+1.5)
+		gfx:SetRenderingDistance(self.gDynamicMaxRenderDist)
+		gfx:SetScale( 1, 1, 1)
+		gfx:SetNormaliseNormals(true)
+		return gfx
+	end
+	=

+	return nil
+end
+
 function Renderer3D:RemovePointLight	(name)
 	Client_RemoveLight(name)
 	=




From no-reply at zwischenwelt.org  Wed Jul 30 21:24:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 30 Jul 2008 19:24:49 -0000
Subject: [Iris-commit] [IRIS] r2332 - in /trunk: bin/iris2.exe
 lua/lib.2d.renderer.lua lua/lib.3d.map.lua lua/lib.3d.renderer.lua
 lua/lib.loading.lua lua/lib.mainmenu.lua lua/main.lua
Message-ID: <20080730192450.214A81524030@zwischenwelt.org>

Author: sience
Date: Wed Jul 30 21:24:49 2008
New Revision: 2332

Log:
-renderer Init(), DeInit(), StartInGame(), StopInGame() cleaned and adjuste=
d for seperate Mainmenu and 2d renderer
-new win32 binary
-2d mainmenu is now black because of no 2d sky
-3d mainmenu has now caleum without shaders (shaderoption later)

Modified:
    trunk/bin/iris2.exe
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/main.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Wed Jul 30 21:24:49 2008
@@ -20,32 +20,42 @@
 	RegisterListener("Hook_MainWindowResized",function () Renderer2D.gbNeedCo=
rrectAspectRatio =3D true end)
 	MultiTexTerrainInit()
 end
-	=

-
-function Renderer2D:StartInGame ()
-	-- initialize Worldlight for normal SkyBox
-	self:CamInit()
-	SetupWorldLight_Default()
-end
 =

 function Renderer2D:Init ()
 	self:FirstInit()
 	self.gbActive =3D true
+end
+
+function Renderer2D:DeInit ()
+	-- todo: unload MultiTexTerrainInit
+	self:StopInGame()
+	self.gbActive =3D false
+end
+
+-- called by main.lua
+function Renderer2D:StartInGame ()
+	Client_ClearLights()
 	=

 	-- for 2D/3D renderer switching
 	self:CamInit()
+	=

 	SetupWorldLight_Default()
 	=

+	-- initialize Mapenvironment
+	self:SetMapEnvironment()
+	-- initialize Worldlight
+	SetupWorldLight_Default()
+
 	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
 	for k,mobile in pairs(GetMobileList()) do self:UpdateMobile(mobile) end
 end
 =

-function Renderer2D:DeInit							() =

-	self.gbActive =3D false
+function Renderer3D:StopInGame ()
+	Client_ClearLights()
 end
 =

 -- called from mainstep while ingame
-function Renderer2D:MainStep	()
+function Renderer2D:MainStep ()
 	self:CamStep()
 	self:MapStep()
 	self:MobileAnimStep()
@@ -105,9 +115,8 @@
 =

 =

 -- skybox,fog etc for 3d
-function Renderer2D:SetMapEnvironment			() =

+function Renderer2D:SetMapEnvironment () =

 	GetMainViewport():SetBackCol(0,0,0)
-	Client_SetSkybox()
 end
 =

 function Renderer2D:UpdateMapEnvironment (hour,minute,second) end -- updat=
e time, lightscale and season

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Wed Jul 30 21:24:49 2008
@@ -296,14 +296,7 @@
 		staticwatertile =3D not gEnableMultiTexTerrain		--on multitexturing filt=
er static water
 	end
 =

-	if gUseCaduneTree then
-		Renderer3D:GenerateCaduneTree(entity)
-	end
-
 	local meshname =3D (not gForceFallBackBillboards_Statics) and staticwater=
tile and GetMeshName(iTileTypeID)
-
-	-- TODO: does it really work? 	--build Edgelist for Stencil Shadows
-	--if (meshname and gBuildStencilShadowEdgeList) then print("edges generat=
ed") MeshBuildEdgeList(meshname) end
 =

 	-- create Mesh
 	if (meshname and meshname ~=3D false) then
@@ -359,7 +352,12 @@
 		end
 	end
 =

-	-- creates a light if lights are enabled and static is a lightsource
+	-- generate Cadune Trees
+	if gUseCaduneTree then
+		Renderer3D:GenerateCaduneTree(entity)
+	end
+	=

+	-- adds a lightsource to Mesh-Tile
 	-- note! lights don't cast shadows
 	if (gLightsources) then
 		local arrtiletype =3D GetStaticTileType(iTileTypeID)
@@ -370,6 +368,7 @@
 =

 	self:UpdateStaticVisibility(entity)
 =

+	-- adds particle Effect to Mesh-Tile
 	entity.particle =3D Renderer3D:Hook_ItemAddParticle(iTileTypeID, entity.x=
,entity.y,entity.z)
 end
 =

@@ -707,7 +706,7 @@
 	if (self.giBlendOutCurZ ~=3D myLayer or self.gbBlendOutTerrainVisible ~=
=3D bTerrainVisible) then
 		self.giBlendOutCurZ =3D myLayer
 	=

-		-- skybox not visible underground
+		-- todo: caelum ? skybox not visible underground
 		if (self.gbBlendOutTerrainVisible ~=3D bTerrainVisible) then
 			self:SetMapEnvironment(not bTerrainVisible)
 			self.gbBlendOutTerrainVisible =3D bTerrainVisible

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Jul 30 21:24:49 2008
@@ -12,7 +12,6 @@
 dofile(libpath .. "lib.3d.cam.lua")
 dofile(libpath .. "lib.3d.walksmooth.lua")
 =

-
 gRendererList[ "Renderer3d" ] =3D Renderer3D
 =

 -- static Factor to rise the Z-Level for statics+dynamics
@@ -22,12 +21,58 @@
 Renderer3D.gDynamicMaxRenderDist =3D 128 -- 0 means always rendered  -- TO=
DO : make this dependant on bounding sphere size, e.g. in pixel size ?
 Renderer3D.gDynamicZAdd =3D 0.2 -- add a bit to make sure all dynamics can=
 be clicked and none are below the floor, todo : improve this by detecting =
floor height and model bbox
 =

+function Renderer3D:FirstInit ()
+	if (self.bFirstInitDone) then return end
+	self.bFirstInitDone =3D true
+	-- load texture atlas
+	LoadTexAtlas()
+	MultiTexTerrainInit()
+	RegisterListener("Hook_MainWindowResized",function () Renderer3D.gbNeedCo=
rrectAspectRatio =3D true end)
+end
+
+function Renderer3D:Init ()
+	self:FirstInit()
+	self.gbActive =3D true
+end
+
+function Renderer3D:DeInit ()
+	-- todo: unload LoadTexAtlas
+	-- todo: unload MultiTexTerrainInit
+	self:StopInGame ()
+	self.gbActive =3D false
+end
+
+-- called by main.lua
+function Renderer3D:StartInGame ()
+	Client_ClearLights()
+
+	-- for 2D/3D renderer switching
+	self:CamInit()
+
+	-- initialize Shadowsystem
+	self:SetupShadows(gShadowTechnique)
+	-- initialize Mapenvironment
+	self:SetMapEnvironment()
+
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
+	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
+end
+
+function Renderer3D:StopInGame ()
+	--print("deactivating Renderer3D")
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:DestroyDynamicGfx(dynamic) end end
+	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
+	self:DeactivateMousePick()
+	Client_ClearLights()
+	self:ClearMapCache()
+	-- DeInit Caelum here
+	if (gCaelumSystem) then
+		gCaelumSystem:Shutdown()
+	end
+end
+
 function Renderer3D:SetOfflineStartPos (x,y,z)
 	gTileFreeWalk:SetPos_All(x+0.5,y+0.5,z) -- + for both might be wrong..
-end
-
-function Renderer3D:StartInGame () =

-	-- setup cam after menu ?
 end
 =

 function Renderer3D:MainStep	()
@@ -103,101 +148,91 @@
 	if (not self.gbActive) then return end
 	if (not gMapIndex) then return end
 =

-	if (gUseCaelumSkysystem) then
-		-- disable any normal SkyBox
+print("SetMapEnvironment")
+
+	-- black background when underground
+	if (bUnderGround) then
+		-- deinit Caelum first
+		if (gCaelumSystem) then
+			gCaelumSystem:Shutdown()
+		end
 		GetMainViewport():SetBackCol(0,0,0)
-		Client_SetSkybox()
-
-		if not(bUnderGround) then
-			-- check if already a caelum skysystem is there
-			if (gCaelumSystem) then return end
-
-			-- if not create a new Skysystem
-			gCaelumSystem =3D CreateCaelumCaelumSystem(
-				CAELUM_COMPONENT_SUN + =

-				CAELUM_COMPONENT_MOON +
-		        CAELUM_COMPONENT_SKY_DOME +
-		        CAELUM_COMPONENT_POINT_STARFIELD +
-		        CAELUM_COMPONENT_CLOUDS +
-		        CAELUM_COMPONENT_PRECIPITATION +
-		        0
-			)
+	else
+		-- check if already a caelum skysystem is there
+		if (gCaelumSystem) then return end
+
+		-- if not create a new Skysystem
+		gCaelumSystem =3D CreateCaelumCaelumSystem(
+			CAELUM_COMPONENT_SUN + =

+--			CAELUM_COMPONENT_MOON +
+	        CAELUM_COMPONENT_SKY_DOME +
+--	        CAELUM_COMPONENT_POINT_STARFIELD +
+			CAELUM_COMPONENT_IMAGE_STARFIELD +
+--	        CAELUM_COMPONENT_CLOUDS +
+	        CAELUM_COMPONENT_PRECIPITATION +
+	        0
+		)
 			=

-			gCaelumSystem:SetManageSceneFog(true)
-			gCaelumSystem:SetSceneFogDensityMultiplier(0.0115)
-			gCaelumSystem:SetManageAmbientLight(true)
+		gCaelumSystem:SetManageSceneFog(true)
+		gCaelumSystem:SetSceneFogDensityMultiplier(0.0115)
+		gCaelumSystem:SetManageAmbientLight(true)
 			=

-			local sun =3D gCaelumSystem:GetSun()
-		    if sun then
-		    	--~ print("SUN")
-		        sun:SetAmbientMultiplier(0.5, 0.5, 0.5, 1)
-		        sun:SetDiffuseMultiplier(3, 3, 2.7, 1)
-		        sun:SetSpecularMultiplier(5, 5, 5, 1)
-		        sun:SetAutoDisable(true)
-		        sun:SetAutoDisableThreshold(0.1)
-		    end
+		local sun =3D gCaelumSystem:GetSun()
+		if sun then
+			--~ print("SUN")
+			sun:SetAmbientMultiplier(0.5, 0.5, 0.5, 1)
+			sun:SetDiffuseMultiplier(3, 3, 2.7, 1)
+			sun:SetSpecularMultiplier(5, 5, 5, 1)
+			sun:SetAutoDisable(true)
+			sun:SetAutoDisableThreshold(0.1)
+		end
+--[[		=

+		local moon =3D gCaelumSystem:GetMoon()
+		if moon then
+			--~ print("MOON")
+			moon:SetAutoDisable(true)
+			moon:SetAutoDisableThreshold(0.1)
+		end
 		=

-			local moon =3D gCaelumSystem:GetMoon()
-		    if moon then
-		    	--~ print("MOON")
-		        moon:SetAutoDisable(true)
-		        moon:SetAutoDisableThreshold(0.1)
-		    end
+		local clouds =3D gCaelumSystem:GetCloudSystem()
+		if clouds then
+			--~ print("CLOUDS")
+			clouds:CreateLayerAtHeight(120)
+			clouds:GetLayer(0):SetCloudSpeed(0.000005, -0.000009)
+			clouds:GetLayer(1):SetCloudSpeed(0.0000045, -0.0000085)
+		end
+]]--
+		local prec =3D gCaelumSystem:GetPrecipitationController()
+		if prec then
+			--~ print("PREC")
+			prec:SetCoverage(0)
+		end
 		=

-			local clouds =3D gCaelumSystem:GetCloudSystem()
-		    if clouds then
-		    	--~ print("CLOUDS")
-		        clouds:CreateLayerAtHeight(120)
-		        clouds:GetLayer(0):SetCloudSpeed(0.000005, -0.000009)
-		        clouds:GetLayer(1):SetCloudSpeed(0.0000045, -0.0000085)
-		    end
-		=

-			local prec =3D gCaelumSystem:GetPrecipitationController()
-			if prec then
-		    	--~ print("PREC")
-			    prec:SetCoverage(0)
-		    end
-		=

-		    -- Sunrise with visible moon.
-		    local cl =3D gCaelumSystem:GetUniversalClock()
-		    --number year, number month, number day, number hour, number minute,=
 number second
-		    cl:SetGregorianDateTime(2007, 4, 9, 9, 33, 10)
-		    --~ cl:SetTimeScale(2500)
-		    --~ cl:SetTimeScale(512)
+		-- Sunrise with visible moon.
+		local cl =3D gCaelumSystem:GetUniversalClock()
+		--number year, number month, number day, number hour, number minute, num=
ber second
+		cl:SetGregorianDateTime(2007, 4, 9, 9, 33, 10)
+		--~ cl:SetTimeScale(2500)
+		--~ cl:SetTimeScale(512)
 		    =

-		    -- to prevent wobbly shadows
-		    -- updates clock and caelum every 30 sec
-		    cl:SetUpdateRate(30)
+		-- to prevent wobbly shadows
+		-- updates clock and caelum every 30 sec
+		cl:SetUpdateRate(30)
 		    =

-			function rotate(gfx,w,x,y,z)
-				local ww,xx,yy,zz =3D gfx:GetOrientation()
-				gfx:SetOrientation(Quaternion.Mul(w,x,y,z, ww,xx,yy,zz))
-			end
+		function rotate(gfx,w,x,y,z)
+			local ww,xx,yy,zz =3D gfx:GetOrientation()
+			gfx:SetOrientation(Quaternion.Mul(w,x,y,z, ww,xx,yy,zz))
+		end
 			=

-			local w,x,y,z =3D Quaternion.fromAngleAxis(90 * gfDeg2Rad, 1,0,0)
-			rotate(gCaelumSystem:GetCaelumGroundNode(), w,x,y,z)
-			rotate(gCaelumSystem:GetCaelumCameraNode(), w,x,y,z)
-		end
-	else
-		-- black background when underground
-		if (bUnderGround) then
-			GetMainViewport():SetBackCol(0,0,0)
-			Client_SetSkybox()
-		else
-			Client_SetSkybox(gMaps[gMapIndex].skybox)
-		end
-		=

-		if (gUseDistanceFog) then
-			gFogcolorred			=3D gMaps[gMapIndex].fog_r
-			gFogcolorgreen			=3D gMaps[gMapIndex].fog_g
-			gFogcolorblue			=3D gMaps[gMapIndex].fog_b
-			Client_SetFog(3, gFogcolorred/255, gFogcolorgreen/255, gFogcolorblue/25=
5, 1.0, 0, 10*gSightRange, 10*gSightRange+gFogValue)
-		end
+		local w,x,y,z =3D Quaternion.fromAngleAxis(90 * gfDeg2Rad, 1,0,0)
+		rotate(gCaelumSystem:GetCaelumGroundNode(), w,x,y,z)
+		rotate(gCaelumSystem:GetCaelumCameraNode(), w,x,y,z)
 	end
 end
 =

 function Renderer3D:UpdateMapEnvironment (hour,minute,second)
-	if (gUseCaelumSkysystem) then
+print("UpdateMapEnvironment")
+	if (gCaelumSystem) then
 	    -- Sunrise with visible moon.
 	   local cl =3D gCaelumSystem:GetUniversalClock()
 	   --number year, number month, number day, number hour, number minute, n=
umber second
@@ -207,16 +242,14 @@
 	end
 end
 =

-gBuildStencilShadowEdgeList =3D false
-function Renderer3D:SetupShadows ()
-	local shadowfardist=3D5*gSightRange+gFogValue
-	print("ShadowTechnique used: "..gShadowTechnique)
-	if ((gShadowTechnique =3D=3D "stencil_modulative") or (gShadowTechnique =
=3D=3D "stencil_additive")) then
+function Renderer3D:SetupShadows (strShadowTechnique)
+	local shadowfardist=3D5*gSightRange+16
+
+	if ((strShadowTechnique =3D=3D "stencil_modulative") or (strShadowTechniq=
ue =3D=3D "stencil_additive")) then
 		----- currently doesn't work with Fastbatch
 		--OgreSetShadowFarDistance(shadowfardist)
-		--OgreShadowTechnique(gShadowTechnique)
-		--gBuildStencilShadowEdgeList=3Dtrue
-	elseif ((gShadowTechnique =3D=3D "texture_modulative") or (gShadowTechniq=
ue =3D=3D "texture_additive")) then
+		--OgreShadowTechnique(strShadowTechnique)
+	elseif ((strShadowTechnique =3D=3D "texture_modulative") or (strShadowTec=
hnique =3D=3D "texture_additive")) then
 		OgreSetShadowTextureCount(5)				-- first mention the count (one texture =
for one lightsource)
 		OgreSetShadowTextureSize(1024)				-- then the texsize
 		OgreSetShadowFarDistance(shadowfardist)
@@ -224,10 +257,10 @@
 		OgreSetShadowTextureFadeEnd(0.9)
 		OgreSetShadowCasterRenderBackFaces(false)
 		OgreSetShadowTextureSelfShadow(false)		-- doesn't work when using the fi=
xed function pipeline
-		OgreShadowTechnique(gShadowTechnique)		-- last, the technique
+		OgreShadowTechnique(strShadowTechnique)		-- last, the technique
 --mLiSPSMSetup =3D new LiSPSMShadowCameraSetup()
 --m_pSceneMgr->setShadowCameraSetup(ShadowCameraSetupPtr(mLiSPSMSetup))
-	elseif ((gShadowTechnique =3D=3D "texture_additive_integrated") or (gShad=
owTechnique =3D=3D "texture_modulative_integrated")) then
+	elseif ((strShadowTechnique =3D=3D "texture_additive_integrated") or (str=
ShadowTechnique =3D=3D "texture_modulative_integrated")) then
 		OgreSetShadowTextureCount(4)				-- first mention the count (one texture =
for one lightsource)
 		OgreSetShadowTextureSize(512)				-- then the texsize
 		OgreSetShadowFarDistance(shadowfardist)
@@ -238,10 +271,12 @@
 		OgreSetShadowTextureSelfShadow(true)
 		OgreSetShadowTextureCasterMaterial("DepthShadowmap/Caster/Float")
 		OgreSetShadowTextureReceiverMaterial("tex_base")
- 		OgreShadowTechnique(gShadowTechnique)		-- last, the technique
-	end
-end
-
+ 		OgreShadowTechnique(strShadowTechnique)		-- last, the technique
+	else
+		-- any other is like setting No shadows
+		OgreShadowTechnique(strShadowTechnique)
+	end
+end
 =

 function Renderer3D:CorrectAspectRatio ()
 	if (not Renderer3D.gbNeedCorrectAspectRatio) then return end
@@ -249,50 +284,6 @@
 	local vp =3D GetMainViewport()
 	GetMainCam():SetAspectRatio(vp:GetActualWidth() / vp:GetActualHeight())
 end
-
-function Renderer3D:FirstInit ()
-	if (self.bFirstInitDone) then return end
-	self.bFirstInitDone =3D true
-	-- load texture atlas
-	LoadTexAtlas()
-	MultiTexTerrainInit()
-	RegisterListener("Hook_MainWindowResized",function () Renderer3D.gbNeedCo=
rrectAspectRatio =3D true end)
-end
-
-	=

-function Renderer3D:Init()
-	self:FirstInit()
-	self:CamInit()
-	=

-	-- for 2D/3D renderer switching
-	self.gbActive =3D true
-
-	-- only Worldlight when Caelum is disabled
-	if (not(gUseCaelumSkysystem)) then
-		-- initialize Worldlight for normal SkyBox=C2=B4
-		SetupWorldLight_Default()
-	end
-
-	-- initialize Shadowsystem
-	self:SetupShadows()
-
-	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
-	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
-end
-
-function Renderer3D:DeInit()
-	--print("deactivating Renderer3D")
-	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:DestroyDynamicGfx(dynamic) end end
-	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
-	self:DeactivateMousePick()
-	self:ClearMapCache()
-	Client_SetFog()
-	Client_SetSkybox()
-	-- DeInit Caelum here
-	gCaelumSystem:Shutdown()
-	self.gbActive =3D false
-end
-
 =

 -- adds a point light source
 -- Diffuse dr,dg,db
@@ -320,6 +311,14 @@
 	return name
 end
 =

+function Renderer3D:RemovePointLight	(name)
+	Client_RemoveLight(name)
+	=

+	if gLightDebugMeshList and gLightDebugMeshList[name] then
+		gLightDebugMeshList[name]:Destroy()
+	end
+end
+
 -- hook to add artid based particle effects
 function Renderer3D:Hook_ItemAddParticle	(artid, x, y, z)
 	-- moongate
@@ -334,14 +333,6 @@
 	end
 	=

 	return nil
-end
-
-function Renderer3D:RemovePointLight	(name)
-	Client_RemoveLight(name)
-	=

-	if gLightDebugMeshList and gLightDebugMeshList[name] then
-		gLightDebugMeshList[name]:Destroy()
-	end
 end
 =

 function Renderer3D:CheckForUpdateMapOrigin()

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Wed Jul 30 21:24:49 2008
@@ -262,7 +262,7 @@
 	UnloadOldMap()
 	=

 	-- TODO ! don't trigger mapload here, as some servers send a lot of mapch=
anges in a row
-	-- problem : loaders are needed instantly (skybox,ground,static,compass)
+	-- problem : loaders are needed instantly (sky,ground,static,compass)
 	gMapIndex =3D iMaxNewIndex
 	ExecuteMapChangeIfNeeded()
 end
@@ -361,9 +361,6 @@
 	-- update renderer
 	profile:StartSection("mapenv")
 	=

-	-- initialize Mapenvironment
-	gCurrentRenderer:SetMapEnvironment()
-	=

 	profile:StartSection("compass")
 	SetCompassMapIndex(index)
 	=


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Wed Jul 30 21:24:49 2008
@@ -182,23 +182,18 @@
 end
 =

 local function SetMainMenuCam (roth,rotv)
-	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
-	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

-	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
-	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
-	=

-	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
-	GetMainCam():SetRot(w,x,y,z)	=

-end
-
-local function MainMenuSetBackground_Sky ()
 	local cam =3D GetMainCam()
 	cam:SetFOVy(gfDeg2Rad*45)
 	cam:SetNearClipDistance(0.5) -- old : 1
 	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
 	cam:SetProjectionType(kCamera_PT_PERSPECTIVE) -- perspective
-	Client_SetSkybox("sunset") -- cleansky skybox sunset darksun
-	SetMainMenuCam(0,gfDeg2Rad)
+	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
+	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

+	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
+	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
+	=

+	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
+	GetMainCam():SetRot(w,x,y,z)	=

 end
 =

 -- ----------------------------------------------- End of local functions =
-----------------------------
@@ -352,7 +347,8 @@
 =

 	-- start menu sound
 	SoundPlayMusicById(8)
-	MainMenuSetBackground_Sky()
+	SetMainMenuCam(0,gfDeg2Rad)
+	gCurrentRenderer:SetMapEnvironment()
 =

 	local rows =3D {
 		{ {type=3D"Label",	text=3D"Login:"} }

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Wed Jul 30 21:24:49 2008
@@ -351,7 +351,6 @@
 =

 	-- mainloop
 	while (Client_IsAlive()) do =

-		GrassTestStep()
 		MainStep() =

 	end
 end



From no-reply at zwischenwelt.org  Wed Jul 30 21:42:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 30 Jul 2008 19:42:38 -0000
Subject: [Iris-commit] [IRIS] r2333 - in /trunk/lua: lib.3d.renderer.lua
	lib.mainmenu.lua
Message-ID: <20080730194238.915001C18575@zwischenwelt.org>

Author: sience
Date: Wed Jul 30 21:42:38 2008
New Revision: 2333

Log:
-mainmenu update

Modified:
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.mainmenu.lua

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Jul 30 21:42:38 2008
@@ -144,11 +144,9 @@
 	return x - camangdeg + 5*45
 end
 =

-function Renderer3D:SetMapEnvironment (bUnderGround)
+function Renderer3D:SetMapEnvironment (bUnderGround, timeScale)
 	if (not self.gbActive) then return end
 	if (not gMapIndex) then return end
-
-print("SetMapEnvironment")
 =

 	-- black background when underground
 	if (bUnderGround) then
@@ -186,7 +184,7 @@
 			sun:SetAutoDisable(true)
 			sun:SetAutoDisableThreshold(0.1)
 		end
---[[		=

+--[[
 		local moon =3D gCaelumSystem:GetMoon()
 		if moon then
 			--~ print("MOON")
@@ -211,14 +209,17 @@
 		-- Sunrise with visible moon.
 		local cl =3D gCaelumSystem:GetUniversalClock()
 		--number year, number month, number day, number hour, number minute, num=
ber second
-		cl:SetGregorianDateTime(2007, 4, 9, 9, 33, 10)
-		--~ cl:SetTimeScale(2500)
-		--~ cl:SetTimeScale(512)
-		    =

-		-- to prevent wobbly shadows
-		-- updates clock and caelum every 30 sec
-		cl:SetUpdateRate(30)
-		    =

+		local t =3D os.date('*t')
+		cl:SetGregorianDateTime(t.year or 2007, t.month or 4, t.day or 9, t.hour=
 or 10, t.min or 20, t.sec or 10)
+		=

+		if (timeScale) then
+			cl:SetTimeScale(timeScale)
+		else
+			-- to prevent wobbly shadows
+			-- updates clock and caelum every 30 sec
+			cl:SetUpdateRate(30)
+		end
+
 		function rotate(gfx,w,x,y,z)
 			local ww,xx,yy,zz =3D gfx:GetOrientation()
 			gfx:SetOrientation(Quaternion.Mul(w,x,y,z, ww,xx,yy,zz))
@@ -231,14 +232,13 @@
 end
 =

 function Renderer3D:UpdateMapEnvironment (hour,minute,second)
-print("UpdateMapEnvironment")
 	if (gCaelumSystem) then
 	    -- Sunrise with visible moon.
-	   local cl =3D gCaelumSystem:GetUniversalClock()
-	   --number year, number month, number day, number hour, number minute, n=
umber second
+		local cl =3D gCaelumSystem:GetUniversalClock()
+		--number year, number month, number day, number hour, number minute, num=
ber second
 	   =

-	   local t =3D os.date('*t')
-	   cl:SetGregorianDateTime(t.year or 2007, t.month or 4, t.day or 9, hour=
 or t.hour, minute or t.min, second or t.sec)
+		local t =3D os.date('*t')
+		cl:SetGregorianDateTime(t.year or 2007, t.month or 4, t.day or 9, hour o=
r t.hour, minute or t.min, second or t.sec)
 	end
 end
 =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Wed Jul 30 21:42:38 2008
@@ -348,7 +348,7 @@
 	-- start menu sound
 	SoundPlayMusicById(8)
 	SetMainMenuCam(0,gfDeg2Rad)
-	gCurrentRenderer:SetMapEnvironment()
+	gCurrentRenderer:SetMapEnvironment(false,512)
 =

 	local rows =3D {
 		{ {type=3D"Label",	text=3D"Login:"} }



From no-reply at zwischenwelt.org  Wed Jul 30 21:54:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 30 Jul 2008 19:54:08 -0000
Subject: [Iris-commit] [IRIS] r2334 - in /trunk: data/config.lua.dist
	lua/main.lua
Message-ID: <20080730195409.438041C1852D@zwischenwelt.org>

Author: sience
Date: Wed Jul 30 21:54:08 2008
New Revision: 2334

Log:
-caelum options removed

Modified:
    trunk/data/config.lua.dist
    trunk/lua/main.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Wed Jul 30 21:54:08 2008
@@ -510,8 +510,6 @@
 =

 gUseStaticFallbacks =3D true
 =

-gUseCaelumSkysystem =3D false
-
 gUseCaduneTree =3D false
 =

 gShow3DManaChanges =3D false

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Wed Jul 30 21:54:08 2008
@@ -214,9 +214,7 @@
 	=

 	OgreAddResLoc(gUOPath..CorrectPath("Models/Maps")				,"FileSystem","Gener=
al")
 =

-	if gUseCaelumSkysystem then =

-		OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/caelum/resources")=
,"FileSystem","Caelum")
-	end
+	OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/caelum/resources"),=
"FileSystem","Caelum")
 =

 	if gUseCaduneTree then =

 		OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/cadune_tree/resour=
ces"),"FileSystem","CaduneTree")



From no-reply at zwischenwelt.org  Thu Jul 31 01:55:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 30 Jul 2008 23:55:32 -0000
Subject: [Iris-commit] [IRIS] r2335 - in /trunk: data/config.lua.dist
 lua/lib.3d.renderer.lua lua/lib.debugmenu.lua lua/lib.mainmenu.lua
Message-ID: <20080731000014.49F181C18049@zwischenwelt.org>

Author: sience
Date: Thu Jul 31 01:55:31 2008
New Revision: 2335

Log:
-old skybox added again as standard because of too many bugs in caelum (shu=
tdown doesn't work, and lightning, also no fallback for moon & clouds)

Modified:
    trunk/data/config.lua.dist
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.debugmenu.lua
    trunk/lua/lib.mainmenu.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Thu Jul 31 01:55:31 2008
@@ -510,6 +510,8 @@
 =

 gUseStaticFallbacks =3D true
 =

+gUseCaelumSkysystem =3D false
+
 gUseCaduneTree =3D false
 =

 gShow3DManaChanges =3D false

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Thu Jul 31 01:55:31 2008
@@ -36,6 +36,7 @@
 end
 =

 function Renderer3D:DeInit ()
+	--print("deactivating Renderer3D")
 	-- todo: unload LoadTexAtlas
 	-- todo: unload MultiTexTerrainInit
 	self:StopInGame ()
@@ -48,26 +49,32 @@
 =

 	-- for 2D/3D renderer switching
 	self:CamInit()
-
+	=

+	-- only Worldlight when Caelum is disabled
+	if (not(gUseCaelumSkysystem)) then
+		-- initialize Worldlight for normal SkyBox=C2=B4
+		SetupWorldLight_Default()
+	end
+
+	-- initialize Mapenvironment
+	self:SetMapEnvironment()
 	-- initialize Shadowsystem
 	self:SetupShadows(gShadowTechnique)
-	-- initialize Mapenvironment
-	self:SetMapEnvironment()
 =

 	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
 	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
 end
 =

 function Renderer3D:StopInGame ()
-	--print("deactivating Renderer3D")
 	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:DestroyDynamicGfx(dynamic) end end
 	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
 	self:DeactivateMousePick()
 	Client_ClearLights()
 	self:ClearMapCache()
-	-- DeInit Caelum here
+	self:DeleteMapEnvironment()
+	-- DeInit Caelum here (doesn't seem to work)
 	if (gCaelumSystem) then
-		gCaelumSystem:Shutdown()
+		gCaelumSystem:Shutdown(true)
 	end
 end
 =

@@ -102,7 +109,6 @@
 	end
 end
 =

-
 function Renderer3D:SetLastConfirmedUOPos(xloc,yloc,zloc) gTileFreeWalk:Im=
pl_SetLastConfirmedUOPos(xloc,yloc,zloc) end -- walk
 function Renderer3D:SetLastRequestedUOPos(xloc,yloc,zloc) gTileFreeWalk:Im=
pl_SetLastRequestedUOPos(xloc,yloc,zloc) end -- walk
 =

@@ -144,29 +150,30 @@
 	return x - camangdeg + 5*45
 end
 =

-function Renderer3D:SetMapEnvironment (bUnderGround, timeScale)
+function Renderer3D:SetMapEnvironment (bUnderGround)
 	if (not self.gbActive) then return end
 	if (not gMapIndex) then return end
 =

 	-- black background when underground
 	if (bUnderGround) then
-		-- deinit Caelum first
+		-- if Caelum deinit first
 		if (gCaelumSystem) then
-			gCaelumSystem:Shutdown()
+			gCaelumSystem:Shutdown(true)
 		end
 		GetMainViewport():SetBackCol(0,0,0)
-	else
+		Client_SetSkybox()
+	elseif (gUseCaelumSkysystem) then
 		-- check if already a caelum skysystem is there
 		if (gCaelumSystem) then return end
 =

-		-- if not create a new Skysystem
+		-- create a new Skysystem
+		-- create with CG shaders
 		gCaelumSystem =3D CreateCaelumCaelumSystem(
 			CAELUM_COMPONENT_SUN + =

---			CAELUM_COMPONENT_MOON +
 	        CAELUM_COMPONENT_SKY_DOME +
---	        CAELUM_COMPONENT_POINT_STARFIELD +
-			CAELUM_COMPONENT_IMAGE_STARFIELD +
---	        CAELUM_COMPONENT_CLOUDS +
+			CAELUM_COMPONENT_MOON +
+	        CAELUM_COMPONENT_POINT_STARFIELD +
+	        CAELUM_COMPONENT_CLOUDS +
 	        CAELUM_COMPONENT_PRECIPITATION +
 	        0
 		)
@@ -184,14 +191,14 @@
 			sun:SetAutoDisable(true)
 			sun:SetAutoDisableThreshold(0.1)
 		end
---[[
+
 		local moon =3D gCaelumSystem:GetMoon()
 		if moon then
 			--~ print("MOON")
 			moon:SetAutoDisable(true)
 			moon:SetAutoDisableThreshold(0.1)
 		end
-		=

+
 		local clouds =3D gCaelumSystem:GetCloudSystem()
 		if clouds then
 			--~ print("CLOUDS")
@@ -199,7 +206,7 @@
 			clouds:GetLayer(0):SetCloudSpeed(0.000005, -0.000009)
 			clouds:GetLayer(1):SetCloudSpeed(0.0000045, -0.0000085)
 		end
-]]--
+
 		local prec =3D gCaelumSystem:GetPrecipitationController()
 		if prec then
 			--~ print("PREC")
@@ -210,15 +217,13 @@
 		local cl =3D gCaelumSystem:GetUniversalClock()
 		--number year, number month, number day, number hour, number minute, num=
ber second
 		local t =3D os.date('*t')
-		cl:SetGregorianDateTime(t.year or 2007, t.month or 4, t.day or 9, t.hour=
 or 10, t.min or 20, t.sec or 10)
+		cl:SetGregorianDateTime(t.year, t.month, t.day, t.hour, t.min, t.sec)
+
+		-- cl:SetTimeScale(timeScale)
 		=

-		if (timeScale) then
-			cl:SetTimeScale(timeScale)
-		else
-			-- to prevent wobbly shadows
-			-- updates clock and caelum every 30 sec
-			cl:SetUpdateRate(30)
-		end
+		-- to prevent wobbly shadows
+		-- updates clock and caelum every 30 sec
+		cl:SetUpdateRate(30)
 =

 		function rotate(gfx,w,x,y,z)
 			local ww,xx,yy,zz =3D gfx:GetOrientation()
@@ -228,6 +233,16 @@
 		local w,x,y,z =3D Quaternion.fromAngleAxis(90 * gfDeg2Rad, 1,0,0)
 		rotate(gCaelumSystem:GetCaelumGroundNode(), w,x,y,z)
 		rotate(gCaelumSystem:GetCaelumCameraNode(), w,x,y,z)
+	else
+        -- black background when underground =

+		Client_SetSkybox(gMaps[gMapIndex].skybox) =

+
+		if (gUseDistanceFog) then =

+			gFogcolorred                    =3D gMaps[gMapIndex].fog_r =

+			gFogcolorgreen                  =3D gMaps[gMapIndex].fog_g =

+			gFogcolorblue                   =3D gMaps[gMapIndex].fog_b =

+			Client_SetFog(3, gFogcolorred/255, gFogcolorgreen/255, gFogcolorblue/25=
5, 1.0, 0, 10*gSightRange, 10*gSightRange+gFogValue) =

+		end =

 	end
 end
 =

@@ -238,12 +253,12 @@
 		--number year, number month, number day, number hour, number minute, num=
ber second
 	   =

 		local t =3D os.date('*t')
-		cl:SetGregorianDateTime(t.year or 2007, t.month or 4, t.day or 9, hour o=
r t.hour, minute or t.min, second or t.sec)
+		cl:SetGregorianDateTime(t.year, t.month, t.day, hour or t.hour, minute o=
r t.min, second or t.sec)
 	end
 end
 =

 function Renderer3D:SetupShadows (strShadowTechnique)
-	local shadowfardist=3D5*gSightRange+16
+	local shadowfardist=3D5*gSightRange+gFogValue
 =

 	if ((strShadowTechnique =3D=3D "stencil_modulative") or (strShadowTechniq=
ue =3D=3D "stencil_additive")) then
 		----- currently doesn't work with Fastbatch

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Thu Jul 31 01:55:31 2008
@@ -721,6 +721,7 @@
 	gStartInDebugMode =3D true
 	gDebugMenuRunning =3D true
 	gDialog_IrisLogo:SetVisible(false)
+
 	gCurrentRenderer:Init()
 	ActivateRenderer(Renderer3D)
 =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Thu Jul 31 01:55:31 2008
@@ -348,7 +348,7 @@
 	-- start menu sound
 	SoundPlayMusicById(8)
 	SetMainMenuCam(0,gfDeg2Rad)
-	gCurrentRenderer:SetMapEnvironment(false,512)
+	gCurrentRenderer:SetMapEnvironment()
 =

 	local rows =3D {
 		{ {type=3D"Label",	text=3D"Login:"} }



From no-reply at zwischenwelt.org  Thu Jul 31 12:46:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 31 Jul 2008 10:46:25 -0000
Subject: [Iris-commit] [IRIS] r2336 - /trunk/lua/lib.3d.dynamic.lua
Message-ID: <20080731104625.5F0E51C1857B@zwischenwelt.org>

Author: hagish
Date: Thu Jul 31 12:46:24 2008
New Revision: 2336

Log:
added some nil checks

Modified:
    trunk/lua/lib.3d.dynamic.lua

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Thu Jul 31 12:46:24 2008
@@ -379,6 +379,8 @@
 	=

 	if (bCorpseGFX) then
 		-- already handled above
+	elseif not item.artid then
+		print("ERROR: artid missing!!!!\n")
 	elseif item.artid >=3D gMulti_ID then =

 		-- Multis
 	=

@@ -516,18 +518,20 @@
 		end
 	end
 =

-	local arrtiletype =3D GetStaticTileType(item.artid)
-
-	-- creates a light if lights are enabled and static is a lightsource
-	if (gLightsources) then
-		if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Light=
Source) ) then
-			local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc+=
arrtiletype.miHeight) * 0.1)
-			item.lightname =3D Renderer3D:AddPointLight(x,y,z, 0.3,0.3,0.2, 0.3,0.3=
,0.2, 5.0,0.1,0.1,0.0)
-		end
-	end
-	=

-	if arrtiletype then =

-		item.particle =3D Renderer3D:Hook_ItemAddParticle(item.artid, Renderer3D=
:UOPosToLocal(item.xloc,item.yloc,(item.zloc+arrtiletype.miHeight) * 0.1))
+	if item.artid then
+		local arrtiletype =3D GetStaticTileType(item.artid)
+
+		-- creates a light if lights are enabled and static is a lightsource
+		if (gLightsources) then
+			if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Ligh=
tSource) ) then
+				local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc=
+arrtiletype.miHeight) * 0.1)
+				item.lightname =3D Renderer3D:AddPointLight(x,y,z, 0.3,0.3,0.2, 0.3,0.=
3,0.2, 5.0,0.1,0.1,0.0)
+			end
+		end
+		=

+		if arrtiletype then =

+			item.particle =3D Renderer3D:Hook_ItemAddParticle(item.artid, Renderer3=
D:UOPosToLocal(item.xloc,item.yloc,(item.zloc+arrtiletype.miHeight) * 0.1))
+		end
 	end
 end
 =




From no-reply at zwischenwelt.org  Thu Jul 31 18:52:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 31 Jul 2008 16:52:55 -0000
Subject: [Iris-commit] [IRIS] r2337 - in /trunk: data/profiles/gfx_med.lua
 lua/lib.2d.mobile.lua lua/lib.2d.renderer.lua lua/lib.3d.renderer.lua
 lua/main.lua
Message-ID: <20080731165256.06CA41C1857B@zwischenwelt.org>

Author: sience
Date: Thu Jul 31 18:52:55 2008
New Revision: 2337

Log:
-fixed assertion bug when using gUseStaticFallbacks
-renamed renderer startingame to startworld/stopworld
-several syncs between 3drenderer & 2drenderer

Modified:
    trunk/data/profiles/gfx_med.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/main.lua

Modified: trunk/data/profiles/gfx_med.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/profiles/gfx_med.lua (original)
+++ trunk/data/profiles/gfx_med.lua Thu Jul 31 18:52:55 2008
@@ -9,5 +9,3 @@
 gMobileCastShadows =3D false
 =

 gSightRange	=3D 4
-
-gUseStaticFallbacks =3D false

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Thu Jul 31 18:52:55 2008
@@ -30,6 +30,8 @@
 end =

 =

 function Renderer2D:DestroyMobileGfx			(mobile) if (mobile.gfx2d) then mob=
ile.gfx2d:Destroy() mobile.gfx2d =3D nil end end
+
+function Renderer2D:CreateMobileGfx				( mobile ) self:UpdateMobile(mobile=
) end	=

 =

 function Renderer2D:UpdateMobileModel			() end -- check equipment change e=
tc ?? called every time when UpdateMobile() is called ..
 =


Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Thu Jul 31 18:52:55 2008
@@ -27,13 +27,15 @@
 end
 =

 function Renderer2D:DeInit ()
-	-- todo: unload MultiTexTerrainInit
-	self:StopInGame()
+	-- todo: MultiTexTerrainInit() deinit ?!?
+	=

+	-- if 2d is stopped, stop also World
+	self:StopWorld()
 	self.gbActive =3D false
 end
 =

 -- called by main.lua
-function Renderer2D:StartInGame ()
+function Renderer2D:StartWorld ()
 	Client_ClearLights()
 	=

 	-- for 2D/3D renderer switching
@@ -46,11 +48,14 @@
 	-- initialize Worldlight
 	SetupWorldLight_Default()
 =

-	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
-	for k,mobile in pairs(GetMobileList()) do self:UpdateMobile(mobile) end
+-- sience: not needed anymore? bring up and assertion failure (it seems wi=
thout, everything is correct)
+	--	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynam=
ic)) then self:AddDynamicItem(dynamic) end end
+	--	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile)=
 end
 end
 =

-function Renderer3D:StopInGame ()
+function Renderer3D:StopWorld ()
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:RemoveDynamicItem(dynamic) end end
+	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
 	Client_ClearLights()
 end
 =


Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Thu Jul 31 18:52:55 2008
@@ -37,14 +37,16 @@
 =

 function Renderer3D:DeInit ()
 	--print("deactivating Renderer3D")
-	-- todo: unload LoadTexAtlas
-	-- todo: unload MultiTexTerrainInit
-	self:StopInGame ()
+	-- todo: LoadTexAtlas()  deinit ?!?
+	-- todo: MultiTexTerrainInit() deinit ?!?
+	=

+	-- if 3d is stopped, stop also World
+	self:StopWorld ()
 	self.gbActive =3D false
 end
 =

 -- called by main.lua
-function Renderer3D:StartInGame ()
+function Renderer3D:StartWorld ()
 	Client_ClearLights()
 =

 	-- for 2D/3D renderer switching
@@ -61,12 +63,13 @@
 	-- initialize Shadowsystem
 	self:SetupShadows(gShadowTechnique)
 =

-	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
-	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
-end
-
-function Renderer3D:StopInGame ()
-	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:DestroyDynamicGfx(dynamic) end end
+-- sience: not needed anymore? bring up and assertion failure (it seems wi=
thout, everything is correct)
+	--	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynam=
ic)) then self:AddDynamicItem(dynamic) end end
+	--	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile)=
 end
+end
+
+function Renderer3D:StopWorld ()
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:RemoveDynamicItem(dynamic) end end
 	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
 	self:DeactivateMousePick()
 	Client_ClearLights()

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Jul 31 18:52:55 2008
@@ -359,7 +359,7 @@
 	print("##################################")
 	print("######      START INGAME     #####")
 	print("##################################")
-	gCurrentRenderer:StartInGame()
+	gCurrentRenderer:StartWorld()
 =

 	ExecuteMapChangeIfNeeded()
 =




From no-reply at zwischenwelt.org  Thu Jul 31 22:09:51 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 31 Jul 2008 20:09:51 -0000
Subject: [Iris-commit] [IRIS] r2338 - in /trunk/lua: lib.3d.dynamic.lua
	lib.3d.map.lua
Message-ID: <20080731210006.0DE7B1C18018@zwischenwelt.org>

Author: sience
Date: Thu Jul 31 22:09:51 2008
New Revision: 2338

Log:
-lightsource centered

Modified:
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.3d.map.lua

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Thu Jul 31 22:09:51 2008
@@ -525,7 +525,7 @@
 		if (gLightsources) then
 			if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Ligh=
tSource) ) then
 				local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc=
+arrtiletype.miHeight) * 0.1)
-				item.lightname =3D Renderer3D:AddPointLight(x,y,z, 0.3,0.3,0.2, 0.3,0.=
3,0.2, 5.0,0.1,0.1,0.0)
+				item.lightname =3D Renderer3D:AddPointLight(x-0.5,y+0.5,z+1, 0.3,0.3,0=
.2, 0.3,0.3,0.2, 5.0,0.1,0.1,0.0)
 			end
 		end
 		=


Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Thu Jul 31 22:09:51 2008
@@ -362,7 +362,7 @@
 	if (gLightsources) then
 		local arrtiletype =3D GetStaticTileType(iTileTypeID)
 		if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Light=
Source) ) then
-			entity.lightname =3D Renderer3D:AddPointLight(entity.x-0.5,entity.y-0.5=
,entity.z+arrtiletype.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
+			entity.lightname =3D Renderer3D:AddPointLight(entity.x-0.5,entity.y+0.5=
,entity.z+1+arrtiletype.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
 		end
 	end
 =




