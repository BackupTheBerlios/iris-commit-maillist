From no-reply at zwischenwelt.org  Tue Mar  2 00:09:41 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 01 Mar 2010 23:09:41 -0000
Subject: [Iris-commit] [IRIS] r3263 - in /trunk/lua: ./ gui/ net/ widgets/
Message-ID: <20100301230942.3F3A47A98072@simon>

Author: ghoulsblade
Date: Tue Mar  2 00:09:38 2010
New Revision: 3263

Log:
experimental hotkey dialog and system, only minimal so far

Added:
    trunk/lua/lib.configdialog.macro.lua
Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.configdialog.hotkeys.lua
    trunk/lua/lib.configdialog.lua
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.walking3.lua
    trunk/lua/main.lua
    trunk/lua/net/net.text.lua
    trunk/lua/widgets/widget.uocheckbox.lua
    trunk/lua/widgets/widget.uoedittext.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Tue Mar  2 00:09:38 2010
@@ -133,7 +133,7 @@
 function Client_SetBottomLine (text) if (not gDisableBottomLine) then SetB=
ottomLine(text) end end -- from lugre
 =

 -- function is called by Lugre (lib.chatline.lua) from IrisChatLine_Repeat=
Last and IrisChatLine_Init
-function SendChat (text_plain,text_unicode,bIgnoreSpecials) =

+function SendChat (text_plain,text_unicode,bIgnoreSpecials,textmode) =

 	IrisCharLine_SetLast(text_plain)
 	print("SendChat",text_plain)
 	local bParseSpecials =3D not bIgnoreSpecials
@@ -184,7 +184,7 @@
 		elseif (gPlaintextTextEntryRequest) then =

 			Send_Plain_Text_Entry(text_plain,text_unicode) =

 		else
-			Send_UnicodeSpeech(text_plain,nil,nil,nil,text_unicode) =

+			Send_UnicodeSpeech(text_plain,textmode,nil,nil,text_unicode) =

 		end
 	end
 end =


Modified: trunk/lua/lib.configdialog.hotkeys.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.hotkeys.lua (original)
+++ trunk/lua/lib.configdialog.hotkeys.lua Tue Mar  2 00:09:38 2010
@@ -1,192 +1,179 @@
-
--- ***** ***** ***** ***** ***** ConfigDialogPage_HotKey
-
+-- hotkey config dialog
+
+gHotKeyData =3D gHotKeyData or {}
+gHotKeyDialog_CurrentKeyIdx =3D 1
+
+-- ***** ***** ***** ***** ***** load save
+
+function HotKeys_LoadData    		() gHotKeyData =3D	SimpleXMLLoad(HotKeys_Ge=
tDataFilePath()) or {} end
+function HotKeys_SaveData    		()              	SimpleXMLSave(HotKeys_GetD=
ataFilePath(),gHotKeyData) end
+function HotKeys_GetDataFilePath	() return GetConfigDirPath().."hotkeys.xm=
l" end
+
+
+-- ***** ***** ***** ***** ***** ConfigDialogPage_HotKey  (main)
 =

 function ConfigDialogPage_HotKey(page)
-    local group =3D page:AddWidget(CreateWidgetFromXMLString(nil,"<UOText =
bold=3D1 text=3D'not yet implemented'>"))
-    =

-    =

+    --~ page:AddWidget(CreateWidgetFromXMLString(nil,"<UOText bold=3D1 tex=
t=3D'not yet implemented'>"))
+    =

+    local hbox =3D page:AddChild("HBox",{spacer=3D3})
+    hbox:AddChild("Button",{label=3D"Prev",on_button_click=3Dfunction () p=
rint("show prev key") HotKeyDialog_ShowKeyIdx(gHotKeyDialog_CurrentKeyIdx -=
 1) end})
+    hbox:AddChild("Button",{label=3D"Next",on_button_click=3Dfunction () p=
rint("show next key") HotKeyDialog_ShowKeyIdx(gHotKeyDialog_CurrentKeyIdx +=
 1) end})
+    hbox:AddChild("Button",{label=3D"Add" ,on_button_click=3Dfunction () p=
rint("add key") table.insert(gHotKeyData,{}) HotKeyDialog_ShowKeyIdx(#gHotK=
eyData) end})
+    hbox:AddChild("Button",{label=3D"Del" ,on_button_click=3Dfunction () p=
rint("del key") =

+		if (gHotKeyDialog_CurrentKeyIdx <=3D #gHotKeyData) then
+			table.remove(gHotKeyData,gHotKeyDialog_CurrentKeyIdx) =

+			HotKeyDialog_ShowKeyIdx(gHotKeyDialog_CurrentKeyIdx) =

+			HotKeys_SaveData()
+		end
+		end})
+	=

     -- GetMacroKeyComboName (keycode,char,bCtrl,bAlt,bShift) =

     =

+	=

     local hbox =3D page:AddChild("HBox",{spacer=3D3})
-    hbox:AddChild("Button",{label=3D"test key combo",on_button_click=3Dfun=
ction (widget)  =

-            PollNextKey(function(keycode,char) =

-                print("ConfigDialogPage_HotKey:keystroke",keycode,char) =

-                local keyname =3D (keycode > 0) and GetKeyName(keycode) or=
 ("0"..char)
-                widget:SetText(keyname)
-                --~ widget:UpdateContent()
-            end)
-        end})
+    page.key =3D hbox:AddChild("Button",{label=3D"???",w=3D260,on_button_c=
lick=3Dfunction () =

+		PollNextKey(function(keycode,char) HotKeyDialog_SetKey(ConfigHotKey_GetK=
eyName(keycode,char)) end) end})
+		=

     local hbox =3D page:AddChild("HBox",{spacer=3D3})
         =

     hbox:AddWidget(CreateWidgetFromXMLString(nil,"<UOText bold=3D1 text=3D=
'shift'>"))
-    page.bShift     =3D hbox:AddChild("UOCheckBox",{gump_id_normal=3D210,g=
ump_id_pressed=3D211})
+    page.bShift     =3D hbox:AddChild("UOCheckBox",{gump_id_normal=3D210,g=
ump_id_pressed=3D211,on_change=3Dfunction (self,bState) HotKeyDialog_SetFla=
g("bShift",bState) end})
     =

     hbox:AddWidget(CreateWidgetFromXMLString(nil,"<UOText bold=3D1 text=3D=
'alt'>"))
-    page.bAlt       =3D hbox:AddChild("UOCheckBox",{gump_id_normal=3D210,g=
ump_id_pressed=3D211})
+    page.bAlt       =3D hbox:AddChild("UOCheckBox",{gump_id_normal=3D210,g=
ump_id_pressed=3D211,on_change=3Dfunction (self,bState) HotKeyDialog_SetFla=
g("bAlt",bState) end})
     =

     hbox:AddWidget(CreateWidgetFromXMLString(nil,"<UOText bold=3D1 text=3D=
'ctrl'>"))
-    page.bCtrl      =3D hbox:AddChild("UOCheckBox",{gump_id_normal=3D210,g=
ump_id_pressed=3D211})
-    =

-    =

+    page.bCtrl      =3D hbox:AddChild("UOCheckBox",{gump_id_normal=3D210,g=
ump_id_pressed=3D211,on_change=3Dfunction (self,bState) HotKeyDialog_SetFla=
g("bCtrl",bState) end})
+    =

+	=

     gConfigDialogPage_HotKeys =3D page
     local hbox =3D page:AddChild("HBox",{spacer=3D3})
-    gConfigDialogPage_HotKeys.btn_action =3D hbox:AddChild("Button",{label=
=3D"--select action--",w=3D260,on_button_click=3Dfunction (widget)  =

+    gConfigDialogPage_HotKeys.btn_action =3D hbox:AddChild("Button",{label=
=3D"???",w=3D260,on_button_click=3Dfunction (widget)  =

             local x,y =3D widget:GetDerivedLeftTop()
             ConfigDialogShowMenu(x,y,gConfigDialogHotkeyActionGroups,
                 function (group) return group.name end,
                 function (group) =

                     ConfigDialogShowMenu(x,y,group.list,
                         function (actiondata) return actiondata.callback a=
nd actiondata.name end,
-                        function (actiondata) ConfigDialog_HotKey_SetActio=
n(actiondata) end)
+                        function (actiondata) HotKeyDialog_SetAction(actio=
ndata and actiondata.actionid) end)
                 end)
         end})
-    page:AddChild("Button",{label=3D"--selector--",w=3D260,on_button_click=
=3Dfunction (widget)  =

-            local x,y =3D widget:GetDerivedLeftTop()
-            ConfigDialogShowMenu(x,y,gMobListSelectors.list,
-                function (selector) return selector.name end,
-                function (selector) widget:SetText("selector:"..selector.n=
ame) end)
-        end})
-    for i=3D1,4 do
-        local hbox =3D page:AddChild("HBox",{spacer=3D3})
-        hbox:AddChild("Button",{label=3D"+",w=3D21,h=3D15,on_button_click=
=3Dfunction (self) self.bState =3D not self.bState self:SetText(self.bState=
 and "not" or "+") end})
-        hbox:AddChild("Button",{label=3D"--filter--",w=3D230,on_button_cli=
ck=3Dfunction (widget)  =

-                local x,y =3D widget:GetDerivedLeftTop()
-                ConfigDialogShowMenu(x,y,gMobListFilters.list,
-                    function (filter) return filter.name end,
-                    function (filter) widget:SetText("filter:"..filter.nam=
e) end)
-            end})
-    end
-end
-
-function ConfigDialog_HotKey_SetAction(actiondata)
-    print("action",actiondata.name)
-    local group =3D actiondata.group
-    gConfigDialogPage_HotKeys.btn_action:SetText(group.name..":"..actionda=
ta.name)
-end
-
-
-
--- ***** ***** ***** ***** ***** target : selector
-
-local function MyDualList() return {
-    list =3D {},
-    listByName =3D {},
-    Register =3D function (self,name,o)
-        o.name =3D name
-        table.insert(self.list,o)
-        self.listByName[name] =3D o
-    end,
-    } =

-end
-gMobListSelectors =3D MyDualList()
-gMobListSelectors:Register("random"         ,{fun=3Dfunction (moblist) ret=
urn GetRandomArrayElement(moblist) end}) -- needs array, e.g. not serial as=
 key
-gMobListSelectors:Register("weakest(hp)"    ,{fun=3Dfunction (moblist) ret=
urn MobListSelectorUtil_Min(moblist,function (mobile) return  (mobile:GetRe=
lHP() or 1) end) end})
-gMobListSelectors:Register("strongest(hp)"  ,{fun=3Dfunction (moblist) ret=
urn MobListSelectorUtil_Min(moblist,function (mobile) return -(mobile:GetRe=
lHP() or 1) end) end})
-gMobListSelectors:Register("nearest"        ,{fun=3Dfunction (moblist) =

-    return MobListSelectorUtil_Min(moblist,function (mobile) =

-        local xloc,yloc =3D GetPlayerPos()
-        return dist2(xloc,yloc,mobile.xloc,mobile.yloc)
-        end) =

-end})
-function MobListSelectorUtil_Min    (moblist,evaluation) =

-    local foundvalue,foundmob
-    for k,mobile in pairs(moblist) do =

-        local value =3D evaluation(mobile)
-        if ((not foundvalue) or value < foundvalue) then =

-            foundvalue =3D value =

-            foundmob =3D mobile
-        end
-    end
-    return foundmob
-end
-
--- ***** ***** ***** ***** ***** target : category
-
-gMobListFilters =3D MyDualList()
-gMobListFilters:Register("self"                     ,{fun=3Dfunction (mobi=
le) return IsPlayerMobile(mobile) end})
-gMobListFilters:Register("selected"                 ,{fun=3Dfunction (mobi=
le) return mobile.serial =3D=3D MobListGetMainTargetSerial() end})
-gMobListFilters:Register("last"                     ,{fun=3Dfunction (mobi=
le) return mobile.serial =3D=3D MacroGetLastTargetSerial() end})
-gMobListFilters:Register("party"                    ,{fun=3Dfunction (mobi=
le) return IsMobileInParty(mobile.serial) end})
-gMobListFilters:Register("friend(party+rep)"        ,{fun=3Dfunction (mobi=
le) return IsMobileInParty(mobile.serial) or mobile.notoriety =3D=3D kNotor=
iety_Friend end})
-gMobListFilters:Register("rep:friend"               ,{fun=3Dfunction (mobi=
le) return mobile.notoriety =3D=3D kNotoriety_Friend    end})
-gMobListFilters:Register("rep:blue"                 ,{fun=3Dfunction (mobi=
le) return mobile.notoriety =3D=3D kNotoriety_Blue      end})
-gMobListFilters:Register("rep:red"                  ,{fun=3Dfunction (mobi=
le) return mobile.notoriety =3D=3D kNotoriety_Red       end})
-gMobListFilters:Register("rep:neutral"              ,{fun=3Dfunction (mobi=
le) return mobile.notoriety =3D=3D kNotoriety_Neutral   end})
-gMobListFilters:Register("rep:crime"                ,{fun=3Dfunction (mobi=
le) return mobile.notoriety =3D=3D kNotoriety_Crime     end})
-gMobListFilters:Register("rep:orange(enemy)"        ,{fun=3Dfunction (mobi=
le) return mobile.notoriety =3D=3D kNotoriety_Orange    end})
-gMobListFilters:Register("poisoned"                 ,{fun=3Dfunction (mobi=
le) return IsMobilePoisoned(mobile)    end})
-gMobListFilters:Register("healable"                 ,{fun=3Dfunction (mobi=
le) return ((mobile:GetRelHP() or 1) < 1) and (not IsMobilePoisoned(mobile)=
) and (not IsMobileMortaled(mobile)) end}) =

-gMobListFilters:Register("inrange"                  ,{fun=3Dfunction (mobi=
le) return not IsOutsideRange(mobile.xloc,mobile.yloc,gPlayerXLoc,gPlayerYL=
oc,gSpellCastRange) end})
---~ gMobListFilters:Register("insight"                  ,{fun=3Dfunction (=
mobile) return TODO(mobile.xloc,mobile.yloc,mobile.zloc) end})
-gMobListFilters:Register("fullhp"                   ,{fun=3Dfunction (mobi=
le) return ((mobile:GetRelHP() or 1) >=3D 1) end})
-gMobListFilters:Register("wounded(hp<90%)"          ,{fun=3Dfunction (mobi=
le) return ((mobile:GetRelHP() or 1) < 0.9) end})
-gMobListFilters:Register("weak(hp<50%)"             ,{fun=3Dfunction (mobi=
le) return ((mobile:GetRelHP() or 1) < 0.5) end})
-gMobListFilters:Register("human"                    ,{fun=3Dfunction (mobi=
le) return mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401 end})
-gMobListFilters:Register("vendor(preaos-name-hue)"  ,{fun=3Dfunction (mobi=
le) return GetItemLabelHue(mobile.serial) =3D=3D kPlayerVendorLabelHue end})
-gMobListFilters:Register("tamable(aos)"             ,{fun=3Dfunction (mobi=
le) return StringContains(GetItemTooltipOrLabel(mobile.serial),"gender") an=
d (not StringContains(GetItemTooltipOrLabel(mobile.serial),"(tame)")) end})
-gMobListFilters:Register("(summoned)"               ,{fun=3Dfunction (mobi=
le) return StringContains(GetItemTooltipOrLabel(mobile.serial),"(summoned)"=
) end})
-gMobListFilters:Register("(tame)"                   ,{fun=3Dfunction (mobi=
le) return StringContains(GetItemTooltipOrLabel(mobile.serial),"(tame)") en=
d})
-gMobListFilters:Register("blade,evortex,revenant"   ,{fun=3Dfunction (mobi=
le) return
-        (mobile.artid =3D=3D 574 and mobile.hue =3D=3D 0) or -- blade spir=
it
-        (mobile.artid =3D=3D 164 and mobile.hue =3D=3D 0) or -- energy vor=
tex
-        StringContains(GetItemTooltipOrLabel(mobile.serial),"revenant") --=
 revenant
-        end})
--- todo : npc(name:cliloc)
--- todo : player(moblist)
-
-gConfigDialogTipps =3D { list=3D{}, Add=3Dfunction(self,tipp) table.insert=
(self.list,tipp) end }
-gConfigDialogTipps:Add("use spell:cure/acure + selector:weakest + filter:p=
oisoned + filter:party to quickly cure friends in battle")
-gConfigDialogTipps:Add("use spell:heal/gheal + selector:weakest + filter:h=
ealable + filter:party to quickly heal friends in battle")
-gConfigDialogTipps:Add("use spell:dispel + selector:nearest + filter:blade=
,evortex,revenant to quickly target dispell")
-gConfigDialogTipps:Add("use misc:Select + selector:random + filter:not-fri=
end + filter:not-vendor + filter:not-pet to cycle targets")
-gConfigDialogTipps:Add("bind wheelup   : misc:Target + selector:self to tr=
igger spells/precast")
-gConfigDialogTipps:Add("bind wheeldown : misc:Target + selector:selected t=
o trigger spells/precast")
-gConfigDialogTipps:Add("use skill:taming + selector:random + filter:tamabl=
e for training")
-gConfigDialogTipps:Add("use misc:LastSpell + selector:last for spamming bo=
ssmonsters")
-gConfigDialogTipps:Add("spam chat:say:'all kill' + selector:random + filte=
r:not-friend for tamer aggro")
-
---[[
-        humanoid
-        friendlist (party+self+rep:green+manually set
-        =

-        *smart (heal/cure or selected, only works with spells)
-        *any
-        friendly   (party?guild?options)
-        attackable/enemy (orange,red or crime)
-        hostile (battleflagged?)
-        summons (dispel: bladespirit,evortex,revenant) =

-        byname  (tooltip scan)
-        bytype  (bodyid)
-        ?gate (item! dispel)
-        ?field (item! dispel:next to self or under selected target(when ef=
ielding in group fights))
-        ?ground near self   (summons : free tile, insight,inrange)
-        ?ground near target (summons : free tile, insight,inrange)
-        ?BackpackObjectByType (retrap pouch)
-        ?BackpackObjectByID
-        =

-    filters :  (and-combined)
-        [human]
-        [human or transform](human or human transform forms and non-npc)
-        [player](moblist : smart human detection?)
-        [npc](moblist : smart npc detection?)
-        [pet] : tame
-        [tamable] (postaos-tooltip contains gender, and not tame)
-]]--
+		=

+		=

+    local ew,eh =3D 200,24
+    local row =3D page:AddChild("HBox")
+    row:AddWidget(CreateWidgetFromXMLString(nil,"<UOText bold=3D1 text=3D'=
Text:'>"))
+    page.box_hotkey_param_text =3D row:AddChild("UOEditText",{width=3Dew,h=
eight=3Deh,text=3D"",name=3D"hotkey_param_text",hue=3D0,bHasBackPane=3Dtrue=
})
+	page.box_hotkey_param_text.on_change_text =3D function (self,text) HotKey=
Dialog_SetParamText(text) end
+    page.box_hotkey_param_text:SetVisible(false)
+	=

+	HotKeyDialog_ShowKeyIdx(1)
+end
+
+
+-- ***** ***** ***** ***** ***** HotKeyDialog_ShowKeyIdx
+
+function HotKeyDialog_ShowKeyIdx (idx) =

+	if (#gHotKeyData =3D=3D 0) then table.insert(gHotKeyData,{}) end
+	gHotKeyDialog_CurrentKeyIdx =3D max(1,min(#gHotKeyData,idx))
+	print("HotKeyDialog_ShowKeyIdx",gHotKeyDialog_CurrentKeyIdx)
+	=

+	local cur =3D HotKeyDialog_GetCur()
+	=

+	HotKeyDialog_SetKey(cur.keyname)
+	HotKeyDialog_SetAction(cur.actionid)
+	HotKeyDialog_SetFlag("bShift"	,cur.bShift	,true)
+	HotKeyDialog_SetFlag("bAlt"		,cur.bAlt	,true)
+	HotKeyDialog_SetFlag("bCtrl"	,cur.bCtrl	,true)
+	HotKeyDialog_SetParamText(cur.param_text,true)
+end
+
+function HotKeyDialog_GetCur () return gHotKeyData[gHotKeyDialog_CurrentKe=
yIdx] end
+
+function HotKeyDialog_SetData(fieldname,value)
+	print("HotKeyDialog_SetData",fieldname,value)
+	local cur =3D HotKeyDialog_GetCur()
+	if (cur[fieldname] =3D=3D value) then return end -- no change
+	cur[fieldname] =3D value
+	HotKeys_SaveData()
+end
+
+-- ***** ***** ***** ***** ***** data update
+
+function HotKeyDialog_SetKey(keyname)
+	HotKeyDialog_SetData("keyname",keyname)
+	gConfigDialogPage_HotKeys.key:SetText(keyname or "-- select key --")
+end
+function ConfigHotKey_GetKeyName (keycode,char) return (keycode > 0) and G=
etKeyName(keycode) or ("0"..char) end
+
+function HotKeyDialog_SetFlag (flagname,bState,bUpdateControl)
+	HotKeyDialog_SetData(flagname,bState)
+	if (bUpdateControl) then gConfigDialogPage_HotKeys[flagname]:SetState(bSt=
ate) end
+end
+
+function HotKeyDialog_SetAction(actionid)
+	local actiondata =3D GetHotKeyActionDataByID(actionid)
+	HotKeyDialog_SetData("actionid",actionid)
+    print("action",actiondata and actiondata.name)
+    local group =3D actiondata and actiondata.group
+    gConfigDialogPage_HotKeys.btn_action:SetText(actiondata and (group.nam=
e..":"..actiondata.name) or "--select action--")
+    gConfigDialogPage_HotKeys.box_hotkey_param_text:SetVisible(actiondata =
and actiondata.bHasTextParam)
+end
+
+function HotKeyDialog_SetParamText(param_text,bUpdateControl)
+	HotKeyDialog_SetData("param_text",param_text)
+	if (bUpdateControl) then gConfigDialogPage_HotKeys.box_hotkey_param_text:=
SetText(param_text or "") end
+end
+
+
+
+-- ***** ***** ***** ***** ***** TriggerConfigHotkey
+
+-- called from listener:keydown via lib.macrolist.lua:TriggerMacros()
+function TriggerConfigHotkey (keycode,char,bCtrl,bAlt,bShift)
+	local keyname =3D ConfigHotKey_GetKeyName(keycode,char)
+	bCtrl =3D not not bCtrl
+	bAlt =3D not not bAlt
+	bShift =3D not not bShift
+	--~ print("TriggerConfigHotkey1",keyname,bCtrl,bAlt,bShift)
+	for k,hotkey in ipairs(gHotKeyData) do =

+		if (hotkey.keyname =3D=3D keyname and (not not keyname.bCtrl) =3D=3D bCt=
rl and (not not keyname.bAlt) =3D=3D bAlt and (not not keyname.bShift) =3D=
=3D bShift) then
+			local actiondata =3D GetHotKeyActionDataByID(hotkey.actionid)
+			print("TriggerConfigHotkey2",keyname,bCtrl,bAlt,bShift,"action:",action=
data)
+			if (actiondata and actiondata.callback) then =

+				local param =

+				if (actiondata.bHasTextParam) then param =3D hotkey.param_text end
+				job.create(function () actiondata:callback(param) end) =

+			end
+			return true
+		end
+	end
+end
 =

 -- ***** ***** ***** ***** ***** hotkey actions
 =

-function HotkeyAction_Spell (info,target)
-    -- info.spellid
-end
-function HotkeyAction_Skill (info,target)
-    -- info.skillid_onebased
-end
-function HotkeyAction_Chat (info,text)
-
-end
+function HotkeyAction_Spell (actiondata)
+	print("HotkeyAction_Spell",actiondata.spellid)
+	if (actiondata.spellid) then MacroCmd_Spell(actiondata.spellid) end
+end
+function HotkeyAction_Skill (actiondata)
+	print("HotkeyAction_Skill",actiondata.skillid_onebased)
+	local skillname =3D actiondata.skillid_onebased and glSkillNames[actionda=
ta.skillid_onebased]
+	if (skillname) then MacroCmd_Skill(skillname) end
+end
+function HotkeyAction_Chat (actiondata,text)
+	print("HotkeyAction_Chat",text,actiondata.texttype)
+	if (text) then =

+		if (actiondata.bIsPartChat) then text =3D "/"..text end =

+		MacroCmd_Say(text,actiondata.texttype) -- see SendChat
+	end
+end
+
+gHotKeyActionDataByID =3D gHotKeyActionDataByID or {}
+function GetHotKeyActionDataByID(actionid) return gHotKeyActionDataByID[ac=
tionid] end -- returns actiondata
 =

 function InitConfigDialogHotkeyActions ()
+	gHotKeyActionDataByID =3D {}
     gConfigDialogHotkeyActionGroups         =3D {}
     gConfigDialogHotkeyActionGroupsByName   =3D {}
     function MyAddHotkeyAction (groupname,actiondata)
@@ -198,7 +185,9 @@
             --~ print("group:",groupname)
         end
         actiondata.group =3D group
+		actiondata.actionid =3D (groupname or "???")..":"..(actiondata.name or "=
???")
         table.insert(group.list,actiondata)
+		gHotKeyActionDataByID[actiondata.actionid] =3D actiondata
         --~ print(" +",actiondata.skillid_onebased or actiondata.spellid,a=
ctiondata.name)
     end
     =

@@ -239,29 +228,30 @@
         table.insert(gUOActions,action)
         gUOActionByName[action.name] =3D action
     end
-    RegisterUOAction({name=3D"WeaponSkill:Primary"    ,callback=3DMacroCmd=
_WeaponAbilityPrimary}) =

-    RegisterUOAction({name=3D"WeaponSkill:Secondary"  ,callback=3DMacroCmd=
_WeaponAbilitySecondary})
-    RegisterUOAction({name=3D"Dismount"               ,callback=3DMacroCmd=
_Dismount})
-    RegisterUOAction({name=3D"ToggleWarmode"          ,callback=3DMacroCmd=
_ToggleWarmode})
-    RegisterUOAction({name=3D"LastSpell"              ,callback=3DMacroCmd=
_RepeatLastSpell}) -- todo : targetlast option ?
-    RegisterUOAction({name=3D"LastChat"               ,callback=3DMacroCmd=
_RepeatLastChat})
-    RegisterUOAction({name=3D"LastObject"             ,callback=3DMacroCmd=
_RepeatLastDoubleClick})
+    RegisterUOAction({name=3D"WeaponSkill:Primary"    ,callback=3Dfunction=
 () MacroCmd_WeaponAbilityPrimary() end})
+    RegisterUOAction({name=3D"WeaponSkill:Secondary"  ,callback=3Dfunction=
 () MacroCmd_WeaponAbilitySecondary() end})
+    RegisterUOAction({name=3D"Dismount"               ,callback=3Dfunction=
 () MacroCmd_Dismount() end})
+    RegisterUOAction({name=3D"ToggleWarmode"          ,callback=3Dfunction=
 () MacroCmd_ToggleWarmode() end})
+    RegisterUOAction({name=3D"LastSpell"              ,callback=3Dfunction=
 () MacroCmd_RepeatLastSpell() end}) -- todo : targetlast option ?
+    RegisterUOAction({name=3D"LastChat"               ,callback=3Dfunction=
 () MacroCmd_RepeatLastChat() end})
+    RegisterUOAction({name=3D"LastObject"             ,callback=3Dfunction=
 () MacroCmd_RepeatLastDoubleClick() end})
     RegisterUOAction({name=3D"SelfInterrupt(hat)"     ,callback=3Dfunction=
 () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_Helm)) end})
     RegisterUOAction({name=3D"SelfInterrupt(robe)"    ,callback=3Dfunction=
 () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_TorsoOuter)) end})
-    RegisterUOAction({name=3D"OpenDoor(new)"          ,callback=3DMacroCmd=
_OpenDoors})
-    RegisterUOAction({name=3D"UseNearestGate"         ,callback=3DMacroCmd=
_UseNearbyGate})
-    RegisterUOAction({name=3D"UseObjectByType"        ,bHasObjectTypeParam=
=3Dtrue}) -- {potions,fukija,shuriken,bandage(old)}
-    RegisterUOAction({name=3D"UseObjectByID"          ,bHasObjectIDParam=
=3Dtrue})
-    RegisterUOAction({name=3D"UseItemInHand(Wands)"   })
-    RegisterUOAction({name=3D"OpenDoor(old/preaos)"   })
-    RegisterUOAction({name=3D"Select"                 ,bHasTargetOption=3D=
true})
-    RegisterUOAction({name=3D"Attack"                 ,bHasTargetOption=3D=
true})
-    RegisterUOAction({name=3D"Target"                 ,bHasTargetOption=3D=
true})
-    RegisterUOAction({name=3D"Mini Heal/Cure"         ,bHasTargetOption=3D=
true})
-    RegisterUOAction({name=3D"Big Heal/Cure"          ,bHasTargetOption=3D=
true})
-    RegisterUOAction({name=3D"Bandage"                ,bHasTargetOption=3D=
true})
-    RegisterUOAction({name=3D"ReloadFukija"})
-    RegisterUOAction({name=3D"ReloadShuriken"})
+    RegisterUOAction({name=3D"OpenDoor(new)"          ,callback=3Dfunction=
 () MacroCmd_OpenDoors() end})
+    RegisterUOAction({name=3D"UseNearestGate"         ,callback=3Dfunction=
 () MacroCmd_UseNearbyGate() end})
+    --~ RegisterUOAction({name=3D"MyTest"       		    ,bHasTextParam=3Dtru=
e,callback=3Dfunction (actiondata,param) print("mytest",actiondata,param) e=
nd})
+    --~ RegisterUOAction({name=3D"UseObjectByType"        ,callback=3DHotk=
eyAction_Object,bHasObjectTypeParam=3Dtrue}) -- {potions,fukija,shuriken,ba=
ndage(old)}
+    --~ RegisterUOAction({name=3D"UseObjectByID"          ,callback=3DHotk=
eyAction_Object,bHasObjectIDParam=3Dtrue})
+    --~ RegisterUOAction({name=3D"UseItemInHand(Wands)"   })
+    --~ RegisterUOAction({name=3D"OpenDoor(old/preaos)"   })
+    --~ RegisterUOAction({name=3D"Select"                 ,bHasTargetOptio=
n=3Dtrue})
+    --~ RegisterUOAction({name=3D"Attack"                 ,bHasTargetOptio=
n=3Dtrue})
+    --~ RegisterUOAction({name=3D"Target"                 ,bHasTargetOptio=
n=3Dtrue})
+    --~ RegisterUOAction({name=3D"Mini Heal/Cure"         ,bHasTargetOptio=
n=3Dtrue})
+    --~ RegisterUOAction({name=3D"Big Heal/Cure"          ,bHasTargetOptio=
n=3Dtrue})
+    --~ RegisterUOAction({name=3D"Bandage"                ,bHasTargetOptio=
n=3Dtrue})
+    --~ RegisterUOAction({name=3D"ReloadFukija"})
+    --~ RegisterUOAction({name=3D"ReloadShuriken"})
     --~ RegisterUOAction({name=3D"ScavengerStep"})
     --~ RegisterUOAction({name=3D"ScavengerReset"})
     --~ RegisterUOAction({name=3D"Looter"})
@@ -276,6 +266,7 @@
     --~ RegisterUOAction({name=3D"Mover/Organizer(items)"})  -- move betwe=
en containers, or to grid positions
     --~ RegisterUOAction({name=3D"UseOnce(Pouches)"}) -- saves a list, whe=
n an item is used, it is removed from list, when list is empty, it is refil=
led ?
     -- (razor:add/remove friend (targetting))
+	-- todo: screenshot/vid
     =

     -- misc
     local groupname =3D "misc"
@@ -283,23 +274,23 @@
     =

     -- chat
     local groupname =3D "chat"
-    MyAddHotkeyAction(groupname,{name=3D"Say",        bHasTextParam=3Dtrue=
,bHasTargetOption=3Dtrue,   callback=3DHotkeyAction_Chat})  =

-    MyAddHotkeyAction(groupname,{name=3D"Yell",       bHasTextParam=3Dtrue=
,bHasTargetOption=3Dtrue,   callback=3DHotkeyAction_Chat, texttype=3DkTextT=
ype_Yell})  =

-    MyAddHotkeyAction(groupname,{name=3D"Wisper",     bHasTextParam=3Dtrue=
,bHasTargetOption=3Dtrue,   callback=3DHotkeyAction_Chat, texttype=3DkTextT=
ype_Whisper})  =

-    MyAddHotkeyAction(groupname,{name=3D"Emote",      bHasTextParam=3Dtrue=
,                         callback=3DHotkeyAction_Chat, texttype=3DkTextTyp=
e_Emote})  =

-    MyAddHotkeyAction(groupname,{name=3D"Guild",      bHasTextParam=3Dtrue=
,                         callback=3DHotkeyAction_Chat, texttype=3DkTextTyp=
e_Guild})  =

-    MyAddHotkeyAction(groupname,{name=3D"Alliance",   bHasTextParam=3Dtrue=
,                         callback=3DHotkeyAction_Chat, texttype=3DkTextTyp=
e_Alliance})  =

-    MyAddHotkeyAction(groupname,{name=3D"Party",      bHasTextParam=3Dtrue=
,                         callback=3DHotkeyAction_Chat, bIsPartChat=3Dtrue}=
)  =

+    MyAddHotkeyAction(groupname,{name=3D"Say",        bHasTextParam=3Dtrue=
, callback=3DHotkeyAction_Chat})  =

+    MyAddHotkeyAction(groupname,{name=3D"Yell",       bHasTextParam=3Dtrue=
, callback=3DHotkeyAction_Chat, texttype=3DkTextType_Yell})  =

+    MyAddHotkeyAction(groupname,{name=3D"Wisper",     bHasTextParam=3Dtrue=
, callback=3DHotkeyAction_Chat, texttype=3DkTextType_Whisper})  =

+    MyAddHotkeyAction(groupname,{name=3D"Emote",      bHasTextParam=3Dtrue=
, callback=3DHotkeyAction_Chat, texttype=3DkTextType_Emote})  =

+    MyAddHotkeyAction(groupname,{name=3D"Guild",      bHasTextParam=3Dtrue=
, callback=3DHotkeyAction_Chat, texttype=3DkTextType_Guild})  =

+    MyAddHotkeyAction(groupname,{name=3D"Alliance",   bHasTextParam=3Dtrue=
, callback=3DHotkeyAction_Chat, texttype=3DkTextType_Alliance})  =

+    MyAddHotkeyAction(groupname,{name=3D"Party",      bHasTextParam=3Dtrue=
, callback=3DHotkeyAction_Chat, bIsPartChat=3Dtrue})  =

     =

     -- macros
-    local groupname =3D "macros"
+    --~ local groupname =3D "macros"
     -- todo =

     =

     -- dress
-    local groupname =3D "dress"
-    MyAddHotkeyAction(groupname,{name=3D"Toggle Left-Hand"})
-    MyAddHotkeyAction(groupname,{name=3D"Toggle Right-Hand"})
-    MyAddHotkeyAction(groupname,{name=3D"Redress(after death)"})
+    --~ local groupname =3D "dress"
+    --~ MyAddHotkeyAction(groupname,{name=3D"Toggle Left-Hand"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Toggle Right-Hand"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Redress(after death)"})
     -- todo =

     =

     --~ todo : party/guild : treat as friend : options
@@ -307,7 +298,7 @@
     --~ todo : target : instant(nodelay:only works when targetcursor is al=
ready there),auto,specified
     --  spellparam : target + target-delay (delay/timeout : auto? hardcode=
?)
 end
-
+InitConfigDialogHotkeyActions()
 =

 --[[
 --~ gCharCreateSkillIDs["Anatomy"]                  =3D 1

Modified: trunk/lua/lib.configdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.lua (original)
+++ trunk/lua/lib.configdialog.lua Tue Mar  2 00:09:38 2010
@@ -11,30 +11,29 @@
 end
 =

 function OpenConfigDialog ()
-	print("mesadebug:OpenConfigDialog 1")
+	--~ print("mesadebug:OpenConfigDialog 1")
 	ConfigDialog_Close()
-	print("mesadebug:OpenConfigDialog 2")
-    if (not gConfigDialogHotkeyActionGroups) then InitConfigDialogHotkeyAc=
tions() end
-
-	print("mesadebug:OpenConfigDialog 3")
+	--~ print("mesadebug:OpenConfigDialog 2")
+
+	--~ print("mesadebug:OpenConfigDialog 3")
     local texname,w,h,xoff,yoff =3D "simplebutton.png",80,80,0,0
     local u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy =3D 0,0, 4,8,4, 4,8,4, 32,32
     local gfxparam_white =3D MakeSpritePanelParam_BorderPartMatrix(GetPlai=
nTextureGUIMat(texname),w,h,xoff,yoff, u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy, 1,=
1, false, false)
     =

-	print("mesadebug:OpenConfigDialog 4")
+	--~ print("mesadebug:OpenConfigDialog 4")
     -- sience_window.png 64x64      w=3D16,24,24 h=3D16,16,32
     local texname,w,h,xoff,yoff =3D "sience_window.png",80,80,0,0
     local u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy =3D 0,0, 16,24,24, 16,16,32, 64=
,64
     local gfxparam_window =3D MakeSpritePanelParam_BorderPartMatrix(GetPla=
inTextureGUIMat(texname),w,h,xoff,yoff, u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy, 1=
,1, false, false)
     =

-	print("mesadebug:OpenConfigDialog 5")
+	--~ print("mesadebug:OpenConfigDialog 5")
     -- sience_button.png 128x128 128x25 w=3D6,116,6 h=3D6,13,6  (only one =
highlight state?)
     local texname,w,h,xoff,yoff =3D "sience_button.png",80,80,0,0
     local u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy =3D 0,0, 6,116,6, 6,13,6, 128,1=
28
     local gfxparam_border =3D MakeSpritePanelParam_BorderPartMatrix(GetPla=
inTextureGUIMat(texname),w,h,xoff,yoff, u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy, 1=
,1, false, false)
     =

     =

-	print("mesadebug:OpenConfigDialog 6")
+	--~ print("mesadebug:OpenConfigDialog 6")
     local b =3D 3
     GuiThemeSetDefaultParam("Button",{  gfxparam_init       =3D gfxparam_w=
hite,
                                         gfxparam_in_down    =3D MakeSprite=
PanelParam_Mod_TexTransform(0.0,0.5,1,1,0),
@@ -63,22 +62,22 @@
     GuiThemeSetDefaultParam("Pane",{    gfxparam_init       =3D gfxparam_w=
hite,
                                     })
     =

-	print("mesadebug:OpenConfigDialog 7")
+	--~ print("mesadebug:OpenConfigDialog 7")
     =

     -- bla
     local kConfigDialogW =3D 400
     local kConfigDialogH =3D 300
     local dialog =3D GetDesktopWidget():CreateChild("Window",{w=3DkConfigD=
ialogW,h=3DkConfigDialogH})
-	print("mesadebug:OpenConfigDialog 8")
+	--~ print("mesadebug:OpenConfigDialog 8")
     gConfigDialog =3D dialog
     dialog:SetPos(200,100)
-	print("mesadebug:OpenConfigDialog 9")
+	--~ print("mesadebug:OpenConfigDialog 9")
     --~ local btn =3D dialog:CreateContentChild("Button",{x=3D10,y=3D10,la=
bel=3D"testbutton"})
     --~ local txt =3D dialog:CreateContentChild("UOText",{bold=3Dtrue,text=
=3D"bla",x=3D10,y=3D50})
     local list      =3D dialog:CreateContentChild("List",{x=3D10,y=3D10,w=
=3D100,h=3D280})
     local pagelist  =3D dialog:CreateContentChild("PageList",{x=3D120,y=3D=
10})
     =

-	print("mesadebug:OpenConfigDialog 10")
+	--~ print("mesadebug:OpenConfigDialog 10")
     =

     function MyAddPage (name) =

         local pagenum =3D dialog.nextpagenum or 1
@@ -87,18 +86,18 @@
         return pagelist:GetOrCreatePage(pagenum):CreateContentChild("VBox")
     end
     =

-	print("mesadebug:OpenConfigDialog 11")
+	--~ print("mesadebug:OpenConfigDialog 11")
     ConfigDialogPage_Config(        MyAddPage("Config"))
-	print("mesadebug:OpenConfigDialog 12")
+	--~ print("mesadebug:OpenConfigDialog 12")
     ConfigDialogPage_Graphics(      MyAddPage("Graphics"))
-	print("mesadebug:OpenConfigDialog 14")
-    --~ ConfigDialogPage_HotKey(        MyAddPage("HotKey"))
+	--~ print("mesadebug:OpenConfigDialog 14")
     --~ ConfigDialogPage_Macro(         MyAddPage("Macro"))
     ConfigDialogPage_UOAM(          MyAddPage("UOAM"))
-	print("mesadebug:OpenConfigDialog 15")
+	--~ print("mesadebug:OpenConfigDialog 15")
     ConfigDialogPage_PacketVideo(   MyAddPage("PacketVideo"))
-	print("mesadebug:OpenConfigDialog 16")
+	--~ print("mesadebug:OpenConfigDialog 16")
     --~ ConfigDialogPage_Misc(          MyAddPage("Misc"))
+    ConfigDialogPage_HotKey(        MyAddPage("HotKey"))
     =

     =

     --[[
@@ -121,19 +120,19 @@
                                                                 --~ "</Win=
dow>")    =

 =

 																=

-	print("mesadebug:OpenConfigDialog 17")
+	--~ print("mesadebug:OpenConfigDialog 17")
     local alignbox  =3D dialog:CreateContentChild("AlignBox",{x=3D120,y=3D=
10,w=3DkConfigDialogW-120-10,h=3DkConfigDialogH-10-10})
-	print("mesadebug:OpenConfigDialog 18")
+	--~ print("mesadebug:OpenConfigDialog 18")
     local hbox      =3D alignbox:AddChild("HBox",{halign=3D"right",valign=
=3D"bottom",spacer=3D10})
     hbox:AddChild("Button",{label=3D"OK",     on_button_click=3Dfunction (=
) ConfigDialog_Close() end})
     alignbox:UpdateLayout()
     =

-	print("mesadebug:OpenConfigDialog 19")
+	--~ print("mesadebug:OpenConfigDialog 19")
     list:SetSelectedIndex(1)
-	print("mesadebug:OpenConfigDialog 20")
-end
-
-function ConfigDialog_Close () if (gConfigDialog) then gConfigDialog:Destr=
oy() gConfigDialog =3D nil end end
+	--~ print("mesadebug:OpenConfigDialog 20")
+end
+
+function ConfigDialog_Close () if (gConfigDialog) then HotKeys_SaveData() =
gConfigDialog:Destroy() gConfigDialog =3D nil end end
 =

 =

 -- ***** ***** ***** ***** ***** xml

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Mar  2 00:09:38 2010
@@ -225,7 +225,7 @@
 =

 -- stores the current desktop into a file, if file is nil the current open=
ed file will be used
 function SaveDesktop    (file)
-	print("#####SaveDesktop",debug.traceback())
+	--~ print("#####SaveDesktop",debug.traceback())
     file =3D file or gDesktopFile
     if file then
         local path =3D gDesktopDir..file

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Tue Mar  2 00:09:38 2010
@@ -164,7 +164,7 @@
     return false
 end
 =

-function MacroCmd_Say                   (text)  if (gInGameStarted) then S=
endChat(text) end end
+function MacroCmd_Say                   (text,textmode)  if (gInGameStarte=
d) then SendChat(text,nil,nil,textmode) end end
 function MacroCmd_NextCamMode           ()      gCurrentRenderer:ChangeCam=
Mode() end
 function MacroCmd_BandageSelf           ()      SendBandageSelf() end
 function MacroCmd_Quit                  ()      Terminate() end
@@ -828,7 +828,7 @@
 end
 function MacroCmd_Spell                 (spellname,targetserial,targetcall=
back,targetwaitadd)
     if (not gInGameStarted) then return end
-    local spellid =3D GetSpellIDByName(spellname)
+    local spellid =3D (type(spellname) =3D=3D "number") and spellname or G=
etSpellIDByName(spellname)
     if (not spellid) then return MacroErrorNameMismatch("MacroCmd_Spell",s=
pellname,gSpellIDByName) end
     Send_Spell(spellid)
     =

@@ -979,12 +979,13 @@
     local bAlt      =3D gKeyPressed[key_lalt]     or gKeyPressed[key_ralt]=
    =

     local bShift    =3D gKeyPressed[key_lshift]   or gKeyPressed[key_rshif=
t]
     local name =3D GetMacroKeyComboName(keycode,char,bCtrl,bAlt,bShift)
+	if (TriggerConfigHotkey(keycode,char,bCtrl,bAlt,bShift)) then return end
     local macrofun =3D gMacroList[name]
     if (gMacroPrintAllKeyCombos) then print('to use this macro keycombo : =
SetMacro("'..name..'",function() MacroCmd_Say("test") end)') end
     if (not macrofun) then return end -- no macro mapped to this keycode
     =

     -- protected macro call
-    local success,errormsg_or_result =3D lugrepcall(macrofun)
+    local success,errormsg_or_result =3D lugrepcall(function () job.create=
(macrofun) end)
     if (not success) then
         local myErrorText =3D "ERROR executing MACRO for keycombo "..name.=
." :\n"..tostring(errormsg_or_result)
         print(myErrorText)

Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Tue Mar  2 00:09:38 2010
@@ -30,6 +30,7 @@
 	local posx,posy,posz,d =3D xloc,yloc,iStartZ,iDir
 	=

 	local bMoveIsOk,newZ =3D W3_CheckMovement( mobile, posx,posy,posz, d)
+	if ((not bMoveIsOk) and (gWalkDebugOverrideActive and gKeyPressed[key_lsh=
ift] and gKeyPressed[key_lalt])) then return gPlayerZLoc end
 	--~ print("GetNearestGroundLevel",posx,posy,posz,"d"..d,bMoveIsOk and "ok=
" or "blocked",newZ)
 	return bMoveIsOk and newZ or nil
 end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Mar  2 00:09:38 2010
@@ -221,6 +221,7 @@
 =

 -- Load new XML Config-Data
 ConfigDialog_LoadData()
+HotKeys_LoadData()
 =

 --###############################
 --###        MACROS           ###

Modified: trunk/lua/net/net.text.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.text.lua (original)
+++ trunk/lua/net/net.text.lua Tue Mar  2 00:09:38 2010
@@ -622,7 +622,7 @@
 	=

 	local hue			=3D hex2num("0x34")
 	local font			=3D 0 -- ignored by runuo 1
-	local msgtype		=3D kTextType_Normal + (bEncoded and kTextType_Encoded or =
0)
+	local msgtype		=3D (mode or kTextType_Normal) + (bEncoded and kTextType_E=
ncoded or 0)
 	local packetlen		=3D 1+2+1+2+2+4+ (bEncoded and (2+0+ascilen+1) or (ascil=
en*2+2))
 	for i =3D 0,keywordcount-1 do packetlen =3D packetlen + ((math.mod(i,2) =
=3D=3D 0) and 1 or 2) end -- calc packetlength for encoding
 	=


Modified: trunk/lua/widgets/widget.uocheckbox.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uocheckbox.lua (original)
+++ trunk/lua/widgets/widget.uocheckbox.lua Tue Mar  2 00:09:38 2010
@@ -15,7 +15,7 @@
 	=

 	local dialog =3D parentwidget:GetDialog()
 	if (dialog and dialog.uo_check) then table.insert(dialog.uo_check,self) e=
nd
-
+	if (params.on_change) then self.on_change =3D params.on_change end
 	self:SetState(params.status)
 	self:UpdateGfx()
 end

Modified: trunk/lua/widgets/widget.uoedittext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uoedittext.lua (original)
+++ trunk/lua/widgets/widget.uoedittext.lua Tue Mar  2 00:09:38 2010
@@ -52,7 +52,7 @@
 =

 function gWidgetPrototype.UOEditText:UpdateTextDisplay () =

 	self.textwidget:SetUOHtml(self.text) =

-	self:on_change_text()
+	self:on_change_text(self.text)
 end
 =

 function gWidgetPrototype.UOEditText:RemoveLastChar		()



From no-reply at zwischenwelt.org  Wed Mar  3 00:23:01 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 02 Mar 2010 23:23:01 -0000
Subject: [Iris-commit] [IRIS] r3264 - in /trunk/lua:
	lib.configdialog.hotkeys.lua lib.macrolist.lua
Message-ID: <20100302232301.5311654D0007@simon>

Author: ghoulsblade
Date: Wed Mar  3 00:23:00 2010
New Revision: 3264

Log:
tons of new actions for hotkeys, started object by type/id param, untested

Modified:
    trunk/lua/lib.configdialog.hotkeys.lua
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.configdialog.hotkeys.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.hotkeys.lua (original)
+++ trunk/lua/lib.configdialog.hotkeys.lua Wed Mar  3 00:23:00 2010
@@ -61,11 +61,29 @@
 		=

 		=

     local ew,eh =3D 200,24
+	=

+	-- param:text
     local row =3D page:AddChild("HBox")
     row:AddWidget(CreateWidgetFromXMLString(nil,"<UOText bold=3D1 text=3D'=
Text:'>"))
+	page.box_hotkey_param_text_row =3D row
     page.box_hotkey_param_text =3D row:AddChild("UOEditText",{width=3Dew,h=
eight=3Deh,text=3D"",name=3D"hotkey_param_text",hue=3D0,bHasBackPane=3Dtrue=
})
 	page.box_hotkey_param_text.on_change_text =3D function (self,text) HotKey=
Dialog_SetParamText(text) end
-    page.box_hotkey_param_text:SetVisible(false)
+    page.box_hotkey_param_text_row:SetVisible(false)
+	=

+	-- param:object
+    local row =3D page:AddChild("HBox")
+    row:AddWidget(CreateWidgetFromXMLString(nil,"<UOText bold=3D1 text=3D'=
Object:'>"))
+	page.box_hotkey_param_object_row =3D row
+    page.box_hotkey_param_object =3D row:AddChild("Button",{label=3D"???",=
w=3D260,on_button_click=3Dfunction () =

+		job.create(function ()
+			local t =3D MacroCmd_JobGetTargetClientSide()
+			if (not t) then return end
+			local obj =3D GetDynamic(MacroCmd_GetStoredTarget_Serial(t) or 0)
+			if (not obj) then return end
+			HotKeyDialog_SetObject(obj.serial,obj.artid,obj.hue)
+		end)
+		end})
+    page.box_hotkey_param_object_row:SetVisible(false)
 	=

 	HotKeyDialog_ShowKeyIdx(1)
 end
@@ -86,6 +104,7 @@
 	HotKeyDialog_SetFlag("bAlt"		,cur.bAlt	,true)
 	HotKeyDialog_SetFlag("bCtrl"	,cur.bCtrl	,true)
 	HotKeyDialog_SetParamText(cur.param_text,true)
+	HotKeyDialog_SetObject(cur.param_obj_serial,cur.param_obj_artid,cur.param=
_obj_hue)
 end
 =

 function HotKeyDialog_GetCur () return gHotKeyData[gHotKeyDialog_CurrentKe=
yIdx] end
@@ -117,7 +136,8 @@
     print("action",actiondata and actiondata.name)
     local group =3D actiondata and actiondata.group
     gConfigDialogPage_HotKeys.btn_action:SetText(actiondata and (group.nam=
e..":"..actiondata.name) or "--select action--")
-    gConfigDialogPage_HotKeys.box_hotkey_param_text:SetVisible(actiondata =
and actiondata.bHasTextParam)
+    gConfigDialogPage_HotKeys.box_hotkey_param_text_row:SetVisible(actiond=
ata and actiondata.bHasTextParam)
+    gConfigDialogPage_HotKeys.box_hotkey_param_object_row:SetVisible(actio=
ndata and (actiondata.bHasObjectParam))
 end
 =

 function HotKeyDialog_SetParamText(param_text,bUpdateControl)
@@ -125,6 +145,15 @@
 	if (bUpdateControl) then gConfigDialogPage_HotKeys.box_hotkey_param_text:=
SetText(param_text or "") end
 end
 =

+function HotKeyDialog_SetObject(param_obj_serial,param_obj_artid,param_obj=
_hue)
+	HotKeyDialog_SetData("param_obj_serial",param_obj_serial)
+	HotKeyDialog_SetData("param_obj_artid",param_obj_artid)
+	HotKeyDialog_SetData("param_obj_hue",param_obj_hue)
+	gConfigDialogPage_HotKeys.box_hotkey_param_object:SetText(
+		param_obj_serial and =

+		("serial:"..hex(param_obj_serial or 0)..",artid:"..hex(param_obj_artid o=
r 0)..",hue:"..tostring(param_obj_hue)) or =

+		"-- select object --")
+end
 =

 =

 -- ***** ***** ***** ***** ***** TriggerConfigHotkey
@@ -141,9 +170,10 @@
 			local actiondata =3D GetHotKeyActionDataByID(hotkey.actionid)
 			print("TriggerConfigHotkey2",keyname,bCtrl,bAlt,bShift,"action:",action=
data)
 			if (actiondata and actiondata.callback) then =

-				local param =

-				if (actiondata.bHasTextParam) then param =3D hotkey.param_text end
-				job.create(function () actiondata:callback(param) end) =

+				local a,b,c
+				if (actiondata.bHasTextParam	) then a =3D hotkey.param_text end
+				if (actiondata.bHasObjectParam	) then a,b,c =3D hotkey.param_obj_seria=
l,hotkey.param_obj_artid,hotkey.param_obj_hue end
+				job.create(function () actiondata:callback(a,b,c) end) =

 			end
 			return true
 		end
@@ -228,20 +258,50 @@
         table.insert(gUOActions,action)
         gUOActionByName[action.name] =3D action
     end
-    RegisterUOAction({name=3D"WeaponSkill:Primary"    ,callback=3Dfunction=
 () MacroCmd_WeaponAbilityPrimary() end})
-    RegisterUOAction({name=3D"WeaponSkill:Secondary"  ,callback=3Dfunction=
 () MacroCmd_WeaponAbilitySecondary() end})
-    RegisterUOAction({name=3D"Dismount"               ,callback=3Dfunction=
 () MacroCmd_Dismount() end})
-    RegisterUOAction({name=3D"ToggleWarmode"          ,callback=3Dfunction=
 () MacroCmd_ToggleWarmode() end})
-    RegisterUOAction({name=3D"LastSpell"              ,callback=3Dfunction=
 () MacroCmd_RepeatLastSpell() end}) -- todo : targetlast option ?
-    RegisterUOAction({name=3D"LastChat"               ,callback=3Dfunction=
 () MacroCmd_RepeatLastChat() end})
-    RegisterUOAction({name=3D"LastObject"             ,callback=3Dfunction=
 () MacroCmd_RepeatLastDoubleClick() end})
-    RegisterUOAction({name=3D"SelfInterrupt(hat)"     ,callback=3Dfunction=
 () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_Helm)) end})
-    RegisterUOAction({name=3D"SelfInterrupt(robe)"    ,callback=3Dfunction=
 () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_TorsoOuter)) end})
-    RegisterUOAction({name=3D"OpenDoor(new)"          ,callback=3Dfunction=
 () MacroCmd_OpenDoors() end})
-    RegisterUOAction({name=3D"UseNearestGate"         ,callback=3Dfunction=
 () MacroCmd_UseNearbyGate() end})
-    --~ RegisterUOAction({name=3D"MyTest"       		    ,bHasTextParam=3Dtru=
e,callback=3Dfunction (actiondata,param) print("mytest",actiondata,param) e=
nd})
-    --~ RegisterUOAction({name=3D"UseObjectByType"        ,callback=3DHotk=
eyAction_Object,bHasObjectTypeParam=3Dtrue}) -- {potions,fukija,shuriken,ba=
ndage(old)}
-    --~ RegisterUOAction({name=3D"UseObjectByID"          ,callback=3DHotk=
eyAction_Object,bHasObjectIDParam=3Dtrue})
+    RegisterUOAction({name=3D"WeaponSkill:Primary"    	,callback=3Dfunctio=
n () MacroCmd_WeaponAbilityPrimary() end})
+    RegisterUOAction({name=3D"WeaponSkill:Secondary"  	,callback=3Dfunctio=
n () MacroCmd_WeaponAbilitySecondary() end})
+    RegisterUOAction({name=3D"Dismount"               	,callback=3Dfunctio=
n () MacroCmd_Dismount() end})
+    RegisterUOAction({name=3D"ToggleWarmode"          	,callback=3Dfunctio=
n () MacroCmd_ToggleWarmode() end})
+    RegisterUOAction({name=3D"LastSpell"              	,callback=3Dfunctio=
n () MacroCmd_RepeatLastSpell() end}) -- todo : targetlast option ?
+    RegisterUOAction({name=3D"LastChat"               	,callback=3Dfunctio=
n () MacroCmd_RepeatLastChat() end})
+    RegisterUOAction({name=3D"LastObject"             	,callback=3Dfunctio=
n () MacroCmd_RepeatLastDoubleClick() end})
+    RegisterUOAction({name=3D"SelfInterrupt(hat)"     	,callback=3Dfunctio=
n () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_Helm)) end})
+    RegisterUOAction({name=3D"SelfInterrupt(robe)"    	,callback=3Dfunctio=
n () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_TorsoOuter)) end})
+    RegisterUOAction({name=3D"OpenDoor(new)"          	,callback=3Dfunctio=
n () MacroCmd_OpenDoors() end})
+    RegisterUOAction({name=3D"UseNearestGate"         	,callback=3Dfunctio=
n () MacroCmd_UseNearbyGate() end})
+    RegisterUOAction({name=3D"UseObjectByType"        	,callback=3Dfunctio=
n (serial,artid,hue) MacroCmd_Item_Use(GetDynamic(serial or 0)) end,bHasObj=
ectParam=3Dtrue}) -- {potions,fukija,shuriken,bandage(old)}
+    RegisterUOAction({name=3D"UseObjectByID"          	,callback=3Dfunctio=
n (serial,artid,hue) if (artid) then MacroCmd_Item_UseByArtID(artid,hue) en=
d end,bHasObjectParam=3Dtrue})
+    RegisterUOAction({name=3D"MiniHealCureSelf"			,callback=3Dfunction () =
MacroCmd_MiniHealCureSelf() end})
+    RegisterUOAction({name=3D"BandageSelf(builtin)"		,callback=3Dfunction =
() MacroCmd_BandageSelf() end})
+    RegisterUOAction({name=3D"BandageSelf(use+target)"	,callback=3Dfunctio=
n () MacroCmd_Item_UseByArtID(0xe21) MacroCmd_QueueTargetSerial(GetPlayerSe=
rial(),1000) end})
+    RegisterUOAction({name=3D"TargetSelf"					,callback=3Dfunction () Macr=
oCmd_TargetSelfNow() end})
+    RegisterUOAction({name=3D"TargetLast(dumb)"			,callback=3Dfunction () =
MacroCmd_TargetLastNow() end})
+    RegisterUOAction({name=3D"TargetLast(smart)"			,callback=3Dfunction ()=
 MacroCmd_SendTargetSerial(MacroCmd_GetSmartTargetForLastSpell(),gSpellCast=
Range) end})
+    RegisterUOAction({name=3D"SelectNearest"				,callback=3Dfunction () lo=
cal m=3DMacroCmd_FindNearestMob() MobListSetMainTargetSerial(m and m.serial=
 or 0) end})
+    RegisterUOAction({name=3D"SelectRandomNonFriendly"	,callback=3Dfunctio=
n () MacroCmd_SmartSelectTarget() end}) -- pvp, random..    -- target with =
TargetLast(Smart)
+    RegisterUOAction({name=3D"AttackSelected"				,callback=3Dfunction () M=
acroCmd_AttackSelectedMobile() end}) -- melee
+    RegisterUOAction({name=3D"Screenshot"					,callback=3Dfunction () Macr=
oCmd_Screenshot() end})
+    RegisterUOAction({name=3D"PacketVideo"				,callback=3Dfunction () Pack=
etVideo_Recording_Toggle() end})
+    RegisterUOAction({name=3D"HideAllCorpses"				,callback=3Dfunction () M=
acroCmd_HideAllCorpses() end})
+    RegisterUOAction({name=3D"WalkToMousePos"				,callback=3Dfunction () M=
acroCmd_WalkToMouse() end})
+    RegisterUOAction({name=3D"Walk_North"					,callback=3Dfunction () Macr=
oCmd_WalkInDir(0) end})
+    RegisterUOAction({name=3D"Walk_NorthEast"				,callback=3Dfunction () M=
acroCmd_WalkInDir(1) end})
+    RegisterUOAction({name=3D"Walk_East"					,callback=3Dfunction () Macro=
Cmd_WalkInDir(2) end})
+    RegisterUOAction({name=3D"Walk_SouthEast"				,callback=3Dfunction () M=
acroCmd_WalkInDir(3) end})
+    RegisterUOAction({name=3D"Walk_South"					,callback=3Dfunction () Macr=
oCmd_WalkInDir(4) end})
+    RegisterUOAction({name=3D"Walk_SouthWest"				,callback=3Dfunction () M=
acroCmd_WalkInDir(5) end})
+    RegisterUOAction({name=3D"Walk_West"					,callback=3Dfunction () Macro=
Cmd_WalkInDir(6) end})
+    RegisterUOAction({name=3D"Walk_NorthWest"				,callback=3Dfunction () M=
acroCmd_WalkInDir(7) end})
+    RegisterUOAction({name=3D"ToggleHouseBlendout"		,callback=3Dfunction (=
) ToggleMultiOnlyShowFloor()  end})
+    RegisterUOAction({name=3D"ToggleCompass"				,callback=3Dfunction () Ma=
croCmd_Open("Compass") end})
+    RegisterUOAction({name=3D"CompassZoomIn"				,callback=3Dfunction () Ma=
croCmd_ZoomCompass(1*1.5) end})
+    RegisterUOAction({name=3D"CompassZoomOut"				,callback=3Dfunction () M=
acroCmd_ZoomCompass(1/1.5) end})
+    RegisterUOAction({name=3D"CamZoomIn"					,callback=3Dfunction () Macro=
Cmd_CamChangeZoom( 0.3) end})
+    RegisterUOAction({name=3D"CamZoomOut"					,callback=3Dfunction () Macr=
oCmd_CamChangeZoom(-0.3) end})
+    RegisterUOAction({name=3D"ResyncRequest"				,callback=3Dfunction () Se=
nd_Movement_Resync_Request() end})
+    RegisterUOAction({name=3D"ToggleAlwaysRun"				,callback=3Dfunction () =
gAlwaysRun =3D not gAlwaysRun end})
+	=

+	-- MacroCmd_UseRuneBookPreAOS , MacroCmd_UseRuneBookPostAOS  (method,idx)
     --~ RegisterUOAction({name=3D"UseItemInHand(Wands)"   })
     --~ RegisterUOAction({name=3D"OpenDoor(old/preaos)"   })
     --~ RegisterUOAction({name=3D"Select"                 ,bHasTargetOptio=
n=3Dtrue})

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Wed Mar  3 00:23:00 2010
@@ -180,6 +180,19 @@
     local f =3D gMacroOpenCommands[dialogtype] =

     if (not f) then return MacroErrorNameMismatch("MacroCmd_Open",dialogty=
pe,gMacroOpenCommands) end
     f() =

+end
+
+function MacroCmd_SmartSelectTarget ()
+	local m					=3D MacroCmd_FindNearestNonFriendlyPlayer() =

+	local selectedSerial	=3D m and m.serial
+	local nearlist2	=3D MacroCmd_ListNonFriendlyPlayers() =

+	local nearlist	=3D {}
+	for k,v in pairs(nearlist2) do table.insert(nearlist,v) end
+	local target
+	if (nearlist and countarr(nearlist) =3D=3D 1) then target =3D nearlist[1]=
 end
+	if (nearlist and countarr(nearlist) >=3D 2) then target =3D GetRandomArra=
yElement(nearlist) end
+	if (target) then selectedSerial =3D target.serial end
+	MobListSetMainTargetSerial(selectedSerial or 0) =

 end
 =

 function MacroCmd_UseNearbyGate () local gate =3D MacroCmd_Item_FindFirstN=
earByArtID(kMoongateGateArtID,nil,1) MacroCmd_Item_Use(gate) return gate ~=
=3D nil end



From no-reply at zwischenwelt.org  Sat Mar  6 18:15:23 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 06 Mar 2010 17:15:23 -0000
Subject: [Iris-commit] [IRIS] r3265 - in /trunk: include/builder.h
	src/builder_L.cpp
Message-ID: <20100306171523.4B75D54D0007@simon>

Author: hagish
Date: Sat Mar  6 18:15:23 2010
New Revision: 3265

Log:
compiles with ogre 1.7 : user object removed and some unused functions chan=
ged the signature

Modified:
    trunk/include/builder.h
    trunk/src/builder_L.cpp

Modified: trunk/include/builder.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/builder.h (original)
+++ trunk/include/builder.h Sat Mar  6 18:15:23 2010
@@ -10,13 +10,17 @@
 class 	lua_State;
 void	LuaRegisterBuilder 	(lua_State *L);
 =

+#if OGRE_VERSION < 0x10700
 namespace Lugre {
 	class cOgreUserObjectWrapper;
 };
+#endif
 =

 class cMeshEntity : public Lugre::cSmartPointable { public:
 	Ogre::Entity*			mpOgreEntity;
+#if OGRE_VERSION < 0x10700
 	cOgreUserObjectWrapper* mpUserObject;
+#endif
 	=

 	cMeshEntity(const char* szMeshName);
 	virtual ~cMeshEntity();

Modified: trunk/src/builder_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/builder_L.cpp (original)
+++ trunk/src/builder_L.cpp Sat Mar  6 18:15:23 2010
@@ -17,11 +17,17 @@
 using namespace Lugre;
 =

 =

+#if OGRE_VERSION < 0x10700
 cMeshEntity::cMeshEntity(const char* szMeshName) : mpOgreEntity(0), mpUser=
Object(0) {
+#else
+cMeshEntity::cMeshEntity(const char* szMeshName) : mpOgreEntity(0) {
+#endif
 	if (szMeshName) {
 		mpOgreEntity =3D cOgreWrapper::GetSingleton().mSceneMgr->createEntity(cO=
greWrapper::GetUniqueName(),szMeshName);
+#if OGRE_VERSION < 0x10700
 		mpUserObject =3D new cOgreUserObjectWrapper();
 		mpOgreEntity->setUserObject(mpUserObject); // for mousepicking
+#endif
 	}
 }
 =

@@ -29,7 +35,9 @@
 	if (mpOgreEntity) =

 		cOgreWrapper::GetSingleton().mSceneMgr->destroyEntity(mpOgreEntity);
 	mpOgreEntity =3D 0;
+#if OGRE_VERSION < 0x10700
 	if (mpUserObject) delete mpUserObject; mpUserObject =3D 0;
+#endif
 }
 =

 // mpOgreEntity->setCastShadows(false);
@@ -75,7 +83,9 @@
 			=

 			#define REGISTER_METHOD(methodname) mlMethod.push_back(make_luaL_reg(#m=
ethodname,&cMeshEntity_L::methodname));
 			REGISTER_METHOD(Destroy);
+#if OGRE_VERSION < 0x10700
 			REGISTER_METHOD(SetUserObject);
+#endif
 			REGISTER_METHOD(RayPick);
 			#undef REGISTER_METHOD
 		}
@@ -117,7 +127,8 @@
 			lua_pushnumber(L,iFaceNum);
 			return 3;
 		}
-		=

+
+#if OGRE_VERSION < 0x10700		=

 		static int	SetUserObject	(lua_State *L) { PROFILE =

 			cMeshEntity* 			pMeshEntity =3D checkudata_alive(L);
 			cOgreUserObjectWrapper* pUserObject =3D pMeshEntity ? pMeshEntity->mpUs=
erObject : 0;
@@ -130,7 +141,7 @@
 			}
 			return 0; =

 		}
-		=

+#endif		=

 		virtual const char* GetLuaTypeName () { return "iris.meshentity"; }
 };
 =




From no-reply at zwischenwelt.org  Sat Mar  6 18:35:21 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 06 Mar 2010 17:35:21 -0000
Subject: [Iris-commit] [IRIS] r3266 - in /trunk/lua:
	lib.configdialog.hotkeys.lua lib.macrolist.lua
Message-ID: <20100306173521.E5BE854D0007@simon>

Author: ghoulsblade
Date: Sat Mar  6 18:35:21 2010
New Revision: 3266

Log:
new macros and hotkeys : SimpleLoot,CutNearbyCorpse,Scavenge,TargetWeaponIn=
Hand,TextEntryRepeat,LootItem,CycleMaxFPS,TogglePacketVideoRecording,MountN=
earby,WalkToRandomTree,TargetNearestTree,TargetRandomNearGround,ToggleHouse=
Blendout,HideAllCorpses,WeaponSkill:ToggleAuto reactivate,SpamLastSpell

Modified:
    trunk/lua/lib.configdialog.hotkeys.lua
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.configdialog.hotkeys.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.hotkeys.lua (original)
+++ trunk/lua/lib.configdialog.hotkeys.lua Sat Mar  6 18:35:21 2010
@@ -251,86 +251,126 @@
         end
     end
     =

+    local groupname =3D "interface"
+    MyAddHotkeyAction(groupname,{name=3D"ToggleBackpack"				,callback=3Dfu=
nction () MacroCmd_Open("Backpack") end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleJournal"				,callback=3Dfun=
ction () MacroCmd_Open("Journal") end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleSkills"				,callback=3Dfunc=
tion () MacroCmd_Open("Skill") end})
+    MyAddHotkeyAction(groupname,{name=3D"TogglePaperdoll"				,callback=3Df=
unction () MacroCmd_Open("Paperdoll") end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleStatus"				,callback=3Dfunc=
tion () MacroCmd_Open("Status") end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleCompass"				,callback=3Dfun=
ction () MacroCmd_Open("Compass") end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleMap"					,callback=3Dfuncti=
on () GUI_ToggleMap() end})
+    MyAddHotkeyAction(groupname,{name=3D"CompassZoomIn"				,callback=3Dfun=
ction () MacroCmd_ZoomCompass(1*1.5) end})
+    MyAddHotkeyAction(groupname,{name=3D"CompassZoomOut"				,callback=3Dfu=
nction () MacroCmd_ZoomCompass(1/1.5) end})
+    MyAddHotkeyAction(groupname,{name=3D"CamZoomIn"					,callback=3Dfuncti=
on () MacroCmd_CamChangeZoom( 0.3) end})
+    MyAddHotkeyAction(groupname,{name=3D"CamZoomOut"					,callback=3Dfunct=
ion () MacroCmd_CamChangeZoom(-0.3) end})
+    MyAddHotkeyAction(groupname,{name=3D"Screenshot"					,callback=3Dfunct=
ion () MacroCmd_Screenshot() end})
+    MyAddHotkeyAction(groupname,{name=3D"PacketVideo:ToggleRecording"	,cal=
lback=3Dfunction () MacroCmd_TogglePacketVideoRecording() end})
+    MyAddHotkeyAction(groupname,{name=3D"NextCamMode"					,callback=3Dfunc=
tion () MacroCmd_NextCamMode() end})
+    MyAddHotkeyAction(groupname,{name=3D"Toggle2D/3D"					,callback=3Dfunc=
tion () MacroCmd_ActivateNextRenderer() end})
+    MyAddHotkeyAction(groupname,{name=3D"CycleMaxFPS"					,callback=3Dfunc=
tion () MacroCmd_CycleMaxFPS() end})
+    MyAddHotkeyAction(groupname,{name=3D"Quit"						,callback=3Dfunction (=
) MacroCmd_Quit() end})
+	=

+	=

+	=

+	=

     -- actions
-    gUOActions =3D {}
-    gUOActionByName =3D {}
-    function RegisterUOAction (action) =

-        table.insert(gUOActions,action)
-        gUOActionByName[action.name] =3D action
-    end
-    RegisterUOAction({name=3D"WeaponSkill:Primary"    	,callback=3Dfunctio=
n () MacroCmd_WeaponAbilityPrimary() end})
-    RegisterUOAction({name=3D"WeaponSkill:Secondary"  	,callback=3Dfunctio=
n () MacroCmd_WeaponAbilitySecondary() end})
-    RegisterUOAction({name=3D"Dismount"               	,callback=3Dfunctio=
n () MacroCmd_Dismount() end})
-    RegisterUOAction({name=3D"ToggleWarmode"          	,callback=3Dfunctio=
n () MacroCmd_ToggleWarmode() end})
-    RegisterUOAction({name=3D"LastSpell"              	,callback=3Dfunctio=
n () MacroCmd_RepeatLastSpell() end}) -- todo : targetlast option ?
-    RegisterUOAction({name=3D"LastChat"               	,callback=3Dfunctio=
n () MacroCmd_RepeatLastChat() end})
-    RegisterUOAction({name=3D"LastObject"             	,callback=3Dfunctio=
n () MacroCmd_RepeatLastDoubleClick() end})
-    RegisterUOAction({name=3D"SelfInterrupt(hat)"     	,callback=3Dfunctio=
n () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_Helm)) end})
-    RegisterUOAction({name=3D"SelfInterrupt(robe)"    	,callback=3Dfunctio=
n () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_TorsoOuter)) end})
-    RegisterUOAction({name=3D"OpenDoor(new)"          	,callback=3Dfunctio=
n () MacroCmd_OpenDoors() end})
-    RegisterUOAction({name=3D"UseNearestGate"         	,callback=3Dfunctio=
n () MacroCmd_UseNearbyGate() end})
-    RegisterUOAction({name=3D"UseObjectByType"        	,callback=3Dfunctio=
n (serial,artid,hue) MacroCmd_Item_Use(GetDynamic(serial or 0)) end,bHasObj=
ectParam=3Dtrue}) -- {potions,fukija,shuriken,bandage(old)}
-    RegisterUOAction({name=3D"UseObjectByID"          	,callback=3Dfunctio=
n (serial,artid,hue) if (artid) then MacroCmd_Item_UseByArtID(artid,hue) en=
d end,bHasObjectParam=3Dtrue})
-    RegisterUOAction({name=3D"MiniHealCureSelf"			,callback=3Dfunction () =
MacroCmd_MiniHealCureSelf() end})
-    RegisterUOAction({name=3D"BandageSelf(builtin)"		,callback=3Dfunction =
() MacroCmd_BandageSelf() end})
-    RegisterUOAction({name=3D"BandageSelf(use+target)"	,callback=3Dfunctio=
n () MacroCmd_Item_UseByArtID(0xe21) MacroCmd_QueueTargetSerial(GetPlayerSe=
rial(),1000) end})
-    RegisterUOAction({name=3D"TargetSelf"					,callback=3Dfunction () Macr=
oCmd_TargetSelfNow() end})
-    RegisterUOAction({name=3D"TargetLast(dumb)"			,callback=3Dfunction () =
MacroCmd_TargetLastNow() end})
-    RegisterUOAction({name=3D"TargetLast(smart)"			,callback=3Dfunction ()=
 MacroCmd_SendTargetSerial(MacroCmd_GetSmartTargetForLastSpell(),gSpellCast=
Range) end})
-    RegisterUOAction({name=3D"SelectNearest"				,callback=3Dfunction () lo=
cal m=3DMacroCmd_FindNearestMob() MobListSetMainTargetSerial(m and m.serial=
 or 0) end})
-    RegisterUOAction({name=3D"SelectRandomNonFriendly"	,callback=3Dfunctio=
n () MacroCmd_SmartSelectTarget() end}) -- pvp, random..    -- target with =
TargetLast(Smart)
-    RegisterUOAction({name=3D"AttackSelected"				,callback=3Dfunction () M=
acroCmd_AttackSelectedMobile() end}) -- melee
-    RegisterUOAction({name=3D"Screenshot"					,callback=3Dfunction () Macr=
oCmd_Screenshot() end})
-    RegisterUOAction({name=3D"PacketVideo"				,callback=3Dfunction () Pack=
etVideo_Recording_Toggle() end})
-    RegisterUOAction({name=3D"HideAllCorpses"				,callback=3Dfunction () M=
acroCmd_HideAllCorpses() end})
-    RegisterUOAction({name=3D"WalkToMousePos"				,callback=3Dfunction () M=
acroCmd_WalkToMouse() end})
-    RegisterUOAction({name=3D"Walk_North"					,callback=3Dfunction () Macr=
oCmd_WalkInDir(0) end})
-    RegisterUOAction({name=3D"Walk_NorthEast"				,callback=3Dfunction () M=
acroCmd_WalkInDir(1) end})
-    RegisterUOAction({name=3D"Walk_East"					,callback=3Dfunction () Macro=
Cmd_WalkInDir(2) end})
-    RegisterUOAction({name=3D"Walk_SouthEast"				,callback=3Dfunction () M=
acroCmd_WalkInDir(3) end})
-    RegisterUOAction({name=3D"Walk_South"					,callback=3Dfunction () Macr=
oCmd_WalkInDir(4) end})
-    RegisterUOAction({name=3D"Walk_SouthWest"				,callback=3Dfunction () M=
acroCmd_WalkInDir(5) end})
-    RegisterUOAction({name=3D"Walk_West"					,callback=3Dfunction () Macro=
Cmd_WalkInDir(6) end})
-    RegisterUOAction({name=3D"Walk_NorthWest"				,callback=3Dfunction () M=
acroCmd_WalkInDir(7) end})
-    RegisterUOAction({name=3D"ToggleHouseBlendout"		,callback=3Dfunction (=
) ToggleMultiOnlyShowFloor()  end})
-    RegisterUOAction({name=3D"ToggleCompass"				,callback=3Dfunction () Ma=
croCmd_Open("Compass") end})
-    RegisterUOAction({name=3D"CompassZoomIn"				,callback=3Dfunction () Ma=
croCmd_ZoomCompass(1*1.5) end})
-    RegisterUOAction({name=3D"CompassZoomOut"				,callback=3Dfunction () M=
acroCmd_ZoomCompass(1/1.5) end})
-    RegisterUOAction({name=3D"CamZoomIn"					,callback=3Dfunction () Macro=
Cmd_CamChangeZoom( 0.3) end})
-    RegisterUOAction({name=3D"CamZoomOut"					,callback=3Dfunction () Macr=
oCmd_CamChangeZoom(-0.3) end})
-    RegisterUOAction({name=3D"ResyncRequest"				,callback=3Dfunction () Se=
nd_Movement_Resync_Request() end})
-    RegisterUOAction({name=3D"ToggleAlwaysRun"				,callback=3Dfunction () =
gAlwaysRun =3D not gAlwaysRun end})
-	=

+    local groupname =3D "misc"
+    MyAddHotkeyAction(groupname,{name=3D"UseObjectByType"        	,callbac=
k=3Dfunction (serial,artid,hue) MacroCmd_Item_Use(GetDynamic(serial or 0)) =
end,bHasObjectParam=3Dtrue}) -- {potions,fukija,shuriken,bandage(old)}
+    MyAddHotkeyAction(groupname,{name=3D"UseObjectByID"          	,callbac=
k=3Dfunction (serial,artid,hue) if (artid) then MacroCmd_Item_UseByArtID(ar=
tid,hue) end end,bHasObjectParam=3Dtrue})
+    MyAddHotkeyAction(groupname,{name=3D"UseNearbyByType"        	,callbac=
k=3Dfunction (serial,artid,hue) MacroCmd_Item_Use(GetRandomArrayElement(Mac=
roCmd_Item_FindNearByArtList(artid and {artid},2))) end,bHasObjectParam=3Dt=
rue})
+    MyAddHotkeyAction(groupname,{name=3D"LastSpell"              	,callbac=
k=3Dfunction () MacroCmd_RepeatLastSpell() end}) -- todo : targetlast optio=
n ?
+    MyAddHotkeyAction(groupname,{name=3D"LastObject"             	,callbac=
k=3Dfunction () MacroCmd_RepeatLastDoubleClick() end})
+    MyAddHotkeyAction(groupname,{name=3D"LastChat"               	,callbac=
k=3Dfunction () MacroCmd_RepeatLastChat() end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleWarmode"          	,callbac=
k=3Dfunction () MacroCmd_ToggleWarmode() end})
+    MyAddHotkeyAction(groupname,{name=3D"OpenDoor"       		   	,callback=
=3Dfunction () MacroCmd_OpenDoors() end})
+    MyAddHotkeyAction(groupname,{name=3D"SpamLastSpell"			,callback=3Dfunc=
tion () MacroCmd_TargetLastNow() MacroCmd_RepeatLastSpell() end},"repeat la=
st spell on last target")
+    MyAddHotkeyAction(groupname,{name=3D"TargetSelf"				,callback=3Dfuncti=
on () MacroCmd_TargetSelfNow() end})
+    MyAddHotkeyAction(groupname,{name=3D"TargetLast(dumb)"		,callback=3Dfu=
nction () MacroCmd_TargetLastNow() end})
+    MyAddHotkeyAction(groupname,{name=3D"TargetLast(smart)"		,callback=3Df=
unction () MacroCmd_SendTargetSerial(MacroCmd_GetSmartTargetForLastSpell(),=
gSpellCastRange) end})
+    MyAddHotkeyAction(groupname,{name=3D"TargetWeaponInHand"		,callback=3D=
function () MacroCmd_TargetWeaponInHand() end},"useful for poisoning")
+    MyAddHotkeyAction(groupname,{name=3D"WeaponSkill:Primary"    	,callbac=
k=3Dfunction () MacroCmd_WeaponAbilityPrimary() end})
+    MyAddHotkeyAction(groupname,{name=3D"WeaponSkill:Secondary"  	,callbac=
k=3Dfunction () MacroCmd_WeaponAbilitySecondary() end})
+    MyAddHotkeyAction(groupname,{name=3D"WeaponSkill:ToggleAuto"	,callback=
=3Dfunction () if (gReActivateWeaponAbilityInterval) then gReActivateWeapon=
AbilityInterval =3D nil else gReActivateWeaponAbilityInterval =3D 3100 end =
end},"auto-reactivate weapon ability after 3 seconds")
+    MyAddHotkeyAction(groupname,{name=3D"Dismount"               	,callbac=
k=3Dfunction () MacroCmd_Dismount() end})
+    MyAddHotkeyAction(groupname,{name=3D"MountNearby"            	,callbac=
k=3Dfunction () MacroCmd_MountNearby() end})
+    MyAddHotkeyAction(groupname,{name=3D"SelfInterrupt(hat)"     	,callbac=
k=3Dfunction () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_Helm))=
 end},"interrupt self when casting spell")
+    MyAddHotkeyAction(groupname,{name=3D"SelfInterrupt(robe)"    	,callbac=
k=3Dfunction () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_TorsoO=
uter)) end},"interrupt self when casting spell")
+    MyAddHotkeyAction(groupname,{name=3D"UseNearestGate"         	,callbac=
k=3Dfunction () MacroCmd_UseNearbyGate() end})
+    MyAddHotkeyAction(groupname,{name=3D"MiniHealCureSelf"		,callback=3Dfu=
nction () MacroCmd_MiniHealCureSelf() end})
+    MyAddHotkeyAction(groupname,{name=3D"BandageSelf(builtin)"	,callback=
=3Dfunction () MacroCmd_BandageSelf() end})
+    MyAddHotkeyAction(groupname,{name=3D"BandageSelf(use+target)"	,callbac=
k=3Dfunction () MacroCmd_Item_UseByArtID(0xe21) MacroCmd_QueueTargetSerial(=
GetPlayerSerial(),1000) end})
+    --~ MyAddHotkeyAction(groupname,{name=3D"BandageNearbyParty"		,callbac=
k=3Dfunction () MacroCmd_Item_UseByArtID(0xe21) MacroCmd_QueueTargetSerial(=
GetNearbyHealCurePartyMember(),1000) end})  -- pet,gray,nonparty..
+    MyAddHotkeyAction(groupname,{name=3D"SelectNearest"			,callback=3Dfunc=
tion () local m=3DMacroCmd_FindNearestMob() MobListSetMainTargetSerial(m an=
d m.serial or 0) end})
+    MyAddHotkeyAction(groupname,{name=3D"SelectRandomNonFriendly"	,callbac=
k=3Dfunction () MacroCmd_SmartSelectTarget() end}) -- pvp, random..    -- t=
arget with TargetLast(Smart)
+    MyAddHotkeyAction(groupname,{name=3D"AttackSelected"			,callback=3Dfun=
ction () MacroCmd_AttackSelectedMobile() end},"meelee")
+    MyAddHotkeyAction(groupname,{name=3D"HideAllCorpses"			,callback=3Dfun=
ction () MacroCmd_HideAllCorpses() end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleHouseBlendout"		,callback=
=3Dfunction () ToggleMultiOnlyShowFloor()  end})
+    MyAddHotkeyAction(groupname,{name=3D"ResyncRequest"			,callback=3Dfunc=
tion () Send_Movement_Resync_Request() end},"ask server to resync player po=
sition and objects")
+    MyAddHotkeyAction(groupname,{name=3D"ToggleAlwaysRun"			,callback=3Dfu=
nction () gAlwaysRun =3D not gAlwaysRun end})
+    MyAddHotkeyAction(groupname,{name=3D"TargetRandomNearGround"	,callback=
=3Dfunction () MacroCmd_TargetGroundNow(gPlayerXLoc+math.random(3)-2,gPlaye=
rYLoc+math.random(3)-2) end})
+    MyAddHotkeyAction(groupname,{name=3D"TargetNearestTree"		,callback=3Df=
unction () local tree =3D GetRandomArrayElement(MacroCmd_FindNearbyTrees(2)=
)  if (tree) then CompleteTargetModeWithTargetStatic(tree) end end})
+    MyAddHotkeyAction(groupname,{name=3D"WalkToRandomTree"		,callback=3Dfu=
nction () local tree =3D GetRandomArrayElement(MacroCmd_FindNearbyTrees(20)=
) if (tree) then MacroCmd_PathFindTo(tree.xloc,tree.yloc,2) end end})
+    MyAddHotkeyAction(groupname,{name=3D"SimpleLoot"				,callback=3Dfuncti=
on () MacroCmd_SimpleLootStep() end},"loot a random item from nearby corpse=
s")
+    MyAddHotkeyAction(groupname,{name=3D"ToggleAutoLoot"			,callback=3Dfun=
ction () ToggleAutoLoot() end})
+    MyAddHotkeyAction(groupname,{name=3D"ScavengeNearby"			,callback=3Dfun=
ction () MacroCmd_Scavenge() end},"picks up nearby items")
+    MyAddHotkeyAction(groupname,{name=3D"CutNearbyCorpse"			,callback=3Dfu=
nction () MacroCmd_CutNearbyCorpse() end},"uses dagger or skinning knife to=
 cut a nearby corpse")
+    MyAddHotkeyAction(groupname,{name=3D"ToggleTextEntryRepeat"	,callback=
=3Dfunction () MacroCmd_ToggleTextEntryRepeatLastChat() end},"uses last cha=
tline as text for all text-entry prompts, useful for filling vendors")
+	=

+    local groupname =3D "walk"
+    MyAddHotkeyAction(groupname,{name=3D"WalkToMousePos"			,callback=3Dfun=
ction () MacroCmd_WalkToMouse() end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_North"				,callback=3Dfuncti=
on () MacroCmd_WalkInDir(0) end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_NorthEast"			,callback=3Dfun=
ction () MacroCmd_WalkInDir(1) end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_East"				,callback=3Dfunctio=
n () MacroCmd_WalkInDir(2) end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_SouthEast"			,callback=3Dfun=
ction () MacroCmd_WalkInDir(3) end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_South"				,callback=3Dfuncti=
on () MacroCmd_WalkInDir(4) end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_SouthWest"			,callback=3Dfun=
ction () MacroCmd_WalkInDir(5) end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_West"				,callback=3Dfunctio=
n () MacroCmd_WalkInDir(6) end})
+    MyAddHotkeyAction(groupname,{name=3D"Walk_NorthWest"			,callback=3Dfun=
ction () MacroCmd_WalkInDir(7) end})
+	=

+	--[[
+	-- mine and lumber : =

+	MiniHealCureParty
+	TargetrandomNearbyCorpse (necro animate? cut?)
+	MountNearby (warmode off)
+	BandageNearby
+	BandageNearbyParty
+	BandageNearbyFriendly
+	BandageNearbyNonHostile
+	BandageNearbySmart  (preference, self if low, party/guild,blue,pets...)
+	RazorActions ...
+	doubleclick nearby objtype (harvest)
+	=

+	targetlast+castspell x (chooser, not last here)
+	=

+	ToggleMinerGrid
+	target nearest revenant.  (dispel)    local target =3D MacroCmd_FindNeare=
stMobByName("revenant") or MacroCmd_FindNearestMobByName("blade spirit")
+	necro-familiar-menu
+	=

+	]]--
+	-- mount nearest horse
 	-- MacroCmd_UseRuneBookPreAOS , MacroCmd_UseRuneBookPostAOS  (method,idx)
-    --~ RegisterUOAction({name=3D"UseItemInHand(Wands)"   })
-    --~ RegisterUOAction({name=3D"OpenDoor(old/preaos)"   })
-    --~ RegisterUOAction({name=3D"Select"                 ,bHasTargetOptio=
n=3Dtrue})
-    --~ RegisterUOAction({name=3D"Attack"                 ,bHasTargetOptio=
n=3Dtrue})
-    --~ RegisterUOAction({name=3D"Target"                 ,bHasTargetOptio=
n=3Dtrue})
-    --~ RegisterUOAction({name=3D"Mini Heal/Cure"         ,bHasTargetOptio=
n=3Dtrue})
-    --~ RegisterUOAction({name=3D"Big Heal/Cure"          ,bHasTargetOptio=
n=3Dtrue})
-    --~ RegisterUOAction({name=3D"Bandage"                ,bHasTargetOptio=
n=3Dtrue})
-    --~ RegisterUOAction({name=3D"ReloadFukija"})
-    --~ RegisterUOAction({name=3D"ReloadShuriken"})
-    --~ RegisterUOAction({name=3D"ScavengerStep"})
-    --~ RegisterUOAction({name=3D"ScavengerReset"})
-    --~ RegisterUOAction({name=3D"Looter"})
-    --~ RegisterUOAction({name=3D"OpenCorpse"})
-    --~ RegisterUOAction({name=3D"CutCorpse"})
-    --~ RegisterUOAction({name=3D"CutLeather"}) -- scissor
-    --~ RegisterUOAction({name=3D"LeatherStep(lootleather,scissor leather,=
cut corpse,opencorpse)"})
-    --~ RegisterUOAction({name=3D"Harvester(cotton,flax,sheep)"})
-    --~ RegisterUOAction({name=3D"Restock(regs,pots,pouches,clothes)"})
-    --~ RegisterUOAction({name=3D"BuyAgent"})
-    --~ RegisterUOAction({name=3D"SellAgent"})
-    --~ RegisterUOAction({name=3D"Mover/Organizer(items)"})  -- move betwe=
en containers, or to grid positions
-    --~ RegisterUOAction({name=3D"UseOnce(Pouches)"}) -- saves a list, whe=
n an item is used, it is removed from list, when list is empty, it is refil=
led ?
+    --~ MyAddHotkeyAction(groupname,{name=3D"UseItemInHand(Wands)"   })
+    --~ MyAddHotkeyAction(groupname,{name=3D"OpenDoor(old/preaos)"   })
+    --~ MyAddHotkeyAction(groupname,{name=3D"Select"                 ,bHas=
TargetOption=3Dtrue})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Attack"                 ,bHas=
TargetOption=3Dtrue})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Target"                 ,bHas=
TargetOption=3Dtrue})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Mini Heal/Cure"         ,bHas=
TargetOption=3Dtrue})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Big Heal/Cure"          ,bHas=
TargetOption=3Dtrue})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Bandage"                ,bHas=
TargetOption=3Dtrue})
+    --~ MyAddHotkeyAction(groupname,{name=3D"ReloadFukija"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"ReloadShuriken"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"CutCorpse"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"CutLeather"}) -- scissor
+    --~ MyAddHotkeyAction(groupname,{name=3D"LeatherStep(lootleather,sciss=
or leather,cut corpse,opencorpse)"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Harvester(cotton,flax,sheep)"=
})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Restock(regs,pots,pouches,clo=
thes)"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"BuyAgent"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"SellAgent"})
+    --~ MyAddHotkeyAction(groupname,{name=3D"Mover/Organizer(items)"})  --=
 move between containers, or to grid positions
+    --~ MyAddHotkeyAction(groupname,{name=3D"UseOnce(Pouches)"}) -- saves =
a list, when an item is used, it is removed from list, when list is empty, =
it is refilled ?
     -- (razor:add/remove friend (targetting))
 	-- todo: screenshot/vid
     =

-    -- misc
-    local groupname =3D "misc"
-    for k,action in pairs(gUOActions) do MyAddHotkeyAction(groupname,actio=
n) end
     =

     -- chat
     local groupname =3D "chat"

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Mar  6 18:35:21 2010
@@ -584,6 +584,12 @@
 end
 function MacroCmd_GetItemInHand () return MacroCmd_GetPlayerEquipment(kLay=
er_OneHanded) end
 function MacroCmd_IsMounted () return MacroCmd_GetPlayerEquipment(kLayer_M=
ount) ~=3D nil end
+function MacroCmd_MountNearby ()
+	if (MacroCmd_IsMounted()) then return end
+	if (IsWarModeActive()) then MacroCmd_ToggleWarmode() end
+	local mount =3D GetRandomArrayElement(MobileList_GetByFilter(function (mo=
bile) return GetUODistToPlayer(mobile.xloc,mobile.yloc) <=3D 2 and (not Mob=
ileIsHuman(mobile)) end))
+	if (mount) then Send_DoubleClick(mount.serial) end
+end
 function MacroCmd_Dismount ()
     if (MacroCmd_IsMounted()) then Send_DoubleClick(GetPlayerSerial()) ret=
urn true end -- todo : check if mounted
 end
@@ -614,6 +620,77 @@
 		Send_Drop_Object(takeserial,xloc,yloc,zloc,0xFFFFFFFF)
 	end)
 end
+
+
+function MacroCmd_TogglePacketVideoRecording() PacketVideo_Recording_Toggl=
e() MacroCmd_RiseText(1,0,0,"packetvideo:rec:"..(gPacketVideoRecording and =
"start" or "stop")) end
+
+function MacroCmd_CycleMaxFPS()
+	local fps =3D {5,10,15,20,40}
+	local found
+	for k,v in pairs(fps) do if (gMaxFPS =3D=3D v) then gMaxFPS =3D fps[k+1] =
found =3D true break end end =

+	if ((not gMaxFPS) or (not found)) then gMaxFPS =3D fps[1] end
+	MacroCmd_RiseText(1,0,0,"maxfps:"..gMaxFPS) =

+end
+
+function MacroCmd_GetOpenBankBoxSerial ()  -- search for bankbox in curren=
tly open containers
+	for k,dynamic in pairs(GetDynamicList()) do =

+		if (dynamic.artid =3D=3D 0xe7c and dynamic.hue =3D=3D 0 and (not Dynamic=
IsInWorld(dynamic))) then =

+			print("bankbox: open",IsContainerAlreadyOpen(dynamic)) -- always false =
in norender, HandleOpenContainer: no gumploader
+			return dynamic.serial
+		end =

+	end
+end
+
+function MacroCmd_LootItem (item,containerserial,amount) =

+	if (not item) then return end
+	job.create(function () =

+		Send_Take_Object(item.serial,min(item.amount,amount or item.amount))
+		job.wait(math.random(200,300))
+		Send_Drop_Object_AutoStack(item.serial,containerserial or GetPlayerBackP=
ackSerial())
+		end)
+end
+
+function MacroCmd_ToggleTextEntryRepeatLastChat() gMacroCmd_OnTextEntryRep=
eat =3D not gMacroCmd_OnTextEntryRepeat MacroCmd_RiseText(1,1,0,"entry:repe=
at:"..(gMacroCmd_OnTextEntryRepeat and "on" or "off")) end
+RegisterListenerOnce("Hook_Unicode_Text_Entry",function () if (gMacroCmd_O=
nTextEntryRepeat) then MacroCmd_RiseText(1,1,0,"entry:repeat") MacroCmd_Rep=
eatLastChat() end end,"MacroCmd_Hook_Unicode_Text_Entry")
+
+function MacroCmd_TargetWeaponInHand () -- useful for poisoning
+	local weapon =3D MacroCmd_GetPlayerEquipment(kLayer_OneHanded) or MacroCm=
d_GetPlayerEquipment(kLayer_TwoHanded) =

+	if (weapon) then MacroCmd_QueueTargetSerial(weapon.serial,1000) end
+end =

+
+function MacroCmd_Scavenge (artlist,dist) MacroCmd_LootItem(GetRandomArray=
Element(MacroCmd_Item_FindNearByArtList(artlist,dist))) end -- try to picku=
p nearby items
+
+function MacroCmd_CutNearbyCorpse ()
+	local corpse =3D GetRandomArrayElement(MacroCmd_Item_FindNearCorpses(2))
+	local blade =3D MacroCmd_Item_FindFirstByArtID({0x0f52,0x13f6,0xec4,0x13b=
6,0xf51}) -- 0x0f52=3Dknife 0x13f6=3Dgargyknife 0xec4:skinningknife
+	if (corpse and blade) then Send_DoubleClick(blade.serial) MacroCmd_QueueT=
argetSerial(corpse.serial,1000) end
+end
+
+function MacroCmd_SimpleLootStep ()
+	local corpses =3D MacroCmd_Item_FindNearCorpses(2)
+	local item
+	for k,corpse in pairs(corpses) do =

+		if (IsContainerAlreadyOpen(corpse)) then =

+			item =3D item or GetRandomArrayElement(corpse:GetContent()) =

+		end =

+	end
+	local backpack	=3D GetPlayerBackPackSerial()
+	local bankbox	=3D MacroCmd_GetOpenBankBoxSerial()
+	for serial,container in pairs(gObjectList) do
+		if (IsContainerAlreadyOpen(container) and serial ~=3D backpack and seria=
l ~=3D bankbox) then =

+			item =3D item or GetRandomArrayElement(container:GetContent()) =

+		end =

+	end
+	=

+	if (item) then MacroCmd_LootItem(item) return end
+	for k,corpse in pairs(corpses) do =

+		if (not IsContainerAlreadyOpen(corpse)) then =

+			Send_DoubleClick(corpse.serial)
+			return =

+		end =

+	end
+end
+
 =

 -- 0x0c9e : ohii tree not hackable
 function MacroCmd_IsHackableTrees (artid) return 0x0c9e ~=3D artid and Str=
ingContains(string.lower(GetStaticTileTypeName(artid)),"tree") end
@@ -680,7 +757,7 @@
     local res =3D {}
     for k,item in pairs(GetDynamicList()) do =

         if (DynamicIsInWorld(item) and =

-            (dist =3D=3D nil or item:GetUODistToPlayer() <=3D dist) and in=
_array(item.artid,artlist)) then
+            (dist =3D=3D nil or item:GetUODistToPlayer() <=3D (dist or 2))=
 and ((not artlist) or in_array(item.artid,artlist))) then
             table.insert(res,item)
         end
     end



From no-reply at zwischenwelt.org  Sun Mar  7 12:11:06 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 07 Mar 2010 11:11:06 -0000
Subject: [Iris-commit] [IRIS] r3267 - /trunk/lua/lib.macrolist.lua
Message-ID: <20100307111106.1E9E07A9807A@simon>

Author: ghoulsblade
Date: Sun Mar  7 12:11:06 2010
New Revision: 3267

Log:
macrocmd : read player str,dex,int

Modified:
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Mar  7 12:11:06 2010
@@ -28,6 +28,9 @@
 gMacroReadMobileStats.maxPet		=3D true
 gMacroReadMobileStats.curPet		=3D true
 gMacroReadMobileStats.tithing		=3D true
+gMacroReadMobileStats.str			=3D true
+gMacroReadMobileStats.dex			=3D true
+gMacroReadMobileStats.int			=3D true
 =

 function GetMobileStat(mobile,statname) return mobile and mobile.stats and=
 mobile.stats[statname] or 0 end =

 function GetMobileRelHP(serial) local mobile =3D GetMobile(serial) return =
mobile and mobile:GetRelHP() end =

@@ -41,6 +44,10 @@
 function GetPlayerHitsMax() return GetMobileStat(GetPlayerMobile(),"maxHit=
s") end =

 function GetPlayerPetsCur() return GetMobileStat(GetPlayerMobile(),"curPet=
") end  -- follower slots
 function GetPlayerPetsMax() return GetMobileStat(GetPlayerMobile(),"maxPet=
") end
+function GetPlayerStr() 	return GetMobileStat(GetPlayerMobile(),"str") end
+function GetPlayerDex() 	return GetMobileStat(GetPlayerMobile(),"dex") end
+function GetPlayerInt() 	return GetMobileStat(GetPlayerMobile(),"int") end
+		=

 function GetPlayerTithingPoints() return GetMobileStat(GetPlayerMobile(),"=
tithing") end
 function IsPlayerHidden() local mobile =3D GetPlayerMobile() return mobile=
 and mobile.flag_hidden end
 =




From no-reply at zwischenwelt.org  Sun Mar  7 14:26:07 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 07 Mar 2010 13:26:07 -0000
Subject: [Iris-commit] [IRIS] r3268 - in /trunk/lua:
 lib.configdialog.hotkeys.lua lib.macrolist.lua net/net.object.lua
Message-ID: <20100307132607.8382754D0007@simon>

Author: ghoulsblade
Date: Sun Mar  7 14:26:07 2010
New Revision: 3268

Log:
hotkey actions bugfixes

Modified:
    trunk/lua/lib.configdialog.hotkeys.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.object.lua

Modified: trunk/lua/lib.configdialog.hotkeys.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.hotkeys.lua (original)
+++ trunk/lua/lib.configdialog.hotkeys.lua Sun Mar  7 14:26:07 2010
@@ -79,6 +79,8 @@
 			local t =3D MacroCmd_JobGetTargetClientSide()
 			if (not t) then return end
 			local obj =3D GetDynamic(MacroCmd_GetStoredTarget_Serial(t) or 0)
+			print("######################################################")
+			print("hotkey:objpick:",SmartDump(t),MacroCmd_GetStoredTarget_Serial(t)=
,obj)
 			if (not obj) then return end
 			HotKeyDialog_SetObject(obj.serial,obj.artid,obj.hue)
 		end)
@@ -259,10 +261,10 @@
     MyAddHotkeyAction(groupname,{name=3D"ToggleStatus"				,callback=3Dfunc=
tion () MacroCmd_Open("Status") end})
     MyAddHotkeyAction(groupname,{name=3D"ToggleCompass"				,callback=3Dfun=
ction () MacroCmd_Open("Compass") end})
     MyAddHotkeyAction(groupname,{name=3D"ToggleMap"					,callback=3Dfuncti=
on () GUI_ToggleMap() end})
-    MyAddHotkeyAction(groupname,{name=3D"CompassZoomIn"				,callback=3Dfun=
ction () MacroCmd_ZoomCompass(1*1.5) end})
-    MyAddHotkeyAction(groupname,{name=3D"CompassZoomOut"				,callback=3Dfu=
nction () MacroCmd_ZoomCompass(1/1.5) end})
-    MyAddHotkeyAction(groupname,{name=3D"CamZoomIn"					,callback=3Dfuncti=
on () MacroCmd_CamChangeZoom( 0.3) end})
-    MyAddHotkeyAction(groupname,{name=3D"CamZoomOut"					,callback=3Dfunct=
ion () MacroCmd_CamChangeZoom(-0.3) end})
+    MyAddHotkeyAction(groupname,{name=3D"CompassZoomOut"				,callback=3Dfu=
nction () MacroCmd_ZoomCompass(1*1.5) end})
+    MyAddHotkeyAction(groupname,{name=3D"CompassZoomIn"				,callback=3Dfun=
ction () MacroCmd_ZoomCompass(1/1.5) end})
+    MyAddHotkeyAction(groupname,{name=3D"CamZoomOut"					,callback=3Dfunct=
ion () MacroCmd_CamChangeZoom( 0.3) end})
+    MyAddHotkeyAction(groupname,{name=3D"CamZoomIn"					,callback=3Dfuncti=
on () MacroCmd_CamChangeZoom(-0.3) end})
     MyAddHotkeyAction(groupname,{name=3D"Screenshot"					,callback=3Dfunct=
ion () MacroCmd_Screenshot() end})
     MyAddHotkeyAction(groupname,{name=3D"PacketVideo:ToggleRecording"	,cal=
lback=3Dfunction () MacroCmd_TogglePacketVideoRecording() end})
     MyAddHotkeyAction(groupname,{name=3D"NextCamMode"					,callback=3Dfunc=
tion () MacroCmd_NextCamMode() end})
@@ -275,9 +277,9 @@
 	=

     -- actions
     local groupname =3D "misc"
-    MyAddHotkeyAction(groupname,{name=3D"UseObjectByType"        	,callbac=
k=3Dfunction (serial,artid,hue) MacroCmd_Item_Use(GetDynamic(serial or 0)) =
end,bHasObjectParam=3Dtrue}) -- {potions,fukija,shuriken,bandage(old)}
-    MyAddHotkeyAction(groupname,{name=3D"UseObjectByID"          	,callbac=
k=3Dfunction (serial,artid,hue) if (artid) then MacroCmd_Item_UseByArtID(ar=
tid,hue) end end,bHasObjectParam=3Dtrue})
-    MyAddHotkeyAction(groupname,{name=3D"UseNearbyByType"        	,callbac=
k=3Dfunction (serial,artid,hue) MacroCmd_Item_Use(GetRandomArrayElement(Mac=
roCmd_Item_FindNearByArtList(artid and {artid},2))) end,bHasObjectParam=3Dt=
rue})
+    MyAddHotkeyAction(groupname,{name=3D"UseObjectByType"        	,callbac=
k=3Dfunction (actiondata,serial,artid,hue) print("hotkey:UseObjectByType",s=
erial,hex(artid),hue) MacroCmd_Item_Use(GetDynamic(serial or 0)) end,bHasOb=
jectParam=3Dtrue}) -- {potions,fukija,shuriken,bandage(old)}
+    MyAddHotkeyAction(groupname,{name=3D"UseObjectByID"          	,callbac=
k=3Dfunction (actiondata,serial,artid,hue) if (artid) then MacroCmd_Item_Us=
eByArtID(artid,hue) end end,bHasObjectParam=3Dtrue})
+    MyAddHotkeyAction(groupname,{name=3D"UseNearbyByType"        	,callbac=
k=3Dfunction (actiondata,serial,artid,hue) MacroCmd_Item_Use(GetRandomArray=
Element(MacroCmd_Item_FindNearByArtList(artid and {artid},2))) end,bHasObje=
ctParam=3Dtrue})
     MyAddHotkeyAction(groupname,{name=3D"LastSpell"              	,callbac=
k=3Dfunction () MacroCmd_RepeatLastSpell() end}) -- todo : targetlast optio=
n ?
     MyAddHotkeyAction(groupname,{name=3D"LastObject"             	,callbac=
k=3Dfunction () MacroCmd_RepeatLastDoubleClick() end})
     MyAddHotkeyAction(groupname,{name=3D"LastChat"               	,callbac=
k=3Dfunction () MacroCmd_RepeatLastChat() end})

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Mar  7 14:26:07 2010
@@ -228,6 +228,8 @@
 	if (not t) then return end
     if (t.hittype =3D=3D kMousePickHitType_Mobile) then return t.mobile.se=
rial end
     if (t.hittype =3D=3D kMousePickHitType_Dynamic) then return t.dynamic.=
serial end
+    if (t.hittype =3D=3D kMousePickHitType_ContainerItem) then return t.it=
em.serial end
+    if (t.hittype =3D=3D kMousePickHitType_PaperdollItem) then return t.it=
em.serial end
 end
 function MacroCmd_GetStoredTarget_Pos (t)
 	if (not t) then return end

Modified: trunk/lua/net/net.object.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.object.lua (original)
+++ trunk/lua/net/net.object.lua Sun Mar  7 14:26:07 2010
@@ -3,6 +3,7 @@
 =

 function Send_DoubleClick (iSerial)
 	if (gbDisableDoubleClick) then return end
+	if (not iSerial) then return end
 	--print("Send_DoubleClick",sprintf("0x%08x",iSerial),GetOneLineBackTrace(=
2))
 	printdebug("net",sprintf("NET: Send_DoubleClick: 0x%08x\n",iSerial))
 	local out =3D GetSendFIFO()



From no-reply at zwischenwelt.org  Fri Mar 12 21:00:21 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 12 Mar 2010 20:00:21 -0000
Subject: [Iris-commit] [IRIS] r3269 - in /trunk/lua: lib.macrolist.lua
	net/net.uoam.lua
Message-ID: <20100312200021.96D307A98072@simon>

Author: ghoulsblade
Date: Fri Mar 12 21:00:21 2010
New Revision: 3269

Log:
bugfix : MacroGetLastTargetSerial

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.uoam.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Fri Mar 12 21:00:21 2010
@@ -429,8 +429,7 @@
 =

 function MacroGetLastTargetSerial ()
     if (not gMacroLastTargetMemory) then return 0 end
-    if (gMacroLastTargetMemory.hittype =3D=3D kMousePickHitType_Mobile) th=
en return gMacroLastTargetMemory.mobile.serial end
-    if (gMacroLastTargetMemory.hittype =3D=3D kMousePickHitType_Dynamic) t=
hen return gMacroLastTargetMemory.dynamic.serial end
+	return MacroCmd_GetStoredTarget_Serial(gMacroLastTargetMemory)
 end
 =

 function MacroCmd_LastTargetVisible ()
@@ -681,6 +680,7 @@
 	for k,corpse in pairs(corpses) do =

 		if (IsContainerAlreadyOpen(corpse)) then =

 			item =3D item or GetRandomArrayElement(corpse:GetContent()) =

+			print("MacroCmd_SimpleLootStep: item after corpse:",item)
 		end =

 	end
 	local backpack	=3D GetPlayerBackPackSerial()
@@ -688,9 +688,11 @@
 	for serial,container in pairs(gObjectList) do
 		if (IsContainerAlreadyOpen(container) and serial ~=3D backpack and seria=
l ~=3D bankbox) then =

 			item =3D item or GetRandomArrayElement(container:GetContent()) =

+			print("MacroCmd_SimpleLootStep: item after container:",item)
 		end =

 	end
 	=

+	print("MacroCmd_SimpleLootStep: item final:",item)
 	if (item) then MacroCmd_LootItem(item) return end
 	for k,corpse in pairs(corpses) do =

 		if (not IsContainerAlreadyOpen(corpse)) then =


Modified: trunk/lua/net/net.uoam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.uoam.lua (original)
+++ trunk/lua/net/net.uoam.lua Fri Mar 12 21:00:21 2010
@@ -366,6 +366,11 @@
 =

 -- handles sequence increment automatically
 function UOAM_PushPosUpdate (fifo,uname,upass,i22,facet,x,y)
+	if (gUOAM_DontSendPosUpdate and gUOAM_LastPushedXLoc) then =

+		x =3D gUOAM_LastPushedXLoc
+		y =3D gUOAM_LastPushedYLoc
+	end
+	--~ print("UOAM_PushPosUpdate",x,y)
 	local seqnum =3D gUOAMSequenceNumber
 	gUOAMSequenceNumber =3D gUOAMSequenceNumber + 1
 	local bytes =3D gUOAMPacketTemplate_PosUpdate
@@ -376,6 +381,8 @@
 	OverwriteByteArrayPart(bytes,128,{facet})
 	OverwriteByteArrayPart(bytes,129,UOAM_Long2ByteArray(x))
 	OverwriteByteArrayPart(bytes,133,UOAM_Long2ByteArray(y))
+	gUOAM_LastPushedXLoc =3D x
+	gUOAM_LastPushedYLoc =3D y
 	FIFOPushByteArray(fifo,bytes)
 end
 =




From no-reply at zwischenwelt.org  Fri Mar 12 22:16:33 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 12 Mar 2010 21:16:33 -0000
Subject: [Iris-commit] [IRIS] r3270 - /trunk/lua/lib.macrolist.lua
Message-ID: <20100312211633.545EC54D0007@simon>

Author: ghoulsblade
Date: Fri Mar 12 22:16:33 2010
New Revision: 3270

Log:
improved MacroCmd_SimpleLootStep

Modified:
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Fri Mar 12 22:16:33 2010
@@ -594,7 +594,7 @@
 function MacroCmd_IsMounted () return MacroCmd_GetPlayerEquipment(kLayer_M=
ount) ~=3D nil end
 function MacroCmd_MountNearby ()
 	if (MacroCmd_IsMounted()) then return end
-	if (IsWarModeActive()) then MacroCmd_ToggleWarmode() end
+	if (IsWarModeActive()) then MacroCmd_ToggleWarmode() return end
 	local mount =3D GetRandomArrayElement(MobileList_GetByFilter(function (mo=
bile) return GetUODistToPlayer(mobile.xloc,mobile.yloc) <=3D 2 and (not Mob=
ileIsHuman(mobile)) end))
 	if (mount) then Send_DoubleClick(mount.serial) end
 end
@@ -676,30 +676,31 @@
 =

 function MacroCmd_SimpleLootStep ()
 	local corpses =3D MacroCmd_Item_FindNearCorpses(2)
-	local item
+	local items =3D {}
+	=

 	for k,corpse in pairs(corpses) do =

 		if (IsContainerAlreadyOpen(corpse)) then =

-			item =3D item or GetRandomArrayElement(corpse:GetContent()) =

-			print("MacroCmd_SimpleLootStep: item after corpse:",item)
+			for k2,item in pairs(corpse:GetContent()) do table.insert(items,item) e=
nd
 		end =

 	end
 	local backpack	=3D GetPlayerBackPackSerial()
 	local bankbox	=3D MacroCmd_GetOpenBankBoxSerial()
 	for serial,container in pairs(gObjectList) do
 		if (IsContainerAlreadyOpen(container) and serial ~=3D backpack and seria=
l ~=3D bankbox) then =

-			item =3D item or GetRandomArrayElement(container:GetContent()) =

-			print("MacroCmd_SimpleLootStep: item after container:",item)
+			for k2,item in pairs(container:GetContent()) do table.insert(items,item=
) end
 		end =

 	end
 	=

-	print("MacroCmd_SimpleLootStep: item final:",item)
+	local item =3D GetRandomArrayElement(items)
 	if (item) then MacroCmd_LootItem(item) return end
+	local unopened_corpses =3D {}
 	for k,corpse in pairs(corpses) do =

 		if (not IsContainerAlreadyOpen(corpse)) then =

-			Send_DoubleClick(corpse.serial)
-			return =

+			table.insert(unopened_corpses,corpse)
 		end =

 	end
+	local openme =3D GetRandomArrayElement(unopened_corpses)
+	if (openme) then Send_DoubleClick(openme.serial) return end
 end
 =

 =




From no-reply at zwischenwelt.org  Fri Mar 12 23:51:02 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 12 Mar 2010 22:51:02 -0000
Subject: [Iris-commit] [IRIS] r3271 - in /trunk/lua:
 lib.configdialog.hotkeys.lua lib.configdialog.lua lib.macrolist.lua
Message-ID: <20100312225106.3A7237A98072@simon>

Author: ghoulsblade
Date: Fri Mar 12 23:50:53 2010
New Revision: 3271

Log:
fixed some hotkey functions

Modified:
    trunk/lua/lib.configdialog.hotkeys.lua
    trunk/lua/lib.configdialog.lua
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.configdialog.hotkeys.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.hotkeys.lua (original)
+++ trunk/lua/lib.configdialog.hotkeys.lua Fri Mar 12 23:50:53 2010
@@ -273,7 +273,15 @@
     MyAddHotkeyAction(groupname,{name=3D"Quit"						,callback=3Dfunction (=
) MacroCmd_Quit() end})
 	=

 	=

-	=

+	function MyHotKeyToggleGlobalRiseText (varname,risetext,onvalue)
+		if (_G[varname]) then =

+			_G[varname] =3D nil =

+			MacroCmd_RiseText(1,0,0,risetext..":-off-")
+		else
+			_G[varname] =3D onvalue or true =

+			MacroCmd_RiseText(0,1,0,risetext..": ON ")
+		end =

+	end
 	=

     -- actions
     local groupname =3D "misc"
@@ -292,7 +300,9 @@
     MyAddHotkeyAction(groupname,{name=3D"TargetWeaponInHand"		,callback=3D=
function () MacroCmd_TargetWeaponInHand() end},"useful for poisoning")
     MyAddHotkeyAction(groupname,{name=3D"WeaponSkill:Primary"    	,callbac=
k=3Dfunction () MacroCmd_WeaponAbilityPrimary() end})
     MyAddHotkeyAction(groupname,{name=3D"WeaponSkill:Secondary"  	,callbac=
k=3Dfunction () MacroCmd_WeaponAbilitySecondary() end})
-    MyAddHotkeyAction(groupname,{name=3D"WeaponSkill:ToggleAuto"	,callback=
=3Dfunction () if (gReActivateWeaponAbilityInterval) then gReActivateWeapon=
AbilityInterval =3D nil else gReActivateWeaponAbilityInterval =3D 3100 end =
end},"auto-reactivate weapon ability after 3 seconds")
+    MyAddHotkeyAction(groupname,{name=3D"WeaponSkill:ToggleAuto"	,callback=
=3Dfunction () =

+		MyHotKeyToggleGlobalRiseText("gReActivateWeaponAbilityInterval","WeaponS=
killAutoReactivate",3100)
+		end},"auto-reactivate weapon ability after 3 seconds")
     MyAddHotkeyAction(groupname,{name=3D"Dismount"               	,callbac=
k=3Dfunction () MacroCmd_Dismount() end})
     MyAddHotkeyAction(groupname,{name=3D"MountNearby"            	,callbac=
k=3Dfunction () MacroCmd_MountNearby() end})
     MyAddHotkeyAction(groupname,{name=3D"SelfInterrupt(hat)"     	,callbac=
k=3Dfunction () InterruptOwnSpell(MacroCmd_GetPlayerEquipment(kLayer_Helm))=
 end},"interrupt self when casting spell")
@@ -303,18 +313,19 @@
     MyAddHotkeyAction(groupname,{name=3D"BandageSelf(use+target)"	,callbac=
k=3Dfunction () MacroCmd_Item_UseByArtID(0xe21) MacroCmd_QueueTargetSerial(=
GetPlayerSerial(),1000) end})
     --~ MyAddHotkeyAction(groupname,{name=3D"BandageNearbyParty"		,callbac=
k=3Dfunction () MacroCmd_Item_UseByArtID(0xe21) MacroCmd_QueueTargetSerial(=
GetNearbyHealCurePartyMember(),1000) end})  -- pet,gray,nonparty..
     MyAddHotkeyAction(groupname,{name=3D"SelectNearest"			,callback=3Dfunc=
tion () local m=3DMacroCmd_FindNearestMob() MobListSetMainTargetSerial(m an=
d m.serial or 0) end})
-    MyAddHotkeyAction(groupname,{name=3D"SelectRandomNonFriendly"	,callbac=
k=3Dfunction () MacroCmd_SmartSelectTarget() end}) -- pvp, random..    -- t=
arget with TargetLast(Smart)
+    MyAddHotkeyAction(groupname,{name=3D"SelectRandomNonFriendly"			,callb=
ack=3Dfunction () MacroCmd_SelectRandomNonFriendly() end})		-- all, random =
   -- target with TargetLast(Smart)
+    MyAddHotkeyAction(groupname,{name=3D"SelectRandomNonFriendlyPlayer"	,c=
allback=3Dfunction () MacroCmd_SelectRandomNonFriendly(true) end})	-- pvp, =
random..    -- target with TargetLast(Smart)
     MyAddHotkeyAction(groupname,{name=3D"AttackSelected"			,callback=3Dfun=
ction () MacroCmd_AttackSelectedMobile() end},"meelee")
     MyAddHotkeyAction(groupname,{name=3D"HideAllCorpses"			,callback=3Dfun=
ction () MacroCmd_HideAllCorpses() end})
     MyAddHotkeyAction(groupname,{name=3D"ToggleHouseBlendout"		,callback=
=3Dfunction () ToggleMultiOnlyShowFloor()  end})
     MyAddHotkeyAction(groupname,{name=3D"ResyncRequest"			,callback=3Dfunc=
tion () Send_Movement_Resync_Request() end},"ask server to resync player po=
sition and objects")
-    MyAddHotkeyAction(groupname,{name=3D"ToggleAlwaysRun"			,callback=3Dfu=
nction () gAlwaysRun =3D not gAlwaysRun end})
+    MyAddHotkeyAction(groupname,{name=3D"ToggleAlwaysRun"			,callback=3Dfu=
nction () MyHotKeyToggleGlobalRiseText("gAlwaysRun","AlwaysRun") end})
     MyAddHotkeyAction(groupname,{name=3D"TargetRandomNearGround"	,callback=
=3Dfunction () MacroCmd_TargetGroundNow(gPlayerXLoc+math.random(3)-2,gPlaye=
rYLoc+math.random(3)-2) end})
     MyAddHotkeyAction(groupname,{name=3D"TargetNearestTree"		,callback=3Df=
unction () local tree =3D GetRandomArrayElement(MacroCmd_FindNearbyTrees(2)=
)  if (tree) then CompleteTargetModeWithTargetStatic(tree) end end})
     MyAddHotkeyAction(groupname,{name=3D"WalkToRandomTree"		,callback=3Dfu=
nction () local tree =3D GetRandomArrayElement(MacroCmd_FindNearbyTrees(20)=
) if (tree) then MacroCmd_PathFindTo(tree.xloc,tree.yloc,2) end end})
     MyAddHotkeyAction(groupname,{name=3D"SimpleLoot"				,callback=3Dfuncti=
on () MacroCmd_SimpleLootStep() end},"loot a random item from nearby corpse=
s")
     MyAddHotkeyAction(groupname,{name=3D"ToggleAutoLoot"			,callback=3Dfun=
ction () ToggleAutoLoot() end})
-    MyAddHotkeyAction(groupname,{name=3D"ScavengeNearby"			,callback=3Dfun=
ction () MacroCmd_Scavenge() end},"picks up nearby items")
+    MyAddHotkeyAction(groupname,{name=3D"ScavengeNearby"			,callback=3Dfun=
ction () MacroCmd_Scavenge(nil,2) end},"picks up nearby items")
     MyAddHotkeyAction(groupname,{name=3D"CutNearbyCorpse"			,callback=3Dfu=
nction () MacroCmd_CutNearbyCorpse() end},"uses dagger or skinning knife to=
 cut a nearby corpse")
     MyAddHotkeyAction(groupname,{name=3D"ToggleTextEntryRepeat"	,callback=
=3Dfunction () MacroCmd_ToggleTextEntryRepeatLastChat() end},"uses last cha=
tline as text for all text-entry prompts, useful for filling vendors")
 	=


Modified: trunk/lua/lib.configdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.lua (original)
+++ trunk/lua/lib.configdialog.lua Fri Mar 12 23:50:53 2010
@@ -88,16 +88,13 @@
     =

 	--~ print("mesadebug:OpenConfigDialog 11")
     ConfigDialogPage_Config(        MyAddPage("Config"))
-	--~ print("mesadebug:OpenConfigDialog 12")
+    ConfigDialogPage_HotKey(        MyAddPage("HotKey"))
     ConfigDialogPage_Graphics(      MyAddPage("Graphics"))
-	--~ print("mesadebug:OpenConfigDialog 14")
     --~ ConfigDialogPage_Macro(         MyAddPage("Macro"))
     ConfigDialogPage_UOAM(          MyAddPage("UOAM"))
-	--~ print("mesadebug:OpenConfigDialog 15")
     ConfigDialogPage_PacketVideo(   MyAddPage("PacketVideo"))
 	--~ print("mesadebug:OpenConfigDialog 16")
     --~ ConfigDialogPage_Misc(          MyAddPage("Misc"))
-    ConfigDialogPage_HotKey(        MyAddPage("HotKey"))
     =

     =

     --[[

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Fri Mar 12 23:50:53 2010
@@ -112,7 +112,7 @@
 function MobileIsHuman   (mobile) =

 	return	mobile and
 			mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401 or
-			mobile.artid =3D=3D 744 or mobile.artid =3D=3D 745 or MobileHasEquip(mo=
bile)
+			mobile.artid =3D=3D 744 or mobile.artid =3D=3D 745 or MobileHasEquip(mo=
bile) -- vampform wolfform ? =

 end
 =

 function MobileList_GetByFilter (fun)
@@ -189,17 +189,11 @@
     f() =

 end
 =

-function MacroCmd_SmartSelectTarget ()
-	local m					=3D MacroCmd_FindNearestNonFriendlyPlayer() =

-	local selectedSerial	=3D m and m.serial
-	local nearlist2	=3D MacroCmd_ListNonFriendlyPlayers() =

-	local nearlist	=3D {}
-	for k,v in pairs(nearlist2) do table.insert(nearlist,v) end
-	local target
-	if (nearlist and countarr(nearlist) =3D=3D 1) then target =3D nearlist[1]=
 end
-	if (nearlist and countarr(nearlist) >=3D 2) then target =3D GetRandomArra=
yElement(nearlist) end
-	if (target) then selectedSerial =3D target.serial end
-	MobListSetMainTargetSerial(selectedSerial or 0) =

+function MacroCmd_SmartSelectTarget 		(bPlayersOnly) MacroCmd_SelectRandom=
NonFriendly(bPlayersOnly) end
+function MacroCmd_SelectRandomNonFriendly	(bPlayersOnly)
+	local target =3D GetRandomTableElementValue(bPlayersOnly and MacroCmd_Lis=
tNonFriendlyPlayers() or MacroCmd_ListNonFriendlyMobiles())
+	print("MacroCmd_SelectRandomNonFriendly",bPlayersOnly,target,target and t=
arget.serial)
+	MobListSetMainTargetSerial(target and target.serial or 0) =

 end
 =

 function MacroCmd_UseNearbyGate () local gate =3D MacroCmd_Item_FindFirstN=
earByArtID(kMoongateGateArtID,nil,1) MacroCmd_Item_Use(gate) return gate ~=
=3D nil end
@@ -666,7 +660,7 @@
 	if (weapon) then MacroCmd_QueueTargetSerial(weapon.serial,1000) end
 end =

 =

-function MacroCmd_Scavenge (artlist,dist) MacroCmd_LootItem(GetRandomArray=
Element(MacroCmd_Item_FindNearByArtList(artlist,dist))) end -- try to picku=
p nearby items
+function MacroCmd_Scavenge (artlist,dist) MacroCmd_LootItem(GetRandomArray=
Element(MacroCmd_Item_FindNearByArtList(artlist,dist,true))) end -- try to =
pickup nearby items
 =

 function MacroCmd_CutNearbyCorpse ()
 	local corpse =3D GetRandomArrayElement(MacroCmd_Item_FindNearCorpses(2))
@@ -765,10 +759,11 @@
     end
 end
 =

-function MacroCmd_Item_FindNearByArtList    (artlist,dist)
+function MacroCmd_Item_FindNearByArtList    (artlist,dist,bSkipCorpses)
     local res =3D {}
     for k,item in pairs(GetDynamicList()) do =

         if (DynamicIsInWorld(item) and =

+			((not bSkipCorpses) or (not IsCorpseArtID(item.artid))) and
             (dist =3D=3D nil or item:GetUODistToPlayer() <=3D (dist or 2))=
 and ((not artlist) or in_array(item.artid,artlist))) then
             table.insert(res,item)
         end
@@ -864,17 +859,19 @@
     return foundmob
 end
 =

-function MacroCmd_ListNonFriendlyPlayers ()
+function MacroCmd_ListNonFriendlyPlayers () return MacroCmd_ListNonFriendl=
yMobiles(true) end =

+function MacroCmd_ListNonFriendlyMobiles (bPlayersOnly)
     local res =3D {}
     for k,mobile in pairs(GetMobileList()) do =

-        if ((mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) and =

+        if (((not bPlayersOnly) or MobileIsHuman(mobile)) and =

             (not IsMobileInParty(mobile.serial)) and
             (not IsPlayerMobile(mobile))) then =

             =

             local labelhue =3D GetItemLabelHue(mobile.serial)
-            if (labelhue ~=3D kPlayerVendorLabelHue) then res[mobile.seria=
l] =3D mobile  end =

-        end
-    end
+            if (labelhue ~=3D kPlayerVendorLabelHue) then res[mobile.seria=
l] =3D mobile end =

+        end
+    end
+	print("MacroCmd_ListNonFriendlyMobiles res",bPlayersOnly,#res)
     return res
 end
 =




From no-reply at zwischenwelt.org  Sat Mar 13 00:23:03 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 12 Mar 2010 23:23:03 -0000
Subject: [Iris-commit] [IRIS] r3272 - /trunk/installdeps.ubuntu.sh
Message-ID: <20100312232303.117E27A98072@simon>

Author: ghoulsblade
Date: Sat Mar 13 00:23:02 2010
New Revision: 3272

Log:
changed compile instructions in installdeps.ubuntu.sh for ogre1.7 : ogre us=
es cmake instead of automake now

Modified:
    trunk/installdeps.ubuntu.sh

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Sat Mar 13 00:23:02 2010
@@ -24,18 +24,25 @@
 echo "then iris will find it during compile : ./makeclean.sh && ./premakel=
inux.sh"
 echo "if you get linker errors like 'undefined reference to ... FMOD_...' =
(64 bit problem) you can disable fmod by editing premake.lua and setting 'g=
bUseSoundFmod =3D true' to false "
 echo ------------------------------
-echo "Ogre1.6"
-echo iris 2 uses ogre1.6 now, there is no package for that yet, so you wil=
l need to compile that from source
-echo to do that, download the source from =

-echo http://sourceforge.net/projects/ogre/files/ogre/1.6.1/ogre-v1-6-1.tar=
.bz2/download
-echo cd ogrenew
-echo aclocal
-echo ./bootstrap
-echo ./configure --enable-cg CXXFLAGS=3D\"-DNDEBUG=3D1\"       =

-echo make
-echo sudo make install
-echo    add a line \"/usr/local/lib\" to /etc/ld.so.conf
-echo sudo /sbin/ldconfig
+echo "Ogre1.7"
+echo "iris 2 uses ogre1.7 now, there is no package for that yet, so you wi=
ll need to compile that from source"
+echo "# download and unpack (tar xfj filename.tar.bz2) https://sourceforge=
.net/projects/ogre/files/ogre/1.7/ogre-v1-7-0p1.tar.bz2/download"
+echo "# follow instructions in ogre/BuildingOgre.txt"
+echo "cd ogre"
+echo "sudo apt-get install cmake-gui"
+echo "mkdir build"
+echo "cmake-gui"
+echo "cd build"
+echo "make"
+echo "sudo make install"
+echo "   add a line \"/usr/local/lib\" to /etc/ld.so.conf"
+echo "sudo /sbin/ldconfig"
+
+#~ echo ./configure --enable-cg CXXFLAGS=3D\"-DNDEBUG=3D1\"       =

+#~ echo make
+#~ echo sudo make install
+#~ echo    add a line \"/usr/local/lib\" to /etc/ld.so.conf
+#~ echo sudo /sbin/ldconfig
 echo ---------------------------------------------
 echo "Ogre1.6 package"
 #~ DISTRO_CODENAME=3Dhardy



From no-reply at zwischenwelt.org  Sat Mar 13 17:01:00 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 13 Mar 2010 16:01:00 -0000
Subject: [Iris-commit] [IRIS] r3273 - /trunk/data/base/main.material
Message-ID: <20100313160100.2962B54D0007@simon>

Author: ghoulsblade
Date: Sat Mar 13 17:01:00 2010
New Revision: 3273

Log:
fixed compass ogre1.7 material

Modified:
    trunk/data/base/main.material

Modified: trunk/data/base/main.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/main.material (original)
+++ trunk/data/base/main.material Sat Mar 13 17:01:00 2010
@@ -25,7 +25,7 @@
 			=

 			// alpha_rejection greater_equal 255
 =

-			texture_unit guitex
+			texture_unit
 			{
 				filtering point point none
 				tex_address_mode clamp
@@ -80,7 +80,7 @@
 			lighting off
 			depth_write off
 =

-			texture_unit guitex
+			texture_unit
 			{
 				texture guibase.png 2d 0
 				tex_address_mode clamp
@@ -197,6 +197,7 @@
 		pass
 		{
 			depth_check off
+			scene_blend alpha_blend
 =

 			texture_unit
 			{
@@ -212,6 +213,7 @@
 		pass
 		{
 			depth_check off
+			scene_blend alpha_blend
 =

 			texture_unit
 			{
@@ -227,6 +229,7 @@
 		pass
 		{
 			depth_check off
+			scene_blend alpha_blend
 =

 			texture_unit
 			{
@@ -270,7 +273,16 @@
 =

 material irislogo : guibase
 {
-	set_texture_alias guitex irislogo256x256bw.png
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture irislogo256x256bw.png 2d 0
+			}
+		}
+	}
 }
 =

 material rtt_base : guibase



From no-reply at zwischenwelt.org  Sat Mar 13 18:16:19 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 13 Mar 2010 17:16:19 -0000
Subject: [Iris-commit] [IRIS] r3274 - /trunk/data/base/ui/ui.material
Message-ID: <20100313171619.BD9BE7A9805B@simon>

Author: ghoulsblade
Date: Sat Mar 13 18:16:19 2010
New Revision: 3274

Log:
fixed mainmenu ogre1.7

Modified:
    trunk/data/base/ui/ui.material

Modified: trunk/data/base/ui/ui.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/ui/ui.material (original)
+++ trunk/data/base/ui/ui.material Sat Mar 13 18:16:19 2010
@@ -2,46 +2,136 @@
 =

 material ui_ray_border : guibase
 {
-	set_texture_alias guitex ui/ray_border.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/ray_border.png 2d 0
+			}
+		}
+	}
 }
 =

 material ui_ray_button : guibase
 {
-	set_texture_alias guitex ui/ray_button.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/ray_button.png 2d 0
+			}
+		}
+	}
 }
 =

 material ui_ray_window : guibase
 {
-	set_texture_alias guitex ui/ray_window.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/ray_window.png 2d 0
+			}
+		}
+	}
 }
 =

 =

 material ui_iris_border : guibase
 {
-	set_texture_alias guitex ui/iris_border.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/iris_border.png 2d 0
+			}
+		}
+	}
 }
 =

 material ui_iris_button : guibase
 {
-	set_texture_alias guitex ui/iris_button.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/iris_button.png 2d 0
+			}
+		}
+	}
 }
 =

 material ui_iris_window : guibase
 {
-	set_texture_alias guitex ui/iris_window.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/iris_window.png 2d 0
+			}
+		}
+	}
 }
 =

 material ui_sience_border : guibase
 {
-	set_texture_alias guitex ui/sience_border.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/sience_border.png 2d 0
+			}
+		}
+	}
 }
 =

 material ui_sience_button : guibase
 {
-	set_texture_alias guitex ui/sience_button.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/sience_button.png 2d 0
+			}
+		}
+	}
 }
 =

 material ui_sience_window : guibase
 {
-	set_texture_alias guitex ui/sience_window.png
+
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture ui/sience_window.png 2d 0
+			}
+		}
+	}
 }



From no-reply at zwischenwelt.org  Sat Mar 13 21:15:28 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 13 Mar 2010 20:15:28 -0000
Subject: [Iris-commit] [IRIS] r3275 - in /trunk: bin/ lua/ vc9_ogre17/
	vc9_ogre17/res/
Message-ID: <20100313201529.3F22854D0007@simon>

Author: sience
Date: Sat Mar 13 21:15:22 2010
New Revision: 3275

Log:
-win32 Binary of Iris2 updated to Ogre 1.7
-new project settings added

Added:
    trunk/vc9_ogre17/
    trunk/vc9_ogre17/iris.sln
    trunk/vc9_ogre17/iris.vcproj
    trunk/vc9_ogre17/res/
    trunk/vc9_ogre17/res/iris.ico   (with props)
    trunk/vc9_ogre17/res/resource.rc
Modified:
    trunk/bin/OIS.dll
    trunk/bin/OgreMain.dll
    trunk/bin/Plugin_CgProgramManager.dll
    trunk/bin/Plugin_ParticleFX.dll
    trunk/bin/RenderSystem_Direct3D9.dll
    trunk/bin/RenderSystem_GL.dll
    trunk/bin/cg.dll
    trunk/bin/iris2.exe
    trunk/lua/config_declarations.lua

Modified: trunk/bin/OIS.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/OgreMain.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_CgProgramManager.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_ParticleFX.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_Direct3D9.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_GL.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/cg.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sat Mar 13 21:15:22 2010
@@ -41,7 +41,7 @@
 gConfig:DeclareBoolean("gHideHUDNames", "gui", "hide hud names", 'TODO', f=
alse)
 gConfig:DeclareBoolean("gHideUOCursor", "gui", "hide uo cursor", 'TODO', f=
alse)
 gConfig:DeclareBoolean("gHideFPS", "gui", "hide fps", 'TODO old but requir=
ed for lugre', true)
-gConfig:DeclareBoolean("gHideMemoryUsage", "gui", "hide memory usage", 'TO=
DO includes now also fps', false)
+gConfig:DeclareBoolean("gHideMemoryUsage", "gui", "hide memory usage", 'TO=
DO includes now also fps', true)
 =

 -- Font settings
 gFontDefs  =3D {}



From no-reply at zwischenwelt.org  Fri Mar 19 23:22:52 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 19 Mar 2010 22:22:52 -0000
Subject: [Iris-commit] [IRIS] r3276 - in /trunk/lua: lib.thread.lua main.lua
Message-ID: <20100319222252.9F93A7A9807B@simon>

Author: ghoulsblade
Date: Fri Mar 19 23:22:52 2010
New Revision: 3276

Log:
thread tests

Modified:
    trunk/lua/lib.thread.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Fri Mar 19 23:22:52 2010
@@ -1,12 +1,54 @@
---[[
-if (Threads_GetHardwareConcurrency) then
-	print("Threads_GetHardwareConcurrency:",Threads_GetHardwareConcurrency())
+function RunThreadTest () RunThreadTest_Main() end =

+
+function RunThreadTest_Main ()
+	print("main: Threads_GetHardwareConcurrency:",Threads_GetHardwareConcurre=
ncy())
 	=

 	local thread =3D CreateLuaThread("../mythread.lua")
-	Client_Sleep(2) =

+	print("main: child started")
+	--~ thread:Interrupt()
+	--~ Client_Sleep(1) =

+	=

+	=

+	=

+	--~ Client_USleep(1*1000)
+	--~ Thread_Sleep(1*1000)
+	=

+	print("main: lock and send..")
+	thread:LockMutex()
+	local fifo =3D thread:CreateFifoHandle()
+	fifo:PushUint8(10)
+	thread:UnLockMutex()
+	print("main: sleep...")
+	Client_USleep(5*1000) =

+	print("main: send interrupt...")
 	thread:Interrupt()
-	Client_Sleep(1) =

-	print("end")
+	print("main: interrupt done, sleeping...")
+	Client_USleep(5*60*1000) =

+	print("main: end")
 	os.exit(0)
 end
-]]--
+
+function RunThreadTest_Child () =

+	print("child: hello world,this_thread=3D",this_thread,this_thread:CreateF=
ifoHandle())
+	Thread_Sleep(5*1000)
+
+	print("child: getmutex")
+
+	this_thread:LockMutex()
+	local fifo =3D this_thread:CreateFifoHandle()
+	this_thread:UnLockMutex()
+
+
+	for i=3D1,211 do =

+		print("child: sleeping")
+		if (Thread_Sleep(1*1000)) then print("child: interrupted") break end
+	end
+
+	print("child: lock and read...")
+	this_thread:LockMutex()
+	print("child: FifoSize",fifo:Size())
+	this_thread:UnLockMutex()
+
+	print("child: ended")
+end
+

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Fri Mar 19 23:22:52 2010
@@ -170,6 +170,7 @@
 dofile(libpath .. "lib.proxy.lua")
 dofile(libpath .. "lib.randomname.lua")
 dofile(libpath .. "lib.weaponability.lua")
+dofile(libpath .. "lib.thread.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")
@@ -463,6 +464,7 @@
 --- main function, when it returns, the program ends
 function Main ()
 	if (gCommandLineSwitches["-radeonbug"]) then RadeonBugTest() end
+	if (gCommandLineSwitches["-threadtest"]) then RunThreadTest() end
 =

     if (gCommandLineSwitches["-proxy"]) then =

 		local host =3D gCommandLineArguments[gCommandLineSwitches["-proxy"]+1]



From no-reply at zwischenwelt.org  Sat Mar 20 00:23:16 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 19 Mar 2010 23:23:16 -0000
Subject: [Iris-commit] [IRIS] r3277 - /trunk/lua/lib.thread.lua
Message-ID: <20100319232317.3EC277A9807B@simon>

Author: hagish
Date: Sat Mar 20 00:23:16 2010
New Revision: 3277

Log:
duplex communication from parent to child thread

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 00:23:16 2010
@@ -1,22 +1,23 @@
 function RunThreadTest () RunThreadTest_Main() end =

 =

 function RunThreadTest_Main ()
-	print("main: Threads_GetHardwareConcurrency:",Threads_GetHardwareConcurre=
ncy())
+	print("main: Threads_GetHardwareConcurrency:", Threads_GetHardwareConcurr=
ency())
 	=

 	local thread =3D CreateLuaThread("../mythread.lua")
 	print("main: child started")
 	--~ thread:Interrupt()
 	--~ Client_Sleep(1) =

 	=

-	=

-	=

 	--~ Client_USleep(1*1000)
 	--~ Thread_Sleep(1*1000)
 	=

 	print("main: lock and send..")
 	thread:LockMutex()
-	local fifo =3D thread:CreateFifoHandle()
-	fifo:PushUint8(10)
+	local fifo_send =3D thread:CreateFifoParent2ChildHandle()
+	local fifo_recv =3D thread:CreateFifoChild2ParentHandle()
+	=

+	fifo_send:PushUint8(10)
+	=

 	thread:UnLockMutex()
 	print("main: sleep...")
 	Client_USleep(5*1000) =

@@ -29,15 +30,10 @@
 end
 =

 function RunThreadTest_Child () =

-	print("child: hello world,this_thread=3D",this_thread,this_thread:CreateF=
ifoHandle())
+	print("child: hello world,this_thread=3D",this_thread)
 	Thread_Sleep(5*1000)
 =

 	print("child: getmutex")
-
-	this_thread:LockMutex()
-	local fifo =3D this_thread:CreateFifoHandle()
-	this_thread:UnLockMutex()
-
 =

 	for i=3D1,211 do =

 		print("child: sleeping")
@@ -46,7 +42,8 @@
 =

 	print("child: lock and read...")
 	this_thread:LockMutex()
-	print("child: FifoSize",fifo:Size())
+	print("child: FifoSizeRecv",this_fifo_recv:Size())
+	print("child: FifoSizeSend",this_fifo_send:Size())
 	this_thread:UnLockMutex()
 =

 	print("child: ended")



From no-reply at zwischenwelt.org  Sat Mar 20 01:33:22 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 00:33:22 -0000
Subject: [Iris-commit] [IRIS] r3279 - /trunk/lua/lib.thread.lua
Message-ID: <20100320003322.5E66F7A98079@simon>

Author: ghoulsblade
Date: Sat Mar 20 01:33:22 2010
New Revision: 3279

Log:
threadtest : child copies received data and unlocks mutex before handling m=
essages, so that message sending from other threads isn't blocked in case o=
f longer handling

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 01:33:22 2010
@@ -69,10 +69,8 @@
 	=

 	function MySend (msgtype,...)
 		thread:LockMutex()
-		print("main:send. before fifosize=3D",fifo_send:Size())
 		fifo_send:PushUint8(msgtype)
 		FPush(fifo_send,gNetMessageParamFormat[msgtype],...)
-		print("main:send. after  fifosize=3D",fifo_send:Size())
 		thread:UnLockMutex()
 		thread:Interrupt()
 	end
@@ -89,7 +87,7 @@
 	for i=3D1,10 do =

 		print("main:send")
 		MySend(kThreadMessage_Debug,i,42,"bla!")
-		Client_USleep(5*1000) =

+		Client_USleep(2*1000) =

 	end
 	=

 	=

@@ -108,10 +106,23 @@
 	RunThreadTest_RegisterMessageTypes()
 	--~ Thread_Sleep(5*1000)
 	=

+	=

+	function MySend (msgtype,...)
+		thread:LockMutex()
+		this_fifo_send:PushUint8(msgtype)
+		FPush(this_fifo_send,gNetMessageParamFormat[msgtype],...)
+		thread:UnLockMutex()
+		thread:Interrupt()
+	end
+	=

+	=

+	local local_fifo_recv =3D CreateFIFO()
 	while (true) do =

 		this_thread:LockMutex()
-		RecvNetMessages(this_fifo_recv,function (msgtype,...) print("child:msg",=
msgtype,...) end)
-		this_thread:UnLockMutex()
+		local_fifo_recv:PushFIFOPartRaw(this_fifo_recv) -- move data from this_f=
ifo_recv to local_fifo_recv
+		this_fifo_recv:Clear()
+		this_thread:UnLockMutex() -- release so we don't block while processing =
messages
+		RecvNetMessages(local_fifo_recv,function (msgtype,...) print("child:msg"=
,msgtype,...) end)
 		Thread_Sleep(999*1000)
 	end
 	=




From no-reply at zwischenwelt.org  Sat Mar 20 01:23:56 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 00:23:56 -0000
Subject: [Iris-commit] [IRIS] r3278 - /trunk/lua/lib.thread.lua
Message-ID: <20100320002356.DA9C77A98079@simon>

Author: ghoulsblade
Date: Sat Mar 20 01:23:56 2010
New Revision: 3278

Log:
thread experiments

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 01:23:56 2010
@@ -1,7 +1,59 @@
-function RunThreadTest () RunThreadTest_Main() end =

+function RunThreadTest () RunThreadTest_Main() end  --  -threadtest
+
+-- see lib.netmessage.lua  for message system
+--[[
+	RecvNetMessages (fifo,callback)
+
+	-- receive messages from clients
+	RecvNetMessages(myplayer.netRecvFifo,function (msgtype,...) =

+			local msgtypename =3D gNetMessageTypeName[msgtype]
+			if (gMessageTypeHandler_Server[msgtypename]) then =

+				gMessageTypeHandler_Server[msgtypename](myplayer,unpack(arg))
+			end
+			NotifyListener("Hook_Server_RecvNetMsg",myplayer,msgtype,unpack(arg))
+		end)
+		=

+	FPush(gSendFifo,gNetMessageParamFormat[msgtype],...)
+
+	gMessageTypeHandler_Client.kNetMessage_Chat =3D function (iParam,iFlags,s=
ChatText)  .. end
+	=

+	RegisterNetMessageType("kNetMessage_Chat"						,"iis")			-- sent by serve=
r and client : param,flags,chattext (used for client and server, if from cl=
ient then param =3D target else param =3D from)
+			=

+	RegisterNetMessageFormatWrapper("o","i",function (obj) return obj and obj=
.id or 0 end,  -- obj2id  =

+											function (objid) return GetObject(objid) end)	-- id2obj
+
+											=

+	function FIFOPushNetSimpleTable(tbl, fifo)
+	function FIFOPopNetSimpleTable(fifo)
+]]--
+
+--[[
+gConfig:DeclareEnum("gGroundBlockLoaderType"	, "loader", "ground loader"		=
, 'TODO', "Blockwise", {"OnDemand","FullFile","Blockwise"})
+gConfig:DeclareEnum("gStaticBlockLoaderType"	, "loader", "static loader"		=
, 'TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gRadarColorLoaderType"		, "loader", "radar color load=
er", 'TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gTileTypeLoaderType"		, "loader", "tile type loader"	=
, 'TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gTexMapLoaderType"			, "loader", "tex map loader"	, '=
TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gArtMapLoaderType"			, "loader", "art map loader"	, '=
TODO', "OnDemand", {"OnDemand","FullFile"})
+gConfig:DeclareEnum("gGumpLoaderType"			, "loader", "gump loader"		, 'TODO=
', "OnDemand", {"OnDemand","FullFile"})
+gConfig:DeclareEnum("gClilocLoaderType"			, "loader", "cliloc loader"		, '=
TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gSoundLoaderType"			, "loader", "sound loader"		, 'TO=
DO', "OnDemand", {"OnDemand","FullFile"})
+gConfig:DeclareEnum("gSpeechLoaderType"			, "loader", "speech loader"		, '=
TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gHueLoaderType"			, "loader", "hue loader"		, 'TODO',=
 "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gAnimLoaderType"			, "loader", "anim loader"		, 'TODO=
', "Blockwise", {"OnDemand","FullFile","Blockwise"})
+gConfig:DeclareEnum("gMultiLoaderType"			, "loader", "multi loader"		, 'TO=
DO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gStitchinLoaderType"		, "loader", "stitchin loader"	,=
 'TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gAnimDataLoaderType"		, "loader", "anim data loader"	=
, 'TODO', "FullFile", {"FullFile"})
+gConfig:DeclareEnum("gGrannyLoaderType"			, "loader", "granny loader"		, '=
TODO', "OnDemand", {"OnDemand"})
+gConfig:DeclareEnum("gUniFontLoaderType"		, "loader", "uni font loader"	, =
'TODO', "FullFile", {"FullFile"})
+]]--
+
+function RunThreadTest_RegisterMessageTypes ()
+	RegisterNetMessageType("kThreadMessage_Debug","iis")
+end
 =

 function RunThreadTest_Main ()
 	print("main: Threads_GetHardwareConcurrency:", Threads_GetHardwareConcurr=
ency())
+	RunThreadTest_RegisterMessageTypes()
 	=

 	local thread =3D CreateLuaThread("../mythread.lua")
 	print("main: child started")
@@ -12,18 +64,37 @@
 	--~ Thread_Sleep(1*1000)
 	=

 	print("main: lock and send..")
-	thread:LockMutex()
 	local fifo_send =3D thread:CreateFifoParent2ChildHandle()
 	local fifo_recv =3D thread:CreateFifoChild2ParentHandle()
 	=

-	fifo_send:PushUint8(10)
+	function MySend (msgtype,...)
+		thread:LockMutex()
+		print("main:send. before fifosize=3D",fifo_send:Size())
+		fifo_send:PushUint8(msgtype)
+		FPush(fifo_send,gNetMessageParamFormat[msgtype],...)
+		print("main:send. after  fifosize=3D",fifo_send:Size())
+		thread:UnLockMutex()
+		thread:Interrupt()
+	end
 	=

-	thread:UnLockMutex()
+	--~ thread:LockMutex()
+	--~ fifo_send:PushUint8(10)
+	--~ thread:UnLockMutex()
+	=

 	print("main: sleep...")
-	Client_USleep(5*1000) =

-	print("main: send interrupt...")
-	thread:Interrupt()
-	print("main: interrupt done, sleeping...")
+	Client_USleep(2*1000) =

+	--~ print("main: send interrupt...")
+	--~ thread:Interrupt()
+	=

+	for i=3D1,10 do =

+		print("main:send")
+		MySend(kThreadMessage_Debug,i,42,"bla!")
+		Client_USleep(5*1000) =

+	end
+	=

+	=

+	=

+	print("main: done, sleeping before end...")
 	Client_USleep(5*60*1000) =

 	print("main: end")
 	os.exit(0)
@@ -31,20 +102,32 @@
 =

 function RunThreadTest_Child () =

 	print("child: hello world,this_thread=3D",this_thread)
-	Thread_Sleep(5*1000)
+	dofile(GetMainWorkingDir().."mylugre/lua/lib.util.lua") =

+	dofile(GetMainWorkingDir().."mylugre/lua/lib.fifo.lua") =

+	dofile(GetMainWorkingDir().."mylugre/lua/lib.netmessage.lua") =

+	RunThreadTest_RegisterMessageTypes()
+	--~ Thread_Sleep(5*1000)
+	=

+	while (true) do =

+		this_thread:LockMutex()
+		RecvNetMessages(this_fifo_recv,function (msgtype,...) print("child:msg",=
msgtype,...) end)
+		this_thread:UnLockMutex()
+		Thread_Sleep(999*1000)
+	end
+	=

 =

-	print("child: getmutex")
+	--~ print("child: getmutex")
 =

-	for i=3D1,211 do =

-		print("child: sleeping")
-		if (Thread_Sleep(1*1000)) then print("child: interrupted") break end
-	end
+	--~ for i=3D1,211 do =

+		--~ print("child: sleeping")
+		--~ if (Thread_Sleep(1*1000)) then print("child: interrupted") break end
+	--~ end
 =

-	print("child: lock and read...")
-	this_thread:LockMutex()
-	print("child: FifoSizeRecv",this_fifo_recv:Size())
-	print("child: FifoSizeSend",this_fifo_send:Size())
-	this_thread:UnLockMutex()
+	--~ print("child: lock and read...")
+	--~ this_thread:LockMutex()
+	--~ print("child: FifoSizeRecv",this_fifo_recv:Size())
+	--~ print("child: FifoSizeSend",this_fifo_send:Size())
+	--~ this_thread:UnLockMutex()
 =

 	print("child: ended")
 end



From no-reply at zwischenwelt.org  Sat Mar 20 01:35:21 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 00:35:21 -0000
Subject: [Iris-commit] [IRIS] r3280 - in /trunk:
 lua/lib.configdialog.hotkeys.lua lua/lib.granny.debug.lua
 lua/lib.granny.loader.lua lua/lib.macrolist.lua lua/net/net.skill.lua
 lua/net/net.uoam.lua plugins/itemcounter.lua
Message-ID: <20100320003522.00D0D7A98079@simon>

Author: ghoulsblade
Date: Sat Mar 20 01:35:21 2010
New Revision: 3280

Log:
uoam chat fix, MacroCmd_PathFindTo step callback, MacroCmd_RepeatLastSkill+=
hotkey

Modified:
    trunk/lua/lib.configdialog.hotkeys.lua
    trunk/lua/lib.granny.debug.lua
    trunk/lua/lib.granny.loader.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.skill.lua
    trunk/lua/net/net.uoam.lua
    trunk/plugins/itemcounter.lua

Modified: trunk/lua/lib.configdialog.hotkeys.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.configdialog.hotkeys.lua (original)
+++ trunk/lua/lib.configdialog.hotkeys.lua Sat Mar 20 01:35:21 2010
@@ -291,6 +291,7 @@
     MyAddHotkeyAction(groupname,{name=3D"LastSpell"              	,callbac=
k=3Dfunction () MacroCmd_RepeatLastSpell() end}) -- todo : targetlast optio=
n ?
     MyAddHotkeyAction(groupname,{name=3D"LastObject"             	,callbac=
k=3Dfunction () MacroCmd_RepeatLastDoubleClick() end})
     MyAddHotkeyAction(groupname,{name=3D"LastChat"               	,callbac=
k=3Dfunction () MacroCmd_RepeatLastChat() end})
+    MyAddHotkeyAction(groupname,{name=3D"LastSkill"               ,callbac=
k=3Dfunction () MacroCmd_RepeatLastSkill() end})
     MyAddHotkeyAction(groupname,{name=3D"ToggleWarmode"          	,callbac=
k=3Dfunction () MacroCmd_ToggleWarmode() end})
     MyAddHotkeyAction(groupname,{name=3D"OpenDoor"       		   	,callback=
=3Dfunction () MacroCmd_OpenDoors() end})
     MyAddHotkeyAction(groupname,{name=3D"SpamLastSpell"			,callback=3Dfunc=
tion () MacroCmd_TargetLastNow() MacroCmd_RepeatLastSpell() end},"repeat la=
st spell on last target")

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Sat Mar 20 01:35:21 2010
@@ -301,8 +301,9 @@
 		local combos =3D {}
 		=

 		-- assembling vertex-buffer, this block doesn't need ogre
-		=

 		local rr =3D 0
+		--[[
+		!!!!!! MOVED TO lib.granny.anim.lua cSubMeshConstructor::Execute !!!!!
 		for k,poly in pairs(polygons) do =

 			local texpoly =3D texpolys and texpolys[k] =

 			for i=3D0,2 do =

@@ -333,6 +334,7 @@
 				ib:Index(comboi)
 			end
 		end
+		]]--
 		vb0:CheckSize()
 		vb1:CheckSize()
 		local fSquareRadius =3D rr
@@ -346,8 +348,8 @@
 		local msMatName =3D matname -- TODO!
 		=

 		-- create submesh
-		local sub =3D pOgreMesh:createSubMesh();
-		sub:setMaterialName(msMatName);
+		local sub =3D pOgreMesh:createSubMesh()
+		sub:setMaterialName(msMatName)
 		sub:setUseSharedVertices(false)
 		=

 		sub:setOperationType(OT_TRIANGLE_LIST)
@@ -521,9 +523,11 @@
 obj     9/36    {[2]=3D3,[4]=3D14=3D0x0e,[6]=3D0,}
 obj     10/36   {[2]=3D3,[4]=3D15=3D0x0f,[6]=3D0,}
 obj     11/36   {[2]=3D3,[4]=3D16=3D0x10,[6]=3D0,}
-]]--
-
---[[
+
+
+***************
+
+
 cGrannyFile:LoadFile    /home/ghoul/Desktop/cavern/uoml/Models/Animals/Equ=
ines_Horse_Dappled_Brown_Lod2.grn                                          =
         =

 text    1/46    "__Standard"                                              =
                                                                           =
         =

 text    2/46    "__FileName"                                              =
                                                                           =
         =

@@ -640,17 +644,6 @@
 obj     9/40    {[2]=3D3,[4]=3D13=3D0x0d,[6]=3D0,}
 obj     10/40   {[2]=3D3,[4]=3D14=3D0x0e,[6]=3D0,}
 obj     11/40   {[2]=3D3,[4]=3D15=3D0x0f,[6]=3D0,}
-
-]]--
-
-
-
-
-
-
-
-
---[[
 	=

 	point   				1/557   {y=3D-0.710749,x=3D-0.767177,z=3D1.416132,}          =
                                                                           =
                                                                   =

 	normal 					1/553   {y=3D0,x=3D0,z=3D0,}                                 =
                                                                           =
                                     =


Modified: trunk/lua/lib.granny.loader.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.loader.lua (original)
+++ trunk/lua/lib.granny.loader.lua Sat Mar 20 01:35:21 2010
@@ -1,5 +1,8 @@
 -- redesign of grannyloader in lua
 -- start with -grannytest   ->StartGrannyTest()
+--~ ./start.sh -sdg         (console output)
+--~ ./start.sh -sdg -res 640x480 -maxfps 20
+--~ lib.granny.debug.lua
 =

 --[[
 =


Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Mar 20 01:35:21 2010
@@ -922,6 +922,9 @@
     Send_Request_SkillUse(skillid)
 end
 =

+function MacroCmd_RepeatLastSkill ()
+	if (gLastUsedSkillID) then Send_Request_SkillUse(gLastUsedSkillID) end
+end
 function MacroCmd_RepeatLastSpell ()
     if (gLastSpellID) then Send_Spell(gLastSpellID) end
 end
@@ -1205,7 +1208,7 @@
 end
 =

 -- bMarkOnly : for debugging, creates markers on route
-function MacroCmd_PathFindTo	(xloc,yloc,tolerance,timeout,bNoLog,bAutoOpen=
Doors,bShowMarkers)
+function MacroCmd_PathFindTo	(xloc,yloc,tolerance,timeout,bNoLog,bAutoOpen=
Doors,bShowMarkers,step_callback)
 	tolerance =3D tolerance or 0
 	local bLog =3D not bNoLog
 	if (bLog) then print("MacroCmd_PathFindTo : start",xloc,yloc,tolerance,ti=
meout) end
@@ -1240,6 +1243,7 @@
 					if (bLog) then print("MacroCmd_PathFindTo : failed, timeout") end
 					return
 				end
+				if (step_callback and step_callback()) then return end -- cancel if st=
ep_callback returns true =

 				if (gMyTicks > nextstept) then break end
 			until GetUODistToPlayer(wp_xloc,wp_yloc) <=3D 0 -- repeat (turn,walk) u=
ntil this next tile reached
 			if (gMyTicks > nextstept) then break end

Modified: trunk/lua/net/net.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.skill.lua (original)
+++ trunk/lua/net/net.skill.lua Sat Mar 20 01:35:21 2010
@@ -3,6 +3,7 @@
 =

 -- Request SkillUse
 function Send_Request_SkillUse(skillid)
+	gLastUsedSkillID =3D skillid
 	local s =3D tostring(skillid-1).." 0"	-- i dont know why we must -1 here =
:)
 	local size =3D 4+string.len(s)+1
 	=


Modified: trunk/lua/net/net.uoam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.uoam.lua (original)
+++ trunk/lua/net/net.uoam.lua Sat Mar 20 01:35:21 2010
@@ -198,7 +198,9 @@
 		end
 	until false
 end
-	=

+
+
+
 function UOAM_RecvData_OnePacket (fifo,len)
 	local packetheadercode =3D fifo:PeekNetUint8(2) -- should be 0x02, except=
 in first packet
 	local msgtype =3D fifo:PeekNetUint8(20)
@@ -247,35 +249,13 @@
 		--~ fifo:PopRaw(1) -- zero term
 		local rest =3D fifo:Size()
 		=

-		local bDebug =3D true
-		local text =3D ""
-		if (bDebug) then text =3D text .. sprintf("n%d:",namelen) end
-		=

-		-- weird shit, this took a while to find out... also needed during sendi=
ng
-		--~ local padlength =3D 3 - math.mod(namelen,4)
-		--~ fifo:PopRaw(padlength)
-	=

-		--~ print("name",namelen,name,"padlen=3D",padlength)
-		--~ print(FIFOHexDump(fifo))
-	=

-		function IsAscii (c) return c >=3D 32 and c < 128 end
-		local firstascii
-		for i=3D1,rest do =

-			local c =3D fifo:PopUint8()
-			if ((not firstascii) and IsAscii(c) and i < rest and IsAscii(fifo:PeekN=
etUint8(0))) then
-				text =3D text .. "<"..i..">"
-				firstascii =3D i
-			end
-			if (IsAscii(c)) then =

-				text =3D text .. string.char(c)
-			elseif (bDebug) then =

-				if (c > 0) then =

-					text =3D text .. ("["..c.."]")
-				else =

-					text =3D text .. "_"
-				end
-			end
-		end
+		function GetSkipLen (x) return 16 - math.mod(x-1,4) end
+		function TestSkipLen (namelen,skip) print(GetSkipLen(namelen)) assert(Ge=
tSkipLen(namelen) =3D=3D skip,"bad GetSkipLen("..tostring(namelen)..")=3D".=
.tostring(GetSkipLen(namelen))..", should be "..tostring(skip)) end
+		TestSkipLen( 5,16) -- 16 - math.mod(x-1,4) =3D 0    vime
+		TestSkipLen( 6,15) -- 16 - math.mod(x-1,4) =3D 1    maxey,frost,laura
+		TestSkipLen( 7,14) -- 16 - math.mod(x-1,4) =3D 2    vilmon,cridan,johnny=
,miller
+		TestSkipLen( 8,13) -- 16 - math.mod(x-1,4) =3D 3    castiel
+		TestSkipLen(12,13) -- 16 - math.mod(x-1,4) =3D 3    ghoulsblade
 		=

 		-- namelen5,off:16 mike		+=3D21
 		-- namelen6,off:15 frost	+=3D21
@@ -284,11 +264,49 @@
 		-- namelen7,off:14 grolic			+=3D21			=

 		-- namelen13,off:16 page morgain	+=3D29=3D21+8
 		-- namelen14,off:15 jeen sunburst	+=3D29=3D21+8
+		=

+		local skiplen =3D GetSkipLen(namelen)
+		=

+		local bDebug =3D false
+		--~ local bDebug =3D true
+		local text =3D ""
+		if (bDebug) then =

+			text =3D text .. sprintf("n%d:",namelen) =

+			=

+			-- weird shit, this took a while to find out... also needed during send=
ing
+			--~ local padlength =3D 3 - math.mod(namelen,4)
+			--~ fifo:PopRaw(padlength)
+		=

+			--~ print("name",namelen,name,"padlen=3D",padlength)
+			--~ print(FIFOHexDump(fifo))
+		=

+			function IsAscii (c) return c >=3D 32 and c < 128 end
+			local firstascii
+			for i=3D1,rest do =

+				local c =3D fifo:PopUint8()
+				if ((not firstascii) and IsAscii(c) and i < rest and IsAscii(fifo:Peek=
NetUint8(0))) then
+					text =3D text .. "<"..i..">"
+					firstascii =3D i
+				end
+				if (IsAscii(c)) then =

+					text =3D text .. string.char(c)
+				elseif (bDebug) then =

+					if (c > 0) then =

+						text =3D text .. ("["..c.."]")
+					else =

+						text =3D text .. "_"
+					end
+				end
+			end
+		else
+			fifo:PopRaw(skiplen-1)
+			text =3D fifo:PopFilledString(fifo:Size())
+		end
+		=

 	=

 		--~ local textlen =3D fifo:PopUint8()
 		--~ fifo:PopRaw(11) -- wrong
 		--~ local text =3D fifo:PopFilledString(fifo:Size()) -- wrong
-		=

 		=

 		--~ print("text",textlen,text)
 		print("uoam:chat",name,text)

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Sat Mar 20 01:35:21 2010
@@ -50,6 +50,7 @@
 	{{name=3D"bandas"		,artid=3D0xe21,	usagetype=3DkItemCounterUsageType_Use}=
},
 	{{name=3D"arrows"		,artid=3D3903,hue=3D0}},
 	{{name=3D"bolts"		,artid=3D0x1bfb,hue=3D0}},
+	{{name=3D"gheal"		,artid=3D0xf0e,hue=3D2125}},
 	=

 	{ -- tailor
 		{name=3D"cloth"			,artid=3D0x1766},



From no-reply at zwischenwelt.org  Sat Mar 20 01:42:51 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 00:42:51 -0000
Subject: [Iris-commit] [IRIS] r3281 - /trunk/lua/lib.thread.lua
Message-ID: <20100320004251.C7F6F7A98079@simon>

Author: ghoulsblade
Date: Sat Mar 20 01:42:51 2010
New Revision: 3281

Log:
threadtest : SendNetMessageFifo , fixed mylugre/lugre path

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 01:42:51 2010
@@ -69,8 +69,7 @@
 	=

 	function MySend (msgtype,...)
 		thread:LockMutex()
-		fifo_send:PushUint8(msgtype)
-		FPush(fifo_send,gNetMessageParamFormat[msgtype],...)
+		SendNetMessageFifo(fifo_send,msgtype,...)
 		thread:UnLockMutex()
 		thread:Interrupt()
 	end
@@ -100,19 +99,18 @@
 =

 function RunThreadTest_Child () =

 	print("child: hello world,this_thread=3D",this_thread)
-	dofile(GetMainWorkingDir().."mylugre/lua/lib.util.lua") =

-	dofile(GetMainWorkingDir().."mylugre/lua/lib.fifo.lua") =

-	dofile(GetMainWorkingDir().."mylugre/lua/lib.netmessage.lua") =

+	lugreluapath        =3D (file_exists(GetMainWorkingDir().."mylugre") and =
GetMainWorkingDir().."mylugre/lua/" or GetLugreLuaPath()) -- this is should=
 also in USERHOME dir
+	dofile(lugreluapath.."lib.util.lua") =

+	dofile(lugreluapath.."lib.fifo.lua") =

+	dofile(lugreluapath.."lib.netmessage.lua") =

 	RunThreadTest_RegisterMessageTypes()
 	--~ Thread_Sleep(5*1000)
 	=

 	=

 	function MySend (msgtype,...)
 		thread:LockMutex()
-		this_fifo_send:PushUint8(msgtype)
-		FPush(this_fifo_send,gNetMessageParamFormat[msgtype],...)
+		SendNetMessageFifo(this_fifo_send,msgtype,...)
 		thread:UnLockMutex()
-		thread:Interrupt()
 	end
 	=

 	=




From no-reply at zwischenwelt.org  Sat Mar 20 01:51:49 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 00:51:49 -0000
Subject: [Iris-commit] [IRIS] r3282 - /trunk/lua/lib.thread.lua
Message-ID: <20100320005150.157927A98079@simon>

Author: ghoulsblade
Date: Sat Mar 20 01:51:49 2010
New Revision: 3282

Log:
threadtest : child sends back answer to parent

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 01:51:49 2010
@@ -74,9 +74,14 @@
 		thread:Interrupt()
 	end
 	=

-	--~ thread:LockMutex()
-	--~ fifo_send:PushUint8(10)
-	--~ thread:UnLockMutex()
+	local local_fifo_recv =3D CreateFIFO()
+	function MyRecvMessages ()
+		thread:LockMutex()
+		local_fifo_recv:PushFIFOPartRaw(fifo_recv) -- move data from this_fifo_r=
ecv to local_fifo_recv
+		fifo_recv:Clear()
+		thread:UnLockMutex()
+		RecvNetMessages(local_fifo_recv,function (msgtype,...) print("main:msg",=
msgtype,...) end)
+	end
 	=

 	print("main: sleep...")
 	Client_USleep(2*1000) =

@@ -85,6 +90,7 @@
 	=

 	for i=3D1,10 do =

 		print("main:send")
+		MyRecvMessages()
 		MySend(kThreadMessage_Debug,i,42,"bla!")
 		Client_USleep(2*1000) =

 	end
@@ -107,10 +113,10 @@
 	--~ Thread_Sleep(5*1000)
 	=

 	=

-	function MySend (msgtype,...)
-		thread:LockMutex()
+	function ChildThread_Send (msgtype,...)
+		this_thread:LockMutex()
 		SendNetMessageFifo(this_fifo_send,msgtype,...)
-		thread:UnLockMutex()
+		this_thread:UnLockMutex()
 	end
 	=

 	=

@@ -120,7 +126,7 @@
 		local_fifo_recv:PushFIFOPartRaw(this_fifo_recv) -- move data from this_f=
ifo_recv to local_fifo_recv
 		this_fifo_recv:Clear()
 		this_thread:UnLockMutex() -- release so we don't block while processing =
messages
-		RecvNetMessages(local_fifo_recv,function (msgtype,...) print("child:msg"=
,msgtype,...) end)
+		RecvNetMessages(local_fifo_recv,function (msgtype,...) print("child:msg"=
,msgtype,...) ChildThread_Send(kThreadMessage_Debug,99,99,"answer") end)
 		Thread_Sleep(999*1000)
 	end
 	=




From no-reply at zwischenwelt.org  Sat Mar 20 02:57:30 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 01:57:30 -0000
Subject: [Iris-commit] [IRIS] r3283 - /trunk/lua/lib.thread.lua
Message-ID: <20100320015730.731447A9807B@simon>

Author: ghoulsblade
Date: Sat Mar 20 02:57:30 2010
New Revision: 3283

Log:
thread fifo sending

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 02:57:30 2010
@@ -1,4 +1,8 @@
 function RunThreadTest () RunThreadTest_Main() end  --  -threadtest
+-- idea hagish : helper-class to create message-handling thread that can b=
e serialized as option for easier debugging (decide at create if a real thr=
ead is started or a thread-object that handles messages directly)
+
+
+
 =

 -- see lib.netmessage.lua  for message system
 --[[
@@ -49,9 +53,41 @@
 =

 function RunThreadTest_RegisterMessageTypes ()
 	RegisterNetMessageType("kThreadMessage_Debug","iis")
+	RegisterNetMessageType("kThreadMessage_TransferPointer","p")
+	RegisterNetMessageType("kThreadMessage_TransferBuffer","x")
 end
 =

 function RunThreadTest_Main ()
+
+	if (1 =3D=3D 2) then =

+		local fifo =3D CreateFIFO()
+		local p =3D fifo:GetCrossThreadHandle()
+		print("GetCrossThreadHandle",p)
+		local fifo3 =3D CreateFIFO()
+		local fifo4 =3D CreateFIFO()
+		local fifo5 =3D CreateFIFO()
+		local fifo6 =3D CreateFIFO()
+		fifo3:PushPointer(p)
+		fifo4:PushPointer2(p)
+		fifo5:PushPointerTest()
+		fifo6:PushNetUint32(0x12345678)
+		print("fifo3:Size() a",fifo3:Size())
+		print("fifo3:Size() raw3",hex(fifo3:PeekNetUint8(0)),hex(fifo3:PeekNetUi=
nt8(1)),hex(fifo3:PeekNetUint8(2)),hex(fifo3:PeekNetUint8(3)))
+		print("fifo3:Size() raw4",hex(fifo4:PeekNetUint8(0)),hex(fifo4:PeekNetUi=
nt8(1)),hex(fifo4:PeekNetUint8(2)),hex(fifo4:PeekNetUint8(3)))
+		print("fifo3:Size() raw5",hex(fifo5:PeekNetUint8(0)),hex(fifo5:PeekNetUi=
nt8(1)),hex(fifo5:PeekNetUint8(2)),hex(fifo5:PeekNetUint8(3)))
+		print("fifo3:Size() raw6",hex(fifo6:PeekNetUint8(0)),hex(fifo6:PeekNetUi=
nt8(1)),hex(fifo6:PeekNetUint8(2)),hex(fifo6:PeekNetUint8(3)))
+		local p2 =3D fifo3:PopPointer()
+		print("fifo3:Size() b",fifo3:Size())
+		print("fifo pointer test p,p2=3D",p,p2,p =3D=3D p2) =

+		assert(p =3D=3D p2)
+		local fifo2 =3D CreateFIFOFromCrossThreadHandle(p2)
+		print("CreateFIFOFromCrossThreadHandle",fifo2)
+		print(" Size",fifo2:Size())
+		fifo:PushNetUint8(123)
+		print(" Size",fifo2:Size())
+	end
+	=

+	=

 	print("main: Threads_GetHardwareConcurrency:", Threads_GetHardwareConcurr=
ency())
 	RunThreadTest_RegisterMessageTypes()
 	=

@@ -73,6 +109,14 @@
 		thread:UnLockMutex()
 		thread:Interrupt()
 	end
+	=

+	=

+	local message_handlers =3D {}
+	message_handlers[kThreadMessage_TransferBuffer] =3D function (fifo)
+		print("mainthread:kThreadMessage_TransferBuffer received, data:",fifo)
+		print(FIFOHexDump(fifo))
+	end
+	=

 	=

 	local local_fifo_recv =3D CreateFIFO()
 	function MyRecvMessages ()
@@ -80,7 +124,11 @@
 		local_fifo_recv:PushFIFOPartRaw(fifo_recv) -- move data from this_fifo_r=
ecv to local_fifo_recv
 		fifo_recv:Clear()
 		thread:UnLockMutex()
-		RecvNetMessages(local_fifo_recv,function (msgtype,...) print("main:msg",=
msgtype,...) end)
+		RecvNetMessages(local_fifo_recv,function (msgtype,...) =

+			print("main:msg",msgtype,...) =

+			local handler =3D message_handlers[msgtype]
+			if (handler) then handler(...) end
+		end)
 	end
 	=

 	print("main: sleep...")
@@ -88,14 +136,19 @@
 	--~ print("main: send interrupt...")
 	--~ thread:Interrupt()
 	=

+	=

 	for i=3D1,10 do =

 		print("main:send")
 		MyRecvMessages()
 		MySend(kThreadMessage_Debug,i,42,"bla!")
+		MySend(kThreadMessage_Debug,i,42,"bla2!")
+		--~ local fifo2 =3D CreateFIFO()
+		--~ local crossp =3D fifo2:GetCrossThreadHandle()
+		--~ print("sending crossp",crossp)
+		--~ MySend(kThreadMessage_TransferPointer,crossp)
+		MySend(kThreadMessage_TransferBuffer,CreateFIFO())
 		Client_USleep(2*1000) =

 	end
-	=

-	=

 	=

 	print("main: done, sleeping before end...")
 	Client_USleep(5*60*1000) =

@@ -119,6 +172,21 @@
 		this_thread:UnLockMutex()
 	end
 	=

+	local message_handlers =3D {}
+	message_handlers[kThreadMessage_TransferPointer] =3D function (p) =

+		print("child:kThreadMessage_TransferPointer",p) =

+		local fifo2 =3D CreateFIFOFromCrossThreadHandle(p)
+		print(" + transferred to fifo:",fifo2)
+	end
+	message_handlers[kThreadMessage_TransferBuffer] =3D function (fifo)
+		print("child:kThreadMessage_TransferBuffer received, filling and sending=
 back",fifo)
+		fifo:PushNetUint8(0xff)
+		fifo:PushNetUint8(0x11)
+		fifo:PushNetUint8(0x22)
+		ChildThread_Send(kThreadMessage_TransferBuffer,fifo) =

+		print("child:kThreadMessage_TransferBuffer done")
+	end
+	=

 	=

 	local local_fifo_recv =3D CreateFIFO()
 	while (true) do =

@@ -126,7 +194,12 @@
 		local_fifo_recv:PushFIFOPartRaw(this_fifo_recv) -- move data from this_f=
ifo_recv to local_fifo_recv
 		this_fifo_recv:Clear()
 		this_thread:UnLockMutex() -- release so we don't block while processing =
messages
-		RecvNetMessages(local_fifo_recv,function (msgtype,...) print("child:msg"=
,msgtype,...) ChildThread_Send(kThreadMessage_Debug,99,99,"answer") end)
+		RecvNetMessages(local_fifo_recv,function (msgtype,...) =

+				print("child:msg",msgtype,...) =

+				ChildThread_Send(kThreadMessage_Debug,99,99,"answer") =

+				local handler =3D message_handlers[msgtype]
+				if (handler) then handler(...) end
+				end)
 		Thread_Sleep(999*1000)
 	end
 	=




From no-reply at zwischenwelt.org  Sat Mar 20 03:56:17 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 02:56:17 -0000
Subject: [Iris-commit] [IRIS] r3284 -
	/trunk/data/models/materials/textures.material
Message-ID: <20100320025623.2ADA87A98007@simon>

Author: ghoulsblade
Date: Sat Mar 20 03:56:16 2010
New Revision: 3284

Log:
material script fixes for ogre170

Modified:
    trunk/data/models/materials/textures.material

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Sat Mar 20 03:56:16 2010
@@ -3573,17 +3573,13 @@
 =

 material tex_996 : diffuse_template_sceneblend
 { =

-	technique
-	{ =

-		pass =

+	technique default
+	{
+		pass Decal
 		{
 			depth_bias 5
 			=

-			texture_unit ambient_tex
-			{ =

-				texture blood.png
-			}
-			texture_unit diffuse_tex
+			texture_unit
 			{ =

 				texture blood.png
 			}
@@ -3593,17 +3589,13 @@
 =

 material tex_997 : diffuse_template_sceneblend
 { =

-	technique
-	{ =

-		pass =

+	technique default
+	{
+		pass Decal
 		{
 			depth_bias 5
 			=

-			texture_unit ambient_tex
-			{ =

-				texture blood_spot.png
-			}
-			texture_unit diffuse_tex
+			texture_unit
 			{ =

 				texture blood_spot.png
 			}
@@ -3656,21 +3648,21 @@
 =

 material tex_grass : diffuse_template_sceneblend
 { =

-	technique
+	// set_texture_alias diffuse_tex tex_grass.png
+	=

+	technique default
 	{
-		pass
+		pass Decal
 		{
 			cull_hardware none   =

 			cull_software none
 			=

-			texture_unit ambient_tex
-			{ =

+			texture_unit
+			{
+				filtering anisotropic
+				max_anisotropy 8
 				texture tex_grass.png
-				wave_xform scale_x sine 1.0 0.1 0.0 1.0
-			}
-			texture_unit diffuse_tex
-			{ =

-				texture tex_grass.png
+				tex_address_mode clamp
 				wave_xform scale_x sine 1.0 0.1 0.0 1.0
 			}
 		}
@@ -3835,16 +3827,11 @@
 =

 material palm01_bark : diffuse_template
 {
-	technique
+	technique default
 	{
-		pass
+		pass Decal
 		{
-			texture_unit ambient_tex
-			{
-				tex_address_mode wrap
-				texture tex_palmbark.png
-			}
-			texture_unit diffuse_tex
+			texture_unit
 			{
 				tex_address_mode wrap
 				texture tex_palmbark.png



From no-reply at zwischenwelt.org  Sat Mar 20 04:58:48 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 03:58:48 -0000
Subject: [Iris-commit] [IRIS] r3285 - in /trunk/lua: lib.3d.map.lua
 lib.3d.mousepick.lua lib.compass.lua
Message-ID: <20100320035848.E5EC77A9807B@simon>

Author: hagish
Date: Sat Mar 20 04:58:48 2010
New Revision: 3285

Log:
* reduced compass update interval
* faster 3d mousepicking

Modified:
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.compass.lua

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Sat Mar 20 04:58:48 2010
@@ -142,7 +142,7 @@
 			end
 		end
 	end
-	print("Renderer3D:MapAreaCheck",x,y,activearea)
+	--~ print("Renderer3D:MapAreaCheck",x,y,activearea)
 	if (gLastMapArea =3D=3D activearea) then return end
 	gLastMapArea =3D activearea
 	self:SetMapAreaEnv(activearea or gMaps[gMapIndex])

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sat Mar 20 04:58:48 2010
@@ -33,6 +33,7 @@
         =

         local serial
 		if (not gKeyPressed[key_mouse_right]) then
+			--~ #THREAD
 			serial =3D GetMouseHitSerial(true) -- executes mousepick
 			if (serial =3D=3D 0) then serial =3D nil end
 			if (gMousePickFoundHit and gMousePickFoundHit.hittype =3D=3D kMousePick=
HitType_Container) then serial =3D nil end -- backpane
@@ -52,16 +53,16 @@
     =

     -- multi mousepicking
     for k,v in pairs(gMultis) do
-        local skipcheck =3D false
+        local docheck =3D false
         =

         -- bb ray pick for early out
         if k.minx and k.maxx and k.miny and k.maxy then
             local x,y,w,h =3D k.minx, k.miny, k.maxx - k.minx + 1, k.maxy =
- k.miny + 1
             local hit,dist =3D RayAABBQuery( rx, ry, rz, rvx, rvy, rvz, -x=
,y,-10000, w, h, 10000 )
-            if hit then skipcheck =3D true end
-        end
-        =

-        if skipcheck then
+            if hit then docheck =3D true end
+        end
+        =

+        if docheck then
             for kk,vv in pairs(k.lparts) do
                 local iTileTypeID,xloc,yloc,zloc,iHue =3D unpack(vv) -- se=
e Multi_AddPartHelper
                 local mousepickdata =3D vv.multi_mousepick -- see cMapBloc=
k_3D_Multis:WorkStep_LoadDetail
@@ -140,9 +141,11 @@
     local numcustomquads =3D 0
     if self.map3d_spawners and self.map3d_spawners.statics then
         self.map3d_spawners.statics:ForAllBlocks(function(block)
+			-- OLD NOTE/COMMENT
             -- bbox raypick disabled, as it seems broken. model raypick co=
ntains bounding sphere precheck already.
             -- block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) -- if 3d static =
mousepicking is strange, look here, xmirror maybe.. no longer used for terr=
ain, only here
-            if true then
+            =

+            if not block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
                 block:ForAllEntities(function(entity)
                     if (not entity.bLoaded) then return end
                     if (not entity.zloc) then print("mousepick warning, st=
atic entity has no zloc",entity.serial,entity.artid) end

Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Sat Mar 20 04:58:48 2010
@@ -17,6 +17,10 @@
 gbCompassLayoutDirty =3D false
 kDetailMapCacheSize =3D 256
 kDetailMapCacheViewRad =3D 80
+
+gCompassLastUpdate =3D nil
+gCompassUpdateTimeout =3D 100
+
 =

 gPositionMarkers =3D {
     --[1] =3D {
@@ -474,7 +478,8 @@
 =

 -- called every frame
 function UpdateCompass ()
-    if (not(gEnableCompass)) then return end
+	--~ #THREAD
+    if (not(gEnableCompass) or not(gIrisCompassDialog)) then return end
     =

     if(gbCompassLayoutDirty) then
         gbCompassLayoutDirty =3D false
@@ -498,7 +503,15 @@
         end
     end
     =

-    if (gIrisCompassDialog and gIrisCompassDialog.bDoUpdate) then   =

+    if 	gIrisCompassDialog and =

+		gIrisCompassDialog.bDoUpdate and =

+		(
+			(gCompassLastUpdate =3D=3D nil) or =

+			(Client_GetTicks() - gCompassLastUpdate > gCompassUpdateTimeout)
+		)
+	then   =

+		gCompassLastUpdate =3D (gCompassLastUpdate or Client_GetTicks()) + gComp=
assUpdateTimeout
+	=

         -- ax =3D camera angle, cxloc, cyloc =3D tileposition
         local ax, cxloc, cyloc =3D gCurrentRenderer:GetCompassInfo()
         local vw,vh =3D GetViewportSize() -- uses overlay manager



From no-reply at zwischenwelt.org  Sat Mar 20 05:04:38 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 04:04:38 -0000
Subject: [Iris-commit] [IRIS] r3286 - in /trunk/lua: lib.3d.mobile.lua
 lib.3d.mousepick.lua lib.bodygfx.lua
Message-ID: <20100320040438.47FC37A9807B@simon>

Author: ghoulsblade
Date: Sat Mar 20 05:04:38 2010
New Revision: 3286

Log:
granny : gGrannyAnimEnabled : if false : update at least a few times per se=
cond. more often for player.  3d mousepick profiling

Modified:
    trunk/lua/lib.3d.mobile.lua
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.bodygfx.lua

Modified: trunk/lua/lib.3d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mobile.lua (original)
+++ trunk/lua/lib.3d.mobile.lua Sat Mar 20 05:04:38 2010
@@ -7,7 +7,10 @@
 -- called from obj.mobile.lua
 function Renderer3D:UpdateMobileModel (mobile)
     if (gTestNoMobileGfxNodes) then return end
-    if (not mobile.bodygfx) then mobile.bodygfx =3D CreateBodyGfx() end
+    if (not mobile.bodygfx) then =

+		mobile.bodygfx =3D CreateBodyGfx() =

+		if (GetPlayerSerial() =3D=3D mobile.serial) then mobile.bodygfx.iSlowAni=
mInterval =3D 1000/25 end
+	end
     mobile.bodygfx:MarkForUpdate(mobile.artid,mobile.hue,GetMobileEquipmen=
tList(mobile))
 end
 =


Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sat Mar 20 05:04:38 2010
@@ -15,6 +15,10 @@
 Renderer3D.gMousePickFoundHit_ExactZ =3D 0
 Renderer3D.gMousePickTippOverride =3D false -- used for container-item-tip=
ps and other stuff from widget system, TODO : proper mousepicking for them
 =

+
+gProfiler_R3D_MousePick =3D CreateRoughProfiler("  3D:MousePick")
+
+
 function Renderer3D:DeactivateMousePick ()
     Client_SetBottomLine(self.gMousePickTippOverride or "")
     if (self.gbShowMousePickHitBoxes) then
@@ -26,8 +30,12 @@
 Renderer3D.gNextMousePick =3D 0
 function Renderer3D:MousePickStep ()
     if (not self.gbActive) then return end
+	=

+	=

+	=

     if (gMyTicks > self.gNextMousePick) then
         self.gNextMousePick =3D gMyTicks + 400
+		gProfiler_R3D_MousePick:Start(gEnableProfiler_R3D_MousePick)
         =

         -- self:MousePick() -- obsolete, don't do mousepicking every frame
         =

@@ -39,12 +47,18 @@
 			if (gMousePickFoundHit and gMousePickFoundHit.hittype =3D=3D kMousePick=
HitType_Container) then serial =3D nil end -- backpane
 		end
 		=

+		gProfiler_R3D_MousePick:Section("StartUOToolTipAtMouse_Serial")
+	=

 		StartUOToolTipAtMouse_Serial(serial)
+		=

+		gProfiler_R3D_MousePick:End()
     end
 end
 =

 -- CLEAR gMousePickFoundHit =3D {} if you want to use this alone !!!
 function Renderer3D:MousePick_Scene ()
+
+    gProfiler_R3D_MousePick:Section("GetMouseRay")
     -- 3d mousepicking : mouseray
     local rx,ry,rz,rvx,rvy,rvz =3D GetMouseRay()
 =

@@ -52,6 +66,7 @@
     local bHit,fHitDist
     =

     -- multi mousepicking
+    gProfiler_R3D_MousePick:Section("multis")
     for k,v in pairs(gMultis) do
         local docheck =3D false
         =

@@ -85,6 +100,7 @@
     end
 =

     -- terrain
+    gProfiler_R3D_MousePick:Section("terrain")
     if self.map3d_spawners and self.map3d_spawners.terrain and Renderer3D.=
gbBlendOutTerrainVisible and gGroundBlockLoader then
         self.map3d_spawners.terrain:ForAllBlocks(function(block)
             if block.gfx_terrain and block.gfx_terrain:IsAlive() then
@@ -139,12 +155,16 @@
     -- statics
     local numgfx =3D 0
     local numcustomquads =3D 0
+    gProfiler_R3D_MousePick:Section("statics")
+	local static_mesh_buffer_num =3D 0
+	local static_block_num =3D 0
     if self.map3d_spawners and self.map3d_spawners.statics then
         self.map3d_spawners.statics:ForAllBlocks(function(block)
 			-- OLD NOTE/COMMENT
             -- bbox raypick disabled, as it seems broken. model raypick co=
ntains bounding sphere precheck already.
             -- block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) -- if 3d static =
mousepicking is strange, look here, xmirror maybe.. no longer used for terr=
ain, only here
-            =

+
+			static_block_num =3D static_block_num + 1
             if not block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
                 block:ForAllEntities(function(entity)
                     if (not entity.bLoaded) then return end
@@ -153,21 +173,26 @@
                         =

                         if (entity.gfx) then numgfx =3D numgfx + 1 end
                         if (entity.gfx and entity.gfx.billboard) then
+							gProfiler_R3D_MousePick:Section("statics:fallback")
                             -- fallback
                             local x,y,z =3D entity.gfx.billboard:GetDerive=
dPosition()
                             fHitDist =3D SphereRayPick(x,y,z,0.5,rx,ry,rz,=
rvx,rvy,rvz) -- 0.5 rad
                             bHit =3D (fHitDist ~=3D nil)
                         elseif (entity.staticentity) then
+							gProfiler_R3D_MousePick:Section("statics:staticentity")
                             bHit,fHitDist =3D entity.staticentity:RayPick(=
rx,ry,rz,rvx,rvy,rvz,
                                 entity.x,entity.y,entity.z,
                                 entity.qw,entity.qx,entity.qy,entity.qz,
                                 entity.sx,entity.sy,entity.sz)
                         elseif (entity.meshbuffer) then
+							gProfiler_R3D_MousePick:Section("statics:meshbuffer")
+							static_mesh_buffer_num =3D static_mesh_buffer_num + 1 =

                             bHit,fHitDist =3D entity.meshbuffer:RayPick(rx=
,ry,rz,rvx,rvy,rvz,
                                 entity.x,entity.y,entity.z,
                                 entity.qw,entity.qx,entity.qy,entity.qz,
                                 entity.sx,entity.sy,entity.sz)
                         elseif (entity.gfx and entity.gfx.customquads) then
+							gProfiler_R3D_MousePick:Section("statics:customquads")
                             numcustomquads =3D numcustomquads + 1
                             --~ print("mousepick : entity.customquads",ent=
ity.x,entity.y,entity.z)
                             for k,quad in pairs(entity.gfx.customquads) do =

@@ -179,6 +204,7 @@
                                 bHit,fHitDist =3D dist ~=3D nil,dist =

                             end
                         end
+						gProfiler_R3D_MousePick:Section("statics:rest")
                         if (bHit and ((not gMousePickFoundHit) or fHitDist=
 < self.gMousePickFoundDist)) then
                             self.gMousePickFoundDist =3D fHitDist
                             gMousePickFoundHit =3D {}
@@ -197,6 +223,7 @@
             end
         end)
     end
+	print("mousepick : static_mesh_buffer_num=3D",static_mesh_buffer_num,"sta=
tic_block_num=3D",static_block_num)
     =

     if ((not gCustomQuadInfoWritten) and numcustomquads > 300) then
         gCustomQuadInfoWritten =3D true
@@ -205,6 +232,7 @@
     =

     -- dynamics
 	assert(gMulti_ID)
+    gProfiler_R3D_MousePick:Section("dynamics")
     for k,dynamic in pairs(GetDynamicList()) do
         -- if Dynamic is in World (if it's not an Container) & if it's not=
 an Multi & if it's not a skipped Fallback (multitile mesh)
         if (DynamicIsInWorld(dynamic) and dynamic.artid and (not ItemIsMul=
ti(dynamic)) and not(IsArtBillboardFallBackSkipped(dynamic.artid))) then
@@ -259,6 +287,7 @@
 =

     -- mobiles
     local bIgnorePlayer =3D self:IsFirstPersonCam()
+    gProfiler_R3D_MousePick:Section("mobiles")
     for k,mobile in pairs(GetMobileList()) do if (mobile.gfx and self:IsZL=
ayerVisible(mobile.zloc) and ((not bIgnorePlayer) or (not IsPlayerMobile(mo=
bile)))) then
         if (true) then
             -- small bbox mousepick as fallback in case model is not avail=
able/invisible (horse)
@@ -288,12 +317,14 @@
     end end
 =

     -- prepare exact hit coords 3d hit
+    gProfiler_R3D_MousePick:Section("end_scene")
     self.gMousePickFoundHit_ExactX =3D rx + self.gMousePickFoundDist * rvx
     self.gMousePickFoundHit_ExactY =3D ry + self.gMousePickFoundDist * rvy
     self.gMousePickFoundHit_ExactZ =3D rz + self.gMousePickFoundDist * rvz
 end
         =

 function Renderer3D:MousePick_ShowHits ()
+    gProfiler_R3D_MousePick:Section("MousePick_ShowHits")
     -- prepare hit boxes
     if (self.gbShowMousePickHitBoxes) then =

         if (not self.gMousePickBBox) then =


Modified: trunk/lua/lib.bodygfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bodygfx.lua (original)
+++ trunk/lua/lib.bodygfx.lua Sat Mar 20 05:04:38 2010
@@ -180,7 +180,10 @@
                 mountbodyid =3D gStandardHorse
             end
             =

-            if (not self.modelmountgfx) then self.modelmountgfx =3D Create=
BodyGfx(self.modelgfx) end
+            if (not self.modelmountgfx) then =

+				self.modelmountgfx =3D CreateBodyGfx(self.modelgfx) =

+				self.modelmountgfx.iSlowAnimInterval =3D self.iSlowAnimInterval
+			end
             self.modelmountgfx.artid =3D 0
             self.modelmountgfx.hue =3D gMountHueOverride[mount.artid] or m=
ount.hue or 0
             self.modelmountgfx.equipmentlist =3D {}
@@ -410,8 +413,13 @@
 			bForceUpdateEvenIfAnimDisabled =3D true
 		end
 	end =

+	=

+	if ((not gGrannyAnimEnabled) and ((self.last_anim_step or 0) < gMyTicks -=
 (self.iSlowAnimInterval or (1000/5)))) then
+		bForceUpdateEvenIfAnimDisabled =3D true
+	end
 	if (gGrannyAnimEnabled or bForceUpdateEvenIfAnimDisabled) then =

 		for k,partgfx in pairs(self.modelparts or {}) do partgfx:SetAnimTimePos(=
self.animtime) end -- update parts
+		self.last_anim_step =3D gMyTicks
 	end
 	=

     gProfiler_BodyGfxStep:End()



From no-reply at zwischenwelt.org  Sat Mar 20 05:25:50 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 04:25:50 -0000
Subject: [Iris-commit] [IRIS] r3287 - in /trunk/lua: lib.3d.mousepick.lua
	lib.mapblock.base.lua
Message-ID: <20100320042550.449927A9807B@simon>

Author: ghoulsblade
Date: Sat Mar 20 05:25:50 2010
New Revision: 3287

Log:
fixed mapblock bounding box check (xmirror, other edge) : used by static mo=
usepick

Modified:
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.mapblock.base.lua

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sat Mar 20 05:25:50 2010
@@ -165,7 +165,8 @@
             -- block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) -- if 3d static =
mousepicking is strange, look here, xmirror maybe.. no longer used for terr=
ain, only here
 =

 			static_block_num =3D static_block_num + 1
-            if not block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
+            if block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
+				local aabbx,aabby,aabbw,aabbh =3D block:GetAABB()
                 block:ForAllEntities(function(entity)
                     if (not entity.bLoaded) then return end
                     if (not entity.zloc) then print("mousepick warning, st=
atic entity has no zloc",entity.serial,entity.artid) end
@@ -187,6 +188,7 @@
                         elseif (entity.meshbuffer) then
 							gProfiler_R3D_MousePick:Section("statics:meshbuffer")
 							static_mesh_buffer_num =3D static_mesh_buffer_num + 1 =

+							--~ print("meshbu aabb",floor(entity.x)-(-aabbx-aabbw),floor(entity=
.y)-aabby,aabbw,aabbh)
                             bHit,fHitDist =3D entity.meshbuffer:RayPick(rx=
,ry,rz,rvx,rvy,rvz,
                                 entity.x,entity.y,entity.z,
                                 entity.qw,entity.qx,entity.qy,entity.qz,

Modified: trunk/lua/lib.mapblock.base.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.base.lua (original)
+++ trunk/lua/lib.mapblock.base.lua Sat Mar 20 05:25:50 2010
@@ -22,8 +22,9 @@
 -- returns hit and distance
 function cMapBlock:BBRayPick	(rx, ry, rz, rvx, rvy, rvz)
 	local x,y,w,h =3D self:GetAABB()
+	--~ print("cMapBlock:BBRayPick",x,y,w,h)
 	-- if 3d static mousepicking is strange, look here, xmirror maybe.. no lo=
nger used for terrain, only here
-	local hit,dist =3D RayAABBQuery( rx, ry, rz, rvx, rvy, rvz, -x,y,-10000, =
w, h, 10000 )
+	local hit,dist =3D RayAABBQuery( rx, ry, rz, rvx, rvy, rvz, -x-w,y,-10000=
, w, h, 10000 )
 	return hit,dist
 end
 =




From no-reply at zwischenwelt.org  Sat Mar 20 05:28:40 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 04:28:40 -0000
Subject: [Iris-commit] [IRIS] r3288 - /trunk/lua/lib.3d.mousepick.lua
Message-ID: <20100320042840.24AE67A9807B@simon>

Author: hagish
Date: Sat Mar 20 05:28:39 2010
New Revision: 3288

Log:
remove useless stuff

Modified:
    trunk/lua/lib.3d.mousepick.lua

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sat Mar 20 05:28:39 2010
@@ -163,10 +163,9 @@
 			-- OLD NOTE/COMMENT
             -- bbox raypick disabled, as it seems broken. model raypick co=
ntains bounding sphere precheck already.
             -- block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) -- if 3d static =
mousepicking is strange, look here, xmirror maybe.. no longer used for terr=
ain, only here
-
 			static_block_num =3D static_block_num + 1
             if block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
-				local aabbx,aabby,aabbw,aabbh =3D block:GetAABB()
+				--~ local aabbx,aabby,aabbw,aabbh =3D block:GetAABB()
                 block:ForAllEntities(function(entity)
                     if (not entity.bLoaded) then return end
                     if (not entity.zloc) then print("mousepick warning, st=
atic entity has no zloc",entity.serial,entity.artid) end



From no-reply at zwischenwelt.org  Sat Mar 20 13:20:14 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 12:20:14 -0000
Subject: [Iris-commit] [IRIS] r3289 - /trunk/lua/lib.3d.mousepick.lua
Message-ID: <20100320122015.7F8C07A98072@simon>

Author: ghoulsblade
Date: Sat Mar 20 13:20:11 2010
New Revision: 3289

Log:
finer mousepick 3d profiling

Modified:
    trunk/lua/lib.3d.mousepick.lua

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sat Mar 20 13:20:11 2010
@@ -164,11 +164,14 @@
             -- bbox raypick disabled, as it seems broken. model raypick co=
ntains bounding sphere precheck already.
             -- block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) -- if 3d static =
mousepicking is strange, look here, xmirror maybe.. no longer used for terr=
ain, only here
 			static_block_num =3D static_block_num + 1
+			gProfiler_R3D_MousePick:Section("statics:BBRayPick")
             if block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
+				gProfiler_R3D_MousePick:Section("statics:ForAllEntities")
 				--~ local aabbx,aabby,aabbw,aabbh =3D block:GetAABB()
                 block:ForAllEntities(function(entity)
                     if (not entity.bLoaded) then return end
                     if (not entity.zloc) then print("mousepick warning, st=
atic entity has no zloc",entity.serial,entity.artid) end
+					gProfiler_R3D_MousePick:Section("statics:IsZLayerVisible")
                     if (Renderer3D:IsZLayerVisible(entity.zloc)) then -- z=
loc is in integer tilecoords from uo
                         =

                         if (entity.gfx) then numgfx =3D numgfx + 1 end
@@ -205,7 +208,7 @@
                                 bHit,fHitDist =3D dist ~=3D nil,dist =

                             end
                         end
-						gProfiler_R3D_MousePick:Section("statics:rest")
+						gProfiler_R3D_MousePick:Section("statics:rest1")
                         if (bHit and ((not gMousePickFoundHit) or fHitDist=
 < self.gMousePickFoundDist)) then
                             self.gMousePickFoundDist =3D fHitDist
                             gMousePickFoundHit =3D {}
@@ -219,6 +222,7 @@
                             --~ print("static mousepick",iX,iY)
                             -- entity has to have the following properties=
: hue, x, y, z, iTileTypeID
                         end
+						gProfiler_R3D_MousePick:Section("statics:rest2")
                     end
                 end)
             end



From no-reply at zwischenwelt.org  Sat Mar 20 14:24:00 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 13:24:00 -0000
Subject: [Iris-commit] [IRIS] r3290 - /trunk/installdeps.ubuntu.sh
Message-ID: <20100320132400.E6B5B7A98079@simon>

Author: ghoulsblade
Date: Sat Mar 20 14:24:00 2010
New Revision: 3290

Log:
added instruction to set -DNDEBUG in ogre cmake compile, helps against boun=
ding-box asserts caused by particle systems

Modified:
    trunk/installdeps.ubuntu.sh

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Sat Mar 20 14:24:00 2010
@@ -32,6 +32,7 @@
 echo "sudo apt-get install cmake-gui"
 echo "mkdir build"
 echo "cmake-gui"
+echo "# to avoid boundingbox-asserts from particle systems, in cmake gui e=
nter cxx in search, select advanced view, and add -DNDEBUG to all CXX_FLAGS=
 entries (or the one you're using : CMAKE_BUILD_TYPE)"
 echo "cd build"
 echo "make"
 echo "sudo make install"



From no-reply at zwischenwelt.org  Sat Mar 20 14:57:32 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 13:57:32 -0000
Subject: [Iris-commit] [IRIS] r3291 - /trunk/lua/lib.thread.lua
Message-ID: <20100320135732.E5FC57A98079@simon>

Author: hagish
Date: Sat Mar 20 14:57:32 2010
New Revision: 3291

Log:
* queuing calls to a thread
* you can obtain the result via callback or polling

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 14:57:32 2010
@@ -1,159 +1,238 @@
 function RunThreadTest () RunThreadTest_Main() end  --  -threadtest
 -- idea hagish : helper-class to create message-handling thread that can b=
e serialized as option for easier debugging (decide at create if a real thr=
ead is started or a thread-object that handles messages directly)
 =

-
-
-
--- see lib.netmessage.lua  for message system
+function ack(n, m)
+	--~ print("ack",n,m)
+	while n ~=3D 0 do
+		if m =3D=3D 0 then
+			m =3D 1
+		else
+			m =3D ack(n, m-1)
+		end
+		=

+		n =3D n - 1
+	end
+	=

+    return m + 1
+end
+
+function stupidCounter(count)
+	print("CHILD stupidCounter", count)
+	local x =3D 0
+	for i=3D1,count do
+		x =3D x + 1
+		Thread_Sleep(1000)
+	end
+	return x
+end
+
+function ThreadChildMainLoop()
+	-- from global scope: this_thread, this_fifo_send, this_fifo_recv
+	=

+	local SendResult =3D function(id, ok, ret)
+		this_thread:LockMutex()
+		=

+		this_fifo_send:PushU(id)
+		this_fifo_send:PushU(ok)
+		FIFOPushNetSimpleTable(ret, this_fifo_send)
+		=

+		this_thread:UnLockMutex()
+	end
+	=

+	local HandleCall =3D function(id, funName, params)
+		print("HANDLECALL", id, funName, unpack(params))
+		local fun =3D _G[funName]
+		=

+		if fun then
+			SendResult(id, 1, {fun(unpack(params))})
+		else
+			SendResult(id, 0, {})
+		end
+	end
+	=

+	while true do
+		this_thread:LockMutex()
+		=

+		local id,funName,params =3D nil,nil,nil
+		local len =3D this_fifo_recv:Size()
+		=

+		if len > 0 then
+			id =3D this_fifo_recv:PopU()
+			funName =3D this_fifo_recv:PopS()
+			params =3D FIFOPopNetSimpleTable(this_fifo_recv)
+		end
+		=

+		this_thread:UnLockMutex()
+		=

+		if id then
+			HandleCall(id, funName, params)
+		else
+			Thread_Sleep(1000)
+		end
+	end
+end
+
 --[[
-	RecvNetMessages (fifo,callback)
-
-	-- receive messages from clients
-	RecvNetMessages(myplayer.netRecvFifo,function (msgtype,...) =

-			local msgtypename =3D gNetMessageTypeName[msgtype]
-			if (gMessageTypeHandler_Server[msgtypename]) then =

-				gMessageTypeHandler_Server[msgtypename](myplayer,unpack(arg))
+local t =3D CreateExtendedLuaThread("bla.lua")
+t:queueCall("ack", 3,3)
+local id,ok,ret =3D t:pickupResult()
+]]
+function CreateExtendedLuaThread(file)
+	local thread =3D CreateLuaThread(file)
+	=

+	thread.fifo_send		=3D thread:CreateFifoParent2ChildHandle()
+	thread.fifo_recv		=3D thread:CreateFifoChild2ParentHandle()
+	thread.nextCallId		=3D 1
+	thread.callsRunning 	=3D 0
+	thread.callbackTable	=3D {}
+	thread.resultTable		=3D {}
+	=

+	thread.isIdValid =3D function(self, id)
+		if self.resultTable[id] or self.callbackTable[id] then
+			return true
+		else
+			return false
+		end
+	end
+	=

+	thread.isResultAvailable =3D function(self, id)
+		if self.resultTable[id] and type(self.resultTable[id]) =3D=3D "table" th=
en =

+			return true =

+		else =

+			return false =

+		end
+	end
+	=

+	thread.step =3D function(self)
+		while true do
+			local id,ok,ret =3D self:_getResult()
+			=

+			if id then
+				if self.callbackTable[id] then
+					-- send result via callback
+					self.callbackTable[id](id,ok,ret)
+					self.callbackTable[id] =3D nil
+					self.resultTable[id] =3D nil
+				else
+					-- store result for picking up later
+					self.resultTable[id] =3D {ok, ret}
+				end
+			else
+				return
 			end
-			NotifyListener("Hook_Server_RecvNetMsg",myplayer,msgtype,unpack(arg))
-		end)
-		=

-	FPush(gSendFifo,gNetMessageParamFormat[msgtype],...)
-
-	gMessageTypeHandler_Client.kNetMessage_Chat =3D function (iParam,iFlags,s=
ChatText)  .. end
-	=

-	RegisterNetMessageType("kNetMessage_Chat"						,"iis")			-- sent by serve=
r and client : param,flags,chattext (used for client and server, if from cl=
ient then param =3D target else param =3D from)
+		end
+	end
+	=

+	thread._generateNextId =3D function(self)
+		local id =3D self.nextCallId
+		self.nextCallId =3D self.nextCallId + 1
+		return id
+	end
+	=

+	-- callback : function(id,ok,ret)
+	thread.queueCallWithCallback =3D function(self, callback, funName, ...)
+		local id =3D self:queueCall(funName, ...)
+		self.callbackTable[id] =3D callback
+	end
+	=

+	thread.queueCall =3D function(self, funName, ...)
+		local id =3D self:_generateNextId()
+		local fifo =3D self.fifo_send
+		=

+		self:LockMutex()
+		=

+		self.resultTable[id] =3D true
+		=

+		fifo:PushU(id)
+		fifo:PushS(funName)
+		FIFOPushNetSimpleTable({...}, fifo)
+	=

+		self.callsRunning =3D self.callsRunning + 1
+	=

+		self:UnLockMutex()
+		=

+		self:Interrupt()
+		=

+		return id
+	end
+	=

+	thread.waitForAllBlocking =3D function(self)
+		while self.callsRunning > 0 do
+			--~ print("still running", self.callsRunning)
+			self:step()
+			Client_USleep(1000 / 100)
+		end
+		--~ print("all finished")
+	end
+	=

+	thread.pickupResult =3D function(self, id)
+		if self:isIdValid(id) then
+			while not self:isResultAvailable(id) do
+				self:step()
+				Client_USleep(1000 / 100)
+			end
 			=

-	RegisterNetMessageFormatWrapper("o","i",function (obj) return obj and obj=
.id or 0 end,  -- obj2id  =

-											function (objid) return GetObject(objid) end)	-- id2obj
-
-											=

-	function FIFOPushNetSimpleTable(tbl, fifo)
-	function FIFOPopNetSimpleTable(fifo)
-]]--
-
---[[
-gConfig:DeclareEnum("gGroundBlockLoaderType"	, "loader", "ground loader"		=
, 'TODO', "Blockwise", {"OnDemand","FullFile","Blockwise"})
-gConfig:DeclareEnum("gStaticBlockLoaderType"	, "loader", "static loader"		=
, 'TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gRadarColorLoaderType"		, "loader", "radar color load=
er", 'TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gTileTypeLoaderType"		, "loader", "tile type loader"	=
, 'TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gTexMapLoaderType"			, "loader", "tex map loader"	, '=
TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gArtMapLoaderType"			, "loader", "art map loader"	, '=
TODO', "OnDemand", {"OnDemand","FullFile"})
-gConfig:DeclareEnum("gGumpLoaderType"			, "loader", "gump loader"		, 'TODO=
', "OnDemand", {"OnDemand","FullFile"})
-gConfig:DeclareEnum("gClilocLoaderType"			, "loader", "cliloc loader"		, '=
TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gSoundLoaderType"			, "loader", "sound loader"		, 'TO=
DO', "OnDemand", {"OnDemand","FullFile"})
-gConfig:DeclareEnum("gSpeechLoaderType"			, "loader", "speech loader"		, '=
TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gHueLoaderType"			, "loader", "hue loader"		, 'TODO',=
 "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gAnimLoaderType"			, "loader", "anim loader"		, 'TODO=
', "Blockwise", {"OnDemand","FullFile","Blockwise"})
-gConfig:DeclareEnum("gMultiLoaderType"			, "loader", "multi loader"		, 'TO=
DO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gStitchinLoaderType"		, "loader", "stitchin loader"	,=
 'TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gAnimDataLoaderType"		, "loader", "anim data loader"	=
, 'TODO', "FullFile", {"FullFile"})
-gConfig:DeclareEnum("gGrannyLoaderType"			, "loader", "granny loader"		, '=
TODO', "OnDemand", {"OnDemand"})
-gConfig:DeclareEnum("gUniFontLoaderType"		, "loader", "uni font loader"	, =
'TODO', "FullFile", {"FullFile"})
-]]--
-
-function RunThreadTest_RegisterMessageTypes ()
-	RegisterNetMessageType("kThreadMessage_Debug","iis")
-	RegisterNetMessageType("kThreadMessage_TransferPointer","p")
-	RegisterNetMessageType("kThreadMessage_TransferBuffer","x")
+			local ok,ret =3D unpack(self.resultTable[id])
+			return ok,ret
+		end
+		=

+		return 0,{}
+	end
+	=

+	thread._getResult =3D function(self)
+		--~ print("------_getResult", self, self.fifo_recv)
+		local fifo =3D self.fifo_recv
+		=

+		local id,ok,ret =3D nil,nil,nil
+	=

+		self:LockMutex()
+		=

+		local len =3D fifo:Size()
+		if len > 0 then
+			id =3D fifo:PopU()
+			ok =3D fifo:PopU()
+			ret =3D FIFOPopNetSimpleTable(fifo)
+			self.callsRunning =3D self.callsRunning - 1
+		end
+		=

+		self:UnLockMutex()
+		=

+		return id,ok,ret
+	end
+	=

+	return thread
 end
 =

 function RunThreadTest_Main ()
-
-	if (1 =3D=3D 2) then =

-		local fifo =3D CreateFIFO()
-		local p =3D fifo:GetCrossThreadHandle()
-		print("GetCrossThreadHandle",p)
-		local fifo3 =3D CreateFIFO()
-		local fifo4 =3D CreateFIFO()
-		local fifo5 =3D CreateFIFO()
-		local fifo6 =3D CreateFIFO()
-		fifo3:PushPointer(p)
-		fifo4:PushPointer2(p)
-		fifo5:PushPointerTest()
-		fifo6:PushNetUint32(0x12345678)
-		print("fifo3:Size() a",fifo3:Size())
-		print("fifo3:Size() raw3",hex(fifo3:PeekNetUint8(0)),hex(fifo3:PeekNetUi=
nt8(1)),hex(fifo3:PeekNetUint8(2)),hex(fifo3:PeekNetUint8(3)))
-		print("fifo3:Size() raw4",hex(fifo4:PeekNetUint8(0)),hex(fifo4:PeekNetUi=
nt8(1)),hex(fifo4:PeekNetUint8(2)),hex(fifo4:PeekNetUint8(3)))
-		print("fifo3:Size() raw5",hex(fifo5:PeekNetUint8(0)),hex(fifo5:PeekNetUi=
nt8(1)),hex(fifo5:PeekNetUint8(2)),hex(fifo5:PeekNetUint8(3)))
-		print("fifo3:Size() raw6",hex(fifo6:PeekNetUint8(0)),hex(fifo6:PeekNetUi=
nt8(1)),hex(fifo6:PeekNetUint8(2)),hex(fifo6:PeekNetUint8(3)))
-		local p2 =3D fifo3:PopPointer()
-		print("fifo3:Size() b",fifo3:Size())
-		print("fifo pointer test p,p2=3D",p,p2,p =3D=3D p2) =

-		assert(p =3D=3D p2)
-		local fifo2 =3D CreateFIFOFromCrossThreadHandle(p2)
-		print("CreateFIFOFromCrossThreadHandle",fifo2)
-		print(" Size",fifo2:Size())
-		fifo:PushNetUint8(123)
-		print(" Size",fifo2:Size())
-	end
-	=

 	=

 	print("main: Threads_GetHardwareConcurrency:", Threads_GetHardwareConcurr=
ency())
-	RunThreadTest_RegisterMessageTypes()
-	=

-	local thread =3D CreateLuaThread("../mythread.lua")
-	print("main: child started")
-	--~ thread:Interrupt()
-	--~ Client_Sleep(1) =

-	=

-	--~ Client_USleep(1*1000)
-	--~ Thread_Sleep(1*1000)
-	=

-	print("main: lock and send..")
-	local fifo_send =3D thread:CreateFifoParent2ChildHandle()
-	local fifo_recv =3D thread:CreateFifoChild2ParentHandle()
-	=

-	function MySend (msgtype,...)
-		thread:LockMutex()
-		SendNetMessageFifo(fifo_send,msgtype,...)
-		thread:UnLockMutex()
-		thread:Interrupt()
-	end
-	=

-	=

-	local message_handlers =3D {}
-	message_handlers[kThreadMessage_TransferBuffer] =3D function (fifo)
-		print("mainthread:kThreadMessage_TransferBuffer received, data:",fifo)
-		print(FIFOHexDump(fifo))
-	end
-	=

-	=

-	local local_fifo_recv =3D CreateFIFO()
-	function MyRecvMessages ()
-		thread:LockMutex()
-		local_fifo_recv:PushFIFOPartRaw(fifo_recv) -- move data from this_fifo_r=
ecv to local_fifo_recv
-		fifo_recv:Clear()
-		thread:UnLockMutex()
-		RecvNetMessages(local_fifo_recv,function (msgtype,...) =

-			print("main:msg",msgtype,...) =

-			local handler =3D message_handlers[msgtype]
-			if (handler) then handler(...) end
-		end)
-	end
-	=

-	print("main: sleep...")
-	Client_USleep(2*1000) =

-	--~ print("main: send interrupt...")
-	--~ thread:Interrupt()
-	=

-	=

-	for i=3D1,10 do =

-		print("main:send")
-		MyRecvMessages()
-		MySend(kThreadMessage_Debug,i,42,"bla!")
-		MySend(kThreadMessage_Debug,i,42,"bla2!")
-		--~ local fifo2 =3D CreateFIFO()
-		--~ local crossp =3D fifo2:GetCrossThreadHandle()
-		--~ print("sending crossp",crossp)
-		--~ MySend(kThreadMessage_TransferPointer,crossp)
-		MySend(kThreadMessage_TransferBuffer,CreateFIFO())
-		Client_USleep(2*1000) =

-	end
-	=

-	print("main: done, sleeping before end...")
-	Client_USleep(5*60*1000) =

-	print("main: end")
-	os.exit(0)
+	=

+	local t =3D CreateExtendedLuaThread("../mythread.lua")
+	t:queueCall("ack", 3,3)
+	t:queueCall("stupidCounter", 5)
+	t:queueCall("ack", 2,2)
+	t:queueCall("ack", 2,1)
+	=

+	t:queueCallWithCallback(
+		function(id, ok, ret) =

+			print("CALLBACK", id, ok, unpack(ret))
+		end, =

+		"ack", 3,1)
+	=

+	local ok,ret =3D t:pickupResult(1)
+	print("RESULT",1,ok,unpack(ret))
+	=

+	local ok,ret =3D t:pickupResult(2)
+	print("RESULT",2,ok,unpack(ret))
+	=

+	local ok,ret =3D t:pickupResult(3)
+	print("RESULT",3,ok,unpack(ret))
+	=

+	t:waitForAllBlocking()
+	print("all finished")
+	=

+	Client_Sleep(10)
+	os.exit(1)
 end
 =

 function RunThreadTest_Child () =

@@ -162,61 +241,12 @@
 	dofile(lugreluapath.."lib.util.lua") =

 	dofile(lugreluapath.."lib.fifo.lua") =

 	dofile(lugreluapath.."lib.netmessage.lua") =

-	RunThreadTest_RegisterMessageTypes()
-	--~ Thread_Sleep(5*1000)
-	=

-	=

-	function ChildThread_Send (msgtype,...)
-		this_thread:LockMutex()
-		SendNetMessageFifo(this_fifo_send,msgtype,...)
-		this_thread:UnLockMutex()
-	end
-	=

-	local message_handlers =3D {}
-	message_handlers[kThreadMessage_TransferPointer] =3D function (p) =

-		print("child:kThreadMessage_TransferPointer",p) =

-		local fifo2 =3D CreateFIFOFromCrossThreadHandle(p)
-		print(" + transferred to fifo:",fifo2)
-	end
-	message_handlers[kThreadMessage_TransferBuffer] =3D function (fifo)
-		print("child:kThreadMessage_TransferBuffer received, filling and sending=
 back",fifo)
-		fifo:PushNetUint8(0xff)
-		fifo:PushNetUint8(0x11)
-		fifo:PushNetUint8(0x22)
-		ChildThread_Send(kThreadMessage_TransferBuffer,fifo) =

-		print("child:kThreadMessage_TransferBuffer done")
-	end
-	=

-	=

-	local local_fifo_recv =3D CreateFIFO()
-	while (true) do =

-		this_thread:LockMutex()
-		local_fifo_recv:PushFIFOPartRaw(this_fifo_recv) -- move data from this_f=
ifo_recv to local_fifo_recv
-		this_fifo_recv:Clear()
-		this_thread:UnLockMutex() -- release so we don't block while processing =
messages
-		RecvNetMessages(local_fifo_recv,function (msgtype,...) =

-				print("child:msg",msgtype,...) =

-				ChildThread_Send(kThreadMessage_Debug,99,99,"answer") =

-				local handler =3D message_handlers[msgtype]
-				if (handler) then handler(...) end
-				end)
-		Thread_Sleep(999*1000)
-	end
-	=

-
-	--~ print("child: getmutex")
-
-	--~ for i=3D1,211 do =

-		--~ print("child: sleeping")
-		--~ if (Thread_Sleep(1*1000)) then print("child: interrupted") break end
-	--~ end
-
-	--~ print("child: lock and read...")
-	--~ this_thread:LockMutex()
-	--~ print("child: FifoSizeRecv",this_fifo_recv:Size())
-	--~ print("child: FifoSizeSend",this_fifo_send:Size())
-	--~ this_thread:UnLockMutex()
+	=

+	ThreadChildMainLoop()
 =

 	print("child: ended")
 end
 =

+
+
+



From no-reply at zwischenwelt.org  Sat Mar 20 15:00:26 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 14:00:26 -0000
Subject: [Iris-commit] [IRIS] r3292 - /trunk/lua/lib.thread.lua
Message-ID: <20100320140026.8E9F87A98079@simon>

Author: hagish
Date: Sat Mar 20 15:00:24 2010
New Revision: 3292

Log:
* no need for calling the thread:step() method

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 15:00:24 2010
@@ -96,6 +96,8 @@
 	end
 	=

 	thread.isResultAvailable =3D function(self, id)
+		self:_step()
+		=

 		if self.resultTable[id] and type(self.resultTable[id]) =3D=3D "table" th=
en =

 			return true =

 		else =

@@ -103,7 +105,7 @@
 		end
 	end
 	=

-	thread.step =3D function(self)
+	thread._step =3D function(self)
 		while true do
 			local id,ok,ret =3D self:_getResult()
 			=

@@ -159,7 +161,7 @@
 	thread.waitForAllBlocking =3D function(self)
 		while self.callsRunning > 0 do
 			--~ print("still running", self.callsRunning)
-			self:step()
+			self:_step()
 			Client_USleep(1000 / 100)
 		end
 		--~ print("all finished")
@@ -168,7 +170,6 @@
 	thread.pickupResult =3D function(self, id)
 		if self:isIdValid(id) then
 			while not self:isResultAvailable(id) do
-				self:step()
 				Client_USleep(1000 / 100)
 			end
 			=




From no-reply at zwischenwelt.org  Sat Mar 20 15:24:24 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 14:24:24 -0000
Subject: [Iris-commit] [IRIS] r3293 - /trunk/lua/lib.thread.lua
Message-ID: <20100320142424.3E01A7A98079@simon>

Author: hagish
Date: Sat Mar 20 15:24:23 2010
New Revision: 3293

Log:
* small thread api changes for easier using

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 15:24:23 2010
@@ -73,9 +73,18 @@
 end
 =

 --[[
+
+-- example
+
 local t =3D CreateExtendedLuaThread("bla.lua")
-t:queueCall("ack", 3,3)
-local id,ok,ret =3D t:pickupResult()
+local id =3D t:queueCall("ack", 3,3)
+local id,ok,ret =3D t:pickupResultEx(id)
+id =3D t:queueCall("ack", 3,3)
+local ret =3D t:pickupResult(id)
+local id =3D t:queueCallWithCallback(function(ack_ret)
+	print("RESULT", ack_ret)
+end, "ack", 3,3)
+
 ]]
 function CreateExtendedLuaThread(file)
 	local thread =3D CreateLuaThread(file)
@@ -83,7 +92,7 @@
 	thread.fifo_send		=3D thread:CreateFifoParent2ChildHandle()
 	thread.fifo_recv		=3D thread:CreateFifoChild2ParentHandle()
 	thread.nextCallId		=3D 1
-	thread.callsRunning 	=3D 0
+	thread.callsQueued 	=3D 0
 	thread.callbackTable	=3D {}
 	thread.resultTable		=3D {}
 	=

@@ -131,10 +140,38 @@
 		return id
 	end
 	=

+	-- callback_success : function(...), [callback_error : function()]
+	thread.queueCallWithCallback =3D function(self, callback_success, callbac=
k_error, funName, ...)
+		if type(callback_error) =3D=3D "function" then
+		=

+			-- normal call with error handler
+			self:queueCallWithCallbackEx(function(id,ok,ret)
+				if ok =3D=3D 0 then
+					if callback_error then callback_error() end
+				else
+					if callback_success then callback_success(unpack(ret)) end
+				end
+			end, funName, ...)
+			=

+		else
+		=

+			-- shortened call without error handler
+			-- therefore funName is the first parameter
+			self:queueCallWithCallbackEx(function(id,ok,ret)
+				if ok =3D=3D 1 then
+					if callback_success then callback_success(unpack(ret)) end
+				end
+			end, callback_error, unpack({funName, ...}))
+		=

+		end
+	end
+	=

 	-- callback : function(id,ok,ret)
-	thread.queueCallWithCallback =3D function(self, callback, funName, ...)
-		local id =3D self:queueCall(funName, ...)
-		self.callbackTable[id] =3D callback
+	thread.queueCallWithCallbackEx =3D function(self, callback, funName, ...)
+		if callback then
+			local id =3D self:queueCall(funName, ...)
+			self.callbackTable[id] =3D callback
+		end
 	end
 	=

 	thread.queueCall =3D function(self, funName, ...)
@@ -149,7 +186,7 @@
 		fifo:PushS(funName)
 		FIFOPushNetSimpleTable({...}, fifo)
 	=

-		self.callsRunning =3D self.callsRunning + 1
+		self.callsQueued =3D self.callsQueued + 1
 	=

 		self:UnLockMutex()
 		=

@@ -158,9 +195,13 @@
 		return id
 	end
 	=

+	thread.countQueuedCalls =3D function(self)
+		return self.callsQueued
+	end
+	=

 	thread.waitForAllBlocking =3D function(self)
-		while self.callsRunning > 0 do
-			--~ print("still running", self.callsRunning)
+		while self.callsQueued > 0 do
+			--~ print("still running", self.callsQueued)
 			self:_step()
 			Client_USleep(1000 / 100)
 		end
@@ -168,6 +209,15 @@
 	end
 	=

 	thread.pickupResult =3D function(self, id)
+		local ok, ret =3D self:pickupResult(id) =

+		if ok =3D=3D 0 then
+			return nil
+		else
+			return unpack(ret)
+		end
+	end
+	=

+	thread.pickupResultEx =3D function(self, id)
 		if self:isIdValid(id) then
 			while not self:isResultAvailable(id) do
 				Client_USleep(1000 / 100)
@@ -193,7 +243,7 @@
 			id =3D fifo:PopU()
 			ok =3D fifo:PopU()
 			ret =3D FIFOPopNetSimpleTable(fifo)
-			self.callsRunning =3D self.callsRunning - 1
+			self.callsQueued =3D self.callsQueued - 1
 		end
 		=

 		self:UnLockMutex()
@@ -209,25 +259,40 @@
 	print("main: Threads_GetHardwareConcurrency:", Threads_GetHardwareConcurr=
ency())
 	=

 	local t =3D CreateExtendedLuaThread("../mythread.lua")
+	=

+	t:queueCallWithCallback(
+	function(ack) =

+		print("CALLBACK ack", ack)
+	end,
+	"ack", 3,1)
+		=

+	t:waitForAllBlocking()
+	print("all finished")
+	=

 	t:queueCall("ack", 3,3)
 	t:queueCall("stupidCounter", 5)
 	t:queueCall("ack", 2,2)
 	t:queueCall("ack", 2,1)
 	=

-	t:queueCallWithCallback(
+	t:queueCallWithCallbackEx(
 		function(id, ok, ret) =

 			print("CALLBACK", id, ok, unpack(ret))
 		end, =

 		"ack", 3,1)
-	=

-	local ok,ret =3D t:pickupResult(1)
+		=

+	t:queueCallWithCallback(
+		function(ack) =

+			print("CALLBACK ack", ack)
+		end,
+		"ack", 3,1)
+	=

+	local ok,ret =3D t:pickupResultEx(1)
 	print("RESULT",1,ok,unpack(ret))
 	=

-	local ok,ret =3D t:pickupResult(2)
+	local ok,ret =3D t:pickupResultEx(2)
 	print("RESULT",2,ok,unpack(ret))
 	=

-	local ok,ret =3D t:pickupResult(3)
-	print("RESULT",3,ok,unpack(ret))
+	--~ print("RESULT",3,t:pickupResult(3))
 	=

 	t:waitForAllBlocking()
 	print("all finished")



From no-reply at zwischenwelt.org  Sat Mar 20 15:31:45 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 14:31:45 -0000
Subject: [Iris-commit] [IRIS] r3294 - /trunk/lua/lib.thread.lua
Message-ID: <20100320143145.24A557A98079@simon>

Author: hagish
Date: Sat Mar 20 15:31:44 2010
New Revision: 3294

Log:
* block call added

Modified:
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 15:31:44 2010
@@ -174,6 +174,10 @@
 		end
 	end
 	=

+	thread.blockingCall =3D function(self, funName, ...)
+		return self:pickupResult(self:queueCall(funName, ...))
+	end
+	=

 	thread.queueCall =3D function(self, funName, ...)
 		local id =3D self:_generateNextId()
 		local fifo =3D self.fifo_send
@@ -209,7 +213,7 @@
 	end
 	=

 	thread.pickupResult =3D function(self, id)
-		local ok, ret =3D self:pickupResult(id) =

+		local ok, ret =3D self:pickupResultEx(id) =

 		if ok =3D=3D 0 then
 			return nil
 		else
@@ -260,6 +264,8 @@
 	=

 	local t =3D CreateExtendedLuaThread("../mythread.lua")
 	=

+	print("BLOCKING", t:blockingCall("stupidCounter", 2))
+	=

 	t:queueCallWithCallback(
 	function(ack) =

 		print("CALLBACK ack", ack)



From no-reply at zwischenwelt.org  Sat Mar 20 18:03:09 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 17:03:09 -0000
Subject: [Iris-commit] [IRIS] r3295 - in /trunk/lua: ./ gui/ net/ widgets/
Message-ID: <20100320170310.0ADEB54D0007@simon>

Author: hagish
Date: Sat Mar 20 18:03:09 2010
New Revision: 3295

Log:
* mega_cliloc speed improvements

Added:
    trunk/lua/worker_thread.lua
Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.helper.lua
    trunk/lua/gui/gui.popup.lua
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.cliloc.lua
    trunk/lua/lib.razorpacketvideo.lua
    trunk/lua/lib.thread.lua
    trunk/lua/main.lua
    trunk/lua/net/net.generic.lua
    trunk/lua/net/net.tooltips.lua
    trunk/lua/net/net.trade.lua
    trunk/lua/widgets/widget.gumpdialog.lua
    trunk/lua/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sat Mar 20 18:03:09 2010
@@ -716,7 +716,7 @@
 			--				a scrollbar s displayed.
 			-- TODO : width, height, background, scrollbar
 			elseif ((command =3D=3D "xmfhtmlgump") and (table.getn(bToken) >=3D 8))=
 then
-				local msg =3D HtmlParser( gClilocLoader and gClilocLoader:Get(bToken[6=
]) or "no_cliloc" )
+				local msg =3D HtmlParser( GetCliloc(bToken[6]) )
 				printdebug("gump","Cliloc Msg ("..bToken[6].."): "..msg.text)
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, gFo=
ntDefs["Gump"].col,
@@ -728,7 +728,7 @@
 			--				a scrollbar s displayed.
 			-- TODO : background, scrollbar, HUE-color
 			elseif ((command =3D=3D "xmfhtmlgumpcolor") and (table.getn(bToken) >=
=3D 9)) then
-				local msg =3D HtmlParser(  gClilocLoader and gClilocLoader:Get(bToken[=
6]) or "no_cliloc" )
+				local msg =3D HtmlParser(  GetCliloc(bToken[6]) )
 				printdebug("gump","Cliloc Msg ("..bToken[6].."): "..msg.text)
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, gFo=
ntDefs["Gump"].col,
@@ -965,7 +965,7 @@
 			--Description:  Adds to the previous layoutarray entry a Tooltip with t=
he in [cliloc-nr] defined Cliloc entry.
 			-- TODO : display tooltip
 			elseif ((command =3D=3D "tooltip") and (table.getn(bToken)>=3D 2)) then
-				local msg =3D HtmlParser( gClilocLoader and gClilocLoader:Get(bToken[2=
]) or "no_cliloc" )
+				local msg =3D HtmlParser( GetCliloc(bToken[2]) )
 				GuiAddChatLine("HtmlGumpparser - tooltip (TODO):"..msg.text)
 			else
 				printdebug("gump","UNKNOWN Generic Gump Command: "..command)

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Sat Mar 20 18:03:09 2010
@@ -58,6 +58,8 @@
 		local l =3D giShowLoading
 		local lu =3D giShowLoadingUnfinished
 		local fps =3D OgreAvgFPS()
+		local gfx3d =3D GetGfx3DCount()
+		local gfx2d =3D GetGfx2DCount()
 	=

 		if gConfig:Get("gLogStatsToFile") then
 			-- write to file
@@ -89,13 +91,18 @@
 			end
 		end
 					=

-		local text =3D sprintf("%5.1ffps %dt %db gfx | OGRE:%s LUA:%s C:%s | cpu=
/(cpu+gpu):%d%% | job:%d | blockload:%d/%d",
+		local cpu =3D floor((gFrameTimeCPUFraction or 0)*100)
+		local gpu =3D 100 - cpu
+					=

+		local text =3D sprintf("%5.1ffps %dt %db gfx | OGRE:%s LUA:%s C:%s | cpu=
:%d%% gpu:%d%% | job:%d/%d | blockload:%d/%d | %d/%d gfx",
 			fps, t, b, =

 			DisplayMemoryUsageFormatHelper(memoryusage),
 			DisplayMemoryUsageFormatHelper(mem_dyn), =

 			DisplayMemoryUsageFormatHelper(Client_GetMemoryUsage and Client_GetMemo=
ryUsage() or 0), =

-			floor((gFrameTimeCPUFraction or 0)*100),
-			j, l, lu   -- #"job.create()-jobs"    blockloader: working/killme
+			cpu, gpu,
+			j, (gWorkerThread and gWorkerThread:countQueuedCalls()) or 0,
+			l, lu,   -- #"job.create()-jobs"    blockloader: working/killme
+			gfx3d, gfx2d
 		)
 		if (not gMemoryUsageField) then
 			local vw,vh =3D GetViewportSize()

Modified: trunk/lua/gui/gui.popup.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.popup.lua (original)
+++ trunk/lua/gui/gui.popup.lua Sat Mar 20 18:03:09 2010
@@ -145,7 +145,7 @@
 =

 function GetPopupEntryText (textid) =

 	-- return GetIntLocText(math.floor(textid / 1000),math.mod(textid,1000)) =
-- doesn't work
-	return gClilocLoader and gClilocLoader:Get(3000000 + textid) or "Not Defi=
ned"
+	return GetCliloc(3000000 + textid)
 end
 --[[
 -- the packet description doesn't work on my installation

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sat Mar 20 18:03:09 2010
@@ -160,9 +160,6 @@
 	local static_block_num =3D 0
     if self.map3d_spawners and self.map3d_spawners.statics then
         self.map3d_spawners.statics:ForAllBlocks(function(block)
-			-- OLD NOTE/COMMENT
-            -- bbox raypick disabled, as it seems broken. model raypick co=
ntains bounding sphere precheck already.
-            -- block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) -- if 3d static =
mousepicking is strange, look here, xmirror maybe.. no longer used for terr=
ain, only here
 			static_block_num =3D static_block_num + 1
 			gProfiler_R3D_MousePick:Section("statics:BBRayPick")
             if block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
@@ -228,7 +225,7 @@
             end
         end)
     end
-	print("mousepick : static_mesh_buffer_num=3D",static_mesh_buffer_num,"sta=
tic_block_num=3D",static_block_num)
+	--~ print("mousepick : static_mesh_buffer_num=3D",static_mesh_buffer_num,=
"static_block_num=3D",static_block_num)
     =

     if ((not gCustomQuadInfoWritten) and numcustomquads > 300) then
         gCustomQuadInfoWritten =3D true

Modified: trunk/lua/lib.cliloc.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.cliloc.lua (original)
+++ trunk/lua/lib.cliloc.lua Sat Mar 20 18:03:09 2010
@@ -88,6 +88,34 @@
     return loader
 end
 =

+
+function ClilocTextContainsParameters(text)
+	if string.find (text, "~([1-9]+)_[^~]+~") =3D=3D nil then
+		return false
+	else
+		return true
+	end
+end
+
+gClilocCache =3D {}
+function GetClilocFromCache(id)
+	if not gClilocLoader then return "???", false end
+	=

+	if not gClilocCache[id] then
+		local text =3D gClilocLoader:Get(id)
+		local hasParams =3D ClilocTextContainsParameters(text)
+		gClilocCache[id] =3D {text, hasParams}
+		return text, hasParams
+	else =

+		return unpack(gClilocCache[id])
+	end
+end
+
+function GetCliloc(id)
+	local text, hasParams =3D GetClilocFromCache(id)
+	return text
+end
+
 -- replaces #1231231 by cliloc entry
 function ParseClilocParam (param)
     if (string.sub(param,1,1) ~=3D "#") then return param end -- first char
@@ -97,11 +125,18 @@
 end
 =

 -- replaces ~1_BLA~ by param_arr[1]
-function ParameterizedClilocText (cliloc_id,param_arr) =

-    local text_base =3D gClilocLoader and gClilocLoader:Get(cliloc_id) or =
("unknown_cliloc_"..cliloc_id)
-    local res =3D string.gsub(text_base,"~([1-9]+)_[^~]+~",function (num) =
return ParseClilocParam(param_arr[tonumber(num)]) end)
-    return res
-end
+function ParameterizedClilocText(id, params)
+	local text, hasParams =3D GetClilocFromCache(id)
+	if hasParams then
+		local res =3D string.gsub(text, "~([1-9]+)_[^~]+~",
+			function (num) return ParseClilocParam(params[tonumber(num)]) end)
+		return res
+	else
+		return text	=

+	end
+end
+
+
 =

 --[[
 -- TODO : port old iris code :  --- see also function gPacketHandler.kPack=
et_Localized_Text () in net.other.lua

Modified: trunk/lua/lib.razorpacketvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.razorpacketvideo.lua (original)
+++ trunk/lua/lib.razorpacketvideo.lua Sat Mar 20 18:03:09 2010
@@ -380,7 +380,7 @@
 	while true do =

 		local cliloc_id =3D input:PopNetUint32()
 		if (cliloc_id =3D=3D 0x00000000) then break end
-		local cliloctext =3D gClilocLoader and gClilocLoader:Get(cliloc_id) or ""
+		local cliloctext =3D GetCliloc(cliloc_id)
 		=

 		local number_of_unicode_chars =3D input:PopNetUint16() / 2
 		local text =3D ""

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sat Mar 20 18:03:09 2010
@@ -105,7 +105,7 @@
 	end
 	=

 	thread.isResultAvailable =3D function(self, id)
-		self:_step()
+		self:checkForResults()
 		=

 		if self.resultTable[id] and type(self.resultTable[id]) =3D=3D "table" th=
en =

 			return true =

@@ -114,7 +114,7 @@
 		end
 	end
 	=

-	thread._step =3D function(self)
+	thread.checkForResults =3D function(self)
 		while true do
 			local id,ok,ret =3D self:_getResult()
 			=

@@ -206,7 +206,7 @@
 	thread.waitForAllBlocking =3D function(self)
 		while self.callsQueued > 0 do
 			--~ print("still running", self.callsQueued)
-			self:_step()
+			self:checkForResults()
 			Client_USleep(1000 / 100)
 		end
 		--~ print("all finished")

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Mar 20 18:03:09 2010
@@ -32,6 +32,8 @@
 gSecondsSinceLastFrame =3D 0
 gInGameStarted =3D false
 gNet_State =3D false
+
+gFrameCounter =3D 0
 =

 function GetStackTrace () return _TRACEBACK() end
 =

@@ -501,6 +503,7 @@
     =

     gMyTicks =3D Client_GetTicks()
     =

+    =

     LoadingProfile("initializing Ogre",true)
     if (SetOgreInputOptions) then SetOgreInputOptions(gbHideMouse,gbGrabIn=
put) end
     gPreOgreTime =3D gLoadingProfileLastTime
@@ -522,7 +525,7 @@
     =

     ------------------------------------------ obsolete, just for testing =
-----------------------------------
     -- Lua test because Lua50 should not be compiled full-optimized with V=
S2005 Express (maybe also other compilers)
-    if (true) then LuaBitwiseTest() end
+    --~ if (true) then LuaBitwiseTest() end
     -- if (gHuffmanCompression) then LuaHuffmanTest() end
     ---if (false) then AnalyseStatics(0) end
     -- if (false) then ExpressionTest() end
@@ -563,6 +566,8 @@
     BindGeneralKeys()
 =

     NotifyListener("Hook_PostLoad")
+    =

+    gWorkerThread =3D CreateExtendedLuaThread(GetMainWorkingDir().."lua/wo=
rker_thread.lua")
 =

     StartMainMenu()
     =

@@ -571,6 +576,8 @@
     if gConfig:Get("gLogStatsToFile") then
         os.remove("stats.dat")
     end
+
+	=

 =

     -- mainloop
     if (gEnableGlobalProfiler) then StartGlobalProfiler2() end -- old and =
too slow, don't use
@@ -622,12 +629,16 @@
 =

 -- called every frame, after all timer-steppers, see Step() in lib.time.lua
 function MainStep ()
+	gFrameCounter =3D gFrameCounter + 1
+	=

     local t_cpu_start =3D Client_GetTicks()
     gProfiler_MainStep:Start(gEnableProfiler_MainStep)
     gProfiler_MainStep:Section("LugreStep")
         =

     gViewportW,gViewportH =3D GetViewportSize()
     LugreStep()
+    =

+    gWorkerThread:checkForResults()
     =

     gProfiler_MainStep:Section("Hook_MainStep")
     =


Modified: trunk/lua/net/net.generic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.generic.lua (original)
+++ trunk/lua/net/net.generic.lua Sat Mar 20 18:03:09 2010
@@ -161,7 +161,7 @@
 			else =

 				local iAttributeCharges =3D input:PopNetInt16()
 				data.attributes[iAttributeID] =3D iAttributeCharges
-				local cliloctxt =3D gClilocLoader and gClilocLoader:Get(iAttributeID) =
or ("unknown_cliloc_"..iAttributeID)
+				local cliloctxt =3D GetCliloc(iAttributeID)
 				table.insert(myPreAosAttributeLines,((iAttributeCharges > 0) and (iAtt=
ributeCharges..":") or "")..cliloctxt)
 			end
 		end

Modified: trunk/lua/net/net.tooltips.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.tooltips.lua (original)
+++ trunk/lua/net/net.tooltips.lua Sat Mar 20 18:03:09 2010
@@ -44,6 +44,9 @@
 	end
 end
 =

+gMegaClilocParamsCache =3D {}
+gMegaClilocParamsCache.size =3D 0
+
 -- Mega Cliloc - server sends new Clilocs - just add them to the Cliloc
 -- TODO : this cliloc additions might be local to a specific mobile, e.g. =
vendor or container...
 function gPacketHandler.kPacket_Mega_Cliloc()	--0xD6
@@ -58,33 +61,60 @@
 	local hash =3D BitwiseAND(data.objrevision_hash,kToolTipHashMask) =

 		-- objrevision_hash in old iris code : obj/character->SetAOSTooltipID(li=
stID);
 	=

+	-- reset cache if it gets tooo big
+	if gMegaClilocParamsCache.size > 100 then
+		gMegaClilocParamsCache =3D {}
+		gMegaClilocParamsCache.size =3D 0
+		--~ print("RESET PARAM CACHE")
+	end
+	=

 	local totaltext =3D ""
 	local bFirst =3D true
 	=

 	while true do =

 		local cliloc_id =3D input:PopNetUint32()
 		if (cliloc_id =3D=3D 0x00000000) then break end
-		local cliloctext =3D gClilocLoader and gClilocLoader:Get(cliloc_id) or ""
+		--~ local cliloctext =3D GetCliloc(cliloc_id)
 		=

 		local number_of_unicode_chars =3D input:PopNetUint16() / 2
-		local text =3D ""
-		local totalparamtext =3D ""
-		local debugtxt =3D ""
+		=

+		local buffersize =3D number_of_unicode_chars * 2
+		local crc =3D input:CRC(buffersize)
+		=

+		--~ print("CRC", crc)
+		=

 		local params =3D {}
-		for i =3D 1,number_of_unicode_chars do  -- read unicode text and split b=
y 0x09 =3D tab
-			local head =3D input:PopUint8()
-			local data =3D input:PopUint8()
-			local c =3D ((head~=3D0) and string.char(head) or "?")
-			if (head =3D=3D 9 and data =3D=3D 0) then -- delimiter =3D tab=3D0x09
-				table.insert(params,text)
-				text =3D ""
-			else
-				text =3D text..c
+		=

+		if not gMegaClilocParamsCache[crc] then
+					=

+			--~ print("---->", cliloc_id, number_of_unicode_chars)
+			local text =3D ""
+			local totalparamtext =3D ""
+			--~ local debugtxt =3D ""
+			=

+			for i =3D 1,number_of_unicode_chars do  -- read unicode text and split =
by 0x09 =3D tab
+				local head =3D input:PopUint8()
+				local data =3D input:PopUint8()
+				local c =3D ((head~=3D0) and string.char(head) or "?")
+				if (head =3D=3D 9 and data =3D=3D 0) then -- delimiter =3D tab=3D0x09
+					table.insert(params,text)
+					text =3D ""
+				else
+					text =3D text..c
+				end
+				totalparamtext =3D totalparamtext..c
+				--~ debugtxt =3D debugtxt.."("..head..","..data..":"..c..")"
 			end
-			totalparamtext =3D totalparamtext..c
-			debugtxt =3D debugtxt.."("..head..","..data..":"..c..")"
+			table.insert(params,text)
+		=

+			gMegaClilocParamsCache[crc] =3D params
+			gMegaClilocParamsCache.size =3D gMegaClilocParamsCache.size + 1
+		else
+			input:PopRaw(buffersize)
+			=

+			--~ print("CACHE HIT", crc)
+			params =3D gMegaClilocParamsCache[crc]
 		end
-		table.insert(params,text)
 		=

 		local text =3D string.gsub(ParameterizedClilocText(cliloc_id,params),"<b=
r>","\n")
 		=


Modified: trunk/lua/net/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.trade.lua (original)
+++ trunk/lua/net/net.trade.lua Sat Mar 20 18:03:09 2010
@@ -153,7 +153,7 @@
 			end
 			=

 			local nameint =3D tonumber(good.name)
-			if (nameint and good.name =3D=3D ""..nameint) then good.name =3D gClilo=
cLoader:Get(nameint) or ("unknown_cliloc_"..nameint) end
+			if (nameint and good.name =3D=3D ""..nameint) then good.name =3D GetCli=
loc(nameint) end
 			shop.goods[i] =3D good
 		end
 		=

@@ -247,7 +247,7 @@
 			--~ good.bIsInPlayerBackpack =3D good.item.iContainerSerial =3D=3D GetP=
layerBackPackSerial()  not needed, see bSellMode above
 			=

 			local nameint =3D tonumber(good.name)
-			if (nameint and good.name =3D=3D ""..nameint) then good.name =3D gClilo=
cLoader:Get(nameint) or ("unknown_cliloc_"..nameint) end
+			if (nameint and good.name =3D=3D ""..nameint) then good.name =3D GetCli=
loc(nameint) end
 			=

 			print("shopitem",hex(good.item.artid),hex(good.item.hue),good.price,goo=
d.name) =

 			--~ if (not knownartids[good.item.artid]) then print("shopitem",good.it=
em.artid,good.name) knownartids[good.item.artid] =3D true end

Modified: trunk/lua/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.gumpdialog.lua (original)
+++ trunk/lua/widgets/widget.gumpdialog.lua Sat Mar 20 18:03:09 2010
@@ -84,7 +84,7 @@
 	end
 	if (gClilocLoader) then
 		for cliloc_id,v in pairs(self.usedClilocs) do
-			if (StringContains(gClilocLoader:Get(cliloc_id),search)) then return tr=
ue end
+			if (StringContains(GetCliloc(cliloc_id),search)) then return true end
 		end
 	end
 end
@@ -104,7 +104,7 @@
 	end
 	if (gClilocLoader) then
 		for cliloc_id,v in pairs(self.usedClilocs) do
-			table.insert(res,gClilocLoader:Get(cliloc_id))
+			table.insert(res,GetCliloc(cliloc_id))
 		end
 	end
 	return res

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Sat Mar 20 18:03:09 2010
@@ -35,7 +35,7 @@
 			if (params.args) then =

 				text =3D ParameterizedClilocText(params.cliloc_id,params.args)
 			else
-				text =3D gClilocLoader:Get(params.cliloc_id) or "no_cliloc" =

+				text =3D GetCliloc(params.cliloc_id)
 			end
 		end
 	end



From no-reply at zwischenwelt.org  Sat Mar 20 22:54:23 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 21:54:23 -0000
Subject: [Iris-commit] [IRIS] r3296 - /trunk/lua/gui/gui.helper.lua
Message-ID: <20100320215424.705447A98079@simon>

Author: ghoulsblade
Date: Sat Mar 20 22:54:21 2010
New Revision: 3296

Log:
fix if no new compile

Modified:
    trunk/lua/gui/gui.helper.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Sat Mar 20 22:54:21 2010
@@ -58,8 +58,8 @@
 		local l =3D giShowLoading
 		local lu =3D giShowLoadingUnfinished
 		local fps =3D OgreAvgFPS()
-		local gfx3d =3D GetGfx3DCount()
-		local gfx2d =3D GetGfx2DCount()
+		local gfx3d =3D GetGfx3DCount and GetGfx3DCount() or 0
+		local gfx2d =3D GetGfx2DCount and GetGfx2DCount() or 0
 	=

 		if gConfig:Get("gLogStatsToFile") then
 			-- write to file



From no-reply at zwischenwelt.org  Sat Mar 20 23:32:16 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 20 Mar 2010 22:32:16 -0000
Subject: [Iris-commit] [IRIS] r3297 - in /trunk/lua: gui/gui.helper.lua
 lib.mapblock.3d.statics.lua lib.mapblock.3d.terrain.lua
 lib.mapblock.scheduler.lua
Message-ID: <20100320223216.316867A98079@simon>

Author: hagish
Date: Sat Mar 20 23:32:15 2010
New Revision: 3297

Log:
* small 3d map improvements

Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.mapblock.3d.statics.lua
    trunk/lua/lib.mapblock.3d.terrain.lua
    trunk/lua/lib.mapblock.scheduler.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Sat Mar 20 23:32:15 2010
@@ -17,7 +17,8 @@
 	-- calculate frame number
 	local f =3D 0
 	if giShowLoading > 0 then
-		f =3D 1 + math.mod(math.floor(gMyTicks / 1000 * fps), frames-1)
+		local speed =3D Clamp(1 + giShowLoading / 200, 1, 2)
+		f =3D 1 + math.mod(math.floor(gMyTicks / 1000 * fps * speed), frames-1)
 	end
 	=

 	-- on demand create icon

Modified: trunk/lua/lib.mapblock.3d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.statics.lua (original)
+++ trunk/lua/lib.mapblock.3d.statics.lua Sat Mar 20 23:32:15 2010
@@ -15,7 +15,7 @@
 =

 cMapBlock_3D_Statics	=3D CreateClass(cMapBlockGrid)
 cMapBlock_3D_Statics.iBlockSize		=3D 8*2 -- in tiles
-cMapBlock_3D_Statics.iLoadRadius	=3D 8 -- in iBlockSize-blocks
+cMapBlock_3D_Statics.iLoadRadius	=3D 4 -- in iBlockSize-blocks
 cMapBlock_3D_Statics.kMaxDist_Visible		=3D cMapBlock_3D_Statics.iBlockSize=
 * 8 -- camdist in tiles  see mapblock.base for default
 cMapBlock_3D_Statics.kMaxDist_Detail		=3D cMapBlock_3D_Statics.iBlockSize =
* 4 -- camdist in tiles
 =


Modified: trunk/lua/lib.mapblock.3d.terrain.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.terrain.lua (original)
+++ trunk/lua/lib.mapblock.3d.terrain.lua Sat Mar 20 23:32:15 2010
@@ -1,6 +1,6 @@
 cMapBlock_3D_Terrain	=3D CreateClass(cMapBlockGrid)
 cMapBlock_3D_Terrain.iBlockSize		=3D 8*2 -- in tiles
-cMapBlock_3D_Terrain.iLoadRadius	=3D 8 -- in iBlockSize-blocks
+cMapBlock_3D_Terrain.iLoadRadius	=3D 4 -- in iBlockSize-blocks
 cMapBlock_3D_Terrain.kMaxDist_Visible		=3D cMapBlock_3D_Terrain.iBlockSize=
 * 8 -- camdist in tiles  see mapblock.base for default
 cMapBlock_3D_Terrain.kMaxDist_Detail		=3D cMapBlock_3D_Terrain.iBlockSize =
* 4 -- camdist in tiles
 =


Modified: trunk/lua/lib.mapblock.scheduler.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.scheduler.lua (original)
+++ trunk/lua/lib.mapblock.scheduler.lua Sat Mar 20 23:32:15 2010
@@ -11,6 +11,9 @@
 	self.kGoodFPS =3D 50
 	self.kGoodTicksBetweenFrames =3D 1000 / self.kGoodFPS -- 1000=3D1sec
 	self.kAllowedTicksPerFrame =3D self.kGoodTicksBetweenFrames
+	=

+	self.lastSort =3D nil
+	self.sortTimeout =3D 1000 / 5
 end
 =

 function cScheduler:AddProcess		(process) =

@@ -28,12 +31,9 @@
 gfScheduler_WorkTime =3D 0
 gfScheduler_WorkCount =3D 0
 =

+
 -- x,y,z : cam/focus-pos
 function cScheduler:Step		(x,y,z)
-	--~ if math.mod(gMyFrameCounter, 100) =3D=3D 0 then
-		--~ print("procs",table.getn(self.pProcessList))
-	--~ end
-
 	local t =3D Client_GetTicks()
 	local t_end =3D gMyTicks + self.kAllowedTicksPerFrame
 	=

@@ -46,6 +46,10 @@
 			table.insert(active_blocks, process)
 		end
 	end =

+	=

+	--~ if math.mod(gMyFrameCounter, 30) =3D=3D 0 then
+		--~ print("procs",table.getn(self.pProcessList), countarr(active_blocks))
+	--~ end
 	=

 	giShowLoading =3D countarr(active_blocks)
 	if (gDebugJobOrigin and giShowLoading > 20) then =

@@ -61,19 +65,31 @@
 	end
 	=

 	-- sort by priority
-	table.sort(active_blocks,self.CmpProcess)
+	if self.lastSort =3D=3D nil or (t - self.lastSort > self.sortTimeout) then
+		table.sort(active_blocks, self.CmpProcess)
+		=

+		if self.lastSort =3D=3D nil then =

+			self.lastSort =3D t
+		else
+			self.lastSort =3D self.lastSort + self.sortTimeout
+		end
+	end
 	=

-	-- work until no time left
+	-- work until no time left but to atleast a small number of blocks
 	local avgdt =3D nil
+	local done =3D 0
+	local minDone =3D 3
 	for k,process in ipairs(active_blocks) do =

 		local t1 =3D Client_GetTicks()
 		process:Work(t_end)
 		local t2 =3D Client_GetTicks()
 =

+		done =3D done + 1
+
 		avgdt =3D avgdt and (avgdt*0.5+(t2-t1)*0.5) or (t2-t1)
 		=

 		--~ if (Client_GetTicks() >=3D t_end) then break end
-		if (t2 + avgdt >=3D t_end) then break end
+		if (t2 + avgdt >=3D t_end and done >=3D minDone) then break end
 	end
 end
 =




From no-reply at zwischenwelt.org  Sun Mar 21 16:19:54 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 21 Mar 2010 15:19:54 -0000
Subject: [Iris-commit] [IRIS] r3298 - in /trunk/lua: lib.granny.anim.lua
 lib.granny.debug.lua lib.granny.loader.lua
Message-ID: <20100321151955.045B77A9807A@simon>

Author: ghoulsblade
Date: Sun Mar 21 16:19:54 2010
New Revision: 3298

Log:
granny lua port, loading static works, test : -sdg

Added:
    trunk/lua/lib.granny.anim.lua
Modified:
    trunk/lua/lib.granny.debug.lua
    trunk/lua/lib.granny.loader.lua

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Sun Mar 21 16:19:54 2010
@@ -59,6 +59,8 @@
 	--~ self:MakeOldGranny(modelid)
 	self:MakeNewGranny(modelid)
 	=

+	print("")
+	=

 	self:StartMainLoop()
 end
 =

@@ -150,6 +152,77 @@
 									}
 =

 function cDebugGrannyMenu:MakeNewGranny (artid)
+	artid =3D 200 -- horse
+	local folder =3D "/cavern/uoml_freshinstall.4.x/Models/Animals/"
+	local matname =3D GetGrannyMat(artid,0,GetGrannyModelLoader(artid))
+	local filepath =3D GetGrannyFilePath(artid)
+	local grn =3D cGrannyFile:New()
+	grn:LoadFile(filepath)
+	=

+	local pGrannyLoader =3D {}
+	if (1 =3D=3D 1) then
+		-- wrap grn into pGrannyLoader
+		local Object =3D grn.pMainChunk.Object
+		local mSubMeshes =3D {}
+		pGrannyLoader.mSubMeshes =3D mSubMeshes
+		for kMeshIndex,mesh in ipairs(Object.mesh_list.childs or {}) do
+			local pLoaderSubMesh =3D {}
+			table.insert(mSubMeshes,pLoaderSubMesh)
+			pLoaderSubMesh.mWeights =3D {}
+			pLoaderSubMesh.mTexCoords =3D {}
+			=

+			--~ local weightdata =3D {}
+			--~ table.insert(pLoaderSubMesh.mWeights,weightdata)
+			=

+			--~ weightdata.iNumBones =3D 0
+			--~ weightdata.pWeights =3D {}
+			--~ local weight =3D {}
+			--~ table.insert(weightdata.pWeights,weight)
+			--~ weight.iWeightBoneIndex =3D 0
+			--~ weight.fWeight =3D 0
+			=

+			--~ if (mesh.weights and mesh.weights.list_weightchunks and #mesh.weigh=
ts.list_weightchunks > 0) then bHasBoneWeights =3D true end
+			--~ if (mesh.polygons and mesh.polygons.list_polygons and #mesh.polygon=
s.list_polygons > 0) then bIsEmptyMesh =3D false end
+			=

+			local polygons			=3D mesh.polygons.list_polygons
+			local point_container 	=3D mesh.point_block.point_container
+			local positions			=3D point_container.points.list_points
+			local normals			=3D point_container.normals.list_normals
+			local texcoords			=3D point_container.texture_container.texcoords and
+									  point_container.texture_container.texcoords.list_texcoords
+			=

+			local texture_poly 		=3D Object.texture_list.texture.texture_sublist.ch=
ilds[kMeshIndex]
+			local texpolys			=3D texture_poly.texture_poly_list.list_texpoly_normal
+			=

+            -- sanity checks
+            if (texpolys) then =

+                    assert(#polygons =3D=3D #texpolys)
+                    for k,texpoly in ipairs(texpolys) do assert(texpoly.iU=
nknown =3D=3D k-1) end
+            end
+
+			pLoaderSubMesh.mPolygons =3D polygons
+			pLoaderSubMesh.mTexturePolyLists =3D texpolys
+			pLoaderSubMesh.mTempName_TexCoords =3D texcoords
+			pLoaderSubMesh.mPoints =3D positions
+			pLoaderSubMesh.mNormals =3D normals
+		end
+	end
+	local szMatName =3D matname
+	local szMeshName =3D "MyGrannyTest_Mesh_123"
+	local szSkeletonName =3D "MyGrannyTest_Skel_123"
+	local res =3D LoadGrannyAsOgreMesh(pGrannyLoader,szMatName,szMeshName,szS=
keletonName)
+	=

+	-- create instance
+	local sceneManager =3D GetSceneManager()
+	local sMeshName =3D szMeshName
+	local sEntityName =3D GetUniqueName()
+	local entity =3D sceneManager:createEntity(sEntityName,sMeshName)
+	local gfx =3D CreateRootGfx3D()
+	local scenenode =3D gfx:GetSceneNode()
+	scenenode:attachObject(entity)
+end
+
+function cDebugGrannyMenu:MakeNewGranny_OldDump (artid)
 	--~ artid =3D 791 -- beetle
 	artid =3D 200 -- horse
 	=

@@ -294,49 +367,8 @@
 			for k,texpoly in ipairs(texpolys) do assert(texpoly.iUnknown =3D=3D k-1=
) end
 		end
 		=

-		local vb0 =3D cVertexBuffer:New()
-		local vb1 =3D cVertexBuffer:New()
-		local ib =3D cIndexBuffer:New()
-		local combo_next_i =3D 0
-		local combos =3D {}
-		=

 		-- assembling vertex-buffer, this block doesn't need ogre
-		local rr =3D 0
-		--[[
-		!!!!!! MOVED TO lib.granny.anim.lua cSubMeshConstructor::Execute !!!!!
-		for k,poly in pairs(polygons) do =

-			local texpoly =3D texpolys and texpolys[k] =

-			for i=3D0,2 do =

-				local pi =3D poly.iVertex[i] + 1
-				local ni =3D poly.iNormal[i] + 1
-				local ti =3D (texpoly and texpoly.iTexCoord[i] or 0) + 1
-				local comboname =3D pi..","..ni..","..ti
-				local comboi =3D combos[comboname]
-				if (not comboi) then =

-					comboi =3D combo_next_i
-					combo_next_i =3D combo_next_i + 1
-					local p =3D positions[pi]
-					local n =3D normals[ni]
-					local x =3D p.x
-					local y =3D p.y
-					local z =3D p.z
-					local dd =3D x*x + y*y + z*z
-					if (dd > rr) then rr =3D dd end
-					vb0:Vertex(	x,y,z, n.x,n.y,n.z)
-					if (texcoords) then
-						local t =3D texcoords[ti]
-						vb1:Vertex(t.x,t.y)
-					else
-						vb1:Vertex(math.random(),math.random())
-					end
-					combos[comboname] =3D comboi
-				end
-				ib:Index(comboi)
-			end
-		end
-		]]--
-		vb0:CheckSize()
-		vb1:CheckSize()
+		--~ !!!!!! MOVED TO lib.granny.anim.lua cSubMeshConstructor::Execute !!!=
!!
 		local fSquareRadius =3D rr
 		--~ print("vb0.vc",vb0.vc,vb0.iFirstSize)
 		--~ print("vb1.vc",vb1.vc,vb1.iFirstSize)

Modified: trunk/lua/lib.granny.loader.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.loader.lua (original)
+++ trunk/lua/lib.granny.loader.lua Sun Mar 21 16:19:54 2010
@@ -25,6 +25,7 @@
 =

 cGrannyFile =3D cGrannyFile or CreateClass()
 =

+dofile(libpath .. "lib.granny.anim.lua")
 dofile(libpath .. "lib.granny.types.lua")
 =

 function GrannyTest_PreOgreInit () =




From no-reply at zwischenwelt.org  Sun Mar 21 17:16:36 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 21 Mar 2010 16:16:36 -0000
Subject: [Iris-commit] [IRIS] r3299 - in /trunk/lua: lib.granny.anim.lua
	lib.granny.debug.lua
Message-ID: <20100321161636.1B1F354D0007@simon>

Author: ghoulsblade
Date: Sun Mar 21 17:16:35 2010
New Revision: 3299

Log:
small fixes

Modified:
    trunk/lua/lib.granny.anim.lua
    trunk/lua/lib.granny.debug.lua

Modified: trunk/lua/lib.granny.anim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.anim.lua (original)
+++ trunk/lua/lib.granny.anim.lua Sun Mar 21 17:16:35 2010
@@ -317,7 +317,8 @@
 	-- order for VertexDeclaration : position, blending weights, normals, dif=
fuse colours, specular colours, texture coordinates
 	=

 	=

-	local bUseSkeleton	=3D self.mpSkeleton and #pLoaderSubMesh.mWeights > 0 -=
- (pLoaderSubMesh.mWeights).second > 0
+	local bUseSkeleton	=3D self.mpSkeleton and (pLoaderSubMesh.mWeights and #=
pLoaderSubMesh.mWeights > 0) -- (pLoaderSubMesh.mWeights).second > 0
+	print("granny.anim: useskel,skel,weight,#weight",bUseSkeleton,self.mpSkel=
eton,pLoaderSubMesh.mWeights,pLoaderSubMesh.mWeights and #pLoaderSubMesh.mW=
eights)
 	local bUseColors	=3D false and pLoaderSubMesh.mColors -- TODO_Get(pLoader=
SubMesh.mColors).first -- not yet supported (see below)
 	local bUseTexCoords	=3D pLoaderSubMesh.mTexCoords -- TODO_Get(pLoaderSubM=
esh.mTexCoords).first
 	--~ typedef std::vector< std::pair<int,float> >		tMyBoneWeightList
@@ -360,14 +361,14 @@
 	local texpolys		=3D pLoaderSubMesh.mTexturePolyLists -- wrong var ? recur=
sive ?   mpGrannyLoader->GetTexIndex(i,j)
 	local positions		=3D pLoaderSubMesh.mPoints
 	local normals		=3D pLoaderSubMesh.mNormals
-	local texcoords		=3D pLoaderSubMesh.mTempName_TexCoords
+	local texcoords		=3D pLoaderSubMesh.mTexCoords
 	-- assembling vertex-buffer, this block doesn't need ogre
 	=

 	local rr =3D 0
 	-- iterate over all polygon-vertices
 	for k,poly in pairs(polygons) do =

 		local texpoly =3D texpolys and texpolys[k] =

-		print("granny.anim.submesh texpolys texpoly",texpolys,texpoly,texpoly an=
d texpoly.iTexCoord[0])
+		--~ print("granny.anim.submesh texpolys texpoly",texpolys,texpoly,texpol=
y and texpoly.iTexCoord[0])
 		for i=3D0,2 do =

 			local pi =3D poly.iVertex[i] + 1
 			local ni =3D poly.iNormal[i] + 1

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Sun Mar 21 17:16:35 2010
@@ -196,13 +196,13 @@
 			=

             -- sanity checks
             if (texpolys) then =

-                    assert(#polygons =3D=3D #texpolys)
-                    for k,texpoly in ipairs(texpolys) do assert(texpoly.iU=
nknown =3D=3D k-1) end
+                assert(#polygons =3D=3D #texpolys)
+                for k,texpoly in ipairs(texpolys) do assert(texpoly.iUnkno=
wn =3D=3D k-1) end
             end
 =

 			pLoaderSubMesh.mPolygons =3D polygons
 			pLoaderSubMesh.mTexturePolyLists =3D texpolys
-			pLoaderSubMesh.mTempName_TexCoords =3D texcoords
+			pLoaderSubMesh.mTexCoords =3D texcoords
 			pLoaderSubMesh.mPoints =3D positions
 			pLoaderSubMesh.mNormals =3D normals
 		end



From no-reply at zwischenwelt.org  Mon Mar 22 20:48:58 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 22 Mar 2010 19:48:58 -0000
Subject: [Iris-commit] [IRIS] r3300 - /trunk/bin/iris2.exe
Message-ID: <20100322194858.597DE7A98079@simon>

Author: sience
Date: Mon Mar 22 20:48:58 2010
New Revision: 3300

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Mon Mar 22 20:54:54 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 22 Mar 2010 19:54:54 -0000
Subject: [Iris-commit] [IRIS] r3301 - /trunk/lua/main.lua
Message-ID: <20100322195454.B7B197A98079@simon>

Author: sience
Date: Mon Mar 22 20:54:53 2010
New Revision: 3301

Log:
-win32 thread fix (currently no threading in win32)

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Mar 22 20:54:53 2010
@@ -567,7 +567,9 @@
 =

     NotifyListener("Hook_PostLoad")
     =

-    gWorkerThread =3D CreateExtendedLuaThread(GetMainWorkingDir().."lua/wo=
rker_thread.lua")
+    if (WIN32=3D=3Dfalse) then
+    	gWorkerThread =3D CreateExtendedLuaThread(GetMainWorkingDir().."lua/w=
orker_thread.lua")
+    end
 =

     StartMainMenu()
     =

@@ -638,7 +640,9 @@
     gViewportW,gViewportH =3D GetViewportSize()
     LugreStep()
     =

-    gWorkerThread:checkForResults()
+    if (WIN32=3D=3Dfalse) then
+		gWorkerThread:checkForResults()
+	end
     =

     gProfiler_MainStep:Section("Hook_MainStep")
     =




From no-reply at zwischenwelt.org  Mon Mar 22 21:03:47 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 22 Mar 2010 20:03:47 -0000
Subject: [Iris-commit] [IRIS] r3302 - /branches/stable_release/
Message-ID: <20100322200347.976F37A98079@simon>

Author: ghoulsblade
Date: Mon Mar 22 21:03:47 2010
New Revision: 3302

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Mon Mar 22 21:03:48 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 22 Mar 2010 20:03:48 -0000
Subject: [Iris-commit] [IRIS] r3303 - /branches/stable_release/
Message-ID: <20100322200348.7628C7A9816F@simon>

Author: ghoulsblade
Date: Mon Mar 22 21:03:47 2010
New Revision: 3303

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r3302, trunk/



From no-reply at zwischenwelt.org  Mon Mar 22 21:03:49 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 22 Mar 2010 20:03:49 -0000
Subject: [Iris-commit] [IRIS] r3304 - /branches/stable_release/
Message-ID: <20100322200349.231B07A9816F@simon>

Author: ghoulsblade
Date: Mon Mar 22 21:03:48 2010
New Revision: 3304

Log:
lugre -r829 svn://zwischenwelt.org/lugre/trunk/lugre

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Wed Mar 24 23:49:45 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 24 Mar 2010 22:49:45 -0000
Subject: [Iris-commit] [IRIS] r3305 - in /trunk/lua: lib.granny.anim.lua
	lib.granny.debug.lua
Message-ID: <20100324224946.156C754D0007@simon>

Author: ghoulsblade
Date: Wed Mar 24 23:49:45 2010
New Revision: 3305

Log:
granny loader luaport : data api adjusted for the nasty stuff : paramgroups=
, mainparams, boneties 0+1+2

Modified:
    trunk/lua/lib.granny.anim.lua
    trunk/lua/lib.granny.debug.lua

Modified: trunk/lua/lib.granny.anim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.anim.lua (original)
+++ trunk/lua/lib.granny.anim.lua Wed Mar 24 23:49:45 2010
@@ -100,7 +100,6 @@
 	assert(pLoaderSubMesh.mTexCoords.first)
 	assert(pLoaderSubMesh.mColors)
 	assert(pLoaderSubMesh.mColors.first)
-	assert(pLoaderSubMesh.mWeights)
 	assert(pLoaderSubMesh.mWeights)
 	=

 	for i,weightdata in ipairs(pLoaderSubMesh.mWeights) do =

@@ -343,9 +342,9 @@
 			local pBoneList =3D {} -- tMyBoneWeightList
 			table.insert(myBoneWeights,pBoneList)
 			=

-			for k,weight in ipairs(weightdata.pWeights) do  -- iNumBones entries
-				local		iWeightBoneIndex	=3D weight.iWeightBoneIndex	-- *(p++)	-- ::uin=
t32
-				local		fWeight				=3D weight.fWeight			-- *(float*)(p++)	-- float
+			for k,weight in ipairs(weightdata.list_pairs) do  -- iNumBones entries
+				local		iWeightBoneIndex	=3D weight.iWeightBoneIndex	-- *(p++)	-- ::uin=
t32        iWeightBoneIndex=3D22=3D0x16
+				local		fWeight				=3D weight.fWeight			-- *(float*)(p++)	-- float     =
   fWeight=3D1
 				table.insert(pBoneList,{iWeightBoneIndex,fWeight})
 			end
 		end
@@ -389,12 +388,12 @@
 				=

 				if (bUseSkeleton) then
 					-- iterate over boneweights
-					local myBoneWeightList =3D myBoneWeights[iP-1] -- tMyBoneWeightList
+					local myBoneWeightList =3D myBoneWeights[pi] -- tMyBoneWeightList
 					if (myBoneWeightList) then
 						for i,itor in ipairs(myBoneWeightList) do =

 							local	iWeightBoneIndex 	=3D itor[1]
 							local	w 					=3D itor[2]
-							local 	iGrannyBoneID 		=3D self:WeightBoneIndex2GrannyBoneID(iWeigh=
tBoneIndex)
+							--~ local 	iGrannyBoneID 		=3D self:WeightBoneIndex2GrannyBoneID(iW=
eightBoneIndex)
 							local	iOgreBoneHandle 	=3D self:WeightBoneIndex2OgreBoneHandle(iWei=
ghtBoneIndex)
 							=

 							-- assign vertices to skeleton bones
@@ -471,8 +470,8 @@
 	local bIsEmptyMesh =3D true
 	local bHasBoneWeights =3D false
 	for k,sub in ipairs(pGrannyLoader.mSubMeshes) do -- pGrannyLoader.mSubMes=
hes.size()
-		if (#sub.mWeights > 0) then bHasBoneWeights =3D true end
-		if (#sub.mPolygons > 0) then bIsEmptyMesh =3D false end
+		if (sub.mWeights and #sub.mWeights > 0) then bHasBoneWeights =3D true end
+		if (sub.mPolygons and #sub.mPolygons > 0) then bIsEmptyMesh =3D false end
 	end
 	=

 	--printf("LoadGrannyAsOgreMesh %s, submesh=3D%d\n",pGrannyLoader.mGranny.=
msFilePath,pGrannyLoader.mSubMeshes.size())
@@ -488,6 +487,7 @@
 	pMesh:_setBoundingSphereRadius(0)
 =

 	=

+	print("granny.anim:LoadGrannyAsOgreMesh:bHasBoneWeights=3D",bHasBoneWeigh=
ts)
 	local pSkeleton -- Ogre::SkeletonPtr
 	-- assign skeleton only if there are BoneWeights
 	if (bHasBoneWeights) then

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Wed Mar 24 23:49:45 2010
@@ -168,8 +168,6 @@
 		for kMeshIndex,mesh in ipairs(Object.mesh_list.childs or {}) do
 			local pLoaderSubMesh =3D {}
 			table.insert(mSubMeshes,pLoaderSubMesh)
-			pLoaderSubMesh.mWeights =3D {}
-			pLoaderSubMesh.mTexCoords =3D {}
 			=

 			--~ local weightdata =3D {}
 			--~ table.insert(pLoaderSubMesh.mWeights,weightdata)
@@ -193,6 +191,7 @@
 			=

 			local texture_poly 		=3D Object.texture_list.texture.texture_sublist.ch=
ilds[kMeshIndex]
 			local texpolys			=3D texture_poly.texture_poly_list.list_texpoly_normal
+			local list_weightchunks	=3D mesh.weights.list_weightchunks
 			=

             -- sanity checks
             if (texpolys) then =

@@ -205,6 +204,127 @@
 			pLoaderSubMesh.mTexCoords =3D texcoords
 			pLoaderSubMesh.mPoints =3D positions
 			pLoaderSubMesh.mNormals =3D normals
+			pLoaderSubMesh.mWeights =3D list_weightchunks -- 0XCA5E0702:VisitWeight=
s lib.granny.loader.lua:417:cGrannyFile.chunkHandlers[0XCA5E0702]
+			=

+			-- weights : =

+			pLoaderSubMesh.mBoneNameCache =3D {}
+			function pLoaderSubMesh:GetBoneName (iBoneID) -- used when creating bon=
e weights
+				local cache =3D self.mBoneNameCache[iBoneID]
+				if (cache ~=3D nil) then return cache end
+				local iObjPtr =3D self.mBoneTies2[iBoneID]
+				cache =3D iObjPtr and self:GetBoneName2(iObjPtr - 1) or ""
+				self.mBoneNameCache[iBoneID] =3D cache
+				return cache
+			end
+			function pLoaderSubMesh:GetBoneName2 (iObjPtr) -- used by GetBoneName()=
 and when creating anim    (pAnim.mpAnim.iID-1)
+				local iObj =3D self.mBoneTies1[iObjPtr] if (not iObj) then return "" e=
nd
+				iObj =3D iObj - 1 =

+				local mainparam =3D mMainParams[iObj] if (not mainparam) then return "=
" end
+				local sName =3D mainparam["__ObjectName"] or ""
+				if (self:IsMasterBoneName(sName)) then return self:GetUnifiedMasterBon=
eName() end
+				return sName
+			end
+			function pLoaderSubMesh:GetUnifiedMasterBoneName () return "unified_gra=
nny_master_bone_name" end
+			function pLoaderSubMesh:IsMasterBoneName (sName) return string.find(sNa=
me,"master") or string.find(sName,"mesh") end
+			=

+			if (1 =3D=3D 1) then =

+				function MyZeroBased (arr) local res =3D {} for k,v in ipairs(arr) do =
res[k-1] =3D v end return res end
+				pLoaderSubMesh.mTextChunks =3D {{},Object.textChunk.texts}  -- first :=
 probaly copyright text chunk in other header
+				=

+				-- Object.textChunk.texts
+				--~ print("textChunk:",SmartDump(Object.textChunk))    -- 0xca5e0200
+				--~ for k,text in pairs(Object.textChunk.texts) do print(" text:",k,Sm=
artDump(text)) end
+				=

+				local objlist =3D {}
+				for k,obj in ipairs(Object.object_list.childs) do
+					local keys =3D {}
+					assert(obj.unknown_a =3D=3D 1)
+					assert(obj.unknown_b =3D=3D 1)
+					local myobj =3D keys
+					table.insert(objlist,myobj)
+					for k2,key in ipairs(obj.object_key_list.childs) do
+						local values =3D key.object_value_list.childs
+						assert(#values =3D=3D 1)
+						assert(values[1].unknown_a =3D=3D 0)
+						keys[key.key] =3D values[1].unknown_b
+						assert(not values[2])
+						--~ for k3,value in ipairs(values) do
+							--~ print("key:",k,key.key,value.unknown_b,Object.textChunk.texts[v=
alue.unknown_b])
+						--~ end
+					end
+					--~ print("----")
+				end
+				pLoaderSubMesh.mParamGroups =3D objlist
+			end
+			=

+			-- main params are in mParamGroups and mTextChunks[2]
+			if (1 =3D=3D 1) then
+				assert(pLoaderSubMesh.mTextChunks) -- std::vector<std::vector<std::str=
ing> >	0xCA5E0200	VisitTextChunk
+				assert(pLoaderSubMesh.mParamGroups) -- vector<vector<pair<uint32,uint3=
2> > >	0XCA5E0F00.0XCA5E0F01.0XCA5E0F02
+				local self =3D pLoaderSubMesh
+				local mParamGroups =3D pLoaderSubMesh.mParamGroups
+				local mMainParams =3D {}
+				local mTextChunks =3D self.mTextChunks
+				local mTextChunksB =3D mTextChunks[2]
+				self.mMainParams =3D mMainParams
+				if (mTextChunksB) then
+					for objidx,keys in ipairs(mParamGroups) do =

+						mMainParams[objidx-1] =3D {}
+						for i_key,i_val in pairs(keys) do =

+							local key		=3D mTextChunksB[i_key]
+							local val		=3D mTextChunksB[i_val]
+							if (key and val) then =

+								mMainParams[objidx-1][key] =3D string.lower(val) =

+							end
+							--~ print("mMainParams["..(objidx-1).."]:"..i_key.."=3D"..tostring(=
key).."=3D"..i_val.."=3D"..tostring(val))
+						end
+					end
+				end
+			end
+			=

+			if (pLoaderSubMesh.mWeights and #pLoaderSubMesh.mWeights > 0) then
+				function MyIterGranny (node,callback,path) =

+					path =3D (path or "root") .. "." .. tostring(cGrannyFile.kTypeNames[n=
ode.iChunkType or ""])
+					local res =3D callback(node,path)
+					if (res) then return res end
+					for k,subnode in ipairs(node.childs or {}) do =

+						local res =3D MyIterGranny(subnode,callback,path)
+						if (res) then return res end
+					end
+				end
+				--~ 0xca5e0c02	MyIterGranny    root.Object.boneTies2.boneties_containe=
r.bone_objptrs_container.bone_objptr.bone_objptrs        {iChildren=3D0,iNu=
m=3D37=3D0x25,BoneTies2=3Dtable: 0x9bab008,iChunkType=3D0xca5e0c02,iOffset=
=3D34572=3D0x870c,}
+				--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChi=
ldren=3D0,iID=3D6,iChunkType=3D0xca5e0f04,iOffset=3D9992=3D0x2708,}
+				--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChi=
ldren=3D0,iID=3D2,iChunkType=3D0xca5e0f04,iOffset=3D9996=3D0x270c,}
+				--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_containe=
r.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bon=
etie=3Dtable: 0xa0f98a0,iChunkType=3D0xca5e0c0a,iOffset=3D34724=3D0x87a4,}
+				--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_containe=
r.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bon=
etie=3Dtable: 0xa3bb478,iChunkType=3D0xca5e0c0a,iOffset=3D34756=3D0x87c4,}
+				--~ MyIterGranny(Object,function (node,path) if (node.iChunkType =3D=
=3D 0XCA5E0C02) then print("MyIterGranny",path,SmartDump(node)) end end)
+			=

+				pLoaderSubMesh.mBoneTies2 =3D Object.boneTies2.boneties_container.bone=
_objptrs_container.bone_objptr.bone_objptrs.BoneTies2 -- 0xca5e0c02  only o=
ne hit
+				local mBoneTies1 =3D {}
+				pLoaderSubMesh.mBoneTies1 =3D mBoneTies1
+				for k,child in ipairs(Object.boneTies1.childs) do =

+					assert(#child.childs =3D=3D 1)
+					assert(child.childs[1].iID)
+					--~ print("0xca5e0f04",SmartDump())      =

+					local id =3D child.childs[1].iID
+					table.insert(mBoneTies1,id)
+				end =

+				local bone_tie_list =3D Object.boneTies2.boneties_container.bonetie_co=
ntainer.bonetie_group.bonetie_list.childs
+				local mBoneTies =3D {}
+				pLoaderSubMesh.mBoneTies =3D mBoneTies
+				for k,child in ipairs(bone_tie_list) do =

+					assert(child.bonetie)
+					assert(child.bonetie.iBone)
+					table.insert(mBoneTies,child.bonetie)
+				end
+				=

+				assert(pLoaderSubMesh.mBoneTies1)		-- std::vector<uint32>								mBone=
Ties1; // 0xCA5E0f04 && bRootParent_BoneTies	VisitBoneTieID	"id", parent=3D=
[0xCA5E0b01] =3D "boneTies1" -- bone_name_list ?
+				assert(pLoaderSubMesh.mBoneTies2)		-- std::vector<uint32>								mBone=
Ties2; // 0XCA5E0C02 && bRootParent_BoneTies2	VisitBoneTies2 (boneObjPtrs?)=
	"bone_objptrs" parent=3D0XCA5E0C01=3DboneTies2
+				assert(pLoaderSubMesh.mBoneTies)		-- std::vector<const GrannyBoneTie*>=
				mBoneTies;  // 0xCA5E0c0a && bRootParent_BoneTies2	VisitBoneTie							"=
bonetie"
+				assert(pLoaderSubMesh.mMainParams)		-- std::map<int,std::map<std::stri=
ng,std::string> >	VisitEOF
+				print("checkpoint one reached")
+			end
+			os.exit(0)
 		end
 	end
 	local szMatName =3D matname



From no-reply at zwischenwelt.org  Fri Mar 26 19:45:30 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 26 Mar 2010 18:45:30 -0000
Subject: [Iris-commit] [IRIS] r3306 - in /trunk: lua/lib.granny.anim.lua
 lua/lib.granny.debug.lua plugins/loot.lua
Message-ID: <20100326184530.CAF9B7A98067@simon>

Author: ghoulsblade
Date: Fri Mar 26 19:45:30 2010
New Revision: 3306

Log:
lua granny loader : bone assignment active

Modified:
    trunk/lua/lib.granny.anim.lua
    trunk/lua/lib.granny.debug.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.granny.anim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.anim.lua (original)
+++ trunk/lua/lib.granny.anim.lua Fri Mar 26 19:45:30 2010
@@ -234,12 +234,14 @@
 --~ std::map<int,int>	mWeightBoneIndexMap ---< caches WeightBoneIndex2Ogre=
BoneHandle results
 =

 function cSubMeshConstructor:Init	(pGrannyLoader,mpMesh,mpSkeleton,szMatNa=
me,miTargetSubMesh)
-	self.mpGrannyLoader		=3D pGrannyLoader
-	self.mpMesh				=3D mpMesh
-	self.mpSkeleton			=3D mpSkeleton
-	self.msMatName			=3D szMatName
-	self.miCurrentSubMesh	=3D 0
-	self.miTargetSubMesh	=3D miTargetSubMesh
+	self.mpGrannyLoader			=3D pGrannyLoader
+	self.mpMesh					=3D mpMesh
+	self.mpSkeleton				=3D mpSkeleton
+	self.msMatName				=3D szMatName
+	self.miCurrentSubMesh		=3D 0
+	self.miTargetSubMesh		=3D miTargetSubMesh
+	self.mWeightBoneIndexMap	=3D {}
+	assert(self.mpGrannyLoader.mBoneTies)
 end
 	=

 --- translate weightindex to bone index using info from 0xCA5E0c0a (only i=
n models, not in anims)
@@ -399,7 +401,7 @@
 							-- assign vertices to skeleton bones
 							if (iOgreBoneHandle >=3D 0) then
 								-- NOTE ! iOgreBoneHandle might refer to the animtrack handle inst=
ead of the bone handle, so best keep both equal
-								sub:addBoneAssignment(iCurComboVertex,iOgreBoneHandle,w)
+								sub:addBoneAssignment(comboi,iOgreBoneHandle,w)
 							end
 						end
 					end
@@ -487,7 +489,7 @@
 	pMesh:_setBoundingSphereRadius(0)
 =

 	=

-	print("granny.anim:LoadGrannyAsOgreMesh:bHasBoneWeights=3D",bHasBoneWeigh=
ts)
+	print("granny.anim:LoadGrannyAsOgreMesh:bHasBoneWeights=3D",bHasBoneWeigh=
ts,szSkeletonName)
 	local pSkeleton -- Ogre::SkeletonPtr
 	-- assign skeleton only if there are BoneWeights
 	if (bHasBoneWeights) then

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Fri Mar 26 19:45:30 2010
@@ -165,6 +165,7 @@
 		local Object =3D grn.pMainChunk.Object
 		local mSubMeshes =3D {}
 		pGrannyLoader.mSubMeshes =3D mSubMeshes
+		local bHasBoneWeights
 		for kMeshIndex,mesh in ipairs(Object.mesh_list.childs or {}) do
 			local pLoaderSubMesh =3D {}
 			table.insert(mSubMeshes,pLoaderSubMesh)
@@ -206,9 +207,14 @@
 			pLoaderSubMesh.mNormals =3D normals
 			pLoaderSubMesh.mWeights =3D list_weightchunks -- 0XCA5E0702:VisitWeight=
s lib.granny.loader.lua:417:cGrannyFile.chunkHandlers[0XCA5E0702]
 			=

-			-- weights : =

-			pLoaderSubMesh.mBoneNameCache =3D {}
-			function pLoaderSubMesh:GetBoneName (iBoneID) -- used when creating bon=
e weights
+			if (pLoaderSubMesh.mWeights and #pLoaderSubMesh.mWeights > 0) then bHas=
BoneWeights =3D true end
+		end
+		=

+		=

+		-- granny wide bone infos
+		if (bHasBoneWeights) then =

+			pGrannyLoader.mBoneNameCache =3D {}
+			function pGrannyLoader:GetBoneName (iBoneID) -- used when creating bone=
 weights
 				local cache =3D self.mBoneNameCache[iBoneID]
 				if (cache ~=3D nil) then return cache end
 				local iObjPtr =3D self.mBoneTies2[iBoneID]
@@ -216,120 +222,131 @@
 				self.mBoneNameCache[iBoneID] =3D cache
 				return cache
 			end
-			function pLoaderSubMesh:GetBoneName2 (iObjPtr) -- used by GetBoneName()=
 and when creating anim    (pAnim.mpAnim.iID-1)
+			function pGrannyLoader:GetBoneName2 (iObjPtr) -- used by GetBoneName() =
and when creating anim    (pAnim.mpAnim.iID-1)
 				local iObj =3D self.mBoneTies1[iObjPtr] if (not iObj) then return "" e=
nd
 				iObj =3D iObj - 1 =

-				local mainparam =3D mMainParams[iObj] if (not mainparam) then return "=
" end
+				local mainparam =3D self.mMainParams[iObj] if (not mainparam) then ret=
urn "" end
 				local sName =3D mainparam["__ObjectName"] or ""
 				if (self:IsMasterBoneName(sName)) then return self:GetUnifiedMasterBon=
eName() end
 				return sName
 			end
-			function pLoaderSubMesh:GetUnifiedMasterBoneName () return "unified_gra=
nny_master_bone_name" end
-			function pLoaderSubMesh:IsMasterBoneName (sName) return string.find(sNa=
me,"master") or string.find(sName,"mesh") end
-			=

-			if (1 =3D=3D 1) then =

-				function MyZeroBased (arr) local res =3D {} for k,v in ipairs(arr) do =
res[k-1] =3D v end return res end
-				pLoaderSubMesh.mTextChunks =3D {{},Object.textChunk.texts}  -- first :=
 probaly copyright text chunk in other header
+			function pGrannyLoader:GetUnifiedMasterBoneName () return "unified_gran=
ny_master_bone_name" end
+			function pGrannyLoader:IsMasterBoneName (sName) return string.find(sNam=
e,"master") or string.find(sName,"mesh") end
+			=

+			=

+	=

+			--~ function MyZeroBased (arr) local res =3D {} for k,v in ipairs(arr) =
do res[k-1] =3D v end return res end
+			pGrannyLoader.mTextChunks =3D {{},Object.textChunk.texts}  -- first : p=
robaly copyright text chunk in other header
+			=

+			-- Object.textChunk.texts
+			--~ print("textChunk:",SmartDump(Object.textChunk))    -- 0xca5e0200
+			--~ for k,text in pairs(Object.textChunk.texts) do print(" text:",k,Sma=
rtDump(text)) end
+			=

+			local objlist =3D {}
+			for k,obj in ipairs(Object.object_list.childs) do
+				local keys =3D {}
+				assert(obj.unknown_a =3D=3D 1)
+				assert(obj.unknown_b =3D=3D 1)
+				local myobj =3D keys
+				table.insert(objlist,myobj)
+				for k2,key in ipairs(obj.object_key_list.childs) do
+					local values =3D key.object_value_list.childs
+					assert(#values =3D=3D 1)
+					assert(values[1].unknown_a =3D=3D 0)
+					keys[key.key] =3D values[1].unknown_b
+					assert(not values[2])
+					--~ for k3,value in ipairs(values) do
+						--~ print("key:",k,key.key,value.unknown_b,Object.textChunk.texts[va=
lue.unknown_b])
+					--~ end
+				end
+				--~ print("----")
+			end
+			pGrannyLoader.mParamGroups =3D objlist
 				=

-				-- Object.textChunk.texts
-				--~ print("textChunk:",SmartDump(Object.textChunk))    -- 0xca5e0200
-				--~ for k,text in pairs(Object.textChunk.texts) do print(" text:",k,Sm=
artDump(text)) end
 				=

-				local objlist =3D {}
-				for k,obj in ipairs(Object.object_list.childs) do
-					local keys =3D {}
-					assert(obj.unknown_a =3D=3D 1)
-					assert(obj.unknown_b =3D=3D 1)
-					local myobj =3D keys
-					table.insert(objlist,myobj)
-					for k2,key in ipairs(obj.object_key_list.childs) do
-						local values =3D key.object_value_list.childs
-						assert(#values =3D=3D 1)
-						assert(values[1].unknown_a =3D=3D 0)
-						keys[key.key] =3D values[1].unknown_b
-						assert(not values[2])
-						--~ for k3,value in ipairs(values) do
-							--~ print("key:",k,key.key,value.unknown_b,Object.textChunk.texts[v=
alue.unknown_b])
-						--~ end
-					end
-					--~ print("----")
-				end
-				pLoaderSubMesh.mParamGroups =3D objlist
-			end
-			=

 			-- main params are in mParamGroups and mTextChunks[2]
-			if (1 =3D=3D 1) then
-				assert(pLoaderSubMesh.mTextChunks) -- std::vector<std::vector<std::str=
ing> >	0xCA5E0200	VisitTextChunk
-				assert(pLoaderSubMesh.mParamGroups) -- vector<vector<pair<uint32,uint3=
2> > >	0XCA5E0F00.0XCA5E0F01.0XCA5E0F02
-				local self =3D pLoaderSubMesh
-				local mParamGroups =3D pLoaderSubMesh.mParamGroups
-				local mMainParams =3D {}
-				local mTextChunks =3D self.mTextChunks
-				local mTextChunksB =3D mTextChunks[2]
-				self.mMainParams =3D mMainParams
-				if (mTextChunksB) then
-					for objidx,keys in ipairs(mParamGroups) do =

-						mMainParams[objidx-1] =3D {}
-						for i_key,i_val in pairs(keys) do =

-							local key		=3D mTextChunksB[i_key]
-							local val		=3D mTextChunksB[i_val]
-							if (key and val) then =

-								mMainParams[objidx-1][key] =3D string.lower(val) =

-							end
-							--~ print("mMainParams["..(objidx-1).."]:"..i_key.."=3D"..tostring(=
key).."=3D"..i_val.."=3D"..tostring(val))
+			assert(pGrannyLoader.mTextChunks) -- std::vector<std::vector<std::strin=
g> >	0xCA5E0200	VisitTextChunk
+			assert(pGrannyLoader.mParamGroups) -- vector<vector<pair<uint32,uint32>=
 > >	0XCA5E0F00.0XCA5E0F01.0XCA5E0F02
+			local self =3D pGrannyLoader
+			local mParamGroups =3D pGrannyLoader.mParamGroups
+			local mMainParams =3D {}
+			local mTextChunks =3D self.mTextChunks
+			local mTextChunksB =3D mTextChunks[2]
+			self.mMainParams =3D mMainParams
+			if (mTextChunksB) then
+				for objidx,keys in ipairs(mParamGroups) do =

+					mMainParams[objidx-1] =3D {}
+					for i_key,i_val in pairs(keys) do =

+						local key		=3D mTextChunksB[i_key]
+						local val		=3D mTextChunksB[i_val]
+						if (key and val) then =

+							mMainParams[objidx-1][key] =3D string.lower(val) =

 						end
+						--~ print("mMainParams["..(objidx-1).."]:"..i_key.."=3D"..tostring(k=
ey).."=3D"..i_val.."=3D"..tostring(val))
 					end
 				end
 			end
-			=

-			if (pLoaderSubMesh.mWeights and #pLoaderSubMesh.mWeights > 0) then
-				function MyIterGranny (node,callback,path) =

-					path =3D (path or "root") .. "." .. tostring(cGrannyFile.kTypeNames[n=
ode.iChunkType or ""])
-					local res =3D callback(node,path)
-					if (res) then return res end
-					for k,subnode in ipairs(node.childs or {}) do =

-						local res =3D MyIterGranny(subnode,callback,path)
-						if (res) then return res end
-					end
-				end
-				--~ 0xca5e0c02	MyIterGranny    root.Object.boneTies2.boneties_containe=
r.bone_objptrs_container.bone_objptr.bone_objptrs        {iChildren=3D0,iNu=
m=3D37=3D0x25,BoneTies2=3Dtable: 0x9bab008,iChunkType=3D0xca5e0c02,iOffset=
=3D34572=3D0x870c,}
-				--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChi=
ldren=3D0,iID=3D6,iChunkType=3D0xca5e0f04,iOffset=3D9992=3D0x2708,}
-				--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChi=
ldren=3D0,iID=3D2,iChunkType=3D0xca5e0f04,iOffset=3D9996=3D0x270c,}
-				--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_containe=
r.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bon=
etie=3Dtable: 0xa0f98a0,iChunkType=3D0xca5e0c0a,iOffset=3D34724=3D0x87a4,}
-				--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_containe=
r.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bon=
etie=3Dtable: 0xa3bb478,iChunkType=3D0xca5e0c0a,iOffset=3D34756=3D0x87c4,}
-				--~ MyIterGranny(Object,function (node,path) if (node.iChunkType =3D=
=3D 0XCA5E0C02) then print("MyIterGranny",path,SmartDump(node)) end end)
-			=

-				pLoaderSubMesh.mBoneTies2 =3D Object.boneTies2.boneties_container.bone=
_objptrs_container.bone_objptr.bone_objptrs.BoneTies2 -- 0xca5e0c02  only o=
ne hit
-				local mBoneTies1 =3D {}
-				pLoaderSubMesh.mBoneTies1 =3D mBoneTies1
-				for k,child in ipairs(Object.boneTies1.childs) do =

-					assert(#child.childs =3D=3D 1)
-					assert(child.childs[1].iID)
-					--~ print("0xca5e0f04",SmartDump())      =

-					local id =3D child.childs[1].iID
-					table.insert(mBoneTies1,id)
-				end =

-				local bone_tie_list =3D Object.boneTies2.boneties_container.bonetie_co=
ntainer.bonetie_group.bonetie_list.childs
-				local mBoneTies =3D {}
-				pLoaderSubMesh.mBoneTies =3D mBoneTies
-				for k,child in ipairs(bone_tie_list) do =

-					assert(child.bonetie)
-					assert(child.bonetie.iBone)
-					table.insert(mBoneTies,child.bonetie)
-				end
 				=

-				assert(pLoaderSubMesh.mBoneTies1)		-- std::vector<uint32>								mBone=
Ties1; // 0xCA5E0f04 && bRootParent_BoneTies	VisitBoneTieID	"id", parent=3D=
[0xCA5E0b01] =3D "boneTies1" -- bone_name_list ?
-				assert(pLoaderSubMesh.mBoneTies2)		-- std::vector<uint32>								mBone=
Ties2; // 0XCA5E0C02 && bRootParent_BoneTies2	VisitBoneTies2 (boneObjPtrs?)=
	"bone_objptrs" parent=3D0XCA5E0C01=3DboneTies2
-				assert(pLoaderSubMesh.mBoneTies)		-- std::vector<const GrannyBoneTie*>=
				mBoneTies;  // 0xCA5E0c0a && bRootParent_BoneTies2	VisitBoneTie							"=
bonetie"
-				assert(pLoaderSubMesh.mMainParams)		-- std::map<int,std::map<std::stri=
ng,std::string> >	VisitEOF
-				print("checkpoint one reached")
+			--~ function MyIterGranny (node,callback,path) =

+				--~ path =3D (path or "root") .. "." .. tostring(cGrannyFile.kTypeName=
s[node.iChunkType or ""])
+				--~ local res =3D callback(node,path)
+				--~ if (res) then return res end
+				--~ for k,subnode in ipairs(node.childs or {}) do =

+					--~ local res =3D MyIterGranny(subnode,callback,path)
+					--~ if (res) then return res end
+				--~ end
+			--~ end
+			--~ 0xca5e0c02	MyIterGranny    root.Object.boneTies2.boneties_container=
.bone_objptrs_container.bone_objptr.bone_objptrs        {iChildren=3D0,iNum=
=3D37=3D0x25,BoneTies2=3Dtable: 0x9bab008,iChunkType=3D0xca5e0c02,iOffset=
=3D34572=3D0x870c,}
+			--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChil=
dren=3D0,iID=3D6,iChunkType=3D0xca5e0f04,iOffset=3D9992=3D0x2708,}
+			--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChil=
dren=3D0,iID=3D2,iChunkType=3D0xca5e0f04,iOffset=3D9996=3D0x270c,}
+			--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_container=
.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bone=
tie=3Dtable: 0xa0f98a0,iChunkType=3D0xca5e0c0a,iOffset=3D34724=3D0x87a4,}
+			--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_container=
.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bone=
tie=3Dtable: 0xa3bb478,iChunkType=3D0xca5e0c0a,iOffset=3D34756=3D0x87c4,}
+			--~ MyIterGranny(Object,function (node,path) if (node.iChunkType =3D=3D=
 0XCA5E0C02) then print("MyIterGranny",path,SmartDump(node)) end end)
+		=

+			pGrannyLoader.mBoneTies2 =3D Object.boneTies2.boneties_container.bone_o=
bjptrs_container.bone_objptr.bone_objptrs.BoneTies2 -- 0xca5e0c02  only one=
 hit
+			local mBoneTies1 =3D {}
+			pGrannyLoader.mBoneTies1 =3D mBoneTies1
+			for k,child in ipairs(Object.boneTies1.childs) do =

+				assert(#child.childs =3D=3D 1)
+				assert(child.childs[1].iID)
+				--~ print("0xca5e0f04",SmartDump())      =

+				local id =3D child.childs[1].iID
+				table.insert(mBoneTies1,id)
+			end =

+			local bone_tie_list =3D Object.boneTies2.boneties_container.bonetie_con=
tainer.bonetie_group.bonetie_list.childs
+			local mBoneTies =3D {}
+			pGrannyLoader.mBoneTies =3D mBoneTies
+			for k,child in ipairs(bone_tie_list) do =

+				assert(child.bonetie)
+				assert(child.bonetie.iBone)
+				table.insert(mBoneTies,child.bonetie)
 			end
-			os.exit(0)
+			=

+			assert(pGrannyLoader.mBoneTies1)		-- std::vector<uint32>								mBoneTi=
es1; // 0xCA5E0f04 && bRootParent_BoneTies	VisitBoneTieID	"id", parent=3D[0=
xCA5E0b01] =3D "boneTies1" -- bone_name_list ?
+			assert(pGrannyLoader.mBoneTies2)		-- std::vector<uint32>								mBoneTi=
es2; // 0XCA5E0C02 && bRootParent_BoneTies2	VisitBoneTies2 (boneObjPtrs?)	"=
bone_objptrs" parent=3D0XCA5E0C01=3DboneTies2
+			assert(pGrannyLoader.mBoneTies)		-- std::vector<const GrannyBoneTie*>		=
		mBoneTies;  // 0xCA5E0c0a && bRootParent_BoneTies2	VisitBoneTie							"bo=
netie"
+			assert(pGrannyLoader.mMainParams)		-- std::map<int,std::map<std::string=
,std::string> >	VisitEOF
+			--~ print("checkpoint one reached")
 		end
 	end
 	local szMatName =3D matname
 	local szMeshName =3D "MyGrannyTest_Mesh_123"
-	local szSkeletonName =3D "MyGrannyTest_Skel_123"
+	--~ local szSkeletonName =3D "MyGrannyTest_Skel_123"
+	--~ local szSkeletonName2 =3D CreateSkeleton(szSkeletonName)
+	--~ assert(szSkeletonName =3D=3D szSkeletonName2)
+	=

+	=

+	=

+	local bodyid =3D artid
+    local skeleton =3D GetOrCreateSkeleton(bodyid) -- skeleton is determin=
ed by the bodyid, not possible from the wearables
+	if (not skeleton) then return end
+    local skeleton_name =3D skeleton and skeleton.name or "unknown_skeleto=
n"
+	local szSkeletonName =3D skeleton_name
+	=

+	=

+	=

+	assert(pGrannyLoader.mBoneTies)
+	=

 	local res =3D LoadGrannyAsOgreMesh(pGrannyLoader,szMatName,szMeshName,szS=
keletonName)
 	=

 	-- create instance

Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Fri Mar 26 19:45:30 2010
@@ -221,6 +221,7 @@
 	local tooltip =3D AosToolTip_GetText(item.serial,true) --- todo : GetItem=
TooltipOrLabel
 	if (not tooltip) then return end
 	tooltip =3D string.lower(tooltip)
+	if (string.find(tooltip,"%d+ nox crystal")) then return false end
 	for k,v in pairs(gLootPluginWantedWords) do =

 		if string.find(tooltip,v) then print("LOOT : loot because",v) return tru=
e end =

 	end



From no-reply at zwischenwelt.org  Fri Mar 26 21:42:56 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 26 Mar 2010 20:42:56 -0000
Subject: [Iris-commit] [IRIS] r3307 - in /trunk: lua/lib.bodygfx.lua
 lua/lib.granny.debug.lua plugins/moblist.lua scripts/luabindheader.lua
Message-ID: <20100326204256.66DC47A98067@simon>

Author: ghoulsblade
Date: Fri Mar 26 21:42:56 2010
New Revision: 3307

Log:
first anim played for lua-loaded granny, bone assignments still off by one =
or so, luadbind for AnimationState, c++ recompile needed

Modified:
    trunk/lua/lib.bodygfx.lua
    trunk/lua/lib.granny.debug.lua
    trunk/plugins/moblist.lua
    trunk/scripts/luabindheader.lua

Modified: trunk/lua/lib.bodygfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bodygfx.lua (original)
+++ trunk/lua/lib.bodygfx.lua Fri Mar 26 21:42:56 2010
@@ -197,7 +197,7 @@
     end
     self.groupgfx:SetPosition(0,0,mount and kMountZAdd[bodyid] or 0)
     =

-    self:PartsSetAnim()
+    self:PartsSetAnim() -- todo : update returned animlen ? self.bla_animl=
en =3D result ?
 end
 =

 =


Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Fri Mar 26 21:42:56 2010
@@ -357,6 +357,26 @@
 	local gfx =3D CreateRootGfx3D()
 	local scenenode =3D gfx:GetSceneNode()
 	scenenode:attachObject(entity)
+	=

+	=

+	local curanimid =3D 1
+    local animname =3D GetAnimName(bodyid,curanimid)
+	local bLoop =3D true
+	local mpAnimState
+	if (animname) then
+		mpAnimState =3D entity:getAnimationState(animname)
+		assert(mpAnimState)
+		mpAnimState:setEnabled(true)
+		mpAnimState:setLoop(bLoop)
+	end
+	=

+--~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:700:void	cGfx3D::SetAnim=
	(const char* szAnimName,const bool bLoop) {
+--~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:721:void	cGfx3D::SetAnim=
TimePos	(const Real fTimeInSeconds) { if (mpAnimState) mpAnimState->setTime=
Position(fTimeInSeconds); }
+	RegisterStepper(function () =

+		local fTimeInSeconds =3D math.mod(gMyTicks/1000,10) =

+		--~ print("debug.granny.animstep",animname,fTimeInSeconds)
+		mpAnimState:setTimePosition(fTimeInSeconds)
+	end)
 end
 =

 function cDebugGrannyMenu:MakeNewGranny_OldDump (artid)

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Fri Mar 26 21:42:56 2010
@@ -532,7 +532,7 @@
 -- ***** ***** ***** ***** ***** rest
 =

 function MobListGetMainTargetSerial() return gMobList and gMobList.maintar=
get_serial end
-function MobListSetMainTargetSerial(serial) gMobList:SetMainTarget(serial)=
 end
-		=

-
-end
+function MobListSetMainTargetSerial(serial) if (gMobList) then gMobList:Se=
tMainTarget(serial) end end
+		=

+
+end

Modified: trunk/scripts/luabindheader.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/scripts/luabindheader.lua (original)
+++ trunk/scripts/luabindheader.lua Fri Mar 26 21:42:56 2010
@@ -31,6 +31,7 @@
 							{basepath.."OgreEntity.h"				,"Entity"				,{"MovableObject"}},
 							{basepath.."OgreAnimationTrack.h"		,"AnimationTrack"		,{}},
 							{basepath.."OgreAnimationTrack.h"		,"NodeAnimationTrack"	,{"Animati=
onTrack"}},
+							{basepath.."OgreAnimationState.h"		,"AnimationState"		,{}},
 							=

 							{basepath.."OgreKeyFrame.h"				,"KeyFrame"				,{}},
 							{basepath.."OgreKeyFrame.h"				,"NumericKeyFrame"		,{"KeyFrame"}},



From no-reply at zwischenwelt.org  Sat Mar 27 00:14:46 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 26 Mar 2010 23:14:46 -0000
Subject: [Iris-commit] [IRIS] r3308 - /trunk/lua/lib.granny.debug.lua
Message-ID: <20100326231446.6346C7A98067@simon>

Author: ghoulsblade
Date: Sat Mar 27 00:14:44 2010
New Revision: 3308

Log:
granny lua loader anim : displayed next to old loader for debugging. boneas=
sign debug utils

Modified:
    trunk/lua/lib.granny.debug.lua

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Sat Mar 27 00:14:44 2010
@@ -56,8 +56,10 @@
 	=

 	local modelid =3D 791 -- giant_beetle
 	local modelid =3D 200 -- standard horse
-	--~ self:MakeOldGranny(modelid)
-	self:MakeNewGranny(modelid)
+	local animid =3D 1
+	gGrannyAnimEnabled =3D true
+	self:MakeOldGranny(modelid,animid)
+	self:MakeNewGranny(modelid,animid)
 	=

 	print("")
 	=

@@ -66,7 +68,7 @@
 =

 =

 	=

-function cDebugGrannyMenu:MakeOldGranny (artid) =

+function cDebugGrannyMenu:MakeOldGranny (artid,animid) =

 	local mobile =3D {artid=3Dartid}
 	local gfx =3D CreateRootGfx3D()
 	local body =3D CreateBodyGfx(gfx)
@@ -79,8 +81,9 @@
 	--~ if (gDebugMenuAnimIndex =3D=3D -2) then bMoving,bRunFlag            =
=3D true,true,true end
 	--~ if (gDebugMenuAnimIndex =3D=3D -3) then bWarMode,bMoving            =
=3D true,true,true end
 	--~ if (gDebugMenuAnimIndex =3D=3D -4) then bWarMode,bMoving,bRunFlag   =
=3D true,true,true end
-	body:SetState(bMoving,bTurning,bWarMode,bRunFlag)
-	gfx:SetPosition(0,2,0)
+	--~ body:SetState(bMoving,bTurning,bWarMode,bRunFlag)
+	gfx:SetPosition(1,0,0)
+	if (animid) then body:StartAnimLoop(animid) end
 	=

 	--~ if (gDebugMenuAnimIndex >=3D 0) then body:StartAnimLoop(gDebugMenuAni=
mIndex) end
 	--~ body:StartAnimLoop(1)
@@ -151,7 +154,7 @@
 										"Giant_Beetle_Run.grn",
 									}
 =

-function cDebugGrannyMenu:MakeNewGranny (artid)
+function cDebugGrannyMenu:MakeNewGranny (artid,animid)
 	artid =3D 200 -- horse
 	local folder =3D "/cavern/uoml_freshinstall.4.x/Models/Animals/"
 	local matname =3D GetGrannyMat(artid,0,GetGrannyModelLoader(artid))
@@ -359,24 +362,41 @@
 	scenenode:attachObject(entity)
 	=

 	=

-	local curanimid =3D 1
-    local animname =3D GetAnimName(bodyid,curanimid)
-	local bLoop =3D true
-	local mpAnimState
-	if (animname) then
-		mpAnimState =3D entity:getAnimationState(animname)
-		assert(mpAnimState)
-		mpAnimState:setEnabled(true)
-		mpAnimState:setLoop(bLoop)
-	end
-	=

---~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:700:void	cGfx3D::SetAnim=
	(const char* szAnimName,const bool bLoop) {
---~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:721:void	cGfx3D::SetAnim=
TimePos	(const Real fTimeInSeconds) { if (mpAnimState) mpAnimState->setTime=
Position(fTimeInSeconds); }
-	RegisterStepper(function () =

-		local fTimeInSeconds =3D math.mod(gMyTicks/1000,10) =

-		--~ print("debug.granny.animstep",animname,fTimeInSeconds)
-		mpAnimState:setTimePosition(fTimeInSeconds)
-	end)
+	if (animid) then =

+		--~ entity:setDisplaySkeleton(true)
+		local animname =3D GetAnimName(bodyid,animid)
+		local bLoop =3D true
+		local mpAnimState
+		if (animname) then
+			assert(entity.getAnimationState,"getAnimationState luabind missing: rec=
ompile required (26.03.2010)")
+			mpAnimState =3D entity:getAnimationState(animname)
+			assert(mpAnimState)
+			mpAnimState:setEnabled(true)
+			mpAnimState:setLoop(bLoop)
+		end
+			=

+		if (1 =3D=3D 1) then =

+			local pMesh =3D entity:getMesh()
+			local list =3D pMesh:enumBoneAssignment()
+			print("enumBoneAssignment",list,list and #list,"#"..sMeshName.."#","#".=
.pMesh:getName().."#")
+			for k,entry in ipairs(list) do print("boneAssignment",k,unpack(entry)) =
end
+			local iNumSubMeshes =3D pMesh:getNumSubMeshes()
+			for iSubMeshIdx =3D 0,iNumSubMeshes-1 do =

+				local sub =3D pMesh:getSubMesh(iSubMeshIdx)
+				local list =3D sub:enumBoneAssignment()
+				print("sub.enumBoneAssignment",list,list and #list)
+				for k,entry in ipairs(list) do print("sub["..iSubMeshIdx.."].boneAssig=
nment",k,unpack(entry)) end
+			end
+		end
+		=

+	--~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:700:void	cGfx3D::SetAni=
m	(const char* szAnimName,const bool bLoop) {
+	--~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:721:void	cGfx3D::SetAni=
mTimePos	(const Real fTimeInSeconds) { if (mpAnimState) mpAnimState->setTim=
ePosition(fTimeInSeconds); }
+		RegisterStepper(function () =

+			local fTimeInSeconds =3D math.mod(gMyTicks/1000,10) =

+			--~ print("debug.granny.animstep",animname,fTimeInSeconds)
+			mpAnimState:setTimePosition(fTimeInSeconds)
+		end)
+	end
 end
 =

 function cDebugGrannyMenu:MakeNewGranny_OldDump (artid)



From no-reply at zwischenwelt.org  Sat Mar 27 12:33:01 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 27 Mar 2010 11:33:01 -0000
Subject: [Iris-commit] [IRIS] r3309 - in /trunk: include/grannyparser.h
 lua/lib.granny.anim.lua lua/lib.granny.debug.lua src/granny_L.cpp
Message-ID: <20100327113302.0AD5154D0007@simon>

Author: ghoulsblade
Date: Sat Mar 27 12:33:00 2010
New Revision: 3309

Log:
lua granny loader : anim working with old skeleton loader, bugfix in granny=
 c++ code: signed type

Modified:
    trunk/include/grannyparser.h
    trunk/lua/lib.granny.anim.lua
    trunk/lua/lib.granny.debug.lua
    trunk/src/granny_L.cpp

Modified: trunk/include/grannyparser.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/grannyparser.h (original)
+++ trunk/include/grannyparser.h Sat Mar 27 12:33:00 2010
@@ -90,7 +90,7 @@
 } STRUCT_PACKED;
 =

 struct GrannyBoneTie {
-	uint32	iBone;
+	int32	iBone;
 	=

 	/// this might be initial position, translate:3f quaternion:4f =

 	/// but doesn't look like floats in uo/Models/Others/H_Female_LLegs_V2_LO=
D2.grn

Modified: trunk/lua/lib.granny.anim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.anim.lua (original)
+++ trunk/lua/lib.granny.anim.lua Sat Mar 27 12:33:00 2010
@@ -245,10 +245,7 @@
 end
 	=

 --- translate weightindex to bone index using info from 0xCA5E0c0a (only i=
n models, not in anims)
-function cSubMeshConstructor:WeightBoneIndex2GrannyBoneID		(iWeightBoneInd=
ex)
-	local o =3D self.mpGrannyLoader.mBoneTies[iWeightBoneIndex]
-	return o and o.iBone or -1
-end
+function cSubMeshConstructor:WeightBoneIndex2GrannyBoneID		(iWeightBoneInd=
ex) return self.mpGrannyLoader:WeightBoneIndex2GrannyBoneID(iWeightBoneInde=
x) end
 	=

 --- converts a boneindex from the granny vertex weights to an ogre bone in=
dex in the skeleton
 --- returns -1 if not found

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Sat Mar 27 12:33:00 2010
@@ -85,6 +85,8 @@
 	gfx:SetPosition(1,0,0)
 	if (animid) then body:StartAnimLoop(animid) end
 	=

+	gsOldGrannyMeshName =3D body.modelparts[1]:GetEntity():getMesh():getName()
+	=

 	--~ if (gDebugMenuAnimIndex >=3D 0) then body:StartAnimLoop(gDebugMenuAni=
mIndex) end
 	--~ body:StartAnimLoop(1)
 	=

@@ -217,16 +219,26 @@
 		-- granny wide bone infos
 		if (bHasBoneWeights) then =

 			pGrannyLoader.mBoneNameCache =3D {}
+			function pGrannyLoader:WeightBoneIndex2GrannyBoneID (iWeightBoneIndex)
+				local o =3D self.mBoneTies[iWeightBoneIndex+1]
+				return o and o.iBone or -1
+			end
+			function pGrannyLoader:FindBone (sName)
+				local sSearchName =3D self:IsMasterBoneName(sName) and self:GetUnified=
MasterBoneName() or sName
+				local imax =3D #self.mBoneTies2+1
+				for i =3D 0,imax do if (self:GetBoneName(i) =3D=3D sSearchName) then r=
eturn i end end
+				return -1
+			end
 			function pGrannyLoader:GetBoneName (iBoneID) -- used when creating bone=
 weights
 				local cache =3D self.mBoneNameCache[iBoneID]
 				if (cache ~=3D nil) then return cache end
-				local iObjPtr =3D self.mBoneTies2[iBoneID]
+				local iObjPtr =3D self.mBoneTies2[iBoneID+1]
 				cache =3D iObjPtr and self:GetBoneName2(iObjPtr - 1) or ""
 				self.mBoneNameCache[iBoneID] =3D cache
 				return cache
 			end
 			function pGrannyLoader:GetBoneName2 (iObjPtr) -- used by GetBoneName() =
and when creating anim    (pAnim.mpAnim.iID-1)
-				local iObj =3D self.mBoneTies1[iObjPtr] if (not iObj) then return "" e=
nd
+				local iObj =3D self.mBoneTies1[iObjPtr+1] if (not iObj) then return ""=
 end
 				iObj =3D iObj - 1 =

 				local mainparam =3D self.mMainParams[iObj] if (not mainparam) then ret=
urn "" end
 				local sName =3D mainparam["__ObjectName"] or ""
@@ -376,17 +388,47 @@
 		end
 			=

 		if (1 =3D=3D 1) then =

+			local pMesh2 =3D gsOldGrannyMeshName and MeshManager_load(gsOldGrannyMe=
shName)
 			local pMesh =3D entity:getMesh()
 			local list =3D pMesh:enumBoneAssignment()
 			print("enumBoneAssignment",list,list and #list,"#"..sMeshName.."#","#".=
.pMesh:getName().."#")
 			for k,entry in ipairs(list) do print("boneAssignment",k,unpack(entry)) =
end
 			local iNumSubMeshes =3D pMesh:getNumSubMeshes()
+			local skel1 =3D pMesh:getSkeleton()
+			local skel2 =3D pMesh2 and pMesh2:getSkeleton()
 			for iSubMeshIdx =3D 0,iNumSubMeshes-1 do =

 				local sub =3D pMesh:getSubMesh(iSubMeshIdx)
-				local list =3D sub:enumBoneAssignment()
+				local sub2 =3D pMesh2 and pMesh2:getSubMesh(iSubMeshIdx)
+				local list =3D sub:enumBoneAssignment() -- key,vertexIndex,boneIndex,w=
eight
+				local list2 =3D sub2 and sub2:enumBoneAssignment()
 				print("sub.enumBoneAssignment",list,list and #list)
-				for k,entry in ipairs(list) do print("sub["..iSubMeshIdx.."].boneAssig=
nment",k,unpack(entry)) end
+				for k,e in ipairs(list) do =

+					local f =3D list2 and list2[k] or {} =

+					local keyA,vertexIndexA,boneIndexA,weightA =3D unpack(e) local pBone =
=3D skel1:getBone(boneIndexA) local boneName1 =3D pBone and pBone:getName()=
 local bh1 =3D pBone and pBone:getHandle()
+					local keyB,vertexIndexB,boneIndexB,weightB =3D unpack(f) local pBone =
=3D skel2:getBone(boneIndexB) local boneName2 =3D pBone and pBone:getName()=
 local bh2 =3D pBone and pBone:getHandle()
+					print("sub["..iSubMeshIdx.."].boneAssignmentA",k,keyA,vertexIndexA,bo=
neIndexA,weightA,boneName1,bh1)
+					print("sub["..iSubMeshIdx.."].boneAssignmentB",k,keyB,vertexIndexB,bo=
neIndexB,weightB,boneName2,bh2)
+					if (k>=3D 30) then break end
+				end
+				=

+				-- problem mit boneindex. abfolge lua : =

+				--[[
+				local pi =3D poly.iVertex[i] + 1
+				local myBoneWeightList =3D myBoneWeights[pi] -- tMyBoneWeightList     =
   TODO : see how myBoneWeights is built
+				for i,itor in ipairs(myBoneWeightList) do =

+							local	iWeightBoneIndex 	=3D itor[1]
+							local	iOgreBoneHandle 	=3D self:WeightBoneIndex2OgreBoneHandle(iWei=
ghtBoneIndex)
+								local iBoneID =3D self:WeightBoneIndex2GrannyBoneID(iWeightBoneInd=
ex)   	self.mpGrannyLoader.mBoneTies[iWeightBoneIndex].iBone
+								local sName =3D self.mpGrannyLoader:GetBoneName(iBoneID)					mpSke=
leton:SearchBoneByName(sName)
+					idea : output bonenames from skeleton of old loader , bruteforce id->=
name from new loader (show list helps with off-by-one)
+				]]--
+				=

 			end
+			=

+			local oldgrn =3D GetGrannyModelLoader(bodyid)
+			for iBoneID=3D0,40 do local a,b =3D pGrannyLoader:GetBoneName(iBoneID),=
oldgrn:GetBoneName(iBoneID)   print("iBoneID->name",iBoneID,a,b) assert(a=
=3D=3Db) end
+			for iObjPtr=3D0,40 do local a,b =3D pGrannyLoader:GetBoneName2(iObjPtr)=
,oldgrn:GetBoneName2(iObjPtr) print("iObjPtr->name",iObjPtr,a,b) assert(a=
=3D=3Db) end
+			for wid=3D0,40 do local a,b =3D pGrannyLoader:WeightBoneIndex2GrannyBon=
eID(wid),oldgrn:WeightBoneIndex2GrannyBoneID(wid) print("wid->gbid",wid,hex=
(a),hex(b)) assert(a=3D=3Db) end
 		end
 		=

 	--~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:700:void	cGfx3D::SetAni=
m	(const char* szAnimName,const bool bLoop) {

Modified: trunk/src/granny_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/granny_L.cpp (original)
+++ trunk/src/granny_L.cpp Sat Mar 27 12:33:00 2010
@@ -1,5 +1,6 @@
 #include "lugre_prefix.h"
 #include "lugre_luabind.h"
+#include "lugre_luabind_direct.h"
 #include "grannyparser.h"
 #include "grannyloader_i2.h"
 #include "grannyogreloader.h"
@@ -23,7 +24,7 @@
 =

 =

 =

-class cGrannyLoader_i2_L : public cLuaBind<cGrannyLoader_i2> { public:
+class cGrannyLoader_i2_L : public cLuaBind<cGrannyLoader_i2>, cLuaBindDire=
ctQuickWrapHelper { public:
 	// implementation of cLuaBind
 =

 		/// called by Register(), registers object-methods (see cLuaBind constru=
ctor for examples)
@@ -31,6 +32,15 @@
 			lua_register(L,"LoadGranny",			&cGrannyLoader_i2_L::LoadGranny);
 			lua_register(L,"CreateSkeleton",		&cGrannyLoader_i2_L::CreateSkeleton);=
 // TODO : destroy, own class like material
 			lua_register(L,"SkeletonHasAnimation",	&cGrannyLoader_i2_L::SkeletonHas=
Animation);
+			=

+			LUABIND_QUICKWRAP(	GetBoneName,					{ return PushString(L,checkudata_al=
ive(L)->GetBoneName(ParamInt(L,2)) ); });
+			LUABIND_QUICKWRAP(	GetBoneName2,					{ return PushString(L,checkudata_a=
live(L)->GetBoneName2(ParamInt(L,2)) ); });
+			LUABIND_QUICKWRAP(	WeightBoneIndex2GrannyBoneID,	{ =

+					int iWeightBoneIndex =3D ParamInt(L,2);
+					return PushNumber(L, (iWeightBoneIndex >=3D 0 && iWeightBoneIndex < c=
heckudata_alive(L)->mBoneTies.size()) ? checkudata_alive(L)->mBoneTies[iWei=
ghtBoneIndex]->iBone : -1 );
+				});
+			=

+			=

 			=

 			#define REGISTER_METHOD(methodname) mlMethod.push_back(make_luaL_reg(#m=
ethodname,&cGrannyLoader_i2_L::methodname));
 			REGISTER_METHOD(Destroy);



From no-reply at zwischenwelt.org  Sat Mar 27 15:21:03 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 27 Mar 2010 14:21:03 -0000
Subject: [Iris-commit] [IRIS] r3310 - in /trunk/lua: lib.granny.anim.lua
	lib.granny.debug.lua
Message-ID: <20100327142103.18F7F54D0007@simon>

Author: ghoulsblade
Date: Sat Mar 27 15:21:02 2010
New Revision: 3310

Log:
preparations for granny skeleton loading

Modified:
    trunk/lua/lib.granny.anim.lua
    trunk/lua/lib.granny.debug.lua

Modified: trunk/lua/lib.granny.anim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.anim.lua (original)
+++ trunk/lua/lib.granny.anim.lua Sat Mar 27 15:21:02 2010
@@ -256,8 +256,8 @@
 	local iBoneID =3D self:WeightBoneIndex2GrannyBoneID(iWeightBoneIndex)
 	=

 	-- retrieves bone from skeleton (search by name)
-	local sName =3D self.mpGrannyLoader:GetBoneName(iBoneID)
-	local pBone =3D self.mpSkeleton:SearchBoneByName(sName)
+	local sName =3D (iBoneID >=3D 0) and self.mpGrannyLoader:GetBoneName(iBon=
eID)
+	local pBone =3D sName and self.mpSkeleton:SearchBoneByName(sName)
 	=

 	-- get ogre bone handle/index
 	local res =3D pBone and pBone:getHandle() or -1

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Sat Mar 27 15:21:02 2010
@@ -39,6 +39,7 @@
 	--~ PrintBrokenGrannyInfo   276                                Raptalon  =
   gMountGrannyOverride    105
 	--~ PrintBrokenGrannyInfo   179                 equines_horse_nightmare  =
   gMountGrannyOverride    200
 	--~ PrintBrokenGrannyInfo   115                  equines_horse_ethereal  =
   gMountGrannyOverride    200
+	--~ broken anim : 0x13a (boneties compare different, #texpoly <> #poly
 }
 =

 function StartDebugGrannyMenu () cDebugGrannyMenu:StartMenu() end
@@ -54,8 +55,11 @@
 	=

 	self:MakeGrid({0,0,0},{1,0,0},{0,1,0},5,5,true)
 	=

-	local modelid =3D 791 -- giant_beetle
+	--~ local modelid =3D 276 -- Raptalon
+	--~ local modelid =3D 257 -- DreadHorn
+	--~ local modelid =3D 791 -- giant_beetle
 	local modelid =3D 200 -- standard horse
+	--~ local modelid =3D 0x101
 	local animid =3D 1
 	gGrannyAnimEnabled =3D true
 	self:MakeOldGranny(modelid,animid)
@@ -156,16 +160,24 @@
 										"Giant_Beetle_Run.grn",
 									}
 =

+									=

+									=

+									=

 function cDebugGrannyMenu:MakeNewGranny (artid,animid)
-	artid =3D 200 -- horse
 	local folder =3D "/cavern/uoml_freshinstall.4.x/Models/Animals/"
-	local matname =3D GetGrannyMat(artid,0,GetGrannyModelLoader(artid))
-	local filepath =3D GetGrannyFilePath(artid)
-	local grn =3D cGrannyFile:New()
-	grn:LoadFile(filepath)
-	=

-	local pGrannyLoader =3D {}
-	if (1 =3D=3D 1) then
+	local old_GetGrannyModelLoader =3D GetGrannyModelLoader(artid)
+	local matname =3D old_GetGrannyModelLoader and GetGrannyMat(artid,0,old_G=
etGrannyModelLoader) or "grannybase"
+	=

+	function assert_warn (cond,msg) if (not cond) then print("assert_warn",ms=
g) end end
+	=

+	function LoadGrannyLua (artid)
+		local grn =3D cGrannyFile:New()
+		local filepath =3D GetGrannyFilePath(artid)
+		grn:LoadFile(filepath)
+		return WrapGrannyLoaderNew(grn)
+	end
+	function WrapGrannyLoaderNew (grn)
+		local pGrannyLoader =3D {}
 		-- wrap grn into pGrannyLoader
 		local Object =3D grn.pMainChunk.Object
 		local mSubMeshes =3D {}
@@ -201,7 +213,7 @@
 			=

             -- sanity checks
             if (texpolys) then =

-                assert(#polygons =3D=3D #texpolys)
+                assert_warn(#polygons =3D=3D #texpolys,"poly:texpoly:"..#p=
olygons.."<>"..#texpolys)
                 for k,texpoly in ipairs(texpolys) do assert(texpoly.iUnkno=
wn =3D=3D k-1) end
             end
 =

@@ -343,17 +355,71 @@
 			assert(pGrannyLoader.mMainParams)		-- std::map<int,std::map<std::string=
,std::string> >	VisitEOF
 			--~ print("checkpoint one reached")
 		end
-	end
+		return pGrannyLoader
+	end
+	=

+	local pGrannyLoader =3D LoadGrannyLua(artid)
 	local szMatName =3D matname
 	local szMeshName =3D "MyGrannyTest_Mesh_123"
 	--~ local szSkeletonName =3D "MyGrannyTest_Skel_123"
 	--~ local szSkeletonName2 =3D CreateSkeleton(szSkeletonName)
 	--~ assert(szSkeletonName =3D=3D szSkeletonName2)
 	=

+	function MyLoadGrannyAnim(bodyid,animid,skeleton,bodypartsamples)
+		-- load anim granny
+		local animname =3D GetAnimName(bodyid,animid) =

+		if (skeleton.anims[animname]) then return end -- already loaded
+		local animpath =3D GetAnimPath(bodyid,animid)
+		local mygrannyanim =3D LoadGranny(animpath)
+		if (not mygrannyanim) then =

+			print("ERROR LoadGrannyAnim",animpath,bodyid,animid,skeleton,bodypartsa=
mples)
+			return false
+		end
+		=

+		-- construct animation
+		printdebug("granny","LoadGrannyAnim",bodyid,animid,skeleton.name,animnam=
e,animpath)
+		mygrannyanim:AddAnimToSkeleton(skeleton.name,animname,bodypartsamples)
+		skeleton.anims[animname] =3D true
+	end
+	function MyGetOrCreateSkeleton(bodyid)
+		return GetOrCreateSkeleton(bodyid)
+		--~ local modelinfo =3D GetGrannyModelInfo(bodyid)
+		=

+		--~ if (not modelinfo) then GrannyShowNo3DDataError(bodyid) return end
+		--~ assert(modelinfo,"ERROR bodyinfo for skeleton not found "..tostring(=
bodyid))
+
+		--~ while (modelinfo.animid ~=3D 0) do modelinfo =3D GetGrannyModelInfo(=
modelinfo.animid) end
+		--~ local skeletonname =3D GetUniqueName() -- modelinfo.modelname -- exa=
mple: "deer_stag"
+		=

+		--~ CreateSkeleton(skeletonname)
+		--~ local skeleton =3D { name=3Dskeletonname, anims=3D{} }
+		=

+		--~ -- load sample bodyparts needed for animation (needed to assemble co=
rrect granny skeleton)
+		--~ local bodypartsamples =3D {}
+		--~ if (IsBodyIDHuman(bodyid)) then =

+			--~ if (IsBodyIDFemale(bodyid)) then
+				--~ -- human female body parts, often (bodyid =3D=3D 401)
+				--~ for k,v in pairs(kGrannyModelPartByNum) do table.insert(bodypartsa=
mples,LoadGrannyLua(k+kGrannyModelPartAddFemale)) end -- GetGrannyModelLoad=
er->LoadGrannyLua
+			--~ else
+				--~ -- human male body parts, often (bodyid =3D=3D 400)
+				--~ for k,v in pairs(kGrannyModelPartByNum) do table.insert(bodypartsa=
mples,LoadGrannyLua(k+kGrannyModelPartAddMale)) end -- GetGrannyModelLoader=
->LoadGrannyLua
+			--~ end
+		--~ else
+			--~ -- non-human model has komplete skeleton
+			--~ table.insert(bodypartsamples,LoadGrannyLua(bodyid)) -- GetGrannyMod=
elLoader->LoadGrannyLua
+		--~ end
+		=

+		--~ -- load all animations so all entities created afterwards have the f=
ull anim set
+		--~ for k,v in pairs(gAnimInfoLists[modelinfo.typeid]) do
+			--~ MyLoadGrannyAnim(bodyid,k,skeleton,bodypartsamples) =

+		--~ end
+	=

+		--~ return skeleton
+	end
 	=

 	=

 	local bodyid =3D artid
-    local skeleton =3D GetOrCreateSkeleton(bodyid) -- skeleton is determin=
ed by the bodyid, not possible from the wearables
+    local skeleton =3D MyGetOrCreateSkeleton(bodyid) -- skeleton is determ=
ined by the bodyid, not possible from the wearables
 	if (not skeleton) then return end
     local skeleton_name =3D skeleton and skeleton.name or "unknown_skeleto=
n"
 	local szSkeletonName =3D skeleton_name
@@ -402,33 +468,23 @@
 				local list =3D sub:enumBoneAssignment() -- key,vertexIndex,boneIndex,w=
eight
 				local list2 =3D sub2 and sub2:enumBoneAssignment()
 				print("sub.enumBoneAssignment",list,list and #list)
+				if (skel2) then =

 				for k,e in ipairs(list) do =

 					local f =3D list2 and list2[k] or {} =

 					local keyA,vertexIndexA,boneIndexA,weightA =3D unpack(e) local pBone =
=3D skel1:getBone(boneIndexA) local boneName1 =3D pBone and pBone:getName()=
 local bh1 =3D pBone and pBone:getHandle()
+
 					local keyB,vertexIndexB,boneIndexB,weightB =3D unpack(f) local pBone =
=3D skel2:getBone(boneIndexB) local boneName2 =3D pBone and pBone:getName()=
 local bh2 =3D pBone and pBone:getHandle()
 					print("sub["..iSubMeshIdx.."].boneAssignmentA",k,keyA,vertexIndexA,bo=
neIndexA,weightA,boneName1,bh1)
 					print("sub["..iSubMeshIdx.."].boneAssignmentB",k,keyB,vertexIndexB,bo=
neIndexB,weightB,boneName2,bh2)
 					if (k>=3D 30) then break end
 				end
-				=

-				-- problem mit boneindex. abfolge lua : =

-				--[[
-				local pi =3D poly.iVertex[i] + 1
-				local myBoneWeightList =3D myBoneWeights[pi] -- tMyBoneWeightList     =
   TODO : see how myBoneWeights is built
-				for i,itor in ipairs(myBoneWeightList) do =

-							local	iWeightBoneIndex 	=3D itor[1]
-							local	iOgreBoneHandle 	=3D self:WeightBoneIndex2OgreBoneHandle(iWei=
ghtBoneIndex)
-								local iBoneID =3D self:WeightBoneIndex2GrannyBoneID(iWeightBoneInd=
ex)   	self.mpGrannyLoader.mBoneTies[iWeightBoneIndex].iBone
-								local sName =3D self.mpGrannyLoader:GetBoneName(iBoneID)					mpSke=
leton:SearchBoneByName(sName)
-					idea : output bonenames from skeleton of old loader , bruteforce id->=
name from new loader (show list helps with off-by-one)
-				]]--
-				=

+				end
 			end
 			=

 			local oldgrn =3D GetGrannyModelLoader(bodyid)
-			for iBoneID=3D0,40 do local a,b =3D pGrannyLoader:GetBoneName(iBoneID),=
oldgrn:GetBoneName(iBoneID)   print("iBoneID->name",iBoneID,a,b) assert(a=
=3D=3Db) end
-			for iObjPtr=3D0,40 do local a,b =3D pGrannyLoader:GetBoneName2(iObjPtr)=
,oldgrn:GetBoneName2(iObjPtr) print("iObjPtr->name",iObjPtr,a,b) assert(a=
=3D=3Db) end
-			for wid=3D0,40 do local a,b =3D pGrannyLoader:WeightBoneIndex2GrannyBon=
eID(wid),oldgrn:WeightBoneIndex2GrannyBoneID(wid) print("wid->gbid",wid,hex=
(a),hex(b)) assert(a=3D=3Db) end
+			for iBoneID=3D0,40 do local a,b =3D pGrannyLoader:GetBoneName(iBoneID),=
oldgrn:GetBoneName(iBoneID)   print("iBoneID->name",iBoneID,a,b) assert_war=
n(a=3D=3Db) end
+			for iObjPtr=3D0,40 do local a,b =3D pGrannyLoader:GetBoneName2(iObjPtr)=
,oldgrn:GetBoneName2(iObjPtr) print("iObjPtr->name",iObjPtr,a,b) assert_war=
n(a=3D=3Db) end
+			for wid=3D0,40 do local a,b =3D pGrannyLoader:WeightBoneIndex2GrannyBon=
eID(wid),oldgrn:WeightBoneIndex2GrannyBoneID(wid) print("wid->gbid",wid,a,h=
ex(a),b,hex(b)) assert_warn(a=3D=3Db) end
 		end
 		=

 	--~ /cavern/code/iris/mylugre/src/lugre_gfx3D.cpp:700:void	cGfx3D::SetAni=
m	(const char* szAnimName,const bool bLoop) {



From no-reply at zwischenwelt.org  Sun Mar 28 21:20:55 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 28 Mar 2010 19:20:55 -0000
Subject: [Iris-commit] [IRIS] r3311 - /trunk/bin/iris2.exe
Message-ID: <20100328192055.CA8197A98179@simon>

Author: sience
Date: Sun Mar 28 21:20:54 2010
New Revision: 3311

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Mar 28 23:39:51 2010
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 28 Mar 2010 21:39:51 -0000
Subject: [Iris-commit] [IRIS] r3312 - in /trunk/lua: lib.granny.anim.lua
 lib.granny.debug.lua lib.thread.lua
Message-ID: <20100328213952.6BBB97A980A7@simon>

Author: ghoulsblade
Date: Sun Mar 28 23:39:51 2010
New Revision: 3312

Log:
worked on granny lua loader : anim skeleton, not quite finished

Modified:
    trunk/lua/lib.granny.anim.lua
    trunk/lua/lib.granny.debug.lua
    trunk/lua/lib.thread.lua

Modified: trunk/lua/lib.granny.anim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.anim.lua (original)
+++ trunk/lua/lib.granny.anim.lua Sun Mar 28 23:39:51 2010
@@ -210,13 +210,13 @@
 end
 =

 function	GetBoneDerivedRotation	(mpGrannyLoader,iBoneID)
-	local pGrannyBone =3D mpGrannyLoader.mBones[iBoneID]
+	local pGrannyBone =3D mpGrannyLoader.mBones[iBoneID+1]
 	if ((not pGrannyBone) or (pGrannyBone.iParent =3D=3D iBoneID)) then retur=
n GetBoneRotate(pGrannyBone) end
 	return QuatMult(GetBoneDerivedRotation(mpGrannyLoader,pGrannyBone.iParent=
),GetBoneRotate(pGrannyBone))
 end
 =

 function	GetBoneDerivedTranslate	(mpGrannyLoader,iBoneID)
-	local pGrannyBone =3D mpGrannyLoader.mBones[iBoneID]
+	local pGrannyBone =3D mpGrannyLoader.mBones[iBoneID+1]
 	if ((not pGrannyBone) or (pGrannyBone.iParent =3D=3D iBoneID)) then retur=
n GetBoneTranslate(pGrannyBone) end
 	return VectAdd(GetBoneDerivedTranslate(mpGrannyLoader,pGrannyBone.iParent=
),QuadVectMult(GetBoneDerivedRotation(mpGrannyLoader,pGrannyBone.iParent),G=
etBoneTranslate(pGrannyBone)))
 end
@@ -517,7 +517,7 @@
 function cAnimationTotalTimeConstructor:Init (mfTotalTime)
 	self.mfTotalTime =3D mfTotalTime
 end
-function cAnimationTotalTimeConstructor:Exectute (pAnim) -- cGrannyLoader_=
i2::cAnim
+function cAnimationTotalTimeConstructor:Execute (pAnim) -- cGrannyLoader_i=
2::cAnim
 	if (self.mfTotalTime < pAnim.mfTotalTime) then
 		self.mfTotalTime =3D pAnim.mfTotalTime
 	end
@@ -537,7 +537,7 @@
 function cAnimationConstructor:Init (pGrannyLoader,mpSkeleton,mpAnim,mlBod=
ySamples)
 	self.mpGrannyLoader			=3D pGrannyLoader
 	self.mpSkeleton				=3D mpSkeleton
-	self.mpAnim					=3D mpAnim
+	self.mpAnim					=3D mpAnim -- Ogre::Animation*
 	self.mlBodySamples			=3D mlBodySamples
 	self.miAnimDataCounter		=3D 0
 	self.miCurrentSubMesh		=3D 0
@@ -547,7 +547,7 @@
 function cAnimationConstructor:GetSampleBone	(sBoneName) -- returns Granny=
Bone
 	for k,sample in ipairs(self.mlBodySamples) do =

 		local iBoneID =3D sample:FindBone(sBoneName)
-		local bone =3D sample.mBones[iBoneID]
+		local bone =3D sample.mBones[iBoneID+1]
 		if (bone) then return bone end
 	end
 end
@@ -556,7 +556,7 @@
 			=

 	--- recursive : creates parent hierarchy if needed
 function cAnimationConstructor:GetOrCreateBone	(iBoneID) -- returns Ogre::=
Bone*
-	if (iBoneID < 0 or iBoneID >=3D self.mpGrannyLoader.mBones:size()) then r=
eturn 0 end
+	if (iBoneID < 0 or iBoneID >=3D #self.mpGrannyLoader.mBones) then return =
0 end  -- TODO:LUA SIZE WRONG ??? =

 	local sName =3D self.mpGrannyLoader:GetBoneName(iBoneID)
 	if (sName =3D=3D "") then
 		print("warning, unnamed bone id=3D%d\n",iBoneID)
@@ -569,7 +569,7 @@
 	=

 	-- create bone
 	pBone =3D self.mpSkeleton:createBone(sName)
-	local pGrannyBone =3D self.mpGrannyLoader.mBones[iBoneID] -- const Granny=
Bone*
+	local pGrannyBone =3D self.mpGrannyLoader.mBones[iBoneID+1] -- const Gran=
nyBone*
 	=

 	-- child bone : attach to parent
 	local iParent =3D pGrannyBone.iParent
@@ -614,14 +614,14 @@
 	if (iTransformSpaceModeR =3D=3D 2) then iTransformSpaceR =3D TS_WORLD end
 	=

 	if (iBoneStartMode =3D=3D 1) then
-		if (iRotateFirst ~=3D 0) then pBone:rotate(q,iTransformSpaceR) end
+		if (iRotateFirst ~=3D 0) then pBone:rotate2(q,iTransformSpaceR) end
 		pBone:translate(v,iTransformSpaceT)
-		if (iRotateFirst =3D=3D 0) then pBone:rotate(q,iTransformSpaceR) end
+		if (iRotateFirst =3D=3D 0) then pBone:rotate2(q,iTransformSpaceR) end
 	end
 	if (iBoneStartMode =3D=3D 2) then
-		if (iRotateFirst ~=3D 0) then pBone:rotate(Quaternion_Inverse(q),iTransf=
ormSpaceR) end
+		if (iRotateFirst ~=3D 0) then pBone:rotate2(Quaternion_Inverse(q),iTrans=
formSpaceR) end
 		pBone:translate(Vector_Invert(v),iTransformSpaceT)
-		if (iRotateFirst =3D=3D 0) then pBone:rotate(Quaternion_Inverse(q),iTran=
sformSpaceR) end
+		if (iRotateFirst =3D=3D 0) then pBone:rotate2(Quaternion_Inverse(q),iTra=
nsformSpaceR) end
 	end
 	-- granny rotation is often (   0.000,   0.000,   0.000,   1.000) , so pr=
obably x,y,z,w
 	-- void Ogre::Bone::setScale  	(   	const Vector3 &   	 scale  	 )
@@ -654,7 +654,7 @@
 		pTrack =3D self.mpAnim:createNodeTrack(iOgreBoneHandle,pBone)
 	end
 	=

-	local pGrannyBone =3D self.mpGrannyLoader.mBones[iCurBoneNum] -- const Gr=
annyBone*
+	local pGrannyBone =3D self.mpGrannyLoader.mBones[iCurBoneNum+1] -- const =
GrannyBone*
 	assert(pGrannyBone)
 	local pOrigGrannyBone =3D pGrannyBone -- const GrannyBone*
 	local pSampleBone =3D self:GetSampleBone(pBone:getName()) -- const Granny=
Bone*
@@ -721,15 +721,17 @@
 		-- calc rotation at fCurTime
 		local qo =3D Make_Ogre_Quaternion_IDENTITY() -- Ogre::Quaternion
 		if (pAnim.mpAnim.iNumQuaternion > 0) then
+			local i
 			for k,fTestTime in ipairs(pAnim.mpQuaternionTime) do -- pAnim.mpAnim.iN=
umQuaternion
+				i =3D k
 				if (fTestTime >=3D fCurTime) then break end
 				fBeforeTime =3D fTestTime
 			end
-			if (bDebugHack_OnlyFirst) then i =3D 0 end
-			if (i >=3D pAnim.mpAnim.iNumQuaternion) then
+			if (bDebugHack_OnlyFirst) then i =3D 1 end
+			if (i > pAnim.mpAnim.iNumQuaternion) then
 				-- after last frame
 				qo =3D GrannyToOgreQ(pAnim.mpQuaternion[pAnim.mpAnim.iNumQuaternion-1+=
1])
-			elseif (i =3D=3D 0 or fTestTime =3D=3D fCurTime) then
+			elseif (i =3D=3D 1 or fTestTime =3D=3D fCurTime) then
 				-- before first frame or exact time-match frame
 				qo =3D GrannyToOgreQ(pAnim.mpQuaternion[i+1])
 				--printf(" bone=3D%02d t=3D%5.3f q=3D(x=3D%f y=3D%f z=3D%f w=3D%f)\n",=
iCurBoneNum,fCurTime,q.x,q.y,q.z,q.w)
@@ -743,15 +745,17 @@
 		-- calc translation at fCurTime
 		local vt0 =3D Make_Ogre_Vector3_ZERO()
 		if (pAnim.mpAnim.iNumTranslate > 0) then
+			local i
 			for k,fTestTime in ipairs(pAnim.mpTranslateTime) do -- pAnim.mpAnim.iNu=
mTranslate
+				i =3D k
 				if (fTestTime >=3D fCurTime) then break end
 				fBeforeTime =3D fTestTime
 			end
-			if (bDebugHack_OnlyFirst) then i =3D 0 end
-			if (i >=3D pAnim.mpAnim.iNumTranslate) then
+			if (bDebugHack_OnlyFirst) then i =3D 1 end
+			if (i > pAnim.mpAnim.iNumTranslate) then
 				-- after last frame
 				vt0 =3D GrannyToOgreV(pAnim.mpTranslate[pAnim.mpAnim.iNumTranslate-1+1=
])
-			elseif (i =3D=3D 0 or fTestTime =3D=3D fCurTime) then
+			elseif (i =3D=3D 1 or fTestTime =3D=3D fCurTime) then
 				-- before first frame or exact time-match frame
 				vt0 =3D GrannyToOgreV(pAnim.mpTranslate[i+1])
 			else
@@ -813,14 +817,14 @@
 	-- calc total time
 	local fTotalTime =3D 0
 	local o =3D cAnimationTotalTimeConstructor:New(fTotalTime)
-	for k,anim in ipairs(pGrannyLoader.mAnims) do o:Exectute(anim) end
+	for k,anim in ipairs(pGrannyLoader.mAnims) do o:Execute(anim) end
 	fTotalTime =3D o.mfTotalTime
 	--printf("LoadGrannyAsOgreAnim name=3D%s total_bone_anims=3D%d totaltime=
=3D%f samplebodyparts=3D%d\n",szAnimName,pGrannyLoader.mAnims.size(),fTotal=
Time,lBodySamples.size())
-	local pAnim =3D pSkeleton:createAnimation(szAnimName,fTotalTime) -- in se=
conds	    Ogre::Animation*
+	local pOgreAnim =3D pSkeleton:createAnimation(szAnimName,fTotalTime) -- i=
n seconds	    Ogre::Animation*
 	=

 	-- construct anims
-	local o =3D cAnimationConstructor:New(pGrannyLoader,pSkeleton,pAnim,lBody=
Samples)
-	for k,anim in ipairs(pGrannyLoader.mAnims) do o:Exectute(anim) end
+	local o =3D cAnimationConstructor:New(pGrannyLoader,pSkeleton,pOgreAnim,l=
BodySamples)
+	for k,anim in ipairs(pGrannyLoader.mAnims) do o:Execute(anim) end
 	--	pSkeleton.load()
 	=

 	--Ogre::Skeleton::BoneIterator itor =3D pSkeleton.getBoneIterator()

Modified: trunk/lua/lib.granny.debug.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.debug.lua (original)
+++ trunk/lua/lib.granny.debug.lua Sun Mar 28 23:39:51 2010
@@ -160,9 +160,17 @@
 										"Giant_Beetle_Run.grn",
 									}
 =

-									=

-									=

-									=

+
+function MyIterGranny (node,callback,path) =

+	path =3D (path or "root") .. "." .. tostring(cGrannyFile.kTypeNames[node.=
iChunkType or ""])
+	local res =3D callback(node,path)
+	if (res) then return res end
+	for k,subnode in ipairs(node.childs or {}) do =

+		local res =3D MyIterGranny(subnode,callback,path)
+		if (res) then return res end
+	end
+end
+
 function cDebugGrannyMenu:MakeNewGranny (artid,animid)
 	local folder =3D "/cavern/uoml_freshinstall.4.x/Models/Animals/"
 	local old_GetGrannyModelLoader =3D GetGrannyModelLoader(artid)
@@ -170,9 +178,9 @@
 	=

 	function assert_warn (cond,msg) if (not cond) then print("assert_warn",ms=
g) end end
 	=

-	function LoadGrannyLua (artid)
+	function LoadGrannyLua (artid) return LoadGrannyLua_ByFilePath(GetGrannyF=
ilePath(artid)) end
+	function LoadGrannyLua_ByFilePath (filepath)
 		local grn =3D cGrannyFile:New()
-		local filepath =3D GetGrannyFilePath(artid)
 		grn:LoadFile(filepath)
 		return WrapGrannyLoaderNew(grn)
 	end
@@ -229,7 +237,7 @@
 		=

 		=

 		-- granny wide bone infos
-		if (bHasBoneWeights) then =

+		if (true) then =

 			pGrannyLoader.mBoneNameCache =3D {}
 			function pGrannyLoader:WeightBoneIndex2GrannyBoneID (iWeightBoneIndex)
 				local o =3D self.mBoneTies[iWeightBoneIndex+1]
@@ -314,21 +322,12 @@
 				end
 			end
 				=

-			--~ function MyIterGranny (node,callback,path) =

-				--~ path =3D (path or "root") .. "." .. tostring(cGrannyFile.kTypeName=
s[node.iChunkType or ""])
-				--~ local res =3D callback(node,path)
-				--~ if (res) then return res end
-				--~ for k,subnode in ipairs(node.childs or {}) do =

-					--~ local res =3D MyIterGranny(subnode,callback,path)
-					--~ if (res) then return res end
-				--~ end
-			--~ end
 			--~ 0xca5e0c02	MyIterGranny    root.Object.boneTies2.boneties_container=
.bone_objptrs_container.bone_objptr.bone_objptrs        {iChildren=3D0,iNum=
=3D37=3D0x25,BoneTies2=3Dtable: 0x9bab008,iChunkType=3D0xca5e0c02,iOffset=
=3D34572=3D0x870c,}
 			--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChil=
dren=3D0,iID=3D6,iChunkType=3D0xca5e0f04,iOffset=3D9992=3D0x2708,}
 			--~ 0xca5e0f04	MyIterGranny    Object.boneTies1.boneobject.id    {iChil=
dren=3D0,iID=3D2,iChunkType=3D0xca5e0f04,iOffset=3D9996=3D0x270c,}
 			--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_container=
.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bone=
tie=3Dtable: 0xa0f98a0,iChunkType=3D0xca5e0c0a,iOffset=3D34724=3D0x87a4,}
 			--~ 0xca5e0c0a	MyIterGranny    root.Object.boneTies2.boneties_container=
.bonetie_container.bonetie_group.bonetie_list.bonetie   {iChildren=3D0,bone=
tie=3Dtable: 0xa3bb478,iChunkType=3D0xca5e0c0a,iOffset=3D34756=3D0x87c4,}
-			--~ MyIterGranny(Object,function (node,path) if (node.iChunkType =3D=3D=
 0XCA5E0C02) then print("MyIterGranny",path,SmartDump(node)) end end)
+			--~ MyIterGranny(Object,function (node,path) if (node.iChunkType =3D=3D=
 0XCA5E1204) then print("MyIterGranny",path,SmartDump(node)) end end)
 		=

 			pGrannyLoader.mBoneTies2 =3D Object.boneTies2.boneties_container.bone_o=
bjptrs_container.bone_objptr.bone_objptrs.BoneTies2 -- 0xca5e0c02  only one=
 hit
 			local mBoneTies1 =3D {}
@@ -340,13 +339,16 @@
 				local id =3D child.childs[1].iID
 				table.insert(mBoneTies1,id)
 			end =

-			local bone_tie_list =3D Object.boneTies2.boneties_container.bonetie_con=
tainer.bonetie_group.bonetie_list.childs
+			local bonetie_group =3D Object.boneTies2.boneties_container.bonetie_con=
tainer.bonetie_group
 			local mBoneTies =3D {}
 			pGrannyLoader.mBoneTies =3D mBoneTies
-			for k,child in ipairs(bone_tie_list) do =

-				assert(child.bonetie)
-				assert(child.bonetie.iBone)
-				table.insert(mBoneTies,child.bonetie)
+			if (bonetie_group) then =

+				local bone_tie_list =3D bonetie_group.bonetie_list.childs
+				for k,child in ipairs(bone_tie_list) do =

+					assert(child.bonetie)
+					assert(child.bonetie.iBone)
+					table.insert(mBoneTies,child.bonetie)
+				end
 			end
 			=

 			assert(pGrannyLoader.mBoneTies1)		-- std::vector<uint32>								mBoneTi=
es1; // 0xCA5E0f04 && bRootParent_BoneTies	VisitBoneTieID	"id", parent=3D[0=
xCA5E0b01] =3D "boneTies1" -- bone_name_list ?
@@ -354,6 +356,97 @@
 			assert(pGrannyLoader.mBoneTies)		-- std::vector<const GrannyBoneTie*>		=
		mBoneTies;  // 0xCA5E0c0a && bRootParent_BoneTies2	VisitBoneTie							"bo=
netie"
 			assert(pGrannyLoader.mMainParams)		-- std::map<int,std::map<std::string=
,std::string> >	VisitEOF
 			--~ print("checkpoint one reached")
+		end
+		=

+		--~ local animbase =3D Object.animation_list.animation_sublist.animation=
        =

+		--~ MyIterGranny    root.Object.animation_list.animation_sublist.animati=
on.animdata {fTotalTime=3D0.616667,pScaleTime=3Dtable: 0x9e42720,pQuaternio=
nTime=3Dtable: 0x9e42080,hexdump=3Dtable: 0x9e44af0,iOffset=3D29560=3D0x737=
8,iChildren=3D0,pQuaternion=3Dtable: 0x9e42bf8,pAnim=3Dtable: 0x9e421a8,pRe=
st=3Dtable: 0x9e44b18,pTranslateTime=3Dtable: 0x9e42450,pScale=3Dtable: 0x9=
e43990,iChunkType=3D0xca5e1204,pTranslate=3Dtable: 0x9e42748,}
+
+		if (Object.animation_list.animation_sublist.animation.animdata) then -- =
granny with animation tracks         =

+			--~ pGrannyLoader.mAnims =3D {} -- VisitGrannyAnim 0XCA5E1204
+			--~ for (
+			local mAnims =3D {}
+			pGrannyLoader.mAnims =3D mAnims
+			for k,grnanim in ipairs(Object.animation_list.animation_sublist.animati=
on.childs) do =

+				local pAnim =3D {}
+				table.insert(mAnims,pAnim)
+				pAnim.mfTotalTime	=3D grnanim.fTotalTime
+				pAnim.mpAnim		=3D grnanim.pAnim
+				--~ print("pAnim.mpAnim",SmartDump(pAnim.mpAnim))
+				pAnim.mpQuaternionTime	=3D grnanim.pQuaternionTime
+				pAnim.mpQuaternion		=3D grnanim.pQuaternion
+				pAnim.mpTranslateTime	=3D grnanim.pTranslateTime
+				pAnim.mpTranslate		=3D grnanim.pTranslate
+				=

+				--~ print("pAnim.mpQuaternionTime",SmartDump(pAnim.mpQuaternionTime))
+				--~ print("pAnim.mpQuaternion",SmartDump(pAnim.mpQuaternion))
+				=

+				assert(pAnim.mpAnim.iNumTranslate)
+				assert(pAnim.mpAnim.iNumQuaternion)
+				assert(pAnim.mpAnim.iID)
+				assert(ipairs(pAnim.mpQuaternionTime))
+				assert(ipairs(pAnim.mpTranslateTime))
+				assert(pAnim.mpQuaternion)
+				assert(pAnim.mpTranslate)
+				     =

+				--[[
+				{
+				fTotalTime=3D0.616667
+				pAnim=3Dtable: 0xb308660
+				=

+				pQuaternionTime=3Dtable: 0xb308558
+				pQuaternion=3Dtable: 0xb308f60
+				=

+				pTranslateTime=3Dtable: 0xb308908
+				pTranslate=3Dtable: 0xb308ab0
+				=

+				pScaleTime=3Dtable: 0xb308a50
+				pScale=3Dtable: 0xb308968
+				=

+				pRest=3Dtable: 0xb309900
+				iChunkType=3D0xca5e1204
+				}
+				]]--
+			end
+			--~ MyIterGranny(Object,function (node,path) if (node.iChunkType =3D=3D=
 0XCA5E1204) then print("MyIterGranny",path,SmartDump(node)) end end)
+			--~ print("anim:boom")
+			--~ os.exit(0)
+			--~ assert(pGrannyLoader.mAnims) -- GrannyAnim*
+			--~ assert(pGrannyLoader.mBones) -- GrannyBone*
+		end
+		=

+		if (Object.bones.skeleton.bonelist) then	   =

+			local mBones =3D {}
+			pGrannyLoader.mBones =3D mBones
+			for k,grnbone in ipairs(Object.bones.skeleton.bonelist.childs) do
+				-- grnbone {iChildren=3D0,bone=3Dtable: 0x8fc8830,iChunkType=3D0xca5e0=
506,iOffset=3D32020=3D0x7d14,}
+				table.insert(mBones,grnbone.bone)    =

+				--~ print("pGrannyBone",SmartDump(grnbone.bone,2)) -- {fTranslate=3Dta=
ble: 0x9f664a0,fQuaternion=3Dtable: 0x9f66568,fMatrix=3Dtable: 0x9f65358,iP=
arent=3D0,}
+			end
+			--~ MyIterGranny(Object,function (node,path) if (node.iChunkType =3D=3D=
 0XCA5E0506) then print("MyIterGranny",path,SmartDump(node)) end end)
+			=

+			print("TODO!!!!!!!!!! lib.granny.anim.lua:196: attempt to index field '=
data' (a nil value)")
+			--[[     =

+				error running function `Main': ../lua/lib.granny.anim.lua:196: attempt=
 to index field 'data' (a nil value)
+				LuaStackTrace:
+
+						../lua/lib.granny.anim.lua:196: in function `GrannyToOgreQ'
+						../lua/lib.granny.anim.lua:736: in function `Execute'
+						../lua/lib.granny.anim.lua:827: in function `LoadGrannyAsOgreAnim'
+						../lua/lib.granny.debug.lua:454: in function `MyLoadGrannyAnim'
+						../lua/lib.granny.debug.lua:488: in function `MyGetOrCreateSkeleton'
+						../lua/lib.granny.debug.lua:496: in function `MakeNewGranny'
+						../lua/lib.granny.debug.lua:66: in function `StartMenu'
+						../lua/lib.granny.debug.lua:45: in function `StartDebugGrannyMenu'
+						../lua/main.lua:536: in function <../lua/main.lua:467>
+			]]--
+			=

+			os.exit(0)
+			=

+			=

+			=

+			=

+			assert(pGrannyLoader.mBones) -- VisitBone 0XCA5E0506 && bRootParent_Ske=
letonList
+			--~ local pGrannyBone =3D mpGrannyLoader.mBones[iBoneID]       pGrannyB=
one.iParent  GetBoneRotate(pGrannyBone) pGrannyBone.fTranslate[0]   pGranny=
Bone.fQuaternion[3]
 		end
 		return pGrannyLoader
 	end
@@ -370,7 +463,7 @@
 		local animname =3D GetAnimName(bodyid,animid) =

 		if (skeleton.anims[animname]) then return end -- already loaded
 		local animpath =3D GetAnimPath(bodyid,animid)
-		local mygrannyanim =3D LoadGranny(animpath)
+		local mygrannyanim =3D LoadGrannyLua_ByFilePath(animpath)
 		if (not mygrannyanim) then =

 			print("ERROR LoadGrannyAnim",animpath,bodyid,animid,skeleton,bodypartsa=
mples)
 			return false
@@ -378,43 +471,45 @@
 		=

 		-- construct animation
 		printdebug("granny","LoadGrannyAnim",bodyid,animid,skeleton.name,animnam=
e,animpath)
-		mygrannyanim:AddAnimToSkeleton(skeleton.name,animname,bodypartsamples)
+		--~ mygrannyanim:AddAnimToSkeleton(skeleton.name,animname,bodypartsample=
s)
+		LoadGrannyAsOgreAnim(mygrannyanim,skeleton.name,animname,bodypartsamples)
+		=

 		skeleton.anims[animname] =3D true
 	end
 	function MyGetOrCreateSkeleton(bodyid)
-		return GetOrCreateSkeleton(bodyid)
-		--~ local modelinfo =3D GetGrannyModelInfo(bodyid)
-		=

-		--~ if (not modelinfo) then GrannyShowNo3DDataError(bodyid) return end
-		--~ assert(modelinfo,"ERROR bodyinfo for skeleton not found "..tostring(=
bodyid))
-
-		--~ while (modelinfo.animid ~=3D 0) do modelinfo =3D GetGrannyModelInfo(=
modelinfo.animid) end
-		--~ local skeletonname =3D GetUniqueName() -- modelinfo.modelname -- exa=
mple: "deer_stag"
-		=

-		--~ CreateSkeleton(skeletonname)
-		--~ local skeleton =3D { name=3Dskeletonname, anims=3D{} }
-		=

-		--~ -- load sample bodyparts needed for animation (needed to assemble co=
rrect granny skeleton)
-		--~ local bodypartsamples =3D {}
-		--~ if (IsBodyIDHuman(bodyid)) then =

-			--~ if (IsBodyIDFemale(bodyid)) then
-				--~ -- human female body parts, often (bodyid =3D=3D 401)
-				--~ for k,v in pairs(kGrannyModelPartByNum) do table.insert(bodypartsa=
mples,LoadGrannyLua(k+kGrannyModelPartAddFemale)) end -- GetGrannyModelLoad=
er->LoadGrannyLua
-			--~ else
-				--~ -- human male body parts, often (bodyid =3D=3D 400)
-				--~ for k,v in pairs(kGrannyModelPartByNum) do table.insert(bodypartsa=
mples,LoadGrannyLua(k+kGrannyModelPartAddMale)) end -- GetGrannyModelLoader=
->LoadGrannyLua
-			--~ end
-		--~ else
-			--~ -- non-human model has komplete skeleton
-			--~ table.insert(bodypartsamples,LoadGrannyLua(bodyid)) -- GetGrannyMod=
elLoader->LoadGrannyLua
-		--~ end
-		=

-		--~ -- load all animations so all entities created afterwards have the f=
ull anim set
-		--~ for k,v in pairs(gAnimInfoLists[modelinfo.typeid]) do
-			--~ MyLoadGrannyAnim(bodyid,k,skeleton,bodypartsamples) =

-		--~ end
-	=

-		--~ return skeleton
+		--~ return GetOrCreateSkeleton(bodyid)
+		local modelinfo =3D GetGrannyModelInfo(bodyid)
+		=

+		if (not modelinfo) then GrannyShowNo3DDataError(bodyid) return end
+		assert(modelinfo,"ERROR bodyinfo for skeleton not found "..tostring(body=
id))
+
+		while (modelinfo.animid ~=3D 0) do modelinfo =3D GetGrannyModelInfo(mode=
linfo.animid) end
+		local skeletonname =3D GetUniqueName() -- modelinfo.modelname -- example=
: "deer_stag"
+		=

+		CreateSkeleton(skeletonname)
+		local skeleton =3D { name=3Dskeletonname, anims=3D{} }
+		=

+		-- load sample bodyparts needed for animation (needed to assemble correc=
t granny skeleton)
+		local bodypartsamples =3D {}
+		if (IsBodyIDHuman(bodyid)) then =

+			if (IsBodyIDFemale(bodyid)) then
+				-- human female body parts, often (bodyid =3D=3D 401)
+				for k,v in pairs(kGrannyModelPartByNum) do table.insert(bodypartsample=
s,LoadGrannyLua(k+kGrannyModelPartAddFemale)) end -- GetGrannyModelLoader->=
LoadGrannyLua
+			else
+				-- human male body parts, often (bodyid =3D=3D 400)
+				for k,v in pairs(kGrannyModelPartByNum) do table.insert(bodypartsample=
s,LoadGrannyLua(k+kGrannyModelPartAddMale)) end -- GetGrannyModelLoader->Lo=
adGrannyLua
+			end
+		else
+			-- non-human model has komplete skeleton
+			table.insert(bodypartsamples,LoadGrannyLua(bodyid)) -- GetGrannyModelLo=
ader->LoadGrannyLua
+		end
+		=

+		-- load all animations so all entities created afterwards have the full =
anim set
+		for k,v in pairs(gAnimInfoLists[modelinfo.typeid]) do
+			MyLoadGrannyAnim(bodyid,k,skeleton,bodypartsamples) =

+		end
+	=

+		return skeleton
 	end
 	=

 	=

@@ -771,29 +866,7 @@
 =

 =

 --[[
-  cGrannyFile:LoadFile    /cavern/uoml_freshinstall.4.x/Models/Animals/Equ=
ines_Horse_Dappled_Brown_Walk.grn                          =

-text    1/42    "__Standard"                                              =
                                                         =

-text    2/42    "__FileName"                                              =
                                                         =

-text    3/42    "R:\content\Game\Fauna\Creatures\Equines\Max\Anim\equines_=
horse_dappled_brown_walk.max"                            =

-text    4/42    "__ObjectName"                                            =
                                                         =

-text    5/42    "Bip01 L Finger0"                                         =
                                                         =

-text    6/42    "__Description"                                           =
                                                         =

-text    7/42    "Bip01 L Hand"                                            =
                                                         =

-text    8/42    "Bip01 R Clavicle"                                        =
                                                         =

-text    9/42    "Bip01 Tail"                                              =
                                                         =

-text    10/42   "Bip01 R UpperArm"                                        =
                                                         =

-text    11/42   "Bip01 R Calf"                                            =
                                                         =

-boneTies1:boneobject    1/36    {childs=3D{[1]=3D{iID=3D3				},},}        =
                                                                           =
                            =

-boneTies1:boneobject    2/36    {childs=3D{[1]=3D{iID=3D1				},},}        =
                                                                           =
                            =

-boneTies1:boneobject    3/36    {childs=3D{[1]=3D{iID=3D2				},},}        =
                                                                           =
                            =

-boneTies1:boneobject    4/36    {childs=3D{[1]=3D{iID=3D9=3D0x09		},},}   =
                                                                           =
                            =

-boneTies1:boneobject    5/36    {childs=3D{[1]=3D{iID=3D21=3D0x15		},},}  =
                                                                           =
                            =

-boneTies1:boneobject    6/36    {childs=3D{[1]=3D{iID=3D16=3D0x10		},},}  =
                                                                           =
                            =

-boneTies1:boneobject    7/36    {childs=3D{[1]=3D{iID=3D6				},},}        =
                                                                           =
                            =

-boneTies1:boneobject    8/36    {childs=3D{[1]=3D{iID=3D19=3D0x13		},},}  =
                                                                           =
                            =

-boneTies1:boneobject    9/36    {childs=3D{[1]=3D{iID=3D8				},},}        =
                                                                           =
                            =

-boneTies1:boneobject    10/36   {childs=3D{[1]=3D{iID=3D12=3D0x0c		},},}  =
                                                                           =
                            =

-boneTies1:boneobject    11/36   {childs=3D{[1]=3D{iID=3D13=3D0x0d		},},}  =
                                                                           =
       =

+  cGrannyFile:LoadFile    /cavern/uoml_freshinstall.4.x/Models/Animals/Equ=
ines_Horse_Dappled_Brown_Walk.grn        =

 bone    1/36    {fTranslate=3D{[1]=3D0,[2]=3D0,[0]=3D0,},iParent=3D0,fMatr=
ix=3D{[1]=3D0,[2]=3D0,[3]=3D0,[4]=3D1,[5]=3D0,[6]=3D0,[7]=3D0,[8]=3D1,[0]=
=3D1,},fQuaternion=3D{[1]=3D0,[2]=3D0,[3]=3D1,[0]=3D0,},}                  =
                                                                           =
                                                           =

 bone    2/36    {fTranslate=3D{[1]=3D-0.000461,[2]=3D0,[0]=3D0,},iParent=
=3D0,fMatrix=3D{[1]=3D0,[2]=3D0,[3]=3D0,[4]=3D1,[5]=3D0,[6]=3D0,[7]=3D0,[8]=
=3D1,[0]=3D1,},fQuaternion=3D{[1]=3D0,[2]=3D0,[3]=3D1,[0]=3D0,},}          =
                                                                           =
                                                           =

 bone    3/36    {fTranslate=3D{[1]=3D0.473461,[2]=3D1.085400,[0]=3D-0.0089=
64,},iParent=3D1,fMatrix=3D{[1]=3D0.000000,[2]=3D-0.000000,[3]=3D0.000000,[=
4]=3D1,[5]=3D0.000000,[6]=3D0.000000,[7]=3D0.000000,[8]=3D1,[0]=3D1,},fQuat=
ernion=3D{[1]=3D0.003099,[2]=3D-0.710178,[3]=3D0.704009,[0]=3D0.003072,},} =
                                                         =

@@ -805,93 +878,8 @@
 bone    9/36    {fTranslate=3D{[1]=3D-0.000251,[2]=3D0.000001,[0]=3D0.2238=
47,},iParent=3D7,fMatrix=3D{[1]=3D-0.000000,[2]=3D0.000000,[3]=3D-0.000000,=
[4]=3D1,[5]=3D-0.000000,[6]=3D-0.000000,[7]=3D-0.000000,[8]=3D1.000000,[0]=
=3D1.000000,},fQuaternion=3D{[1]=3D0.004809,[2]=3D0.141923,[3]=3D0.989864,[=
0]=3D-0.001989,},}
 bone    10/36   {fTranslate=3D{[1]=3D0.000000,[2]=3D-0.000000,[0]=3D0.3291=
82,},iParent=3D8,fMatrix=3D{[1]=3D0.000000,[2]=3D0.000000,[3]=3D0.000000,[4=
]=3D1,[5]=3D-0.000000,[6]=3D0.000000,[7]=3D-0.000000,[8]=3D1.000000,[0]=3D1=
.000000,},fQuaternion=3D{[1]=3D-0.015708,[2]=3D-0.107925,[3]=3D0.993487,[0]=
=3D-0.032989,},}
 bone    11/36   {fTranslate=3D{[1]=3D0.007118,[2]=3D-0.078183,[0]=3D0.0431=
31,},iParent=3D9=3D0x09,fMatrix=3D{[1]=3D0.000000,[2]=3D-0.000000,[3]=3D-0.=
000000,[4]=3D1,[5]=3D-0.000000,[6]=3D-0.000000,[7]=3D-0.000000,[8]=3D1.0000=
00,[0]=3D1,},fQuaternion=3D{[1]=3D-0.004665,[2]=3D-0.190827,[3]=3D0.981608,=
[0]=3D-0.003001,},}
-iBoneTie2ID=3D    1       bone_objptrs.iNum=3D      36
-bt2:bone_objptr 1/36    24=3D0x18
-bt2:bone_objptr 2/36    23=3D0x17
-bt2:bone_objptr 3/36    22=3D0x16
-bt2:bone_objptr 4/36    27=3D0x1b
-bt2:bone_objptr 5/36    26=3D0x1a
-bt2:bone_objptr 6/36    25=3D0x19
-bt2:bone_objptr 7/36    30=3D0x1e
-bt2:bone_objptr 8/36    29=3D0x1d
-bt2:bone_objptr 9/36    28=3D0x1c
-bt2:bone_objptr 10/36   33=3D0x21
-bt2:bone_objptr 11/36   32=3D0x20
-bt2:bonetie     !!NIL!!
-iTextureID      1
-obj     1/36    {[2]=3D3,[4]=3D5,[6]=3D0,}	-- 3=3D4/42 "__ObjectName"    	=
5=3D6/42    "__Description" =

-obj     2/36    {[2]=3D3,[4]=3D7,[6]=3D0,}    =

-obj     3/36    {[2]=3D3,[4]=3D8,[6]=3D0,}
-obj     4/36    {[2]=3D3,[4]=3D9=3D0x09,[6]=3D0,}
-obj     5/36    {[2]=3D3,[4]=3D10=3D0x0a,[6]=3D0,}
-obj     6/36    {[2]=3D3,[4]=3D11=3D0x0b,[6]=3D0,}
-obj     7/36    {[2]=3D3,[4]=3D12=3D0x0c,[6]=3D0,}
-obj     8/36    {[2]=3D3,[4]=3D13=3D0x0d,[6]=3D0,}
-obj     9/36    {[2]=3D3,[4]=3D14=3D0x0e,[6]=3D0,}
-obj     10/36   {[2]=3D3,[4]=3D15=3D0x0f,[6]=3D0,}
-obj     11/36   {[2]=3D3,[4]=3D16=3D0x10,[6]=3D0,}
-
-
-***************
-
-
-cGrannyFile:LoadFile    /home/ghoul/Desktop/cavern/uoml/Models/Animals/Equ=
ines_Horse_Dappled_Brown_Lod2.grn                                          =
         =

-text    1/46    "__Standard"                                              =
                                                                           =
         =

-text    2/46    "__FileName"                                              =
                                                                           =
         =

-text    3/46    "r:\content\game\fauna\creatures\equines\max\equines_horse=
_dappled_brown_lod2.max"                                                   =
         =

-text    4/46    "__ObjectName"                                            =
                                                                           =
         =

-text    5/46    "Equines_Horse_Dappled_Brown"                             =
                                                                           =
         =

-text    6/46    "__Description"                                           =
                                                                           =
         =

-text    7/46    "Bip01 Spine1"                                            =
                                                                           =
         =

-text    8/46    "master_equines_horse_dappled_brown"                      =
                                                                           =
         =

-text    9/46    "__Root"                                                  =
                                                                           =
         =

-text    10/46   "Bip01 Pelvis"                                            =
                                                                           =
         =

-text    11/46   "Bip01"                                                   =
                                                                           =
         =

-point   1/223   {y=3D0.547549,x=3D-0.281395,z=3D1.035676,}                =
                                                                           =
               =

-point   2/223   {y=3D0.341187,x=3D-0.279739,z=3D0.754919,}                =
                                                                           =
               =

-point   3/223   {y=3D-0.344653,x=3D-0.253881,z=3D1.039981,}               =
                                                                           =
               =

-point   4/223   {y=3D0.520265,x=3D-0.246531,z=3D1.201591,}                =
                                                                           =
               =

-point   5/223   {y=3D0.243041,x=3D-0.243713,z=3D1.043599,}                =
                                                                           =
               =

-point   6/223   {y=3D-0.604263,x=3D-0.233141,z=3D0.808763,}               =
                                                                           =
               =

-point   7/223   {y=3D-0.345181,x=3D-0.222155,z=3D0.888647,}               =
                                                                           =
               =

-point   8/223   {y=3D-0.638878,x=3D-0.220125,z=3D0.967547,}               =
                                                                           =
               =

-point   9/223   {y=3D0.309630,x=3D-0.214871,z=3D1.149054,}                =
                                                                           =
               =

-point   10/223  {y=3D-0.460259,x=3D-0.212234,z=3D0.739967,}               =
                                                                           =
               =

-point   11/223  {y=3D0.311111,x=3D-0.222721,z=3D0.150869,}                =
                                                                           =
                                 =

-weights:        {unknown_b=3D2,wnum=3D223=3D0xdf,unknown_a=3D32=3D0x20,lis=
t_weightchunks=3Dtable: 0x952e858,}                                        =
                     =

-weight  1/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D0,f=
Weight=3D1,},},}                                                           =
                   =

-weight  2/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D0,f=
Weight=3D1,},},}                                                           =
                   =

-weight  3/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D1,f=
Weight=3D1,},},}                                                           =
                   =

-weight  4/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D2,f=
Weight=3D1,},},}                                                           =
                   =

-weight  5/223   {iNumBones=3D2,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D0,f=
Weight=3D0.500000,},[2]=3D{iWeightBoneIndex=3D2,fWeight=3D0.500000,},},}   =
                         =

-weight  6/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D3,f=
Weight=3D1,},},}                                                           =
                   =

-weight  7/223   {iNumBones=3D2,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D3,f=
Weight=3D0.500000,},[2]=3D{iWeightBoneIndex=3D4,fWeight=3D0.500000,},},}   =
                         =

-weight  8/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D1,f=
Weight=3D1,},},}                                                           =
                   =

-weight  9/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D2,f=
Weight=3D1,},},}                                                           =
                   =

-weight  10/223  {iNumBones=3D2,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D3,f=
Weight=3D0.500000,},[2]=3D{iWeightBoneIndex=3D5,fWeight=3D0.500000,},},}   =
                         =

-weight  11/223  {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D6,f=
Weight=3D1,},},}                                                           =
                   =

-polygon 1/442   {iVertex=3D{[1]=3D83=3D0x53,[2]=3D72=3D0x48,[0]=3D82=3D0x5=
2,},iNormal=3D{[1]=3D83=3D0x53,[2]=3D72=3D0x48,[0]=3D82=3D0x52,},}         =
                                     =

-polygon 2/442   {iVertex=3D{[1]=3D134=3D0x86,[2]=3D148=3D0x94,[0]=3D140=3D=
0x8c,},iNormal=3D{[1]=3D134=3D0x86,[2]=3D148=3D0x94,[0]=3D140=3D0x8c,},}   =
                                     =

-polygon 3/442   {iVertex=3D{[1]=3D158=3D0x9e,[2]=3D139=3D0x8b,[0]=3D148=3D=
0x94,},iNormal=3D{[1]=3D158=3D0x9e,[2]=3D139=3D0x8b,[0]=3D148=3D0x94,},}   =
                                     =

-polygon 4/442   {iVertex=3D{[1]=3D82=3D0x52,[2]=3D72=3D0x48,[0]=3D87=3D0x5=
7,},iNormal=3D{[1]=3D82=3D0x52,[2]=3D72=3D0x48,[0]=3D87=3D0x57,},}         =
                                     =

-polygon 5/442   {iVertex=3D{[1]=3D87=3D0x57,[2]=3D84=3D0x54,[0]=3D121=3D0x=
79,},iNormal=3D{[1]=3D87=3D0x57,[2]=3D84=3D0x54,[0]=3D121=3D0x79,},}       =
                                     =

-polygon 6/442   {iVertex=3D{[1]=3D134=3D0x86,[2]=3D121=3D0x79,[0]=3D138=3D=
0x8a,},iNormal=3D{[1]=3D134=3D0x86,[2]=3D121=3D0x79,[0]=3D138=3D0x8a,},}   =
                                     =

-polygon 7/442   {iVertex=3D{[1]=3D84=3D0x54,[2]=3D119=3D0x77,[0]=3D121=3D0=
x79,},iNormal=3D{[1]=3D84=3D0x54,[2]=3D119=3D0x77,[0]=3D121=3D0x79,},}     =
                                     =

-polygon 8/442   {iVertex=3D{[1]=3D138=3D0x8a,[2]=3D159=3D0x9f,[0]=3D148=3D=
0x94,},iNormal=3D{[1]=3D138=3D0x8a,[2]=3D159=3D0x9f,[0]=3D148=3D0x94,},}   =
                                     =

-polygon 9/442   {iVertex=3D{[1]=3D138=3D0x8a,[2]=3D119=3D0x77,[0]=3D144=3D=
0x90,},iNormal=3D{[1]=3D138=3D0x8a,[2]=3D119=3D0x77,[0]=3D144=3D0x90,},}   =
                                     =

-polygon 10/442  {iVertex=3D{[1]=3D120=3D0x78,[2]=3D134=3D0x86,[0]=3D140=3D=
0x8c,},iNormal=3D{[1]=3D120=3D0x78,[2]=3D134=3D0x86,[0]=3D140=3D0x8c,},}   =
                                     =

-polygon 11/442  {iVertex=3D{[1]=3D148=3D0x94,[2]=3D139=3D0x8b,[0]=3D140=3D=
0x8c,},iNormal=3D{[1]=3D148=3D0x94,[2]=3D139=3D0x8b,[0]=3D140=3D0x8c,},}   =
                                            =

-boneTies1:boneobject    1/37    {childs=3D{[1]=3D{iID=3D6,		},},}         =
                                          =

-boneTies1:boneobject    2/37    {childs=3D{[1]=3D{iID=3D2,		},},}         =
                                          =

-boneTies1:boneobject    3/37    {childs=3D{[1]=3D{iID=3D7,		},},}         =
                                         =

-boneTies1:boneobject    4/37    {childs=3D{[1]=3D{iID=3D4,		},},}         =
                                         =

-boneTies1:boneobject    5/37    {childs=3D{[1]=3D{iID=3D3,		},},}         =
                                         =

-boneTies1:boneobject    6/37    {childs=3D{[1]=3D{iID=3D8,		},},}         =
                                         =

-boneTies1:boneobject    7/37    {childs=3D{[1]=3D{iID=3D5,		},},}         =
                                         =

-boneTies1:boneobject    8/37    {childs=3D{[1]=3D{iID=3D15=3D0x0f,	},},}  =
                                          =

-boneTies1:boneobject    9/37    {childs=3D{[1]=3D{iID=3D9=3D0x09,	},},}   =
                                          =

-boneTies1:boneobject    10/37   {childs=3D{[1]=3D{iID=3D10=3D0x0a,	},},}  =
                                          =

-boneTies1:boneobject    11/37   {childs=3D{[1]=3D{iID=3D11=3D0x0b,	},},}  =
                                                                           =
                    =

+
+cGrannyFile:LoadFile    /home/ghoul/Desktop/cavern/uoml/Models/Animals/Equ=
ines_Horse_Dappled_Brown_Lod2.grn                                          =
                                                        =

 bone    1/37    {fTranslate=3D{[1]=3D0,[2]=3D0,[0]=3D0,},iParent=3D0,fMatr=
ix=3D{[1]=3D0,[2]=3D0,[3]=3D0,[4]=3D1,[5]=3D0,[6]=3D0,[7]=3D0,[8]=3D1,[0]=
=3D1,},fQuaternion=3D{[1]=3D0,[2]=3D0,[3]=3D1,[0]=3D0,},}                  =
                                                                           =
                                                           =

 bone    2/37    {fTranslate=3D{[1]=3D-0.000461,[2]=3D0,[0]=3D0,},iParent=
=3D0,fMatrix=3D{[1]=3D0,[2]=3D0,[3]=3D0,[4]=3D1,[5]=3D0,[6]=3D0,[7]=3D0,[8]=
=3D1,[0]=3D1,},fQuaternion=3D{[1]=3D0,[2]=3D0,[3]=3D1,[0]=3D0,},}          =
                                                                           =
                                                           =

 bone    3/37    {fTranslate=3D{[1]=3D0.473461,[2]=3D1.060614,[0]=3D-0.0000=
00,},iParent=3D1,fMatrix=3D{[1]=3D0.000000,[2]=3D0.000000,[3]=3D0.000000,[4=
]=3D1,[5]=3D0.000000,[6]=3D-0.000000,[7]=3D0.000000,[8]=3D1,[0]=3D1.000000,=
},fQuaternion=3D{[1]=3D0.003085,[2]=3D-0.707100,[3]=3D0.707101,[0]=3D0.0030=
85,},}                                                   =

@@ -903,149 +891,13 @@
 bone    9/37    {fTranslate=3D{[1]=3D-0.142090,[2]=3D-0.112536,[0]=3D-0.02=
4633,},iParent=3D7,fMatrix=3D{[1]=3D0.000000,[2]=3D0.000000,[3]=3D0.000000,=
[4]=3D1.000000,[5]=3D0.000000,[6]=3D0.000000,[7]=3D0.000000,[8]=3D1.000000,=
[0]=3D1.000000,},fQuaternion=3D{[1]=3D0.536666,[2]=3D-0.535021,[3]=3D-0.426=
220,[0]=3D0.494044,},}                                   =

 bone    10/37   {fTranslate=3D{[1]=3D-0.000000,[2]=3D0.000000,[0]=3D0.3523=
91,},iParent=3D8,fMatrix=3D{[1]=3D0.000000,[2]=3D-0.000000,[3]=3D0.000000,[=
4]=3D1,[5]=3D-0.000000,[6]=3D0.000000,[7]=3D-0.000000,[8]=3D1.000000,[0]=3D=
1.000000,},fQuaternion=3D{[1]=3D-0.525638,[2]=3D0.472182,[3]=3D0.501046,[0]=
=3D0.499702,},}                                          =

 bone    11/37   {fTranslate=3D{[1]=3D-0.000000,[2]=3D0.000000,[0]=3D0.2616=
71,},iParent=3D9=3D0x09,fMatrix=3D{[1]=3D0.000000,[2]=3D0.000000,[3]=3D-0.0=
00000,[4]=3D1.000000,[5]=3D0.000000,[6]=3D0.000000,[7]=3D0.000000,[8]=3D1,[=
0]=3D1,},fQuaternion=3D{[1]=3D-0.000000,[2]=3D-0.498851,[3]=3D0.866688,[0]=
=3D0.000000,},}                                             =

-iBoneTie2ID=3D    1       bone_objptrs.iNum=3D      37                    =
                                                                           =
             =

-bt2:bone_objptr 1/37    4                                                 =
                                                                           =
         =

-bt2:bone_objptr 2/37    5                                                 =
                                                                           =
         =

-bt2:bone_objptr 3/37    1                                                 =
                                                                           =
         =

-bt2:bone_objptr 4/37    7                                                 =
                                                                           =
         =

-bt2:bone_objptr 5/37    12=3D0x0c                                         =
                                                                           =
           =

-bt2:bone_objptr 6/37    34=3D0x22                                         =
                                                                           =
           =

-bt2:bone_objptr 7/37    2                                                 =
                                                                           =
         =

-bt2:bone_objptr 8/37    3                                                 =
                                                                           =
         =

-bt2:bone_objptr 9/37    22=3D0x16                                         =
                                                                           =
           =

-bt2:bone_objptr 10/37   20=3D0x14                                         =
                                                                           =
           =

-bt2:bone_objptr 11/37   21=3D0x15                                         =
                                                                           =
           =

-bt2:bonetie     1/33    {iBone=3D5,iUnknown=3D{[1]=3D-0.058629,[2]=3D-0.23=
7984,[3]=3D-0.162302,[4]=3D0.358194,[5]=3D0.183488,[6]=3D0.102694,[0]=3D0.3=
67406,},}                  =

-bt2:bonetie     2/33    {iBone=3D8,iUnknown=3D{[1]=3D-0.040035,[2]=3D0.008=
894,[3]=3D-0.147809,[4]=3D0.371476,[5]=3D0.125108,[6]=3D0.136732,[0]=3D0.38=
6154,},}                   =

-bt2:bonetie     3/33    {iBone=3D4,iUnknown=3D{[1]=3D-0.261872,[2]=3D-0.08=
0894,[3]=3D-0.246581,[4]=3D0.385943,[5]=3D0.416525,[6]=3D0.246485,[0]=3D0.5=
00515,},}                  =

-bt2:bonetie     4/33    {iBone=3D9=3D0x09,iUnknown=3D{[1]=3D-0.053002,[2]=
=3D-0.150285,[3]=3D-0.092842,[4]=3D0.289619,[5]=3D0.132025,[6]=3D0.142190,[=
0]=3D0.291440,},}             =

-bt2:bonetie     5/33    {iBone=3D6,iUnknown=3D{[1]=3D-0.022146,[2]=3D-0.10=
0626,[3]=3D-0.221972,[4]=3D0.312453,[5]=3D0.468180,[6]=3D0.222517,[0]=3D0.5=
55906,},}
-bt2:bonetie     6/33    {iBone=3D10=3D0x0a,iUnknown=3D{[1]=3D-0.013907,[2]=
=3D-0.233039,[3]=3D-0.070689,[4]=3D0.381548,[5]=3D0.056935,[6]=3D0.074321,[=
0]=3D0.383907,},}
-bt2:bonetie     7/33    {iBone=3D12=3D0x0c,iUnknown=3D{[1]=3D-0.027222,[2]=
=3D-0.101896,[3]=3D-0.065225,[4]=3D0.337428,[5]=3D0.090531,[6]=3D0.068422,[=
0]=3D0.346670,},}
-bt2:bonetie     8/33    {iBone=3D14=3D0x0e,iUnknown=3D{[1]=3D-0.090859,[2]=
=3D-0.000313,[3]=3D-0.060973,[4]=3D-0.007980,[5]=3D-0.000094,[6]=3D0.062011=
,[0]=3D0.091001,},}
-bt2:bonetie     9/33    {iBone=3D11=3D0x0b,iUnknown=3D{[1]=3D0.023739,[2]=
=3D-0.177858,[3]=3D-0.053214,[4]=3D0.344609,[5]=3D0.098641,[6]=3D0.038090,[=
0]=3D0.344661,},}
-bt2:bonetie     10/33   {iBone=3D13=3D0x0d,iUnknown=3D{[1]=3D-0.009283,[2]=
=3D-0.102775,[3]=3D-0.044248,[4]=3D0.176347,[5]=3D0.125947,[6]=3D0.049843,[=
0]=3D0.216987,},}
-bt2:bonetie     11/33   {iBone=3D15=3D0x0f,iUnknown=3D{[1]=3D-0.033795,[2]=
=3D-0.111544,[3]=3D-0.066103,[4]=3D0.275743,[5]=3D0.054734,[6]=3D0.055887,[=
0]=3D0.285613,},}
-iTextureID      1
-iElementSize    16
-iNum    442
-list_texpoly_normal     1/442   {iUnknown=3D0,iTexCoord=3D{[1]=3D45=3D0x2d=
,[2]=3D43=3D0x2b,[0]=3D29=3D0x1d,},}
-list_texpoly_normal     2/442   {iUnknown=3D1,iTexCoord=3D{[1]=3D31=3D0x1f=
,[2]=3D43=3D0x2b,[0]=3D29=3D0x1d,},}
-list_texpoly_normal     3/442   {iUnknown=3D2,iTexCoord=3D{[1]=3D57=3D0x39=
,[2]=3D45=3D0x2d,[0]=3D43=3D0x2b,},}
-list_texpoly_normal     4/442   {iUnknown=3D3,iTexCoord=3D{[1]=3D29=3D0x1d=
,[2]=3D43=3D0x2b,[0]=3D31=3D0x1f,},}
-list_texpoly_normal     5/442   {iUnknown=3D4,iTexCoord=3D{[1]=3D31=3D0x1f=
,[2]=3D42=3D0x2a,[0]=3D33=3D0x21,},}
-list_texpoly_normal     6/442   {iUnknown=3D5,iTexCoord=3D{[1]=3D31=3D0x1f=
,[2]=3D33=3D0x21,[0]=3D42=3D0x2a,},}
-list_texpoly_normal     7/442   {iUnknown=3D6,iTexCoord=3D{[1]=3D48=3D0x30=
,[2]=3D69=3D0x45,[0]=3D34=3D0x22,},}
-list_texpoly_normal     8/442   {iUnknown=3D7,iTexCoord=3D{[1]=3D48=3D0x30=
,[2]=3D53=3D0x35,[0]=3D43=3D0x2b,},}
-list_texpoly_normal     9/442   {iUnknown=3D8,iTexCoord=3D{[1]=3D48=3D0x30=
,[2]=3D69=3D0x45,[0]=3D75=3D0x4b,},}
-list_texpoly_normal     10/442  {iUnknown=3D9=3D0x09,iTexCoord=3D{[1]=3D17=
=3D0x11,[2]=3D31=3D0x1f,[0]=3D29=3D0x1d,},}
-list_texpoly_normal     11/442  {iUnknown=3D10=3D0x0a,iTexCoord=3D{[1]=3D4=
3=3D0x2b,[2]=3D45=3D0x2d,[0]=3D29=3D0x1d,},}
-obj     1/40    {[2]=3D3,[4]=3D5,[6]=3D0,}
-obj     2/40    {[2]=3D3,[4]=3D7,[6]=3D0,}
-obj     3/40    {[2]=3D3,[4]=3D8,[6]=3D0,}
-obj     4/40    {	   [4]=3D9=3D0x09,}
-obj     5/40    {[2]=3D3,[4]=3D10=3D0x0a,[6]=3D0,}
-obj     6/40    {[2]=3D3,[4]=3D11=3D0x0b,[6]=3D0,}
-obj     7/40    {[2]=3D3,[4]=3D12=3D0x0c,[6]=3D0,}
-obj     8/40    {[2]=3D3,[4]=3D5,[6]=3D0,}
-obj     9/40    {[2]=3D3,[4]=3D13=3D0x0d,[6]=3D0,}
-obj     10/40   {[2]=3D3,[4]=3D14=3D0x0e,[6]=3D0,}
-obj     11/40   {[2]=3D3,[4]=3D15=3D0x0f,[6]=3D0,}
-	=

-	point   				1/557   {y=3D-0.710749,x=3D-0.767177,z=3D1.416132,}          =
                                                                           =
                                                                   =

-	normal 					1/553   {y=3D0,x=3D0,z=3D0,}                                 =
                                                                           =
                                     =

-	texcoord   				1/2286  {y=3D0.082323,x=3D0.089491,z=3D0.418126,}         =
    2286/6/3 =3D 127                                                       =
                                         =

-	polygon 				1/1102  {iVertex1=3D3,iNormal2=3D4,iVertex2=3D4,iNormal3=3D14=
0=3D0x8c,iNormal1=3D3,iVertex3=3D140=3D0x8c,}     =

-	polygon 				1/1102  {iVertex=3D{[1]=3D4,[2]=3D140=3D0x8c,[0]=3D3,},iNorma=
l=3D{[1]=3D4,[2]=3D140=3D0x8c,[0]=3D3,},}      =

-	list_texpoly_normal     1/1102  {iUnknown=3D0,iTexCoord=3D{[1]=3D724=3D0x=
02d4,[2]=3D736=3D0x02e0,[0]=3D723=3D0x02d3,},}
-
-
--- animation : =

--- GetOrCreateSkeleton : load all bodyparts, load all anims, add to skelet=
on : (single CreateSkeleton(skeletonname))   mygrannyanim:AddAnimToSkeleton=
(skeleton.name,animname,bodypartsamples)
--- grannyogreloader.cpp : int iCurBoneNum =3D mpGrannyLoader->FindBone(mpG=
rannyLoader->GetBoneName2(pAnim.mpAnim->iID-1));
+
 -- beetle : walk hat eigenes mesh ?!? (MEHRERE SUBMESHES!)    /cavern/uoml=
_freshinstall.4.x/Models/Animals/Giant_Beetle_Walk.grn   ne, nur so hilfobj=
ekte krams oder sowas...
-
--- bones
-
-
 =

 -- comparison beetle vs horse =

 beetle...meshlist.mesh	: <id iID=3D"5" />
 horse...meshlist.mesh	: <id iID=3D"1" />
 one anim per file!
-
-horse : =

-	text    				1/46    "__Standard"
-	point   				1/223   {y=3D0.547549,x=3D-0.281395,z=3D1.035676,}
-	normal  				1/223   {y=3D0.281497,x=3D-0.956108,z=3D-0.081349,}
-	texcoord        		1/222   {y=3D0.689825,x=3D-0.101103,z=3D1,}
-	list_texpoly_normal     1/442   {iUnknown=3D0,iTexCoord=3D{[1]=3D45=3D0x2=
d,[2]=3D43=3D0x2b,[0]=3D29=3D0x1d,},}
-	polygon 				1/442   {iVertex=3D{[1]=3D83=3D0x53,[2]=3D72=3D0x48,[0]=3D82=
=3D0x52,},iNormal=3D{[1]=3D83=3D0x53,[2]=3D72=3D0x48,[0]=3D82=3D0x52,},}
-	=

-	weights:        		{unknown_b=3D2,wnum=3D223=3D0xdf,unknown_a=3D32=3D0x20,=
list_weights=3Dtable: 0xa6208c8,}                                          =
                   =

-	weight  1/223   {iNumBones=3D1,list_pairs=3D{[1]=3D{iWeightBoneIndex=3D0,=
fWeight=3D1,},},}     =

-	boneTies1:boneobject    1/37    {childs=3D{[1]=3Dtable: 0xa762850,},}
-	bone    				1/37    {fTranslate=3D{[1]=3D0,[2]=3D0,[0]=3D0,},iParent=3D0,=
fMatrix=3D{[1]=3D0,[2]=3D0,[3]=3D0,[4]=3D1,[5]=3D0,[6]=3D0,[7]=3D0,[8]=3D1,=
[0]=3D1,},fQuaternion=3D{[1]=3D0,[2]=3D0,[3]=3D1,[0]=3D0,},}
-	bt2:bone_objptr 		1/37    4
-	bt2:bonetie     		1/33    {iBone=3D5,iUnknown=3D{[1]=3D-0.058629,[2]=3D-0=
.237984,[3]=3D-0.162302,[4]=3D0.358194,[5]=3D0.183488,[6]=3D0.102694,[0]=3D=
0.367406,},}
-	obj     				1/40    {[2]=3D3,[4]=3D5,[6]=3D0,}
-
-	weights : =

-		<weights unknown_b=3D"2" unknown_a=3D"32" wnum=3D"223">
-		case 0XCA5E0702: VisitWeights(pInts[0],pInts[1],pInts[2],pData+3*4,iSize=
-3*4); ... mpLastSubMesh->mWeights =3D std::make_pair(pData,iNum);
-	=

-		// prepare bone-weight data
-		if (bUseSkeleton) {
-			sub->clearBoneAssignments();
-			myBoneWeights.reserve(pLoaderSubMesh.mWeights.second);
-			=

-			// WARNING ! buffersize not checked, but as long as the granny files ar=
e intakt thats ok
-			// foreach point : bonenum, index,weight, index,weight,... =

-			const ::uint32* p =3D (::uint32*)pLoaderSubMesh.mWeights.first;   -----=
----- pData
-			for (int i=3D0;i<pLoaderSubMesh.mWeights.second;++i) {
-				::uint32 iNumBones =3D *(p++);
-				=

-				tMyBoneWeightList* pBoneList =3D new tMyBoneWeightList();
-				myBoneWeights.push_back(pBoneList);
-				pBoneList->reserve(iNumBones);
-				=

-				for (int k=3D0;k<iNumBones;++k) {
-					::uint32	iWeightBoneIndex =3D *(p++);
-					float		fWeight =3D *(float*)(p++);
-					pBoneList->push_back(std::make_pair(iWeightBoneIndex,fWeight));
-				}
-			}
-		}
-
-unknown : =

-																															  =

-point  					1/223   {y=3D0.547549,x=3D-0.281395,z=3D1.035676,}            =
                                                                 =

-texcoord        		1/222   {y=3D0.689825,x=3D-0.101103,z=3D1,}   =

-polygon 				1/442   {iVertex=3D{[1]=3D83=3D0x53,[2]=3D72=3D0x48,[0]=3D82=
=3D0x52,},iNormal=3D{[1]=3D83=3D0x53,[2]=3D72=3D0x48,[0]=3D82=3D0x52,},}   =

-list_texpoly_normal     1/442   {iUnknown=3D0,iTexCoord=3D{[1]=3D45=3D0x2d=
,[2]=3D43=3D0x2b,[0]=3D29=3D0x1d,},}
-
-
-	=

-
-weights:       					 {unknown_b=3D2,wnum=3D223=3D0xdf,unknown_a=3D32=3D0x2=
0,list_weights=3Dtable: 0xaf93098,}  =

-weight  				1/809   {w=3D0.000000,}            =

-boneTies1:boneobject    1/37    {childs=3D{[1]=3Dtable: 0xa538fd0,},} =

-bone   					1/37    {fTranslate=3D{[1]=3D0,[2]=3D0,[0]=3D0,},iParent=3D0,f=
Matrix=3D{[1]=3D0,[2]=3D0,[3]=3D0,[4]=3D1,[5]=3D0,[6]=3D0,[7]=3D0,[8]=3D1,[=
0]=3D1,},fQuaternion=3D{[1]=3D0,[2]=3D0,[3]=3D1,[0]=3D0,},}
-iBoneTie2ID=3D    				1       bone_objptrs.iNum=3D      37
-bt2:bone_objptr 		1/37    4
-bt2:bonetie     		1/33    {iBone=3D5,iUnknown=3D{[1]=3D-0.058629,[2]=3D-0.=
237984,[3]=3D-0.162302,[4]=3D0.358194,[5]=3D0.183488,[6]=3D0.102694,[0]=3D0=
.367406,},}
-obj    					1/40    {[2]=3D3,[4]=3D5,[6]=3D0,}
-
-Ogre::Quaternion	GetBoneRotate		(const GrannyBone* pGrannyBone) {
-	return Ogre::Quaternion(pGrannyBone ? pGrannyBone->fQuaternion[3]:1, // o=
gre:w,x,y,z  granny:x,y,z,w
-							pGrannyBone ? pGrannyBone->fQuaternion[0]:0,
-							pGrannyBone ? pGrannyBone->fQuaternion[1]:0,
-							pGrannyBone ? pGrannyBone->fQuaternion[2]:0);
-
-							=

-							=

-}
-			=

 ]]--
 =

 function GrannyTest_PreOgreInit2 ()

Modified: trunk/lua/lib.thread.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.thread.lua (original)
+++ trunk/lua/lib.thread.lua Sun Mar 28 23:39:51 2010
@@ -1,5 +1,23 @@
 function RunThreadTest () RunThreadTest_Main() end  --  -threadtest
 -- idea hagish : helper-class to create message-handling thread that can b=
e serialized as option for easier debugging (decide at create if a real thr=
ead is started or a thread-object that handles messages directly)
+--[[
+	notes : =

+	<ghouly> hi all, question about threading,  is it technically possible to=
 transfer data to vram in a threaded way ? =

+	for example  HardwareVertexBuffer::writeData(...)  etc. looked in the ogr=
e-opengl source and saw it calls glBufferDataARB(...) directly without usin=
g any thread mutex  etc.    i don't want to access the same buffer from dif=
ferent threads,  just wondering if threads other than the mainthread are al=
lowed to call opengl functions
+	http://www.ogre3d.org/forums/viewtopic.php?f=3D2&t=3D56421
+	OGRE_THREAD_CREATE()  -- register with rendersystem
+		Root::getSingleton().getRenderSystem()->postExtraThreadsStarted();
+		workqueue : virtual void setWorkersCanAccessRenderSystem(bool access);  =
    otherwise : response handler executed in mainthread transfers data to r=
endersystem
+		Root::getWorkQueue
+		set(OGRE_CONFIG_THREADS 2 CACHE STRING =

+			"Enable Ogre thread support for background loading. Possible values:
+			0 - Threading off.
+			1 - Full background loading.
+			2 - Background resource preparation."
+		)
+		=

+	/// bhit,fHitDist,iFaceNum =3D FIFO_RayPickTri_Ex(fifoVertexBuf,fifoIndex=
Buf,iNumFaces,iVertexPosOffset,iVertexStride,fBoundRad,rx,ry,rz, rvx,rvy,rv=
z, x,y,z, qw,qx,qy,qz, sx,sy,sz) -- mainly for mousepicking
+]]--
 =

 function ack(n, m)
 	--~ print("ack",n,m)



