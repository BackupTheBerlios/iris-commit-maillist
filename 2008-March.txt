From no-reply at zwischenwelt.org  Sat Mar  1 11:35:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 01 Mar 2008 10:35:58 -0000
Subject: [Iris-commit] [IRIS] r1937 - /trunk/bin/iris2.exe
Message-ID: <20080301110013.B3942152400E@zwischenwelt.org>

Author: sience
Date: Sat Mar  1 11:35:57 2008
New Revision: 1937

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Mar  2 12:44:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Mar 2008 11:44:19 -0000
Subject: [Iris-commit] [IRIS] r1938 - in /trunk/data/models:
 materials/textures.material models/Convert.bat
 models/to_004000/mdl_003679.mesh models/to_009000/mdl_008708.mesh
 textures/tex_106.png textures/tex_27.png textures/tex_54.png
 textures/tex_551.png textures/tex_rune1.png
Message-ID: <20080302114419.7D019152400C@zwischenwelt.org>

Author: sience
Date: Sun Mar  2 12:44:18 2008
New Revision: 1938

Log:
-darker umbra textures (tex_106,27,54,551)
-rune model and skull model from willian added

Added:
    trunk/data/models/models/Convert.bat
    trunk/data/models/models/to_004000/mdl_003679.mesh   (with props)
    trunk/data/models/models/to_009000/mdl_008708.mesh   (with props)
    trunk/data/models/textures/tex_rune1.png   (with props)
Modified:
    trunk/data/models/materials/textures.material
    trunk/data/models/textures/tex_106.png
    trunk/data/models/textures/tex_27.png
    trunk/data/models/textures/tex_54.png
    trunk/data/models/textures/tex_551.png

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Sun Mar  2 12:44:18 2008
@@ -8313,4 +8313,18 @@
 			}	=

 		}
 	} =

-}
+}
+
+material tex_will1 : tex_base
+{ =

+	technique =

+	{ =

+		pass =

+		{		=

+			texture_unit =

+			{ =

+				texture tex_rune1.png =

+			}	=

+		}
+	} =

+}

Modified: trunk/data/models/textures/tex_106.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_27.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_54.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_551.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Mar  2 18:43:47 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Mar 2008 17:43:47 -0000
Subject: [Iris-commit] [IRIS] r1939 - in /trunk: data/models/materials/
 data/models/models/ data/models/models/to_004000/ data/models/textures/
 lua/ lua/filter/ src/
Message-ID: <20080302180026.49E4B1524012@zwischenwelt.org>

Author: sience
Date: Sun Mar  2 18:43:47 2008
New Revision: 1939

Log:
-new fern added
-fern and grasses adjusted
-InLoc (clilocs) disabled, obsolete
-alpha_sceneblend material added (only for grasses & fern)
-bugfix from Arahil added (builder.cpp)
-tex_440.png texture deleted (old fern)
-fern added to textures_skipped_in_atlas.txt

Added:
    trunk/data/models/textures/tex_fernleaf.png   (with props)
Removed:
    trunk/data/models/models/to_004000/mdl_003233.mesh
    trunk/data/models/textures/tex_440.png
Modified:
    trunk/data/models/materials/textures.material
    trunk/data/models/models/textures_skipped_in_atlas.txt
    trunk/data/models/models/to_004000/mdl_003232.mesh
    trunk/data/models/textures/tex_437.png
    trunk/data/models/textures/tex_438.png
    trunk/data/models/textures/tex_439.png
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.gumpparser.lua
    trunk/lua/lib.loading.lua
    trunk/src/builder.cpp

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Sun Mar  2 18:43:47 2008
@@ -47,6 +47,19 @@
 	}
 }
 =

+material tex_base_sceneblend : tex_base
+{
+	technique
+	{
+		pass =

+		{
+			scene_blend alpha_blend
+			depth_write off
+		}
+	}
+}
+			=

+
 // MESH BASE MATERIAL TEMPLATE
 material atlas_base : tex_base
 {
@@ -5347,20 +5360,6 @@
 			texture_unit =

 			{ =

 				texture tex_43.png =

-			}	=

-		}
-	} =

-}
-
-material tex_440 : tex_base_alpha =

-{ =

-	technique =

-	{ =

-		pass =

-		{		=

-			texture_unit =

-			{ =

-				texture tex_440.png =

 			}	=

 		}
 	} =

@@ -8214,14 +8213,12 @@
 	} =

 }
 =

-material tex_grass : tex_base_alpha
+material tex_grass : tex_base_sceneblend
 { =

 	technique =

 	{ =

 		pass =

 		{
-			lighting off
-
 			texture_unit =

 			{ =

 				texture tex_grass.png
@@ -8287,7 +8284,7 @@
 	} =

 }
 =

-material tex_flowers : tex_base_alpha
+material tex_flowers : tex_base_sceneblend
 { =

 	technique =

 	{ =

@@ -8315,6 +8312,20 @@
 	} =

 }
 =

+material fern : tex_base_sceneblend
+{ =

+	technique =

+	{ =

+		pass =

+		{		=

+			texture_unit =

+			{ =

+				texture tex_fernleaf.png
+			}	=

+		}
+	} =

+}
+
 material tex_will1 : tex_base
 { =

 	technique =


Modified: trunk/data/models/models/textures_skipped_in_atlas.txt
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/models/textures_skipped_in_atlas.txt (original)
+++ trunk/data/models/models/textures_skipped_in_atlas.txt Sun Mar  2 18:43=
:47 2008
@@ -1,1 +1,2 @@
 tex_grass
+tex_fernleaf

Modified: trunk/data/models/models/to_004000/mdl_003232.mesh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_437.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_438.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_439.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Sun Mar  2 18:43:47 2008
@@ -112,6 +112,15 @@
 gArtFilter[hex2num("0xcb3")]=3D{maptoid=3D3253}
 gArtFilter[hex2num("0xcb4")]=3D{maptoid=3D3253}
 gArtFilter[hex2num("0xcb6")]=3D{maptoid=3D3253}
+gArtFilter[hex2num("0xd32")]=3D{maptoid=3D3253}
+gArtFilter[hex2num("0xd33")]=3D{maptoid=3D3253}
+
+--fern / farne
+gArtFilter[hex2num("0xca1")]=3D{maptoid=3D3232}
+gArtFilter[hex2num("0xca2")]=3D{maptoid=3D3232}
+gArtFilter[hex2num("0xca3")]=3D{maptoid=3D3232}
+gArtFilter[hex2num("0xca4")]=3D{maptoid=3D3232}
+gArtFilter[hex2num("0xc9f")]=3D{maptoid=3D3232}
 =

 -- barks
 -- map to 3274

Modified: trunk/lua/lib.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gumpparser.lua (original)
+++ trunk/lua/lib.gumpparser.lua Sun Mar  2 18:43:47 2008
@@ -372,7 +372,7 @@
 			--Description:  Defines a text-area where Html-commands are allowed.
 			--				<background> and <scrollbar> can be 0 or 1 and define whether the=
 background is transparent and a scrollbar is displayed.
 			--{ htmlgump 10 8 100 20 0 0 0 }
-			elseif ((command =3D=3D "htmlgump") and (table.getn(bToken)>=3D 8)) then
+			elseif ((command =3D=3D "htmlgump") and (table.getn(bToken)>=3D 7)) then
 				local msg =3D HtmlParser( Gumpdata.textline[tonumber(bToken[6])] )
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+gHorizontal_Textcorrection,
 																bToken[4], bToken[5], msg.text, msg.charh, {1.0,1.0,1.0,1.=
0},

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Sun Mar  2 18:43:47 2008
@@ -110,13 +110,14 @@
 		if (gLanguage) then localisation_file =3D CorrectPath( Addfilepath(gClil=
oc..gLanguage) ) end
 		gClilocLoader =3D CreateClilocLoader(gClilocLoaderType,CorrectPath( Addf=
ilepath(gClilocbaseFile) ),localisation_file,true)
 =

+-- TODO: IntLoc are obsolete ... remove !!!
 		-- intloc loaders, same format as cliloc, like intloc00.enu  intloc11.enu
-		for i =3D 0,20 do
-			local filenamebase =3D sprintf(gIntlocFiles,i)
-			local localisation_file =3D nil
-			if (gLanguage) then localisation_file =3D CorrectPath( Addfilepath(file=
namebase..gLanguage) ) end
-			gIntLocLoaders[i] =3D CreateClilocLoader(gClilocLoaderType,CorrectPath(=
 Addfilepath(filenamebase.."enu") ),localisation_file)
-		end
+--		for i =3D 0,20 do
+--			local filenamebase =3D sprintf(gIntlocFiles,i)
+--			local localisation_file =3D nil
+--			if (gLanguage) then localisation_file =3D CorrectPath( Addfilepath(fi=
lenamebase..gLanguage) ) end
+--			gIntLocLoaders[i] =3D CreateClilocLoader(gClilocLoaderType,CorrectPat=
h( Addfilepath(filenamebase.."enu") ),localisation_file)
+--		end
 	end
 =

 	if (gStitchinLoaderType) then

Modified: trunk/src/builder.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/builder.cpp (original)
+++ trunk/src/builder.cpp Sun Mar  2 18:43:47 2008
@@ -872,22 +872,33 @@
 				NormalMap[x+1][y+1][3] =3D Ogre::Vector3( 0, 0, 1 );
 			} else {
 				Ogre::Vector3 v1, v2;
-
 				v1 =3D Ogre::Vector3( -22, 22, (cell-right)*4 );
 				v2 =3D Ogre::Vector3( -22, -22, (left-cell)*4 );
-				NormalMap[x+1][y+1][0] =3D v1.crossProduct( v2 ).normalise();
+//				NormalMap[x+1][y+1][0] =3D v1.crossProduct( v2 ).normalise();
+//bugfix Arahil
+				NormalMap[x+1][y+1][0] =3D v1.crossProduct( v2 );
+				NormalMap[x+1][y+1][0].normalise();
 =

 				v1 =3D Ogre::Vector3( 22, 22, (right-bottom)*4 );
 				v2 =3D Ogre::Vector3( -22, 22, (cell-right)*4 );
-				NormalMap[x+1][y+1][1] =3D v1.crossProduct( v2 ).normalise();
+//				NormalMap[x+1][y+1][1] =3D v1.crossProduct( v2 ).normalise();
+//bugfix Arahil
+				NormalMap[x+1][y+1][1] =3D v1.crossProduct( v2 );
+				NormalMap[x+1][y+1][1].normalise();
 =

 				v1 =3D Ogre::Vector3( 22, -22, (bottom-left)*4 );
 				v2 =3D Ogre::Vector3( 22, 22, (right-bottom)*4 );
-				NormalMap[x+1][y+1][2] =3D v1.crossProduct( v2 ).normalise();
+//				NormalMap[x+1][y+1][2] =3D v1.crossProduct( v2 ).normalise();
+//bugfix Arahil
+				NormalMap[x+1][y+1][2] =3D v1.crossProduct( v2 );
+				NormalMap[x+1][y+1][2].normalise();
 =

 				v1 =3D Ogre::Vector3( -22, -22, (left-cell)*4 );
 				v2 =3D Ogre::Vector3( 22, -22, (bottom-left)*4 );
-				NormalMap[x+1][y+1][3] =3D v1.crossProduct( v2 ).normalise();
+//				NormalMap[x+1][y+1][3] =3D v1.crossProduct( v2 ).normalise();
+//bugfix Arahil
+				NormalMap[x+1][y+1][3] =3D v1.crossProduct( v2 );
+				NormalMap[x+1][y+1][3].normalise();
 			}
 		}
 	}



From no-reply at zwischenwelt.org  Sun Mar  2 19:08:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Mar 2008 18:08:58 -0000
Subject: [Iris-commit] [IRIS] r1940 - in /trunk/data: config.lua.dist
 models/materials/textures.material models/textures/tex_437.png
 models/textures/tex_438.png models/textures/tex_439.png
Message-ID: <20080302180858.81D6F152400C@zwischenwelt.org>

Author: sience
Date: Sun Mar  2 19:08:54 2008
New Revision: 1940

Log:
-unifont loaders disabled (not needed for now)
-gold,silver,copper textures are now transparent

Modified:
    trunk/data/config.lua.dist
    trunk/data/models/materials/textures.material
    trunk/data/models/textures/tex_437.png
    trunk/data/models/textures/tex_438.png
    trunk/data/models/textures/tex_439.png

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Sun Mar  2 19:08:54 2008
@@ -72,7 +72,7 @@
 gStitchinLoaderType					=3D "FullFile" -- currently only FullFile available
 gAnimDataLoaderType					=3D "FullFile" -- currently only FullFile available
 gGrannyLoaderType					=3D "OnDemand" -- currently only OnDemand available
-gUniFontLoaderType					=3D "FullFile" -- currently only FullFile available
+gUniFontLoaderType					=3D false	--"FullFile" -- currently only FullFile a=
vailable
 =

 -- sightrange is in blocks (8x8 tiles), larger values let you see further,=
 but will result in lower fps
 gSightRange	=3D 4

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Sun Mar  2 19:08:54 2008
@@ -5309,7 +5309,7 @@
 	} =

 }
 =

-material tex_437 : tex_base =

+material tex_437 : tex_base_alpha =

 { =

 	technique =

 	{ =

@@ -5323,7 +5323,7 @@
 	} =

 }
 =

-material tex_438 : tex_base =

+material tex_438 : tex_base_alpha =

 { =

 	technique =

 	{ =

@@ -5337,7 +5337,7 @@
 	} =

 }
 =

-material tex_439 : tex_base =

+material tex_439 : tex_base_alpha =

 { =

 	technique =

 	{ =


Modified: trunk/data/models/textures/tex_437.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_438.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_439.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Mar  2 19:46:51 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Mar 2008 18:46:51 -0000
Subject: [Iris-commit] [IRIS] r1941 - in /trunk/lua: lib.test.lua main.lua
Message-ID: <20080302184651.E716C152400C@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Mar  2 19:46:51 2008
New Revision: 1941

Log:
testcode for lowlevel gui stuff, and removed some annoying bitwise test out=
put

Modified:
    trunk/lua/lib.test.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.test.lua (original)
+++ trunk/lua/lib.test.lua Sun Mar  2 19:46:51 2008
@@ -178,8 +178,10 @@
 function LuaBitwiseTest_FIFO (a)
 	local fifo =3D CreateFIFO()
 	fifo:PushNetUint32(hex2num(a))
-	print("LuaBitwiseTest_FIFO : the following dump should contain "..a)
-	fifo:HexDump()
+	if (gEnableBitwiseHexDumpTest) then
+		print("LuaBitwiseTest_FIFO : the following dump should contain "..a)
+		fifo:HexDump()
+	end
 	local b =3D fifo:PopNetUint32()
 	if (sprintf("0x%08x",b) ~=3D a) then
 		printf("LuaBitwiseTest_FIFO failed : %s !=3D %s\n",a,b)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Mar  2 19:46:51 2008
@@ -345,6 +345,21 @@
 	gFadeLineOffY =3D 30 + gFadeLineTextH
 =

 	StartMainMenu()
+	=

+	if (true) then
+		gRenderMan2D =3D CreateRenderManager2D()
+		print("--CreateSpriteList")
+		local spritelist =3D CreateSpriteList()
+		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
+		spritelist.asgroup:SetParent(gRenderMan2D)
+		spritelist:SetTexture("guibase.png")
+		spritelist:ResizeList(1)
+		print("--SpriteList_Open")
+		SpriteList_Open(spritelist)
+		local iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z =3D 0, 0,0,32,32, 0,0, 1=
,1, 0
+		SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
+		SpriteList_Close()
+	end
 =

 	-- mainloop
 	while (Client_IsAlive()) do =




From no-reply at zwischenwelt.org  Sun Mar  2 20:11:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Mar 2008 19:11:14 -0000
Subject: [Iris-commit] [IRIS] r1942 - in /trunk: bin/iris2.exe
	vs8/iris.vcproj
Message-ID: <20080302200006.1E28D152400F@zwischenwelt.org>

Author: sience
Date: Sun Mar  2 20:11:14 2008
New Revision: 1942

Log:
new win32 binary

Modified:
    trunk/bin/iris2.exe
    trunk/vs8/iris.vcproj

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/vs8/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vs8/iris.vcproj (original)
+++ trunk/vs8/iris.vcproj Sun Mar  2 20:11:14 2008
@@ -530,6 +530,10 @@
 					>
 				</File>
 				<File
+					RelativePath=3D"..\lugre\include\lugre_spritelist.h"
+					>
+				</File>
+				<File
 					RelativePath=3D"..\lugre\include\lugre_texatlas.h"
 					>
 				</File>
@@ -767,6 +771,14 @@
 				</File>
 				<File
 					RelativePath=3D"..\lugre\src\lugre_sound_openal2.cpp"
+					>
+				</File>
+				<File
+					RelativePath=3D"..\lugre\src\lugre_spritelist.cpp"
+					>
+				</File>
+				<File
+					RelativePath=3D"..\lugre\src\lugre_spritelist_L.cpp"
 					>
 				</File>
 				<File



From no-reply at zwischenwelt.org  Mon Mar  3 23:08:33 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 03 Mar 2008 22:08:33 -0000
Subject: [Iris-commit] [IRIS] r1943 - in /trunk: bin/iris2.exe
 data/models/materials/textures.material lua/lib.gumpparser.lua
Message-ID: <20080303220833.5EAF1152400C@zwischenwelt.org>

Author: sience
Date: Mon Mar  3 23:08:32 2008
New Revision: 1943

Log:
-gumpparser updated for lua51
-new win32 binary
-lightning turned off for grass =


Modified:
    trunk/bin/iris2.exe
    trunk/data/models/materials/textures.material
    trunk/lua/lib.gumpparser.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Mon Mar  3 23:08:32 2008
@@ -55,6 +55,7 @@
 		{
 			scene_blend alpha_blend
 			depth_write off
+			depth_check on
 		}
 	}
 }
@@ -8219,6 +8220,8 @@
 	{ =

 		pass =

 		{
+			lighting off
+
 			texture_unit =

 			{ =

 				texture tex_grass.png

Modified: trunk/lua/lib.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gumpparser.lua (original)
+++ trunk/lua/lib.gumpparser.lua Mon Mar  3 23:08:32 2008
@@ -409,41 +409,6 @@
 	--SetDialogAlpha(dialog, 1.0)
 end
 =

---[[
---Support for BR,B,I,U,BODY,DIV,COLOR,BASEFONT,CENTER needed
-function HtmlParser(htmlstring)
-	local msg =3D {}
-	msg.text=3D""
-	msg.center =3D false
-	msg.hue =3D ""
-	msg.charh =3D 12	--standard
-	msg.bold =3D false
-	msg.underline =3D false
-	msg.italic =3D false
-	msg.div =3D 0			--div=3D1, right=3D2, left=3D3, center=3D4
-	msg.body =3D false
-	msg.font =3D ""
-	msg.href =3D ""
-
-	local htmlmsg =3D xmlchild(LuaXML_ParseString(htmlstring), "basefont")
-	for i =3D 1,htmlmsg.n do -- normal order
-		local child =3D htmlmsg[i]
-			if (child.name =3D=3D "font") then  -- TODO : (currently unused) GumpDl=
gAddGfmControlNode(dialog,child)
-		elseif (child.name =3D=3D "hue"	) then -- TODO : (currently unused)
-		elseif (child.name =3D=3D "size") then -- TODO : (currently unused)
-		end
-	end
-
---	if (type(htmlmsg)~=3D"table") then
---		--was,wenn table zur=C3=BCckgeliefert wird!? Also: <basefont><center>b=
la</center></basefont>
---		msg.text =3D msg.text..htmlmsg
---	else
---		HtmlParser(htmlmsg)
---	end
-	return msg
-end
-]]--
-
 -- simple html parser (only center,basefont,br and color tags yep realized)
 -- TODO : BODY, <A HREF=3D"HTTP://www.polserver.com">This is a link</A>
 function HtmlParser(textstring)
@@ -467,26 +432,28 @@
 	--extract tokens
 	for token in string.gfind(textstring, "%w+") do table.insert(bToken,token=
) end
 =

+	-- if > 0 it skips the next tokens
+	local skipnexttoken =3D 0
+	=

 	--parse tokens
 	for z=3D1, table.getn(bToken) do
 		local command =3D string.lower(bToken[z])
---		printdebug("gump",command)
-
-		if (command =3D=3D "basefont") then
+
+		if (skipnexttoken <=3D 0) then
+
+		if (command =3D=3D "basefont" ) then
 			if (table.getn(bToken)>=3D z+2) then
 				if (string.lower(bToken[z+1])=3D=3D"color") then
 					--could be a hex value "msg_hue: 0xFFFFFF" or a colorname like "msg_h=
ue: 0xYELLOW"
 					msg.hue =3D "0x"..bToken[z+2]
---					printdebug("gump","basefont msg.hue=3D"..msg.hue)
-					z=3Dz+2
-				end
+				end
+				skipnexttoken=3D2
 			end
 			if (table.getn(bToken)>=3D z+2) then
 				if (string.lower(bToken[z+1])=3D=3D"size") then
 					msg.charh =3D msg.charh+bToken[z+2]
---					printdebug("gump","basefont msg.charh=3D"..msg.charh)
-					z=3Dz+2
-				end
+				end
+				skipnexttoken=3D2
 			end
 		elseif (command =3D=3D "br") then
 			msg.text =3D msg.text.."\n"
@@ -506,15 +473,15 @@
 				if (string.lower(bToken[z+1])=3D=3D"align") then
 					if (string.lower(bToken[z+2])=3D=3D"left") then
 						msg.div=3D2
-						z=3Dz+1
+						skipnexttoken=3Dskipnexttoken+1
 					elseif (string.lower(bToken[z+2])=3D=3D"right") then
 						msg.div=3D3
-						z=3Dz+1
+						skipnexttoken=3Dskipnexttoken+1
 					elseif (string.lower(bToken[z+2])=3D=3D"center") then
 						msg.div=3D4
-						z=3Dz+1
+						skipnexttoken=3Dskipnexttoken+1
 					end
-					z=3Dz+1
+					skipnexttoken=3Dskipnexttoken+1
 				end
 			end
 		elseif (command =3D=3D "body") then
@@ -524,11 +491,16 @@
 		elseif (command =3D=3D "a") then
 			if (table.getn(bToken)>=3D z+2) then
 				if (string.lower(bToken[z+1])=3D=3D"href") then
-					z=3Dz+2
+					-- TODO: get URL
+					skipnexttoken=3D2
 				end
 			end
 		else
 			msg.text=3Dmsg.text.." "..bToken[z]
+		end
+		=

+		else
+			skipnexttoken =3D skipnexttoken - 1
 		end
 	end
 =




From no-reply at zwischenwelt.org  Tue Mar  4 19:06:26 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Mar 2008 18:06:26 -0000
Subject: [Iris-commit] [IRIS] r1944 - /trunk/lua/main.lua
Message-ID: <20080304180626.1A510152400E@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar  4 19:06:25 2008
New Revision: 1944

Log:
lowlevel gui vertex colour test

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Mar  4 19:06:25 2008
@@ -347,17 +347,22 @@
 	StartMainMenu()
 	=

 	if (true) then
+		print("guitest_spritelist")
 		gRenderMan2D =3D CreateRenderManager2D()
+		gRenderMan2D_Dialogs =3D CreateRenderGroup2D(gRenderMan2D)
+		=

+		=

 		print("--CreateSpriteList")
-		local spritelist =3D CreateSpriteList()
+		local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true)
 		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
-		spritelist.asgroup:SetParent(gRenderMan2D)
+		spritelist.asgroup:SetClip(24,4,122,22)
 		spritelist:SetTexture("guibase.png")
 		spritelist:ResizeList(1)
 		print("--SpriteList_Open")
 		SpriteList_Open(spritelist)
-		local iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z =3D 0, 0,0,32,32, 0,0, 1=
,1, 0
-		SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
+		local iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z, r,g,b,a =3D 0, 0,0,32*4=
,32*4, 0,0, 1,1, 0,  1,0,0,0
+		--~ SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
+		SpriteList_SetSpriteEx(iSpriteIndex, l,t,w,h, u0,v0, uvw,0, 0,uvh, z, r,=
g,b,a)
 		SpriteList_Close()
 	end
 =




From no-reply at zwischenwelt.org  Wed Mar  5 21:42:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 05 Mar 2008 20:42:34 -0000
Subject: [Iris-commit] [IRIS] r1945 - in /trunk: bin/ data/ data/gfm/
 data/models/atlas/ data/models/materials/ data/models/models/
 data/models/models/to_004000/ data/models/textures/ data/terrain/materials/
 lua/ lua/filter/ lua/gui/
Message-ID: <20080305204236.0477D152400E@zwischenwelt.org>

Author: sience
Date: Wed Mar  5 21:42:33 2008
New Revision: 1945

Log:
-win32 binary
-paperdoll gump modified for weapon abilities
-amient lightning increased
-new cedartree mesh + textures (old meshes+textures deleted)
-new grass texture (the original one)
-some gumpparser functions local defined

Added:
    trunk/data/models/textures/firneedle_texture.dds   (with props)
    trunk/data/models/textures/tex_grass_alpha.png   (with props)
Removed:
    trunk/data/models/atlas/tex_atlas_alpha_med0.dds
    trunk/data/models/atlas/tex_atlas_alpha_med1.dds
    trunk/data/models/atlas/tex_atlas_med0.dds
    trunk/data/models/atlas/tex_atlas_med1.dds
    trunk/data/models/atlas/tex_atlas_med2.dds
    trunk/data/models/atlas/tex_atlas_med3.dds
    trunk/data/models/atlas/tex_atlas_med4.dds
    trunk/data/models/models/to_004000/mdl_003288.mesh
    trunk/data/models/models/to_004000/mdl_003289.mesh
    trunk/data/models/textures/tex_441.png
    trunk/data/models/textures/tex_560.png
Modified:
    trunk/bin/iris2.exe
    trunk/data/config.lua.dist
    trunk/data/gfm/player_paperdoll.gfm
    trunk/data/models/materials/textures.material
    trunk/data/models/models/textures_skipped_in_atlas.txt
    trunk/data/models/models/to_004000/mdl_003286.mesh
    trunk/data/models/models/to_004000/mdl_003287.mesh
    trunk/data/models/textures/tex_grass.png
    trunk/data/terrain/materials/terrain.material
    trunk/lua/filter/filter.art.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.gumpparser.lua
    trunk/lua/lib.keybinds.lua
    trunk/lua/lib.spellbooks.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Wed Mar  5 21:42:33 2008
@@ -100,7 +100,7 @@
 gSunLightSpecular =3D {r=3D1.0,g=3D1.0,b=3D1.0}
 =

 -- Ambient Light
-gAmbientLight =3D {r=3D0.4,g=3D0.4,b=3D0.4}
+gAmbientLight =3D {r=3D0.6,g=3D0.6,b=3D0.6}
 =

 -- Soundeffects & Music
 -- gUseSoundSystem =3D "openal"

Modified: trunk/data/gfm/player_paperdoll.gfm
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/gfm/player_paperdoll.gfm (original)
+++ trunk/data/gfm/player_paperdoll.gfm Wed Mar  5 21:42:33 2008
@@ -50,8 +50,16 @@
  <event onclick=3D'' onclose=3D'' onmouseup=3D'' onmousedown=3D'' onkeypre=
ssed=3D''/>
  <gump normal=3D'0x7D2' over=3D'0x7D2' pressed=3D'0x7D2'/>
 </control>
-<control class=3D'button' name=3D'btn_virtues' left=3D'80' top=3D'3' width=
=3D'32' height=3D'32' freezed=3D'0' visible=3D'1' alpha=3D'0' flags=3D'0'>
+<control class=3D'button' name=3D'btn_virtues' left=3D'80' top=3D'3' width=
=3D'32' height=3D'32' freezed=3D'1' visible=3D'1' alpha=3D'0' flags=3D'0'>
  <event onclick=3D'' onclose=3D'' onmouseup=3D'' onmousedown=3D'' onkeypre=
ssed=3D''/>
  <gump normal=3D'0x71' over=3D'0x71' pressed=3D'0x71'/>
 </control>
+<control class=3D'button' name=3D'btn_specialAbilities' left=3D'156' top=
=3D'199' width=3D'15' height=3D'47' freezed=3D'1' visible=3D'1' alpha=3D'0'=
 flags=3D'0'>
+ <event onclick=3D'' onclose=3D'' onmouseup=3D'' onmousedown=3D'' onkeypre=
ssed=3D''/>
+ <gump normal=3D'0x2B34' over=3D'0x2B34' pressed=3D'0x2B34'/>
+</control>
+<control class=3D'button' name=3D'btn_party' left=3D'41' top=3D'195' width=
=3D'19' height=3D'51' freezed=3D'1' visible=3D'1' alpha=3D'0' flags=3D'0'>
+ <event onclick=3D'' onclose=3D'' onmouseup=3D'' onmousedown=3D'' onkeypre=
ssed=3D''/>
+ <gump normal=3D'0x7D2' over=3D'0x7D2' pressed=3D'0x7D2'/>
+</control>
 </form>

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Wed Mar  5 21:42:33 2008
@@ -5366,20 +5366,6 @@
 	} =

 }
 =

-material tex_441 : tex_base_alpha =

-{ =

-	technique =

-	{ =

-		pass =

-		{		=

-			texture_unit =

-			{ =

-				texture tex_441.png =

-			}	=

-		}
-	} =

-}
-
 material tex_442 : tex_base_alpha =

 { =

 	technique =

@@ -7209,20 +7195,6 @@
 			texture_unit =

 			{ =

 				texture tex_55.png =

-			}	=

-		}
-	} =

-}
-
-material tex_560 : tex_base_alpha =

-{ =

-	technique =

-	{ =

-		pass =

-		{		=

-			texture_unit =

-			{ =

-				texture tex_560.png =

 			}	=

 		}
 	} =

@@ -8342,3 +8314,36 @@
 		}
 	} =

 }
+
+material cedar_bark : tex_base
+{
+	technique
+	{
+		pass
+		{
+			texture_unit
+			{
+				texture tex_550.png =

+			}
+		}
+	}
+}
+
+material cedars : tex_base_alpha
+{
+	technique
+	{
+		pass
+		{
+			alpha_rejection greater_equal 55
+//			scene_blend alpha_blend
+//			depth_write off
+//			depth_check on
+
+			texture_unit
+			{
+				texture firneedle_texture.dds
+			}
+		}
+	}
+}

Modified: trunk/data/models/models/textures_skipped_in_atlas.txt
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/models/textures_skipped_in_atlas.txt (original)
+++ trunk/data/models/models/textures_skipped_in_atlas.txt Wed Mar  5 21:42=
:33 2008
@@ -1,2 +1,3 @@
 tex_grass
 tex_fernleaf
+firneedle_texture

Modified: trunk/data/models/models/to_004000/mdl_003286.mesh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/models/to_004000/mdl_003287.mesh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/textures/tex_grass.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/terrain/materials/terrain.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/terrain/materials/terrain.material (original)
+++ trunk/data/terrain/materials/terrain.material Wed Mar  5 21:42:33 2008
@@ -21,6 +21,7 @@
 }
 =

 // simple material without transitions
+//material terrain_multitex_simple_mat
 material terrain_multitex_simple_mat
 {
 	receive_shadows on
@@ -41,6 +42,7 @@
 	}
 }
 =

+//material terrain_multitex_mat : Ogre/DepthShadowmap/BasicTemplateMaterial
 material terrain_multitex_mat
 {
 	receive_shadows on

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Wed Mar  5 21:42:33 2008
@@ -146,7 +146,8 @@
 gArtFilter[3320]=3D{maptoid=3D3274}
 =

 -- cedar tree
-gArtFilter[3288]=3D{maptoid=3D3286,xadd=3D0.8,yadd=3D-0.7,zadd=3D0}
+gArtFilter[3288]=3D{maptoid=3D3286,xadd=3D0.8,yadd=3D-0.7,zadd=3D0}	-- ced=
arbark
+gArtFilter[3289]=3D{maptoid=3D3287,xadd=3D0.8,yadd=3D-0.7,zadd=3D0}	-- ced=
ars
 =

 -- mushrooms
 gArtFilter[3352]=3D{maptoid=3D3351}

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Wed Mar  5 21:42:33 2008
@@ -156,6 +156,16 @@
 																AddFadeLines("btn_scroll")
 															end
 														end
+			dialog.controls["btn_party"].onMouseDown =3D function (widget,mousebutt=
on)
+															if (mousebutton =3D=3D 1) then
+																AddFadeLines("btn_party")
+															end
+														end
+			dialog.controls["btn_specialAbilities"].onMouseDown =3D function (widge=
t,mousebutton)
+															if (mousebutton =3D=3D 1) then
+																AddFadeLines("btn_specialAbilities")
+															end
+														end
 			--  TODO : btn_quit
 		else
 			dialog.controls["btn_status"].onMouseDown =3D function (widget,mousebut=
ton)
@@ -431,3 +441,4 @@
   };   =

 ]]--
 =

+

Modified: trunk/lua/lib.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gumpparser.lua (original)
+++ trunk/lua/lib.gumpparser.lua Wed Mar  5 21:42:33 2008
@@ -9,12 +9,109 @@
 entry enclosed with @'s can be used. With this you can specify texts that =
will be added to the CliLoc entry.
 ]]--
 =

-gHorizontal_Textcorrection=3D5
-
 gServerSideGump =3D {}
 gGumpPosition =3D {}
 =

-function ServerSideGump_GetParams (dialogId)
+-- simple html parser (only center,basefont,br and color tags yep realized)
+-- TODO : BODY, <A HREF=3D"HTTP://www.polserver.com">This is a link</A>
+local function HtmlParser(textstring)
+	local msg =3D {}
+	msg.text =3D ""
+	msg.center =3D false
+	msg.hue =3D ""
+	msg.charh =3D gFontGumpSize	--standard
+	msg.bold =3D false
+	msg.underline =3D false
+	msg.italic =3D false
+	msg.div =3D 0			--div=3D1, right=3D2, left=3D3, center=3D4
+	msg.body =3D false
+	msg.font =3D ""
+	msg.href =3D ""
+
+	if (not(textstring)) then return msg end
+
+	local bToken =3D {}
+
+	--extract tokens
+	for token in string.gfind(textstring, "%w+") do table.insert(bToken,token=
) end
+
+	-- if > 0 it skips the next tokens
+	local skipnexttoken =3D 0
+	=

+	--parse tokens
+	for z=3D1, table.getn(bToken) do
+		local command =3D string.lower(bToken[z])
+
+		if (skipnexttoken <=3D 0) then
+
+		if (command =3D=3D "basefont" ) then
+			if (table.getn(bToken)>=3D z+2) then
+				if (string.lower(bToken[z+1])=3D=3D"color") then
+					--could be a hex value "msg_hue: 0xFFFFFF" or a colorname like "msg_h=
ue: 0xYELLOW"
+					msg.hue =3D "0x"..bToken[z+2]
+				end
+				skipnexttoken=3D2
+			end
+			if (table.getn(bToken)>=3D z+2) then
+				if (string.lower(bToken[z+1])=3D=3D"size") then
+					msg.charh =3D msg.charh+bToken[z+2]
+				end
+				skipnexttoken=3D2
+			end
+		elseif (command =3D=3D "br") then
+			msg.text =3D msg.text.."\n"
+		elseif (command =3D=3D "center") then
+			msg.center =3D true
+		elseif (command =3D=3D "b") then
+			msg.bold =3D true
+		elseif (command =3D=3D "big") then
+			msg.bold =3D true
+		elseif (command =3D=3D "u") then
+			msg.underline =3D true
+		elseif (command =3D=3D "i") then
+			msg.italic =3D true
+		elseif (command =3D=3D "div") then
+			msg.div=3D 1
+			if (table.getn(bToken) >=3D z+2) then
+				if (string.lower(bToken[z+1])=3D=3D"align") then
+					if (string.lower(bToken[z+2])=3D=3D"left") then
+						msg.div=3D2
+						skipnexttoken=3Dskipnexttoken+1
+					elseif (string.lower(bToken[z+2])=3D=3D"right") then
+						msg.div=3D3
+						skipnexttoken=3Dskipnexttoken+1
+					elseif (string.lower(bToken[z+2])=3D=3D"center") then
+						msg.div=3D4
+						skipnexttoken=3Dskipnexttoken+1
+					end
+					skipnexttoken=3Dskipnexttoken+1
+				end
+			end
+		elseif (command =3D=3D "body") then
+			msg.body =3D true
+		elseif (command =3D=3D "font") then
+			msg.font =3D ""
+		elseif (command =3D=3D "a") then
+			if (table.getn(bToken)>=3D z+2) then
+				if (string.lower(bToken[z+1])=3D=3D"href") then
+					-- TODO: get URL
+					skipnexttoken=3D2
+				end
+			end
+		else
+			msg.text=3Dmsg.text.." "..bToken[z]
+		end
+		=

+		else
+			skipnexttoken =3D skipnexttoken - 1
+		end
+	end
+
+--	printdebug("gump","formated-html-string: "..msg.text)
+	return msg
+end
+
+local function ServerSideGump_GetParams (dialogId)
 	local params =3D {}
 	params.switches =3D {}
 	params.texts =3D {}
@@ -49,6 +146,8 @@
 end
 =

 function GumpParser(Gumpdata)
+	local htext_correction=3D5
+
 	if (not gGumpLoader) then return end
 =

 	-- close already existing dialog with the same id
@@ -58,20 +157,21 @@
 =

 	-- create new Dialog
 	local dialog =3D guimaker.MakeSortedDialog()
-	--print("create gump")
 =

 	-- set Dialog ID / Serial
 	dialog.dialogId =3D Gumpdata.dialogId
-	--print("dialogID=3D"..dialog.dialogId)
+	=

+	-- if dialogid is a clientside dialog (found in clientside dialoglist)...=
 turn of send packets and turn on function handler
+	--if dialog.dialogId =3D "paperdoll" then
+	--	gClientsideManualGump=3Dtrue
+	--end
 =

 	dialog.Close =3D function (dialog)
-	--print("Close:dialogID=3D"..dialog.dialogId)
 		gGumpPosition[dialog.dialogId] =3D { x=3Ddialog.rootwidget.gfx:GetDerive=
dLeft() , y=3Ddialog.rootwidget.gfx:GetDerivedTop() }
         dialog:SetVisible(false)
 		gServerSideGump[dialog.dialogId] =3D nil
 		dialog:Destroy()
 		dialog =3D nil
-		--print("close / destory gump")
 	end
 =

 	dialog.controls =3D {} -- associative list of controlls, key=3Dname of co=
ntroll
@@ -178,7 +278,7 @@
 			elseif ((command =3D=3D "xmfhtmlgump") and (table.getn(bToken)>=3D 8)) =
then
 				local msg =3D HtmlParser( gClilocLoader and gClilocLoader:Get(bToken[6=
]) or "no_cliloc" )
 				printdebug("gump","Cliloc Msg ("..bToken[6].."): "..msg.text)
-				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+gHorizontal_Textcorrection,
+				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {1.=
0,1.0,1.0,1.0},
 																msg.center, msg.div, gFontNameDefault)
 			--xmfhtmlgumpcolor <x> <y> <width> <height> <cliloc-nr> <background> <s=
crollbar> <color>
@@ -188,7 +288,7 @@
 			elseif ((command =3D=3D "xmfhtmlgumpcolor") and (table.getn(bToken)>=3D=
 9)) then
 				local msg =3D HtmlParser(  gClilocLoader and gClilocLoader:Get(bToken[=
6]) or "no_cliloc" )
 				printdebug("gump","Cliloc Msg ("..bToken[6].."): "..msg.text)
-				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+gHorizontal_Textcorrection,
+				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {1.=
0,1.0,1.0,1.0},
 																msg.center, msg.div, gFontNameDefault)
 			--gumppic <x> <y> <gumpid> [hue=3D353]
@@ -216,7 +316,7 @@
 			-- TODO : HUE-color
 			elseif ((command =3D=3D "text") and (table.getn(bToken)>=3D 5)) then
 				local text =3D Gumpdata.textline[tonumber(bToken[5])] or "No text"
-				local widget =3D guimaker.MakeText (curparent, bToken[2], bToken[3]+gH=
orizontal_Textcorrection, UnicodeFix(text),
+				local widget =3D guimaker.MakeText (curparent, bToken[2], bToken[3]+ht=
ext_correction, UnicodeFix(text),
 													gFontGumpSize, {190/255,237/255,231/255,1.0}, gFontNameDefaul=
t)
 			--Button <x> <y> <released-id> <pressed-id> <quit> <page-id> <return-va=
lue>
 			--Description:  Adds a button to the gump with the specified coordinate=
s and button graphics.
@@ -295,7 +395,7 @@
 			-- TODO : HUE
 			elseif ((command =3D=3D "croppedtext") and (table.getn(bToken)>=3D 7)) =
then
 				local msg =3D HtmlParser( Gumpdata.textline[tonumber(bToken[7])] )
-				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+gHorizontal_Textcorrection,
+				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {92=
/255,92/255,178/255,1.0},
 																msg.center, msg.div, gFontNameDefault)
 			--radio <x> <y> <released gumpid> <pressed gumpid> <status> <return-val=
ue>
@@ -374,7 +474,7 @@
 			--{ htmlgump 10 8 100 20 0 0 0 }
 			elseif ((command =3D=3D "htmlgump") and (table.getn(bToken)>=3D 7)) then
 				local msg =3D HtmlParser( Gumpdata.textline[tonumber(bToken[6])] )
-				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+gHorizontal_Textcorrection,
+				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], msg.text, msg.charh, {1.0,1.0,1.0,1.=
0},
 																msg.center, msg.div, gFontNameDefault)
 			--tooltip <cliloc-nr>
@@ -408,102 +508,3 @@
 	-- TODO : set correct Alpha Value
 	--SetDialogAlpha(dialog, 1.0)
 end
-
--- simple html parser (only center,basefont,br and color tags yep realized)
--- TODO : BODY, <A HREF=3D"HTTP://www.polserver.com">This is a link</A>
-function HtmlParser(textstring)
-	local msg =3D {}
-	msg.text =3D ""
-	msg.center =3D false
-	msg.hue =3D ""
-	msg.charh =3D gFontGumpSize	--standard
-	msg.bold =3D false
-	msg.underline =3D false
-	msg.italic =3D false
-	msg.div =3D 0			--div=3D1, right=3D2, left=3D3, center=3D4
-	msg.body =3D false
-	msg.font =3D ""
-	msg.href =3D ""
-
-	if (not(textstring)) then return msg end
-
-	local bToken =3D {}
-
-	--extract tokens
-	for token in string.gfind(textstring, "%w+") do table.insert(bToken,token=
) end
-
-	-- if > 0 it skips the next tokens
-	local skipnexttoken =3D 0
-	=

-	--parse tokens
-	for z=3D1, table.getn(bToken) do
-		local command =3D string.lower(bToken[z])
-
-		if (skipnexttoken <=3D 0) then
-
-		if (command =3D=3D "basefont" ) then
-			if (table.getn(bToken)>=3D z+2) then
-				if (string.lower(bToken[z+1])=3D=3D"color") then
-					--could be a hex value "msg_hue: 0xFFFFFF" or a colorname like "msg_h=
ue: 0xYELLOW"
-					msg.hue =3D "0x"..bToken[z+2]
-				end
-				skipnexttoken=3D2
-			end
-			if (table.getn(bToken)>=3D z+2) then
-				if (string.lower(bToken[z+1])=3D=3D"size") then
-					msg.charh =3D msg.charh+bToken[z+2]
-				end
-				skipnexttoken=3D2
-			end
-		elseif (command =3D=3D "br") then
-			msg.text =3D msg.text.."\n"
-		elseif (command =3D=3D "center") then
-			msg.center =3D true
-		elseif (command =3D=3D "b") then
-			msg.bold =3D true
-		elseif (command =3D=3D "big") then
-			msg.bold =3D true
-		elseif (command =3D=3D "u") then
-			msg.underline =3D true
-		elseif (command =3D=3D "i") then
-			msg.italic =3D true
-		elseif (command =3D=3D "div") then
-			msg.div=3D 1
-			if (table.getn(bToken) >=3D z+2) then
-				if (string.lower(bToken[z+1])=3D=3D"align") then
-					if (string.lower(bToken[z+2])=3D=3D"left") then
-						msg.div=3D2
-						skipnexttoken=3Dskipnexttoken+1
-					elseif (string.lower(bToken[z+2])=3D=3D"right") then
-						msg.div=3D3
-						skipnexttoken=3Dskipnexttoken+1
-					elseif (string.lower(bToken[z+2])=3D=3D"center") then
-						msg.div=3D4
-						skipnexttoken=3Dskipnexttoken+1
-					end
-					skipnexttoken=3Dskipnexttoken+1
-				end
-			end
-		elseif (command =3D=3D "body") then
-			msg.body =3D true
-		elseif (command =3D=3D "font") then
-			msg.font =3D ""
-		elseif (command =3D=3D "a") then
-			if (table.getn(bToken)>=3D z+2) then
-				if (string.lower(bToken[z+1])=3D=3D"href") then
-					-- TODO: get URL
-					skipnexttoken=3D2
-				end
-			end
-		else
-			msg.text=3Dmsg.text.." "..bToken[z]
-		end
-		=

-		else
-			skipnexttoken =3D skipnexttoken - 1
-		end
-	end
-
---	printdebug("gump","formated-html-string: "..msg.text)
-	return msg
-end

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Wed Mar  5 21:42:33 2008
@@ -1,4 +1,4 @@
-function BindGeneralKeys ()
+local function BindGeneralKeys ()
 	Bind("escape",	function (state) =

 			if (state > 0) then =

 			if (not gActiveEditText) then =

@@ -9,8 +9,6 @@
 			end =

 		end)
 end
-
-BindGeneralKeys()
 =

 function BindInGameKeys()
 	UnbindAll()
@@ -72,7 +70,36 @@
 			--Send_AOSCommand(kPacket_AOS_Command_WeaponAbilityRequest,hex2num("0x1=
"),2)
 		 end end end)
 	=

-		Bind("f2",		function (state) if (not gActiveEditText) then if (state > 0=
) then =

+		Bind("f2",		function (state) if (not gActiveEditText) then if (state > 0=
) then
+-- Created 05.03.2008 15:55:43, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local manualGump =3D {}
+manualGump.dialogId =3D 1234
+manualGump.x =3D 10
+manualGump.x =3D 10
+manualGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 4 4 2000  }" ..
+	 "{ gumppic 10 17 12  }" ..
+	 "{ button 187 50 2031 2032 1 0 0 }" ..
+	 "{ button 187 76 2006 2007 1 0 0 }" ..
+	 "{ text 36 271 0 0 }" ..
+	 "{ button 84 6 113 113 1 0 0 }" ..
+	 "{ button 187 102 2009 2010 1 0 0 }" ..
+	 "{ button 187 130 22453 22455 1 0 0 }" ..
+	 "{ button 187 156 2015 2016 1 0 0 }" ..
+	 "{ button 187 181 22450 22452 1 0 0 }" ..
+	 "{ button 187 205 2021 2022 1 0 0 }" ..
+	 "{ button 187 233 2027 2028 1 0 0 }" ..
+	 "" =

+manualGump.textline =3D {
+	[0] =3D "status_name",
+}
+
+GumpParser( manualGump )
+
+
+--[[
 			local mobile =3D GetPlayerMobile()
 			if mobile then
 				local effect =3D {}
@@ -90,8 +117,7 @@
 				effect.itemid =3D 119--hex2num("0x376A")
 				gCurrentRenderer:AddEffect(effect)
 			end
+]]--
 		end end end)
 	end
-
-
 end

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Wed Mar  5 21:42:33 2008
@@ -472,16 +472,6 @@
 }
 =

 --[[
-	{name,manacost,minskill,description} -- todo : look description up in cli=
loc and store id instead of text
-	samurai_bushido =3D {	=

-		{"Honorable Execution",	0,25,"Attempts to deliver a killing attack to yo=
ur opponent..."},
-		{"Confidence",			10,25,"Places you in a defensive stance of confidence, =
..."},
-		{"Evasion",				10,60,"Puts you in an evasive stance ..."},
-		{"Counter Attack",		5,40,"Places you in a defensive stance that allows y=
ou to automatically counter attack ..."},
-		{"Lightning Strike",	5,50,"An attack with a large bonus to your chance t=
o hit."},
-		{"Momentum Strike",		10,70,"If you strike an opponent with this ability,=
 you will automatically strike another nearby opponent. ..."},
-	}
-	=

 	ninjitsu =3D {
 		{"Focus Attack",	10,30,"Increases both your damage and the percentage ch=
ance for \"hit\" properties on your weapon for one attack"},
 		{"Death Strike",	30,85,"After receiving a Death Strike, if the opponent =
moves more than five steps or five seconds elapses, they will suffer direct=
 damage determined by the attacker's ninjitsu."},



From no-reply at zwischenwelt.org  Thu Mar  6 17:14:23 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 06 Mar 2008 16:14:23 -0000
Subject: [Iris-commit] [IRIS] r1946 - /trunk/lua/main.lua
Message-ID: <20080306161425.78E911C18778@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar  6 17:14:21 2008
New Revision: 1946

Log:
ogre fontinfo export test

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Mar  6 17:14:21 2008
@@ -279,6 +279,15 @@
 	CollectOgreResLocs()
 	SetCursorBaseOffset(0,0)
 =

+	if (true) then
+		local sFontName =3D "TrebuchetMSBold"
+		print("exporting ogre font ...")
+		local sMatName,tGlyphTable =3D ExportOgreFont(sFontName)
+		print("exporting ogre font finished")
+		local f =3D arrfirst(tGlyphTable)
+		print("font into",sMatName,countarr(tGlyphTable),f.left,f.top,f.right,f.=
bottom,f.aspectRatio) -- Fonts/TrebuchetMSBold   133  ...
+	end
+	=

 	------------------------------------------ obsolete, just for testing ---=
--------------------------------
 	-- Lua test because Lua50 should not be compiled full-optimized with VS20=
05 Express (maybe also other compilers)
 	if (true) then LuaBitwiseTest() end



From no-reply at zwischenwelt.org  Thu Mar  6 23:37:50 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 06 Mar 2008 22:37:50 -0000
Subject: [Iris-commit] [IRIS] r1947 - in /trunk:
 data/models/materials/textures.material data/skippedfallbacks.lua
 lua/filter/filter.art.lua lua/main.lua
Message-ID: <20080306223751.17DFA1C18780@zwischenwelt.org>

Author: sience
Date: Thu Mar  6 23:37:50 2008
New Revision: 1947

Log:
-small fixes
-skippedfallbacks added
-repositioning of some meshes

Modified:
    trunk/data/models/materials/textures.material
    trunk/data/skippedfallbacks.lua
    trunk/lua/filter/filter.art.lua
    trunk/lua/main.lua

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Thu Mar  6 23:37:50 2008
@@ -53,6 +53,7 @@
 	{
 		pass =

 		{
+//			alpha_rejection greater_equal 128
 			scene_blend alpha_blend
 			depth_write off
 			depth_check on

Modified: trunk/data/skippedfallbacks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/skippedfallbacks.lua (original)
+++ trunk/data/skippedfallbacks.lua Thu Mar  6 23:37:50 2008
@@ -423,3 +423,6 @@
 RegisterSkippedArtBillboardFallBack(3443) -- 0x0d73 name=3Dleaves
 RegisterSkippedArtBillboardFallBack(3694) -- 0x0e6e name=3Dcannon
 RegisterSkippedArtBillboardFallBack(3691) -- 0x0e6b name=3Dcannon
+RegisterSkippedArtBillboardFallBack(4564) -- 0x11d4 name=3Dbed
+RegisterSkippedArtBillboardFallBack(4565) -- 0x11d5 name=3Dbed
+RegisterSkippedArtBillboardFallBack(4563) -- 0x11d3 name=3Dbed

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Thu Mar  6 23:37:50 2008
@@ -172,6 +172,12 @@
 gArtFilter[3794]=3D{maptoid=3D3793,rotation=3D"x:0,y:0,z:180",xadd=3D0,yad=
d=3D0,zadd=3D0}
 gArtFilter[3789]=3D{maptoid=3D3788,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D0,zadd=3D0}
 =

+-- bed
+gArtFilter[4562]=3D{xadd=3D-1.5,yadd=3D0,zadd=3D0}
+
+--plate
+gArtFilter[2519]=3D{xadd=3D0,yadd=3D0,zadd=3D0.34}
+
 ----------------------------------------------------------------------
 =

 -- Seasonal Dynamic & Static Art Translation (run tiles)	-- eventuell (iTi=
leTypeID + 16384)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Mar  6 23:37:50 2008
@@ -279,7 +279,7 @@
 	CollectOgreResLocs()
 	SetCursorBaseOffset(0,0)
 =

-	if (true) then
+	if (false) then
 		local sFontName =3D "TrebuchetMSBold"
 		print("exporting ogre font ...")
 		local sMatName,tGlyphTable =3D ExportOgreFont(sFontName)
@@ -355,7 +355,7 @@
 =

 	StartMainMenu()
 	=

-	if (true) then
+	if (false) then
 		print("guitest_spritelist")
 		gRenderMan2D =3D CreateRenderManager2D()
 		gRenderMan2D_Dialogs =3D CreateRenderGroup2D(gRenderMan2D)



From no-reply at zwischenwelt.org  Mon Mar 10 01:44:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 10 Mar 2008 00:44:44 -0000
Subject: [Iris-commit] [IRIS] r1948 - in /trunk: bin/ lua/ lua/gui/ lua/obj/
Message-ID: <20080310004445.4056C152400E@zwischenwelt.org>

Author: sience
Date: Mon Mar 10 01:44:39 2008
New Revision: 1948

Log:
-Ogre updated to 1.4.7
-new win32 binary
-journal, paperdoll, status and healthbar uses gumpparser now
-obj.container.lua reorganized and cleaned
-offline mode for lib.gumpparser.lua added

Modified:
    trunk/bin/OgreMain.dll
    trunk/bin/Plugin_CgProgramManager.dll
    trunk/bin/Plugin_ParticleFX.dll
    trunk/bin/RenderSystem_Direct3D9.dll
    trunk/bin/RenderSystem_GL.dll
    trunk/bin/iris2.exe
    trunk/lua/gui/gui.journal.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/gui/gui.status.lua
    trunk/lua/lib.gui.iris.lua
    trunk/lua/lib.gumpparser.lua
    trunk/lua/lib.keybinds.lua
    trunk/lua/obj/obj.container.lua

Modified: trunk/bin/OgreMain.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_CgProgramManager.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_ParticleFX.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_Direct3D9.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_GL.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/gui/gui.journal.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.journal.lua (original)
+++ trunk/lua/gui/gui.journal.lua Mon Mar 10 01:44:39 2008
@@ -1,4 +1,3 @@
-
 --[[
 function RegisterJournalEntryType (name) _G["kEntryType_"..name] =3D name =
end
 =

@@ -30,37 +29,33 @@
 gJournalMaxVisIdx =3D nil
 gJournalMinimized =3D false
 =

-function JournalAddText (name,message)
-	local sys =3D "System:"
-	local nicklen =3D string.len(name)
-	nicklen =3D math.floor(nicklen*0.9)
-	local initprefix =3D ""	=

-	local mytext =3D message	=

-	-- strip "System:"	=

-	local a,b =3D string.find(name, "System", 1, false)
-	if not string.find(name, "System", 1, true) then =

-		mytext =3D name.."> "..mytext
-	end   	=

-	table.insert(gJournalEntries,mytext)
-	JournalUpdateText()
-end
-
---[[
-function JournalUpdateFontSize (size)
-	if size < 8 then size =3D 8 end
-	gFontGumpSize =3D size
-end
-
-function splitlines(str)
-	local t =3D {}
-	for line in string.gfind(str, "[^\n]+") do
-    	table.insert(t, line)
-  	end
-	return t
-end
-]]--
-
-function JournalUpdateText ()
+-- Created 09.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local journalGump =3D {}
+journalGump.dialogId =3D 1234567
+journalGump.x =3D 10
+journalGump.y =3D 50
+journalGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 4 27 2080 }" ..
+	 "{ gumppic 21 64 2081 }" ..
+	 "{ gumppic 21 134 2082 }" ..
+	 "{ gumppic 23 204 2083 }" ..
+	 "{ gumppic 118 36 2090 }" ..
+	 "{ gumppic 38 65 2091 }" ..
+	 "{ gumppic 38 183 2091 }" ..
+	 "{ button 139 4 2093 2093 1 0 journalminimize }" ..
+	 "{ button 139 235 2094 2095 1 0 journalresize }" ..
+	 "{ button 260 77 2088 2088 1 0 0 }" ..
+	 "{ button 254 61 2084 2084 1 0 0 }" ..
+	 "{ button 254 181 2085 2085 1 0 0 }" ..
+	 "{ button 241 181 2092 2092 1 0 0 }"
+journalGump.textline =3D {
+}
+
+local function JournalGetTextBorder () return 40,80,40,50 end
+
+local function JournalUpdateText ()
 	if (not gJournalDialog or not gJournalEntries) then return end
 	local widget =3D gJournalDialog.maintext
 =

@@ -123,7 +118,75 @@
 	end
 end
 =

-function JournalGetTextBorder () return 40,80,40,50 end
+local function RestoreLastState()
+    -- restore last position if available
+    local pref =3D gJournalDialog_Pref
+    local dialog =3D gJournalDialog
+    if (dialog and gJournalMinimized =3D=3D false) then =

+        dialog.rootwidget.gfx:SetPos((pref.x or 0),(pref.y or 0)) =

+        =

+        --dialog:SetDimensions((pref.dx or dialog.resize_max_total_x),(pre=
f.dy or dialog.resize_max_total_y))
+        pref.dx =3D (pref.dx or dialog.resize_max_total_x) - dialog.rootwi=
dget.gfx:GetWidth()
+        pref.dy =3D (pref.dy or dialog.resize_max_total_y) - dialog.rootwi=
dget.gfx:GetHeight()
+        dialog:ResizeDelta(pref.dx,pref.dy)  -- =

+        --dialog:ResizeMaximize()
+        =

+        JournalUpdateText()
+    end
+end
+
+local function CreateJournal_Small ()
+	gJournalDialog =3D guimaker.MakeSortedDialog()
+	local pref =3D gJournalDialog_Pref
+
+	local dialog =3D gJournalDialog
+	dialog.Close 		=3D function(dialog)
+        	gJournalDialog:SetVisible(false)
+        	gJournalDialog:Destroy()
+        	gJournalDialog =3D nil
+	end
+
+	dialog.onMouseDown =3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 2) then gJournalDialog:Close() end
+			if (mousebutton =3D=3D 1) then
+				widget.dialog:BringToFront()
+				gui.StartMoveDialog(widget.dialog.rootwidget)
+            end
+	end
+
+	local root =3D dialog.rootwidget
+	MakeBorderGumpPart( root, 2096, (pref.x or 0), (pref.y or 0))
+
+	for k,widget in pairs(dialog.childs) do
+            widget.mbIgnoreMouseOver =3D false
+    end
+end
+
+local function ToggleJournal_Small () -- produces a small journal scroll i=
con
+	local pref =3D gJournalDialog_Pref
+	if (gJournalDialog) then  =

+        pref.x, pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
+		gJournalDialog:Close()
+		=

+		-- create minimized journal button
+		gJournalMinimized =3D true
+		CreateJournal_Small()
+	end
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
+
+function JournalAddText (name,message)
+	local sys =3D "System"
+	local mytext =3D message	=

+	-- strip "System:"	=

+	local a,b =3D string.find(name, sys, 1, false)
+	if not string.find(name, sys, 1, true) then =

+		mytext =3D name.."> "..mytext
+	end   	=

+	table.insert(gJournalEntries,mytext)
+	JournalUpdateText()
+end
 =

 function ToggleJournal ()
 	local pref =3D gJournalDialog_Pref
@@ -138,7 +201,9 @@
         end
         gJournalMinimized =3D false
         =

-        gJournalDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/journal.gfm=
")
+        -- gJournalDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/journal.=
gfm")
+        gJournalDialog =3D GumpParser( journalGump, true )
+
         -- create text
         local parent =3D gJournalDialog.rootwidget
         local col =3D {1,1,1,1}
@@ -152,8 +217,7 @@
             widget.gfx:SetClip(widget.gfx:GetDerivedLeft(),widget.gfx:GetD=
erivedTop(),iw,ih) =

         end
         -- see also MakeClippedText,SetAutoWrap
-    =

-    =

+
         printdebug("gump",(pref.dx or "dx=3Dnil ").." -dxy- "..(pref.dy or=
 "dy=3Dnil"))
         printdebug("gump",(pref.x or "x=3Dnil ").." -xy- "..(pref.y or "y=
=3Dnil"))
         =

@@ -175,11 +239,9 @@
         end
             =

         -- resize limits
-        dialog.resize_min_total_x,dialog.resize_min_total_y =3D -20,-66	--=
 -100,-66
-        dialog.resize_max_total_x,dialog.resize_max_total_y =3D 60,175	-- =
334,212
-        =

-        =

-    =

+        dialog.resize_min_total_x,dialog.resize_min_total_y =3D 0,-66	 -- =
-20,-66
+        dialog.resize_max_total_x,dialog.resize_max_total_y =3D 0, 120 -- =
 60,175
+
         -- xml attributes to resize params
         for k,widget in pairs(dialog.childs) do
             widget.mbIgnoreMouseOver =3D false
@@ -188,7 +250,7 @@
         end
 			=

         -- minimize btn
-		local widget =3D dialog.controls["journal_minimize"]
+		local widget =3D dialog.controls["journalminimize"]
 		widget.onMouseDown 		=3D function (widget,mousebutton)
 			pref.x,pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
 			local left,top,w,h =3D gJournalDialog:GetLTWH()
@@ -198,7 +260,7 @@
 		end
         =

         -- resize btn
-		local widget =3D dialog.controls["journal_resize"]
+		local widget =3D dialog.controls["journalresize"]
 		widget.onMouseDown              =3D function (widget,mousebutton) =

             if (mousebutton =3D=3D 1) then
                 widget.gfx:SetMaterial(widget.mat_pressed)
@@ -278,61 +340,3 @@
     -- widget.onMouseUp 		=3D function (widget,mousebutton) if (mousebutto=
n =3D=3D 1) then widget.gfx:SetMaterial(widget.mat_normal) end end
 	=

 end	-- function
-
-
-function RestoreLastState()
-    -- restore last position if available
-    local pref =3D gJournalDialog_Pref
-    local dialog =3D gJournalDialog
-    if (dialog and gJournalMinimized =3D=3D false) then =

-        dialog.rootwidget.gfx:SetPos((pref.x or 0),(pref.y or 0)) =

-        =

-        --dialog:SetDimensions((pref.dx or dialog.resize_max_total_x),(pre=
f.dy or dialog.resize_max_total_y))
-        pref.dx =3D (pref.dx or dialog.resize_max_total_x) - dialog.rootwi=
dget.gfx:GetWidth()
-        pref.dy =3D (pref.dy or dialog.resize_max_total_y) - dialog.rootwi=
dget.gfx:GetHeight()
-        dialog:ResizeDelta(pref.dx,pref.dy)  -- =

-        --dialog:ResizeMaximize()
-        =

-        JournalUpdateText()
-    end
-end
-
-function ToggleJournal_Small () -- produces a small journal scroll icon
-	local pref =3D gJournalDialog_Pref
-	if (gJournalDialog) then  =

-        pref.x, pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
-		gJournalDialog:Close()
-		=

-		-- create minimized journal button
-		gJournalMinimized =3D true
-		CreateJournal_Small()
-	end
-end
-
-function CreateJournal_Small ()
-	gJournalDialog =3D guimaker.MakeSortedDialog()
-	local pref =3D gJournalDialog_Pref
-
-	local dialog =3D gJournalDialog
-	dialog.Close 		=3D function(dialog)
-        	gJournalDialog:SetVisible(false)
-        	gJournalDialog:Destroy()
-        	gJournalDialog =3D nil
-	end
-
-	dialog.onMouseDown =3D function (widget,mousebutton)
-			if (mousebutton =3D=3D 2) then gJournalDialog:Close() end
-			if (mousebutton =3D=3D 1) then
-				widget.dialog:BringToFront()
-				gui.StartMoveDialog(widget.dialog.rootwidget)
-            end
-	end
-
-	local root =3D dialog.rootwidget
-	MakeBorderGumpPart( root, 2096, (pref.x or 0), (pref.y or 0))
-
-	for k,widget in pairs(dialog.childs) do
-            widget.mbIgnoreMouseOver =3D false
-    end
-    =

-end

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Mon Mar 10 01:44:39 2008
@@ -2,6 +2,48 @@
 -- see also lib.packet.lua and lib.protocol.lua
 -- see also net.mobile.lua, especially kPacket_Equipped_MOB
 -- mobileserial : also known as character/player id
+
+-- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local playerPaperdoll =3D {}
+playerPaperdoll.dialogId =3D 1234
+playerPaperdoll.x =3D 10
+playerPaperdoll.x =3D 10
+playerPaperdoll.Data =3D
+ "{ page 0 }" ..
+ "{ gumppic 4 4 2000 }" ..
+ "{ button 187 50 2031 2032 1 0 btnhelp }" ..
+ "{ button 187 76 2006 2007 1 0 btnoptions }" ..
+-- "{ croppedtext 36 263 200 40 0 0 paperdollname }" ..
+ "{ text 36 263 0 0 paperdollname }" ..
+ "{ button 84 6 113 113 1 0 btnvirtues }" ..
+ "{ button 187 102 2009 2010 1 0 btnquit }" ..
+ "{ button 187 130 22453 22455 1 0 btnquests }" ..
+ "{ button 187 156 2015 2016 1 0 btnskills }" ..
+ "{ button 187 181 22450 22452 1 0 btnguild }" ..
+ "{ button 187 205 2021 2022 1 0 btnpeace }" ..
+ "{ button 187 233 2027 2028 1 0 btnstatus }"
+playerPaperdoll.textline =3D {
+ [0] =3D "paperdoll_name",
+}
+-- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local npcPaperdoll =3D {}
+npcPaperdoll.dialogId =3D 1235
+npcPaperdoll.x =3D 10
+npcPaperdoll.x =3D 10
+npcPaperdoll.Data =3D
+ "{ page 0 }" ..
+ "{ gumppic 4 4 2001 }" ..
+-- "{ croppedtext 36 263 200 40 0 0 paperdollname }" ..
+ "{ text 36 263 0 0 paperdollname }" ..
+ "{ button 187 233 2027 2028 1 0 btnstatus }"
+npcPaperdoll.textline =3D {
+ [0] =3D "paperdoll_name",
+}
+
+local kGumpBaseId_Male	=3D 50000
+local kGumpBaseId_Female	=3D 60000
 =

 -- WARNING ! this is not a complete list (see gLayerType for that) , e.g. =
kLayer_Mound =3D 0x19 is not in here
 gLayerOrder =3D {
@@ -31,33 +73,167 @@
     hex2num("0x0F")
 }
 =

-kGumpBaseId_Male	=3D 50000
-kGumpBaseId_Female	=3D 60000
-
 -- TODO : admin char paperdoll body broken : bodyid,bodygumpid =3D     987=
     0x03db  : body gump id unknown unknown  ( GM admin robe)
 -- TODO : gump.def must be parsed, simple format
 =

 gPaperdolls =3D {}
 =

-
--- called from kPacket_Open_Paperdoll
-function HandleOpenPaperdoll	(paperdoll)
-	paperdoll.mobileserial	=3D paperdoll.serial
-	paperdoll.Close =3D ClosePaperdoll
-	=

-	-- close old paperdoll
-	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
-	if (oldpaperdoll) then oldpaperdoll:Close() end =

-	=

-	-- register paperdoll
-	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
-	=

-	--AddFadeLines("Open Paperdoll for ["..(paperdoll.mobileserial).."] "..(p=
aperdoll.name or ""))
-	=

-	RebuildPaperdoll(paperdoll)
-end
-
-
+-- from old iris code, src/gui/Paperdoll.cpp, returns bodygumpid,base_id
+-- base_id is usually 50000 for male and 60000 for female models
+-- TODO : we should put this in a seperate file for easy editing
+-- TODO : maybe this comes from Models.txt
+local function GetPaperdollBodyAndBaseID (bodyid)
+	local bodygumpid =3D nil
+	local base_id =3D kGumpBaseId_Male
+
+	--Human-Male Paperdoll
+	if (bodyid =3D=3D 400 or
+		bodyid =3D=3D 744 or  --Necromancy Transfromed Model
+		bodyid =3D=3D 987)	  --GameMaster v2 + GM Robe should be displayed
+	then
+		bodygumpid =3D hex2num("0x0C")
+		base_id =3D kGumpBaseId_Male
+	--Human-Savage_Male
+	elseif (bodyid =3D=3D 183 or
+			bodyid =3D=3D 185 or
+			bodyid =3D=3D 750)
+	then
+		bodygumpid =3D hex2num("0x79")
+		base_id =3D kGumpBaseId_Male
+	--Human-Female Paperdoll
+	elseif (bodyid =3D=3D 401 or
+			bodyid =3D=3D 745)  --Necromancy Transfromed Model
+	then
+		bodygumpid =3D hex2num("0x0D")
+		base_id =3D kGumpBaseId_Female
+	--Human-Savage_Female
+	elseif (bodyid =3D=3D 184 or
+			bodyid =3D=3D 186 or
+			bodyid =3D=3D 751)
+	then
+		bodygumpid =3D hex2num("0x78")
+		base_id =3D kGumpBaseId_Female
+	--Male-Elf Paperdoll
+	elseif (bodyid =3D=3D 605)
+	then
+		bodygumpid =3D hex2num("0x0E")
+		base_id =3D kGumpBaseId_Male
+	--Female-Elf Paperdoll
+	elseif (bodyid =3D=3D 606)
+	then
+		bodygumpid =3D hex2num("0x0F")
+		base_id =3D kGumpBaseId_Female
+	--Lord British
+	elseif (bodyid =3D=3D 990)
+	then
+		bodygumpid =3D hex2num("0x3DE")
+		base_id =3D kGumpBaseId_Male
+	--Blackthorn
+	elseif (bodyid =3D=3D 991)
+	then
+		bodygumpid =3D hex2num("0x3DF")
+		base_id =3D kGumpBaseId_Male
+	--Dupre (wrong paperdoll ?!)
+	elseif (bodyid =3D=3D 994)
+	then
+		bodygumpid =3D hex2num("0x3E2")
+	--Player Ghosts
+	elseif (bodyid =3D=3D 402 or
+			bodyid =3D=3D 403 or
+			bodyid =3D=3D 607 or
+			bodyid =3D=3D 608 or
+			bodyid =3D=3D 970)
+	then
+		bodygumpid =3D hex2num("0x3DB")
+	else
+		-- unknown
+		--bodygumpid =3D hex2num("0x3DF")
+	end
+	return bodygumpid,base_id
+end
+
+-- don't call this directly, use RebuildPaperdoll() instead (need to rebui=
ld completely on change because of layerorder)
+local function CreatePaperdollItemWidget(paperdoll,item,base_id)
+	-- item fields : serial artid layer hue (=3D-1 if not set)
+	local dialog =3D paperdoll.dialog
+	local animid =3D nil
+	local typename =3D ""
+	if (gTileTypeLoader) then
+		local t =3D GetStaticTileType(item.artid)
+		if (t and t.miAnimID) then animid =3D t.miAnimID end
+		if (t) then typename =3D t.msName end
+	end
+
+	if (not animid) then
+		print("WARNING : CreatePaperdollItemWidget : unknown itemtype -> forced =
Crash")
+		Crash()
+		-- TODO : dummy gfx ?
+	end
+	=

+	-- fallback to female
+	-- TODO : SiENcE : local gumpid =3D animid+50000
+	local gumpid =3D animid+base_id
+	if (GetGumpMat(gumpid) =3D=3D "" and base_id =3D=3D kGumpBaseId_Female) t=
hen gumpid =3D animid+kGumpBaseId_Male end -- fallback to male
+	if (item.layer =3D=3D kLayer_Backpack) then gumpid =3D animid+kGumpBaseId=
_Male end -- no female backpack ;)
+	=

+	--print("CreatePaperdollItemWidget",gumpid,item.layer,animid,base_id)
+	local xoff,yoff =3D 9,19
+	local widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, xoff, yoff=
 , 0, 0, 0, item.hue)
+	local bitmask =3D GetGumpBitMask(gumpid)
+	widget:SetBitMask(bitmask)
+	widget.uoPaperdoll =3D paperdoll
+	widget.item =3D item
+	item.widget =3D widget
+	widget.mbIgnoreMouseOver =3D false
+
+	widget.onMouseEnter =3D function () -- item tooltip (clientside,debuginfo=
s)
+							-- TODO : find a cleaner solution to override the mousepick tipp
+							local name =3D GetStaticTileTypeName(item.artid) or ""
+							info =3D sprintf("equipment %s (artid=3D%04x=3D%d)",name,item.artid=
,item.artid)
+							--print("CreatePaperdollItemWidget onMouseEnter ",name,vardump(item=
))
+							-- interesting ? local t =3D GetStaticTileType(item.artid) -- t.miA=
nimID
+							gCurrentRenderer.gMousePickTippOverride =3D info
+							Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
+						end
+
+	widget.onMouseLeave =3D function () =

+		gCurrentRenderer.gMousePickTippOverride =3D false
+		Client_SetBottomLine("")
+	end
+	widget.onMouseDown =3D function (widget,mousebutton) end
+	=

+	if (gTooltipSupport) then
+		widget.tooltip_offx =3D kUOToolTippOffX
+		widget.tooltip_offy =3D kUOToolTippOffY
+		widget.stylesetname =3D gGuiDefaultStyleSet
+		widget.on_simple_tooltip =3D function (widget)
+				local  tooltiptext =3D AosToolTip_GetText(widget.item.serial) or ""
+				return (tooltiptext .. " \n ") or "?"
+			end -- add newline, workaround for tooltip sizecalc bug
+	end
+end
+
+-- destroys old widgets if neccessary
+local function DestroyPaperdollItemWidgets (paperdoll) =

+	if (paperdoll.mobile) then
+		for k,item in pairs(GetMobileEquipmentList(paperdoll.mobile)) do
+			if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
+		end
+	end
+end
+
+-- close dialog and destroys all widgets
+local function ClosePaperdoll (paperdoll)
+	if (paperdoll and paperdoll.dialog) then =

+		DestroyPaperdollItemWidgets(paperdoll)
+		paperdoll.dialog:Destroy()
+		paperdoll.dialog =3D nil
+		gPaperdolls[paperdoll.mobileserial] =3D nil
+		-- TODO : send network message ?
+	end
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
 =

 -- rebuild needed on update to have correct layerorder
 -- paperdoll.bIsPlayer (check if is player or npc)
@@ -71,7 +247,18 @@
 	-- create paperdoll dialog if neccessary
 	local dialog =3D paperdoll.dialog
 	if (not dialog) then
-		dialog =3D CreateGumpDlgFromGfm(paperdoll.bIsPlayer and datapath.."gfm/p=
layer_paperdoll.gfm" or datapath.."gfm/npc_paperdoll.gfm")
+		-- old gfm
+		-- ---------------------------------------------------------------------=
-----
+--		dialog =3D CreateGumpDlgFromGfm(paperdoll.bIsPlayer and datapath.."gfm=
/player_paperdoll.gfm" or datapath.."gfm/npc_paperdoll.gfm")
+		-- new gumpparser
+		-- ---------------------------------------------------------------------=
-----
+		if (paperdoll.bIsPlayer) then
+			dialog =3D GumpParser( playerPaperdoll, true )
+		else
+			dialog =3D GumpParser( npcPaperdoll, true )
+		end
+		-- ---------------------------------------------------------------------=
-----
+
 		paperdoll.dialog =3D dialog
 		dialog.uoPaperdoll =3D paperdoll
 		dialog.rootwidget.gfx:SetPos(120,100)
@@ -83,7 +270,7 @@
 =

 		if (paperdoll.bIsPlayer) then
 			-- requests VirtuesGump
-			dialog.controls["btn_virtues"].onMouseDown =3D function (widget,mousebu=
tton)
+			dialog.controls["btnvirtues"].onMouseDown =3D function (widget,mousebut=
ton)
 														if (mousebutton =3D=3D 1) then
 															widget.gfx:SetMaterial(widget.mat_pressed)
 															print("btn_virtues,GumpReturnMsg : warning ! playerserial m=
ight be wrong here, usually this param is the gump-serial")
@@ -92,8 +279,9 @@
 																		  hex2num("0x00000001"), gPlayerBodySerial)
 														end
 													end
+
 			-- requests AosStats		=

-			dialog.controls["btn_status"].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls["btnstatus"].onMouseDown =3D function (widget,mousebutt=
on)
 														if (mousebutton =3D=3D 1) then
 															widget.gfx:SetMaterial(widget.mat_pressed)
 															ToggleStatusAos()
@@ -101,7 +289,7 @@
 													end
 =

 			-- request QuestGump (must be supported by Serversidegumps)
-			dialog.controls["btn_quests"].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls["btnquests"].onMouseDown =3D function (widget,mousebutt=
on)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																Send_AOSCommand(kPacket_AOS_Command_QuestGumpRequest,gPlay=
erBodySerial)
@@ -109,7 +297,7 @@
 														end
 =

 			-- request GuildGump (must be supported by Serversidegumps)
-			dialog.controls["btn_guild"].onMouseDown =3D function (widget,mousebutt=
on)
+			dialog.controls["btnguild"].onMouseDown =3D function (widget,mousebutto=
n)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																Send_AOSCommand(kPacket_AOS_Command_GuildGumpRequest,gPlay=
erBodySerial)
@@ -117,7 +305,7 @@
 														end
 =

 			-- request Warmode and change the Peace/Warmode Button visual
-			dialog.controls["btn_peace"].onMouseDown =3D function (widget,mousebutt=
on)
+			dialog.controls["btnpeace"].onMouseDown =3D function (widget,mousebutto=
n)
 															if (gActWarmode=3D=3DgWarmode_Normal) then
 																widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
 																widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
@@ -133,42 +321,42 @@
 															end
 														end
 			-- request HelpGump (must be supported by Serversidegumps)
-			dialog.controls["btn_help"].onMouseDown =3D function (widget,mousebutto=
n)
+			dialog.controls["btnhelp"].onMouseDown =3D function (widget,mousebutton)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																Send_RequestHelp()
 															end
 														end
 			-- request skill gump
-			dialog.controls["btn_skills"].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls["btnskills"].onMouseDown =3D function (widget,mousebutt=
on)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																ToggleSkill()
 															end
 														end
-			dialog.controls["btn_quit"].onMouseDown =3D function (widget,mousebutto=
n)
+			dialog.controls["btnquit"].onMouseDown =3D function (widget,mousebutton)
 															if (mousebutton =3D=3D 1) then
 																OpenQuit()
 															end
 														end
-			dialog.controls["btn_scroll"].onMouseDown =3D function (widget,mousebut=
ton)
-															if (mousebutton =3D=3D 1) then
-																AddFadeLines("btn_scroll")
-															end
-														end
-			dialog.controls["btn_party"].onMouseDown =3D function (widget,mousebutt=
on)
-															if (mousebutton =3D=3D 1) then
-																AddFadeLines("btn_party")
-															end
-														end
-			dialog.controls["btn_specialAbilities"].onMouseDown =3D function (widge=
t,mousebutton)
-															if (mousebutton =3D=3D 1) then
-																AddFadeLines("btn_specialAbilities")
-															end
-														end
-			--  TODO : btn_quit
+--			dialog.controls["btnscroll"].onMouseDown =3D function (widget,mousebu=
tton)
+--															if (mousebutton =3D=3D 1) then
+--																AddFadeLines("btn_scroll")
+--															end
+--														end
+--			dialog.controls["btnparty"].onMouseDown =3D function (widget,mousebut=
ton)
+--															if (mousebutton =3D=3D 1) then
+--																AddFadeLines("btn_party")
+--															end
+--														end
+--			dialog.controls["btnspecialAbilities"].onMouseDown =3D function (widg=
et,mousebutton)
+--															if (mousebutton =3D=3D 1) then
+--																AddFadeLines("btn_specialAbilities")
+--															end
+--														end
+
 		else
-			dialog.controls["btn_status"].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls["btnstatus"].onMouseDown =3D function (widget,mousebutt=
on)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																OpenStatus(widget.dialog.uoPaperdoll.mobile)
@@ -177,10 +365,10 @@
 		end
 		for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
 	end
-	=

+
 	-- visually change the Peace/Warmode Button when opening the Paperdoll
 	if (gActWarmode=3D=3DgWarmode_Combat) then
-		local widget =3D dialog.controls["btn_peace"]
+		local widget =3D dialog.controls["btnpeace"]
 		if (widget) then
 			widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
 			widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
@@ -192,10 +380,10 @@
 	local r,g,b =3D GetNotorietyColor(paperdoll.mobile.notoriety)
 =

 	-- update paperdoll name
-	dialog.controls["status_name"].gfx:SetCharHeight(gFontGumpSize + 2)
-	dialog.controls["status_name"].gfx:SetColour( {r,g,b,1.0} )
-	dialog.controls["status_name"].gfx:SetFont(gFontNameDefault)
-	dialog.controls["status_name"].gfx:SetText(paperdoll.name)
+	dialog.controls["paperdollname"].gfx:SetCharHeight(gFontGumpSize + 2)
+	dialog.controls["paperdollname"].gfx:SetColour( {r,g,b,1.0} )
+	dialog.controls["paperdollname"].gfx:SetFont(gFontNameDefault)
+	dialog.controls["paperdollname"].gfx:SetText(paperdoll.name)
 =

 	-- remove old item widgets
 	DestroyPaperdollItemWidgets(paperdoll)
@@ -233,93 +421,11 @@
 	end
 end
 =

--- don't call this directly, use RebuildPaperdoll() instead (need to rebui=
ld completely on change because of layerorder)
-function CreatePaperdollItemWidget(paperdoll,item,base_id)
-	-- item fields : serial artid layer hue (=3D-1 if not set)
-	local dialog =3D paperdoll.dialog
-	local animid =3D nil
-	local typename =3D ""
-	if (gTileTypeLoader) then
-		local t =3D GetStaticTileType(item.artid)
-		if (t and t.miAnimID) then animid =3D t.miAnimID end
-		if (t) then typename =3D t.msName end
-	end
-
-	if (not animid) then
-		print("WARNING : CreatePaperdollItemWidget : unknown itemtype -> forced =
Crash")
-		Crash()
-		-- TODO : dummy gfx ?
-	end
-	=

-	-- fallback to female
-	-- TODO : SiENcE : local gumpid =3D animid+50000
-	local gumpid =3D animid+base_id
-	if (GetGumpMat(gumpid) =3D=3D "" and base_id =3D=3D kGumpBaseId_Female) t=
hen gumpid =3D animid+kGumpBaseId_Male end -- fallback to male
-	if (item.layer =3D=3D kLayer_Backpack) then gumpid =3D animid+kGumpBaseId=
_Male end -- no female backpack ;)
-	=

-	--print("CreatePaperdollItemWidget",gumpid,item.layer,animid,base_id)
-	local xoff,yoff =3D 9,19
-	local widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, xoff, yoff=
 , 0, 0, 0, item.hue)
-	local bitmask =3D GetGumpBitMask(gumpid)
-	widget:SetBitMask(bitmask)
-	widget.uoPaperdoll =3D paperdoll
-	widget.item =3D item
-	item.widget =3D widget
-	widget.mbIgnoreMouseOver =3D false
-
-	widget.onMouseEnter =3D function () -- item tooltip (clientside,debuginfo=
s)
-							-- TODO : find a cleaner solution to override the mousepick tipp
-							local name =3D GetStaticTileTypeName(item.artid) or ""
-							info =3D sprintf("equipment %s (artid=3D%04x=3D%d)",name,item.artid=
,item.artid)
-							--print("CreatePaperdollItemWidget onMouseEnter ",name,vardump(item=
))
-							-- interesting ? local t =3D GetStaticTileType(item.artid) -- t.miA=
nimID
-							gCurrentRenderer.gMousePickTippOverride =3D info
-							Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
-						end
-
-	widget.onMouseLeave =3D function () =

-		gCurrentRenderer.gMousePickTippOverride =3D false
-		Client_SetBottomLine("")
-	end
-	widget.onMouseDown =3D function (widget,mousebutton) end
-	=

-	if (gTooltipSupport) then
-		widget.tooltip_offx =3D kUOToolTippOffX
-		widget.tooltip_offy =3D kUOToolTippOffY
-		widget.stylesetname =3D gGuiDefaultStyleSet
-		widget.on_simple_tooltip =3D function (widget)
-				local  tooltiptext =3D AosToolTip_GetText(widget.item.serial) or ""
-				return (tooltiptext .. " \n ") or "?"
-			end -- add newline, workaround for tooltip sizecalc bug
-	end
-end
-
-
--- destroys old widgets if neccessary
-function DestroyPaperdollItemWidgets (paperdoll) =

-	if (paperdoll.mobile) then
-		for k,item in pairs(GetMobileEquipmentList(paperdoll.mobile)) do
-			if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
-		end
-	end
-end
-
 -- triggered by mobile destruction
 function DestroyPaperdollByMobileSerial (serial)
 	local paperdoll =3D gPaperdolls[serial]
 	if (not paperdoll) then return end
 	ClosePaperdoll(paperdoll)
-end
-
--- close dialog and destroys all widgets
-function ClosePaperdoll (paperdoll)
-	if (paperdoll and paperdoll.dialog) then =

-		DestroyPaperdollItemWidgets(paperdoll)
-		paperdoll.dialog:Destroy()
-		paperdoll.dialog =3D nil
-		gPaperdolls[paperdoll.mobileserial] =3D nil
-		-- TODO : send network message ?
-	end
 end
 =

 -- TODO : Clean
@@ -347,80 +453,20 @@
 	end
 end
 =

--- from old iris code, src/gui/Paperdoll.cpp, returns bodygumpid,base_id
--- base_id is usually 50000 for male and 60000 for female models
--- TODO : we should put this in a seperate file for easy editing
--- TODO : maybe this comes from Models.txt
-function GetPaperdollBodyAndBaseID (bodyid)
-	local bodygumpid =3D nil
-	local base_id =3D kGumpBaseId_Male
-
-	--Human-Male Paperdoll
-	if (bodyid =3D=3D 400 or
-		bodyid =3D=3D 744 or  --Necromancy Transfromed Model
-		bodyid =3D=3D 987)	  --GameMaster v2 + GM Robe should be displayed
-	then
-		bodygumpid =3D hex2num("0x0C")
-		base_id =3D kGumpBaseId_Male
-	--Human-Savage_Male
-	elseif (bodyid =3D=3D 183 or
-			bodyid =3D=3D 185 or
-			bodyid =3D=3D 750)
-	then
-		bodygumpid =3D hex2num("0x79")
-		base_id =3D kGumpBaseId_Male
-	--Human-Female Paperdoll
-	elseif (bodyid =3D=3D 401 or
-			bodyid =3D=3D 745)  --Necromancy Transfromed Model
-	then
-		bodygumpid =3D hex2num("0x0D")
-		base_id =3D kGumpBaseId_Female
-	--Human-Savage_Female
-	elseif (bodyid =3D=3D 184 or
-			bodyid =3D=3D 186 or
-			bodyid =3D=3D 751)
-	then
-		bodygumpid =3D hex2num("0x78")
-		base_id =3D kGumpBaseId_Female
-	--Male-Elf Paperdoll
-	elseif (bodyid =3D=3D 605)
-	then
-		bodygumpid =3D hex2num("0x0E")
-		base_id =3D kGumpBaseId_Male
-	--Female-Elf Paperdoll
-	elseif (bodyid =3D=3D 606)
-	then
-		bodygumpid =3D hex2num("0x0F")
-		base_id =3D kGumpBaseId_Female
-	--Lord British
-	elseif (bodyid =3D=3D 990)
-	then
-		bodygumpid =3D hex2num("0x3DE")
-		base_id =3D kGumpBaseId_Male
-	--Blackthorn
-	elseif (bodyid =3D=3D 991)
-	then
-		bodygumpid =3D hex2num("0x3DF")
-		base_id =3D kGumpBaseId_Male
-	--Dupre (wrong paperdoll ?!)
-	elseif (bodyid =3D=3D 994)
-	then
-		bodygumpid =3D hex2num("0x3E2")
-	--Player Ghosts
-	elseif (bodyid =3D=3D 402 or
-			bodyid =3D=3D 403 or
-			bodyid =3D=3D 607 or
-			bodyid =3D=3D 608 or
-			bodyid =3D=3D 970)
-	then
-		bodygumpid =3D hex2num("0x3DB")
-	else
-		-- unknown
-		--bodygumpid =3D hex2num("0x3DF")
-	end
-	return bodygumpid,base_id
-end
-
+-- called from kPacket_Open_Paperdoll
+function HandleOpenPaperdoll	(paperdoll)
+	paperdoll.mobileserial	=3D paperdoll.serial
+	paperdoll.Close =3D ClosePaperdoll
+	=

+	-- close old paperdoll
+	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
+	if (oldpaperdoll) then oldpaperdoll:Close() end =

+	=

+	-- register paperdoll
+	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
+	=

+	RebuildPaperdoll(paperdoll)
+end
 =

 --[[
 =


Modified: trunk/lua/gui/gui.status.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.status.lua (original)
+++ trunk/lua/gui/gui.status.lua Mon Mar 10 01:44:39 2008
@@ -1,3 +1,60 @@
+-- Created 09.03.2008 15:05:13, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local statusGump =3D {}
+statusGump.dialogId =3D 1234
+statusGump.x =3D 0
+statusGump.y =3D 0
+statusGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 0 0 10860 }" ..
+	 "{ text 54 44 0 0 statusname }" ..
+	 "{ text 88 71 0 1 statusstr }" ..
+	 "{ text 88 99 0 2 statusdex }" ..
+	 "{ text 87 127 0 3 statusint }" ..
+	 "{ text 147 67 0 4 statushits }" ..
+	 "{ text 147 77 0 5 statusmaxhits }" ..
+	 "{ text 219 71 0 6 statusstatcap }" ..
+	 "{ text 277 70 0 7 statusminmaxdamage }" ..
+	 "{ text 147 94 0 8 statusstamina }" ..
+	 "{ text 147 105 0 9 statusmaxstamina }" ..
+	 "{ text 148 122 0 10 statusmana }" ..
+	 "{ text 148 133 0 11 statusmaxmana }" ..
+	 "{ text 218 99 0 12 statusluck }" ..
+	 "{ text 212 121 0 13 statusweight }" ..
+	 "{ text 212 132 0 14 statusmaxweight }" ..
+	 "{ text 282 99 0 15 statusgold }" ..
+	 "{ text 289 127 0 16 statuspets }" ..
+	 "{ text 352 70 0 17 statusarmor }" ..
+	 "{ text 351 85 0 18 statusfireres }" ..
+	 "{ text 353 100 0 19 statuscoldres }" ..
+	 "{ text 353 114 0 20 statuspoisres }" ..
+	 "{ text 352 129 0 21 statusenergres }"
+	 =

+statusGump.textline =3D {
+	[0] =3D "status_name",
+	[1] =3D "status_str",
+	[2] =3D "status_dex",
+	[3] =3D "status_int",
+	[4] =3D "status_hits",
+	[5] =3D "status_maxhits",
+	[6] =3D "status_statcap",
+	[7] =3D "status_minmaxdamage",
+	[8] =3D "status_stamina",
+	[9] =3D "status_maxstamina",
+	[10] =3D "status_mana",
+	[11] =3D "status_maxmana",
+	[12] =3D "status_luck",
+	[13] =3D "status_weight",
+	[14] =3D "status_maxweight",
+	[15] =3D "status_gold",
+	[16] =3D "status_pets",
+	[17] =3D "status_armor",
+	[18] =3D "status_fireres",
+	[19] =3D "status_coldres",
+	[20] =3D "status_poisres",
+	[21] =3D "status_energres",
+}
+
 -- toggles the display of the extended aos stats
 gStatusAosDialog_LastPositionX =3D nil
 gStatusAosDialog_LastPositionY =3D nil
@@ -18,8 +75,10 @@
 	else
 		-- request stats update of player body
 		if gPlayerBodySerial then Send_ClientQuery(gRequest_States,gPlayerBodySe=
rial) end
-	=

-		gStatusAosDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/status_aos.gfm")
+
+		-- old gfm file
+		-- gStatusAosDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/status_aos.g=
fm")
+		gStatusAosDialog =3D GumpParser( statusGump, true )
 =

 		-- restore last positoin if available
 		if gStatusAosDialog_LastPositionX and gStatusAosDialog_LastPositionY the=
n gStatusAosDialog.rootwidget.gfx:SetPos(gStatusAosDialog_LastPositionX, gS=
tatusAosDialog_LastPositionY) end
@@ -42,14 +101,14 @@
 				if m and m.stats then
 					local s =3D m.stats
 					=

-					local l =3D {	str =3D "status_str", dex =3D "status_dex", int =3D "st=
atus_int",
-								curHits =3D "status_hits", 		maxHits =3D "status_maxhits",
-								curMana =3D "status_mana", 		maxMana =3D "status_maxmana",
-								curStamina =3D "status_stamina", 	maxStamina =3D "status_maxstamin=
a",
-								luck =3D "status_luck", 			gold =3D "status_gold",
-								armor =3D "status_armor", 		statcap =3D "status_statcap", fireresi=
st =3D "status_fireres",
-								coldresist =3D "status_coldres", 	poisonresist =3D "status_poisres=
",
-								energyresist =3D "status_energres" }
+					local l =3D {	str =3D "statusstr", dex =3D "statusdex", int =3D "stat=
usint",
+								curHits =3D "statushits", 		maxHits =3D "statusmaxhits",
+								curMana =3D "statusmana", 		maxMana =3D "statusmaxmana",
+								curStamina =3D "statusstamina", 	maxStamina =3D "statusmaxstamina",
+								luck =3D "statusluck", 			gold =3D "statusgold",
+								armor =3D "statusarmor", 		statcap =3D "statusstatcap", fireresist=
 =3D "statusfireres",
+								coldresist =3D "statuscoldres", 	poisonresist =3D "statuspoisres",
+								energyresist =3D "statusenergres" }
 =

 					-- set all textfields (single)
 					for k,v in pairs(l) do
@@ -61,40 +120,40 @@
 =

 					-- set name
 					if m.name then
-						dialog.controls["status_name"].gfx:SetCharHeight(gFontGumpSize)
-						dialog.controls["status_name"].gfx:SetColour({r,g,b,1.0})
-						dialog.controls["status_name"].gfx:SetFont(gFontNameDefault)
-						dialog.controls["status_name"].gfx:SetText(m.name)
+						dialog.controls["statusname"].gfx:SetCharHeight(gFontGumpSize)
+						dialog.controls["statusname"].gfx:SetColour({r,g,b,1.0})
+						dialog.controls["statusname"].gfx:SetFont(gFontNameDefault)
+						dialog.controls["statusname"].gfx:SetText(m.name)
 					else
-						dialog.controls["status_name"].gfx:SetCharHeight(gFontGumpSize)
-						dialog.controls["status_name"].gfx:SetColour({r,g,b,1.0})
-						dialog.controls["status_name"].gfx:SetFont(gFontNameDefault)
-						dialog.controls["status_name"].gfx:SetText("?")
+						dialog.controls["statusname"].gfx:SetCharHeight(gFontGumpSize)
+						dialog.controls["statusname"].gfx:SetColour({r,g,b,1.0})
+						dialog.controls["statusname"].gfx:SetFont(gFontNameDefault)
+						dialog.controls["statusname"].gfx:SetText("?")
 					end
 =

 					-- multi part textfields, like "10 / 20"
 					-- pets
 					if s["curPet"] and s["maxPet"] then =

-						dialog.controls["status_pets"].gfx:SetText(s["curPet"].."/"..s["maxP=
et"]) =

-					else dialog.controls["status_pets"].gfx:SetText("?") end =

+						dialog.controls["statuspets"].gfx:SetText(s["curPet"].."/"..s["maxPe=
t"]) =

+					else dialog.controls["statuspets"].gfx:SetText("?") end =

 					-- damage
 					if s["minDamage"] and s["maxDamage"] then =

-						dialog.controls["status_minmaxdamage"].gfx:SetText(s["minDamage"].."=
-"..s["maxDamage"]) =

-					else dialog.controls["status_minmaxdamage"].gfx:SetText("?") end =

+						dialog.controls["statusminmaxdamage"].gfx:SetText(s["minDamage"].."-=
"..s["maxDamage"]) =

+					else dialog.controls["statusminmaxdamage"].gfx:SetText("?") end =

 					-- weight
 					if s["curWeight"] then =

 						if s["maxWeight"] then =

 							-- max weight given
-							dialog.controls["status_weight"].gfx:SetText(s["curWeight"])
-							dialog.controls["status_maxweight"].gfx:SetText(s["maxWeight"])
+							dialog.controls["statusweight"].gfx:SetText(s["curWeight"])
+							dialog.controls["statusmaxweight"].gfx:SetText(s["maxWeight"])
 						else =

 							-- no maxweight present
-							dialog.controls["status_weight"].gfx:SetText(s["curWeight"]) =

+							dialog.controls["statusweight"].gfx:SetText(s["curWeight"]) =

 							-- hardcoded fallback: 40 + floor(str*35/10)
-							dialog.controls["status_maxweight"].gfx:SetText(""..
+							dialog.controls["statusmaxweight"].gfx:SetText(""..
 								(40 + math.floor(s["str"]*35/10)))
 						end
-					else dialog.controls["status_weight"].gfx:SetText("?") end =

+					else dialog.controls["statusweight"].gfx:SetText("?") end =

 				end
 			end
 		end

Modified: trunk/lua/lib.gui.iris.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gui.iris.lua (original)
+++ trunk/lua/lib.gui.iris.lua Mon Mar 10 01:44:39 2008
@@ -1,3 +1,37 @@
+-- Created 09.03.2008 16:33:50, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local healthbarGump =3D {}
+healthbarGump.dialogId =3D 1234
+healthbarGump.x =3D 0
+healthbarGump.y =3D 0
+healthbarGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 0 0 2051 statusbar }" ..
+	 "{ gumppic 35 11 2053 }" ..
+	 "{ gumppic 35 25 2053 }" ..
+	 "{ gumppic 35 39 2053 }" ..
+	 "{ gumppic 35 11 2054 hitsbar }" ..
+	 "{ gumppic 35 25 2054 manabar }" ..
+	 "{ gumppic 35 39 2054 stambar }"
+healthbarGump.textline =3D {
+}
+
+-- Created 09.03.2008 16:52:23, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local npchealthGump =3D {}
+npchealthGump.dialogId =3D 1234
+npchealthGump.x =3D 0
+npchealthGump.y =3D 0
+npchealthGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 0 0 2052 statusbar }" ..
+	 "{ gumppic 35 38 2053 }" ..
+	 "{ gumppic 35 38 2054 hitsbar }" ..
+	 "{ text 20 10 0 0 npcname }"
+npchealthGump.textline =3D {
+	[0] =3D "npc_name",
+}
+
 gui =3D gui or {}
 gui.bMouseBlocked =3D false
 =

@@ -97,7 +131,7 @@
 		-- find player status dialog
 		local dialog =3D gStatusDialogs[gPlayerBodySerial]
 =

-		local widget =3D dialog.controls and dialog.controls["status_bar"]
+		local widget =3D dialog.controls and dialog.controls["statusbar"]
 		if (widget) then
 			local mat =3D GetGumpMat(warmode =3D=3D gWarmode_Normal and gWargump_No=
rmal or gWargump_Combat)
 			widget.mat_over =3D mat
@@ -145,15 +179,16 @@
 =

 -- Open Status Gump
 function OpenStatus (mobile,x,y)
-	-- set default parameter
-	x =3D x or 10
-	y =3D y or 60
-	=

 	if mobile =3D=3D nil then return end
 	if (gStatusDialogs[mobile.serial]) then return end -- already open =

 	=

-	local dialog =3D CreateGumpDlgFromGfm(IsPlayerMobile(mobile) and datapath=
.."gfm/healthbar.gfm" or datapath.."gfm/healthbar_npc.gfm")
-	=

+	--local dialog =3D CreateGumpDlgFromGfm(IsPlayerMobile(mobile) and datapa=
th.."gfm/healthbar.gfm" or datapath.."gfm/healthbar_npc.gfm")
+	local dialog =3D GumpParser( IsPlayerMobile(mobile) and healthbarGump or =
npchealthGump, true )
+
+	-- set default parameter
+	x =3D x or healthbarGump.x
+	y =3D y or healthbarGump.y
+
 	-- widgets in this dialog handle mouse
 	for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
 	=

@@ -169,10 +204,10 @@
 	local r,g,b =3D GetNotorietyColor(mobile.notoriety)
 =

 	if not(IsPlayerMobile(mobile)) then
-		dialog.controls["npc_name"].gfx:SetCharHeight(gFontGumpSize)
-		dialog.controls["npc_name"].gfx:SetColour({r,g,b,1.0})
-		dialog.controls["npc_name"].gfx:SetFont(gFontNameDefault)
-		dialog.controls["npc_name"].gfx:SetText(mobile.name)
+		dialog.controls["npcname"].gfx:SetCharHeight(gFontGumpSize)
+		dialog.controls["npcname"].gfx:SetColour({r,g,b,1.0})
+		dialog.controls["npcname"].gfx:SetFont(gFontNameDefault)
+		dialog.controls["npcname"].gfx:SetText(mobile.name)
 	end
 =

 	gStatusDialogs[mobile.serial] =3D dialog

Modified: trunk/lua/lib.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gumpparser.lua (original)
+++ trunk/lua/lib.gumpparser.lua Mon Mar 10 01:44:39 2008
@@ -145,13 +145,13 @@
 	dialog:Close()
 end
 =

-function GumpParser(Gumpdata)
+function GumpParser(Gumpdata, Clientsidemode)
 	local htext_correction=3D5
 =

 	if (not gGumpLoader) then return end
 =

 	-- close already existing dialog with the same id
-	if gServerSideGump[Gumpdata.dialogId] then
+	if not(Clientsidemode) and gServerSideGump[Gumpdata.dialogId] then
 		CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, 0)
 	end
 =

@@ -296,12 +296,12 @@
 			--				Optionaly there is a color parameter. =

 			-- TODO : HUE
 			elseif ((command =3D=3D "gumppic") and (table.getn(bToken)>=3D 4)) then
-				local huenumber=3DbToken[6] or 0
+				local huenumber =3D 0
+				if (bToken[5] =3D=3D hue) then huenumber=3DbToken[6] end
 				local widget =3D MakeBorderGumpPart( curparent, bToken[4], bToken[2], =
bToken[3], 0, 0, 0, tonumber(huenumber) )
 				widget.mbIgnoreMouseOver =3D false
-				if (bToken[8]) then
-					printdebug("gump","gumppic class=3D"..bToken[8])
-				end
+				if (Clientsidemode) then if (bToken[5]) then dialog.controls[bToken[5]=
] =3D widget end end
+				--if (bToken[8]) then printdebug("gump","gumppic class=3D"..bToken[8])=
 end
 			--gumppictiled <x> <y> <width> <height> <gumpid>
 			--Description:  Similar to GumpPic, but the gumppic is tiled to the giv=
en <height> and <width>.
 			elseif ((command =3D=3D "gumppictiled") and (table.getn(bToken)>=3D 6))=
 then
@@ -311,31 +311,42 @@
 			--Description:  Creates a transparent rectangle on position <x,y> using=
 <width> and <height>.
 			elseif ((command =3D=3D "checkertrans") and (table.getn(bToken)>=3D 5))=
 then
 				printdebug("gump","todo - checkertrans")
+				-- TODO : set correct Alpha Value
+				--SetDialogAlpha(dialog, 1.0)
 			--text <x> <y> <hue> <textline-id>
 			--Description:  Defines the position and color of a text (data) entry.
 			-- TODO : HUE-color
 			elseif ((command =3D=3D "text") and (table.getn(bToken)>=3D 5)) then
 				local text =3D Gumpdata.textline[tonumber(bToken[5])] or "No text"
+
 				local widget =3D guimaker.MakeText (curparent, bToken[2], bToken[3]+ht=
ext_correction, UnicodeFix(text),
 													gFontGumpSize, {190/255,237/255,231/255,1.0}, gFontNameDefaul=
t)
+
+				if (Clientsidemode) then if (bToken[6]) then dialog.controls[bToken[6]=
] =3D widget end end
 			--Button <x> <y> <released-id> <pressed-id> <quit> <page-id> <return-va=
lue>
 			--Description:  Adds a button to the gump with the specified coordinate=
s and button graphics.
 			--				<released-id> and <pressed-id> specify the buttongraphic. If pres=
sed check for <return-value>.
 			--				Use <page-id> to switch between pages and <quit>=3D1/0 to close t=
he gump.
 			elseif ((command =3D=3D "button") and (table.getn(bToken)>=3D 7)) then	=
-- >=3D7 because pol buttons returns 7 or 8 arguments
 				local widget =3D MakeGumpButton (curparent,bToken[4],bToken[4],bToken[=
5],bToken[2],bToken[3],nil,nil,false)
-				if (bToken[8]) then widget.returnmsg =3D tonumber(bToken[8]) end
+				if (bToken[8]) then widget.returnmsg =3D bToken[8] end
 				widget.page			=3D tonumber(bToken[7])
-				widget.onLeftClick =3D function (widget)
-										if (widget.page > 0 and not(widget.page > table.getn(pages)) ) t=
hen
-											printdebug("gump","Parsegump Button: Switch to Page "..widget.p=
age.."/"..table.getn(pages))
-											widget.dialog:ShowPage(widget.page)
-										elseif (widget.returnmsg) then
-											printdebug("gump","Button pressed -> Send button return_message=
: "..widget.returnmsg)
-											GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.retu=
rnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
-											widget.dialog:Close()
+
+				if (Clientsidemode) then
+					dialog.controls[widget.returnmsg] =3D widget
+				else
+					widget.onLeftClick =3D function (widget)
+											if (widget.page > 0 and not(widget.page > table.getn(pages)) ) =
then
+												printdebug("gump","Parsegump Button: Switch to Page "..widget.=
page.."/"..table.getn(pages))
+												widget.dialog:ShowPage(widget.page)
+											elseif (widget.returnmsg) then
+												printdebug("gump","Button pressed -> Send button return_messag=
e: "..widget.returnmsg)
+												GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
+												widget.dialog:Close()
+											end
 										end
-									end
+				end
+
 			--buttontileart <x> <y> <released-id> <pressed-id> <quit> <page-id> <re=
turn-value> <tilepic-id> <hue> <tile-x> <tile-y>
 			--Client introduced: between 4.0.4d and 5.0.2b
 			--Description:  Adds a button to the gump with the specified coordinate=
s and tilepic as graphic.
@@ -346,18 +357,21 @@
 				local widgetart =3D MakeArtGumpPart (curparent,bToken[9],bToken[2]+bTo=
ken[11],bToken[3]+bToken[12],0,0,0,bToken[10])
 				if (bToken[8]) then widget.returnmsg =3D tonumber(bToken[8]) end
 				widget.page			=3D tonumber(bToken[7])
-				widget.onLeftClick =3D function (widget)
-										if (widget.returnmsg) then
-											printdebug("gump","Button pressed -> Send buttontileart return_=
message: "..widget.returnmsg)
-											GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.retu=
rnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
+
+				if not(Clientsidemode) then
+					widget.onLeftClick =3D function (widget)
+											if (widget.returnmsg) then
+												printdebug("gump","Button pressed -> Send buttontileart return=
_message: "..widget.returnmsg)
+												GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
+											end
+											if (widget.page > 0 and not(widget.page > table.getn(pages)) ) =
then
+												printdebug("gump","Parsegump Button: Switch to Page "..widget.=
page.."/"..table.getn(pages))
+												widget.dialog:ShowPage(widget.page)
+											else
+												widget.dialog:Close()
+											end
 										end
-										if (widget.page > 0 and not(widget.page > table.getn(pages)) ) t=
hen
-											printdebug("gump","Parsegump Button: Switch to Page "..widget.p=
age.."/"..table.getn(pages))
-											widget.dialog:ShowPage(widget.page)
-										else
-											widget.dialog:Close()
-										end
-									end
+				end
 			--textentry <x> <y> <width> <height> <hue> <return-value> <default-text=
-id>
 			--Description:  Defines an area where the <default-text-id> is displaye=
d.
 			--				The player can modify this data. To get this data check the <retu=
rn-value>.
@@ -370,16 +384,18 @@
 				widget.mbIgnoreMouseOver =3D false
 				widget.returnmsg =3D tonumber(bToken[7])
 				widget.returndefid =3D tonumber(bToken[8])
-				widget.onMouseDown =3D function (widget,mousebutton)
-											if (mousebutton =3D=3D 1) then
-												widget:Activate()
+
+				if not(Clientsidemode) then
+					widget.onMouseDown =3D function (widget,mousebutton)
+												if (mousebutton =3D=3D 1) then
+													widget:Activate()
+												end
+										   end
+					widget.onMouseLeave =3D function (widget)
+												widget:Deactivate()
 											end
-									   end
-				widget.onMouseLeave =3D function (widget)
-											widget:Deactivate()
-										end
+				end
 				table.insert(dialog.uo_text,widget)
-					=

 			--tilepic <x> <y> <id>
 			--Description:  Adds a Tilepicture to the gump. <id> defines the tile g=
raphic-id.
 			elseif ((command =3D=3D "tilepic") and (table.getn(bToken)>=3D4)) then
@@ -398,6 +414,7 @@
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {92=
/255,92/255,178/255,1.0},
 																msg.center, msg.div, gFontNameDefault)
+				if (Clientsidemode) then if (bToken[8]) then dialog.controls[bToken[8]=
] =3D widget end end
 			--radio <x> <y> <released gumpid> <pressed gumpid> <status> <return-val=
ue>
 			--Description:  Same as Checkbox, but only one Radiobutton can be press=
ed at the same time, except they are per linked via the 'Group' command.
 			-- TODO : make radio buttons work
@@ -421,18 +438,21 @@
 				widget.mat_pressed 	=3D GetGumpMat(radio_down)
 =

 				table.insert(dialog.uo_radio,widget)
-				widget.onMouseDown	=3D function (widget,mousebutton)
-										if (mousebutton =3D=3D 1) then
-											if (widget.state=3D=3D0) then
-												widget.gfx:SetMaterial(widget.mat_pressed)
-												widget.state=3D1
-											else
-												widget.gfx:SetMaterial(widget.mat_normal)
-												widget.state=3D0
+
+				if not(Clientsidemode) then
+					widget.onMouseDown	=3D function (widget,mousebutton)
+											if (mousebutton =3D=3D 1) then
+												if (widget.state=3D=3D0) then
+													widget.gfx:SetMaterial(widget.mat_pressed)
+													widget.state=3D1
+												else
+													widget.gfx:SetMaterial(widget.mat_normal)
+													widget.state=3D0
+												end
+												printdebug("gump","RadioButton changed : id=3D"..widget.return=
msg.." state=3D"..widget.state)
 											end
-											printdebug("gump","RadioButton changed : id=3D"..widget.returnm=
sg.." state=3D"..widget.state)
-										end
-									  end
+										  end
+				end
 			--checkbox <x> <y> <released-id> <pressed-id> <status> <return-value>
 			--Description:  Adds a CheckBox to the gump. Multiple CheckBoxes can be=
 pressed at the same time.
 			--				Check the <return-value> if you want to know which CheckBoxes wer=
e selected.
@@ -456,18 +476,20 @@
 				widget.mat_pressed 	=3D GetGumpMat(check_down)
 				table.insert(dialog.uo_check,widget)
 =

-				widget.onMouseDown	=3D function (widget,mousebutton)
-										if (mousebutton =3D=3D 1) then
-											if (widget.state=3D=3D0) then
-												widget.gfx:SetMaterial(widget.mat_pressed)
-												widget.state=3D1
-											else
-												widget.gfx:SetMaterial(widget.mat_normal)
-												widget.state=3D0
+				if not(Clientsidemode) then
+					widget.onMouseDown	=3D function (widget,mousebutton)
+											if (mousebutton =3D=3D 1) then
+												if (widget.state=3D=3D0) then
+													widget.gfx:SetMaterial(widget.mat_pressed)
+													widget.state=3D1
+												else
+													widget.gfx:SetMaterial(widget.mat_normal)
+													widget.state=3D0
+												end
+												printdebug("gump","Checkbox changed : id=3D"..widget.returnmsg=
.." state=3D"..widget.state)
 											end
-											printdebug("gump","Checkbox changed : id=3D"..widget.returnmsg.=
." state=3D"..widget.state)
-										end
-									  end
+										  end
+				end
 			--HtmlGump <x> <y> <width> <height> <text-id> <background> <scrollbar>
 			--Description:  Defines a text-area where Html-commands are allowed.
 			--				<background> and <scrollbar> can be 0 or 1 and define whether the=
 background is transparent and a scrollbar is displayed.
@@ -500,11 +522,12 @@
 		printdebug("gump","ServerSideGump page ",page.pagenum," childs: ",myc)
 	end
 =

-	gServerSideGump[Gumpdata.dialogId] =3D dialog
-
-	-- hide all except page 0 and 1
-	dialog:ShowPage(1)
-	=

-	-- TODO : set correct Alpha Value
-	--SetDialogAlpha(dialog, 1.0)
+	if not(Clientsidemode) then
+		gServerSideGump[Gumpdata.dialogId] =3D dialog
+	=

+		-- hide all except page 0 and 1
+		dialog:ShowPage(1)
+	else
+		return dialog
+	end
 end

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Mon Mar 10 01:44:39 2008
@@ -71,35 +71,6 @@
 		 end end end)
 	=

 		Bind("f2",		function (state) if (not gActiveEditText) then if (state > 0=
) then
--- Created 05.03.2008 15:55:43, with GumpStudio & Iris2 Lua Export Plugin
--- Exported Iris2 GumpExporter ver 1.0.
-local manualGump =3D {}
-manualGump.dialogId =3D 1234
-manualGump.x =3D 10
-manualGump.x =3D 10
-manualGump.Data =3D
-	 "{ page 0 }" ..
-	 "{ gumppic 4 4 2000  }" ..
-	 "{ gumppic 10 17 12  }" ..
-	 "{ button 187 50 2031 2032 1 0 0 }" ..
-	 "{ button 187 76 2006 2007 1 0 0 }" ..
-	 "{ text 36 271 0 0 }" ..
-	 "{ button 84 6 113 113 1 0 0 }" ..
-	 "{ button 187 102 2009 2010 1 0 0 }" ..
-	 "{ button 187 130 22453 22455 1 0 0 }" ..
-	 "{ button 187 156 2015 2016 1 0 0 }" ..
-	 "{ button 187 181 22450 22452 1 0 0 }" ..
-	 "{ button 187 205 2021 2022 1 0 0 }" ..
-	 "{ button 187 233 2027 2028 1 0 0 }" ..
-	 "" =

-manualGump.textline =3D {
-	[0] =3D "status_name",
-}
-
-GumpParser( manualGump )
-
-
---[[
 			local mobile =3D GetPlayerMobile()
 			if mobile then
 				local effect =3D {}
@@ -117,7 +88,6 @@
 				effect.itemid =3D 119--hex2num("0x376A")
 				gCurrentRenderer:AddEffect(effect)
 			end
-]]--
 		end end end)
 	end
 end

Modified: trunk/lua/obj/obj.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.container.lua (original)
+++ trunk/lua/obj/obj.container.lua Mon Mar 10 01:44:39 2008
@@ -18,7 +18,6 @@
 function gContainerPrototype:GetContent () return self.content end
 =

 function gContainerPrototype:DestroyContent ()
-	--print("gContainerPrototype:DestroyContent",self,self.serial,_TRACEBACK(=
))
 	for serial,object in pairs(self.content) do object:Destroy() end
 	self.content =3D {}
 	self:UpdateContent()
@@ -36,8 +35,72 @@
 	self:UpdateContent()
 end
 =

+-- ----------------------------------------------- container prototype ---=
--------------------------
+
+local function DestroyContainerItemWidgets (container) =

+	for k,item in pairs(container:GetContent()) do
+		if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
+	end
+end
+
+-- create graphical representation (use only if container dialog is alread=
y visible)
+local function MakeContainerItemWidget (item)
+	local parent =3D item.container.dialog.rootwidget
+	local widget =3D nil
+
+	-- If it's not an ART-gfx to display -> Display GUMP-gfx
+	if (item.usegump=3D=3Dtrue) then
+		widget =3D MakeBorderGumpPart (parent,item.artid,item.xloc,item.yloc + i=
tem.gumpyoffset)
+
+		widget.mbIgnoreMouseOver =3D false
+		widget.uoContainer =3D item.container
+		widget.item =3D item
+		item.widget =3D widget
+
+		widget.onMouseLeave =3D function () gCurrentRenderer.gMousePickTippOverr=
ide =3D false end
+		widget.onMouseDown	=3D function (widget,mousebutton) end
+	else
+		widget =3D MakeArtGumpPart (parent,item.artid,item.xloc,item.yloc,0,0,0,=
item.hue)
+		=

+		-- for exact mousepicking
+		widget:SetBitMask( GetArtBitMask(item.artid + hex2num("0x4000")) )
+
+		widget.mbIgnoreMouseOver =3D false
+		widget.uoContainer =3D item.container
+		widget.item =3D item
+		item.widget =3D widget
+
+		-- item debuginfo on mouseover (clientside,debuginfos)
+		widget.onMouseLeave =3D function () =

+			gCurrentRenderer.gMousePickTippOverride =3D false =

+			Client_SetBottomLine("")
+		end
+		widget.onMouseDown	=3D function (widget,mousebutton) end
+		widget.onMouseEnter =3D function ()
+			-- TODO : find a cleaner solution to override the mousepick tipp
+			local item =3D widget.item
+			local name =3D GetStaticTileTypeName(item.artid) or ""
+			info =3D sprintf("item %s amount=3D%d (artid=3D%04x=3D%d)",name,item.am=
ount,item.artid,item.artid)
+			gCurrentRenderer.gMousePickTippOverride =3D info
+			Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
+		end
+	end
+
+	if (gTooltipSupport and widget) then
+		widget.tooltip_offx =3D kUOToolTippOffX
+		widget.tooltip_offy =3D kUOToolTippOffY
+		widget.stylesetname =3D gGuiDefaultStyleSet
+		widget.on_simple_tooltip =3D function (widget) =

+				local tooltiptext =3D AosToolTip_GetText(widget.item.serial) or ""
+				return (tooltiptext .. " \n ") or "?" =

+			end -- add newline, workaround for tooltip sizecalc bug
+	end
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
+
 -- called from kPacket_Equip_Item
-function HandleEquipItem	(dynamicdata)
+function HandleEquipItem (dynamicdata)
 	local mobile =3D GetMobile(dynamicdata.iContainerSerial)
 	if (not mobile) then =

 		print("WARNING ! mobile update for unknown mobile received, update lost =
!")
@@ -63,13 +126,17 @@
 	return container and (container.dialog)
 end
 =

+-- destroys old widgets and creates new ones from contents
+function RefreshContainerItemWidgets (container) =

+	if (container.dialog) then
+		DestroyContainerItemWidgets(container)
+		for k,item in pairs(container:GetContent()) do MakeContainerItemWidget(i=
tem) end
+	end
+end
 =

 -- called from kPacket_Open_Container
 function HandleOpenContainer	(containerdata)
 	if (not gGumpLoader) then return end
-	--containerdata.serial
-	--containerdata.gumpid
-	--print("# HandleOpenContainer",containerdata.serial,containerdata.gumpid)
 	=

 	--Ignore Shop container - created somewhere else
 	if (containerdata.gumpid =3D=3D kGumpIDShopContainer) then
@@ -99,7 +166,6 @@
 	=

 	-- 0x003c =3D backpack
 	-- 0x0030 =3D shopcontainer
-	--AddFadeLines(sprintf("Open_Container gumpid=3D%d",container.gumpid))
 	if (not container.dialog) then
 		-- create dialog from scratch
 		local dialog =3D guimaker.MakeSortedDialog()
@@ -125,7 +191,7 @@
 -- dialog is only created when it is displayed, on kPacket_Open_Container
 -- TODO : check if iContainerSerial is secure trade serial
 -- TODO : check if spellbook
-
+-- destroys old widgets if neccessary
 =

 function CloseContainer (serial) =

 	local container =3D GetContainer(serial)
@@ -149,247 +215,141 @@
 	return container
 end
 =

--- destroys old widgets if neccessary
-function DestroyContainerItemWidgets (container) =

-	for k,item in pairs(container:GetContent()) do
-		if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
-	end
-end
-
--- destroys old widgets and creates new ones from contents
-function RefreshContainerItemWidgets (container) =

-	if (container.dialog) then
-		DestroyContainerItemWidgets(container)
-		for k,item in pairs(container:GetContent()) do MakeContainerItemWidget(i=
tem) end
-	end
-end
-
-
-function ScanItemPropBoolean	(props,line,pattern,field) end
-function ScanItemPropNumber		(props,line,pattern,field) end
-
-gItemPropAOS =3D {
-	{"^luck (%d+)"								,{0}		,"luck"				},	=

-	{"^lower reagent cost (%d+)%%"				,{0}		,"lrc"				},	=

-	{"^lower mana cost (%d+)%%"					,{0}		,"lmc"				},	=

-	{"^defense chance increase (%d+)%%"			,{0}		,"dci"				},	=

-	{"^hit chance increase (%d+)%%"				,{0}		,"hci"				},	=

-	{"^skillbonus_sum"							,0			,"skillbonus_sum"	},-- dummy entry, pattern=
 will never match
-	{"^faster cast recovery (%d+)"				,{0}		,"fastcastrecov"	},	=

-	{"^faster casting (%d+)"					,{0}		,"fastcast"			},	=

-	{"^mage armor"								,false		,"magearmor"		},	=

-	{"^\"Maximum sockets allowed is (%d+).\""	,{0}		,"maxsocket"		},	=

-	{"^mana regeneration (%d+)"					,{0}		,"manareg"			},	=

-	{"^mana increase (%d+)"						,{0}		,"manainc"			},	=

-	{"^damage increase (%d+)%%"					,{0}		,"dmginc"			},	=

-	{"^spell damage increase (%d+)%%"			,{0}		,"sdi"				},	=

-	{"^strength bonus (%d+)"					,{0}		,"bonusstr"			},	=

-	{"^dexterity bonus (%d+)"					,{0}		,"bonusdex"			},	=

-	{"^intelligence bonus (%d+)"				,{0}		,"bonusint"			},	=

-	{"^<b>Insured</b>"							,false		,"insured"			},	=

-	{"^self repair (%d+)%%"						,{0}		,"selfrepair"		},	=

-	{"^enhance potions (%d+)%%"					,{0}		,"enhancepotion"	},	=

-	{"^hit point regeneration (%d+)"			,{0}		,"hpreg"			},	=

-	{"^hit point increase (%d+)"				,{0}		,"hpinc"			},	=

-	{"^physical resist (%d+)%%"					,{0}		,"resistphysical"	},	=

-	{"^poison resist (%d+)%%"					,{0}		,"resistpoison"		},	=

-	{"^cold resist (%d+)%%"						,{0}		,"resistcold"		},	=

-	{"^fire resist (%d+)%%"						,{0}		,"resistfire"		},	=

-	{"^energy resist (%d+)%%"					,{0}		,"resistenergy"		},	=

-	{"^strength requirement (%d+)"				,{0}		,"strengthreq"		},
-	{"^durability (%d+) / (%d+)"				,{0,0}		,"durability"		},
-	{"^Weight: (%d+) stones"					,{0}		,"weight"			},	=

-	{"^night sight"								,false		,"nightsight"		},
-}
-	=

---[[
-crafted by Lady Smya,lower requirements 90%,stamina regeneration 2,durabil=
ity 20%,
-reflect physical damage 3%,
-crafted by Lady Smya,reflect physical damage 15%,self repair 3,durability =
20%,
-lower requirements 50%,reflect physical damage 6%,self repair 3,spell chan=
neling,durability 20%,
-physical damage 100%,weapon damage 16 - 17,weapon speed 29,two-handed weap=
on,skill required: swordsmanship,
-hit life leech 6%,physical damage 100%,weapon damage 16 - 18,weapon speed =
25,range 10,two-handed weapon,skill required: archery,"1 Sockets. 1 availab=
le.,Maximum sockets allowed is 2.",Quiver using: Normal,
-hit cold area 10%,hit dispel 10%,hit lower attack 10%,hit mana leech 10%,p=
hysical damage 100%,weapon damage 11 - 13,weapon speed 47,two-handed weapon=
,skill required: mace fighting,
-lower requirements 40%,physical damage 100%,weapon damage 14 - 16,weapon s=
peed 37,two-handed weapon,skill required: fencing,
-lower requirements 20%,physical damage 100%,weapon damage 19 - 20,weapon s=
peed 22,range 8,two-handed weapon,skill required: archery,Quiver using: Nor=
mal,
-faster casting -1,reflect physical damage 3%,spell channeling,
-hit life leech 24%,hit lightning 6%,hit lower attack 6%,swing speed increa=
se 15%,physical damage 100%,weapon damage 14 - 15,weapon speed 33,one-hande=
d weapon,skill required: swordsmanship,
-hit lower attack 14%,hit mana leech 10%,lower requirements 30%,physical da=
mage 100%,weapon damage 11 - 13,weapon speed 46,one-handed weapon,skill req=
uired: swordsmanship,
-
-physical damage 100%,weapon damage 15 - 17,weapon speed 33,two-handed weap=
on,skill required: mace fighting,
-Weapon: +2 Leech Mana, +2 Leech Life,Armor: +1 Mana Regen, +1 Hits Regen,C=
reature: +20 Hits,
-repond slayer,swing speed increase 10%,physical damage 100%,weapon damage =
15 - 17,weapon speed 28,one-handed weapon,skill required: swordsmanship,
-mage weapon -28 skill,physical damage 100%,weapon damage 15 - 17,weapon sp=
eed 33,two-handed weapon,skill required: swordsmanship,
-
-]]--
-
-
-function countmatches (text,searchpattern)
-	local counter =3D 0
-	for w in string.gmatch(text,searchpattern) do counter =3D counter + 1 end
-	return counter
-end
-			=

-function DebugDumpContainerContentInfo ()
+--[[
+function ScanItemPropBoolean	(props,line,pattern,field) end
+function ScanItemPropNumber		(props,line,pattern,field) end
+
+gItemPropAOS =3D {
+	{"^luck (%d+)"								,{0}		,"luck"				},	=

+	{"^lower reagent cost (%d+)%%"				,{0}		,"lrc"				},	=

+	{"^lower mana cost (%d+)%%"					,{0}		,"lmc"				},	=

+	{"^defense chance increase (%d+)%%"			,{0}		,"dci"				},	=

+	{"^hit chance increase (%d+)%%"				,{0}		,"hci"				},	=

+	{"^skillbonus_sum"							,0			,"skillbonus_sum"	},-- dummy entry, pattern=
 will never match
+	{"^faster cast recovery (%d+)"				,{0}		,"fastcastrecov"	},	=

+	{"^faster casting (%d+)"					,{0}		,"fastcast"			},	=

+	{"^mage armor"								,false		,"magearmor"		},	=

+	{"^\"Maximum sockets allowed is (%d+).\""	,{0}		,"maxsocket"		},	=

+	{"^mana regeneration (%d+)"					,{0}		,"manareg"			},	=

+	{"^mana increase (%d+)"						,{0}		,"manainc"			},	=

+	{"^damage increase (%d+)%%"					,{0}		,"dmginc"			},	=

+	{"^spell damage increase (%d+)%%"			,{0}		,"sdi"				},	=

+	{"^strength bonus (%d+)"					,{0}		,"bonusstr"			},	=

+	{"^dexterity bonus (%d+)"					,{0}		,"bonusdex"			},	=

+	{"^intelligence bonus (%d+)"				,{0}		,"bonusint"			},	=

+	{"^<b>Insured</b>"							,false		,"insured"			},	=

+	{"^self repair (%d+)%%"						,{0}		,"selfrepair"		},	=

+	{"^enhance potions (%d+)%%"					,{0}		,"enhancepotion"	},	=

+	{"^hit point regeneration (%d+)"			,{0}		,"hpreg"			},	=

+	{"^hit point increase (%d+)"				,{0}		,"hpinc"			},	=

+	{"^physical resist (%d+)%%"					,{0}		,"resistphysical"	},	=

+	{"^poison resist (%d+)%%"					,{0}		,"resistpoison"		},	=

+	{"^cold resist (%d+)%%"						,{0}		,"resistcold"		},	=

+	{"^fire resist (%d+)%%"						,{0}		,"resistfire"		},	=

+	{"^energy resist (%d+)%%"					,{0}		,"resistenergy"		},	=

+	{"^strength requirement (%d+)"				,{0}		,"strengthreq"		},
+	{"^durability (%d+) / (%d+)"				,{0,0}		,"durability"		},
+	{"^Weight: (%d+) stones"					,{0}		,"weight"			},	=

+	{"^night sight"								,false		,"nightsight"		},
+}
+
+local function countmatches (text,searchpattern)
+	local counter =3D 0
+	for w in string.gmatch(text,searchpattern) do counter =3D counter + 1 end
+	return counter
+end
+		=

+local function DebugDumpContainerContentInfo ()
 	print("DebugDumpContainerContentInfo")
 	local container =3D gLastDebugContainer  =

 	if (not container) then return end
-	local fp =3D io.open("myitems.csv","a")
-	=

-	local csvout =3D "name;type"
-	for k1,arr in pairs(gItemPropAOS) do =

-		local infopattern,defaultval,propfield =3D unpack(arr)
-		csvout =3D csvout..";"..propfield
-	end
-	csvout =3D csvout..";".."rest"
-	fp:write(csvout.."\n")
+	local fp =3D io.open("myitems.csv","a")
+	=

+	local csvout =3D "name;type"
+	for k1,arr in pairs(gItemPropAOS) do =

+		local infopattern,defaultval,propfield =3D unpack(arr)
+		csvout =3D csvout..";"..propfield
+	end
+	csvout =3D csvout..";".."rest"
+	fp:write(csvout.."\n")
 	=

 	for k,item in pairs(container:GetContent()) do =

 		local name =3D GetStaticTileTypeName(item.artid) or ""
-		local tooltiptext =3D AosToolTip_GetText(item.serial) or ""
-		local props =3D {rest=3D"",skillbonus_sum=3D0,skillbonus=3D{}}
-		=

-		for k,line in pairs(strsplit("\n",tooltiptext)) do
-			if (k =3D=3D 1) then =

-				props.name =3D line
-			else
-				-- try to match all known property format strings
-				local found =3D false
-				for k1,arr in pairs(gItemPropAOS) do =

-					local infopattern,defaultval,propfield =3D unpack(arr)
-					local p0,p1,a,b =3D string.find(line,infopattern)
-					if (p0) then -- only happens for one of the patterns
-						found =3D true
-						props[propfield] =3D {a,b}
-					end
-				end
-				=

-				-- check for skillbonus like "Peacemaking +7"
-				local p0,p1,skillname,bonus =3D string.find(line,"^([%w ]+) %+(%d+)")
-				if (skillname) then
-					--found =3D true   -- just count, but also mention in "rest"
-					props.skillbonus_sum =3D props.skillbonus_sum + tonumber(bonus)
-					props.skillbonus[skillname] =3D bonus
-					=

-				end
-				=

-				-- if unknown prop, append to props.rest
-				if (not found) then props.rest =3D props.rest .. line .. "," end
-			end
-		end
-		=

-		local bInteresting =3D false
-		if (tonumber(props.skillbonus["Animal Taming"] or 0) >=3D 10) then bInte=
resting =3D true end
-		if (props.lrc and tonumber(props.lrc[1]) >=3D 14) then bInteresting =3D =
true end
-		if (props.luck and tonumber(props.luck[1]) >=3D 85) then bInteresting =
=3D true end
-		if (bInteresting) then =

-			print("interesting item found, moving to backpack")
-			local amount =3D 1
-			local itemserial =3D item.serial
-			local x,y,z =3D 0,0,0
-			local containerserial =3D gPlayerBackPack and gPlayerBackPack.serial
-			if (containerserial) then
-				print("grab",itemserial,containerserial)
-				Send_Take_Object(itemserial,amount)
-				Client_USleep(500)
-				Send_Drop_Object(itemserial,x,y,z,containerserial)
-				Client_USleep(1000)
-			else 	=

-				print("error, backpack not found")
-			end
-		end
-		=

---~ 		print(props.rest)
-		=

-		local layer =3D GetPaperdollLayerFromTileType(item.artid) or 0
-		=

-		local csvout =3D props.name..";"..layer
-		for k1,arr in pairs(gItemPropAOS) do =

-			local infopattern,defaultval,propfield =3D unpack(arr)
-			local val =3D props[propfield] or defaultval
-			if (val and type(val) =3D=3D "number") then  -- 0 : skillbonus sum
-				val =3D val
-			elseif (val and val[2]) then =

-				val =3D val[1].."/"..val[2] =

-			elseif (val and val[1]) then =

-				val =3D val[1]
-			elseif (val and type(val) =3D=3D "table") then  -- {} : "yes", etc for =
nightsight,magearmor : match without params
-				val =3D "ja"
-			else
-				val =3D "nein"
-			end
-			csvout =3D csvout..";"..val
-		end
+		local tooltiptext =3D AosToolTip_GetText(item.serial) or ""
+		local props =3D {rest=3D"",skillbonus_sum=3D0,skillbonus=3D{}}
+		=

+		for k,line in pairs(strsplit("\n",tooltiptext)) do
+			if (k =3D=3D 1) then =

+				props.name =3D line
+			else
+				-- try to match all known property format strings
+				local found =3D false
+				for k1,arr in pairs(gItemPropAOS) do =

+					local infopattern,defaultval,propfield =3D unpack(arr)
+					local p0,p1,a,b =3D string.find(line,infopattern)
+					if (p0) then -- only happens for one of the patterns
+						found =3D true
+						props[propfield] =3D {a,b}
+					end
+				end
+				=

+				-- check for skillbonus like "Peacemaking +7"
+				local p0,p1,skillname,bonus =3D string.find(line,"^([%w ]+) %+(%d+)")
+				if (skillname) then
+					--found =3D true   -- just count, but also mention in "rest"
+					props.skillbonus_sum =3D props.skillbonus_sum + tonumber(bonus)
+					props.skillbonus[skillname] =3D bonus
+					=

+				end
+				=

+				-- if unknown prop, append to props.rest
+				if (not found) then props.rest =3D props.rest .. line .. "," end
+			end
+		end
+		=

+		local bInteresting =3D false
+		if (tonumber(props.skillbonus["Animal Taming"] or 0) >=3D 10) then bInte=
resting =3D true end
+		if (props.lrc and tonumber(props.lrc[1]) >=3D 14) then bInteresting =3D =
true end
+		if (props.luck and tonumber(props.luck[1]) >=3D 85) then bInteresting =
=3D true end
+		if (bInteresting) then =

+			print("interesting item found, moving to backpack")
+			local amount =3D 1
+			local itemserial =3D item.serial
+			local x,y,z =3D 0,0,0
+			local containerserial =3D gPlayerBackPack and gPlayerBackPack.serial
+			if (containerserial) then
+				print("grab",itemserial,containerserial)
+				Send_Take_Object(itemserial,amount)
+				Client_USleep(500)
+				Send_Drop_Object(itemserial,x,y,z,containerserial)
+				Client_USleep(1000)
+			else 	=

+				print("error, backpack not found")
+			end
+		end
+		=

+		local layer =3D GetPaperdollLayerFromTileType(item.artid) or 0
+		=

+		local csvout =3D props.name..";"..layer
+		for k1,arr in pairs(gItemPropAOS) do =

+			local infopattern,defaultval,propfield =3D unpack(arr)
+			local val =3D props[propfield] or defaultval
+			if (val and type(val) =3D=3D "number") then  -- 0 : skillbonus sum
+				val =3D val
+			elseif (val and val[2]) then =

+				val =3D val[1].."/"..val[2] =

+			elseif (val and val[1]) then =

+				val =3D val[1]
+			elseif (val and type(val) =3D=3D "table") then  -- {} : "yes", etc for =
nightsight,magearmor : match without params
+				val =3D "ja"
+			else
+				val =3D "nein"
+			end
+			csvout =3D csvout..";"..val
+		end
 		csvout =3D csvout..";"..props.rest
 		fp:write(csvout.."\n")
 	end
 	fp:close()
 end
-
--- TODO use lib.gfm.lua : MakeArtGumpPart ?
--- create graphical representation (use only if container dialog is alread=
y visible)
-function MakeContainerItemWidget (item)
-	local parent =3D item.container.dialog.rootwidget
-	local iArtID =3D item.artid + hex2num("0x4000")
-	local x,y =3D item.xloc,item.yloc
-	local widget =3D nil
-
-	-- If it's not an ART-gfx to display -> Display GUMP-gfx
-	if (item.usegump=3D=3Dtrue) then
-		widget =3D MakeBorderGumpPart (parent,item.artid,x,y + item.gumpyoffset)
-
-		widget.mbIgnoreMouseOver =3D false
-		widget.uoContainer =3D item.container
-		widget.item =3D item
-		item.widget =3D widget
-
-		widget.onMouseLeave =3D function () gCurrentRenderer.gMousePickTippOverr=
ide =3D false end
-		widget.onMouseDown	=3D function (widget,mousebutton) end
-	else
-		local mat =3D GetArtMat(iArtID,item.hue)
-		if ((not mat) or mat =3D=3D "") then
-			print("WARNING ! MakeContainerItemWidget : material load failed for art=
id=3D", iArtID)
-		else
-			local bitmask =3D GetArtBitMask(iArtID)
-			local w,h =3D GetArtSize(iArtID,item.hue)
-			widget =3D guimaker.MakePlane(parent,mat,x,y,w,h)
-			local tw,th =3D texsize(w),texsize(h)
-			widget.gfx:SetUV(0,(0)/th,w/tw,(h+0)/th)
-			widget:SetBitMask(bitmask)
-			widget.mbIgnoreMouseOver =3D false
-			widget.uoContainer =3D item.container
-			widget.item =3D item
-			item.widget =3D widget
-		=

-			-- item debuginfo on mouseover (clientside,debuginfos)
-			widget.onMouseLeave =3D function () =

-				gCurrentRenderer.gMousePickTippOverride =3D false =

-				Client_SetBottomLine("")
-			end
-			widget.onMouseDown	=3D function (widget,mousebutton) end
-			widget.onMouseEnter =3D function ()
-				-- TODO : find a cleaner solution to override the mousepick tipp
-				local item =3D widget.item
-				local name =3D GetStaticTileTypeName(item.artid) or ""
-				info =3D sprintf("item %s amount=3D%d (artid=3D%04x=3D%d)",name,item.a=
mount,item.artid,item.artid)
-				gCurrentRenderer.gMousePickTippOverride =3D info
-				Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
-			end
-		end
-	end
-
-	if (gTooltipSupport) then
-		widget.tooltip_offx =3D kUOToolTippOffX
-		widget.tooltip_offy =3D kUOToolTippOffY
-		widget.stylesetname =3D gGuiDefaultStyleSet
-		widget.on_simple_tooltip =3D function (widget) =

-				local tooltiptext =3D AosToolTip_GetText(widget.item.serial) or ""
-				return (tooltiptext .. " \n ") or "?" =

-			end -- add newline, workaround for tooltip sizecalc bug
-	end
-end
-
-
-
-
-
+]]--



From no-reply at zwischenwelt.org  Tue Mar 11 02:30:31 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Mar 2008 01:30:31 -0000
Subject: [Iris-commit] [IRIS] r1949 - in /trunk: data/config.lua.dist
 include/builder.h include/data.h lua/lib.loading.lua lua/lib.unifont.lua
 lua/main.lua src/builder.cpp src/data.cpp src/data_L.cpp
Message-ID: <20080311013032.C52AC152400F@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 11 02:30:30 2008
New Revision: 1949

Log:
worked on unifont stuff for new guisystem

Added:
    trunk/lua/lib.unifont.lua
Modified:
    trunk/data/config.lua.dist
    trunk/include/builder.h
    trunk/include/data.h
    trunk/lua/lib.loading.lua
    trunk/lua/main.lua
    trunk/src/builder.cpp
    trunk/src/data.cpp
    trunk/src/data_L.cpp

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Tue Mar 11 02:30:30 2008
@@ -72,7 +72,8 @@
 gStitchinLoaderType					=3D "FullFile" -- currently only FullFile available
 gAnimDataLoaderType					=3D "FullFile" -- currently only FullFile available
 gGrannyLoaderType					=3D "OnDemand" -- currently only OnDemand available
-gUniFontLoaderType					=3D false	--"FullFile" -- currently only FullFile a=
vailable
+gUniFontLoaderType					=3D "FullFile" -- currently only FullFile available
+gGenerateOldUnifontTextures			=3D false
 =

 -- sightrange is in blocks (8x8 tiles), larger values let you see further,=
 but will result in lower fps
 gSightRange	=3D 4

Modified: trunk/include/builder.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/builder.h (original)
+++ trunk/include/builder.h Tue Mar 11 02:30:30 2008
@@ -75,6 +75,10 @@
 bool	WriteTexMapToFile					(cTexMapLoader& oTexMapLoader,const char* szFil=
ePath,const int iID,cHueLoader* pHueLoader,const short iHue);
 bool	WriteArtMapToFile					(cArtMapLoader& oArtMapLoader,const char* szFil=
ePath,const int iID,cHueLoader* pHueLoader,const short iHue);
 bool	WriteArtMapToImage					(Ogre::Image& pDest,cArtMapLoader& oArtMapLoad=
er,const int iID,cHueLoader* pHueLoader,const short iHue);
+bool	WriteFontGlyphToImage				(Ogre::Image& pDest,cUniFontFileLoader& oUni=
FontFileLoader,const int iCharCode,
+	const Ogre::ColourValue& vInner		=3DOgre::ColourValue::White,
+	const Ogre::ColourValue& vBorder	=3DOgre::ColourValue::Black,
+	const Ogre::ColourValue& vBackground=3DOgre::ColourValue::ZERO);
 =

 bool	GenerateArtImage(Ogre::Image &image, cArtMapLoader& oArtMapLoader,con=
st int iID,const bool bPixelExact,const bool bInvertY,const bool bInvertX,c=
HueLoader* pHueLoader,const short iHue);
 =


Modified: trunk/include/data.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data.h (original)
+++ trunk/include/data.h Tue Mar 11 02:30:30 2008
@@ -192,19 +192,7 @@
 		char miFrameStart;
 	}  STRUCT_PACKED;
 	=

-	// header of the fontfile, normale 1 byte
-	struct RawFontFileHeader {
-		char miUnknown;
-	} STRUCT_PACKED;
-	=

-	// the header of a single letter
-	struct RawFontFileLetterHeader {
-		char miWidth;
-		char miHeight;
-		char miUnknown;
-	} STRUCT_PACKED;
-
-	=

+	// see also : fonts.mul : http://arachnide.sourceforge.net/formats/fonts/=
index.html, seems to be wrong though...
 	// unifont letter header
 	struct RawUniFontFileLetterHeader {
 		int8 miXOffset;
@@ -236,10 +224,11 @@
 		/// read out the pixel at x,y in data of one letter (with given width w =
and height h of buffer)
 		/// this ignores the offsets of the letter, position only local in data
 		/// returns 1 if the pixel ist visible and 0 if invisible
-		static const int				IsPixelVisible(const char *data, const int w, const =
int h, const int x, const int y);
-		/// @see IsPixelVisible
+		const bool		IsPixelInside	(const char *data, const int w, const int h, c=
onst int x, const int y);
+		=

+		/// @see IsPixelInside
 		/// returns true if the pixel is a border pixel (has visible non border =
neightbours, a normal visible pixel is no border)
-		static const int				IsPixelBorder(const char *data, const int w, const i=
nt h, const int x, const int y);
+		const bool		IsPixelBorder	(const char *data, const int w, const int h, c=
onst int x, const int y);
 	};
 	=

 // ***** ***** ***** ***** ***** cMapInfo

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Tue Mar 11 02:30:30 2008
@@ -11,6 +11,7 @@
 -- store global uni font infos
 gUniFontHeight =3D {}
 gUniFontName =3D {}
+gUniFontLoaderList =3D {}
 -- which uni font chat should be used in chat over the head
 gChatText_UniFontNumber =3D 1
 =

@@ -81,26 +82,37 @@
 -- create a ogre font from a uo unifont file
 -- name =3D resourcename
 -- filename =3D unifont filename
-function CreateUniFont(filename,name)
-	if file_exists(filename) then
-		local l =3D CreateUniFontLoader(filename)
-		l:CreateOgreFont(name)
-		local h =3D l:GetDefaultHeight()
-		l:Destroy()
+function CreateUniFontTexture(loader,name)
+	if not loader then
+		loader:CreateOgreFont(name)
+		local h =3D loader:GetDefaultHeight()
+		loader:Destroy()
 		return h
 	end
 	return 0
+end
+
+function CreateUniFontLoaderIfFileExists(filename)
+	if not file_exists(filename) then return end
+	return CreateUniFontLoader(filename)
 end
 =

 -- load bigger data chunks while menu is visible
 function PreLoad ()
 	--DebugCallLogStartIgnore()
-	LoadingProfile("init unifonts")
 	if (gUniFontLoaderType) then
-		CreateUniFont(CorrectPath( Addfilepath(gUnifontFile) ),"font_unifont0")
+		LoadingProfile("init unifonts")
+		-- TODO : fonts.mul  needed as well ??
+		gUniFontLoader =3D CreateUniFontLoaderIfFileExists(CorrectPath(Addfilepa=
th(gUnifontFile))) -- unifont.mul
+		for i=3D1,6 do gUniFontLoaderList[i] =3D CreateUniFontLoaderIfFileExists=
(CorrectPath(Addfilepath(gUnifonts..i..".mul"))) end -- unifont1.mul  - 6
+	end
+	=

+	if (gGenerateOldUnifontTextures) then
+		LoadingProfile("generate old font textures")
+		CreateUniFontTexture(gUniFontLoader,"font_unifont0")
 		for i=3D1,2 do
 			gUniFontName[i] =3D "font_unifont"..i
-			gUniFontHeight[i] =3D CreateUniFont(CorrectPath( Addfilepath(gUnifonts.=
.i..".mul") ),gUniFontName[i])
+			gUniFontHeight[i] =3D CreateUniFontTexture(gUniFontLoaderList[i],gUniFo=
ntName[i])
 		end
 	end
 	=


Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Mar 11 02:30:30 2008
@@ -86,6 +86,7 @@
 dofile(libpath .. "lib.bugreport.lua")
 dofile(libpath .. "lib.buff.lua")
 dofile(libpath .. "lib.securetrade.lua")
+dofile(libpath .. "lib.unifont.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")
@@ -279,14 +280,6 @@
 	CollectOgreResLocs()
 	SetCursorBaseOffset(0,0)
 =

-	if (false) then
-		local sFontName =3D "TrebuchetMSBold"
-		print("exporting ogre font ...")
-		local sMatName,tGlyphTable =3D ExportOgreFont(sFontName)
-		print("exporting ogre font finished")
-		local f =3D arrfirst(tGlyphTable)
-		print("font into",sMatName,countarr(tGlyphTable),f.left,f.top,f.right,f.=
bottom,f.aspectRatio) -- Fonts/TrebuchetMSBold   133  ...
-	end
 	=

 	------------------------------------------ obsolete, just for testing ---=
--------------------------------
 	-- Lua test because Lua50 should not be compiled full-optimized with VS20=
05 Express (maybe also other compilers)
@@ -315,32 +308,6 @@
 	=

 	InvokeExporters()
 	=

-	------------------------------------------ obsolete, just for testing ---=
--------------------------------
-	if (false) then -- texture-atlas test
-		local w =3D 1024
-		local iArtMapIDList =3D {65,129,321,449,513}
-		local sFilePath =3D "mytexatlas.png"
-		local sFileNameOrPath =3D "art_fallback.png"
-		local pTexAtlas =3D CreateTexAtlas(w,w)
-		local img =3D CreateImage()
-		for k,id in pairs(iArtMapIDList) do
-			local iArtMapID =3D hex2num("0x00004000") + id
-			if (gArtMapLoader:ExportToImage(img,iArtMapID)) then
-				local b =3D 4
-				local img2 =3D ImageScale(img,64-b-b,64-b-b)
-				local bSuccess,l,r,t,b =3D pTexAtlas:AddImage(img2)
-				img2:Destroy()
-			end
-		end
-		--~ local sTexName =3D	pTexAtlas:MakeTexture()
-		pTexAtlas:MakeImage(img)
-		img:SaveAsFile(sFilePath)
-		pTexAtlas:Destroy()
-		img:Destroy()
-		os.exit(0)
-	end
-	-------------------------------------------------------------------------=
---------------------------------
-	=

 	gCurrentRenderer:PreInit()
 =

 	MainMenuFinishedPreLoading()
@@ -355,25 +322,7 @@
 =

 	StartMainMenu()
 	=

-	if (false) then
-		print("guitest_spritelist")
-		gRenderMan2D =3D CreateRenderManager2D()
-		gRenderMan2D_Dialogs =3D CreateRenderGroup2D(gRenderMan2D)
-		=

-		=

-		print("--CreateSpriteList")
-		local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true)
-		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
-		spritelist.asgroup:SetClip(24,4,122,22)
-		spritelist:SetTexture("guibase.png")
-		spritelist:ResizeList(1)
-		print("--SpriteList_Open")
-		SpriteList_Open(spritelist)
-		local iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z, r,g,b,a =3D 0, 0,0,32*4=
,32*4, 0,0, 1,1, 0,  1,0,0,0
-		--~ SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
-		SpriteList_SetSpriteEx(iSpriteIndex, l,t,w,h, u0,v0, uvw,0, 0,uvh, z, r,=
g,b,a)
-		SpriteList_Close()
-	end
+	if (true) then UniFontTest() end
 =

 	-- mainloop
 	while (Client_IsAlive()) do =


Modified: trunk/src/builder.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/builder.cpp (original)
+++ trunk/src/builder.cpp Tue Mar 11 02:30:30 2008
@@ -358,7 +358,6 @@
 	pDest.loadDynamicImage((Ogre::uchar*)pBuf32,iImgW,iImgH,1,Ogre::PF_A8R8G8=
B8,true); // autoDelete pBuf32
 	return true;
 }
-
 =

 bool	WriteTexMapToFile	(cTexMapLoader& oTexMapLoader,const char* szFilePat=
h,const int iID,cHueLoader* pHueLoader,const short iHue) { PROFILE
 	//~ printf("WriteTexMapToFile path=3D%s id=3D%d hueloader=3D0x%x hue=3D%d=
\n",szFilePath,iID,(int)pHueLoader,iHue);
@@ -649,7 +648,7 @@
 	unsigned int texh =3D 1;
 	// OBSOLETE 16*16 is enough space to store all 255 letters
 	//int size =3D sqrt(float(oUniFontFileLoader.GetLetterNumbers())*oUniFont=
FileLoader.GetLetterUsage());
-	int size =3D mymax(letw,leth) * sqrt(float(letters));
+	int size =3D (int)((float)mymax(letw,leth) * sqrt(float(letters)));
 	texw =3D Ogre::Bitwise::firstPO2From(size);
 	texh =3D Ogre::Bitwise::firstPO2From(size);
 	=

@@ -702,9 +701,9 @@
 				// read out pixel
 				float r,g,b,a;
 				=

-				if(cUniFontFileLoader::IsPixelBorder(data,hd->miWidth,hd->miHeight,dx,=
dy)){
+				if(oUniFontFileLoader.IsPixelBorder(data,hd->miWidth,hd->miHeight,dx,d=
y)){
 					r =3D border_r; g =3D border_g; b =3D border_b; a =3D border_a;
-				} else if(cUniFontFileLoader::IsPixelVisible(data,hd->miWidth,hd->miHe=
ight,dx,dy)){
+				} else if(oUniFontFileLoader.IsPixelInside(data,hd->miWidth,hd->miHeig=
ht,dx,dy)){
 					r =3D letter_r; g =3D letter_g; b =3D letter_b; a =3D letter_a;
 				} else {
 					r =3D free_r; g =3D free_g; b =3D free_b; a =3D free_a;
@@ -803,6 +802,32 @@
 	return font;
 }
 =

+bool	WriteFontGlyphToImage				(Ogre::Image& pDest,cUniFontFileLoader& oUni=
FontFileLoader,const int iCharCode,
+	const Ogre::ColourValue& vInner,
+	const Ogre::ColourValue& vBorder,
+	const Ogre::ColourValue& vBackground) {
+	RawUniFontFileLetterHeader*	pHead =3D oUniFontFileLoader.GetLetterHeader(=
	iCharCode);
+	const char*					pData =3D oUniFontFileLoader.GetLetterData(	iCharCode);
+	if (!pData) return false;
+
+	int b =3D 2; // image border around the raw font data
+	int w =3D b + pHead->miWidth	+ b;  // border on all sides, 2 for
+	int h =3D b + pHead->miHeight	+ b;
+	if (w =3D=3D 0 || h =3D=3D 0) return false;
+		=

+	Ogre::PixelFormat iFormat =3D Ogre::PF_BYTE_RGBA; // Ogre::PF_BYTE_BGRA;
+	Ogre::uint32* pBuf =3D new Ogre::uint32[w*h];
+	for (int y=3D0;y<w;++y)
+	for (int x=3D0;x<h;++x) {
+		bool bInside =3D 				oUniFontFileLoader.IsPixelInside(pData,w,h,x-b,y-b);
+		bool bBorder =3D !bInside &&	oUniFontFileLoader.IsPixelBorder(pData,w,h,=
x-b,y-b);
+		Ogre::PixelUtil::packColour(bInside?vInner:(bBorder?vBorder:vBackground)=
,iFormat,&pBuf[y*w+x]); // write to buffer
+	}
+	pDest.loadDynamicImage((Ogre::uchar*)pBuf,w,h,1,iFormat,true); // autoDel=
ete
+	return true;
+}
+
+
 bool	GenerateHeightMap(cGroundBlockLoader* oGroundBlockLoader, const int i=
BlockX, const int iBlockY, signed char* fValues ) { PROFILE
 	int OldBX =3D -1;
 	int OldBY =3D -1;
@@ -936,44 +961,3 @@
 =

 	return true;
 }
-
-class cUnicodeLine {
-	public :
-		Ogre::UTFString mText;
-		int mWidth, mHeight;
-
-		cUnicodeLine( int iMinHeight ) {
-			mText =3D "";
-			mWidth =3D 2;
-			mHeight =3D iMinHeight;
-		}
-};
-
-bool GenerateUnicodeText (const Ogre::UTFString& sText, const Ogre::UTFStr=
ing& sFont, Ogre::RenderOperation& RenderOp, const uint8 bRed, const uint8 =
bGreen, const uint8 bBlue, const uint8 bAlpha, const int iMaxWidth) { PROFI=
LE
-	Ogre::FontPtr pFont =3D Ogre::FontManager::getSingleton().getByName( sFon=
t );
-	if (pFont.isNull()) {
-		return false;
-	}
-
-	int TmpWidth =3D 0;
-	int TmpHeight =3D 0;
-	Ogre::UTFString TmpText =3D "";
-	int CurLine =3D 0;
-
-	Ogre::MaterialPtr Material =3D pFont->getMaterial();
-	Ogre::TexturePtr Tex =3D Material->getTechnique(0)->getPass(0)->getTextur=
eUnitState(0)->_getTexturePtr();
-	//int TexWidth =3D Tex->GetWidth();
-	//int TexHeight =3D Tex->GetHeight();
-
-	//char A =3D "A";
-	//Ogre::Font::UVRect ARect =3D pFont->getGlyphTexCoords( (Ogre::Font::Cod=
ePoint)A );
-	//int MinHeight =3D floor( ARect.height * TexHeight );
-	int MinHeight =3D 0;
-
-	std::list<cUnicodeLine*> Lines;
-	cUnicodeLine* Line =3D new cUnicodeLine( MinHeight );
-	Lines.push_back( Line );
-
-	// f=C3=BCr gr=C3=B6sse: texturkoordinaten ;)
-	return true;
-}

Modified: trunk/src/data.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data.cpp (original)
+++ trunk/src/data.cpp Tue Mar 11 02:30:30 2008
@@ -803,7 +803,38 @@
 =

 // ***** ***** ***** ***** ***** cUniFontFileLoader
 =

+/*
+fonts.mul  ????????? different format ?
+unifont1.mul
+unifont2.mul
+unifont3.mul
+unifont4.mul
+unifont5.mul
+unifont6.mul
+unifont.mul
+*/
 cUniFontFileLoader::cUniFontFileLoader(const char* szFile) : cFullFileLoad=
er(szFile) { PROFILE
+	/*
+	for (int i=3D0;i<300;++i) {
+		RawUniFontFileLetterHeader*	pHead =3D GetLetterHeader(i);
+		const char*					pData =3D GetLetterData(	i);
+		if (!pData) continue;
+		int w =3D (int)pHead->miWidth;
+		int h =3D (int)pHead->miHeight;
+		if (w =3D=3D 0 && h =3D=3D 0) continue;
+		const char*					pNextBigger =3D 0;
+		for (int j=3D0;j<0xFFFF;++j) {
+			const char*	pOtherData =3D (const char*)GetLetterHeader(j);
+			if (pOtherData && pOtherData > pData) {
+				if (!pNextBigger || pOtherData < pNextBigger) pNextBigger =3D pOtherDa=
ta;
+			}
+		}
+		int iMySize =3D pNextBigger ? (pNextBigger - pData) : 0;
+		int iExpectedSize =3D ((w+7)/8)*h;
+		int iSizeDiff =3D iMySize - iExpectedSize;
+		if (iSizeDiff !=3D 0) printf("char %d : w=3D%3d h=3D%3d mem=3D%4d (%4d+%=
4d %s)\n",i,w,h,iMySize,iExpectedSize,iSizeDiff,(iSizeDiff!=3D0)?"########"=
:"");
+	}
+	*/
 	/*
 	int mw =3D GetMaxWidth();
 	int mh =3D GetMaxHeight();
@@ -826,7 +857,7 @@
 					=

 					if(lx < 0 || lx >=3D h->miWidth || ly < 0 || ly >=3D h->miHeight)prin=
tf("-");
 					else if(IsPixelBorder(offset,h->miWidth,h->miHeight,lx,ly))printf("."=
);
-					else if(IsPixelVisible(offset,h->miWidth,h->miHeight,lx,ly))printf("#=
");
+					else if(IsPixelInside(offset,h->miWidth,h->miHeight,lx,ly))printf("#"=
);
 					else printf("~");
 				}
 				printf("\n");
@@ -836,6 +867,7 @@
 	}
 	*/
 }
+
 =

 const int cUniFontFileLoader::GetLetterNumbers(){return 0xFFFF;}
 const float cUniFontFileLoader::GetLetterUsage(){
@@ -852,18 +884,16 @@
 =

 RawUniFontFileLetterHeader* cUniFontFileLoader::GetLetterHeader	(const uns=
igned int iCode){ PROFILE
 	// read out offset of letter header
+	if (iCode * sizeof(int32) + sizeof(int32) >=3D  miFullFileSize) return 0;=
 // check if iCode is valid
 	int32 offset =3D ((int32 *)(mpFullFileBuffer))[iCode];
-	if(offset =3D=3D -1)return 0;
-	if (offset < 0)return 0;
-	// valid?
-	if(offset + sizeof(RawUniFontFileLetterHeader) < miFullFileSize)return (R=
awUniFontFileLetterHeader *)(mpFullFileBuffer + offset);
-	else return 0;
+	if (offset < 0 || offset + sizeof(RawUniFontFileLetterHeader) >=3D miFull=
FileSize) return 0; // check if offset is valid
+	return (RawUniFontFileLetterHeader *)(mpFullFileBuffer + offset);
 }
 =

 const char* cUniFontFileLoader::GetLetterData	(const unsigned int iCode){ =
PROFILE
 	char *p =3D (char *)GetLetterHeader(iCode);
-	if(p)return p + sizeof(RawUniFontFileLetterHeader);
-	else return 0;
+	if (!p) return 0;
+	return p + sizeof(RawUniFontFileLetterHeader);
 }
 =

 cUniFontFileLoader::~cUniFontFileLoader(){ PROFILE
@@ -902,45 +932,30 @@
 	return m;
 }
 =

-
-const int cUniFontFileLoader::IsPixelVisible(const char *data, const int w=
, const int h, const int x, const int y){ PROFILE
-	if(data =3D=3D 0)return 0;
-	=

-	// limit check
-	if(x < 0 || x >=3D w || y < 0 || y >=3D h)return 0;
-	=

-	// recalc metric, due to one char contains 8 pixels as bit along the x ax=
is
-	int basew =3D ((w - (w%8)) / 8) + 1;
-	int basex =3D (x - (x%8)) / 8;
-
-	// index in data array
-	int index =3D basex + (y * basew);
-
-	if((data[index] & (1 << (7 - (x % 8)))) > 0)return 1;
-	else return 0;
-}
-
-const int cUniFontFileLoader::IsPixelBorder(const char *data, const int w,=
 const int h, const int x, const int y){ PROFILE
-	if(data =3D=3D 0)return 0;
-	=

-	// only non visbile pixels can be borders
-	if(IsPixelVisible(data,w,h,x,y))return 0;
+const bool cUniFontFileLoader::IsPixelInside (const char *data, const int =
w, const int h, const int x, const int y) {
+	if (data =3D=3D 0) return false;
+	if (x < 0 || x >=3D w || y < 0 || y >=3D h) return false;
+	int iOffset =3D x/8 + y*((w+7)/8); // +7 / 8 : round upwards
+	if (iOffset + (data - mpFullFileBuffer) >=3D  miFullFileSize) return fals=
e; // boundscheck
+	return (data[iOffset] & (1 << (7 - (x%8)))) !=3D 0;
+}
+
+const bool cUniFontFileLoader::IsPixelBorder (const char *data, const int =
w, const int h, const int x, const int y) {
+	if (data =3D=3D 0) return false;
+	if (IsPixelInside(data,w,h,x,y)) return false; // only non visbile pixels=
 can be borders
 	=

 	// check for visible neighbours
-	if(	=

-		IsPixelVisible(data,w,h,x-1,y-1) ||
-		IsPixelVisible(data,w,h,x  ,y-1) ||
-		IsPixelVisible(data,w,h,x+1,y-1) ||
-		=

-		IsPixelVisible(data,w,h,x-1,y  ) ||
-		IsPixelVisible(data,w,h,x  ,y  ) ||
-		IsPixelVisible(data,w,h,x+1,y  ) ||
-
-		IsPixelVisible(data,w,h,x-1,y+1) ||
-		IsPixelVisible(data,w,h,x  ,y+1) ||
-		IsPixelVisible(data,w,h,x+1,y+1)
-	)return 1;
-	else return 0;
+	return (IsPixelInside(data,w,h,x-1,y-1) ||
+			IsPixelInside(data,w,h,x  ,y-1) ||
+			IsPixelInside(data,w,h,x+1,y-1) ||
+			=

+			IsPixelInside(data,w,h,x-1,y  ) ||
+			IsPixelInside(data,w,h,x  ,y  ) ||
+			IsPixelInside(data,w,h,x+1,y  ) ||
+
+			IsPixelInside(data,w,h,x-1,y+1) ||
+			IsPixelInside(data,w,h,x  ,y+1) ||
+			IsPixelInside(data,w,h,x+1,y+1));
 }
 =

 	=


Modified: trunk/src/data_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data_L.cpp (original)
+++ trunk/src/data_L.cpp Tue Mar 11 02:30:30 2008
@@ -163,10 +163,11 @@
 			=

 			#define REGISTER_METHOD(methodname) mlMethod.push_back(make_luaL_reg(#m=
ethodname,&cUniFontFileLoader_L::methodname));
 			REGISTER_METHOD(Destroy);
-			REGISTER_METHOD(GetLetterHeader);
 			REGISTER_METHOD(GetMaxWidth);
 			REGISTER_METHOD(GetMaxHeight);
 			REGISTER_METHOD(CountLetters);
+			REGISTER_METHOD(WriteGlyphToImage);
+			REGISTER_METHOD(GetGlyphInfo);
 			REGISTER_METHOD(GetDefaultHeight);
 			REGISTER_METHOD(CreateOgreFont);
 			#undef REGISTER_METHOD
@@ -189,19 +190,26 @@
 		static int	GetDefaultHeight	(lua_State *L) { PROFILE lua_pushnumber(L,ch=
eckudata_alive(L)->GetMaxHeight()+2); return 1; }	=

 		static int	CountLetters		(lua_State *L) { PROFILE lua_pushnumber(L,check=
udata_alive(L)->GetLetterNumbers()); return 1; }	=

 		=

-		/// for lua  xoffset,yoffset,w,h		GetLetterHeader		(code)
-		static int	GetLetterHeader				(lua_State *L) { PROFILE =

-			cUniFontFileLoader* target =3D checkudata_alive(L);
-			if (!target) return 0;
-			=

-			RawUniFontFileLetterHeader *h =3D target->GetLetterHeader(luaL_checkint=
(L,2));
+		/// return true on success
+		/// loads the glyph for iCharCode into a Ogre::Image (lua wrapper : cIma=
ge)
+		/// bSuccess	WriteGlyphToImage	(pImage,iCharCode)
+		static int		WriteGlyphToImage	(lua_State *L) { PROFILE =

+			cImage*	pImage		=3D cLuaBind<cImage>::checkudata_alive(L,2);
+			int		iCharCode	=3D luaL_checkint(L,3); // Ogre::Font::CodePoint ?  unic=
ode
+			if (!WriteFontGlyphToImage(pImage->mImage,*checkudata_alive(L),iCharCod=
e)) return 0;
+			lua_pushboolean(L,true);
+			return 1; =

+		}
+		=

+		/// for lua  xoffset,yoffset,w,h	GetGlyphInfo	(iCharCode)
+		static int							GetGlyphInfo	(lua_State *L) { PROFILE =

+			RawUniFontFileLetterHeader *h =3D checkudata_alive(L)->GetLetterHeader(=
luaL_checkint(L,2));
 			if (!h) return 0;
-
 			lua_pushnumber(L,h->miXOffset);
 			lua_pushnumber(L,h->miYOffset);
 			lua_pushnumber(L,h->miWidth);
 			lua_pushnumber(L,h->miHeight);
-			return 4; =

+			return 4;
 		}	=

 =

 		/// for lua CreateOgreFont(fontname)
@@ -216,6 +224,8 @@
 			=

 			return 0; =

 		}	=

+		=

+		// see also l_ExportOgreFont in lugre/src/lugre_scripting.ogre.cpp
 		=

 		virtual const char* GetLuaTypeName () { return "iris.unifontloader"; }
 };



From no-reply at zwischenwelt.org  Tue Mar 11 03:17:40 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Mar 2008 02:17:40 -0000
Subject: [Iris-commit] [IRIS] r1951 - in /trunk: lua/lib.unifont.lua
	src/builder.cpp
Message-ID: <20080311021740.72CDE1524013@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 11 03:17:38 2008
New Revision: 1951

Log:
unicode experiment worked

Modified:
    trunk/lua/lib.unifont.lua
    trunk/src/builder.cpp

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Tue Mar 11 03:17:38 2008
@@ -46,7 +46,6 @@
 =

 -- texname,u0,v0,u1,v1,xoff,yoff,w,h
 function GetUniFontGlyph (fontloader,iCharCode)
-	print("GetUniFontGlyph",fontloader,iCharCode)
 	if (not fontloader.glyphs) then fontloader.glyphs =3D {} end
 	local glyphdata =3D fontloader.glyphs[iCharCode]
 	if (glyphdata) then return unpack(glyphdata) end
@@ -62,6 +61,7 @@
 	img:Destroy()
 	=

 	fontloader.glyphs[iCharCode] =3D glyphdata
+	if (not glyphdata) then return end
 	return unpack(glyphdata)
 end
 =

@@ -116,8 +116,9 @@
 		local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true) =

 		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
 		local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontLo=
ader,string.byte("A",1))
+		local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontLo=
ader,string.byte("B",1))
 		--~ local texname =3D GetTexture(fontobj.sMatName)
-		print("MyText",texname)
+		--~ print("MyText",texname)
 		spritelist:SetTexture(texname)
 		local textlen =3D string.len(text)
 		spritelist:ResizeList(textlen)
@@ -126,39 +127,40 @@
 		for i=3D1,textlen do =

 			local c =3D string.byte(text,i)
 			local ctxt =3D string.sub(text,i,i)
-			print("MyText",i,c,ctxt)
+			--~ print("MyText",i,c,ctxt)
 			local texname =3D nil
 			local iCharCode =3D c
-			--~ local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniF=
ontLoader,iCharCode)
-			local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontL=
oader,string.byte("A",1))
+			local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontL=
oader,iCharCode)
+			--~ local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniF=
ontLoader,string.byte("B",1))
+			--~ local texname =3D "aaaaaaaaaaargh"
 			local glyph =3D fontobj.tGlyphTable[c]
 			local h =3D 44
 			local spacew =3D h * fontobj.tSpaceAspect
 			local tablen =3D 4
 			local tabmaxw =3D tablen * spacew
-			if (texname) then
-				print("unifont_lastret",texname,u0,v0,u1,v1,xoff,yoff,fw,fh)
+			if (c =3D=3D kCharCode_Space) then
+				x =3D x + spacew
+			elseif (c =3D=3D kCharCode_Tab) then
+				x =3D math.ceil((x + spacew)/tabmaxw) * tabmaxw
+			elseif (c =3D=3D kCharCode_Nl) then
+				x =3D 0
+				y =3D y + h
+			elseif (texname) then
+				--~ print("unifont_lastret",texname,u0,v0,u1,v1,xoff,yoff,fw,fh)
 				local b =3D 2
+				local s =3D 2
 				fw,fh =3D b+fw+b,b+fh+b
-				fw,fh =3D fw*4,fh*4
-				--~ local fw,fh,u0,v0,u1,v1 =3D 128,128,0,0,1,1
+				fw,fh =3D fw*s,fh*s
 				local uvw, uvh =3D u1-u0,v1-v0
 				local iSpriteIndex, l,t,z =3D i-1,x,y,0
-				x =3D x + fw
-				SpriteList_SetSprite(iSpriteIndex, l,t,fw,fh, u0,v0, uvw, uvh, z)
+				x =3D x + fw - xoff*s
+				SpriteList_SetSprite(iSpriteIndex,xoff*s+l,yoff*s+t,fw,fh, u0,v0, uvw,=
 uvh, z)
 			elseif (glyph) then
 				local u0,v0, uvw, uvh =3D glyph.left,glyph.top, glyph.right-glyph.left=
, glyph.bottom-glyph.top
 				local w =3D h * glyph.aspectRatio
 				local iSpriteIndex, l,t,z =3D i-1,x,y,0
 				x =3D x + w
 				SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
-			elseif (c =3D=3D kCharCode_Space) then
-				x =3D x + spacew
-			elseif (c =3D=3D kCharCode_Tab) then
-				x =3D math.ceil((x + spacew)/tabmaxw) * tabmaxw
-			elseif (c =3D=3D kCharCode_Nl) then
-				x =3D 0
-				y =3D y + h
 			end
 		end
 		SpriteList_Close()
@@ -166,7 +168,7 @@
 		return spritelist
 	end
 	=

-	local mytextspritelist =3D MyText("Hallo, test 123\nBlablubblub\nTab\t1\t=
Tabtest\nt\t1\n\t1\n\t\t2\n\t\t\t3",myfont,gRenderMan2D_Dialogs)
+	local mytextspritelist =3D MyText("Hallo, test 123\nBlablubblub\nUnicode:=
=C3=A4=C3=B6=C3=BC=C3=9F=C3=84=C3=96=C3=9C(german)\nTab\t1\tTabtest\nt\t1\n=
\t1\n\t\t2\n\t\t\t3",myfont,gRenderMan2D_Dialogs)
 		=

 end
 =


Modified: trunk/src/builder.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/builder.cpp (original)
+++ trunk/src/builder.cpp Tue Mar 11 03:17:38 2008
@@ -817,10 +817,10 @@
 		=

 	Ogre::PixelFormat iFormat =3D Ogre::PF_BYTE_RGBA; // Ogre::PF_BYTE_BGRA;
 	Ogre::uint32* pBuf =3D new Ogre::uint32[w*h];
-	for (int y=3D0;y<w;++y)
-	for (int x=3D0;x<h;++x) {
-		bool bInside =3D 				oUniFontFileLoader.IsPixelInside(pData,w,h,x-b,y-b);
-		bool bBorder =3D !bInside &&	oUniFontFileLoader.IsPixelBorder(pData,w,h,=
x-b,y-b);
+	for (int y=3D0;y<h;++y)
+	for (int x=3D0;x<w;++x) {
+		bool bInside =3D 				oUniFontFileLoader.IsPixelInside(pData,pHead->miWid=
th,pHead->miHeight,x-b,y-b);
+		bool bBorder =3D !bInside &&	oUniFontFileLoader.IsPixelBorder(pData,pHea=
d->miWidth,pHead->miHeight,x-b,y-b);
 		Ogre::PixelUtil::packColour(bInside?vInner:(bBorder?vBorder:vBackground)=
,iFormat,&pBuf[y*w+x]); // write to buffer
 	}
 	pDest.loadDynamicImage((Ogre::uchar*)pBuf,w,h,1,iFormat,true); // autoDel=
ete



From no-reply at zwischenwelt.org  Tue Mar 11 02:45:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Mar 2008 01:45:58 -0000
Subject: [Iris-commit] [IRIS] r1950 - in /trunk: include/grannyloader_i2.h
 lua/lib.unifont.lua src/data.cpp src/granny_L.cpp src/grannydump.cpp
 src/grannyloader_i2.cpp
Message-ID: <20080311014558.D5B8F1524010@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 11 02:45:57 2008
New Revision: 1950

Log:
fixed typo, experiment with unicode

Modified:
    trunk/include/grannyloader_i2.h
    trunk/lua/lib.unifont.lua
    trunk/src/data.cpp
    trunk/src/granny_L.cpp
    trunk/src/grannydump.cpp
    trunk/src/grannyloader_i2.cpp

Modified: trunk/include/grannyloader_i2.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/grannyloader_i2.h (original)
+++ trunk/include/grannyloader_i2.h Tue Mar 11 02:45:57 2008
@@ -140,7 +140,7 @@
 	std::vector<const GrannyBoneTie*>	mBoneTies; // 0xCA5E0c0a
 	std::vector<cAnim>				mAnims;
 	std::vector<cSubMesh>			mSubMeshes;
-	std::vector<uint32>				mTexureIDs;
+	std::vector<uint32>				mTextureIDs;
 	std::vector<uint32>				mBoneTies1; // 0xCA5E0f04
 	std::vector<uint32>				mBoneTies2; // 0XCA5E0C02
 	uint32							miLastKey;

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Tue Mar 11 02:45:57 2008
@@ -45,14 +45,15 @@
 end
 =

 -- texname,u0,v0,u1,v1,xoff,yoff,w,h
-function GetUniFontGlyph (fontloader,iCharcode)
+function GetUniFontGlyph (fontloader,iCharCode)
+	print("GetUniFontGlyph",fontloader,iCharCode)
 	if (not fontloader.glyphs) then fontloader.glyphs =3D {} end
-	local glyphdata =3D fontloader.glyphs[iCharcode]
+	local glyphdata =3D fontloader.glyphs[iCharCode]
 	if (glyphdata) then return unpack(glyphdata) end
 	if (glyphdata =3D=3D false) then return false end -- not loadable, don't =
retry
 	glyphdata =3D false
 	local img =3D CreateImage()
-	local success =3D fontloader:WriteGlyphToImage(img,iCharcode)
+	local success =3D fontloader:WriteGlyphToImage(img,iCharCode)
 	if (success) then
 		local xoff,yoff,w,h =3D gUniFontLoader:GetGlyphInfo(iCharCode)
 		local texname,u0,v0,u1,v1 =3D UniFont_AddImageToAtlas(img)
@@ -60,8 +61,8 @@
 	end
 	img:Destroy()
 	=

-	fontloader.glyphs[iCharcode] =3D glyphdata
-	return glyphdata
+	fontloader.glyphs[iCharCode] =3D glyphdata
+	return unpack(glyphdata)
 end
 =

 function UniFontTest ()
@@ -114,7 +115,8 @@
 		kCharCode_Cr	=3D string.byte("\r",1)
 		local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true) =

 		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
-		local texname =3D GetTexture(fontobj.sMatName)
+		local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontLo=
ader,string.byte("A",1))
+		--~ local texname =3D GetTexture(fontobj.sMatName)
 		print("MyText",texname)
 		spritelist:SetTexture(texname)
 		local textlen =3D string.len(text)
@@ -126,15 +128,20 @@
 			local ctxt =3D string.sub(text,i,i)
 			print("MyText",i,c,ctxt)
 			local texname =3D nil
-			local iCharcode =3D c
-			--~ local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniF=
ontLoader,iCharcode)
-			--~ local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniF=
ontLoader,string.byte("a",1))
+			local iCharCode =3D c
+			--~ local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniF=
ontLoader,iCharCode)
+			local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontL=
oader,string.byte("A",1))
 			local glyph =3D fontobj.tGlyphTable[c]
 			local h =3D 44
 			local spacew =3D h * fontobj.tSpaceAspect
 			local tablen =3D 4
 			local tabmaxw =3D tablen * spacew
 			if (texname) then
+				print("unifont_lastret",texname,u0,v0,u1,v1,xoff,yoff,fw,fh)
+				local b =3D 2
+				fw,fh =3D b+fw+b,b+fh+b
+				fw,fh =3D fw*4,fh*4
+				--~ local fw,fh,u0,v0,u1,v1 =3D 128,128,0,0,1,1
 				local uvw, uvh =3D u1-u0,v1-v0
 				local iSpriteIndex, l,t,z =3D i-1,x,y,0
 				x =3D x + fw

Modified: trunk/src/data.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data.cpp (original)
+++ trunk/src/data.cpp Tue Mar 11 02:45:57 2008
@@ -42,7 +42,7 @@
 =

 	# radarcolor is stored in radarcol.mul, assigns a 16 bit color for every =
groundTileTypeID (<0x00004000) to be displayed on worldmap or so
 =

-	# tileType data is stored in tiledata.mul : flags, id_override for texure
+	# tileType data is stored in tiledata.mul : flags, id_override for texture
 =

 	# Art means 2D graphics, most in iso perspektive, data comes from artidx.=
mul and art.mul
 	used for both iso-ground tiles and 2d gfx for statics, art-index =3D tile=
TypeIndex

Modified: trunk/src/granny_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/granny_L.cpp (original)
+++ trunk/src/granny_L.cpp Tue Mar 11 02:45:57 2008
@@ -188,17 +188,17 @@
 		}
 		=

 		/// int GetTextureIDCount () =

-		/// number of TexureIDs
+		/// number of TextureIDs
 		static int	GetTextureIDCount	(lua_State *L) { PROFILE =

-			lua_pushnumber(L,checkudata_alive(L)->mTexureIDs.size()); =

+			lua_pushnumber(L,checkudata_alive(L)->mTextureIDs.size()); =

 			return 1; =

 		}
 		=

 		/// int GetTextureID (int index) =

 		static int	GetTextureID	(lua_State *L) { PROFILE =

 			int index =3D (lua_gettop(L) >=3D 2 && !lua_isnil(L,2)) ? luaL_checkint=
(L,2) : 0;
-			if (index < 0 || index >=3D checkudata_alive(L)->mTexureIDs.size()) ret=
urn 0;
-			lua_pushnumber(L,checkudata_alive(L)->mTexureIDs[index]); =

+			if (index < 0 || index >=3D checkudata_alive(L)->mTextureIDs.size()) re=
turn 0;
+			lua_pushnumber(L,checkudata_alive(L)->mTextureIDs[index]); =

 			return 1; =

 		}
 		=


Modified: trunk/src/grannydump.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/grannydump.cpp (original)
+++ trunk/src/grannydump.cpp Tue Mar 11 02:45:57 2008
@@ -263,7 +263,7 @@
 	std::vector<const GrannyBoneTie*>	mBoneTies; // 0xCA5E0c0a
 	std::vector<cAnim>				mAnims;
 	std::vector<cSubMesh>			mSubMeshes;
-	std::vector<uint32>				mTexureIDs;
+	std::vector<uint32>				mTextureIDs;
 	std::vector<uint32>				mBoneTies1; // 0xCA5E0f04
 	std::vector<uint32>				mBoneTies2; // 0XCA5E0C02
 	struct GrannyBone {

Modified: trunk/src/grannyloader_i2.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/grannyloader_i2.cpp (original)
+++ trunk/src/grannyloader_i2.cpp Tue Mar 11 02:45:57 2008
@@ -220,7 +220,7 @@
 }
 /// 0xCA5E0f04
 void	cGrannyLoader_i2::VisitTexInfoID			(const uint32 iID) {
-	mTexureIDs.push_back(iID);
+	mTextureIDs.push_back(iID);
 }
 /// 0XCA5E0C08
 void	cGrannyLoader_i2::VisitBoneTie2ID			(const uint32 iID) {



From no-reply at zwischenwelt.org  Tue Mar 11 13:26:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Mar 2008 12:26:14 -0000
Subject: [Iris-commit] [IRIS] r1952 - in /trunk/lua: lib.loading.lua
	lib.unifont.lua
Message-ID: <20080311122614.89BE01524013@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 11 13:26:13 2008
New Revision: 1952

Log:
unifont test

Modified:
    trunk/lua/lib.loading.lua
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Tue Mar 11 13:26:13 2008
@@ -103,13 +103,13 @@
 	if (gUniFontLoaderType) then
 		LoadingProfile("init unifonts")
 		-- TODO : fonts.mul  needed as well ??
-		gUniFontLoader =3D CreateUniFontLoaderIfFileExists(CorrectPath(Addfilepa=
th(gUnifontFile))) -- unifont.mul
+		gUniFontLoaderList[0] =3D CreateUniFontLoaderIfFileExists(CorrectPath(Ad=
dfilepath(gUnifontFile))) -- unifont.mul
 		for i=3D1,6 do gUniFontLoaderList[i] =3D CreateUniFontLoaderIfFileExists=
(CorrectPath(Addfilepath(gUnifonts..i..".mul"))) end -- unifont1.mul  - 6
 	end
 	=

 	if (gGenerateOldUnifontTextures) then
 		LoadingProfile("generate old font textures")
-		CreateUniFontTexture(gUniFontLoader,"font_unifont0")
+		CreateUniFontTexture(gUniFontLoaderList,"font_unifont0")
 		for i=3D1,2 do
 			gUniFontName[i] =3D "font_unifont"..i
 			gUniFontHeight[i] =3D CreateUniFontTexture(gUniFontLoaderList[i],gUniFo=
ntName[i])

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Tue Mar 11 13:26:13 2008
@@ -54,7 +54,7 @@
 	local img =3D CreateImage()
 	local success =3D fontloader:WriteGlyphToImage(img,iCharCode)
 	if (success) then
-		local xoff,yoff,w,h =3D gUniFontLoader:GetGlyphInfo(iCharCode)
+		local xoff,yoff,w,h =3D fontloader:GetGlyphInfo(iCharCode)
 		local texname,u0,v0,u1,v1 =3D UniFont_AddImageToAtlas(img)
 		if (texname) then glyphdata =3D {texname,u0,v0,u1,v1,xoff,yoff,w,h} end
 	end
@@ -83,7 +83,7 @@
 	=

 	=

 	=

-	--~ gUniFontLoader =3D unifont.mul
+	--~ gUniFontLoaderList[0] =3D unifont.mul
 	--~ gUniFontLoaderList[i] =3D unifont(1-6).mul
 	=

 	=

@@ -115,8 +115,8 @@
 		kCharCode_Cr	=3D string.byte("\r",1)
 		local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true) =

 		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
-		local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontLo=
ader,string.byte("A",1))
-		local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontLo=
ader,string.byte("B",1))
+		local myfontloader =3D gUniFontLoaderList[0] -- 0=3Dmedieval 3=3Ddefault=
-chat
+		local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(myfontload=
er,string.byte("A",1))
 		--~ local texname =3D GetTexture(fontobj.sMatName)
 		--~ print("MyText",texname)
 		spritelist:SetTexture(texname)
@@ -130,11 +130,9 @@
 			--~ print("MyText",i,c,ctxt)
 			local texname =3D nil
 			local iCharCode =3D c
-			local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniFontL=
oader,iCharCode)
-			--~ local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(gUniF=
ontLoader,string.byte("B",1))
-			--~ local texname =3D "aaaaaaaaaaargh"
+			local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(myfontloa=
der,iCharCode)
 			local glyph =3D fontobj.tGlyphTable[c]
-			local h =3D 44
+			local h =3D 16
 			local spacew =3D h * fontobj.tSpaceAspect
 			local tablen =3D 4
 			local tabmaxw =3D tablen * spacew
@@ -148,13 +146,16 @@
 			elseif (texname) then
 				--~ print("unifont_lastret",texname,u0,v0,u1,v1,xoff,yoff,fw,fh)
 				local b =3D 2
-				local s =3D 2
+				local s =3D 1
 				fw,fh =3D b+fw+b,b+fh+b
 				fw,fh =3D fw*s,fh*s
 				local uvw, uvh =3D u1-u0,v1-v0
 				local iSpriteIndex, l,t,z =3D i-1,x,y,0
-				x =3D x + fw - xoff*s
-				SpriteList_SetSprite(iSpriteIndex,xoff*s+l,yoff*s+t,fw,fh, u0,v0, uvw,=
 uvh, z)
+				x =3D x + fw - 3 * s
+				if (xoff > 0) then x =3D x - xoff*s else x =3D x + xoff*s end
+				local r,g,b,a =3D math.random(),math.random(),math.random(),1
+				--~ SpriteList_SetSprite(	iSpriteIndex,xoff*s+l,yoff*s+t,fw,fh, u0,v0,=
 uvw, uvh, z)
+				SpriteList_SetSpriteEx(	iSpriteIndex,xoff*s+l,yoff*s+t,fw,fh, u0,v0, u=
vw,0, 0,uvh, z, r,g,b,a)
 			elseif (glyph) then
 				local u0,v0, uvw, uvh =3D glyph.left,glyph.top, glyph.right-glyph.left=
, glyph.bottom-glyph.top
 				local w =3D h * glyph.aspectRatio



From no-reply at zwischenwelt.org  Tue Mar 11 19:05:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Mar 2008 18:05:54 -0000
Subject: [Iris-commit] [IRIS] r1953 - in /trunk: bin/iris2.exe
 lua/filter/filter.granny.lua lua/gui/gui.paperdoll.lua
 lua/lib.gumpparser.lua lua/lib.mousepick.lua lua/lib.securetrade.lua
 lua/lib.skill.lua lua/obj/obj.player.lua
Message-ID: <20080311190003.52D611C18033@zwischenwelt.org>

Author: sience
Date: Tue Mar 11 19:05:53 2008
New Revision: 1953

Log:
-gump are now coded in the specific gumpfiles (no *.gfm's anymore) - use gu=
mpstudio plugin to create
-new win32 binary
-some comments added

Modified:
    trunk/bin/iris2.exe
    trunk/lua/filter/filter.granny.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.gumpparser.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/lib.securetrade.lua
    trunk/lua/lib.skill.lua
    trunk/lua/obj/obj.player.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/filter/filter.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.granny.lua (original)
+++ trunk/lua/filter/filter.granny.lua Tue Mar 11 19:05:53 2008
@@ -36,6 +36,7 @@
 =

 -- custom models can be applyed instead to grannys, just tell the meshname
 --gGrannyFilter[220]	=3D{meshname=3D"Lich.mesh"}
+--gGrannyFilter[207]	=3D{meshname=3D"mummy.mesh"}
 =

 gGrannyFilter[987]	=3D{grannyid=3D400}
 gGrannyFilter[1987]	=3D{grannyid=3D401}

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Tue Mar 11 19:05:53 2008
@@ -307,17 +307,17 @@
 			-- request Warmode and change the Peace/Warmode Button visual
 			dialog.controls["btnpeace"].onMouseDown =3D function (widget,mousebutto=
n)
 															if (gActWarmode=3D=3DgWarmode_Normal) then
+																Send_CombatMode(gWarmode_Combat)
 																widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
 																widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
 																widget.mat_over 	=3D GetGumpMat(hex2num("0x7EA"))
 																widget.gfx:SetMaterial(widget.mat_pressed)
-																Send_CombatMode(gWarmode_Combat)
 															else
+																Send_CombatMode(gWarmode_Normal)
 																widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E5"))
 																widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E6"))
 																widget.mat_over 	=3D GetGumpMat(hex2num("0x7E7"))
 																widget.gfx:SetMaterial(widget.mat_pressed)
-																Send_CombatMode(gWarmode_Normal)
 															end
 														end
 			-- request HelpGump (must be supported by Serversidegumps)

Modified: trunk/lua/lib.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gumpparser.lua (original)
+++ trunk/lua/lib.gumpparser.lua Tue Mar 11 19:05:53 2008
@@ -489,6 +489,8 @@
 												printdebug("gump","Checkbox changed : id=3D"..widget.returnmsg=
.." state=3D"..widget.state)
 											end
 										  end
+				else
+					if (bToken[7]) then dialog.controls[bToken[7]] =3D widget end
 				end
 			--HtmlGump <x> <y> <width> <height> <text-id> <background> <scrollbar>
 			--Description:  Defines a text-area where Html-commands are allowed.

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Tue Mar 11 19:05:53 2008
@@ -31,13 +31,13 @@
 		local pm =3D GetPlayerMobile()
 		if (gActWarmode =3D=3D gWarmode_Normal or (pm and iSerial =3D=3D pm.seri=
al) ) then
 			if (iSerial and iSerial ~=3D 0) then
-				printdebug("UO",sprintf("IrisDoubleClick: serial=3D0x%08x\n",iSerial))
+				printdebug("net",sprintf("IrisDoubleClick: serial=3D0x%08x\n",iSerial))
 				Send_DoubleClick(iSerial)
 			end
 		end
 		if (gActWarmode =3D=3D gWarmode_Combat) then
 			if (iSerial and iSerial ~=3D 0) then
-				printdebug("UO",sprintf("IrisDoubleClickAttack: serial=3D0x%08x\n",iSe=
rial))
+				printdebug("net",sprintf("IrisDoubleClickAttack: serial=3D0x%08x\n",iS=
erial))
 				Send_AttackReq(iSerial)
 			end
 		end
@@ -53,7 +53,7 @@
 	else
 		local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
 		if (iSerial and iSerial ~=3D 0) then =

-			printdebug("UO",sprintf("IrisSingleClick: serial=3D0x%08x\n",iSerial))
+			printdebug("net",sprintf("IrisSingleClick: serial=3D0x%08x\n",iSerial))
 			Send_SingleClick(iSerial)
 			gCurrentRenderer:SelectMobile(iSerial)
 		else
@@ -67,7 +67,7 @@
 	local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
 	gLastRightClickSerial =3D nil
 	if (iSerial and iSerial ~=3D 0) then =

-		printdebug("UO",sprintf("IrisRightClick: serial=3D0x%08x\n",iSerial))
+		printdebug("net",sprintf("IrisRightClick: serial=3D0x%08x\n",iSerial))
 		Send_PopupRequest(iSerial) =

 		gLastRightClickSerial =3D iSerial
 	end

Modified: trunk/lua/lib.securetrade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.securetrade.lua (original)
+++ trunk/lua/lib.securetrade.lua Tue Mar 11 19:05:53 2008
@@ -4,6 +4,25 @@
 -- see also kPacket_Open_Container (exchange is done using containers)
 -- see also old iris trade.csl or so  callback_OnTradeCheck callback_OnTra=
deStart
 -- secure trade is started by dragdrop onto player .. server sends start w=
ith two containers
+
+-- Created 11.03.2008 16:55:39, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local securetrading =3D {}
+securetrading.dialogId =3D 34567
+securetrading.x =3D 0
+securetrading.y =3D 0
+securetrading.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 0 0 2150 }" ..
+	 "{ checkbox 52 30 2151 2153 0 cbmy }" ..
+	 "{ checkbox 268 162 2151 2153 0 cbtheir }" ..
+	 "{ text 85 36 0 0 }" ..
+	 "{ text 70 166 0 1 }" ..
+	 "" =

+securetrading.textline =3D {
+	[0] =3D "namemy",
+	[1] =3D "nametheir",
+}
 =

 kSecTradeAction_Start =3D 0
 kSecTradeAction_Cancel =3D 1
@@ -137,7 +156,9 @@
 		gSecureTrades[mysectrade.id] =3D mysectrade
 		=

 		-- show dialog
-		local dialog =3D CreateGumpDlgFromGfm(datapath.."gfm/secure_trade.gfm")
+		--local dialog =3D CreateGumpDlgFromGfm(datapath.."gfm/secure_trade.gfm")
+		local dialog =3D GumpParser( securetrading, true )
+
 		for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
 		mysectrade.dialog =3D dialog =

 		dialog.uoSecureTrade =3D mysectrade =

@@ -148,12 +169,12 @@
 		end
 		=

 		-- update name display name
-		dialog.controls["name_my"].gfx:SetText(GetPlayerName() or "me")
-		dialog.controls["name_their"].gfx:SetText(sectrade.name or "unknown")
+		dialog.controls["namemy"].gfx:SetText(GetPlayerName() or "me")
+		dialog.controls["nametheir"].gfx:SetText(sectrade.name or "unknown")
 		-- ./net.paperdoll.lua:55:	dialog =3D CreateGumpDlgFromGfm(...)
 		-- cb_my cb_their  normal=3D'0x867' checked=3D'0x869' -- todo :  $209 $2=
08 gumpids ?
 		=

-		dialog.controls["cb_my"].onChange =3D function (widget,bChecked) =

+		dialog.controls["cbmy"].onChange =3D function (widget,bChecked) =

 			--print("Send_SecureTrade_ChangeAgree",widget.dialog.uoSecureTrade.id,b=
Checked)
 			Send_SecureTrade_ChangeAgree(widget.dialog.uoSecureTrade.id,bChecked an=
d 1 or 0)
 		end
@@ -172,8 +193,8 @@
 				mysectrade:Close()
 			else =

 				-- change checkboxes
-				mysectrade.dialog.controls["cb_my"]:SetChecked(myOK)
-				mysectrade.dialog.controls["cb_their"]:SetChecked(theirOK)
+				mysectrade.dialog.controls["cbmy"]:SetChecked(myOK)
+				mysectrade.dialog.controls["cbtheir"]:SetChecked(theirOK)
 			end
 		end
 	end

Modified: trunk/lua/lib.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.skill.lua (original)
+++ trunk/lua/lib.skill.lua Tue Mar 11 19:05:53 2008
@@ -1,3 +1,38 @@
+-- Created 11.03.2008 16:09:57, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local skillGump =3D {}
+skillGump.dialogId =3D 1234
+skillGump.x =3D 0
+skillGump.y =3D 0
+skillGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 23 311 2083 }" ..
+	 "{ gumppic 21 241 2082 }" ..
+	 "{ gumppic 42 273 2102 }" ..
+	 "{ gumppictiled 21 64 263 177 2081 }" ..
+	 "{ gumppic 4 27 2080 }" ..
+	 "{ gumppic 120 37 2100 }" ..
+	 "{ button 139 342 2094 2095 1 0 0 }" ..
+	 "{ gumppic 44 62 2091 }" ..
+	 "{ button 255 61 2084 2084 1 0 skillscrollup }" ..
+	 "{ button 255 291 2085 2085 1 0 skillscrolldown }" ..
+	 "{ button 139 4 2093 2093 1 0 skillclose }" ..
+	 "{ button 259 76 2088 2088 1 0 skillscroll }"
+skillGump.textline =3D {
+}
+-- Created 11.03.2008 15:41:19, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local quickskillGump =3D {}
+quickskillGump.dialogId =3D 234567
+quickskillGump.x =3D 0
+quickskillGump.y =3D 0
+quickskillGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 0 0 2445 }" ..
+	 "{ gumppic 5 5 2362 }"
+quickskillGump.textline =3D {
+}
+
 -- global player skill stuff list, see SkillUpdate for details
 gPlayerSkills =3D nil
 =

@@ -20,7 +55,7 @@
 		for k,skill in pairs(gSkillDialog.lSkill) do
 			if skill.skillid =3D=3D skillid then
 				-- skill found, so update
-				print("skillupdate",k,skillid,skill.skillid,value,base_value,lockstate)
+				--print("skillupdate",k,skillid,skill.skillid,value,base_value,locksta=
te)
 				skill.button_lock.gfx:SetVisible(lockstate =3D=3D 2)
 				skill.button_up.gfx:SetVisible(lockstate =3D=3D 0)
 				skill.button_down.gfx:SetVisible(lockstate =3D=3D 1)
@@ -47,7 +82,8 @@
 		=

 		local scrollbar_h =3D scrollbar_y_end - scrollbar_y_start
 	=

-		gSkillDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/skill.gfm")
+		-- gSkillDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/skill.gfm")
+		gSkillDialog =3D GumpParser( skillGump, true )
 		=

 		-- restore last positoin if available
 		if gSkillDialog_LastPositionX and gSkillDialog_LastPositionY then gSkill=
Dialog.rootwidget.gfx:SetPos(gSkillDialog_LastPositionX, gSkillDialog_LastP=
ositionY) end
@@ -71,7 +107,7 @@
 		end
 		=

 		-- close button
-		local widget =3D dialog.controls["skill_close"]
+		local widget =3D dialog.controls["skillclose"]
 		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then =

 			widget.gfx:SetMaterial(widget.mat_pressed)
 			-- TODO: toggle to gump-id 0x839 on upper right corner (moveable) ... o=
n doubleclick open skills again
@@ -79,7 +115,7 @@
 		end end
 		=

 		-- scrollbar middle button
-		local widget =3D dialog.controls["skill_scroll"]
+		local widget =3D dialog.controls["skillscroll"]
 		widget.onMouseDown 		=3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget) end
 		end
@@ -100,10 +136,10 @@
 		end
 		=

 		-- scroll buttons
-		local widget =3D dialog.controls["skill_scroll_up"]
+		local widget =3D dialog.controls["skillscrollup"]
 		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then dialog:Scroll(-3) end end
 =

-		local widget =3D dialog.controls["skill_scroll_down"]
+		local widget =3D dialog.controls["skillscrolldown"]
 		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then dialog:Scroll(3) end end
 =

 		-- functions handling the up/down/lock switch
@@ -150,7 +186,7 @@
 				dialog.miScrollPosition =3D index
 				=

 				-- position the scroll position thing
-				dialog.controls["skill_scroll"].gfx:SetPos(scrollbar_x,scrollbar_y_sta=
rt + scrollbar_h*(index / maxindex))
+				dialog.controls["skillscroll"].gfx:SetPos(scrollbar_x,scrollbar_y_star=
t + scrollbar_h*(index / maxindex))
 				=

 				for k,skill in pairs(dialog.lSkill) do
 					if (skill.index >=3D index) and (skill.index < index + h) then
@@ -244,7 +280,7 @@
 					skill.button_use_drag.onMouseDown =3D function (widget,mousebutton)
 						if (mousebutton =3D=3D 1) then =

 							skill.button_use_drag.mStartX,skill.button_use_drag.mStartY =3D ski=
ll.button_use_drag.gfx:GetPos()
-							print("start",skill.button_use_drag.mStartX,skill.button_use_drag.m=
StartY)
+							--print("start",skill.button_use_drag.mStartX,skill.button_use_drag=
.mStartY)
 							skill.button_use_drag.dialog:BringToFront() =

 							gui.StartMoveDialog(skill.button_use_drag) =

 						end
@@ -329,7 +365,8 @@
 glQuickCastDialog =3D {}
 -- creates a quickcast button at the given position
 function CreateQuickCastButton (x,y,name,fun)
-	local dialog =3D CreateGumpDlgFromGfm(datapath.."gfm/quickcast.gfm")
+	-- local dialog =3D CreateGumpDlgFromGfm(datapath.."gfm/quickcast.gfm")
+	local dialog =3D GumpParser( quickskillGump, true )
 =

 	-- handle mouse events
 	for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
@@ -355,7 +392,7 @@
 	=

 	local text =3D guimaker.MakeText(root, 20, 5, name, gFontGumpSize, {1.0,1=
.0,1.0,1.0}, gFontNameDefault)
 	local w,h =3D text.gfx:GetDimensions()
-	print("size",text,w,h)
+	--print("size",text,w,h)
 	=

 	-- cast text button
 	local b =3D 2
@@ -364,7 +401,7 @@
 	button.mbIgnoreMouseOver =3D false
 	=

 	button.onLeftClick =3D function (widget)
-		print("click")
+		--print("click")
 		fun()
 	end
 	=


Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Tue Mar 11 19:05:53 2008
@@ -73,8 +73,8 @@
 function NotifyWarmode	(flag)
 	if (flag =3D=3D gWarmode_Normal) then
 		gActWarmode=3DgWarmode_Normal
-		AddFadeLines("Be the peace with you!")
-		JournalAddText("","Be the peace with you!")
+		AddFadeLines("Peace be with you!")
+		JournalAddText("","Peace be with you!")
 		--printf("NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: normal\n",i=
d)
 	end
 	if (flag =3D=3D gWarmode_Combat) then



From no-reply at zwischenwelt.org  Wed Mar 12 17:29:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Mar 2008 16:29:36 -0000
Subject: [Iris-commit] [IRIS] r1954 - in /trunk: lua/lib.unifont.lua
	ravenal_terrain.php
Message-ID: <20080312162937.20AD51524013@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Mar 12 17:29:35 2008
New Revision: 1954

Log:
added ravenal terrain code

Added:
    trunk/ravenal_terrain.php
Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Wed Mar 12 17:29:35 2008
@@ -3,7 +3,11 @@
 gUniFontTexAtlasSize =3D 512
 gUniFontLastTextureAtlas =3D nil
 =

+--~ gUniFontLoaderList[0] =3D unifont.mul
+--~ gUniFontLoaderList[i] =3D unifont(1-6).mul
+
 --[[
+	-- texatlas
 	local w =3D 1024
 	local iArtMapIDList =3D {65,129,321,449,513}
 	local sFilePath =3D "mytexatlas.png"
@@ -24,6 +28,20 @@
 	img:SaveAsFile(sFilePath)
 	pTexAtlas:Destroy()
 	img:Destroy()
+	=

+	=

+	-- spritelist
+	local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true)
+	spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
+	spritelist.asgroup:SetClip(24,4,122,22)
+	spritelist:SetTexture("guibase.png")
+	spritelist:ResizeList(1)
+	print("--SpriteList_Open")
+	SpriteList_Open(spritelist)
+	local iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z, r,g,b,a =3D 0, 0,0,32*4,=
32*4, 0,0, 1,1, 0,  1,0,0,0
+	--~ SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
+	SpriteList_SetSpriteEx(iSpriteIndex, l,t,w,h, u0,v0, uvw,0, 0,uvh, z, r,g=
,b,a)
+	SpriteList_Close()
 ]]--
 =

 -- texname,u0,v0,u1,v1
@@ -65,103 +83,145 @@
 	return unpack(glyphdata)
 end
 =

+kCharCode_Space				=3D string.byte(" ",1)
+kCharCode_Tab				=3D string.byte("\t",1)
+kCharCode_Nl				=3D string.byte("\n",1)
+kCharCode_Cr				=3D string.byte("\r",1)
+kCharCode_SpaceWidthChar	=3D string.byte("0",1) -- this charcode is used t=
o determine the width of "space"
+
+
+-- call after ogre init
+function CreateFontObject_Ogre (sFontName)
+	local sMatName,tGlyphTable =3D ExportOgreFont(sFontName)
+	local myfont =3D {}
+	myfont.sMatName		=3D sMatName
+	myfont.sTexName		=3D GetTexture(myfont.sMatName)
+	myfont.tGlyphTable	=3D tGlyphTable
+	myfont.zeroglyph	=3D myfont.tGlyphTable[kCharCode_SpaceWidthChar]
+	myfont.tSpaceAspect	=3D myfont.zeroglyph and myfont.zeroglyph.aspectRatio=
 or 1
+	=

+	myfont.GetDefaultFontSize	=3D function (self) return 44 end
+	myfont.GetGlyph				=3D function (self,iCharCode) =

+		local glyph =3D self.tGlyphTable[c]
+		local u0	=3D glyph.left
+		local v0	=3D glyph.top
+		local uvw	=3D glyph.right-u0
+		local uvh 	=3D glyph.bottom-v0
+		local w =3D h * glyph.aspectRatio
+		local xmove =3D w
+		return texname, xmove, xoff,yoff,w,h, u0,v0, uvw,0, 0,uvh
+	end
+	return myfont
+end
+
+function CreateFontObject_UO (loader)
+	local myfont =3D {}
+	local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(myfontloade=
r,kCharCode_SpaceWidthChar)
+	myfont.GetDefaultFontSize	=3D function (self) return 44 end
+	myfont.GetGlyph				=3D function (self,iCharCode,iFontSize) =

+		local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(myfontloader=
,iCharCode)
+		if (not texname) then return end
+		local s =3D 1 -- iFontSize
+		local b =3D 2
+		w,h =3D b+w+b,b+h+b
+		w,h =3D w*s,h*s
+		local uvw, uvh =3D u1-u0,v1-v0
+		local xmove =3D w - 3*s + ((xoff < 0) and xoff or -xoff) * s
+		return texname, xmove, xoff,yoff,w,h, u0,v0, uvw,0, 0,uvh
+	end
+end
+
+-- flowlayout =3D glyphlist + widgets as glyphs ?
+function CreateGlyphList (parentgroup2d)
+	local glyphlist =3D CreateRenderGroup2D(parentgroup2d)
+	glyphlist.spritelists =3D {}
+	glyphlist.glyphs =3D {}
+	return glyphlist
+end
+
+
+gGlyphListPrototype =3D {}
+
+-- r,g,b,a defaults to white
+-- iFontSize defaults to font-default
+function gGlyphListPrototype:AddFontText (fontobj,text,r,g,b,a,iFontSize)
+	local textlen =3D string.len(text)
+	for i=3D1,textlen do self:AddFontGlyph(fontobj,string.byte(text,i),r,g,b,=
a,iFontSize) end
+end
+
+-- fontobj : see CreateFontObject_Ogre()
+-- r,g,b,a defaults to white
+-- iFontSize defaults to font-default
+function gGlyphListPrototype:AddFontGlyph (fontobj,iCharCode,r,g,b,a,iFont=
Size)
+	if (iCharCode =3D=3D kCharCode_Space	) then self:AddSpace()		return end
+	if (iCharCode =3D=3D kCharCode_Tab		) then self:AddTab()		return end
+	if (iCharCode =3D=3D kCharCode_Nl		) then self:AddNewLine()	return end
+	if (iCharCode =3D=3D kCharCode_Nl		) then self:AddNewLine()	return end
+	r =3D r or 1
+	g =3D g or 1
+	b =3D b or 1
+	a =3D a or 1
+	local			texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy =3D fontobj:Ge=
tGlyph(iCharCode,iFontSize)
+	if (not texname) then return end -- todo : placeholder glyph defined by f=
ontobj ??
+	self:AddGlyph(	texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy, r,g,b,=
a)
+end
+
+function gGlyphListPrototype:Clear		() self.glyphs =3D {} end
+function gGlyphListPrototype:AddSpace	() table.insert(self.glyphs,kCharCod=
e_Space) end
+function gGlyphListPrototype:AddTab		() table.insert(self.glyphs,kCharCode=
_Tab) end
+function gGlyphListPrototype:AddNewLine	() table.insert(self.glyphs,kCharC=
ode_Nl) end
+function gGlyphListPrototype:AddGlyph	(texname, xmove, xoff,yoff,w,h, u0,v=
0, ux,vx, uy,vy, r,g,b,a)
+	table.insert(self.glyphs,			{texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx,=
 uy,vy, r,g,b,a})
+end
+
+
 function UniFontTest ()
-
-
-
-	local sFontName =3D "TrebuchetMSBold"
-	print("exporting ogre font ...")
-	local sMatName,tGlyphTable =3D ExportOgreFont(sFontName)
-	print("exporting ogre font finished")
-	local f =3D arrfirst(tGlyphTable)
-	print("font into",sMatName,countarr(tGlyphTable),f.left,f.top,f.right,f.b=
ottom,f.aspectRatio) -- Fonts/TrebuchetMSBold   133  ...
-	local myfont =3D {}
-	myfont.sMatName =3D sMatName
-	myfont.tGlyphTable =3D tGlyphTable
-	myfont.zeroglyph =3D myfont.tGlyphTable[string.byte("0",1)]
-	myfont.tSpaceAspect =3D myfont.zeroglyph and myfont.zeroglyph.aspectRatio=
 or 1
-	=

-	=

-	=

-	--~ gUniFontLoaderList[0] =3D unifont.mul
-	--~ gUniFontLoaderList[i] =3D unifont(1-6).mul
-	=

-	=

-	=

-	print("guitest_spritelist")
 	gRenderMan2D =3D CreateRenderManager2D()
 	gRenderMan2D_Dialogs =3D CreateRenderGroup2D(gRenderMan2D)
 	=

-	=

-	print("--CreateSpriteList")
-	if (false) then
-		local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true)
+	-- ogre font
+	local myfont_ogre	=3D CreateFontObject_Ogre("TrebuchetMSBold")
+	local myfont_uo0	=3D CreateFontObject_UO(gUniFontLoaderList[0]) -- 0=3Dme=
dieval 3=3Ddefault-chat
+	local myfont_uo3	=3D CreateFontObject_UO(gUniFontLoaderList[3])
+	=

+	local r,g,b,a =3D math.random(),math.random(),math.random(),1
+	=

+	=

+	function MyText (text,fontobj,parentgroup2d)
+		local group =3D CreateRenderGroup2D(parentgroup2d)
+		local spritelist =3D CreateSpriteList(group,false,true) =

 		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
-		spritelist.asgroup:SetClip(24,4,122,22)
-		spritelist:SetTexture("guibase.png")
-		spritelist:ResizeList(1)
-		print("--SpriteList_Open")
-		SpriteList_Open(spritelist)
-		local iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z, r,g,b,a =3D 0, 0,0,32*4=
,32*4, 0,0, 1,1, 0,  1,0,0,0
-		--~ SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
-		SpriteList_SetSpriteEx(iSpriteIndex, l,t,w,h, u0,v0, uvw,0, 0,uvh, z, r,=
g,b,a)
-		SpriteList_Close()
-	end
-	=

-	function MyText (text,fontobj,parent,parentgroup2d)
-		kCharCode_Space	=3D string.byte(" ",1)
-		kCharCode_Tab	=3D string.byte("\t",1)
-		kCharCode_Nl	=3D string.byte("\n",1)
-		kCharCode_Cr	=3D string.byte("\r",1)
-		local spritelist =3D CreateSpriteList(gRenderMan2D_Dialogs,false,true) =

-		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
-		local myfontloader =3D gUniFontLoaderList[0] -- 0=3Dmedieval 3=3Ddefault=
-chat
-		local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(myfontload=
er,string.byte("A",1))
-		--~ local texname =3D GetTexture(fontobj.sMatName)
 		--~ print("MyText",texname)
 		spritelist:SetTexture(texname)
-		local textlen =3D string.len(text)
 		spritelist:ResizeList(textlen)
 		SpriteList_Open(spritelist)
+		=

+		=

 		local x,y =3D 0,0
+		local textlen =3D string.len(text)
 		for i=3D1,textlen do =

-			local c =3D string.byte(text,i)
-			local ctxt =3D string.sub(text,i,i)
-			--~ print("MyText",i,c,ctxt)
+			local iCharCode =3D string.byte(text,i)
 			local texname =3D nil
-			local iCharCode =3D c
-			local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(myfontloa=
der,iCharCode)
-			local glyph =3D fontobj.tGlyphTable[c]
 			local h =3D 16
 			local spacew =3D h * fontobj.tSpaceAspect
 			local tablen =3D 4
 			local tabmaxw =3D tablen * spacew
-			if (c =3D=3D kCharCode_Space) then
+			if (iCharCode =3D=3D kCharCode_Space) then
 				x =3D x + spacew
-			elseif (c =3D=3D kCharCode_Tab) then
+			elseif (iCharCode =3D=3D kCharCode_Tab) then
 				x =3D math.ceil((x + spacew)/tabmaxw) * tabmaxw
-			elseif (c =3D=3D kCharCode_Nl) then
+			elseif (iCharCode =3D=3D kCharCode_Nl) then
 				x =3D 0
 				y =3D y + h
-			elseif (texname) then
-				--~ print("unifont_lastret",texname,u0,v0,u1,v1,xoff,yoff,fw,fh)
-				local b =3D 2
-				local s =3D 1
-				fw,fh =3D b+fw+b,b+fh+b
-				fw,fh =3D fw*s,fh*s
-				local uvw, uvh =3D u1-u0,v1-v0
-				local iSpriteIndex, l,t,z =3D i-1,x,y,0
-				x =3D x + fw - 3 * s
-				if (xoff > 0) then x =3D x - xoff*s else x =3D x + xoff*s end
-				local r,g,b,a =3D math.random(),math.random(),math.random(),1
-				--~ SpriteList_SetSprite(	iSpriteIndex,xoff*s+l,yoff*s+t,fw,fh, u0,v0,=
 uvw, uvh, z)
-				SpriteList_SetSpriteEx(	iSpriteIndex,xoff*s+l,yoff*s+t,fw,fh, u0,v0, u=
vw,0, 0,uvh, z, r,g,b,a)
-			elseif (glyph) then
-				local u0,v0, uvw, uvh =3D glyph.left,glyph.top, glyph.right-glyph.left=
, glyph.bottom-glyph.top
-				local w =3D h * glyph.aspectRatio
-				local iSpriteIndex, l,t,z =3D i-1,x,y,0
-				x =3D x + w
-				SpriteList_SetSprite(iSpriteIndex, l,t,w,h, u0,v0, uvw, uvh, z)
+			else
+				local iSpriteIndex =3D i-1
+				local texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy =3D fontobj:G=
etGlyph(iCharCode,iFontSize)
+				if (texname) then =

+					local z =3D 0
+					local r,g,b,a =3D 1,1,1,1
+					SpriteList_SetSpriteEx(iSpriteIndex, xoff+x,yoff+y,w,h, u0,v0, ux,vx,=
 uy,vy, z, r,g,b,a)
+					x =3D x + xmove
+				end
 			end
 		end
 		SpriteList_Close()



From no-reply at zwischenwelt.org  Wed Mar 12 17:30:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Mar 2008 16:30:42 -0000
Subject: [Iris-commit] [IRIS] r1955 - /trunk/lua/lib.unifont.lua
Message-ID: <20080312163044.32B9F1524013@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Mar 12 17:30:41 2008
New Revision: 1955

Log:
oops, committed halffinished fontcode, deactivated for now

Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Wed Mar 12 17:30:41 2008
@@ -176,6 +176,7 @@
 =

 =

 function UniFontTest ()
+	if (true) then return end
 	gRenderMan2D =3D CreateRenderManager2D()
 	gRenderMan2D_Dialogs =3D CreateRenderGroup2D(gRenderMan2D)
 	=




From no-reply at zwischenwelt.org  Wed Mar 12 21:15:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Mar 2008 20:15:03 -0000
Subject: [Iris-commit] [IRIS] r1956 - /trunk/lua/lib.terrain.multitex.lua
Message-ID: <20080312201504.1B23B1C1806F@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Mar 12 21:15:00 2008
New Revision: 1956

Log:
added explanatory asciart to lua/lib.terrain.multitex.lua

Modified:
    trunk/lua/lib.terrain.multitex.lua

Modified: trunk/lua/lib.terrain.multitex.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.terrain.multitex.lua (original)
+++ trunk/lua/lib.terrain.multitex.lua Wed Mar 12 21:15:00 2008
@@ -158,6 +158,52 @@
 			--~ 7     3
 			--~ 7     3
 			--~ 6 5 5 4  =

+			--[[
+			2 terrain types, o and X
+			+--------+--------+--------+--------+
+			|o o o o |o o o o |o o o o |o o o o | =

+			|o o o o |o o o o |o o o o |o o o o | =

+			|o o o o |o o o o |o o o o |o o o o | =

+			|o o o o |o o o X |X X X X |X o o o | =

+			+--------+--------+--------+--------+
+			|o o o o |o o o X |X X X X |X o o o | =

+			|o o o o |o o o X |X X X X |X o o o | =

+			|o o o o |o o o X |X X X X |X o o o | =

+			|o o o X |X X X X |X X X X |X o o o | =

+			+--------+--------+--------+--------+
+			|o o o X |X X X X |X X X X |X o o o | =

+			|o o o X |X X X X |X o o o |o o o o | =

+			|o o o X |X X X X |X o o o |o o o o | =

+			|o o o X |X X X X |X o o o |o o o o | =

+			+--------+--------+--------+--------+
+			|o o o X |X X X X |X o o o |o o o o | =

+			|o o o o |o o o o |o o o o |o o o o | =

+			|o o o o |o o o o |o o o o |o o o o | =

+			|o o o o |o o o o |o o o o |o o o o | =

+			+--------+--------+--------+--------+
+			=

+			only the 2 tiles completely filled with X have terraintype X, the other=
s have type o
+			=

+			in the tile on the right with
+			+--------+
+			|X X X X |
+			|X o o o |
+			|X o o o |
+			|X o o o |
+			+--------+
+			you can see that there is an X in the lefttop corner, even if the type =
of the basetype of the left-top tile is not X. , =

+			similar with =

+			+--------+
+			|X X X X |
+			|o o o o |
+			|o o o o |
+			|o o o o |
+			+--------+
+			=

+			so if the top is set, also the top-left and topright corners are set.
+			this saves us a number of combos.
+			=

+			]]--
 			local code =3D i
 			if (MaskTest(code,1)) then code =3D BitwiseOR(code,MaskFlag(0) + MaskFl=
ag(2)) end
 			if (MaskTest(code,5)) then code =3D BitwiseOR(code,MaskFlag(6) + MaskFl=
ag(4)) end



From no-reply at zwischenwelt.org  Wed Mar 12 21:56:33 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Mar 2008 20:56:33 -0000
Subject: [Iris-commit] [IRIS] r1957 - in /trunk: data/ data/gfm/ lua/
	lua/gui/ lua/net/ lua/obj/
Message-ID: <20080312205634.3903C1524013@zwischenwelt.org>

Author: sience
Date: Wed Mar 12 21:56:33 2008
New Revision: 1957

Log:
-several updates to remove gfm's
-gfm's removed
--gfms moved to archiv
-varans gumpmanager moved to archiv

Added:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/gui/gui.helper.lua
    trunk/lua/gui/gui.securetrade.lua
    trunk/lua/gui/gui.skill.lua
Removed:
    trunk/data/gfm/
    trunk/lua/gui/gui.gumpmanager.lua
    trunk/lua/lib.gui.iris.lua
    trunk/lua/lib.gumpparser.lua
    trunk/lua/lib.plaingui.iris.lua
    trunk/lua/lib.securetrade.lua
    trunk/lua/lib.skill.lua
Modified:
    trunk/data/config.lua.dist
    trunk/lua/gui/gui.main.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/gui/gui.quit.lua
    trunk/lua/lib.gfm.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/lib.speech.lua
    trunk/lua/lib.test.lua
    trunk/lua/main.lua
    trunk/lua/net/net.other.lua
    trunk/lua/obj/obj.container.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/obj/obj.player.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Wed Mar 12 21:56:33 2008
@@ -28,7 +28,6 @@
 gHideUOCursor =3D false
 gHideFPS =3D true							-- old but required for lugre
 gHideMemoryUsage =3D false				-- includes now also fps
-gHideOfflineModeTeleportMenu =3D true		-- currently broken
 =

 -- Font settings
 gFontNameDefault =3D "BerlinSans32"
@@ -176,11 +175,11 @@
 		gPolServer =3D false
 	}
 =

-gShardList["#offline"] =3D { =

+gShardList["# - Offline Mode"] =3D { =

 		gStartGameWithoutNetwork =3D true
 	}
 =

-gShardList["#debug"] =3D { =

+gShardList["# - Debug Mode"] =3D { =

 		gStartInDebugMode =3D true
 	}
 =


Modified: trunk/lua/gui/gui.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.main.lua (original)
+++ trunk/lua/gui/gui.main.lua Wed Mar 12 21:56:33 2008
@@ -1,11 +1,15 @@
 dofile(libpath .. "gui/gui.widget.lua")
-dofile(libpath .. "gui/gui.gumpmanager.lua")
+dofile(libpath .. "gui/gui.helper.lua")
+dofile(libpath .. "gui/gui.gumpparser.lua")
 dofile(libpath .. "gui/gui.paperdoll.lua")
 dofile(libpath .. "gui/gui.journal.lua")
 dofile(libpath .. "gui/gui.quit.lua")
 dofile(libpath .. "gui/gui.status.lua")
 dofile(libpath .. "gui/gui.styles.lua")
 dofile(libpath .. "gui/gui.hotbar.lua")
+dofile(libpath .. "gui/gui.healthbar.lua")
+dofile(libpath .. "gui/gui.securetrade.lua")
+dofile(libpath .. "gui/gui.skill.lua")
 =

 -- TODO
 dofile(libpath .. "gui/gui.container.lua")

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Wed Mar 12 21:56:33 2008
@@ -179,12 +179,11 @@
 	--print("CreatePaperdollItemWidget",gumpid,item.layer,animid,base_id)
 	local xoff,yoff =3D 9,19
 	local widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, xoff, yoff=
 , 0, 0, 0, item.hue)
-	local bitmask =3D GetGumpBitMask(gumpid)
-	widget:SetBitMask(bitmask)
+
+	widget.mbIgnoreMouseOver =3D false
 	widget.uoPaperdoll =3D paperdoll
 	widget.item =3D item
 	item.widget =3D widget
-	widget.mbIgnoreMouseOver =3D false
 =

 	widget.onMouseEnter =3D function () -- item tooltip (clientside,debuginfo=
s)
 							-- TODO : find a cleaner solution to override the mousepick tipp
@@ -359,7 +358,7 @@
 			dialog.controls["btnstatus"].onMouseDown =3D function (widget,mousebutt=
on)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
-																OpenStatus(widget.dialog.uoPaperdoll.mobile)
+																OpenHealthbar(widget.dialog.uoPaperdoll.mobile)
 															end
 														end
 		end

Modified: trunk/lua/gui/gui.quit.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.quit.lua (original)
+++ trunk/lua/gui/gui.quit.lua Wed Mar 12 21:56:33 2008
@@ -1,20 +1,37 @@
+-- Created 12.03.2008 16:40:10, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local quitGump =3D {}
+quitGump.dialogId =3D 34436564
+quitGump.x =3D 100
+quitGump.y =3D 100
+quitGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 0 0 2070 }" ..
+	 "{ button 36 78 2071 2072 1 0 quitcanel }" ..
+	 "{ button 99 78 2074 2075 1 0 quitok }" ..
+	 "{ text 70 25 0 0 }" ..
+	 "{ text 44 42 0 1 }"
+quitGump.textline =3D {
+	[0] =3D "Quit",
+	[1] =3D "Ultima Online?",
+}
+
 function OpenQuit()
-	local Gump =3D gGumpmanager.CreateGump( 100, 100 )
-	Gump.name =3D "quit"
-	=

-	Gump:addImage( 0, 0, hex2num("0x816"), 0, 0 )
-	Gump:addButton( 36, 78, hex2num("0x817"), hex2num("0x818"), hex2num("0x81=
9"), 0, 0 )
-	Gump:addButton( 99, 78, hex2num("0x81A"), hex2num("0x81B"), hex2num("0x81=
C"), 1, 0 )
-	Gump:addText( 35, 27, 'Quit', 0, 0, 0 )
-	Gump:addText( 35, 42, 'Ultima Online?', 0, 0, 0 )
-	=

-	Gump.onLeftClick =3D function( Gump, GumpObject )
-		if GumpObject.type =3D=3D gGumpmanager.gumpObjectType_Button then
-			if GumpObject.buttonid =3D=3D 0 then
-				Gump:destroy()
-			elseif GumpObject.buttonid =3D=3D 1 then
-				Terminate()
-			end
-		end
+	local dialog =3D GumpParser( quitGump, true )
+
+	dialog.onMouseDown =3D function (widget,mousebutton)
+		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
+		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end
 	end
+
+	dialog.controls["quitcanel"].onMouseDown =3D function (widget,mousebutton)
+												if (mousebutton =3D=3D 1) then
+													widget.dialog:Close()
+												end
+											end
+	dialog.controls["quitok"].onMouseDown =3D function (widget,mousebutton)
+												if (mousebutton =3D=3D 1) then
+													Terminate()
+												end
+											end
 end

Modified: trunk/lua/lib.gfm.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gfm.lua (original)
+++ trunk/lua/lib.gfm.lua Wed Mar 12 21:56:33 2008
@@ -5,7 +5,6 @@
 function GumpButtonSetOver		(widget) widget.gfx:SetMaterial(widget.mat_ove=
r) end
 function GumpButtonSetNormal	(widget) widget.gfx:SetMaterial(widget.mat_no=
rmal) end
 function GumpButtonSetPressed	(widget) widget.gfx:SetMaterial(widget.mat_p=
ressed) end
-
 =

 -- creates a button with mouseover and pressed effect
 -- w,h can be left out to determine automatically
@@ -151,6 +150,10 @@
 	local widget =3D guimaker.MakePlane(parent,mat,x,y,cx,cy)
 	local tw,th =3D texsize(w),texsize(h)
 	widget.gfx:SetUV(0,(skip_rows_from_top)/th,cx/tw,(cy+skip_rows_from_top)/=
th)
+	-- autogenerate bitmask
+	local bitmask =3D GetGumpBitMask(iGumpID)
+	widget:SetBitMask(bitmask)
+
 	widget.mbIgnoreMouseOver =3D true
 	return widget
 end
@@ -170,34 +173,16 @@
 	local widget =3D guimaker.MakePlane(parent,mat,x,y,cx,cy)
 	local tw,th =3D texsize(w),texsize(h)
 	widget.gfx:SetUV(0,(skip_rows_from_top)/th,cx/tw,(cy+skip_rows_from_top)/=
th)
+	-- autogenerate bitmask
+	local bitmask =3D GetArtBitMask (iArtID)
+	widget:SetBitMask(bitmask)
+
 	widget.mbIgnoreMouseOver =3D true
 	return widget
 end
 =

--- Obsolete, only for testing
+-- TODO: remove obsolete code, gfm's not used anymore
 --[[
-gGumpTestIndex =3D (hex2num("0xA28"))
-function GumpTestAdd (i) =

-	gGumpTestIndex =3D gGumpTestIndex + i
-	=

-	if (gGumpTestDlg.widget) then
-		gGumpTestDlg.widget:Destroy()
-		gGumpTestDlg.widget =3D nil
-	end
-	=

-	local testmat =3D gGumpLoader:CreateMaterial(gGumpTestIndex)
-	if (testmat and testmat ~=3D "") then
-		gGumpLoader:Load(gGumpTestIndex)
-		local w,h =3D gGumpLoader:GetSize()
-		local tw,th =3D texsize(w),texsize(h)
-		gGumpTestDlg.widget =3D guimaker.MakePlane(gGumpTestDlg,testmat,-w/2,-h/=
2,w,h)
-		local widget =3D gGumpTestDlg.widget
-		widget.gfx:SetUV(0,0,w/tw,h/th)
-		widget.gfx:SetAlignment(kGfx2DAlign_Center,kGfx2DAlign_Center)
-	end
-end
-]]--
-
 function CreateGumpDlgFromGfm (path) =

 	local dialog =3D guimaker.MakeSortedDialog()
 	if (gGumpLoader) then
@@ -245,12 +230,10 @@
 	elseif (attr.class =3D=3D "picture") then
 			widget =3D MakeBorderGumpPart(dialog.rootwidget,hex2num(gump[1]),attr.l=
eft,attr.top,attr.width,attr.height)
 		-- TODO :  "data/gfm/healthbar.gfm" "data/gfm/main_menu.gfm" "data/gfm/b=
ackground.gfm" "data/gfm/askquit.gfm"
-		--[[
-		<control class=3D'picture' name=3D'picture_816' left=3D'0' top=3D'0' wid=
th=3D'178' height=3D'108' freezed=3D'1' visible=3D'1' alpha=3D'0' flags=3D'=
0'>
-		 <event onclick=3D'' onclose=3D'' onmouseup=3D'' onmousedown=3D'' onkeyp=
ressed=3D''/>
-		 <gump>0x816</gump>
-		</control>
-		]]--
+		--<control class=3D'picture' name=3D'picture_816' left=3D'0' top=3D'0' w=
idth=3D'178' height=3D'108' freezed=3D'1' visible=3D'1' alpha=3D'0' flags=
=3D'0'>
+		--<event onclick=3D'' onclose=3D'' onmouseup=3D'' onmousedown=3D'' onkey=
pressed=3D''/>
+		--<gump>0x816</gump>
+		--</control>
 	elseif (attr.class =3D=3D "checkbox") then =

 		-- "data/gfm/secure_trade.gfm"
 			local bChecked =3D tonumber(hex2num(xmlchild(node,"checked")[1])) =3D=
=3D 1  -- <checked>0</checked>
@@ -269,44 +252,4 @@
 		dialog.controls[attr.name] =3D widget
 	end
 end
-
--- Obsolete, only for testing
---[[
-function GfmDump (path)
-	print("GfmDump",path)
-	local formnode =3D xmlchild(LuaXML_ParseFile(path),"form")
-	print("width=3D",formnode.attr.width)
-	print("height=3D",formnode.attr.height)
-	local k,child
-	for k,child in ipairs(formnode) do if (child.name =3D=3D "control") then
-		printf("control : class=3D%s, name=3D'%s', left=3D%s, top=3D%s, width=3D=
%s, height=3D%s\n",
-			child.attr.class,
-			child.attr.name,
-			child.attr.left,
-			child.attr.top,
-			child.attr.width,
-			child.attr.height
-			)
-		local node =3D xmlchild(child,"gump")
-		if (node) then =

-			printf("  gump(%s):",node[1] or "")
-			if (node.attr) then for an,av in pairs(node.attr) do if (av ~=3D "") th=
en printf(" %s=3D%s",an,av) end end end
-			printf("\n")
-		end
-		=

-		local node =3D xmlchild(child,"event")
-		if (node) then =

-			printf("  event(%s):",node[1] or "")
-			if (node.attr) then for an,av in pairs(node.attr) do if (av ~=3D "") th=
en printf(" %s=3D%s",an,av) end end end
-			printf("\n")
-		end
-		=

-		local node =3D xmlchild(child,"text")
-		if (node) then =

-			printf("  text(%s):",node[1] or "")
-			if (node.attr) then for an,av in pairs(node.attr) do if (av ~=3D "") th=
en printf(" %s=3D%s",an,av) end end end
-			printf("\n")
-		end
-	end end
-end
 ]]--

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Wed Mar 12 21:56:33 2008
@@ -2,13 +2,21 @@
 =

 gMainMenuCamAng =3D 0
 =

-function StopLoadingBackground ()
+local function GetShardButtonText (shard,shardname)
+	if (shard.gLoginname) then
+		return shardname..":"..(shard.gLoginname or "")
+	else
+		return shardname
+	end
+end
+
+local function StopLoadingBackground ()
 	if (gLoadingBackground) then
 		gLoadingBackground:Destroy()
 	end
 end
 =

-function MainMenuConnectToShard (shard,shardname,loginname,loginpass)
+local function MainMenuConnectToShard (shard,shardname,loginname,loginpass)
 	-- activate shard
 	for k,v in pairs(shard) do =

 		--print("shard",k,v) =

@@ -41,6 +49,139 @@
 	Send_Account_Login_Request(gLoginname,gPassword) -- 0x80 kPacket_Account_=
Login_Request
 	-- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
 end
+
+local function MainMenuShowCharCreationDialog (template,slot)
+	-- TODO : unfinished, need more gui-elements for colorpicking, skill valu=
es etc..
+	=

+	local MyCreateChar =3D function(widget) =

+		local edittextwidget =3D widget.dialog.controls["nameinput"]
+		--print("MyCreateChar",widget.chartemplate,widget.charslot,edittextwidge=
t.plaintext)
+		CreateCharFromTemplate(widget.chartemplate,widget.charslot,edittextwidge=
t.plaintext ,"") -- see lib.charcreate.lua
+		widget.dialog:Destroy()
+	end
+	local rows =3D {
+		{	{type=3D"Label",		text=3D"Character Creation"} },
+		=

+		{	{type=3D"Label",		text=3D"Name:"},
+			{type=3D"EditText",	w=3D300,h=3D16,text=3D"IrisTestChar",controlname=3D=
"nameinput"}  },
+			=

+		{	{type=3D"Button",onLeftClick=3DMyCreateChar,chartemplate=3Dtemplate,ch=
arslot=3Dslot,text=3D"Create Character"},
+			{type=3D"Label",	text=3D"(iris does not support all the options for cha=
r creation yet,\n"..
+								"you can only pick a name, if you want to set all the options your=
self,\n"..
+								"you can create the char using another client, and then login with=
 iris)"}
+			},
+		=

+	}
+	=

+	gCharCreateDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefa=
ultStyleSet,"window")
+end
+
+local function LoadShardfilter(filterfilepath)
+	if (filterfilepath) then
+		if (file_exists(gMainWorkingDir..filterfilepath) ) then
+			print("Load custom shard-specific Filter: "..gMainWorkingDir..filterfil=
epath)
+			dofile(gMainWorkingDir..filterfilepath)
+		else
+			print("Shard-specific Filter not found: "..gMainWorkingDir..filterfilep=
ath)
+		end
+	end
+end
+
+local function StartOfflineMode ()
+	gStartGameWithoutNetwork =3D true
+	MultiTexTerrain_NotifyMapChange()
+	=

+	local x,y,z =3D -183,203,0
+	--if (gGroundBlockLoader) then x,y,z =3D -gGroundBlockLoader:GetMapW()*8/=
2,gGroundBlockLoader:GetMapH()*8/2,0 end
+	if (gOfflineModeCamStart) then x,y,z =3D unpack(gOfflineModeCamStart) end
+	gCurrentRenderer:InitLocalCam(x,y,z)
+
+	-- Binds key and Inits all InGame-Data
+	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
+
+	-- offline : tilefree walk teleport
+	BindDown("f6",function ()
+		gTileFreeWalk:SetPos_All(gTileFreeWalk:RoundPos(gTileFreeWalk:MousePickP=
os()))
+	end)
+	=

+	-- Unbind some keys only for offline mode (rest is the same as InGame)
+	UnBindArr({"u","q","e","tab","r","t","k","j","b","p","g","h","y"})
+end
+
+local function MainMenuShowLoginDialog (shard,shardname)
+	-- TODO : unfinished, pol server options...
+	=

+	local MyLogin =3D function (widget) =

+		local shard =3D widget.shard
+		shard.gLoginServerIP 	=3D 			widget.dialog.controls["loginserverinput"].=
plaintext
+		shard.gLoginServerPort 	=3D tonumber(	widget.dialog.controls["loginporti=
nput"].plaintext)
+		local nameinput =3D widget.dialog.controls["nameinput"].plaintext
+		local passinput =3D widget.dialog.controls["passinput"].plaintext
+		-- TOOD : password style field
+		--print("MainMenuConnectToShard",shard,widget.shardname,nameinput,passin=
put)
+		MainMenuConnectToShard(shard,widget.shardname,nameinput,passinput)
+		widget.dialog:Destroy()
+	end
+	local rows =3D {
+		{	{type=3D"Label",		text=3D"Login"} },
+			=

+		{	{type=3D"Label",		text=3D"LoginServer:"},
+			{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gLoginServerIP or ""),=
controlname=3D"loginserverinput"},
+			{type=3D"EditText",	w=3D100,h=3D16,text=3D(shard.gLoginServerPort or ""=
),controlname=3D"loginportinput"}  },
+			=

+		{	{type=3D"Label",		text=3D"Name:"},
+			{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gLoginname or ""),cont=
rolname=3D"nameinput"}  },
+			=

+		{	{type=3D"Label",		text=3D"Pass:"},
+			{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gPassword or ""),contr=
olname=3D"passinput",bPassWordStyle=3Dtrue}  },
+			=

+		{	{type=3D"Label",		text=3D"Tipp:"},
+			{type=3D"Label",		text=3D	"On many shards you can you can just login wi=
th a username/password you wish\n"..
+										"to create a new account if you don't have one already"}, },
+			=

+		{	{type=3D"Button",onLeftClick=3DMyLogin,shard=3Dshard,shardname=3Dshard=
name,text=3D"Login"}, },
+		=

+	}
+
+	LoadShardfilter(shard.gCustomArtFilterFilePath)
+
+	if (shard.gStartGameWithoutNetwork =3D=3D true) then
+		StartOfflineMode()
+	elseif(shard.gStartInDebugMode =3D=3D true) then
+		StartDebugMenu()
+	else
+		gLoginDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefaultS=
tyleSet,"window")
+	end
+end
+
+local function StopMainMenu ()
+	if (gMainMenuDialog) then
+		gMainMenuDialog:Destroy()
+		gMainMenuDialog=3Dnil
+	end
+end
+
+local function SetMainMenuCam (roth,rotv)
+	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
+	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

+	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
+	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
+	=

+	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
+	GetMainCam():SetRot(w,x,y,z)	=

+end
+
+local function MainMenuSetBackground_Sky ()
+	local cam =3D GetMainCam()
+	cam:SetFOVy(gfDeg2Rad*45)
+	cam:SetNearClipDistance(0.5) -- old : 1
+	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
+	cam:SetProjectionType(0) -- perspective
+	Client_SetSkybox("sunset") -- cleansky skybox sunset darksun
+	SetMainMenuCam(0,gfDeg2Rad)
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
 =

 --gameserverlist selection
 function MainMenuShowServerList (serverlist)
@@ -148,114 +289,15 @@
 	gCharListDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefaul=
tStyleSet,"window")
 end
 =

-function MainMenuShowCharCreationDialog (template,slot)
-	-- TODO : unfinished, need more gui-elements for colorpicking, skill valu=
es etc..
-	=

-	local MyCreateChar =3D function(widget) =

-		local edittextwidget =3D widget.dialog.controls["nameinput"]
-		--print("MyCreateChar",widget.chartemplate,widget.charslot,edittextwidge=
t.plaintext)
-		CreateCharFromTemplate(widget.chartemplate,widget.charslot,edittextwidge=
t.plaintext ,"") -- see lib.charcreate.lua
-		widget.dialog:Destroy()
-	end
-	local rows =3D {
-		{	{type=3D"Label",		text=3D"Character Creation"} },
-		=

-		{	{type=3D"Label",		text=3D"Name:"},
-			{type=3D"EditText",	w=3D300,h=3D16,text=3D"IrisTestChar",controlname=3D=
"nameinput"}  },
-			=

-		{	{type=3D"Button",onLeftClick=3DMyCreateChar,chartemplate=3Dtemplate,ch=
arslot=3Dslot,text=3D"Create Character"},
-			{type=3D"Label",	text=3D"(iris does not support all the options for cha=
r creation yet,\n"..
-								"you can only pick a name, if you want to set all the options your=
self,\n"..
-								"you can create the char using another client, and then login with=
 iris)"}
-			},
-		=

-	}
-	=

-	gCharCreateDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefa=
ultStyleSet,"window")
-end
-
-function LoadShardfilter(filterfilepath)
-	if (filterfilepath) then
-		if (file_exists(gMainWorkingDir..filterfilepath) ) then
-			print("Load custom shard-specific Filter: "..gMainWorkingDir..filterfil=
epath)
-			dofile(gMainWorkingDir..filterfilepath)
-		else
-			print("Shard-specific Filter not found: "..gMainWorkingDir..filterfilep=
ath)
-		end
-	end
-end
-
-function MainMenuShowLoginDialog (shard,shardname)
-	-- TODO : unfinished, pol server options...
-	=

-	local MyLogin =3D function (widget) =

-		local shard =3D widget.shard
-		shard.gLoginServerIP 	=3D 			widget.dialog.controls["loginserverinput"].=
plaintext
-		shard.gLoginServerPort 	=3D tonumber(	widget.dialog.controls["loginporti=
nput"].plaintext)
-		local nameinput =3D widget.dialog.controls["nameinput"].plaintext
-		local passinput =3D widget.dialog.controls["passinput"].plaintext
-		-- TOOD : password style field
-		--print("MainMenuConnectToShard",shard,widget.shardname,nameinput,passin=
put)
-		MainMenuConnectToShard(shard,widget.shardname,nameinput,passinput)
-		widget.dialog:Destroy()
-	end
-	local rows =3D {
-		{	{type=3D"Label",		text=3D"Login"} },
-			=

-		{	{type=3D"Label",		text=3D"LoginServer:"},
-			{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gLoginServerIP or ""),=
controlname=3D"loginserverinput"},
-			{type=3D"EditText",	w=3D100,h=3D16,text=3D(shard.gLoginServerPort or ""=
),controlname=3D"loginportinput"}  },
-			=

-		{	{type=3D"Label",		text=3D"Name:"},
-			{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gLoginname or ""),cont=
rolname=3D"nameinput"}  },
-			=

-		{	{type=3D"Label",		text=3D"Pass:"},
-			{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gPassword or ""),contr=
olname=3D"passinput",bPassWordStyle=3Dtrue}  },
-			=

-		{	{type=3D"Label",		text=3D"Tipp:"},
-			{type=3D"Label",		text=3D	"On many shards you can you can just login wi=
th a username/password you wish\n"..
-										"to create a new account if you don't have one already"}, },
-			=

-		{	{type=3D"Button",onLeftClick=3DMyLogin,shard=3Dshard,shardname=3Dshard=
name,text=3D"Login"}, },
-		=

-	}
-
-	LoadShardfilter(shard.gCustomArtFilterFilePath)
-
-	if (shard.gStartGameWithoutNetwork =3D=3D true) then
-		StartOfflineMode()
-	elseif(shard.gStartInDebugMode =3D=3D true) then
-		StartDebugMenu()
-	else
-		gLoginDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefaultS=
tyleSet,"window")
-	end
-end
-
-function GetShardButtonText (shard,shardname)
-	return shardname..":"..(shard.gLoginname or "???")
-end
-
-function StartOfflineMode ()
-	gStartGameWithoutNetwork =3D true
-	MultiTexTerrain_NotifyMapChange()
-	=

-	local x,y,z =3D -183,203,0
-	--if (gGroundBlockLoader) then x,y,z =3D -gGroundBlockLoader:GetMapW()*8/=
2,gGroundBlockLoader:GetMapH()*8/2,0 end
-	if (gOfflineModeCamStart) then x,y,z =3D unpack(gOfflineModeCamStart) end
-	gCurrentRenderer:InitLocalCam(x,y,z)
-	=

-	InitPlainGUI()
-
-	-- Binds key and Inits all InGame-Data
-	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
-
-	-- offline : tilefree walk teleport
-	BindDown("f6",function ()
-		gTileFreeWalk:SetPos_All(gTileFreeWalk:RoundPos(gTileFreeWalk:MousePickP=
os()))
-	end)
-	=

-	-- Unbind some keys only for offline mode (rest is the same as InGame)
-	UnBindArr({"u","q","e","tab","r","t","k","j","b","p","g","h","y"})
+function MainMenuFinishedPreLoading ()
+	SetUOCursor(0)
+	if (gLoadingBackground) then StopLoadingBackground () end
+end
+
+function StepMainMenu ()
+	if (gMainMenuDialog) then =

+		-- currently unused
+	end
 end
 =

 function StartMainMenu ()
@@ -282,20 +324,28 @@
 		{ {type=3D"Label",	text=3D"Login:"} }
 	}
 =

-	local fun =3D function (widget) MainMenuShowLoginDialog(widget.shard,widg=
et.shardname) StopMainMenu() end
+	local fun =3D function (widget)
+		MainMenuShowLoginDialog(widget.shard,widget.shardname)
+		StopMainMenu()
+	end
+
 	for shardname,shard in pairs(gShardList) do
 		table.insert(rows,{ {type=3D"Button",	onLeftClick=3Dfun,shard=3Dshard,sh=
ardname=3Dshardname,text=3DGetShardButtonText(shard,shardname)} })
 	end
 =

-	table.insert(rows,{ {type=3D"Button",text=3D"#gfx-config",onLeftClick=3Df=
unction ()
+	table.insert(rows,{ {type=3D"Button",text=3D"# - Graphic Options",onLeftC=
lick=3Dfunction ()
 		StopMainMenu()
 		if (Client_ShowOgreConfig()) then
 			DisplayNotice("please restart iris2 for the changes to take effekt")
+			StopMainMenu()
 			Exit() -- Terminate()  -- terminate softly is not enough, no frame can =
be drawn since ogre::root has to be killed for fullscreen switch
 			-- todo : reinit ogre here ? might loose already loaded textures =3D(
 		end	=

 		end } })
-	table.insert(rows,{ {type=3D"Button",text=3D"#exit",onLeftClick=3Dfunctio=
n () Terminate() end } })
+	table.insert(rows,{ {type=3D"Button",text=3D"# - Exit",onLeftClick=3Dfunc=
tion ()
+			StopMainMenu()
+			Terminate()
+		end } })
 =

 	MainMenuSetBackground_Sky()
 =

@@ -303,41 +353,3 @@
 		gMainMenuDialog =3D guimaker.MakeTableDlg(rows,10,10,false,true,gGuiDefa=
ultStyleSet,"window") =

 	end
 end
-
-function MainMenuFinishedPreLoading ()
-	SetUOCursor(0)
-	if (gLoadingBackground) then StopLoadingBackground () end
-end
-
-function StopMainMenu ()
-	if (gMainMenuDialog) then
-		gMainMenuDialog:Destroy()
-		gMainMenuDialog=3Dnil
-	end
-end
-
-function StepMainMenu ()
-	if (gMainMenuDialog) then =

-		-- currently unused
-	end
-end
-
-function MainMenuSetBackground_Sky ()
-	local cam =3D GetMainCam()
-	cam:SetFOVy(gfDeg2Rad*45)
-	cam:SetNearClipDistance(0.5) -- old : 1
-	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
-	cam:SetProjectionType(0) -- perspective
-	Client_SetSkybox("sunset") -- cleansky skybox sunset darksun
-	SetMainMenuCam(0,gfDeg2Rad)
-end
-
-function SetMainMenuCam (roth,rotv)
-	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
-	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

-	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
-	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
-	=

-	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
-	GetMainCam():SetRot(w,x,y,z)	=

-end

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Wed Mar 12 21:56:33 2008
@@ -24,7 +24,7 @@
 			local mobile =3D GetMobile(iSerial)
 			local iMouseX,iMouseY =3D GetMousePos()
 			-- -50,-30 to place the dialog beneath the mouse
-			OpenStatus(mobile,iMouseX - 50,iMouseY - 30)
+			OpenHealthbar(mobile,iMouseX - 50,iMouseY - 30)
 		end
 	else
 		-- normal doubleclick handling

Modified: trunk/lua/lib.speech.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.speech.lua (original)
+++ trunk/lua/lib.speech.lua Wed Mar 12 21:56:33 2008
@@ -1,6 +1,6 @@
 -- speech.mul loader
 -- Keywords detected from client-chat, converted back to index id and send=
 to server
--- see also http://doc.wpdev.org/formats/speech.html (dead link)...
+-- see also http://doc.wpdev.org/formats/speech.html (dead link)...
 =

 =

 function SpeechParseKeywords (ascistr) -- used by Send_UnicodeSpeech kPack=
et_Speech_Unicode 0xAD
@@ -13,7 +13,7 @@
 				local keyword =3D speechentry.text
 				local startpos =3D string.find(ascistr,keyword,0,true)
 				if (startpos) then =

-					print("SpeechParseKeywords:found keyword",keyword,startpos,speechid)
+					--print("SpeechParseKeywords:found keyword",keyword,startpos,speechid)
 					table.insert(speechlistbypos,{ startpos=3Dstartpos, speechid=3Dspeech=
id, keyword=3Dkeyword })
 					found_for_this_speechid =3D true
 				end

Modified: trunk/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.test.lua (original)
+++ trunk/lua/lib.test.lua Wed Mar 12 21:56:33 2008
@@ -4,19 +4,6 @@
 function TestGuiSystem2_Step ()
 	local widget =3D gui.GetWidgetUnderMouse()
 	Client_SetBottomLine("TestGuiSystem2 WidgetUnderMouse : "..(widget and (w=
idget.mytext or "unknown") or "NONE"))
-end
-
-function TestGuiSystem3_Init()
-	--[[local gump =3D gGumpmanager.CreateGump( 40, 40 )
-	gump:addImage( 0, 0, 1, 0, 0 ) =

-	gump:addTiledImage( 0, 0, 150, 150, hex2num("0x588"), 0, 0 )
-	gump:addButton( 10, 10, hex2num("0x1589"), hex2num("0x158B"), hex2num("0x=
1589"), 1, 0, 0 )
-	gump:addText( 10, 30, "Bla blub", 1, 0, 0 )
-	gump:addBackground( 150, 100, 200, 25, hex2num("0xBB8"), 0, 0 )
-	gump:addImage( 60, 175, hex2num("0xD5"), 0, 0 )
-        gump:addTiledImage( 73, 175, 74, 14, hex2num("0xD6"), 0, 0 )
-        gump:addImage( 147, 175, hex2num("0xD7"), 0, 0 )
-        gump:addScrollbar( 60, 175, true, 100, hex2num("0xD8"), hex2num("0=
xD8"), 1, 0 )]]--
 end
 =

 function TestZLib()

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Wed Mar 12 21:56:33 2008
@@ -25,11 +25,8 @@
 dofile(lugreluapath .. "lugre.lua")
 lugre_include_libs(lugreluapath)
 dofile(libpath .. "lib.sound.iris.lua")
-dofile(libpath .. "lib.gui.iris.lua")
 dofile(libpath .. "lib.input.iris.lua")
 dofile(libpath .. "lib.keybinds.lua")
-dofile(libpath .. "lib.plaingui.iris.lua")
-
 dofile(libpath .. "lib.xml.lua")
 dofile(libpath .. "lib.net.lua")
  =

@@ -54,12 +51,10 @@
 dofile(libpath .. "lib.gfm.lua")
 dofile(libpath .. "lib.protocol.lua")
 dofile(libpath .. "lib.mousepick.lua")
-dofile(libpath .. "lib.gumpparser.lua")
 dofile(libpath .. "lib.data.lua")
 dofile(libpath .. "lib.cliloc.lua")
 dofile(libpath .. "lib.macrolist.lua")
 dofile(libpath .. "lib.walking2.lua")
-dofile(libpath .. "lib.skill.lua")
 dofile(libpath .. "lib.spellbooks.lua")
 dofile(libpath .. "lib.speech.lua")
 dofile(libpath .. "lib.granny.lua")
@@ -85,7 +80,6 @@
 dofile(libpath .. "lib.oldwalk.lua")
 dofile(libpath .. "lib.bugreport.lua")
 dofile(libpath .. "lib.buff.lua")
-dofile(libpath .. "lib.securetrade.lua")
 dofile(libpath .. "lib.unifont.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
@@ -297,7 +291,7 @@
 	InitNet()
 =

 	LoadingProfile("init basic gui")
-	gui.StartLoading()
+	CreateIrisLogo()
 =

 	LoadBasicData()
 =

@@ -322,7 +316,7 @@
 =

 	StartMainMenu()
 	=

-	if (true) then UniFontTest() end
+	if (false) then UniFontTest() end
 =

 	-- mainloop
 	while (Client_IsAlive()) do =

@@ -384,8 +378,8 @@
 =

 	print("Welcome to Iris")
 =

-	-- create player status dialog and stuff like this
-	PlayerGuiInit()
+	-- create player healthbar dialog
+	OpenPlayerHealthbar()
 =

 	-- stop menu music
 	SoundStopMusic()
@@ -412,7 +406,7 @@
 		gCurrentRenderer:CombatGuiStep()
 		if (gCurrentRenderer.MobileAnimStep) then gCurrentRenderer:MobileAnimSte=
p() end
 		gCurrentRenderer:CamStep()
-		gui.Step()
+		GuiStep()
 	else
 		StepMainMenu()
 	end

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Wed Mar 12 21:56:33 2008
@@ -166,8 +166,7 @@
 =

 	if (subcmd =3D=3D kPacket_Generic_SubCommand_CloseStatus) then	--0x0C
 		local mobilestatus_serial =3D input:PopNetUint8()
-		-- TODO:	=

-		--closemobilestatusgump(mobilestatus_serial)
+		CloseHealthbar(mobilestatus_serial)
 	end
 =

 	-- AOSTooltip

Modified: trunk/lua/obj/obj.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.container.lua (original)
+++ trunk/lua/obj/obj.container.lua Wed Mar 12 21:56:33 2008
@@ -61,9 +61,6 @@
 		widget.onMouseDown	=3D function (widget,mousebutton) end
 	else
 		widget =3D MakeArtGumpPart (parent,item.artid,item.xloc,item.yloc,0,0,0,=
item.hue)
-		=

-		-- for exact mousepicking
-		widget:SetBitMask( GetArtBitMask(item.artid + hex2num("0x4000")) )
 =

 		widget.mbIgnoreMouseOver =3D false
 		widget.uoContainer =3D item.container

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Wed Mar 12 21:56:33 2008
@@ -116,14 +116,14 @@
 	if (self.stats.curHits and self.stats.maxHits) then
 		if (self.serial =3D=3D gPlayerBodySerial) then
 			-- for player
-			gui.SetHitpoints(self.stats.curHits/self.stats.maxHits)
-			if (self.stats.curMana)		then gui.SetMana(	self.stats.curMana		/self.st=
ats.maxMana		) end
-			if (self.stats.curStamina)	then gui.SetStamina(self.stats.curStamina	/s=
elf.stats.maxStamina	) end
+			SetHitpoints(self.stats.curHits/self.stats.maxHits)
+			if (self.stats.curMana)		then SetMana(	self.stats.curMana		/self.stats.=
maxMana		) end
+			if (self.stats.curStamina)	then SetStamina(self.stats.curStamina	/self.=
stats.maxStamina	) end
 			-- update big_stats window
 			UpdateStatusAos()
 		else
 			-- for other mobiles
-			SetNpcStatusHitpoints(self, self.stats.curHits / self.stats.maxHits)
+			SetNpcHealthbarHitpoints(self, self.stats.curHits / self.stats.maxHits)
 		end
 	end
 	=

@@ -220,7 +220,7 @@
 		self.stats.maxMana =3D maxvalue
 =

 		if (self.serial =3D=3D gPlayerBodySerial) then
-			gui.SetMana(curvalue/maxvalue)
+			SetMana(curvalue/maxvalue)
 			-- update big_stats window
 			UpdateStatusAos()
 		end
@@ -237,7 +237,7 @@
 		self.stats.maxStamina =3D maxvalue
 =

 		if (self.serial =3D=3D gPlayerBodySerial) then
-			gui.SetStamina(curvalue/maxvalue)
+			SetStamina(curvalue/maxvalue)
 			-- update big_stats window
 			UpdateStatusAos()
 		end
@@ -272,7 +272,7 @@
 	self:NotifyListener("Mobile_Destroy")
 	=

 	-- destroy Status Gump from NPC
-	CloseStatus(self)
+	CloseHealthbar(self)
 	=

 	self:DestroyContent() -- warning, triggers self:Update()
 	=


Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Wed Mar 12 21:56:33 2008
@@ -83,7 +83,7 @@
 		JournalAddText("","You go into War!")
 		--printf("NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: combat\n",i=
d)
 	end
-	gui.SetWarmode(gActWarmode)
+	SetWarmode(gActWarmode)
 end
 =

 =

@@ -97,7 +97,7 @@
 		PlayerBackpackItemUpdated()
 =

 		-- reinit player status dialog and stuff like this
-		PlayerGuiInit()
+		OpenPlayerHealthbar()
 	end
 end
 =




From no-reply at zwischenwelt.org  Wed Mar 12 22:53:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Mar 2008 21:53:38 -0000
Subject: [Iris-commit] [IRIS] r1958 - /trunk/lua/lib.unifont.lua
Message-ID: <20080312220013.A15A01524017@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Mar 12 22:53:37 2008
New Revision: 1958

Log:
worked on text-code for new guisystem

Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Wed Mar 12 22:53:37 2008
@@ -2,6 +2,7 @@
 =

 gUniFontTexAtlasSize =3D 512
 gUniFontLastTextureAtlas =3D nil
+kTabLen =3D 4
 =

 --~ gUniFontLoaderList[0] =3D unifont.mul
 --~ gUniFontLoaderList[i] =3D unifont(1-6).mul
@@ -85,8 +86,8 @@
 =

 kCharCode_Space				=3D string.byte(" ",1)
 kCharCode_Tab				=3D string.byte("\t",1)
-kCharCode_Nl				=3D string.byte("\n",1)
-kCharCode_Cr				=3D string.byte("\r",1)
+kCharCode_Nl				=3D string.byte("\n",1) -- newline
+kCharCode_Cr				=3D string.byte("\r",1) -- carriage return
 kCharCode_SpaceWidthChar	=3D string.byte("0",1) -- this charcode is used t=
o determine the width of "space"
 =

 =

@@ -100,15 +101,23 @@
 	myfont.zeroglyph	=3D myfont.tGlyphTable[kCharCode_SpaceWidthChar]
 	myfont.tSpaceAspect	=3D myfont.zeroglyph and myfont.zeroglyph.aspectRatio=
 or 1
 	=

-	myfont.GetDefaultFontSize	=3D function (self) return 44 end
-	myfont.GetGlyph				=3D function (self,iCharCode) =

-		local glyph =3D self.tGlyphTable[c]
+	myfont.GetDefaultFontSize	=3D function (self) return 24 end
+	myfont.GetSpaceWidth		=3D function (self,iFontSize) return self.tSpaceAsp=
ect * iFontSize end
+	myfont.GetLineHeight		=3D function (self,iFontSize) return iFontSize end
+	myfont.GetGlyph				=3D function (self,iCharCode,iFontSize) =

+		local glyph =3D self.tGlyphTable[iCharCode]
+		if (not glyph) then return end
 		local u0	=3D glyph.left
 		local v0	=3D glyph.top
 		local uvw	=3D glyph.right-u0
 		local uvh 	=3D glyph.bottom-v0
-		local w =3D h * glyph.aspectRatio
+		local h		=3D iFontSize
+		local w		=3D h * glyph.aspectRatio
+		local xoff =3D 0
+		local yoff =3D 0
 		local xmove =3D w
+		local texname =3D myfont.sTexName
+		--~ print("CreateFontObject_Ogre:GetGlyph:",self,iCharCode,iFontSize,tex=
name, xmove, xoff,yoff,w,h, u0,v0, uvw,0, 0,uvh)
 		return texname, xmove, xoff,yoff,w,h, u0,v0, uvw,0, 0,uvh
 	end
 	return myfont
@@ -116,26 +125,32 @@
 =

 function CreateFontObject_UO (loader)
 	local myfont =3D {}
-	local texname,u0,v0,u1,v1,xoff,yoff,fw,fh =3D GetUniFontGlyph(myfontloade=
r,kCharCode_SpaceWidthChar)
-	myfont.GetDefaultFontSize	=3D function (self) return 44 end
+	local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(loader,kCharC=
ode_SpaceWidthChar)
+	myfont.spacewidth =3D w
+	myfont.defaultlineh =3D 1.5 * math.max(1,h)
+	myfont.GetDefaultFontSize	=3D function (self) return myfont.defaultlineh =
end
+	myfont.GetSpaceWidth		=3D function (self,iFontSize) return self.spacewidt=
h end
+	myfont.GetLineHeight		=3D function (self,iFontSize) return self.defaultli=
neh end
 	myfont.GetGlyph				=3D function (self,iCharCode,iFontSize) =

-		local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(myfontloader=
,iCharCode)
+		local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(loader,iChar=
Code)
 		if (not texname) then return end
-		local s =3D 1 -- iFontSize
-		local b =3D 2
-		w,h =3D b+w+b,b+h+b
-		w,h =3D w*s,h*s
+		local s =3D math.max(1,round(iFontSize / myfont.defaultlineh))
+		local b =3D 2 -- border, the glyph image is actually bigger than the w,h=
 returned by GetUniFontGlyph
+		w,h =3D (b+w+b)*s,(b+h+b)*s
 		local uvw, uvh =3D u1-u0,v1-v0
-		local xmove =3D w - 3*s + ((xoff < 0) and xoff or -xoff) * s
+		local xmove =3D w - 3*s + xoff*s
 		return texname, xmove, xoff,yoff,w,h, u0,v0, uvw,0, 0,uvh
 	end
+	return myfont
 end
 =

 -- flowlayout =3D glyphlist + widgets as glyphs ?
+-- glyphlist is derived from rendergroup2d
 function CreateGlyphList (parentgroup2d)
 	local glyphlist =3D CreateRenderGroup2D(parentgroup2d)
-	glyphlist.spritelists =3D {}
-	glyphlist.glyphs =3D {}
+	glyphlist.spritelists	=3D {}
+	glyphlist.glyphs		=3D {}
+	ArrayOverwrite(glyphlist,gGlyphListPrototype)
 	return glyphlist
 end
 =

@@ -153,84 +168,152 @@
 -- r,g,b,a defaults to white
 -- iFontSize defaults to font-default
 function gGlyphListPrototype:AddFontGlyph (fontobj,iCharCode,r,g,b,a,iFont=
Size)
-	if (iCharCode =3D=3D kCharCode_Space	) then self:AddSpace()		return end
-	if (iCharCode =3D=3D kCharCode_Tab		) then self:AddTab()		return end
-	if (iCharCode =3D=3D kCharCode_Nl		) then self:AddNewLine()	return end
-	if (iCharCode =3D=3D kCharCode_Nl		) then self:AddNewLine()	return end
-	r =3D r or 1
-	g =3D g or 1
-	b =3D b or 1
-	a =3D a or 1
+	iFontSize =3D iFontSize or fontobj:GetDefaultFontSize()
+	if (iCharCode =3D=3D kCharCode_Space	) then self:AddSpace(	fontobj:GetSpa=
ceWidth(iFontSize),fontobj:GetLineHeight(iFontSize)) return end
+	if (iCharCode =3D=3D kCharCode_Tab		) then self:AddTab(		fontobj:GetSpace=
Width(iFontSize),fontobj:GetLineHeight(iFontSize)) return end
+	if (iCharCode =3D=3D kCharCode_Nl		) then self:AddNewLine(	fontobj:GetLin=
eHeight(iFontSize)) return end
+	if (iCharCode =3D=3D kCharCode_Cr		) then return end -- ignore
 	local			texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy =3D fontobj:Ge=
tGlyph(iCharCode,iFontSize)
 	if (not texname) then return end -- todo : placeholder glyph defined by f=
ontobj ??
 	self:AddGlyph(	texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy, r,g,b,=
a)
 end
 =

 function gGlyphListPrototype:Clear		() self.glyphs =3D {} end
-function gGlyphListPrototype:AddSpace	() table.insert(self.glyphs,kCharCod=
e_Space) end
-function gGlyphListPrototype:AddTab		() table.insert(self.glyphs,kCharCode=
_Tab) end
-function gGlyphListPrototype:AddNewLine	() table.insert(self.glyphs,kCharC=
ode_Nl) end
+function gGlyphListPrototype:AddNewLine	(lineh)			table.insert(self.glyphs=
,{kCharCode_Nl		,lineh}) end
+function gGlyphListPrototype:AddSpace	(spacew,lineh)	table.insert(self.gly=
phs,{kCharCode_Space	,spacew,lineh or 0}) end
+function gGlyphListPrototype:AddTab		(spacew,lineh)	table.insert(self.glyp=
hs,{kCharCode_Tab		,spacew,lineh or 0}) end
 function gGlyphListPrototype:AddGlyph	(texname, xmove, xoff,yoff,w,h, u0,v=
0, ux,vx, uy,vy, r,g,b,a)
-	table.insert(self.glyphs,			{texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx,=
 uy,vy, r,g,b,a})
-end
-
+	table.insert(self.glyphs,			{texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx,=
 uy,vy, r or 1,g or 1,b or 1,a or 0.5})
+end
+function gGlyphListPrototype:AddIcon	(texname, w,h, u0,v0, u1,v1, r,g,b,a)=
 self:AddGlyph(texname,w,0,0,w,h,u0,v0, u1-u0,0, 0,v1-v0, r,g,b,a) end
+
+function gGlyphListPrototype:ClearSpriteLists ()
+	for k,spritelist in pairs(self.spritelists) do spritelist:Destroy() end
+	self.spritelists =3D {}
+end
+
+function gGlyphListPrototype:UpdateGeometry	()
+	-- release old spritelists
+	self:ClearSpriteLists()
+	=

+	-- prepare loopvars
+	local last_texname =3D nil
+	local last_spritelist =3D nil
+	local x,y =3D 0,0
+	local z =3D 0
+	local iSpriteIndex =3D 0
+
+	-- iterate over glyphs
+	local glyphcount =3D table.getn(self.glyphs)
+	for i=3D1,glyphcount do
+		local glyph =3D self.glyphs[i]
+		if (glyph[1] =3D=3D kCharCode_Space) then -- space
+			local code,spacew,lineh =3D unpack(glyph)
+			x =3D x + spacew
+		elseif (glyph[1] =3D=3D kCharCode_Tab) then -- tab
+			local code,spacew,lineh =3D unpack(glyph)
+			local tabmaxw =3D kTabLen * spacew
+			x =3D math.ceil((x + spacew)/tabmaxw) * tabmaxw
+		elseif (glyph[1] =3D=3D kCharCode_Nl) then -- newline
+			local code,lineh =3D unpack(glyph)
+			x =3D 0
+			y =3D y + lineh
+		else -- printable char
+			local texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy, r,g,b,a =3D u=
npack(glyph)
+			if (last_texname ~=3D texname) then
+				-- determine how many glyphs until texname-change
+				local len =3D 0 =

+				for j=3Di,glyphcount do =

+					local glyph =3D self.glyphs[j]
+					if (	glyph[1] =3D=3D kCharCode_Space) then =

+					elseif (glyph[1] =3D=3D kCharCode_Tab) then =

+					elseif (glyph[1] =3D=3D kCharCode_Nl) then =

+					else
+						if (glyph[1] ~=3D texname) then break end
+						len =3D len + 1
+					end
+				end
+				=

+				-- close last spritelist
+				if (last_spritelist) then SpriteList_Close() end
+				=

+				-- start new spritelist
+				last_texname =3D texname
+				local parent =3D self -- glyphlist is derived from rendergroup2d
+				last_spritelist =3D CreateSpriteList(parent,false,true) =

+				last_spritelist.asgroup =3D last_spritelist:CastToRenderGroup2D()
+				last_spritelist:SetTexture(texname)
+				last_spritelist:ResizeList(len)
+				SpriteList_Open(last_spritelist)
+				iSpriteIndex =3D 0
+			end
+			=

+			-- add the sprite to the list
+			SpriteList_SetSpriteEx(iSpriteIndex, xoff+x,yoff+y,w,h, u0,v0, ux,vx, u=
y,vy, z, r,g,b,a)
+			x =3D x + xmove
+			iSpriteIndex =3D iSpriteIndex + 1
+		end
+		=

+	end
+	=

+	-- close spritelist
+	if (last_spritelist) then SpriteList_Close() end
+end
 =

 function UniFontTest ()
-	if (true) then return end
+	ToggleLogo()
+	ToggleLogo()
+	--~ gTestNoIrisLogo =3D true
+	=

+	--~ if (true) then return end
 	gRenderMan2D =3D CreateRenderManager2D()
 	gRenderMan2D_Dialogs =3D CreateRenderGroup2D(gRenderMan2D)
-	=

-	-- ogre font
-	local myfont_ogre	=3D CreateFontObject_Ogre("TrebuchetMSBold")
-	local myfont_uo0	=3D CreateFontObject_UO(gUniFontLoaderList[0]) -- 0=3Dme=
dieval 3=3Ddefault-chat
-	local myfont_uo3	=3D CreateFontObject_UO(gUniFontLoaderList[3])
-	=

-	local r,g,b,a =3D math.random(),math.random(),math.random(),1
-	=

-	=

-	function MyText (text,fontobj,parentgroup2d)
-		local group =3D CreateRenderGroup2D(parentgroup2d)
-		local spritelist =3D CreateSpriteList(group,false,true) =

-		spritelist.asgroup =3D spritelist:CastToRenderGroup2D()
-		--~ print("MyText",texname)
-		spritelist:SetTexture(texname)
-		spritelist:ResizeList(textlen)
-		SpriteList_Open(spritelist)
-		=

-		=

-		local x,y =3D 0,0
-		local textlen =3D string.len(text)
-		for i=3D1,textlen do =

-			local iCharCode =3D string.byte(text,i)
-			local texname =3D nil
-			local h =3D 16
-			local spacew =3D h * fontobj.tSpaceAspect
-			local tablen =3D 4
-			local tabmaxw =3D tablen * spacew
-			if (iCharCode =3D=3D kCharCode_Space) then
-				x =3D x + spacew
-			elseif (iCharCode =3D=3D kCharCode_Tab) then
-				x =3D math.ceil((x + spacew)/tabmaxw) * tabmaxw
-			elseif (iCharCode =3D=3D kCharCode_Nl) then
-				x =3D 0
-				y =3D y + h
-			else
-				local iSpriteIndex =3D i-1
-				local texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy =3D fontobj:G=
etGlyph(iCharCode,iFontSize)
-				if (texname) then =

-					local z =3D 0
-					local r,g,b,a =3D 1,1,1,1
-					SpriteList_SetSpriteEx(iSpriteIndex, xoff+x,yoff+y,w,h, u0,v0, ux,vx,=
 uy,vy, z, r,g,b,a)
-					x =3D x + xmove
-				end
-			end
+	local glyphlist =3D CreateGlyphList(gRenderMan2D_Dialogs)
+	=

+	=

+	=

+	local myfont_ogre	=3D CreateFontObject_Ogre("TrebuchetMSBold") -- ogre fo=
nt
+	local myfont_uo0	=3D CreateFontObject_UO(gUniFontLoaderList[0]) -- 0=3Dme=
dieval =

+	local myfont_uo3	=3D CreateFontObject_UO(gUniFontLoaderList[3]) -- 3=3Dde=
fault-chat
+	=

+	local mytext =3D "Hallo, test 0123\nBlablubblub\nUnicode:=C3=A4=C3=B6=C3=
=BC=C3=9F=C3=84=C3=96=C3=9C(german)\nTab\t1\tTabtest\nt\t1\n\t1\n\t\t2\n\t\=
t\t3\nFont1"
+	-- glyphlist:AddFontText(fontobj,text,r,g,b,a,iFontSize)
+	glyphlist:AddFontText(myfont_uo0,mytext)
+	glyphlist:AddFontText(myfont_ogre,",font2")
+	glyphlist:AddFontText(myfont_uo3,",font3\n")
+	=

+	local funchars =3D "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1=
234567890"
+	for y=3D0,4 do
+		for i=3D0,30 do
+			local cpos =3D math.random(string.len(funchars))
+			local c =3D string.sub(funchars,cpos,cpos)
+			local r,g,b,a =3D math.random(),math.random(),math.random(),1
+			local r =3D math.random()
+			local font =3D myfont_uo0
+			if (math.random() < 0.5) then font =3D myfont_uo0 end
+			--~ if (math.random() < 0.3) then font =3D myfont_ogre end
+			glyphlist:AddFontText(font,c,r,g,b,a)
 		end
-		SpriteList_Close()
-		=

-		return spritelist
-	end
-	=

-	local mytextspritelist =3D MyText("Hallo, test 123\nBlablubblub\nUnicode:=
=C3=A4=C3=B6=C3=BC=C3=9F=C3=84=C3=96=C3=9C(german)\nTab\t1\tTabtest\nt\t1\n=
\t1\n\t\t2\n\t\t\t3",myfont,gRenderMan2D_Dialogs)
-		=

-end
-
+		glyphlist:AddFontText(myfont_uo3,"\n")
+	end
+	glyphlist:AddFontText(myfont_uo3,"Fonts ")
+	glyphlist:AddFontText(myfont_uo0,"and ")
+	glyphlist:AddFontText(myfont_uo3,"C", 1,0,0)
+	glyphlist:AddFontText(myfont_uo3,"o", 0,0,1)
+	glyphlist:AddFontText(myfont_uo3,"l", 0,1,1)
+	glyphlist:AddFontText(myfont_uo3,"o", 0,1,0)
+	glyphlist:AddFontText(myfont_uo3,"r", 1,0,1)
+	glyphlist:AddFontText(myfont_uo3,"s", 1,1,0)
+	glyphlist:AddFontText(myfont_uo0," can be")
+	glyphlist:AddFontText(myfont_uo3," mixed\n")
+	=

+	glyphlist:AddFontText(myfont_uo3,"including images ")
+	glyphlist:AddIcon("art_fallback.png",	16,16, 0,0, 1,1)
+	glyphlist:AddFontText(myfont_uo3," is also possible, even colored ")
+	=

+	local texname, w,h, u0,v0, u1,v1, r,g,b,a =3D "guibase.png", 16,16, 0,0.5=
, 0.5,1
+	glyphlist:AddIcon(texname, w,h, u0,v0, u1,v1, 1,0,0,1) glyphlist:AddSpace=
(4)
+	glyphlist:AddIcon(texname, w,h, u0,v0, u1,v1, 0,1,0,1)
+	glyphlist:UpdateGeometry()
+end
+



From no-reply at zwischenwelt.org  Thu Mar 13 00:45:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Mar 2008 23:45:41 -0000
Subject: [Iris-commit] [IRIS] r1959 - /trunk/lua/lib.unifont.lua
Message-ID: <20080312234541.D013F1524013@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar 13 00:45:41 2008
New Revision: 1959

Log:
tweaked font example a bit

Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Thu Mar 13 00:45:41 2008
@@ -127,7 +127,8 @@
 	local myfont =3D {}
 	local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(loader,kCharC=
ode_SpaceWidthChar)
 	myfont.spacewidth =3D w
-	myfont.defaultlineh =3D 1.5 * math.max(1,h)
+	--~ myfont.defaultlineh =3D 1.5 * math.max(1,h)
+	myfont.defaultlineh =3D 20
 	myfont.GetDefaultFontSize	=3D function (self) return myfont.defaultlineh =
end
 	myfont.GetSpaceWidth		=3D function (self,iFontSize) return self.spacewidt=
h end
 	myfont.GetLineHeight		=3D function (self,iFontSize) return self.defaultli=
neh end
@@ -185,7 +186,7 @@
 function gGlyphListPrototype:AddGlyph	(texname, xmove, xoff,yoff,w,h, u0,v=
0, ux,vx, uy,vy, r,g,b,a)
 	table.insert(self.glyphs,			{texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx,=
 uy,vy, r or 1,g or 1,b or 1,a or 0.5})
 end
-function gGlyphListPrototype:AddIcon	(texname, w,h, u0,v0, u1,v1, r,g,b,a)=
 self:AddGlyph(texname,w,0,0,w,h,u0,v0, u1-u0,0, 0,v1-v0, r,g,b,a) end
+function gGlyphListPrototype:AddIcon	(texname, w,h, yoff, u0,v0, u1,v1, r,=
g,b,a) self:AddGlyph(texname,w,0,yoff,w,h,u0,v0, u1-u0,0, 0,v1-v0, r,g,b,a)=
 end
 =

 function gGlyphListPrototype:ClearSpriteLists ()
 	for k,spritelist in pairs(self.spritelists) do spritelist:Destroy() end
@@ -276,15 +277,16 @@
 	local myfont_uo0	=3D CreateFontObject_UO(gUniFontLoaderList[0]) -- 0=3Dme=
dieval =

 	local myfont_uo3	=3D CreateFontObject_UO(gUniFontLoaderList[3]) -- 3=3Dde=
fault-chat
 	=

-	local mytext =3D "Hallo, test 0123\nBlablubblub\nUnicode:=C3=A4=C3=B6=C3=
=BC=C3=9F=C3=84=C3=96=C3=9C(german)\nTab\t1\tTabtest\nt\t1\n\t1\n\t\t2\n\t\=
t\t3\nFont1"
+	--~ local mytext =3D "Hallo, test 0123\nBlablubblub\nUnicode:=C3=A4=C3=B6=
=C3=BC=C3=9F=C3=84=C3=96=C3=9C(german)\nTab\t1\tTabtest\nt\t1\n\t1\n\t\t2\n=
\t\t\t3\nFont1"
+	local mytext =3D "Hello, test 0123\nUnicode:=C3=A4=C3=B6=C3=BC=C3=9F=C3=
=84=C3=96=C3=9C(german)\nFont1"
 	-- glyphlist:AddFontText(fontobj,text,r,g,b,a,iFontSize)
 	glyphlist:AddFontText(myfont_uo0,mytext)
 	glyphlist:AddFontText(myfont_ogre,",font2")
 	glyphlist:AddFontText(myfont_uo3,",font3\n")
 	=

 	local funchars =3D "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1=
234567890"
-	for y=3D0,4 do
-		for i=3D0,30 do
+	for y=3D0,0 do
+		for i=3D0,20 do
 			local cpos =3D math.random(string.len(funchars))
 			local c =3D string.sub(funchars,cpos,cpos)
 			local r,g,b,a =3D math.random(),math.random(),math.random(),1
@@ -296,24 +298,30 @@
 		end
 		glyphlist:AddFontText(myfont_uo3,"\n")
 	end
-	glyphlist:AddFontText(myfont_uo3,"Fonts ")
-	glyphlist:AddFontText(myfont_uo0,"and ")
+	glyphlist:AddFontText(myfont_uo0,"Fonts ")
+	glyphlist:AddFontText(myfont_uo3,"and ")
 	glyphlist:AddFontText(myfont_uo3,"C", 1,0,0)
 	glyphlist:AddFontText(myfont_uo3,"o", 0,0,1)
 	glyphlist:AddFontText(myfont_uo3,"l", 0,1,1)
 	glyphlist:AddFontText(myfont_uo3,"o", 0,1,0)
 	glyphlist:AddFontText(myfont_uo3,"r", 1,0,1)
 	glyphlist:AddFontText(myfont_uo3,"s", 1,1,0)
-	glyphlist:AddFontText(myfont_uo0," can be")
-	glyphlist:AddFontText(myfont_uo3," mixed\n")
-	=

-	glyphlist:AddFontText(myfont_uo3,"including images ")
-	glyphlist:AddIcon("art_fallback.png",	16,16, 0,0, 1,1)
-	glyphlist:AddFontText(myfont_uo3," is also possible, even colored ")
+	glyphlist:AddFontText(myfont_uo3," can be")
+	glyphlist:AddFontText(myfont_uo0," mixed\n")
+	=

+	glyphlist:AddFontText(myfont_uo3,"you can include images ")
+	--~ glyphlist:AddSpace(2)
+	--~ glyphlist:AddIcon("art_fallback.png",	18,18, 0, 0,0, 1,1)
+	local e =3D 1/8
+	glyphlist:AddIcon("compassframe_zoomin.png", 24,24, -2, e,e, 1-e,1-e)
+	glyphlist:AddFontText(myfont_uo0,"12",0,1,0)
+	glyphlist:AddFontText(myfont_uo3,",\nand even color them ")
 	=

 	local texname, w,h, u0,v0, u1,v1, r,g,b,a =3D "guibase.png", 16,16, 0,0.5=
, 0.5,1
-	glyphlist:AddIcon(texname, w,h, u0,v0, u1,v1, 1,0,0,1) glyphlist:AddSpace=
(4)
-	glyphlist:AddIcon(texname, w,h, u0,v0, u1,v1, 0,1,0,1)
+	glyphlist:AddIcon(texname, w,h, 2, u0,v0, u1,v1, 1,1,1,1) glyphlist:AddSp=
ace(4)
+	glyphlist:AddIcon(texname, w,h, 2, u0,v0, u1,v1, 1,0,0,1) glyphlist:AddSp=
ace(4)
+	glyphlist:AddIcon(texname, w,h, 2, u0,v0, u1,v1, 0,1,0,1)
+	glyphlist:AddFontText(myfont_uo3," =3D)")
 	glyphlist:UpdateGeometry()
 end
 =




From no-reply at zwischenwelt.org  Thu Mar 13 23:36:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 13 Mar 2008 22:36:08 -0000
Subject: [Iris-commit] [IRIS] r1960 - in /trunk/lua: gui/gui.gumpparser.lua
 gui/gui.healthbar.lua gui/gui.paperdoll.lua lib.protocol.lua
Message-ID: <20080313223611.A2EC11524013@zwischenwelt.org>

Author: sience
Date: Thu Mar 13 23:36:07 2008
New Revision: 1960

Log:
-gumps update, button functions moved to gumparray
-paperdoll & healthbar are working , skill & journalgump not yet

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.protocol.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Thu Mar 13 23:36:07 2008
@@ -160,11 +160,6 @@
 =

 	-- set Dialog ID / Serial
 	dialog.dialogId =3D Gumpdata.dialogId
-	=

-	-- if dialogid is a clientside dialog (found in clientside dialoglist)...=
 turn of send packets and turn on function handler
-	--if dialog.dialogId =3D "paperdoll" then
-	--	gClientsideManualGump=3Dtrue
-	--end
 =

 	dialog.Close =3D function (dialog)
 		gGumpPosition[dialog.dialogId] =3D { x=3Ddialog.rootwidget.gfx:GetDerive=
dLeft() , y=3Ddialog.rootwidget.gfx:GetDerivedTop() }
@@ -181,7 +176,13 @@
 	dialog.uo_text =3D {}
 =

 	dialog.onMouseDown =3D function (widget,mousebutton)
-		if (mousebutton =3D=3D 2) then CloseServerSideGump(Gumpdata.playerid, Gu=
mpdata.dialogId, 0) end
+		if (mousebutton =3D=3D 2) then
+			if (Clientsidemode) then
+				-- TODO: close clientside gump here !!!!!!!!
+			else
+				CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, 0)
+			end
+		end
 		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end
 	end
 =

@@ -328,21 +329,20 @@
 			--				<released-id> and <pressed-id> specify the buttongraphic. If pres=
sed check for <return-value>.
 			--				Use <page-id> to switch between pages and <quit>=3D1/0 to close t=
he gump.
 			elseif ((command =3D=3D "button") and (table.getn(bToken)>=3D 7)) then	=
-- >=3D7 because pol buttons returns 7 or 8 arguments
-				local widget =3D MakeGumpButton (curparent,bToken[4],bToken[4],bToken[=
5],bToken[2],bToken[3],nil,nil,false)
-				if (bToken[8]) then widget.returnmsg =3D bToken[8] end
-				widget.page			=3D tonumber(bToken[7])
-
 				if (Clientsidemode) then
-					dialog.controls[widget.returnmsg] =3D widget
+					local widget =3D MakeGumpButtonFunctionOnClick (curparent,bToken[4],b=
Token[4],bToken[5],bToken[2],bToken[3],
+																	nil,nil,Gumpdata.functions[ tonumber(bToken[8]) ])
 				else
+					local widget =3D MakeGumpButton (curparent,bToken[4],bToken[4],bToken=
[5],bToken[2],bToken[3],nil,nil,false)
+					if (bToken[8]) then widget.returnmsg =3D bToken[8] end
+					widget.page			=3D tonumber(bToken[7])
 					widget.onLeftClick =3D function (widget)
 											if (widget.page > 0 and not(widget.page > table.getn(pages)) ) =
then
 												printdebug("gump","Parsegump Button: Switch to Page "..widget.=
page.."/"..table.getn(pages))
 												widget.dialog:ShowPage(widget.page)
 											elseif (widget.returnmsg) then
 												printdebug("gump","Button pressed -> Send button return_messag=
e: "..widget.returnmsg)
-												GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
-												widget.dialog:Close()
+												CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, widg=
et.returnmsg)
 											end
 										end
 				end
@@ -360,15 +360,12 @@
 =

 				if not(Clientsidemode) then
 					widget.onLeftClick =3D function (widget)
-											if (widget.returnmsg) then
-												printdebug("gump","Button pressed -> Send buttontileart return=
_message: "..widget.returnmsg)
-												GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
-											end
 											if (widget.page > 0 and not(widget.page > table.getn(pages)) ) =
then
-												printdebug("gump","Parsegump Button: Switch to Page "..widget.=
page.."/"..table.getn(pages))
+												printdebug("gump","Parsegump buttontileart: Switch to Page "..=
widget.page.."/"..table.getn(pages))
 												widget.dialog:ShowPage(widget.page)
 											else
-												widget.dialog:Close()
+												printdebug("gump","Parsegump buttontileart: pressed -> Send bu=
tton return_message: "..widget.returnmsg)
+												CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, widg=
et.returnmsg)
 											end
 										end
 				end
@@ -524,11 +521,11 @@
 		printdebug("gump","ServerSideGump page ",page.pagenum," childs: ",myc)
 	end
 =

+	-- hide all except page 0 and 1
+	dialog:ShowPage(1)
+
 	if not(Clientsidemode) then
 		gServerSideGump[Gumpdata.dialogId] =3D dialog
-	=

-		-- hide all except page 0 and 1
-		dialog:ShowPage(1)
 	else
 		return dialog
 	end

Modified: trunk/lua/gui/gui.healthbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.healthbar.lua (original)
+++ trunk/lua/gui/gui.healthbar.lua Thu Mar 13 23:36:07 2008
@@ -24,7 +24,7 @@
 local npchealthGump =3D {}
 npchealthGump.dialogId =3D 1234
 npchealthGump.x =3D 0
-npchealthGump.y =3D 0
+npchealthGump.y =3D 60
 npchealthGump.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2052 healthbar }" ..
@@ -137,9 +137,7 @@
 =

 	-- widgets in this dialog handle mouse
 	for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
-	=

-	dialog.rootwidget.gfx:SetPos(x,y)
-	=

+
 	dialog.onMouseDown =3D function (widget,mousebutton)
 		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
 		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Thu Mar 13 23:36:07 2008
@@ -6,44 +6,106 @@
 -- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local playerPaperdoll =3D {}
-playerPaperdoll.dialogId =3D 1234
-playerPaperdoll.x =3D 10
-playerPaperdoll.x =3D 10
+playerPaperdoll.dialogId =3D 7493484
+playerPaperdoll.x =3D 120
+playerPaperdoll.y =3D 100
 playerPaperdoll.Data =3D
  "{ page 0 }" ..
  "{ gumppic 4 4 2000 }" ..
- "{ button 187 50 2031 2032 1 0 btnhelp }" ..
- "{ button 187 76 2006 2007 1 0 btnoptions }" ..
+ "{ button 187 50 2031 2032 1 0 0 }" ..
+ "{ button 187 76 2006 2007 1 0 1 }" ..
 -- "{ croppedtext 36 263 200 40 0 0 paperdollname }" ..
  "{ text 36 263 0 0 paperdollname }" ..
- "{ button 84 6 113 113 1 0 btnvirtues }" ..
- "{ button 187 102 2009 2010 1 0 btnquit }" ..
- "{ button 187 130 22453 22455 1 0 btnquests }" ..
- "{ button 187 156 2015 2016 1 0 btnskills }" ..
- "{ button 187 181 22450 22452 1 0 btnguild }" ..
- "{ button 187 205 2021 2022 1 0 btnpeace }" ..
- "{ button 187 233 2027 2028 1 0 btnstatus }"
+ "{ button 84 6 113 113 1 0 2 }" ..
+ "{ button 187 102 2009 2010 1 0 3 }" ..
+ "{ button 187 130 22453 22455 1 0 4 }" ..
+ "{ button 187 156 2015 2016 1 0 5 }" ..
+ "{ button 187 181 22450 22452 1 0 6 }" ..
+ "{ button 187 205 2021 2022 1 0 7 }" ..
+ "{ button 187 233 2027 2028 1 0 8 }"
 playerPaperdoll.textline =3D {
  [0] =3D "paperdoll_name",
 }
+playerPaperdoll.functions =3D {
+ -- help
+ [0]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then Send=
_RequestHelp() end end,
+ -- options
+ [1]	=3D function (widget,mousebutton) end,
+ -- virtues
+ [2]	=3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 1) then
+				local playermobile =3D GetPlayerMobile()
+				--warning ! playerserial might be wrong here, usually this param is th=
e gump-serial"
+				GumpReturnMsg(playermobile.serial, hex2num("0x000001CD"), hex2num("0x0=
0000001"), nil, hex2num("0x00000001"), playermobile.serial)
+			end
+		  end,
+ -- quit
+ [3]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then Open=
Quit() end end,
+ -- quests
+ [4]	=3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 1) then
+				Send_AOSCommand(kPacket_AOS_Command_QuestGumpRequest,gPlayerBodySerial)
+			end
+		  end,
+ -- skills
+ [5]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then Togg=
leSkill() end end,
+ -- guild
+ [6]	=3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 1) then
+				Send_AOSCommand(kPacket_AOS_Command_GuildGumpRequest,gPlayerBodySerial)
+			end
+		  end,
+ -- peace
+ [7]	=3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 1) then
+				if (gActWarmode=3D=3DgWarmode_Normal) then
+					Send_CombatMode(gWarmode_Combat)
+					widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
+					widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
+					widget.mat_over 	=3D GetGumpMat(hex2num("0x7EA"))
+				else
+					Send_CombatMode(gWarmode_Normal)
+					widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E5"))
+					widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E6"))
+					widget.mat_over 	=3D GetGumpMat(hex2num("0x7E7"))
+				end
+			end
+		  end,
+ -- status
+ [8]	=3D function (widget,mousebutton)
+ 			if (mousebutton =3D=3D 1) then
+ 				ToggleStatusAos()
+ 			end
+ 		  end,
+}
+
 -- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local npcPaperdoll =3D {}
-npcPaperdoll.dialogId =3D 1235
-npcPaperdoll.x =3D 10
-npcPaperdoll.x =3D 10
+npcPaperdoll.dialogId =3D 89878734
+npcPaperdoll.x =3D 120
+npcPaperdoll.y =3D 100
 npcPaperdoll.Data =3D
  "{ page 0 }" ..
  "{ gumppic 4 4 2001 }" ..
 -- "{ croppedtext 36 263 200 40 0 0 paperdollname }" ..
  "{ text 36 263 0 0 paperdollname }" ..
- "{ button 187 233 2027 2028 1 0 btnstatus }"
+ "{ button 187 233 2027 2028 1 0 0 }"
 npcPaperdoll.textline =3D {
  [0] =3D "paperdoll_name",
 }
+npcPaperdoll.functions =3D {
+ -- status
+ [0]	=3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 1) then
+				widget.gfx:SetMaterial(widget.mat_pressed)
+				OpenHealthbar(widget.dialog.uoPaperdoll.mobile)
+			end
+		  end
+}
 =

 local kGumpBaseId_Male	=3D 50000
-local kGumpBaseId_Female	=3D 60000
+local kGumpBaseId_Female=3D 60000
 =

 -- WARNING ! this is not a complete list (see gLayerType for that) , e.g. =
kLayer_Mound =3D 0x19 is not in here
 gLayerOrder =3D {
@@ -246,126 +308,22 @@
 	-- create paperdoll dialog if neccessary
 	local dialog =3D paperdoll.dialog
 	if (not dialog) then
-		-- old gfm
-		-- ---------------------------------------------------------------------=
-----
---		dialog =3D CreateGumpDlgFromGfm(paperdoll.bIsPlayer and datapath.."gfm=
/player_paperdoll.gfm" or datapath.."gfm/npc_paperdoll.gfm")
-		-- new gumpparser
-		-- ---------------------------------------------------------------------=
-----
 		if (paperdoll.bIsPlayer) then
 			dialog =3D GumpParser( playerPaperdoll, true )
 		else
 			dialog =3D GumpParser( npcPaperdoll, true )
 		end
-		-- ---------------------------------------------------------------------=
-----
 =

 		paperdoll.dialog =3D dialog
 		dialog.uoPaperdoll =3D paperdoll
-		dialog.rootwidget.gfx:SetPos(120,100)
-		=

+
 		dialog.onMouseDown =3D function (widget,mousebutton)
-			if (mousebutton =3D=3D 2) then widget.dialog.uoPaperdoll:Close() end
+			if (mousebutton =3D=3D 2) then ClosePaperdoll(paperdoll) end
 			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget.dialog.rootwidget) end
 		end
-
-		if (paperdoll.bIsPlayer) then
-			-- requests VirtuesGump
-			dialog.controls["btnvirtues"].onMouseDown =3D function (widget,mousebut=
ton)
-														if (mousebutton =3D=3D 1) then
-															widget.gfx:SetMaterial(widget.mat_pressed)
-															print("btn_virtues,GumpReturnMsg : warning ! playerserial m=
ight be wrong here, usually this param is the gump-serial")
-															GumpReturnMsg(gPlayerBodySerial, hex2num("0x000001CD"),
-																		  hex2num("0x00000001"), nil,
-																		  hex2num("0x00000001"), gPlayerBodySerial)
-														end
-													end
-
-			-- requests AosStats		=

-			dialog.controls["btnstatus"].onMouseDown =3D function (widget,mousebutt=
on)
-														if (mousebutton =3D=3D 1) then
-															widget.gfx:SetMaterial(widget.mat_pressed)
-															ToggleStatusAos()
-														end
-													end
-
-			-- request QuestGump (must be supported by Serversidegumps)
-			dialog.controls["btnquests"].onMouseDown =3D function (widget,mousebutt=
on)
-															if (mousebutton =3D=3D 1) then
-																widget.gfx:SetMaterial(widget.mat_pressed)
-																Send_AOSCommand(kPacket_AOS_Command_QuestGumpRequest,gPlay=
erBodySerial)
-															end
-														end
-
-			-- request GuildGump (must be supported by Serversidegumps)
-			dialog.controls["btnguild"].onMouseDown =3D function (widget,mousebutto=
n)
-															if (mousebutton =3D=3D 1) then
-																widget.gfx:SetMaterial(widget.mat_pressed)
-																Send_AOSCommand(kPacket_AOS_Command_GuildGumpRequest,gPlay=
erBodySerial)
-															end
-														end
-
-			-- request Warmode and change the Peace/Warmode Button visual
-			dialog.controls["btnpeace"].onMouseDown =3D function (widget,mousebutto=
n)
-															if (gActWarmode=3D=3DgWarmode_Normal) then
-																Send_CombatMode(gWarmode_Combat)
-																widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
-																widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
-																widget.mat_over 	=3D GetGumpMat(hex2num("0x7EA"))
-																widget.gfx:SetMaterial(widget.mat_pressed)
-															else
-																Send_CombatMode(gWarmode_Normal)
-																widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E5"))
-																widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E6"))
-																widget.mat_over 	=3D GetGumpMat(hex2num("0x7E7"))
-																widget.gfx:SetMaterial(widget.mat_pressed)
-															end
-														end
-			-- request HelpGump (must be supported by Serversidegumps)
-			dialog.controls["btnhelp"].onMouseDown =3D function (widget,mousebutton)
-															if (mousebutton =3D=3D 1) then
-																widget.gfx:SetMaterial(widget.mat_pressed)
-																Send_RequestHelp()
-															end
-														end
-			-- request skill gump
-			dialog.controls["btnskills"].onMouseDown =3D function (widget,mousebutt=
on)
-															if (mousebutton =3D=3D 1) then
-																widget.gfx:SetMaterial(widget.mat_pressed)
-																ToggleSkill()
-															end
-														end
-			dialog.controls["btnquit"].onMouseDown =3D function (widget,mousebutton)
-															if (mousebutton =3D=3D 1) then
-																OpenQuit()
-															end
-														end
---			dialog.controls["btnscroll"].onMouseDown =3D function (widget,mousebu=
tton)
---															if (mousebutton =3D=3D 1) then
---																AddFadeLines("btn_scroll")
---															end
---														end
---			dialog.controls["btnparty"].onMouseDown =3D function (widget,mousebut=
ton)
---															if (mousebutton =3D=3D 1) then
---																AddFadeLines("btn_party")
---															end
---														end
---			dialog.controls["btnspecialAbilities"].onMouseDown =3D function (widg=
et,mousebutton)
---															if (mousebutton =3D=3D 1) then
---																AddFadeLines("btn_specialAbilities")
---															end
---														end
-
-		else
-			dialog.controls["btnstatus"].onMouseDown =3D function (widget,mousebutt=
on)
-															if (mousebutton =3D=3D 1) then
-																widget.gfx:SetMaterial(widget.mat_pressed)
-																OpenHealthbar(widget.dialog.uoPaperdoll.mobile)
-															end
-														end
-		end
-		for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
-	end
-
-	-- visually change the Peace/Warmode Button when opening the Paperdoll
+	end
+
+	-- visually change the Peace/Warmode Button when opening the Paperdoll wh=
en in combat mode
 	if (gActWarmode=3D=3DgWarmode_Combat) then
 		local widget =3D dialog.controls["btnpeace"]
 		if (widget) then
@@ -432,12 +390,10 @@
 	if (gPlayerBodySerial and gPaperdolls[gPlayerBodySerial]) then
 		gPaperdolls[gPlayerBodySerial]:Close()
 	else
-		--printf("opening player paperdoll")
-
+		-- open player paperdoll
 		local playermobile =3D GetPlayerMobile()
 		=

 		if (playermobile) then =

-			--print("player serial",playermobile.serial)
 			Send_DoubleClick(playermobile.serial)
 			=

 			Send_ClientQuery(gRequest_States,playermobile.serial)

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Thu Mar 13 23:36:07 2008
@@ -159,7 +159,6 @@
 =

 -- request serverside helppage
 function Send_RequestHelp()
-	print("NET: Send_RequestHelp")
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Request_Assistance)
 	for i=3D1, 257 do



From no-reply at zwischenwelt.org  Fri Mar 14 00:07:52 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 13 Mar 2008 23:07:52 -0000
Subject: [Iris-commit] [IRIS] r1961 - in /trunk/lua: gui/gui.quit.lua
	lib.3d.renderer.lua
Message-ID: <20080314000016.3131B1C1802A@zwischenwelt.org>

Author: sience
Date: Fri Mar 14 00:07:51 2008
New Revision: 1961

Log:
-quit gump updated
-shadowsetup updated

Modified:
    trunk/lua/gui/gui.quit.lua
    trunk/lua/lib.3d.renderer.lua

Modified: trunk/lua/gui/gui.quit.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.quit.lua (original)
+++ trunk/lua/gui/gui.quit.lua Fri Mar 14 00:07:51 2008
@@ -7,13 +7,19 @@
 quitGump.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2070 }" ..
-	 "{ button 36 78 2071 2072 1 0 quitcanel }" ..
-	 "{ button 99 78 2074 2075 1 0 quitok }" ..
+	 "{ button 36 78 2071 2072 1 0 0 }" ..
+	 "{ button 99 78 2074 2075 1 0 1 }" ..
 	 "{ text 70 25 0 0 }" ..
 	 "{ text 44 42 0 1 }"
 quitGump.textline =3D {
 	[0] =3D "Quit",
 	[1] =3D "Ultima Online?",
+}
+quitGump.functions =3D {
+ -- quitcanel
+ [0]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then widg=
et.dialog:Close() end end,
+ -- quitok
+ [1]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then Term=
inate() end end,
 }
 =

 function OpenQuit()
@@ -23,15 +29,4 @@
 		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
 		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end
 	end
-
-	dialog.controls["quitcanel"].onMouseDown =3D function (widget,mousebutton)
-												if (mousebutton =3D=3D 1) then
-													widget.dialog:Close()
-												end
-											end
-	dialog.controls["quitok"].onMouseDown =3D function (widget,mousebutton)
-												if (mousebutton =3D=3D 1) then
-													Terminate()
-												end
-											end
 end

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Fri Mar 14 00:07:51 2008
@@ -154,33 +154,30 @@
 		--OgreShadowTechnique(gShadowTechnique)
 		--gBuildStencilShadowEdgeList=3Dtrue
 	elseif ((gShadowTechnique =3D=3D "texture_modulative") or (gShadowTechniq=
ue =3D=3D "texture_additive")) then
+		OgreSetShadowTextureCount(4)				-- first mention the count (one texture =
for one lightsource)
+		OgreSetShadowTextureSize(1024)				-- then the texsize
 		OgreSetShadowFarDistance(shadowfardist)
 		OgreSetShadowTextureFadeStart(0.6)
 		OgreSetShadowTextureFadeEnd(0.9)
-		OgreShadowTechnique(gShadowTechnique)
-		OgreSetShadowTextureSize(2048)
 		OgreSetShadowCasterRenderBackFaces(false)
-
---		OgreSetShadowTextureCount(3)
+		OgreSetShadowTextureSelfShadow(false)		-- doesn't work when using the fi=
xed function pipeline
+		OgreShadowTechnique(gShadowTechnique)		-- last, the technique
 --mLiSPSMSetup =3D new LiSPSMShadowCameraSetup()
 --m_pSceneMgr->setShadowCameraSetup(ShadowCameraSetupPtr(mLiSPSMSetup))
---		OgreSetShadowTexturePixelFormat(PF_FLOAT32_RGBA)
---		OgreSetShadowTextureCasterMaterial("VSM/ShadowCaster")
---		OgreSetShadowTextureReceiverMaterial("VSM/ShadowReceiver")
---		OgreSetShadowTextureSelfShadow(true)
 	elseif ((gShadowTechnique =3D=3D "texture_additive_integrated") or (gShad=
owTechnique =3D=3D "texture_modulative_integrated")) then
+		OgreSetShadowTextureCount(4)				-- first mention the count (one texture =
for one lightsource)
+		OgreSetShadowTextureSize(1024)				-- then the texsize
 		OgreSetShadowFarDistance(shadowfardist)
-		OgreSetShadowTextureFadeStart(0.5)
+		OgreSetShadowTextureFadeStart(0.6)
 		OgreSetShadowTextureFadeEnd(0.9)
- 		OgreShadowTechnique(gShadowTechnique)
-		OgreSetShadowTextureSize(1024)
+		OgreSetShadowTexturePixelFormat(PF_FLOAT16_RGB)
 		OgreSetShadowCasterRenderBackFaces(false)
-		OgreSetShadowTextureCount(4)
-
-		OgreSetShadowTexturePixelFormat(PF_FLOAT32_R)
-		OgreSetShadowTextureCasterMaterial("Ogre/DepthShadowmap/Caster/Float")
+		OgreSetShadowTextureSelfShadow(true)
+		OgreSetShadowTextureCasterMaterial("shadow_caster")
+		--OgreSetShadowTexturePixelFormat(PF_FLOAT32_R)
+		--OgreSetShadowTextureCasterMaterial("Ogre/DepthShadowmap/Caster/Float")
 --		OgreSetShadowTextureReceiverMaterial("Ogre/DepthShadowmap/BasicTemplat=
eMaterial")
-		OgreSetShadowTextureSelfShadow(true)
+ 		OgreShadowTechnique(gShadowTechnique)		-- last, the technique
 	end
 end
 =




From no-reply at zwischenwelt.org  Sun Mar 16 21:02:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Mar 2008 20:02:53 -0000
Subject: [Iris-commit] [IRIS] r1962 - /trunk/lua/lib.uodragdrop.lua
Message-ID: <20080316200253.1D3E5152402A@zwischenwelt.org>

Author: hagish
Date: Sun Mar 16 21:02:52 2008
New Revision: 1962

Log:
possible to drop item on closed container item

Modified:
    trunk/lua/lib.uodragdrop.lua

Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Sun Mar 16 21:02:52 2008
@@ -144,7 +144,7 @@
 BYTE[4] Move Into Container ID (FF FF FF FF if normal world)
 =

 0x23  	Drag Item ( send by server, displays animation ?)
-0x24  	Open Container  =C2=B7  0x003c =3D backpack =

+0x24  	Open Container  =C3=AF=C2=BF=C2=BD  0x003c =3D backpack =

 0x25  	Object to Object     This is sent by the server to add a single ite=
m to a container.
 =

 0x08 	Packet   Drop Item(s) (14 bytes)
@@ -339,12 +339,23 @@
 		=

 		-- stack this item with the same beneath?
 		if gMousePickFoundHit and gMousePickFoundHit.hittype =3D=3D kMousePickHi=
tType_ContainerItem then
+			-- read out item infos
 			local arrtiletype =3D {}
-			-- read out item infos
 			arrtiletype =3D GetStaticTileType(item.artid)
+
+			local targettiletype =3D {}
+			targettiletype =3D GetStaticTileType(gMousePickFoundHit.item.artid)
+
 			-- if the item beneath has the same artid and stackable, try to stack t=
hem
 			if (TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Generic_Stackable)) =
and gMousePickFoundHit.item.artid =3D=3D item.artid then
 				target =3D gMousePickFoundHit.item.serial =

+			elseif (TestBit(targettiletype.miFlags or 0,kTileDataFlag_Container)) t=
hen
+				-- the item under the mouse is a container so put it into the container
+				target =3D gMousePickFoundHit.item.serial
+				-- TODO this position is hardcoded, is there a better way doing this? =
dynamic position? find free spot?
+				x =3D 70
+				y =3D 60
+				z =3D 0
 			end
 		end
 		=




From no-reply at zwischenwelt.org  Sun Mar 16 21:16:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Mar 2008 20:16:32 -0000
Subject: [Iris-commit] [IRIS] r1963 - /trunk/lua/lib.static.lua
Message-ID: <20080316201632.63933152402A@zwischenwelt.org>

Author: hagish
Date: Sun Mar 16 21:16:32 2008
New Revision: 1963

Log:
small fix in dump missing

Modified:
    trunk/lua/lib.static.lua

Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Sun Mar 16 21:16:32 2008
@@ -99,16 +99,16 @@
 		local filename =3D "missing/"..iTileTypeID..".png"
 		=

 		if not meshname and not skip and not file_exists(filename) and gArtMapLo=
ader then
-			print("dump missing art",iTileTypeID,filename)
+			print("dump missing art",iTranslatedTileTypeID,filename)
 			-- render fallback image
 			local img =3D CreateImage()
-			if gArtMapLoader:ExportToImage(img,iTileTypeID + 16384) then
+			if gArtMapLoader:ExportToImage(img,iTranslatedTileTypeID + 16384) then
 				img:SaveAsFile(filename)
 			end
 			img:Destroy()
 		elseif (meshname or skip) and file_exists(filename) then
 			-- remove existing missing images
-			print("remove missing art image because there is now a model",iTileType=
ID,filename)
+			print("remove missing art image because there is now a model",iTranslat=
edTileTypeID,filename)
 			remove_file(filename)
 		end
 	end



From no-reply at zwischenwelt.org  Sun Mar 16 21:37:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Mar 2008 20:37:08 -0000
Subject: [Iris-commit] [IRIS] r1964 - /trunk/lua/lib.uodragdrop.lua
Message-ID: <20080316203708.623F3152402A@zwischenwelt.org>

Author: hagish
Date: Sun Mar 16 21:37:07 2008
New Revision: 1964

Log:
uo drag and drop seems to be simpler than we thought, drop on runebooks cou=
ld work now

Modified:
    trunk/lua/lib.uodragdrop.lua

Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Sun Mar 16 21:37:07 2008
@@ -346,6 +346,8 @@
 			local targettiletype =3D {}
 			targettiletype =3D GetStaticTileType(gMousePickFoundHit.item.artid)
 =

+			target =3D gMousePickFoundHit.item.serial =

+			--[[
 			-- if the item beneath has the same artid and stackable, try to stack t=
hem
 			if (TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Generic_Stackable)) =
and gMousePickFoundHit.item.artid =3D=3D item.artid then
 				target =3D gMousePickFoundHit.item.serial =

@@ -357,6 +359,7 @@
 				y =3D 60
 				z =3D 0
 			end
+			]]--
 		end
 		=

 		Send_Drop_Object(item.serial,x,y,z,target)



From no-reply at zwischenwelt.org  Sun Mar 16 22:11:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Mar 2008 21:11:49 -0000
Subject: [Iris-commit] [IRIS] r1965 - in /trunk/lua: ./ gui/ net/
Message-ID: <20080316211150.BB3CA152402A@zwischenwelt.org>

Author: sience
Date: Sun Mar 16 22:11:48 2008
New Revision: 1965

Log:
-all clientgumps are working
-heavy updates to gumps
-gui.trade.lua and gui.spellbook.lua seperated from libs

Added:
    trunk/lua/gui/gui.spellbook.lua
    trunk/lua/gui/gui.trade.lua
Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/gui/gui.hotbar.lua
    trunk/lua/gui/gui.journal.lua
    trunk/lua/gui/gui.main.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/gui/gui.quit.lua
    trunk/lua/gui/gui.securetrade.lua
    trunk/lua/gui/gui.skill.lua
    trunk/lua/gui/gui.status.lua
    trunk/lua/lib.spellbooks.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/net.trade.lua
    trunk/lua/net/net.other.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sun Mar 16 22:11:48 2008
@@ -107,7 +107,7 @@
 		end
 	end
 =

---	printdebug("gump","formated-html-string: "..msg.text)
+	printdebug("gump","HtmlParser return message: "..msg.text)
 	return msg
 end
 =

@@ -134,25 +134,25 @@
 	else
 		printdebug("gump","CloseServerSideGump dialogId=3D"..dialogId.." buttonI=
d=3Dnil")
 	end
-	=

+
 	local dialog =3D gServerSideGump[dialogId]
 	if (not dialog) then printdebug("gump","CloseServerSideGump : dialog not =
found=3D",dialogId) return end
-	=

+
 	local params =3D ServerSideGump_GetParams(dialogId)
 	GumpReturnMsg(playerId, dialogId, buttonId, params)
-	=

-	--print("CloseServerSideGump:dialogID=3D"..dialogId)
+
+	printdebug("gump","ServerSideGump Dialog closed: dialogID=3D"..dialogId)
 	dialog:Close()
 end
 =

 function GumpParser(Gumpdata, Clientsidemode)
+	if (not gGumpLoader) then return end
+
 	local htext_correction=3D5
-
-	if (not gGumpLoader) then return end
 =

 	-- close already existing dialog with the same id
 	if not(Clientsidemode) and gServerSideGump[Gumpdata.dialogId] then
-		CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, 0)
+		CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, 0, Clientsidem=
ode)
 	end
 =

 	-- create new Dialog
@@ -235,7 +235,7 @@
 =

 	-- init pagenum of basic widgets =

 	for k,widget in pairs(dialog.childs) do widget.pagenum =3D 0 end
-		=

+
 	-- now construct widgets in an orderly per page fashion
 	local curparent =3D dialog.rootwidget
 	local pageorder =3D {}
@@ -262,7 +262,7 @@
 				printdebug("gump","todo - Generic Gump Command: group")
 			-----------------------------------------------------------------------=
---------------------
 			--resizepic <x> <y> <gumpid> <width> <height>
-			elseif ((command =3D=3D "resizepic") and (table.getn(bToken)>=3D 6)) th=
en
+			elseif ((command =3D=3D "resizepic") and (table.getn(bToken) >=3D 6)) t=
hen
 				printdebug("gump","x=3D"..bToken[2].." y=3D"..bToken[3].." gumpid=3D".=
.bToken[4].." width=3D"..bToken[5].." height=3D"..bToken[6])
 				if (tonumber(bToken[4])~=3D0) then
 					local widgetarr =3D MakeBorderGump(curparent,bToken[4],bToken[2],bTok=
en[3],bToken[5],bToken[6])
@@ -272,46 +272,57 @@
 						end
 					end
 				end
+				if (Clientsidemode) then dialog.controls[ bToken[7] ] =3D widget end
+
 			--xmfhtmlgump <x> <y> <width> <height> <Cliloc Message ID> <background>=
 <scrollbar>
 			--Description:	<background> and <scrollbar> can be 0 or 1 and define wh=
ether the background is transparent and
 			--				a scrollbar s displayed.
 			-- TODO : width, height, background, scrollbar
-			elseif ((command =3D=3D "xmfhtmlgump") and (table.getn(bToken)>=3D 8)) =
then
+			elseif ((command =3D=3D "xmfhtmlgump") and (table.getn(bToken) >=3D 8))=
 then
 				local msg =3D HtmlParser( gClilocLoader and gClilocLoader:Get(bToken[6=
]) or "no_cliloc" )
 				printdebug("gump","Cliloc Msg ("..bToken[6].."): "..msg.text)
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {1.=
0,1.0,1.0,1.0},
 																msg.center, msg.div, gFontNameDefault)
+				if (Clientsidemode) then dialog.controls[ bToken[9] ] =3D widget end
+
 			--xmfhtmlgumpcolor <x> <y> <width> <height> <cliloc-nr> <background> <s=
crollbar> <color>
 			--Description:	<background> and <scrollbar> can be 0 or 1 and define wh=
ether the background is transparent and
 			--				a scrollbar s displayed.
 			-- TODO : background, scrollbar, HUE-color
-			elseif ((command =3D=3D "xmfhtmlgumpcolor") and (table.getn(bToken)>=3D=
 9)) then
+			elseif ((command =3D=3D "xmfhtmlgumpcolor") and (table.getn(bToken) >=
=3D 9)) then
 				local msg =3D HtmlParser(  gClilocLoader and gClilocLoader:Get(bToken[=
6]) or "no_cliloc" )
 				printdebug("gump","Cliloc Msg ("..bToken[6].."): "..msg.text)
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {1.=
0,1.0,1.0,1.0},
 																msg.center, msg.div, gFontNameDefault)
+				if (Clientsidemode) then dialog.controls[ bToken[10] ] =3D widget end
+
 			--gumppic <x> <y> <gumpid> [hue=3D353]
 			--Description:  Adds a graphic to the gump, where <id> ist the graphic =
id of an item.
 			--				Optionaly there is a color parameter. =

 			-- TODO : HUE
-			elseif ((command =3D=3D "gumppic") and (table.getn(bToken)>=3D 4)) then
+			elseif ((command =3D=3D "gumppic") and (table.getn(bToken) >=3D 4)) then
 				local huenumber =3D 0
 				if (bToken[5] =3D=3D hue) then huenumber=3DbToken[6] end
 				local widget =3D MakeBorderGumpPart( curparent, bToken[4], bToken[2], =
bToken[3], 0, 0, 0, tonumber(huenumber) )
 				widget.mbIgnoreMouseOver =3D false
-				if (Clientsidemode) then if (bToken[5]) then dialog.controls[bToken[5]=
] =3D widget end end
-				--if (bToken[8]) then printdebug("gump","gumppic class=3D"..bToken[8])=
 end
+				-- in clientmode no hueing is used yet (because of different hue defin=
itions)
+				if (Clientsidemode) then dialog.controls[bToken[5]] =3D widget end
+
 			--gumppictiled <x> <y> <width> <height> <gumpid>
 			--Description:  Similar to GumpPic, but the gumppic is tiled to the giv=
en <height> and <width>.
-			elseif ((command =3D=3D "gumppictiled") and (table.getn(bToken)>=3D 6))=
 then
+			elseif ((command =3D=3D "gumppictiled") and (table.getn(bToken) >=3D 6)=
) then
 				local widget =3D MakeBorderGumpPart(curparent, bToken[6], bToken[2], b=
Token[3], bToken[4], bToken[5])
 				widget.mbIgnoreMouseOver =3D false
+				if (Clientsidemode) then dialog.controls[bToken[7]] =3D widget end
+
 			--checkertrans <x> <y> <width> <height>
 			--Description:  Creates a transparent rectangle on position <x,y> using=
 <width> and <height>.
-			elseif ((command =3D=3D "checkertrans") and (table.getn(bToken)>=3D 5))=
 then
+			elseif ((command =3D=3D "checkertrans") and (table.getn(bToken) >=3D 5)=
) then
 				printdebug("gump","todo - checkertrans")
+				if (Clientsidemode) then dialog.controls[bToken[6]] =3D widget end
+
 				-- TODO : set correct Alpha Value
 				--SetDialogAlpha(dialog, 1.0)
 			--text <x> <y> <hue> <textline-id>
@@ -322,8 +333,8 @@
 =

 				local widget =3D guimaker.MakeText (curparent, bToken[2], bToken[3]+ht=
ext_correction, UnicodeFix(text),
 													gFontGumpSize, {190/255,237/255,231/255,1.0}, gFontNameDefaul=
t)
-
-				if (Clientsidemode) then if (bToken[6]) then dialog.controls[bToken[6]=
] =3D widget end end
+				if (Clientsidemode) then dialog.controls[bToken[6]] =3D widget end
+
 			--Button <x> <y> <released-id> <pressed-id> <quit> <page-id> <return-va=
lue>
 			--Description:  Adds a button to the gump with the specified coordinate=
s and button graphics.
 			--				<released-id> and <pressed-id> specify the buttongraphic. If pres=
sed check for <return-value>.
@@ -332,9 +343,11 @@
 				if (Clientsidemode) then
 					local widget =3D MakeGumpButtonFunctionOnClick (curparent,bToken[4],b=
Token[4],bToken[5],bToken[2],bToken[3],
 																	nil,nil,Gumpdata.functions[ tonumber(bToken[8]) ])
+					widget.page			=3D tonumber(bToken[7])
+					dialog.controls[ bToken[9] ] =3D widget
 				else
 					local widget =3D MakeGumpButton (curparent,bToken[4],bToken[4],bToken=
[5],bToken[2],bToken[3],nil,nil,false)
-					if (bToken[8]) then widget.returnmsg =3D bToken[8] end
+					if (bToken[8]) then widget.returnmsg =3D tonumber(bToken[8]) end
 					widget.page			=3D tonumber(bToken[7])
 					widget.onLeftClick =3D function (widget)
 											if (widget.page > 0 and not(widget.page > table.getn(pages)) ) =
then
@@ -353,12 +366,17 @@
 			--				<tile-x> and <tile-y> define the coordinates of the tile graphic =
and are relative to <x> and <y>.
 			--{ buttontileart 432 248 9010 9010 1 0 33 1352 0 100 20 }
 			elseif ((command =3D=3D "buttontileart") and (table.getn(bToken)>=3D 12=
)) then
-				local widget =3D MakeGumpButton (curparent,bToken[4],bToken[4],bToken[=
5],bToken[2],bToken[3])
-				local widgetart =3D MakeArtGumpPart (curparent,bToken[9],bToken[2]+bTo=
ken[11],bToken[3]+bToken[12],0,0,0,bToken[10])
-				if (bToken[8]) then widget.returnmsg =3D tonumber(bToken[8]) end
-				widget.page			=3D tonumber(bToken[7])
-
-				if not(Clientsidemode) then
+				if (Clientsidemode) then
+					local widget =3D MakeGumpButtonFunctionOnClick (curparent,bToken[4],b=
Token[4],bToken[5],bToken[2],bToken[3],
+																	nil,nil,Gumpdata.functions[ tonumber(bToken[8]) ])
+					local widgetart =3D MakeArtGumpPart (curparent,bToken[9],bToken[2]+bT=
oken[11],bToken[3]+bToken[12],0,0,0,bToken[10])
+					widget.page			=3D tonumber(bToken[7])
+					dialog.controls[bToken[13]] =3D widget
+				else
+					local widget =3D MakeGumpButton (curparent,bToken[4],bToken[4],bToken=
[5],bToken[2],bToken[3])
+					local widgetart =3D MakeArtGumpPart (curparent,bToken[9],bToken[2]+bT=
oken[11],bToken[3]+bToken[12],0,0,0,bToken[10])
+					if (bToken[8]) then widget.returnmsg =3D tonumber(bToken[8]) end
+					widget.page			=3D tonumber(bToken[7])
 					widget.onLeftClick =3D function (widget)
 											if (widget.page > 0 and not(widget.page > table.getn(pages)) ) =
then
 												printdebug("gump","Parsegump buttontileart: Switch to Page "..=
widget.page.."/"..table.getn(pages))
@@ -369,6 +387,7 @@
 											end
 										end
 				end
+
 			--textentry <x> <y> <width> <height> <hue> <return-value> <default-text=
-id>
 			--Description:  Defines an area where the <default-text-id> is displaye=
d.
 			--				The player can modify this data. To get this data check the <retu=
rn-value>.
@@ -382,26 +401,28 @@
 				widget.returnmsg =3D tonumber(bToken[7])
 				widget.returndefid =3D tonumber(bToken[8])
 =

-				if not(Clientsidemode) then
-					widget.onMouseDown =3D function (widget,mousebutton)
-												if (mousebutton =3D=3D 1) then
-													widget:Activate()
-												end
-										   end
-					widget.onMouseLeave =3D function (widget)
-												widget:Deactivate()
-											end
-				end
+				widget.onMouseDown =3D function (widget,mousebutton)
+										if (mousebutton =3D=3D 1) then
+											widget:Activate()
+									 	end
+									 end
+				widget.onMouseLeave =3D function (widget) widget:Deactivate() end
+				if (Clientsidemode) then dialog.controls[ bToken[9] ] =3D widget end
 				table.insert(dialog.uo_text,widget)
+
 			--tilepic <x> <y> <id>
 			--Description:  Adds a Tilepicture to the gump. <id> defines the tile g=
raphic-id.
 			elseif ((command =3D=3D "tilepic") and (table.getn(bToken)>=3D4)) then
 				local widget =3D MakeArtGumpPart (curparent, bToken[4], bToken[2], bTo=
ken[3])
+				if (Clientsidemode) then dialog.controls[ bToken[5] ] =3D widget end
+
 			--TilePicHue <x> <y> <id> <hue>
 			--Description:  Similar to the tilepic command, but with an additional =
hue parameter.
 			-- TODO : HUE
 			elseif ((command =3D=3D "tilepichue") and (table.getn(bToken)>=3D5)) th=
en
 				local widget =3D MakeArtGumpPart (curparent, bToken[4], bToken[2], bTo=
ken[3], 0, 0, 0, bToken[5])
+				if (Clientsidemode) then dialog.controls[ bToken[6] ] =3D widget end
+
 			--croppedtext <x> <y> <width> <height> <color> <text-id>
 			--Description:  Adds a text field to the gump. This is similar to the t=
ext command,
 			--but the text is cropped to the defined area.
@@ -411,7 +432,8 @@
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {92=
/255,92/255,178/255,1.0},
 																msg.center, msg.div, gFontNameDefault)
-				if (Clientsidemode) then if (bToken[8]) then dialog.controls[bToken[8]=
] =3D widget end end
+				if (Clientsidemode) then dialog.controls[ bToken[8] ] =3D widget end
+
 			--radio <x> <y> <released gumpid> <pressed gumpid> <status> <return-val=
ue>
 			--Description:  Same as Checkbox, but only one Radiobutton can be press=
ed at the same time, except they are per linked via the 'Group' command.
 			-- TODO : make radio buttons work
@@ -434,22 +456,21 @@
 				widget.mat_normal 	=3D GetGumpMat(radio_norm)
 				widget.mat_pressed 	=3D GetGumpMat(radio_down)
 =

+				widget.onMouseDown	=3D function (widget,mousebutton)
+										if (mousebutton =3D=3D 1) then
+											if (widget.state=3D=3D0) then
+												widget.gfx:SetMaterial(widget.mat_pressed)
+												widget.state=3D1
+											else
+												widget.gfx:SetMaterial(widget.mat_normal)
+												widget.state=3D0
+											end
+											printdebug("gump","RadioButton changed : id=3D"..widget.returnm=
sg.." state=3D"..widget.state)
+										end
+									   end
+				if (Clientsidemode) then dialog.controls[ bToken[8] ] =3D widget end
 				table.insert(dialog.uo_radio,widget)
 =

-				if not(Clientsidemode) then
-					widget.onMouseDown	=3D function (widget,mousebutton)
-											if (mousebutton =3D=3D 1) then
-												if (widget.state=3D=3D0) then
-													widget.gfx:SetMaterial(widget.mat_pressed)
-													widget.state=3D1
-												else
-													widget.gfx:SetMaterial(widget.mat_normal)
-													widget.state=3D0
-												end
-												printdebug("gump","RadioButton changed : id=3D"..widget.return=
msg.." state=3D"..widget.state)
-											end
-										  end
-				end
 			--checkbox <x> <y> <released-id> <pressed-id> <status> <return-value>
 			--Description:  Adds a CheckBox to the gump. Multiple CheckBoxes can be=
 pressed at the same time.
 			--				Check the <return-value> if you want to know which CheckBoxes wer=
e selected.
@@ -471,24 +492,22 @@
 				widget.mbIgnoreMouseOver =3D false
 				widget.mat_normal 	=3D GetGumpMat(check_norm)
 				widget.mat_pressed 	=3D GetGumpMat(check_down)
+
+				widget.onMouseDown	=3D function (widget,mousebutton)
+										if (mousebutton =3D=3D 1) then
+											if (widget.state=3D=3D0) then
+												widget.gfx:SetMaterial(widget.mat_pressed)
+												widget.state=3D1
+											else
+												widget.gfx:SetMaterial(widget.mat_normal)
+												widget.state=3D0
+											end
+											printdebug("gump","Checkbox changed : id=3D"..widget.returnmsg.=
." state=3D"..widget.state)
+										end
+									  end
+				if (Clientsidemode) then dialog.controls[ bToken[8] ] =3D widget end
 				table.insert(dialog.uo_check,widget)
 =

-				if not(Clientsidemode) then
-					widget.onMouseDown	=3D function (widget,mousebutton)
-											if (mousebutton =3D=3D 1) then
-												if (widget.state=3D=3D0) then
-													widget.gfx:SetMaterial(widget.mat_pressed)
-													widget.state=3D1
-												else
-													widget.gfx:SetMaterial(widget.mat_normal)
-													widget.state=3D0
-												end
-												printdebug("gump","Checkbox changed : id=3D"..widget.returnmsg=
.." state=3D"..widget.state)
-											end
-										  end
-				else
-					if (bToken[7]) then dialog.controls[bToken[7]] =3D widget end
-				end
 			--HtmlGump <x> <y> <width> <height> <text-id> <background> <scrollbar>
 			--Description:  Defines a text-area where Html-commands are allowed.
 			--				<background> and <scrollbar> can be 0 or 1 and define whether the=
 background is transparent and a scrollbar is displayed.
@@ -498,6 +517,8 @@
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], msg.text, msg.charh, {1.0,1.0,1.0,1.=
0},
 																msg.center, msg.div, gFontNameDefault)
+				if (Clientsidemode) then dialog.controls[ bToken[8] ] =3D widget end
+
 			--tooltip <cliloc-nr>
 			--Description:  Adds to the previous layoutarray entry a Tooltip with t=
he in [cliloc-nr] defined Cliloc entry.
 			-- TODO : display tooltip

Modified: trunk/lua/gui/gui.healthbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.healthbar.lua (original)
+++ trunk/lua/gui/gui.healthbar.lua Sun Mar 16 22:11:48 2008
@@ -1,18 +1,15 @@
--- list of all open stats dialogs serial->dialog
-gHealthbarDialogs =3D {}
-
 -- Created 09.03.2008 16:33:50, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local healthbarGump =3D {}
-healthbarGump.dialogId =3D 1234
+healthbarGump.dialogId =3D 2000001
 healthbarGump.x =3D 0
 healthbarGump.y =3D 0
 healthbarGump.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2051 healthbar }" ..
-	 "{ gumppic 35 11 2053 }" ..
-	 "{ gumppic 35 25 2053 }" ..
-	 "{ gumppic 35 39 2053 }" ..
+	 "{ gumppic 35 11 2053 hitsred }" ..
+	 "{ gumppic 35 25 2053 manared }" ..
+	 "{ gumppic 35 39 2053 stamred }" ..
 	 "{ gumppic 35 11 2054 hitsbar }" ..
 	 "{ gumppic 35 25 2054 manabar }" ..
 	 "{ gumppic 35 39 2054 stambar }"
@@ -22,18 +19,21 @@
 -- Created 09.03.2008 16:52:23, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local npchealthGump =3D {}
-npchealthGump.dialogId =3D 1234
+npchealthGump.dialogId =3D 2000002
 npchealthGump.x =3D 0
 npchealthGump.y =3D 60
 npchealthGump.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2052 healthbar }" ..
-	 "{ gumppic 35 38 2053 }" ..
+	 "{ gumppic 35 38 2053 hitsred }" ..
 	 "{ gumppic 35 38 2054 hitsbar }" ..
 	 "{ text 20 10 0 0 npcname }"
 npchealthGump.textline =3D {
 	[0] =3D "npc_name",
 }
+
+-- list of all open stats dialogs serial->dialog
+gHealthbarDialogs =3D {}
 =

 -- sets the current stats bar in %, dont use this directly
 local function SetStatsBar(name,x)
@@ -128,22 +128,20 @@
 	if mobile =3D=3D nil then return end
 	if (gHealthbarDialogs[mobile.serial]) then return end -- already open =

 	=

-	--local dialog =3D CreateGumpDlgFromGfm(IsPlayerMobile(mobile) and datapa=
th.."gfm/healthbar.gfm" or datapath.."gfm/healthbar_npc.gfm")
 	local dialog =3D GumpParser( IsPlayerMobile(mobile) and healthbarGump or =
npchealthGump, true )
 =

-	-- set default parameter
-	x =3D x or healthbarGump.x
-	y =3D y or healthbarGump.y
+	-- save mobile info to dialog
+	dialog.mobile =3D mobile
 =

-	-- widgets in this dialog handle mouse
-	for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
-
+	-- overwrite the dialog close function from gumpparser
+	dialog.Close =3D function (dialog)
+					CloseHealthbar(dialog.mobile)
+				   end
+	-- overwrite the onMouseDown function from gumpparser
 	dialog.onMouseDown =3D function (widget,mousebutton)
 		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
 		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end
 	end
-	dialog.Close =3D function (dialog) CloseHealthbar(dialog.mobile) end -- d=
ie zeile ist neu =

-	dialog.mobile =3D mobile  -- die zeile ist neu
 =

 	local r,g,b =3D GetNotorietyColor(mobile.notoriety)
 =


Modified: trunk/lua/gui/gui.hotbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.hotbar.lua (original)
+++ trunk/lua/gui/gui.hotbar.lua Sun Mar 16 22:11:48 2008
@@ -15,7 +15,7 @@
 		gHotbarDialog:Close()
 	else
 		-- ..........do something before hotbar creation (get spells/items ?!)
-		gHotbarDialog =3D guimaker.MakeSortedDialog()	--guimaker.MyCreateDialog()
+		gHotbarDialog =3D guimaker.MakeSortedDialog()
 		gHotbarDialog.rootwidget =3D guimaker.MakePlane(gHotbarDialog,gNewGuiSty=
le.."/hotbar",0,0,515,65)
 =

 		-- restore last positoin if available

Modified: trunk/lua/gui/gui.journal.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.journal.lua (original)
+++ trunk/lua/gui/gui.journal.lua Sun Mar 16 22:11:48 2008
@@ -1,24 +1,73 @@
---[[
-function RegisterJournalEntryType (name) _G["kEntryType_"..name] =3D name =
end
-
--- TODO : maybe  gEntryTypeHandler.Chat =3D function (type,arr) return {r,=
g,b},sprintf("",arr[1],arr[2]) end
-RegisterJournalEntryType("Chat")
-RegisterJournalEntryType("TextMessage")
-RegisterJournalEntryType("ServerMessage")
-RegisterJournalEntryType("PickUpItem")
-RegisterJournalEntryType("DropItem")
-RegisterJournalEntryType("EquipItem")
-RegisterJournalEntryType("UnequipItem")
-RegisterJournalEntryType("Trade")
-RegisterJournalEntryType("DoubleClick")
-RegisterJournalEntryType("Use")
-RegisterJournalEntryType("Death")
-RegisterJournalEntryType("WarMode")
-
-function JournalAddEntry (entrytype,...)
-	-- TODO : vararg params
-end
-]]--
+-- Created 09.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local journalGump =3D {}
+journalGump.dialogId =3D 3000001
+journalGump.x =3D 10
+journalGump.y =3D 50
+journalGump.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 4 27 2080 xx1 }" ..
+	 "{ gumppic 21 64 2081 xx2 }" ..
+	 "{ gumppic 21 134 2082 xx3 }" ..
+	 "{ gumppic 23 204 2083 xx4 }" ..
+	 "{ gumppic 118 36 2090 xx5 }" ..
+	 "{ gumppic 38 65 2091 xx6 }" ..
+	 "{ gumppic 38 183 2091 xx7 }" ..
+	 "{ button 139 4 2093 2093 1 0 0 journalminimize }" ..
+	 "{ button 139 235 2094 2095 1 1 1 journalresize }" ..
+	 "{ button 260 77 2088 2088 1 0 2 xx8 }" ..
+	 "{ button 254 61 2084 2084 1 0 3 xx9 }" ..
+	 "{ button 254 181 2085 2085 1 0 4 xx10 }" ..
+	 "{ button 241 181 2092 2092 1 0 5 xx11 }"
+journalGump.textline =3D {
+}
+journalGump.functions =3D {
+ -- journalminimize
+ [0]	=3D function (widget,mousebutton)
+ 			local pref =3D gJournalDialog_Pref
+			pref.x,pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
+			local left,top,w,h =3D gJournalDialog:GetLTWH()
+			pref.dx,pref.dy =3D w,h
+			if (mousebutton =3D=3D 2) then widget.dialog:Close() end
+			if (mousebutton =3D=3D 1) then ToggleJournal_Small() end
+		end,
+ -- journalresize
+ [1]	=3D function (widget,mousebutton) =

+            if (mousebutton =3D=3D 1) then
+                widget.gfx:SetMaterial(widget.mat_pressed)
+                gJournalResizeStartX,gJournalResizeStartY =3D GetMousePos()
+                if (true) then
+                    gui.bMouseBlocked =3D true
+                    RegisterStepper(function ()
+                        local x,y =3D GetMousePos()
+                        local dx =3D 2.0*(x-gJournalResizeStartX)
+                        --local dx =3D 0
+                        gJournalDialog:ResizeDelta(dx,(y-gJournalResizeSta=
rtY))
+                        gJournalResizeStartX,gJournalResizeStartY =3D x,y
+                        JournalUpdateText()
+                        =

+                        if (gKeyPressed[key_mouse1]) then
+                            return false -- continue stepping
+                        else
+                            gui.bMouseBlocked =3D false
+                            local left,top,w,h =3D gJournalDialog:GetLTWH()
+                            local bx1,by1,bx2,by2 =3D JournalGetTextBorder=
()
+                            local iw,ih =3D w-bx1-bx2	, h-by1-by2
+							local pref =3D gJournalDialog_Pref
+                            pref.dx,pref.dy =3D w,h
+                            pref.x,pref.y =3D gJournalDialog.rootwidget.gf=
x:GetPos()
+                            return true -- terminate
+                        end
+                    end)
+                end =

+            end -- if
+        end,
+ -- btn
+ [2]	=3D function (widget,mousebutton) end,
+ [3]	=3D function (widget,mousebutton) end,
+ [4]	=3D function (widget,mousebutton) end,
+ [5]	=3D function (widget,mousebutton) end,
+}
 =

 gJournalEntries =3D {}
 gJournalDialog =3D nil
@@ -29,33 +78,54 @@
 gJournalMaxVisIdx =3D nil
 gJournalMinimized =3D false
 =

--- Created 09.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
--- Exported Iris2 GumpExporter ver 1.0.
-local journalGump =3D {}
-journalGump.dialogId =3D 1234567
-journalGump.x =3D 10
-journalGump.y =3D 50
-journalGump.Data =3D
-	 "{ page 0 }" ..
-	 "{ gumppic 4 27 2080 }" ..
-	 "{ gumppic 21 64 2081 }" ..
-	 "{ gumppic 21 134 2082 }" ..
-	 "{ gumppic 23 204 2083 }" ..
-	 "{ gumppic 118 36 2090 }" ..
-	 "{ gumppic 38 65 2091 }" ..
-	 "{ gumppic 38 183 2091 }" ..
-	 "{ button 139 4 2093 2093 1 0 journalminimize }" ..
-	 "{ button 139 235 2094 2095 1 0 journalresize }" ..
-	 "{ button 260 77 2088 2088 1 0 0 }" ..
-	 "{ button 254 61 2084 2084 1 0 0 }" ..
-	 "{ button 254 181 2085 2085 1 0 0 }" ..
-	 "{ button 241 181 2092 2092 1 0 0 }"
-journalGump.textline =3D {
-}
-
-local function JournalGetTextBorder () return 40,80,40,50 end
-
-local function JournalUpdateText ()
+local function RestoreLastState()
+    -- restore last position if available
+    local pref =3D gJournalDialog_Pref
+    local dialog =3D gJournalDialog
+    if (dialog and gJournalMinimized =3D=3D false) then =

+        dialog.rootwidget.gfx:SetPos((pref.x or 0),(pref.y or 0)) =

+
+        --dialog:SetDimensions((pref.dx or dialog.resize_max_total_x),(pre=
f.dy or dialog.resize_max_total_y))
+        pref.dx =3D (pref.dx or dialog.resize_max_total_x) - dialog.rootwi=
dget.gfx:GetWidth()
+        pref.dy =3D (pref.dy or dialog.resize_max_total_y) - dialog.rootwi=
dget.gfx:GetHeight()
+        dialog:ResizeDelta(pref.dx,pref.dy)  -- =

+        --dialog:ResizeMaximize()
+
+        JournalUpdateText()
+    end
+end
+
+local function CreateJournal_Small ()
+	gJournalDialog =3D guimaker.MakeSortedDialog()
+	local pref =3D gJournalDialog_Pref
+
+	local dialog =3D gJournalDialog
+	dialog.Close 		=3D function(dialog)
+        	gJournalDialog:SetVisible(false)
+        	gJournalDialog:Destroy()
+        	gJournalDialog =3D nil
+	end
+
+	dialog.onMouseDown =3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 2) then gJournalDialog:Close() end
+			if (mousebutton =3D=3D 1) then
+				widget.dialog:BringToFront()
+				gui.StartMoveDialog(widget.dialog.rootwidget)
+            end
+	end
+
+	local root =3D dialog.rootwidget
+	MakeBorderGumpPart( root, 2096, (pref.x or 0), (pref.y or 0))
+
+	for k,widget in pairs(dialog.childs) do
+            widget.mbIgnoreMouseOver =3D false
+    end
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
+function JournalGetTextBorder () return 40,80,40,50 end
+
+function JournalUpdateText ()
 	if (not gJournalDialog or not gJournalEntries) then return end
 	local widget =3D gJournalDialog.maintext
 =

@@ -118,51 +188,20 @@
 	end
 end
 =

-local function RestoreLastState()
-    -- restore last position if available
-    local pref =3D gJournalDialog_Pref
-    local dialog =3D gJournalDialog
-    if (dialog and gJournalMinimized =3D=3D false) then =

-        dialog.rootwidget.gfx:SetPos((pref.x or 0),(pref.y or 0)) =

-        =

-        --dialog:SetDimensions((pref.dx or dialog.resize_max_total_x),(pre=
f.dy or dialog.resize_max_total_y))
-        pref.dx =3D (pref.dx or dialog.resize_max_total_x) - dialog.rootwi=
dget.gfx:GetWidth()
-        pref.dy =3D (pref.dy or dialog.resize_max_total_y) - dialog.rootwi=
dget.gfx:GetHeight()
-        dialog:ResizeDelta(pref.dx,pref.dy)  -- =

-        --dialog:ResizeMaximize()
-        =

-        JournalUpdateText()
-    end
-end
-
-local function CreateJournal_Small ()
-	gJournalDialog =3D guimaker.MakeSortedDialog()
-	local pref =3D gJournalDialog_Pref
-
-	local dialog =3D gJournalDialog
-	dialog.Close 		=3D function(dialog)
-        	gJournalDialog:SetVisible(false)
-        	gJournalDialog:Destroy()
-        	gJournalDialog =3D nil
-	end
-
-	dialog.onMouseDown =3D function (widget,mousebutton)
-			if (mousebutton =3D=3D 2) then gJournalDialog:Close() end
-			if (mousebutton =3D=3D 1) then
-				widget.dialog:BringToFront()
-				gui.StartMoveDialog(widget.dialog.rootwidget)
-            end
-	end
-
-	local root =3D dialog.rootwidget
-	MakeBorderGumpPart( root, 2096, (pref.x or 0), (pref.y or 0))
-
-	for k,widget in pairs(dialog.childs) do
-            widget.mbIgnoreMouseOver =3D false
-    end
-end
-
-local function ToggleJournal_Small () -- produces a small journal scroll i=
con
+function JournalAddText (name,message)
+	local sys =3D "System"
+	local mytext =3D message	=

+	-- strip "System:"
+	local a,b =3D string.find(name, sys, 1, false)
+	if not string.find(name, sys, 1, true) then =

+		mytext =3D name.."> "..mytext
+	end   	=

+	table.insert(gJournalEntries,mytext)
+	JournalUpdateText()
+end
+
+-- produces a small journal scroll icon
+function ToggleJournal_Small ()
 	local pref =3D gJournalDialog_Pref
 	if (gJournalDialog) then  =

         pref.x, pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
@@ -174,20 +213,7 @@
 	end
 end
 =

--- ----------------------------------------------- End of local functions =
-----------------------------
-
-function JournalAddText (name,message)
-	local sys =3D "System"
-	local mytext =3D message	=

-	-- strip "System:"	=

-	local a,b =3D string.find(name, sys, 1, false)
-	if not string.find(name, sys, 1, true) then =

-		mytext =3D name.."> "..mytext
-	end   	=

-	table.insert(gJournalEntries,mytext)
-	JournalUpdateText()
-end
-
+-- produces a big journal scroll
 function ToggleJournal ()
 	local pref =3D gJournalDialog_Pref
 	if (gJournalDialog and (gJournalMinimized=3D=3Dfalse)) then
@@ -201,8 +227,27 @@
         end
         gJournalMinimized =3D false
         =

-        -- gJournalDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/journal.=
gfm")
-        gJournalDialog =3D GumpParser( journalGump, true )
+        local dialog =3D GumpParser( journalGump, true )
+
+        -- save journaldialog as global Journal
+        gJournalDialog =3D dialog
+
+        -- overwrite the Close function from gumpparser
+        dialog.Close =3D function (dialog) =

+            pref.x,pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
+		    local left,top,w,h =3D gJournalDialog:GetLTWH()
+		    pref.dx,pref.dy =3D w,h
+
+        	gJournalDialog:SetVisible(false)
+            gJournalDialog:Destroy() =

+            gJournalDialog =3D nil             =

+        end
+
+        -- overwrite the onMouseDown function from gumpparser
+        dialog.onMouseDown =3D function (widget,mousebutton)
+            if (mousebutton =3D=3D 2) then widget.dialog:Close() end
+            if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gu=
i.StartMoveDialog(widget.dialog.rootwidget) end
+        end
 =

         -- create text
         local parent =3D gJournalDialog.rootwidget
@@ -220,23 +265,6 @@
 =

         printdebug("gump",(pref.dx or "dx=3Dnil ").." -dxy- "..(pref.dy or=
 "dy=3Dnil"))
         printdebug("gump",(pref.x or "x=3Dnil ").." -xy- "..(pref.y or "y=
=3Dnil"))
-        =

-        -- TODO : init journal dialog
-        local dialog =3D gJournalDialog
-        dialog.Close =3D function (dialog) =

-            pref.x,pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
-		    local left,top,w,h =3D gJournalDialog:GetLTWH()
-		    pref.dx,pref.dy =3D w,h
-
-        	gJournalDialog:SetVisible(false)
-            gJournalDialog:Destroy() =

-            gJournalDialog =3D nil             =

-        end
-        =

-        dialog.onMouseDown =3D function (widget,mousebutton)
-            if (mousebutton =3D=3D 2) then widget.dialog:Close() end
-            if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gu=
i.StartMoveDialog(widget.dialog.rootwidget) end
-        end
             =

         -- resize limits
         dialog.resize_min_total_x,dialog.resize_min_total_y =3D 0,-66	 -- =
-20,-66
@@ -248,54 +276,6 @@
             widget.bResizeNoScaleX =3D (widget.node and widget.node.attr.b=
ResizeNoScaleX =3D=3D "true")
             widget.bResizeNoScaleY =3D (widget.node and widget.node.attr.b=
ResizeNoScaleY =3D=3D "true")
         end
-			=

-        -- minimize btn
-		local widget =3D dialog.controls["journalminimize"]
-		widget.onMouseDown 		=3D function (widget,mousebutton)
-			pref.x,pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
-			local left,top,w,h =3D gJournalDialog:GetLTWH()
-			pref.dx,pref.dy =3D w,h
-			if (mousebutton =3D=3D 2) then widget.dialog:Close() end
-			if (mousebutton =3D=3D 1) then ToggleJournal_Small() end
-		end
-        =

-        -- resize btn
-		local widget =3D dialog.controls["journalresize"]
-		widget.onMouseDown              =3D function (widget,mousebutton) =

-            if (mousebutton =3D=3D 1) then
-                widget.gfx:SetMaterial(widget.mat_pressed)
-                gJournalResizeStartX,gJournalResizeStartY =3D GetMousePos()
-                if (true) then
-                    gui.bMouseBlocked =3D true
-                    RegisterStepper(function ()
-                        local x,y =3D GetMousePos()
-                        --AddFadeLines(sprintf("resize %d,%d",2.0*(x-gJour=
nalResizeStartX),(y-gJournalResizeStartY)))
-                        --AddFadeLines(sprintf("resize %d,%d",gJournalDial=
og.resize_x_total or 0,gJournalDialog.resize_y_total or 0))
-                        local dx =3D 2.0*(x-gJournalResizeStartX)
-                        --local dx =3D 0
-                        gJournalDialog:ResizeDelta(dx,(y-gJournalResizeSta=
rtY))
-                        gJournalResizeStartX,gJournalResizeStartY =3D x,y
-                        JournalUpdateText()
-                        =

-                        if (gKeyPressed[key_mouse1]) then
-                            return false -- continue stepping
-                        else
-                            gui.bMouseBlocked =3D false
-                            local left,top,w,h =3D gJournalDialog:GetLTWH()
-                            local bx1,by1,bx2,by2 =3D JournalGetTextBorder=
()
-                            local iw,ih =3D w-bx1-bx2	, h-by1-by2
-                            pref.dx,pref.dy =3D w,h
-                            pref.x,pref.y =3D gJournalDialog.rootwidget.gf=
x:GetPos()
-                            --printdebug("gump",(pref.dx or "dx=3Dnil ")..=
" -idxy- "..(pref.dy or "dy=3Dnil"))
-                            --printdebug("gump",(pref.x or "x=3Dnil ").." =
-xy- "..(pref.y or "y=3Dnil"))
-                            =

-                            return true -- terminate
-                        end
-                    end)
-                end =

-            end -- if
-        end -- function
-
 --[[
 		-- TODO: WRONG !!!! gives exceptions
         -- scrollbutton
@@ -327,16 +307,35 @@
                 JournalUpdateText()
             end -- if
 		end -- function
-]]--	=

-            =

+]]--    =

         JournalUpdateText()
     else
         gJournalDialog:Close()
     end -- if
-    =

+
     -- restore last posion and dimension if available
-    RestoreLastState()	=

-    =

-    -- widget.onMouseUp 		=3D function (widget,mousebutton) if (mousebutto=
n =3D=3D 1) then widget.gfx:SetMaterial(widget.mat_normal) end end
-	=

+    RestoreLastState()
+
 end	-- function
+
+--[[
+function RegisterJournalEntryType (name) _G["kEntryType_"..name] =3D name =
end
+
+-- TODO : maybe  gEntryTypeHandler.Chat =3D function (type,arr) return {r,=
g,b},sprintf("",arr[1],arr[2]) end
+RegisterJournalEntryType("Chat")
+RegisterJournalEntryType("TextMessage")
+RegisterJournalEntryType("ServerMessage")
+RegisterJournalEntryType("PickUpItem")
+RegisterJournalEntryType("DropItem")
+RegisterJournalEntryType("EquipItem")
+RegisterJournalEntryType("UnequipItem")
+RegisterJournalEntryType("Trade")
+RegisterJournalEntryType("DoubleClick")
+RegisterJournalEntryType("Use")
+RegisterJournalEntryType("Death")
+RegisterJournalEntryType("WarMode")
+
+function JournalAddEntry (entrytype,...)
+	-- TODO : vararg params
+end
+]]--

Modified: trunk/lua/gui/gui.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.main.lua (original)
+++ trunk/lua/gui/gui.main.lua Sun Mar 16 22:11:48 2008
@@ -1,4 +1,8 @@
-dofile(libpath .. "gui/gui.widget.lua")
+-- TODO
+--dofile(libpath .. "gui/gui.widget.lua")
+--dofile(libpath .. "gui/gui.container.lua")
+--dofile(libpath .. "gui/gui.pagedialog.lua")
+
 dofile(libpath .. "gui/gui.helper.lua")
 dofile(libpath .. "gui/gui.gumpparser.lua")
 dofile(libpath .. "gui/gui.paperdoll.lua")
@@ -10,7 +14,5 @@
 dofile(libpath .. "gui/gui.healthbar.lua")
 dofile(libpath .. "gui/gui.securetrade.lua")
 dofile(libpath .. "gui/gui.skill.lua")
-
--- TODO
-dofile(libpath .. "gui/gui.container.lua")
-dofile(libpath .. "gui/gui.pagedialog.lua")
+dofile(libpath .. "gui/gui.spellbook.lua")
+dofile(libpath .. "gui/gui.trade.lua")

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Sun Mar 16 22:11:48 2008
@@ -1,3 +1,5 @@
+-- TODO : admin char paperdoll body broken : bodyid,bodygumpid =3D     987=
     0x03db  : body gump id unknown unknown  ( GM admin robe)
+-- TODO : gump.def must be parsed, simple format
 -- packet handlers for paperdolls (clother and equipment of player, npcs..)
 -- see also lib.packet.lua and lib.protocol.lua
 -- see also net.mobile.lua, especially kPacket_Equipped_MOB
@@ -6,23 +8,22 @@
 -- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local playerPaperdoll =3D {}
-playerPaperdoll.dialogId =3D 7493484
+playerPaperdoll.dialogId =3D 1000001
 playerPaperdoll.x =3D 120
 playerPaperdoll.y =3D 100
 playerPaperdoll.Data =3D
  "{ page 0 }" ..
- "{ gumppic 4 4 2000 }" ..
- "{ button 187 50 2031 2032 1 0 0 }" ..
- "{ button 187 76 2006 2007 1 0 1 }" ..
--- "{ croppedtext 36 263 200 40 0 0 paperdollname }" ..
+ "{ gumppic 4 4 2000 paperdollpic }" ..
+ "{ button 187 50 2031 2032 1 0 0 btnhelp }" ..
+ "{ button 187 76 2006 2007 1 0 1 btnoptions }" ..
  "{ text 36 263 0 0 paperdollname }" ..
- "{ button 84 6 113 113 1 0 2 }" ..
- "{ button 187 102 2009 2010 1 0 3 }" ..
- "{ button 187 130 22453 22455 1 0 4 }" ..
- "{ button 187 156 2015 2016 1 0 5 }" ..
- "{ button 187 181 22450 22452 1 0 6 }" ..
- "{ button 187 205 2021 2022 1 0 7 }" ..
- "{ button 187 233 2027 2028 1 0 8 }"
+ "{ button 84 6 113 113 1 0 2 btnvirtues }" ..
+ "{ button 187 102 2009 2010 1 0 3 btnquit }" ..
+ "{ button 187 130 22453 22455 1 0 4 btnquests }" ..
+ "{ button 187 156 2015 2016 1 0 5 btnskills }" ..
+ "{ button 187 181 22450 22452 1 0 6 btnguild }" ..
+ "{ button 187 205 2021 2022 1 0 7 btnpeace }" ..
+ "{ button 187 233 2027 2028 1 0 8 btnstatus }"
 playerPaperdoll.textline =3D {
  [0] =3D "paperdoll_name",
 }
@@ -82,15 +83,14 @@
 -- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local npcPaperdoll =3D {}
-npcPaperdoll.dialogId =3D 89878734
+npcPaperdoll.dialogId =3D 1000002
 npcPaperdoll.x =3D 120
 npcPaperdoll.y =3D 100
 npcPaperdoll.Data =3D
  "{ page 0 }" ..
- "{ gumppic 4 4 2001 }" ..
--- "{ croppedtext 36 263 200 40 0 0 paperdollname }" ..
+ "{ gumppic 4 4 2001 paperdollpic }" ..
  "{ text 36 263 0 0 paperdollname }" ..
- "{ button 187 233 2027 2028 1 0 0 }"
+ "{ button 187 233 2027 2028 1 0 0 btnstatus }"
 npcPaperdoll.textline =3D {
  [0] =3D "paperdoll_name",
 }
@@ -104,46 +104,16 @@
 		  end
 }
 =

+-- base body gump ids
 local kGumpBaseId_Male	=3D 50000
 local kGumpBaseId_Female=3D 60000
 =

--- WARNING ! this is not a complete list (see gLayerType for that) , e.g. =
kLayer_Mound =3D 0x19 is not in here
-gLayerOrder =3D {
-	hex2num("0x09"),					   -- - N/A (not used)
-    hex2num("0x14"),                       -- - Back (Cloak)
-    hex2num("0x10"),                       -- - Facial Hair
-    hex2num("0x12"),                       -- - Earrings
-    hex2num("0x04"),                       -- - Leg Covering (including Pa=
nts"), Shorts"), Bone/Chain/Ring legs)
-    hex2num("0x0E"),                       -- - Bracelet
-    hex2num("0x03"),                       -- - Foot Covering/Armor
-    hex2num("0x08"),                       -- - Ring
-    hex2num("0x18"),                       -- - Legs (inner)(Leg Armor)
-    hex2num("0x05"),                       -- - Chest Clothing/Female Ches=
t Armor
-    hex2num("0x0D"),                       -- - Torso (inner)(Chest Armor)
-    hex2num("0x11"),                       -- - Torso (Middle)(Surcoat"), =
Tunic"), Full Apron"), Sash)
-    hex2num("0x0A"),                       -- - Neck Covering/Armor
-    hex2num("0x13"),                       -- - Arm Covering/Armor
-    hex2num("0x07"),                       -- - Hand Covering/Armor
-    hex2num("0x17"),                       -- - Legs (outer)(Skirt/Kilt)
-    hex2num("0x0B"),                       -- - Hair
-    hex2num("0x16"),                       -- - Torso (outer)(Robe)
-    hex2num("0x06"),                       -- - Head Covering/Armor
-    hex2num("0x0C"),                       -- - Waist (Half-Apron)
-    hex2num("0x01"),                       -- - Single-Hand item/weapon
-    hex2num("0x02"),                       -- - Two-Hand item/weapon (incl=
uding Shield)
-    hex2num("0x15"),                       -- - BackPack
-    hex2num("0x0F")
-}
-
--- TODO : admin char paperdoll body broken : bodyid,bodygumpid =3D     987=
     0x03db  : body gump id unknown unknown  ( GM admin robe)
--- TODO : gump.def must be parsed, simple format
+-- initial body positon in gump
+local BodyWidget_x	=3D 9
+local BodyWidget_y	=3D 19
 =

 gPaperdolls =3D {}
 =

--- from old iris code, src/gui/Paperdoll.cpp, returns bodygumpid,base_id
--- base_id is usually 50000 for male and 60000 for female models
--- TODO : we should put this in a seperate file for easy editing
--- TODO : maybe this comes from Models.txt
 local function GetPaperdollBodyAndBaseID (bodyid)
 	local bodygumpid =3D nil
 	local base_id =3D kGumpBaseId_Male
@@ -214,9 +184,9 @@
 	return bodygumpid,base_id
 end
 =

--- don't call this directly, use RebuildPaperdoll() instead (need to rebui=
ld completely on change because of layerorder)
-local function CreatePaperdollItemWidget(paperdoll,item,base_id)
-	-- item fields : serial artid layer hue (=3D-1 if not set)
+-- Don't call this directly, use RebuildPaperdoll() instead (need to rebui=
ld completely on change because of layerorder)
+-- item fields : serial artid layer hue (=3D-1 if not set)
+local function CreatePaperdollItemWidget(paperdoll, item, base_id)
 	local dialog =3D paperdoll.dialog
 	local animid =3D nil
 	local typename =3D ""
@@ -227,32 +197,30 @@
 	end
 =

 	if (not animid) then
-		print("WARNING : CreatePaperdollItemWidget : unknown itemtype -> forced =
Crash")
+		print("WARNING : CreatePaperdollItemWidget : unknown animid -> forced Cr=
ash")
 		Crash()
 		-- TODO : dummy gfx ?
 	end
-	=

-	-- fallback to female
+
+	-- Fallback to female
 	-- TODO : SiENcE : local gumpid =3D animid+50000
 	local gumpid =3D animid+base_id
 	if (GetGumpMat(gumpid) =3D=3D "" and base_id =3D=3D kGumpBaseId_Female) t=
hen gumpid =3D animid+kGumpBaseId_Male end -- fallback to male
 	if (item.layer =3D=3D kLayer_Backpack) then gumpid =3D animid+kGumpBaseId=
_Male end -- no female backpack ;)
-	=

-	--print("CreatePaperdollItemWidget",gumpid,item.layer,animid,base_id)
-	local xoff,yoff =3D 9,19
-	local widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, xoff, yoff=
 , 0, 0, 0, item.hue)
+
+	local widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, BodyWidget=
_x, BodyWidget_y, 0, 0, 0, item.hue)
 =

 	widget.mbIgnoreMouseOver =3D false
 	widget.uoPaperdoll =3D paperdoll
 	widget.item =3D item
 	item.widget =3D widget
 =

+	widget.onMouseDown =3D function (widget,mousebutton) end
+
+	-- TODO : find a cleaner solution to override the mousepick tipp
 	widget.onMouseEnter =3D function () -- item tooltip (clientside,debuginfo=
s)
-							-- TODO : find a cleaner solution to override the mousepick tipp
 							local name =3D GetStaticTileTypeName(item.artid) or ""
 							info =3D sprintf("equipment %s (artid=3D%04x=3D%d)",name,item.artid=
,item.artid)
-							--print("CreatePaperdollItemWidget onMouseEnter ",name,vardump(item=
))
-							-- interesting ? local t =3D GetStaticTileType(item.artid) -- t.miA=
nimID
 							gCurrentRenderer.gMousePickTippOverride =3D info
 							Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
 						end
@@ -261,8 +229,7 @@
 		gCurrentRenderer.gMousePickTippOverride =3D false
 		Client_SetBottomLine("")
 	end
-	widget.onMouseDown =3D function (widget,mousebutton) end
-	=

+
 	if (gTooltipSupport) then
 		widget.tooltip_offx =3D kUOToolTippOffX
 		widget.tooltip_offy =3D kUOToolTippOffY
@@ -305,7 +272,7 @@
 	paperdoll.mobile =3D mobile
 	paperdoll.bIsPlayer =3D IsPlayerMobile(mobile)
 	=

-	-- create paperdoll dialog if neccessary
+	-- create paperdoll dialog for player or mobile if neccessary
 	local dialog =3D paperdoll.dialog
 	if (not dialog) then
 		if (paperdoll.bIsPlayer) then
@@ -314,9 +281,11 @@
 			dialog =3D GumpParser( npcPaperdoll, true )
 		end
 =

+		-- save paperdolldialog as paperdoll
 		paperdoll.dialog =3D dialog
 		dialog.uoPaperdoll =3D paperdoll
 =

+		-- overwrite the onMouseDown function from gumpparser
 		dialog.onMouseDown =3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 2) then ClosePaperdoll(paperdoll) end
 			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget.dialog.rootwidget) end
@@ -332,11 +301,18 @@
 			widget.mat_over 	=3D GetGumpMat(hex2num("0x7EA"))
 			widget.gfx:SetMaterial(widget.mat_normal)
 		end
-	end
-	=

+	else
+		local widget =3D dialog.controls["btnpeace"]
+		if (widget) then
+			widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E5"))
+			widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E6"))
+			widget.mat_over 	=3D GetGumpMat(hex2num("0x7E7"))
+			widget.gfx:SetMaterial(widget.mat_normal)
+		end
+	end
+
+	-- update paperdoll name and color
 	local r,g,b =3D GetNotorietyColor(paperdoll.mobile.notoriety)
-
-	-- update paperdoll name
 	dialog.controls["paperdollname"].gfx:SetCharHeight(gFontGumpSize + 2)
 	dialog.controls["paperdollname"].gfx:SetColour( {r,g,b,1.0} )
 	dialog.controls["paperdollname"].gfx:SetFont(gFontNameDefault)
@@ -344,7 +320,7 @@
 =

 	-- remove old item widgets
 	DestroyPaperdollItemWidgets(paperdoll)
-	=

+
 	-- create bodywidget and item widgets
 	if (mobile) then
 		local bodyid =3D mobile.artid
@@ -358,7 +334,7 @@
 		=

 		-- create bodywidget
 		if (bodygumpid) then
-			dialog.bodywidget =3D MakeBorderGumpPart(dialog.rootwidget,bodygumpid,9=
,19 , 0, 0, 0,skinhue)
+			dialog.bodywidget =3D MakeBorderGumpPart(dialog.rootwidget, bodygumpid,=
 BodyWidget_x, BodyWidget_y, 0, 0, 0, skinhue)
 		else =

 			--print("Open_Paperdoll : unknown bodyid ",bodyid,sprintf("0x%04x",body=
id))
 			-- TODO : fallback/default bodyid ?
@@ -371,7 +347,7 @@
 			if (item) then CreatePaperdollItemWidget(paperdoll,item,base_id) end
 		end
 	end
-	=

+
 	if (mobile and mobile.name ~=3D paperdoll.name) then =

 		mobile.name =3D paperdoll.name =

 		mobile:Update()

Modified: trunk/lua/gui/gui.quit.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.quit.lua (original)
+++ trunk/lua/gui/gui.quit.lua Sun Mar 16 22:11:48 2008
@@ -1,16 +1,16 @@
 -- Created 12.03.2008 16:40:10, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local quitGump =3D {}
-quitGump.dialogId =3D 34436564
+quitGump.dialogId =3D 9000001
 quitGump.x =3D 100
 quitGump.y =3D 100
 quitGump.Data =3D
 	 "{ page 0 }" ..
-	 "{ gumppic 0 0 2070 }" ..
-	 "{ button 36 78 2071 2072 1 0 0 }" ..
-	 "{ button 99 78 2074 2075 1 0 1 }" ..
-	 "{ text 70 25 0 0 }" ..
-	 "{ text 44 42 0 1 }"
+	 "{ gumppic 0 0 2070 quitpic }" ..
+	 "{ button 36 78 2071 2072 1 0 0 btnquit }" ..
+	 "{ button 99 78 2074 2075 1 0 1 btncancel }" ..
+	 "{ text 70 25 0 0 quittext }" ..
+	 "{ text 44 42 0 1 quituo }"
 quitGump.textline =3D {
 	[0] =3D "Quit",
 	[1] =3D "Ultima Online?",
@@ -25,6 +25,7 @@
 function OpenQuit()
 	local dialog =3D GumpParser( quitGump, true )
 =

+	-- overwrite the onMouseDown function from gumpparser
 	dialog.onMouseDown =3D function (widget,mousebutton)
 		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
 		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end

Modified: trunk/lua/gui/gui.securetrade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.securetrade.lua (original)
+++ trunk/lua/gui/gui.securetrade.lua Sun Mar 16 22:11:48 2008
@@ -1,3 +1,21 @@
+-- Created 11.03.2008 16:55:39, with GumpStudio & Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local securetrading =3D {}
+securetrading.dialogId =3D 4000001
+securetrading.x =3D 0
+securetrading.y =3D 0
+securetrading.Data =3D
+	 "{ page 0 }" ..
+	 "{ gumppic 0 0 2150 securepic }" ..
+	 "{ checkbox 52 30 2151 2153 0 cbmy }" ..
+	 "{ checkbox 268 162 2151 2153 0 cbtheir }" ..
+	 "{ text 85 36 0 0 namemy }" ..
+	 "{ text 70 166 0 1 nametheir }"
+securetrading.textline =3D {
+	[0] =3D "me",
+	[1] =3D "unknown",
+}
+
 -- handles secure trading between players
 -- see also net.uodragdrop.lua for container like droparea
 -- see also net.trade.lua for trade with npcs / shop / vendor...
@@ -5,29 +23,9 @@
 -- see also old iris trade.csl or so  callback_OnTradeCheck callback_OnTra=
deStart
 -- secure trade is started by dragdrop onto player .. server sends start w=
ith two containers
 =

--- Created 11.03.2008 16:55:39, with GumpStudio & Iris2 Lua Export Plugin
--- Exported Iris2 GumpExporter ver 1.0.
-local securetrading =3D {}
-securetrading.dialogId =3D 34567
-securetrading.x =3D 0
-securetrading.y =3D 0
-securetrading.Data =3D
-	 "{ page 0 }" ..
-	 "{ gumppic 0 0 2150 }" ..
-	 "{ checkbox 52 30 2151 2153 0 cbmy }" ..
-	 "{ checkbox 268 162 2151 2153 0 cbtheir }" ..
-	 "{ text 85 36 0 0 }" ..
-	 "{ text 70 166 0 1 }" ..
-	 "" =

-securetrading.textline =3D {
-	[0] =3D "namemy",
-	[1] =3D "nametheir",
-}
-
 kSecTradeAction_Start =3D 0
 kSecTradeAction_Cancel =3D 1
 kSecTradeAction_ChangeCheck =3D 2
-
 =

 kSecureTradeContainerPos_LeftX =3D 50 -- left is my
 kSecureTradeContainerPos_LeftY =3D 90
@@ -49,8 +47,6 @@
 =

 	local addx,addy =3D kSecureTradeContainerPos_LeftX,kSecureTradeContainerP=
os_LeftY
 	if (not bIsMyStuff) then addx,addy =3D kSecureTradeContainerPos_RightX,kS=
ecureTradeContainerPos_RightY end
-	=

-	--print("SecureTradeRebuildContainerWidgets",mysectrade.id,bIsMyStuff)
 	=

 	local parent =3D mysectrade.dialog.rootwidget
 	for k,item in pairs(container:GetContent()) do
@@ -92,23 +88,8 @@
 				gCurrentRenderer.gMousePickTippOverride =3D info
 				Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
 			end
-			=

 		end
 	end
-	=

-	--[[
-	SecureTradeObjectToObjectHook(item)
-	=

-	item.serial =3D input:PopNetUint32()
-	item.artid =3D input:PopNetUint16()
-	item.artid_addstack =3D input:PopNetUint8()
-	item.amount =3D input:PopNetUint16()
-	item.xloc =3D input:PopNetUint16()
-	item.yloc =3D input:PopNetUint16()
-	item.iContainerSerial =3D input:PopNetUint32()
-	item.hue =3D input:PopNetUint16()
-	printf("NET : kPacket_Object_to_Object : container=3D0x%08x item=3D0x%08x=
 artid=3D0x%04x amount=3D%d\n",item.iContainerSerial,item.serial,item.artid=
,item.amount)
-	]]--
 end
 =

 -- triggered when anything is changed,added or removed in/from a container
@@ -128,10 +109,6 @@
 end
 =

 function RecvSecureTrade (sectrade) -- handles data from kPacket_SecureTra=
de
-	printf("RecvSecureTrade action=3D%d, s1=3D0x%08x,s2=3D0x%08x,s3=3D0x%08x =
name=3D%s\n",
-		sectrade.action,sectrade.serial1,sectrade.serial2,sectrade.serial3,sectr=
ade.name or "")
-	=

-	-- GetStaticTileType(hex2num("0x0f52"))
 	if (sectrade.action =3D=3D kSecTradeAction_Start) then
 		-- construct sectrade object
 		local mysectrade =3D {}
@@ -154,30 +131,28 @@
 		local old =3D gSecureTrades[mysectrade.id]
 		if (old) then old:Close() end
 		gSecureTrades[mysectrade.id] =3D mysectrade
-		=

+
 		-- show dialog
-		--local dialog =3D CreateGumpDlgFromGfm(datapath.."gfm/secure_trade.gfm")
 		local dialog =3D GumpParser( securetrading, true )
 =

-		for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
-		mysectrade.dialog =3D dialog =

-		dialog.uoSecureTrade =3D mysectrade =

-		dialog.rootwidget.gfx:SetPos(120,100)
+		mysectrade.dialog =3D dialog
+		dialog.uoSecureTrade =3D mysectrade
+
+		-- overwrite the onMouseDown function from gumpparser
 		dialog.onMouseDown =3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 2) then widget.dialog.uoSecureTrade:Cancel() end
 			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget.dialog.rootwidget) end
 		end
-		=

-		-- update name display name
+
+		-- update gump text fields
 		dialog.controls["namemy"].gfx:SetText(GetPlayerName() or "me")
 		dialog.controls["nametheir"].gfx:SetText(sectrade.name or "unknown")
-		-- ./net.paperdoll.lua:55:	dialog =3D CreateGumpDlgFromGfm(...)
-		-- cb_my cb_their  normal=3D'0x867' checked=3D'0x869' -- todo :  $209 $2=
08 gumpids ?
-		=

-		dialog.controls["cbmy"].onChange =3D function (widget,bChecked) =

-			--print("Send_SecureTrade_ChangeAgree",widget.dialog.uoSecureTrade.id,b=
Checked)
-			Send_SecureTrade_ChangeAgree(widget.dialog.uoSecureTrade.id,bChecked an=
d 1 or 0)
-		end
+
+		-- create function for checkbox
+		dialog.controls["cbmy"].onChange =3D function (widget,bChecked)
+												Send_SecureTrade_ChangeAgree(widget.dialog.uoSecureTrade.id,bC=
hecked and 1 or 0)
+										   end
+
 		SecureTradeRebuildContainers(mysectrade)
 	elseif (sectrade.action =3D=3D kSecTradeAction_Cancel) then
 		local mysectrade =3D gSecureTrades[sectrade.serial1]
@@ -187,7 +162,6 @@
 		if (mysectrade) then =

 			local myOK 		=3D sectrade.serial2 ~=3D 0
 			local theirOK 	=3D sectrade.serial3 ~=3D 0
-			--print("Recv_SecureTrade_ChangeAgree",mysectrade.id,myOK,theirOK)
 			if (myOK and theirOK) then
 				-- trade finished
 				mysectrade:Close()
@@ -198,18 +172,4 @@
 			end
 		end
 	end
-	=

-	--[[
-	hagish serial =3D serial=3D0x00005c55 =3D 23637
-	ghouly serial =3D serial=3D0x0002f31e =3D 193310
-	=

-	RecvSecureTrade action=3D2, s1=3D0x40104009
-	NET : kPacket_Object_to_Object : container=3D0x00005c55 item=3D0x40104008=
 artid=3D0x1e5e amount=3D1
-	RecvSecureTrade action=3D2, s1=3D0x40104009
-	NET : kPacket_Object_to_Object : container=3D0x0002f31e item=3D0x40104009=
 artid=3D0x1e5e amount=3D1
-	RecvSecureTrade action=3D0, s1=3D0x00005c55,s2=3D0x40104009,s3=3D0x401040=
08 name=3DTizi
-	RecvSecureTrade action=3D2, s1=3D0x40104009
-	RecvSecureTrade action=3D2, s1=3D0x40104009
-	NET : kPacket_Object_to_Object : container=3D0x40104008 item=3D0x400a68fc=
 artid=3D0x0f52 amount=3D1
-	]]--
 end

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Sun Mar 16 22:11:48 2008
@@ -1,35 +1,56 @@
 -- Created 11.03.2008 16:09:57, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local skillGump =3D {}
-skillGump.dialogId =3D 1234
-skillGump.x =3D 0
-skillGump.y =3D 0
+skillGump.dialogId =3D 5000001
+skillGump.x =3D 25
+skillGump.y =3D 25
 skillGump.Data =3D
 	 "{ page 0 }" ..
-	 "{ gumppic 23 311 2083 }" ..
-	 "{ gumppic 21 241 2082 }" ..
-	 "{ gumppic 42 273 2102 }" ..
-	 "{ gumppictiled 21 64 263 177 2081 }" ..
-	 "{ gumppic 4 27 2080 }" ..
-	 "{ gumppic 120 37 2100 }" ..
-	 "{ button 139 342 2094 2095 1 0 0 }" ..
-	 "{ gumppic 44 62 2091 }" ..
-	 "{ button 255 61 2084 2084 1 0 skillscrollup }" ..
-	 "{ button 255 291 2085 2085 1 0 skillscrolldown }" ..
-	 "{ button 139 4 2093 2093 1 0 skillclose }" ..
-	 "{ button 259 76 2088 2088 1 0 skillscroll }"
+	 "{ gumppic 23 311 2083 xx1 }" ..
+	 "{ gumppic 21 241 2082 xx2 }" ..
+	 "{ gumppic 42 273 2102 xx3 }" ..
+	 "{ gumppictiled 21 64 263 177 2081 xx4 }" ..
+	 "{ gumppic 4 27 2080 xx5 }" ..
+	 "{ gumppic 120 37 2100 xx6 }" ..
+	 "{ button 139 342 2094 2095 1 0 0 skillresize }" ..
+	 "{ gumppic 44 62 2091 xx7 }" ..
+	 "{ button 255 61 2084 2084 1 0 1 skillscrollup }" ..
+	 "{ button 255 291 2085 2085 1 0 2 skillscrolldown }" ..
+	 "{ button 139 4 2093 2093 1 0 3 skillclose }" ..
+	 "{ button 259 76 2088 2088 1 0 4 skillscroll }"
 skillGump.textline =3D {
 }
+skillGump.functions =3D {
+ -- skillresize (not implemented yet)
+ [0]	=3D function (widget,mousebutton) end,
+ -- skillscrollup
+ [1]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then widg=
et.dialog:Scroll(-3) end end,
+ -- skillscrolldown
+ [2]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then widg=
et.dialog:Scroll(3) end end,
+ -- skillclose
+ [3]	=3D function (widget,mousebutton)
+ 			if (mousebutton =3D=3D 1) then =

+				widget.gfx:SetMaterial(widget.mat_pressed)
+				-- TODO: toggle to gump-id 0x839 on upper right corner (moveable) ... =
on doubleclick open skills again
+				gSkillDialog:Close()
+		 	end
+		  end,
+ -- skillscroll
+ [4]	=3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget) end
+		  end,
+}
+
 -- Created 11.03.2008 15:41:19, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local quickskillGump =3D {}
-quickskillGump.dialogId =3D 234567
+quickskillGump.dialogId =3D 5000002
 quickskillGump.x =3D 0
 quickskillGump.y =3D 0
 quickskillGump.Data =3D
 	 "{ page 0 }" ..
-	 "{ gumppic 0 0 2445 }" ..
-	 "{ gumppic 5 5 2362 }"
+	 "{ gumppic 0 0 2445 xx1 }" ..
+	 "{ gumppic 5 5 2362 xx2 }"
 quickskillGump.textline =3D {
 }
 =

@@ -65,12 +86,46 @@
 	end
 end
 =

+glQuickCastDialog =3D {}
+-- creates a quickcast button at the given position
+function CreateQuickCastButton (x,y,name,fun)
+	quickskillGump.x=3Dx
+	quickskillGump.y=3Dy
+	local dialog =3D GumpParser( quickskillGump, true )
+	=

+	-- overrride dialog close function from gumpparser
+	dialog.Close =3D function (dialog)
+		table.foreach (table, function (k,v) if v =3D=3D dialog then table.remov=
e(glQuickCastDialog,k) end end)
+		dialog:Destroy()
+	end
+	-- overwrite the onMouseDown function from gumpparser
+	dialog.onMouseDown =3D function (widget,mousebutton)
+		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
+		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end
+	end
+
+	if string.len(name) > 10 then
+		name =3D string.sub(name,0,12)..".." =

+	end
+	=

+	local text =3D guimaker.MakeText(dialog.rootwidget, 20, 5, name, gFontGum=
pSize, {1.0,1.0,1.0,1.0}, gFontNameDefault)
+	local w,h =3D text.gfx:GetDimensions()
+	-- cast text button
+	local b =3D 2
+	local button =3D 	guimaker.MakeButton(dialog.rootwidget, 20+b, 5+b, w-2*b=
, h-2*b, {0,0,0,0.0})
+	button.gfx:SetVisible(true)
+	button.mbIgnoreMouseOver =3D false
+	button.onLeftClick =3D function (widget) fun() end
+
+	table.insert(glQuickCastDialog,dialog)
+end
+
 gSkillDialog_LastPositionX =3D nil
 gSkillDialog_LastPositionY =3D nil
 gSkillDialog_LastPositionScrollIndex =3D nil
 function ToggleSkill ()
 	if (gSkillDialog) then
-		-- store current positoin
+		-- store current position
 		gSkillDialog_LastPositionX, gSkillDialog_LastPositionY =3D gSkillDialog.=
rootwidget.gfx:GetPos()
 		-- and close
 		gSkillDialog:Close()
@@ -82,43 +137,33 @@
 		=

 		local scrollbar_h =3D scrollbar_y_end - scrollbar_y_start
 	=

-		-- gSkillDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/skill.gfm")
-		gSkillDialog =3D GumpParser( skillGump, true )
-		=

+		local dialog =3D GumpParser( skillGump, true )
+		=

+		gSkillDialog =3D dialog
+	=

 		-- restore last positoin if available
 		if gSkillDialog_LastPositionX and gSkillDialog_LastPositionY then gSkill=
Dialog.rootwidget.gfx:SetPos(gSkillDialog_LastPositionX, gSkillDialog_LastP=
ositionY) end
-		=

-		-- TODO : init Skill dialog
-		local dialog =3D gSkillDialog
+
 		dialog.Close =3D function (dialog)
 			gSkillDialog:Destroy()
 			gSkillDialog =3D nil
 		end
+
+		-- overwrite the onMouseDown function from gumpparser
 		dialog.onMouseDown =3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 2) then widget.dialog:Close() end
 			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget.dialog.rootwidget) end
 		end
-		=

+	=

 		-- xml attributes to resize params
 		for k,widget in pairs(dialog.childs) do
 			widget.mbIgnoreMouseOver =3D false
 			if (widget.node and widget.node.attr.bResizeNoScaleX =3D=3D "true") the=
n widget.bResizeNoScaleX =3D true end
 			if (widget.node and widget.node.attr.bResizeNoScaleY =3D=3D "true") the=
n widget.bResizeNoScaleY =3D true end
 		end
-		=

-		-- close button
-		local widget =3D dialog.controls["skillclose"]
-		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then =

-			widget.gfx:SetMaterial(widget.mat_pressed)
-			-- TODO: toggle to gump-id 0x839 on upper right corner (moveable) ... o=
n doubleclick open skills again
-			gSkillDialog:Close()
-		end end
-		=

+
 		-- scrollbar middle button
 		local widget =3D dialog.controls["skillscroll"]
-		widget.onMouseDown 		=3D function (widget,mousebutton)
-			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget) end
-		end
 		-- custom move/drag setpos for handling middle part of the scrollbar
 		widget.CustomMoveSetPos =3D function(widget,x,y)
 			local ny =3D y
@@ -134,13 +179,6 @@
 			-- set position
 			widget.gfx:SetPos(scrollbar_x,ny)
 		end
-		=

-		-- scroll buttons
-		local widget =3D dialog.controls["skillscrollup"]
-		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then dialog:Scroll(-3) end end
-
-		local widget =3D dialog.controls["skillscrolldown"]
-		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then dialog:Scroll(3) end end
 =

 		-- functions handling the up/down/lock switch
 		-- state: (0=3Dup, 1=3Ddown, 2=3Dlocked)
@@ -280,7 +318,6 @@
 					skill.button_use_drag.onMouseDown =3D function (widget,mousebutton)
 						if (mousebutton =3D=3D 1) then =

 							skill.button_use_drag.mStartX,skill.button_use_drag.mStartY =3D ski=
ll.button_use_drag.gfx:GetPos()
-							--print("start",skill.button_use_drag.mStartX,skill.button_use_drag=
.mStartY)
 							skill.button_use_drag.dialog:BringToFront() =

 							gui.StartMoveDialog(skill.button_use_drag) =

 						end
@@ -305,105 +342,16 @@
 				table.insert(dialog.lSkill,skill)
 			end
 		end
-		=

+
 		-- scroll to last position if available
 		if gSkillDialog_LastPositionScrollIndex then =

 			dialog:ScrollToIndex(gSkillDialog_LastPositionScrollIndex)
 		else
 			dialog:ScrollToIndex(0)
 		end
-		=

-		-- minimize btn
-		--[[
-		local widget =3D dialog.controls["skill_minimize"]
-		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then =

-			widget.gfx:SetMaterial(widget.mat_pressed)
-			gSkillDialog:ResizeMinimize()
-		end end
-		]]--
-		=

+
 		-- resize limits
 		dialog.resize_min_total_x,dialog.resize_min_total_y =3D -100,-66
 		dialog.resize_max_total_x,dialog.resize_max_total_y =3D 334,212
-		=

-		-- resize btn
-		--[[
-		local widget =3D dialog.controls["skill_resize"]
-		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then =

-			widget.gfx:SetMaterial(widget.mat_pressed)
-			gSkillResizeStartX,gSkillResizeStartY =3D GetMousePos()
-			if (true) then
-				gui.bMouseBlocked =3D true
-				RegisterStepper(function ()
-					local x,y =3D GetMousePos()
-					--AddFadeLines(sprintf("resize %d,%d",2.0*(x-gSkillResizeStartX),(y-g=
SkillResizeStartY)))
-					--AddFadeLines(sprintf("resize %d,%d",gSkillDialog.resize_x_total or =
0,gSkillDialog.resize_y_total or 0))
-					local dx =3D 2.0*(x-gSkillResizeStartX)
-					--local dx =3D 0
-					gSkillDialog:ResizeDelta(dx,(y-gSkillResizeStartY))
-					gSkillResizeStartX,gSkillResizeStartY =3D x,y
-					if (gKeyPressed[key_mouse1]) then
-						return false -- continue stepping
-					else
-						gui.bMouseBlocked =3D false
-						return true -- terminate
-					end
-				end)
-			end
-		end end
-		]]--
-		=

-		-- widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutto=
n =3D=3D 1) then widget.gfx:SetMaterial(widget.mat_normal) end end
-	=

-		-- show first page
-		-- ShowSkillPage(0)
-		=

-		=

 	end
 end
-
-glQuickCastDialog =3D {}
--- creates a quickcast button at the given position
-function CreateQuickCastButton (x,y,name,fun)
-	-- local dialog =3D CreateGumpDlgFromGfm(datapath.."gfm/quickcast.gfm")
-	local dialog =3D GumpParser( quickskillGump, true )
-
-	-- handle mouse events
-	for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
-	=

-	-- dialog base functions
-	dialog.Close =3D function (dialog)
-		table.foreach (table, function (k,v) if v =3D=3D dialog then table.remov=
e(glQuickCastDialog,k) end end)
-		dialog:Destroy()
-	end
-
-	dialog.onMouseDown =3D function (widget,mousebutton)
-		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
-		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end
-	end
-
-	if string.len(name) > 10 then
-		name =3D string.sub(name,0,12)..".." =

-	end
-	=

-	local root =3D dialog.rootwidget
-	=

-	root.gfx:SetPos(x,y)
-	=

-	local text =3D guimaker.MakeText(root, 20, 5, name, gFontGumpSize, {1.0,1=
.0,1.0,1.0}, gFontNameDefault)
-	local w,h =3D text.gfx:GetDimensions()
-	--print("size",text,w,h)
-	=

-	-- cast text button
-	local b =3D 2
-	local button =3D 	guimaker.MakeButton(root, 20+b, 5+b, w-2*b, h-2*b, {0,0=
,0,0.0})
-	button.gfx:SetVisible(true)
-	button.mbIgnoreMouseOver =3D false
-	=

-	button.onLeftClick =3D function (widget)
-		--print("click")
-		fun()
-	end
-	=

-	table.insert(glQuickCastDialog,dialog)
-end

Modified: trunk/lua/gui/gui.status.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.status.lua (original)
+++ trunk/lua/gui/gui.status.lua Sun Mar 16 22:11:48 2008
@@ -1,12 +1,12 @@
 -- Created 09.03.2008 15:05:13, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local statusGump =3D {}
-statusGump.dialogId =3D 1234
+statusGump.dialogId =3D 6000001
 statusGump.x =3D 0
 statusGump.y =3D 0
 statusGump.Data =3D
 	 "{ page 0 }" ..
-	 "{ gumppic 0 0 10860 }" ..
+	 "{ gumppic 0 0 10860 statuspic }" ..
 	 "{ text 54 44 0 0 statusname }" ..
 	 "{ text 88 71 0 1 statusstr }" ..
 	 "{ text 88 99 0 2 statusdex }" ..
@@ -76,8 +76,6 @@
 		-- request stats update of player body
 		if gPlayerBodySerial then Send_ClientQuery(gRequest_States,gPlayerBodySe=
rial) end
 =

-		-- old gfm file
-		-- gStatusAosDialog =3D CreateGumpDlgFromGfm(datapath.."gfm/status_aos.g=
fm")
 		gStatusAosDialog =3D GumpParser( statusGump, true )
 =

 		-- restore last positoin if available
@@ -89,6 +87,8 @@
 			gStatusAosDialog:Destroy()
 			gStatusAosDialog =3D nil
 		end
+		=

+		-- overwrite the onMouseDown function from gumpparser
 		dialog.onMouseDown =3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 2) then widget.dialog:Close() end
 			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget.dialog.rootwidget) end

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Mar 16 22:11:48 2008
@@ -2,9 +2,9 @@
 -- TODO: update definition needed
 =

 gSpellbookExpansion =3D {}
-gSpellbookExpansion["AOS"]=3D hex2num("0x00")		--Mage, Necromancer and Pal=
adin spells
-gSpellbookExpansion["SE"]=3D hex2num("0x01")		--Samurai and Ninja Spells
-gSpellbookExpansion["ML"]=3D hex2num("0x02")		--Spellweaving Spells
+gSpellbookExpansion["AOS"]	=3D hex2num("0x00")		--Mage, Necromancer and Pa=
ladin spells
+gSpellbookExpansion["SE"]	=3D hex2num("0x01")		--Samurai and Ninja Spells
+gSpellbookExpansion["ML"]	=3D hex2num("0x02")		--Spellweaving Spells
 =

 --RunUO1 old_spellbook Items
 --[[
@@ -53,274 +53,6 @@
 	return matrix
 end
 =

-gAvailSpellbooks =3D {}
-function Open_Spellbook(spellbook)
-	local dialog =3D gAvailSpellbooks[spellbook.serial]
-	if (dialog and not(spellbook.old)) then
-		printf("Spellbook Container already exists. Delete this Container. seria=
l=3D0x%08x\n",spellbook.serial)
-		dialog:SetVisible(false)
-		gAvailSpellbooks[dialog.spellbookserial]=3Dnil
-		dialog =3D nil
-	end
-	if (not(dialog)) then
-		dialog =3D guimaker.MakeSortedDialog()
-		dialog.Close =3D function (dialog)
-			-- TODO : close this properly, destroy widgets etc... =

-			dialog:SetVisible(false)
-			gAvailSpellbooks[dialog.spellbookserial]=3Dnil
-			dialog =3D nil
-		end
-
-		--Mapping for Old_Spellbook package
-		if (spellbook.old) then
-			if (spellbook.itemid =3D=3D hex2num("0xffff")) then
-				-- check and get invisible spellbook container with spellbook items (s=
crolls)
-				local container =3D GetOrCreateContainer(spellbook.serial)
-				spellbook.matrix =3D Convert_Spellbookcontainer(spellbook.matrix,conta=
iner)
-				spellbook.itemid =3D MageSpellbook
-			end
-		end
-
-		--base( Core.AOS ? 0x22C5 : 0xEFA )  - if AoS take Runebook otherwise Sp=
ellbook
-		if (gSpellBooks[spellbook.itemid]) then
-			dialog.gumpid =3D gSpellBooks[spellbook.itemid].gumpid
-			dialog.spellbookserial=3Dspellbook.serial
-			gAvailSpellbooks[dialog.spellbookserial] =3D dialog
-		else
-			print("SpellbookID=3D("..spellbook.itemid..") not found (maybe old_spel=
lbook packet)!")
-		end
-	=

-		if	(dialog.gumpid) then
-			dialog.rootwidget.gfx:SetPos(gXGumppos or 200,gYGumppos or 100)
-			dialog.controls =3D {} -- associative list of controlls, key=3Dname of =
controll
-			dialog.childs =3D {} -- all controls, also those without name
-	=

-			dialog.onMouseDown =3D function (widget,mousebutton)
-	               					if (mousebutton =3D=3D 2) then dialog:Close() print("=
Destroy Spellbook!") end
-	               					if (mousebutton =3D=3D 1) then widget.dialog:BringToF=
ront() gui.StartMoveDialog(widget.dialog.rootwidget) end
-	               				end
-	        dialog.onMouseUp =3D function (widget,mousebutton)
-										gXGumppos=3Dwidget.gfx:GetDerivedLeft()
-										gYGumppos=3Dwidget.gfx:GetDerivedTop()
-	       						end
-	=

-			-- Hide all except page 0 and pagenum
-			dialog.ShowPage =3D function (dialog,pagenum)
-				local myc =3D 0
-				for k,widget in pairs(dialog.childs) do if (widget.pagenum =3D=3D page=
num) then myc =3D myc + 1 end end
-				--print("dialog.ShowPage",pagenum,myc)
-				=

-				for k,widget in pairs(dialog.childs) do =

-					widget.gfx:SetVisible((widget.pagenum =3D=3D 0) or (widget.pagenum =
=3D=3D pagenum))
-				end
-			end
-			local curparent =3D dialog.rootwidget
-	=

-			local pages =3D {}
-			dialog.pages =3D pages
-	=

-			-- Backpage 0 --------------------------------------
-			local curpage =3D guimaker.MakePage(0)
-			pages[0] =3D curpage
-	=

-			local backpane =3D MakeBorderGumpPart(curparent,dialog.gumpid,0,0)
-			backpane.mbIgnoreMouseOver =3D false
-	=

-			-- add all newly created widgets to current page
-			local myc =3D 0
-			for k,widget in pairs(dialog.childs) do =

-				if (not widget.pagenum) then
-					myc =3D myc + 1
-					widget.pagenum =3D curpage.pagenum
-					table.insert(curpage.pagewidgets,widget)
-				end
-			end
-			-- Backpage 0 End ----------------------------------
-	=

-			local rightspacer=3D0
-			local top_align=3D0
-			local pageside=3D0
-			local fix_layout=3D0
-			local pagenumber=3D1
-	=

-			local bHasNonZero =3D false
-			for k,v in pairs(spellbook.matrix) do if (tonumber(v) ~=3D 0) then bHas=
NonZero  =3D true end end
-			local circlenumber=3Dtable.getn(gSpellBooks[spellbook.itemid].circles)
-			local available_spells=3D0
-	=

-			for circle=3D1, circlenumber do
-				local spellnumber=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[ci=
rcle])
-	=

-				local page =3D pages[pagenumber]
-				if (not(page)) then
-					page =3D guimaker.MakePage(pagenumber)
-					pages[pagenumber] =3D page
-				end
-				=

-				-- Pageselektor left
-				if (page.pagenum~=3D1) then
-					local browse_back =3D MakeGumpButton (curparent, hex2num("0x8bb"), he=
x2num("0x8bb"), hex2num("0x8bb"), 48, 8,nil,nil,false)
-					browse_back.page=3Dpagenumber-1
-					browse_back.onLeftClick =3D function (widget)
-													if (widget.page > 0 and not(widget.page > table.getn(pages)) =
) then
-														widget.dialog:ShowPage(browse_back.page)
-													end
-											end
-					end				=

-				-- Pageselektor right
-				-- check if spell follows
-				if (bHasNonZero) then
-					local browse_forward =3D MakeGumpButton (curparent, hex2num("0x8bc"),=
 hex2num("0x8bc"), hex2num("0x8bc"), 322, 8,nil,nil,false)
-					browse_forward.page=3Dpagenumber+1
-					browse_forward.onLeftClick =3D function (widget)
-												if (widget.page > 0 and not(widget.page > table.getn(pages)) )=
 then
-													widget.dialog:ShowPage(browse_forward.page)
-												end
-											end
-				end
-				-- Pageselektors on bottom
-	 			for i=3D1, circlenumber/2 do
-	 				local btn_gumpid=3Dhex2num("0x8b0")+i+(circlenumber/2)*pageside
-	 				local btn_x=3D24+165*pageside+i*35
-					local pageselector =3D MakeGumpButton (curparent, btn_gumpid, btn_gum=
pid, btn_gumpid, btn_x, 175,nil,nil,false)
-					pageselector.page=3DgSpellBooks[spellbook.itemid].pages[i+(circlenumb=
er/2)*pageside]
-					pageselector.onLeftClick =3D function (widget)
-												if (widget.page > 0 and not(widget.page > table.getn(pages)) )=
 then
-													widget.dialog:ShowPage(pageselector.page)
-												end
-											end
-				end
-
-				-- Circle Names
-				local circlename =3D guimaker.MakeText (curparent, 90 + rightspacer, 2=
0,
-														gSpellBooks[spellbook.itemid].circles[circle], 14,
-														{255/255,255/255,255/255,1.0}, gFontNameDefault)
-	=

-				-- counter for available spells
-				local spellcounter=3D0
-
-				for spell=3D1, spellnumber do
-					if (TestBit(spellbook.matrix[circle], BitwiseSHL(1,spell-1))) then
-						-- increase number of available spells
-						spellcounter=3Dspellcounter+1
-						local spellbutton =3D MakeBorderGumpPart(curparent, hex2num("0x837")=
, 60 + rightspacer, 20+((spellcounter+1)*15) - top_align)
-						spellbutton.spell=3Dspell+(circle-1)*spellnumber
-						spellbutton.mbIgnoreMouseOver =3D false
-						spellbutton.onLeftClick =3D function (widget)
-													Send_Spell(spellbutton.spell+gSpellBooks[spellbook.itemid].st=
artindex,gSpellbookExpansion["AOS"])
-												end
-						local spellname =3D guimaker.MakeText (curparent, 80 + rightspacer, =
20+((spellcounter+1)*15) - top_align,
-															gSpellBooks[spellbook.itemid].spells[circle][spell], gFontG=
umpSize,
-															{190/255,237/255,231/255,1.0}, gFontNameDefault)
-					end
-			  	end
-
-				-- add all newly created widgets to current page
-				local myc =3D 0
-				for k,widget in pairs(dialog.childs) do =

-					if (not widget.pagenum) then
-						myc =3D myc + 1
-						widget.pagenum =3D page.pagenum
-						table.insert(page.pagewidgets,widget)
-					end
-				end
-				--print("ServerSideGump page ",page.pagenum," childs: ",myc)
-				if (rightspacer=3D=3D0) then rightspacer=3D150 else rightspacer=3D0 end
-				if (pageside=3D=3D0) then pageside=3D1 else pageside=3D0 end
-				if (math.mod(circle,2)=3D=3D0) then pagenumber=3Dpagenumber+1 end
-				available_spells=3Davailable_spells+spellcounter
-			end
-	=

-			pageside=3D0
-			rightspacer=3D0
-			local index_end=3Dpagenumber-1
-			=

-			-- counter for available spells
-			local spellcounter=3D0
-
-			for circle=3D1, circlenumber do
-				local spellnumber=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[ci=
rcle])
-			=

-				for spell=3D1, spellnumber do
-					if (TestBit(spellbook.matrix[circle], BitwiseSHL(1,spell-1))) then
-						-- increase number of available spells
-						spellcounter=3Dspellcounter+1
-
-						local page =3D pages[pagenumber]
-						if (not(page)) then
-							page =3D guimaker.MakePage(pagenumber)
-							pages[pagenumber] =3D page
-						end
-						-- Pageselektor left
-						if (page.pagenum~=3D1) then
-							local browse_back =3D MakeGumpButton (curparent, hex2num("0x8bb"), =
hex2num("0x8bb"), hex2num("0x8bb"), 48, 8,nil,nil,false)
-							browse_back.page=3Dpagenumber-1
-							browse_back.onLeftClick =3D function (widget)
-															if (widget.page > 0 and not(widget.page > table.getn(pages)=
) ) then
-																widget.dialog:ShowPage(browse_back.page)
-															end
-													end
-						end				=

-						-- Pageselektor right
-						-- check for last-page
-						if (spellcounter < available_spells-1) then
-							local browse_forward =3D MakeGumpButton (curparent, hex2num("0x8bc"=
), hex2num("0x8bc"), hex2num("0x8bc"), 322, 8,nil,nil,false)
-							browse_forward.page=3Dpagenumber+1
-							browse_forward.onLeftClick =3D function (widget)
-														if (widget.page > 0 and not(widget.page > table.getn(pages))=
 ) then
-															widget.dialog:ShowPage(browse_forward.page)
-														end
-													end
-						end
-		=

-						-- Calc SpellIcon GumpID
-						local spelliconid=3DgSpellBooks[spellbook.itemid].iconoffset + ((cir=
cle-1) * spellnumber) + spell-1
-						-- Circle Names
-						local circlename =3D guimaker.MakeText (curparent, 85 + rightspacer,=
 15 - top_align,
-																gSpellBooks[spellbook.itemid].circles[circle], 14,
-																{255/255,255/255,255/255,1.0}, gFontNameDefault)
-						local spellname =3D guimaker.MakeText (curparent, 85 + rightspacer, =
30 - top_align,
-																gSpellBooks[spellbook.itemid].spells[circle][spell], 14,
-																{190/255,237/255,231/255,1.0}, gFontNameDefault)
-						local spellicon =3D MakeGumpButton (curparent, spelliconid, spellico=
nid, spelliconid,
-																75 + rightspacer, 50,nil,nil,false)
-						local reagents =3D guimaker.MakeText (curparent, 75 + rightspacer, 1=
08 - top_align,
-																"Reagents:", 13,
-																{190/255,237/255,231/255,1.0}, gFontNameDefault)
-						-- Display Reagentz
-						if (gSpellBooks[spellbook.itemid].spell_reags[circle][spell]) then
-							for reag=3D1, table.getn( gSpellBooks[spellbook.itemid].spell_reags=
[circle][spell] ) do
-								local reagentname=3D gSpellBooks[spellbook.itemid].reagenz[ gSpell=
Books[spellbook.itemid].spell_reags[circle][spell][reag] ]
-								local reagentzia =3D guimaker.MakeText (curparent, 75 + rightspace=
r, 112 + reag*14 - top_align,
-																		reagentname, gFontGumpSize,
-																		{190/255,237/255,231/255,1.0}, gFontNameDefault)
-							end
-						end
-		=

-						-- add all newly created widgets to current page
-						local myc =3D 0
-						for k,widget in pairs(dialog.childs) do =

-							if (not widget.pagenum) then
-								myc =3D myc + 1
-								widget.pagenum =3D page.pagenum
-								table.insert(page.pagewidgets,widget)
-							end
-						end
-						--print("Spellbook page ",page.pagenum," childs: ",myc)
-						--print(gSpellBooks[spellbook.itemid].spells[circle][spell])
-						--print("pageside=3D"..pageside)
-						--print("pagenumber=3D"..pagenumber)
-						if (rightspacer=3D=3D0) then rightspacer=3D150 else rightspacer=3D0 =
end
-						if (pageside=3D=3D0) then pageside=3D1 else pageside=3D0 end
-						if (pageside=3D=3D0) then pagenumber=3Dpagenumber+1 end
-					end
-				end
-			end
-			dialog:ShowPage(1)
-		end
-	end
-end
-
 --[[
 Spell ID:	0x91 - 0x96 - Samurai Spells,
 			0xF5 - 0xFC - Ninja Spells,
@@ -333,7 +65,6 @@
 BushidoSpellbook		=3D hex2num("0x238C") --dialog.gumpid =3D hex2num("0x2B0=
7")
 NinjitsuSpellbook		=3D hex2num("0x23A0") --dialog.gumpid =3D hex2num("0x2B=
06")
 SpellweavingSpellbook	=3D hex2num("0x2D50")	--dialog.gumpid =3D hex2num("0=
x2B2F")
-
 --WeaponAbilityBook		=3D hex2num("0x2B02")
 =

 gSpellBooks =3D {}

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sun Mar 16 22:11:48 2008
@@ -145,7 +145,35 @@
 for k,v in pairs(gLayerType) do _G[k] =3D v end -- make names available as=
 global constants
 gLayerTypeName =3D {}
 for k,v in pairs(gLayerType) do gLayerTypeName[v] =3D k end -- make names =
available as global constants
-	=

+
+-- WARNING ! this is not a complete list (see gLayerType for that) , e.g. =
kLayer_Mound =3D 0x19 is not in here
+gLayerOrder =3D {
+	hex2num("0x09"),					   -- - N/A (not used)
+    hex2num("0x14"),                       -- - Back (Cloak)
+    hex2num("0x10"),                       -- - Facial Hair
+    hex2num("0x12"),                       -- - Earrings
+    hex2num("0x04"),                       -- - Leg Covering (including Pa=
nts"), Shorts"), Bone/Chain/Ring legs)
+    hex2num("0x0E"),                       -- - Bracelet
+    hex2num("0x03"),                       -- - Foot Covering/Armor
+    hex2num("0x08"),                       -- - Ring
+    hex2num("0x18"),                       -- - Legs (inner)(Leg Armor)
+    hex2num("0x05"),                       -- - Chest Clothing/Female Ches=
t Armor
+    hex2num("0x0D"),                       -- - Torso (inner)(Chest Armor)
+    hex2num("0x11"),                       -- - Torso (Middle)(Surcoat"), =
Tunic"), Full Apron"), Sash)
+    hex2num("0x0A"),                       -- - Neck Covering/Armor
+    hex2num("0x13"),                       -- - Arm Covering/Armor
+    hex2num("0x07"),                       -- - Hand Covering/Armor
+    hex2num("0x17"),                       -- - Legs (outer)(Skirt/Kilt)
+    hex2num("0x0B"),                       -- - Hair
+    hex2num("0x16"),                       -- - Torso (outer)(Robe)
+    hex2num("0x06"),                       -- - Head Covering/Armor
+    hex2num("0x0C"),                       -- - Waist (Half-Apron)
+    hex2num("0x01"),                       -- - Single-Hand item/weapon
+    hex2num("0x02"),                       -- - Two-Hand item/weapon (incl=
uding Shield)
+    hex2num("0x15"),                       -- - BackPack
+    hex2num("0x0F")
+}
+
 -- Tiledata Flags
 kTileDataFlag_Background		=3D hex2num("0x00000001")
 kTileDataFlag_Weapon			=3D hex2num("0x00000002") -- set for weapons AND sh=
ields (7035)

Modified: trunk/lua/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.trade.lua (original)
+++ trunk/lua/net.trade.lua Sun Mar 16 22:11:48 2008
@@ -1,48 +1,11 @@
--- trading with npcs can be triggered by typing "vendor buy" for example
--- or by choosing buy from the contextmenu of the mobile (rightclick here,=
 aos-feature, not supported by pol?)
--- see also net.other.lua (for context/popup-menu)
--- see also lib.uoids.lua for special layertypes (kLayer_NPCBuyRestock,NPC=
BuyNoRestock,NPCSellContainer)
--- see also net.container.lua for special containers =

--- see also net.securetrade.lua for secure trading between players
-
---[[
-gLayerType.kLayer_NPCBuyRestock 	=3D hex2num("0x1A") -- container	=

-gLayerType.kLayer_NPCBuyNoRestock 	=3D hex2num("0x1B") -- container	=

-gLayerType.kLayer_NPCSellContainer	=3D hex2num("0x1C")
-gLayerType.kLayer_PCBankBox 		=3D hex2num("0x1D")
-
-TODO : catch  kPacket_Open_Container  layertype
-
-PlainGuiSendChat        vendor buy
-NET: ProtocolPacketRecvHandler typeid=3D0x2e,size=3D15,typename=3DkPacket_=
Equip_Item -- kLayer_NPCBuyRestock
-NET: ProtocolPacketRecvHandler typeid=3D0x2e,size=3D15,typename=3DkPacket_=
Equip_Item -- kLayer_NPCBuyNoRestock
-NET: ProtocolPacketRecvHandler typeid=3D0x3c,size=3D404,typename=3DkPacket=
_Container_Contents
-NET: ProtocolPacketRecvHandler typeid=3D0x74,size=3D435,typename=3DkPacket=
_Shop_Data
-NET: ProtocolPacketRecvHandler typeid=3D0x3c,size=3D5,typename=3DkPacket_C=
ontainer_Contents
-NET: ProtocolPacketRecvHandler typeid=3D0x74,size=3D8,typename=3DkPacket_S=
hop_Data
-NET: ProtocolPacketRecvHandler typeid=3D0x24,size=3D7,typename=3DkPacket_O=
pen_Container
-NET: ProtocolPacketRecvHandler typeid=3D0x11,size=3D66,typename=3DkPacket_=
Mobile_Stats (gold?)
-
-
-]]--
-
-gShop =3D {}
-
-
-function CompareSerialAsc  (a,b) return a.serial < b.serial end
-function CompareSerialDesc (a,b) return a.serial > b.serial end
-
--- common initialisation for kPacket_Shop_Data(buy) and kPacket_Shop_Sell
-function ShopCommonInit (shop)
-	shop.Cancel =3D function (shop) =

-		-- TODO : send cancel message to server ?
-		shop:Close()
-	end
-	shop.Close =3D function (shop)
-		if (shop.dialog_list)	then shop.dialog_list:Destroy()	shop.dialog_list  =
=3D nil end
-		if (shop.dialog_bill)	then shop.dialog_bill:Destroy()	shop.dialog_bill =
=3D nil end
-		gShop[shop.shopContainerID or shop.shopMobileID] =3D nil
-	end
+-- helper function
+function GetShopMobileID (shop)
+	if (shop.shopMobileID) then return shop.shopMobileID end -- only set for =
sell-shop
+	local shopContainerItem =3D GetObjectBySerial(shop.shopContainerID)
+	if (not shopContainerItem) then printf("FATAL : GetShopMobileID : shopCon=
tainerItem not found %08x\n",shop.shopContainerID) return end
+	local shopmobile =3D shopContainerItem.mobile
+	if (not shopmobile) then printf("FATAL : GetShopMobileID : shopmobile not=
 found for container %08x\n",shop.shopContainerID) return end
+	return shopmobile.serial
 end
 =

 -- lists all items that the player can sell to a specific vendor
@@ -62,8 +25,6 @@
 	shop.goods =3D {}
 	ShopCommonInit(shop)
 	=

-	--AddFadeLines(sprintf("Open_SellShop id=3D0x%08x goodcount=3D%d",shop.sh=
opMobileID,shop.goodcount))
-	=

 	if (shop.goodcount > 0) then
 		local playerBackpackContainer =3D GetPlayerBackPackContainer()
 		local playerMobile =3D GetPlayerMobile()
@@ -118,8 +79,6 @@
 			local nameint =3D tonumber(good.name)
 			if (nameint and good.name =3D=3D ""..nameint) then good.name =3D gClilo=
cLoader:Get(nameint) or ("unknown_cliloc_"..nameint) end
 			shop.goods[i] =3D good
-			--local itemname =3D GetStaticTileTypeName(good.itemartid) or "unknown"
-			--AddFadeLines(sprintf("SellShop_Good %d %s %s",good.price,good.name,it=
emname))
 		end
 		=

 		OpenShopDialog(shop)
@@ -152,8 +111,6 @@
 	shop.goodcount	=3D input:PopNetUint8()
 	shop.goods =3D {}
 	ShopCommonInit(shop)
-	=

-	--AddFadeLines(sprintf("Open_Shop id=3D0x%08x",shop.shopContainerID))
 	=

 	if (shop.goodcount > 0) then
 		-- get associated container (probably on one of the special layers, kLay=
er_NPCBuyRestock or NPCBuyNoRestock)
@@ -195,8 +152,6 @@
 			local nameint =3D tonumber(good.name)
 			if (nameint and good.name =3D=3D ""..nameint) then good.name =3D gClilo=
cLoader:Get(nameint) or ("unknown_cliloc_"..nameint) end
 			shop.goods[i] =3D good
-			--local itemname =3D GetStaticTileTypeName(good.itemartid)
-			--AddFadeLines(sprintf("Shop_Good %d %s %s",good.price,good.name,itemna=
me or ""))
 		end
 		=

 		OpenShopDialog(shop)
@@ -206,7 +161,6 @@
 	end
 	RememberShop(shop)
 end
-
 =

 -- close the shopgump for buy and sellshop
 -- same messagetype also used for SendBuyAccept
@@ -215,214 +169,11 @@
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local shopMobileID =3D input:PopNetUint32()
-	printf("CLOSE SHOP %08x\n",shopMobileID)
+	printdebug("net",sprintf("kPacket_Accept_Offer (close-shop): shopMobileID=
=3D0x%08x\n",shopMobileID))
 	for k,shop in pairs(gShop) do  -- can be more than one on pol
-		--printf("shop containerid=3D%08x mobileid=3D%08x\n",shop.shopContainerI=
D,GetShopMobileID(shop))
 		if (shopMobileID =3D=3D GetShopMobileID(shop)) then shop:Close() end
 	end
 	input:PopRaw(size - (1 + 2 + 4)) -- drop the rest, usually just a byte wi=
th 0
-end
-
--- empty dummy placeholder, might be interesting to remember prices and go=
ods later =3D)
-function RememberShop (shop) end
-
--- player gold has changed, update bill window
-function TradeUpdatePlayerGold ()
-	for k,shop in pairs(gShop) do
-		if (shop.dialog_bill) then
-			shop.dialog_bill.gold.gfx:SetText(GetPlayerGold())
-		end
-	end
-end
-
--- npc trading
--- see also old iris trade.csl : net_buywindow
--- used for both buy and sell  npc-shop
-function OpenShopDialog (shop) =

-	print("Shop_Data",vardump(shop))
-	=

-	-- create shop dialog
-	local dialog_list	=3D guimaker.MakeSortedDialog()
-	local dialog_bill	=3D guimaker.MakeSortedDialog()
-	dialog_list.uoShop	=3D shop
-	dialog_bill.uoShop	=3D shop
-	shop.dialog_list	=3D dialog_list
-	shop.dialog_bill	=3D dialog_bill
-	shop.defaultOnMouseDown =3D function (widget,mousebutton)
-		if (mousebutton =3D=3D 2) then widget.dialog.uoShop:Cancel() end
-		if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMov=
eDialog(widget.dialog.rootwidget) end
-	end
-	shop.AddToBill	=3D ShopAddToBill
-	shop.Accept		=3D ShopAccept
-	dialog_list.onMouseDown	=3D shop.defaultOnMouseDown
-	dialog_bill.onMouseDown	=3D shop.defaultOnMouseDown
-	=

-	=

-	-- TODO : seperator gumpid wrong
-	-- TODO : red mark on right upper dialog side missing
-	-- TODO : total/available gold texts wrong
-	=

-	-- gui_addgump		(const x, const y, const gump, [ const flags ])
-	-- gui_addbutton	(const x, const y, [ const normal, const mouseover, cons=
t pressed ])
-	-- gui_addcontainer	(const x, const y, const width, const height)
-	-- gui_addlabel		(const x, const y, const text, [ const font, const hue ])
-	=

-	-- shop inventory
-	dialog_list.rootwidget.gfx:SetPos(150, 10)
-	local widget 		=3D MakeBorderGumpPart(	dialog_list.rootwidget,hex2num("0x=
870"),0,0)
-	local browse_up		=3D MakeGumpButton(		dialog_list.rootwidget,hex2num("0x8=
24"), hex2num("0x824"), hex2num("0x824"),231, 48)
-	local browse_down	=3D MakeGumpButton(		dialog_list.rootwidget,hex2num("0x=
825"), hex2num("0x825"), hex2num("0x825"),231, 193)
-	local separator1 	=3D MakeBorderGumpPart(	dialog_list.rootwidget,hex2num(=
"0x82B"),25, 105)
-	local separator2 	=3D MakeBorderGumpPart(	dialog_list.rootwidget,hex2num(=
"0x82B"),25, 165)
-	browse_up.onLeftClick	=3D function (widget) widget.dialog:PrevPage() end
-	browse_down.onLeftClick =3D function (widget) widget.dialog:NextPage() end
-
-	-- bill
-	dialog_bill.rootwidget.gfx:SetPos(315, 228)
-	local gump2			=3D MakeBorderGumpPart(	dialog_bill.rootwidget,hex2num("0x8=
71"),0,0)
-	local browse_up2	=3D MakeGumpButton(		dialog_bill.rootwidget,hex2num("0x8=
24"), hex2num("0x824"), hex2num("0x824"),231, 49) =

-	local browse_down2	=3D MakeGumpButton(		dialog_bill.rootwidget,hex2num("0=
x825"), hex2num("0x825"), hex2num("0x825"),231,158)
-	local accept		=3D MakeGumpButton(		dialog_bill.rootwidget,hex2num("0x5c")=
 , hex2num("0x5c") , hex2num("0x5c") , 22,188)
-	dialog_bill.total	=3D guimaker.MakeText(	dialog_bill.rootwidget, 70, 173,=
"0",gFontGumpSize,{1.0,1.0,1.0,1.0}, nil, gFontNameDefault)
-	dialog_bill.gold 	=3D guimaker.MakeText(	dialog_bill.rootwidget,190, 173,=
GetPlayerGold(),gFontGumpSize,{1.0,1.0,1.0,1.0}, nil, gFontNameDefault)
-	browse_up2.onLeftClick		=3D function (widget) widget.dialog:PrevPage() end
-	browse_down2.onLeftClick	=3D function (widget) widget.dialog:NextPage() e=
nd
-	accept.onLeftClick			=3D function (widget) widget.dialog.uoShop:Accept() =
end
-		=

-	for k,v in pairs(dialog_list.childs) do v.mbIgnoreMouseOver =3D false end
-	for k,v in pairs(dialog_bill.childs) do v.mbIgnoreMouseOver =3D false end
-	=

-	-- fill shop with items
-	-- TODO : scroll area, but this more "original" pagewise scrolling should=
 remain as option
-	dialog_list.curpagewidgets =3D {}
-	dialog_list.curpage =3D nil
-	dialog_list.RebuildCurrentPage	=3D ShopListRebuildCurrentPage
-	dialog_list.ShowPage 			=3D ShopListShowPage
-	dialog_list:ShowPage(0)
-	dialog_list.NextPage =3D function (dialog_list) dialog_list:ShowPage(dial=
og_list.curpage + 1)	end
-	dialog_list.PrevPage =3D function (dialog_list) dialog_list:ShowPage(dial=
og_list.curpage - 1) end
-	=

-	dialog_bill.curpagewidgets =3D {}
-	dialog_bill.curpage =3D nil
-	dialog_bill.RebuildCurrentPage	=3D ShopBillRebuildCurrentPage
-	dialog_bill.ShowPage 			=3D ShopBillShowPage
-	dialog_bill:ShowPage(0)
-	dialog_bill.NextPage =3D function (dialog_bill) dialog_bill:ShowPage(dial=
og_bill.curpage + 1)	end
-	dialog_bill.PrevPage =3D function (dialog_bill) dialog_bill:ShowPage(dial=
og_bill.curpage - 1) end
-end
-
-
--- build one page for shop inventor dialog
-function ShopListShowPage (dialog,pagenum)
-	local perpage	=3D 3
-	local shop		=3D dialog.uoShop
-	local goodcount	=3D shop.goodcount
-	local lastpage	=3D math.floor((goodcount-1)/perpage)
-	pagenum			=3D math.max(0,math.min(pagenum,lastpage))
-	if (dialog.curpage =3D=3D pagenum) then return end
-	for k,widget in pairs(dialog.curpagewidgets) do widget:Destroy() end
-	dialog.curpage =3D pagenum
-	dialog.curpagewidgets =3D {}
-	=

-	-- fill shop dialog with items
-	local i =3D 0
-	local pageoff =3D pagenum * perpage
-	for k,good in pairs(shop.goods) do =

-		if (i >=3D pageoff and i < pageoff + perpage) then
-			local y =3D 60 * (i - pageoff)
-			local itemmodel	=3D MakeArtGumpPart(  dialog.rootwidget,					good.itema=
rtid,25, 75 + y, 0, 0, 0, good.itemhue)
-			local it_name 	=3D guimaker.MakeText(dialog.rootwidget, 80, 75 + y,		go=
od.name				, gFontGumpSize, {1.0,1.0,1.0,1.0}, gFontNameDefault)
-			local it_price 	=3D guimaker.MakeText(dialog.rootwidget, 80, 75 + y + 1=
2,	good.price .. " Gold"	, gFontGumpSize, {1.0,1.0,1.0,1.0}, gFontNameDefau=
lt)
-			local avail 	=3D guimaker.MakeText(dialog.rootwidget,210, 75 + y,		good=
.itemamount - good.tradeamount , gFontGumpSize, {1.0,1.0,1.0,1.0}, gFontNam=
eDefault)
-			itemmodel.good =3D good
-			itemmodel.mbIgnoreMouseOver =3D false
-			itemmodel.onMouseDown =3D function (widget,mousebutton) if (mousebutton=
 =3D=3D 1) then widget.dialog.uoShop:AddToBill(widget.good,1) end end
-			=

-			table.insert(dialog.curpagewidgets,itemmodel)
-			table.insert(dialog.curpagewidgets,it_name)
-			table.insert(dialog.curpagewidgets,it_price)
-			table.insert(dialog.curpagewidgets,avail)
-		end
-		i =3D i + 1
-	end
-end
-
--- build one page for bill dialog
--- see also trade.csl handler_onartmousedown from old iris
-function ShopBillShowPage (dialog,pagenum)
-	local perpage	=3D 4
-	local shop		=3D dialog.uoShop
-	local goodcount	=3D 0
-	for k,good in pairs(shop.goods) do if (good.tradeamount > 0) then goodcou=
nt =3D goodcount + 1 end end
-	=

-	local lastpage	=3D math.floor((goodcount-1)/perpage)
-	pagenum			=3D math.max(0,math.min(pagenum,lastpage))
-	if (dialog.curpage =3D=3D pagenum) then return end
-	for k,widget in pairs(dialog.curpagewidgets) do widget:Destroy() end
-	dialog.curpage =3D pagenum
-	dialog.curpagewidgets =3D {}
-	=

-	-- fill bill with items
-	local i =3D 0
-	local pageoff =3D pagenum * perpage
-	local totalprice =3D 0
-	for k,good in pairs(shop.goods) do if (good.tradeamount > 0) then
-		totalprice =3D totalprice + good.tradeamount * good.price
-		if (i >=3D pageoff and i < pageoff + perpage) then
-			local y =3D 25 * (i - pageoff)
-					=

-			local incr		=3D MakeGumpButton(	dialog.rootwidget, hex2num("0x37"), hex=
2num("0x37"), hex2num("0x37"), 170, 65 + y) =

-			local decr		=3D MakeGumpButton(	dialog.rootwidget, hex2num("0x38"), hex=
2num("0x38"), hex2num("0x38"), 195, 65 + y) =

-			local name		=3D guimaker.MakeText(dialog.rootwidget,70, 65 + y,good.nam=
e			,gFontGumpSize, {1.0,1.0,1.0,1.0}, gFontNameDefault) =

-			local amount	=3D guimaker.MakeText(dialog.rootwidget,30, 65 + y,good.tr=
adeamount	,gFontGumpSize, {1.0,1.0,1.0,1.0}, gFontNameDefault) =

-	=

-			incr.good =3D good
-			decr.good =3D good
-			incr.onMouseDown =3D function (widget,mousebutton) if (mousebutton =3D=
=3D 1) then widget.dialog.uoShop:AddToBill(widget.good, 1) end end
-			decr.onMouseDown =3D function (widget,mousebutton) if (mousebutton =3D=
=3D 1) then widget.dialog.uoShop:AddToBill(widget.good,-1) end end
-
-			table.insert(dialog.curpagewidgets,incr)
-			table.insert(dialog.curpagewidgets,decr)
-			table.insert(dialog.curpagewidgets,name)
-			table.insert(dialog.curpagewidgets,amount)
-		end
-		i =3D i + 1
-	end end
-	=

-	-- update total price
-	dialog.total.gfx:SetText(totalprice)
-end
-
-function ShopListRebuildCurrentPage (dialog)
-	local mypage =3D dialog.curpage
-	dialog.curpage =3D nil
-	dialog:ShowPage(mypage)
-end
-
-function ShopBillRebuildCurrentPage (dialog)
-	local mypage =3D dialog.curpage
-	dialog.curpage =3D nil
-	dialog:ShowPage(mypage)
-end
-
-function ShopAddToBill (shop,good,amount)
-	amount =3D amount or 1
-	--AddFadeLines(sprintf("ShopAddToBill 0x%08x %s",good.itemserial,good.nam=
e))
-	local newamount =3D math.max(0,math.min(good.itemamount,good.tradeamount =
+ amount))
-	if (good.tradeamount ~=3D newamount) then
-		good.tradeamount =3D newamount
-		shop.dialog_bill:RebuildCurrentPage() =

-		shop.dialog_list:RebuildCurrentPage() -- adjust availcount
-	end
-end
-
-function GetShopMobileID (shop)
-	if (shop.shopMobileID) then return shop.shopMobileID end -- only set for =
sell-shop
-	local shopContainerItem =3D GetObjectBySerial(shop.shopContainerID)
-	if (not shopContainerItem) then printf("FATAL : GetShopMobileID : shopCon=
tainerItem not found %08x\n",shop.shopContainerID) return end
-	local shopmobile =3D shopContainerItem.mobile
-	if (not shopmobile) then printf("FATAL : GetShopMobileID : shopmobile not=
 found for container %08x\n",shop.shopContainerID) return end
-	return shopmobile.serial
 end
 =

 --This is sent by the client to buy items from a vendor.
@@ -433,7 +184,7 @@
 	local out =3D GetSendFIFO()
 	local numitems =3D goods and table.getn(goods) or 0
 	local shopMobileID =3D GetShopMobileID(shop)
-	printf("SendBuyAccept : numitems=3D%d shopContainerID=3D0x%08x mobileseri=
al=3D0x%08x\n",numitems,shop.shopContainerID,shopMobileID)
+	printdebug("net",sprintf("SendBuyAccept : numitems=3D%d shopContainerID=
=3D0x%08x mobileserial=3D0x%08x\n",numitems,shop.shopContainerID,shopMobile=
ID))
 	local len =3D 8 + (numitems * 7)
 	out:PushNetUint8(kPacket_Accept_Offer)
 	out:PushNetUint16(len)
@@ -447,11 +198,10 @@
 		out:PushNetUint8(kLayer_NPCBuyRestock)	-- The shop layer that the item i=
s in (usually 0x1A =3D kLayer_NPCBuyRestock).
         out:PushNetUint32(good.itemserial)	-- object serial form buy conta=
iner
         out:PushNetUint16(good.tradeamount)	-- amount
-		print("item",sprintf("0x%08x",good.itemserial),good.tradeamount)
+		printdebug("net",sprintf("item : itemserial=3D0x%08x tradeamount=3D0x%04=
x\n",good.itemserial,good.tradeamount))
 	end	end
 	out:SendPacket()
 end
-
 =

 -- send to finish the npc-sell shop
 -- similar to SendBuyAccept, but there are a few differences
@@ -459,7 +209,7 @@
 	local out =3D GetSendFIFO()
 	local numitems =3D goods and table.getn(goods) or 0
 	local shopMobileID =3D GetShopMobileID(shop)
-	printf("SendSellAccept : numitems=3D%d mobileserial=3D0x%08x\n",numitems,=
shopMobileID)
+	printdebug("net",sprintf("SendSellAccept : numitems=3D%d mobileserial=3D0=
x%08x\n",numitems,shopMobileID))
 	local len =3D 9 + (numitems * 6)
 	out:PushNetUint8(kPacket_Shop_Offer)
 	out:PushNetUint16(len)
@@ -468,24 +218,17 @@
 	if (goods) then for k,good in pairs(goods) do
         out:PushNetUint32(good.itemserial)	-- object serial
         out:PushNetUint16(good.tradeamount)	-- amount
-		print("item",sprintf("0x%08x",good.itemserial),good.tradeamount)
+		printdebug("net",sprintf("item : itemserial=3D0x%08x tradeamount=3D0x%04=
x\n",good.itemserial,good.tradeamount))
 	end	end
 	out:SendPacket()
 end
 =

-function ShopAccept (shop)
-	local goods =3D {}
-	for k,good in pairs(shop.goods) do if (good.tradeamount > 0) then
-		table.insert(goods,good)
-	end end
-	=

-	if (shop.isSellShop) then
-		SendSellAccept(shop,goods)
-	else
-		SendBuyAccept(shop,goods)
-	end
-end
-
+-- trading with npcs can be triggered by typing "vendor buy" for example
+-- or by choosing buy from the contextmenu of the mobile (rightclick here,=
 aos-feature, not supported by pol?)
+-- see also net.other.lua (for context/popup-menu)
+-- see also lib.uoids.lua for special layertypes (kLayer_NPCBuyRestock,NPC=
BuyNoRestock,NPCSellContainer)
+-- see also net.container.lua for special containers =

+-- see also net.securetrade.lua for secure trading between players
 =

 --[[ strange things :
 	-- strange thing from runuo : base( 0x74 ) kPacket_Shop_Data :  m_Stream.=
Write( (int)(BuyPack =3D=3D null ? Serial.MinusOne : BuyPack.Serial) );
@@ -516,6 +259,3 @@
 			}
 		}
 ]]--
-
-
-

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sun Mar 16 22:11:48 2008
@@ -117,7 +117,7 @@
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local subcmd =3D input:PopNetUint16()
---	printf("NET: Generic_Command id: 0x%02x size: %i subcmd: %i\n",id,size,=
subcmd)
+	printdebug("net",sprintf("NET: kPacket_Generic_Command size=3D0x%04x subc=
md=3D0x%04x\n",size,subcmd))
 =

 	-- FastWalkInit : 6 keys (runuo's fifosize 0-255)
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_FastWalkInit) then -- 0x01
@@ -137,8 +137,9 @@
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_CloseGenericGump) then -- 0x=
04
 		local dialogId =3D input:PopNetUint32()
 		local buttonId =3D input:PopNetUint32()
-		CloseServerSideGump(dialogId,buttonId)
-		--print("NET: 0xbf sub=3D0x04 Close Gump - Servermessage")
+		local playermobile =3D GetPlayerMobile()
+		CloseServerSideGump(playermobile.serial,dialogId,buttonId)
+		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_CloseGenericGu=
mp (0xbf sub=3D0x04)"))
 	end
 =

 	-- Party System
@@ -255,7 +256,8 @@
 		spellbook.matrix[6] =3D input:PopNetUint8()
 		spellbook.matrix[7] =3D input:PopNetUint8()
 		spellbook.matrix[8] =3D input:PopNetUint8()
-		printf("NET: New_Spellbook: serial=3D0x%08x itemId=3D0x%04x offset=3D0x%=
04x\n",spellbook.serial, spellbook.itemid, spellbook.scrolloffset)
+		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_NewSpellbook s=
erial=3D0x%08x itemId=3D0x%04x offset=3D0x%04x\n",
+								spellbook.serial, spellbook.itemid, spellbook.scrolloffset))
 		Open_Spellbook(spellbook)
 	end
 =

@@ -263,6 +265,8 @@
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_RevisionCustomHouse) then	--=
 0x1D
 		local customhouseserial =3D input:PopNetUint32()
 		local customhouserevision =3D input:PopNetUint32()
+		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_RevisionCustom=
House customhouseserial=3D0x%08x customhouserevision=3D0x%08x\n",
+								customhouseserial, customhouserevision))
 =

 		local dyn =3D GetDynamic(customhouseserial)
 		-- check if houserevision exists
@@ -271,11 +275,11 @@
 				-- compare new_houserevisiont with old_houserevision, if different cha=
nge to new
 				if (customhouserevision~=3Ddyn.customhouserevision) then
 					Send_CustomHouseRevision(customhouseserial)
-					print("CH: Old Custom House Revision request New")
+					printdebug("net",sprintf("NET: old-customhouse -> request new revisio=
n\n"))
 				end
 			else
 				Send_CustomHouseRevision(customhouseserial)
-				print("CH: Old Custom House Revision request New")
+				printdebug("net",sprintf("NET: old-customhouse -> request new revision=
\n"))
 			end
 		end
 	end



From no-reply at zwischenwelt.org  Sun Mar 16 23:48:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Mar 2008 22:48:36 -0000
Subject: [Iris-commit] [IRIS] r1966 - in /trunk/lua/gui: gui.container.lua
 gui.main.lua gui.pagedialog.lua gui.widget.lua
Message-ID: <20080316224840.DCFD6152402A@zwischenwelt.org>

Author: sience
Date: Sun Mar 16 23:48:35 2008
New Revision: 1966

Log:
-obsolete files deleted
-gui.widget.lua moved to archive

Removed:
    trunk/lua/gui/gui.container.lua
    trunk/lua/gui/gui.pagedialog.lua
    trunk/lua/gui/gui.widget.lua
Modified:
    trunk/lua/gui/gui.main.lua

Modified: trunk/lua/gui/gui.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.main.lua (original)
+++ trunk/lua/gui/gui.main.lua Sun Mar 16 23:48:35 2008
@@ -1,8 +1,3 @@
--- TODO
---dofile(libpath .. "gui/gui.widget.lua")
---dofile(libpath .. "gui/gui.container.lua")
---dofile(libpath .. "gui/gui.pagedialog.lua")
-
 dofile(libpath .. "gui/gui.helper.lua")
 dofile(libpath .. "gui/gui.gumpparser.lua")
 dofile(libpath .. "gui/gui.paperdoll.lua")



From no-reply at zwischenwelt.org  Mon Mar 17 00:10:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Mar 2008 23:10:34 -0000
Subject: [Iris-commit] [IRIS] r1967 - in /trunk/lua: lib.unifont.lua main.lua
Message-ID: <20080317000012.98567152402A@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Mar 17 00:10:32 2008
New Revision: 1967

Log:
started transforming glyphlist to floatlayout

Modified:
    trunk/lua/lib.unifont.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Mon Mar 17 00:10:32 2008
@@ -1,8 +1,8 @@
 -- handles uo unicode fonts textureatlas =

+-- see also lugre/lib.gui.flow.lua
 =

 gUniFontTexAtlasSize =3D 512
 gUniFontLastTextureAtlas =3D nil
-kTabLen =3D 4
 =

 --~ gUniFontLoaderList[0] =3D unifont.mul
 --~ gUniFontLoaderList[i] =3D unifont(1-6).mul
@@ -84,46 +84,8 @@
 	return unpack(glyphdata)
 end
 =

-kCharCode_Space				=3D string.byte(" ",1)
-kCharCode_Tab				=3D string.byte("\t",1)
-kCharCode_Nl				=3D string.byte("\n",1) -- newline
-kCharCode_Cr				=3D string.byte("\r",1) -- carriage return
-kCharCode_SpaceWidthChar	=3D string.byte("0",1) -- this charcode is used t=
o determine the width of "space"
 =

-
--- call after ogre init
-function CreateFontObject_Ogre (sFontName)
-	local sMatName,tGlyphTable =3D ExportOgreFont(sFontName)
-	local myfont =3D {}
-	myfont.sMatName		=3D sMatName
-	myfont.sTexName		=3D GetTexture(myfont.sMatName)
-	myfont.tGlyphTable	=3D tGlyphTable
-	myfont.zeroglyph	=3D myfont.tGlyphTable[kCharCode_SpaceWidthChar]
-	myfont.tSpaceAspect	=3D myfont.zeroglyph and myfont.zeroglyph.aspectRatio=
 or 1
-	=

-	myfont.GetDefaultFontSize	=3D function (self) return 24 end
-	myfont.GetSpaceWidth		=3D function (self,iFontSize) return self.tSpaceAsp=
ect * iFontSize end
-	myfont.GetLineHeight		=3D function (self,iFontSize) return iFontSize end
-	myfont.GetGlyph				=3D function (self,iCharCode,iFontSize) =

-		local glyph =3D self.tGlyphTable[iCharCode]
-		if (not glyph) then return end
-		local u0	=3D glyph.left
-		local v0	=3D glyph.top
-		local uvw	=3D glyph.right-u0
-		local uvh 	=3D glyph.bottom-v0
-		local h		=3D iFontSize
-		local w		=3D h * glyph.aspectRatio
-		local xoff =3D 0
-		local yoff =3D 0
-		local xmove =3D w
-		local texname =3D myfont.sTexName
-		--~ print("CreateFontObject_Ogre:GetGlyph:",self,iCharCode,iFontSize,tex=
name, xmove, xoff,yoff,w,h, u0,v0, uvw,0, 0,uvh)
-		return texname, xmove, xoff,yoff,w,h, u0,v0, uvw,0, 0,uvh
-	end
-	return myfont
-end
-
-function CreateFontObject_UO (loader)
+function CreateFont_UO (loader)
 	local myfont =3D {}
 	local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(loader,kCharC=
ode_SpaceWidthChar)
 	myfont.spacewidth =3D w
@@ -145,183 +107,4 @@
 	return myfont
 end
 =

--- flowlayout =3D glyphlist + widgets as glyphs ?
--- glyphlist is derived from rendergroup2d
-function CreateGlyphList (parentgroup2d)
-	local glyphlist =3D CreateRenderGroup2D(parentgroup2d)
-	glyphlist.spritelists	=3D {}
-	glyphlist.glyphs		=3D {}
-	ArrayOverwrite(glyphlist,gGlyphListPrototype)
-	return glyphlist
-end
 =

-
-gGlyphListPrototype =3D {}
-
--- r,g,b,a defaults to white
--- iFontSize defaults to font-default
-function gGlyphListPrototype:AddFontText (fontobj,text,r,g,b,a,iFontSize)
-	local textlen =3D string.len(text)
-	for i=3D1,textlen do self:AddFontGlyph(fontobj,string.byte(text,i),r,g,b,=
a,iFontSize) end
-end
-
--- fontobj : see CreateFontObject_Ogre()
--- r,g,b,a defaults to white
--- iFontSize defaults to font-default
-function gGlyphListPrototype:AddFontGlyph (fontobj,iCharCode,r,g,b,a,iFont=
Size)
-	iFontSize =3D iFontSize or fontobj:GetDefaultFontSize()
-	if (iCharCode =3D=3D kCharCode_Space	) then self:AddSpace(	fontobj:GetSpa=
ceWidth(iFontSize),fontobj:GetLineHeight(iFontSize)) return end
-	if (iCharCode =3D=3D kCharCode_Tab		) then self:AddTab(		fontobj:GetSpace=
Width(iFontSize),fontobj:GetLineHeight(iFontSize)) return end
-	if (iCharCode =3D=3D kCharCode_Nl		) then self:AddNewLine(	fontobj:GetLin=
eHeight(iFontSize)) return end
-	if (iCharCode =3D=3D kCharCode_Cr		) then return end -- ignore
-	local			texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy =3D fontobj:Ge=
tGlyph(iCharCode,iFontSize)
-	if (not texname) then return end -- todo : placeholder glyph defined by f=
ontobj ??
-	self:AddGlyph(	texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy, r,g,b,=
a)
-end
-
-function gGlyphListPrototype:Clear		() self.glyphs =3D {} end
-function gGlyphListPrototype:AddNewLine	(lineh)			table.insert(self.glyphs=
,{kCharCode_Nl		,lineh}) end
-function gGlyphListPrototype:AddSpace	(spacew,lineh)	table.insert(self.gly=
phs,{kCharCode_Space	,spacew,lineh or 0}) end
-function gGlyphListPrototype:AddTab		(spacew,lineh)	table.insert(self.glyp=
hs,{kCharCode_Tab		,spacew,lineh or 0}) end
-function gGlyphListPrototype:AddGlyph	(texname, xmove, xoff,yoff,w,h, u0,v=
0, ux,vx, uy,vy, r,g,b,a)
-	table.insert(self.glyphs,			{texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx,=
 uy,vy, r or 1,g or 1,b or 1,a or 0.5})
-end
-function gGlyphListPrototype:AddIcon	(texname, w,h, yoff, u0,v0, u1,v1, r,=
g,b,a) self:AddGlyph(texname,w,0,yoff,w,h,u0,v0, u1-u0,0, 0,v1-v0, r,g,b,a)=
 end
-
-function gGlyphListPrototype:ClearSpriteLists ()
-	for k,spritelist in pairs(self.spritelists) do spritelist:Destroy() end
-	self.spritelists =3D {}
-end
-
-function gGlyphListPrototype:UpdateGeometry	()
-	-- release old spritelists
-	self:ClearSpriteLists()
-	=

-	-- prepare loopvars
-	local last_texname =3D nil
-	local last_spritelist =3D nil
-	local x,y =3D 0,0
-	local z =3D 0
-	local iSpriteIndex =3D 0
-
-	-- iterate over glyphs
-	local glyphcount =3D table.getn(self.glyphs)
-	for i=3D1,glyphcount do
-		local glyph =3D self.glyphs[i]
-		if (glyph[1] =3D=3D kCharCode_Space) then -- space
-			local code,spacew,lineh =3D unpack(glyph)
-			x =3D x + spacew
-		elseif (glyph[1] =3D=3D kCharCode_Tab) then -- tab
-			local code,spacew,lineh =3D unpack(glyph)
-			local tabmaxw =3D kTabLen * spacew
-			x =3D math.ceil((x + spacew)/tabmaxw) * tabmaxw
-		elseif (glyph[1] =3D=3D kCharCode_Nl) then -- newline
-			local code,lineh =3D unpack(glyph)
-			x =3D 0
-			y =3D y + lineh
-		else -- printable char
-			local texname, xmove, xoff,yoff,w,h, u0,v0, ux,vx, uy,vy, r,g,b,a =3D u=
npack(glyph)
-			if (last_texname ~=3D texname) then
-				-- determine how many glyphs until texname-change
-				local len =3D 0 =

-				for j=3Di,glyphcount do =

-					local glyph =3D self.glyphs[j]
-					if (	glyph[1] =3D=3D kCharCode_Space) then =

-					elseif (glyph[1] =3D=3D kCharCode_Tab) then =

-					elseif (glyph[1] =3D=3D kCharCode_Nl) then =

-					else
-						if (glyph[1] ~=3D texname) then break end
-						len =3D len + 1
-					end
-				end
-				=

-				-- close last spritelist
-				if (last_spritelist) then SpriteList_Close() end
-				=

-				-- start new spritelist
-				last_texname =3D texname
-				local parent =3D self -- glyphlist is derived from rendergroup2d
-				last_spritelist =3D CreateSpriteList(parent,false,true) =

-				last_spritelist.asgroup =3D last_spritelist:CastToRenderGroup2D()
-				last_spritelist:SetTexture(texname)
-				last_spritelist:ResizeList(len)
-				SpriteList_Open(last_spritelist)
-				iSpriteIndex =3D 0
-			end
-			=

-			-- add the sprite to the list
-			SpriteList_SetSpriteEx(iSpriteIndex, xoff+x,yoff+y,w,h, u0,v0, ux,vx, u=
y,vy, z, r,g,b,a)
-			x =3D x + xmove
-			iSpriteIndex =3D iSpriteIndex + 1
-		end
-		=

-	end
-	=

-	-- close spritelist
-	if (last_spritelist) then SpriteList_Close() end
-end
-
-function UniFontTest ()
-	ToggleLogo()
-	ToggleLogo()
-	--~ gTestNoIrisLogo =3D true
-	=

-	--~ if (true) then return end
-	gRenderMan2D =3D CreateRenderManager2D()
-	gRenderMan2D_Dialogs =3D CreateRenderGroup2D(gRenderMan2D)
-	local glyphlist =3D CreateGlyphList(gRenderMan2D_Dialogs)
-	=

-	=

-	=

-	local myfont_ogre	=3D CreateFontObject_Ogre("TrebuchetMSBold") -- ogre fo=
nt
-	local myfont_uo0	=3D CreateFontObject_UO(gUniFontLoaderList[0]) -- 0=3Dme=
dieval =

-	local myfont_uo3	=3D CreateFontObject_UO(gUniFontLoaderList[3]) -- 3=3Dde=
fault-chat
-	=

-	--~ local mytext =3D "Hallo, test 0123\nBlablubblub\nUnicode:=C3=A4=C3=B6=
=C3=BC=C3=9F=C3=84=C3=96=C3=9C(german)\nTab\t1\tTabtest\nt\t1\n\t1\n\t\t2\n=
\t\t\t3\nFont1"
-	local mytext =3D "Hello, test 0123\nUnicode:=C3=A4=C3=B6=C3=BC=C3=9F=C3=
=84=C3=96=C3=9C(german)\nFont1"
-	-- glyphlist:AddFontText(fontobj,text,r,g,b,a,iFontSize)
-	glyphlist:AddFontText(myfont_uo0,mytext)
-	glyphlist:AddFontText(myfont_ogre,",font2")
-	glyphlist:AddFontText(myfont_uo3,",font3\n")
-	=

-	local funchars =3D "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1=
234567890"
-	for y=3D0,0 do
-		for i=3D0,20 do
-			local cpos =3D math.random(string.len(funchars))
-			local c =3D string.sub(funchars,cpos,cpos)
-			local r,g,b,a =3D math.random(),math.random(),math.random(),1
-			local r =3D math.random()
-			local font =3D myfont_uo0
-			if (math.random() < 0.5) then font =3D myfont_uo0 end
-			--~ if (math.random() < 0.3) then font =3D myfont_ogre end
-			glyphlist:AddFontText(font,c,r,g,b,a)
-		end
-		glyphlist:AddFontText(myfont_uo3,"\n")
-	end
-	glyphlist:AddFontText(myfont_uo0,"Fonts ")
-	glyphlist:AddFontText(myfont_uo3,"and ")
-	glyphlist:AddFontText(myfont_uo3,"C", 1,0,0)
-	glyphlist:AddFontText(myfont_uo3,"o", 0,0,1)
-	glyphlist:AddFontText(myfont_uo3,"l", 0,1,1)
-	glyphlist:AddFontText(myfont_uo3,"o", 0,1,0)
-	glyphlist:AddFontText(myfont_uo3,"r", 1,0,1)
-	glyphlist:AddFontText(myfont_uo3,"s", 1,1,0)
-	glyphlist:AddFontText(myfont_uo3," can be")
-	glyphlist:AddFontText(myfont_uo0," mixed\n")
-	=

-	glyphlist:AddFontText(myfont_uo3,"you can include images ")
-	--~ glyphlist:AddSpace(2)
-	--~ glyphlist:AddIcon("art_fallback.png",	18,18, 0, 0,0, 1,1)
-	local e =3D 1/8
-	glyphlist:AddIcon("compassframe_zoomin.png", 24,24, -2, e,e, 1-e,1-e)
-	glyphlist:AddFontText(myfont_uo0,"12",0,1,0)
-	glyphlist:AddFontText(myfont_uo3,",\nand even color them ")
-	=

-	local texname, w,h, u0,v0, u1,v1, r,g,b,a =3D "guibase.png", 16,16, 0,0.5=
, 0.5,1
-	glyphlist:AddIcon(texname, w,h, 2, u0,v0, u1,v1, 1,1,1,1) glyphlist:AddSp=
ace(4)
-	glyphlist:AddIcon(texname, w,h, 2, u0,v0, u1,v1, 1,0,0,1) glyphlist:AddSp=
ace(4)
-	glyphlist:AddIcon(texname, w,h, 2, u0,v0, u1,v1, 0,1,0,1)
-	glyphlist:AddFontText(myfont_uo3," =3D)")
-	glyphlist:UpdateGeometry()
-end
-

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Mar 17 00:10:32 2008
@@ -316,7 +316,7 @@
 =

 	StartMainMenu()
 	=

-	if (false) then UniFontTest() end
+	if (true) then UniFontTest() end
 =

 	-- mainloop
 	while (Client_IsAlive()) do =




From no-reply at zwischenwelt.org  Mon Mar 17 19:47:05 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 17 Mar 2008 18:47:05 -0000
Subject: [Iris-commit] [IRIS] r1968 - in /trunk/lua: lib.unifont.lua main.lua
Message-ID: <20080317184705.31E96152402A@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Mar 17 19:47:04 2008
New Revision: 1968

Log:
added a few code comments

Modified:
    trunk/lua/lib.unifont.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Mon Mar 17 19:47:04 2008
@@ -49,17 +49,24 @@
 function UniFont_AddImageToAtlas (glyphimg)
 	local w =3D gUniFontTexAtlasSize
 	if (gUniFontLastTextureAtlas =3D=3D nil) then gUniFontLastTextureAtlas =
=3D CreateTexAtlas(w,w) end -- only first time
+	=

+	-- add to exisiting texatlas or start a new one if it doesn't fit
 	local bSuccess,l,r,t,b =3D gUniFontLastTextureAtlas:AddImage(glyphimg)
 	if (not bSuccess) then =

+		-- not more space in the old atlas, start a new one
 		gUniFontLastTextureAtlas =3D CreateTexAtlas(w,w)
 		bSuccess,l,r,t,b =3D gUniFontLastTextureAtlas:AddImage(glyphimg)
 		if (not bSuccess) then print("warning, glyph too big for texatlas") retu=
rn end
 	end
+	=

+	-- create or update texatlas
 	if (gUniFontLastTextureAtlas.texname) then =

 		gUniFontLastTextureAtlas:LoadToTexture(gUniFontLastTextureAtlas.texname)=
 -- update existing texture
 	else
 		gUniFontLastTextureAtlas.texname =3D gUniFontLastTextureAtlas:MakeTextur=
e() -- generate new texture
 	end
+	=

+	-- return info about the allocated area for this glyph
 	return gUniFontLastTextureAtlas.texname,l,t,r,b
 end
 =

@@ -69,6 +76,8 @@
 	local glyphdata =3D fontloader.glyphs[iCharCode]
 	if (glyphdata) then return unpack(glyphdata) end
 	if (glyphdata =3D=3D false) then return false end -- not loadable, don't =
retry
+	=

+	-- load glyph, add to texatlas
 	glyphdata =3D false
 	local img =3D CreateImage()
 	local success =3D fontloader:WriteGlyphToImage(img,iCharCode)
@@ -79,12 +88,14 @@
 	end
 	img:Destroy()
 	=

+	-- register in cache
 	fontloader.glyphs[iCharCode] =3D glyphdata
 	if (not glyphdata) then return end
 	return unpack(glyphdata)
 end
 =

-
+-- creates and returns a font object for one of the uo fonts that can be u=
sed by the flow layouter to create text
+-- uofonts are pixelart and not scalable, so the size is fixed
 function CreateFont_UO (loader)
 	local myfont =3D {}
 	local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(loader,kCharC=
ode_SpaceWidthChar)
@@ -92,12 +103,13 @@
 	--~ myfont.defaultlineh =3D 1.5 * math.max(1,h)
 	myfont.defaultlineh =3D 20
 	myfont.GetDefaultFontSize	=3D function (self) return myfont.defaultlineh =
end
-	myfont.GetSpaceWidth		=3D function (self,iFontSize) return self.spacewidt=
h end
-	myfont.GetLineHeight		=3D function (self,iFontSize) return self.defaultli=
neh end
-	myfont.GetGlyph				=3D function (self,iCharCode,iFontSize) =

+	myfont.GetSpaceWidth		=3D function (self,fontsize) return self.spacewidth=
 end
+	myfont.GetLineHeight		=3D function (self,fontsize) return self.defaultlin=
eh end
+	myfont.GetGlyph				=3D function (self,iCharCode,fontsize) =

 		local texname,u0,v0,u1,v1,xoff,yoff,w,h =3D GetUniFontGlyph(loader,iChar=
Code)
 		if (not texname) then return end
-		local s =3D math.max(1,round(iFontSize / myfont.defaultlineh))
+		--~ local s =3D math.max(1,round(fontsize / myfont.defaultlineh)) -- pix=
elart is not freely scalable, but this would allow integer-multiples of the=
 original size
+		local s =3D 1
 		local b =3D 2 -- border, the glyph image is actually bigger than the w,h=
 returned by GetUniFontGlyph
 		w,h =3D (b+w+b)*s,(b+h+b)*s
 		local uvw, uvh =3D u1-u0,v1-v0

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Mar 17 19:47:04 2008
@@ -316,7 +316,7 @@
 =

 	StartMainMenu()
 	=

-	if (true) then UniFontTest() end
+	if (gCommandLineSwitches["-fonttest"]) then FontTest() end
 =

 	-- mainloop
 	while (Client_IsAlive()) do =




From no-reply at zwischenwelt.org  Mon Mar 17 20:23:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 17 Mar 2008 19:23:28 -0000
Subject: [Iris-commit] [IRIS] r1969 - in /trunk/lua:
 filter/filter.granny.lua gui/gui.gumpmaker.lua gui/gui.main.lua
 lib.bodygfx.lua lib.debugmenu.lua lib.gfm.lua lib.granny.lua main.lua
Message-ID: <20080317200011.7818E152402A@zwischenwelt.org>

Author: sience
Date: Mon Mar 17 20:23:28 2008
New Revision: 1969

Log:
-custom monster/animals are working more easily
-lib.gfm.lua moved to gui.gumpmaker.lua

Added:
    trunk/lua/gui/gui.gumpmaker.lua
Removed:
    trunk/lua/lib.gfm.lua
Modified:
    trunk/lua/filter/filter.granny.lua
    trunk/lua/gui/gui.main.lua
    trunk/lua/lib.bodygfx.lua
    trunk/lua/lib.debugmenu.lua
    trunk/lua/lib.granny.lua
    trunk/lua/main.lua

Modified: trunk/lua/filter/filter.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.granny.lua (original)
+++ trunk/lua/filter/filter.granny.lua Mon Mar 17 20:23:28 2008
@@ -6,9 +6,10 @@
 -- FILTER: Grannys
 function GrannyOverride(bodyid)
 	if (gGrannyFilter[bodyid]) then
-		if (gGrannyFilter[bodyid].grannyid) then
-			printdebug("granny","Override: GrannyID to new GrannyID ",bodyid," -> "=
,gGrannyFilter[bodyid].grannyid)
-			return gGrannyFilter[bodyid].grannyid
+		local grannyid =3D gGrannyFilter[bodyid].grannyid
+		if (grannyid) then
+			printdebug("granny","Override: GrannyID to new GrannyID ",bodyid," -> "=
,grannyid)
+			return grannyid
 		end
 	end
 	return bodyid
@@ -16,27 +17,18 @@
 =

 function GrannyMeshOverride(bodyid)
 	if (gGrannyFilter[bodyid]) then
-		if (gGrannyFilter[bodyid].meshname) then
-			printdebug("granny","OverrideMesh: GrannyID to Mesh ",bodyid," -> ",gGr=
annyFilter[bodyid].meshname)
-			return gGrannyFilter[bodyid].meshname
-		end
-	end
-	return nil
-end
-
-function GrannySkeletonOverride(bodyid)
-	if (gGrannyFilter[bodyid]) then
-		if (gGrannyFilter[bodyid].skeleton) then
-			printdebug("granny","OverrideSkeleton: GrannyID to Skeleton ",bodyid," =
-> ",gGrannyFilter[bodyid].skeleton)
-			return gGrannyFilter[bodyid].skeleton
+		local meshname =3D gGrannyFilter[bodyid].meshname
+		if (meshname) then
+			printdebug("granny","OverrideMesh: GrannyID to Mesh ",bodyid," -> ",mes=
hname)
+			return meshname
 		end
 	end
 	return nil
 end
 =

 -- custom models can be applyed instead to grannys, just tell the meshname
---gGrannyFilter[220]	=3D{meshname=3D"Lich.mesh"}
---gGrannyFilter[207]	=3D{meshname=3D"mummy.mesh"}
+--gGrannyFilter[153]	=3D{meshname=3D"Lich.mesh"}
+--gGrannyFilter[154]	=3D{meshname=3D"mummy.mesh"}
 =

 gGrannyFilter[987]	=3D{grannyid=3D400}
 gGrannyFilter[1987]	=3D{grannyid=3D401}

Modified: trunk/lua/gui/gui.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.main.lua (original)
+++ trunk/lua/gui/gui.main.lua Mon Mar 17 20:23:28 2008
@@ -1,5 +1,7 @@
 dofile(libpath .. "gui/gui.helper.lua")
 dofile(libpath .. "gui/gui.gumpparser.lua")
+dofile(libpath .. "gui/gui.gumpmaker.lua")
+
 dofile(libpath .. "gui/gui.paperdoll.lua")
 dofile(libpath .. "gui/gui.journal.lua")
 dofile(libpath .. "gui/gui.quit.lua")

Modified: trunk/lua/lib.bodygfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bodygfx.lua (original)
+++ trunk/lua/lib.bodygfx.lua Mon Mar 17 20:23:28 2008
@@ -142,16 +142,19 @@
 	if (not gGrannyLoaderType) then return end
 	if (not gAnimInfoLists) then return end
 	if (self.artid =3D=3D 0 and (not self.bodyid)) then return end
-	=

-	=

-	=

-		 =

+	 =

 	-- create body parts
 	local bodyid =3D self:GetBodyID()
-	local modelidarr,iPrimaryHandItem,iSecondaryHandItem =3D self:GetModelPar=
tModelIDs()
 	self.modelparts =3D {}
-	CreateBodyGfxPartsFromModelIDArray(bodyid,self.groupgfx,self.modelparts,m=
odelidarr,iPrimaryHandItem,iSecondaryHandItem)
-	=

+	=

+	local meshname =3D GrannyMeshOverride(bodyid)
+	if meshname then
+		CreateBodyFromMesh (meshname,self.groupgfx,self.modelparts)
+	else
+		local modelidarr,iPrimaryHandItem,iSecondaryHandItem =3D self:GetModelPa=
rtModelIDs()
+		CreateBodyGfxPartsFromModelIDArray(bodyid,self.groupgfx,self.modelparts,=
modelidarr,iPrimaryHandItem,iSecondaryHandItem)
+	end
+
 	-- create mount gfx (todo : replace by CreateBodyGfx or update bodygfx fo=
r mount)
 	local mount =3D self:GetEquipmentAtLayer(kLayer_Mount)
 	if (mount) then
@@ -254,8 +257,19 @@
 =

 -- ##### ##### ##### ##### ##### generating gfx
 =

-
-
+-- helper function for CreateBodyFromMesh
+function MakeBodyGfx	(meshname,partgfx,forcescalex,forcescaley,forcescalez)
+	partgfx:SetMesh(meshname)
+	partgfx:SetCastShadows(gMobileCastShadows)
+	return partgfx
+end
+-- Add Custom Mobile Meshes
+function CreateBodyFromMesh (meshname,parentgfx,partsarr)
+	local partgfx =3D MakeBodyGfx(meshname,parentgfx:CreateChild(),1,1,1)
+	table.insert(partsarr,partgfx)
+end
+
+-- helper function for CreateBodyGfxPartsFromModelIDArray
 function MakeBodyPartGfx	(modelid,meshname,partgfx,forcescalex,forcescaley=
,forcescalez)
 	partgfx:SetMesh(meshname)
 	partgfx:SetCastShadows(gMobileCastShadows)	=

@@ -273,19 +287,12 @@
 	return partgfx
 end
 =

-
+-- Add Granny Mobiles
 -- creates childnodes of parentgfx and adds inserts them into the partsarr=
 table
 function CreateBodyGfxPartsFromModelIDArray (bodyid,parentgfx,partsarr,mod=
elidarr,iPrimaryHandItem,iSecondaryHandItem)
-	--~ print("CreateBodyGfxPartsFromModelIDArray",iPrimaryHandItem,iPrimaryH=
andItem and iPrimaryHandItem.modelid,iSecondaryHandItem,iSecondaryHandItem =
and iSecondaryHandItem.modelid)
 	if (not gGrannyLoaderType) then return end
-	local override_meshname =3D GrannyMeshOverride(bodyid)
-	local skeleton_name
-	if (override_meshname) then =

-		skeleton_name =3D "character_override_skeleton" -- should not be used, o=
verride models don't support equipment yet
-	else
-		local skeleton =3D (not override_meshname) and GetOrCreateSkeleton(bodyi=
d) -- skeleton is determined by the bodyid, not possible from the wearables
-		skeleton_name =3D skeleton.name
-	end
+	local skeleton =3D GetOrCreateSkeleton(bodyid) -- skeleton is determined =
by the bodyid, not possible from the wearables
+	local skeleton_name =3D skeleton.name
 	printdebug("granny","CreateBodyGfxPartsFromModelIDArray...",bodyid,bodyid=
,skeleton_name)
 	local leftHandEntity1
 	local leftHandEntity2
@@ -308,7 +315,7 @@
 		local modelid =3D element.modelid
 		if (modelid ~=3D (iPrimaryHandItem and iPrimaryHandItem.modelid) and mod=
elid ~=3D (iSecondaryHandItem and iSecondaryHandItem.modelid)) then
 			-- HasBone
-			local meshname =3D override_meshname or GetGrannyMeshName(modelid,skele=
ton_name,element.hue or 0)
+			local meshname =3D GetGrannyMeshName(modelid,skeleton_name,element.hue =
or 0)
 			if (meshname) then =

 				local partgfx =3D MakeBodyPartGfx(modelid,meshname,parentgfx:CreateChi=
ld(),fsx,fsy,fsz)
 				handname =3D "cp_grasp_rhand"	if (partgfx:HasBone(handname)) then righ=
tHandEntity1 =3D partgfx rightHandBoneName1 =3D handname end

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Mon Mar 17 20:23:28 2008
@@ -45,6 +45,9 @@
 	{artid=3D400, content=3D{}},
 	{artid=3D400, content=3D({{artid=3D5905,animid=3D476},{artid=3D5422,animi=
d=3D430},{artid=3D7933,animid=3D435},{artid=3D5909,animid=3D406},{artid=3D5=
441,animid=3D490},{artid=3D3701,animid=3D422},{artid=3D8251,animid=3D700},}=
)},
 =

+	{artid=3D153 , content=3D{}}, 	--walking_dead_ghoul
+	{artid=3D154 , content=3D{}}, 	--walking_dead_mummy
+	{artid=3D155 , content=3D{}}, 	--walking_dead_rotting_corpse
 	{artid=3D187 , content=3D{}}, 	--ridgeback_ridgeback
 	{artid=3D193 , content=3D{}}, 	--ridgeback_ridgeback_ethereal
 	{artid=3D188 , content=3D{}}, 	--ridgeback_savage
@@ -314,9 +317,6 @@
 	{artid=3D53 , content=3D{}}, 	--trolls_troll
 	{artid=3D54 , content=3D{}}, 	--trolls_troll
 	{artid=3D55 , content=3D{}}, 	--trolls_troll_frost
-	{artid=3D153 , content=3D{}}, 	--walking_dead_ghoul
-	{artid=3D154 , content=3D{}}, 	--walking_dead_mummy
-	{artid=3D155 , content=3D{}}, 	--walking_dead_rotting_corpse
 	{artid=3D3 , content=3D{}}, 	--walking_dead_zombie
 	{artid=3D221 , content=3D{}}, 	--walrus_walrus_male
 	=


Modified: trunk/lua/lib.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.lua (original)
+++ trunk/lua/lib.granny.lua Mon Mar 17 20:23:28 2008
@@ -323,14 +323,13 @@
 	local cachename =3D modelid.."_"..hue
 	local cache =3D gGrannyMeshCache[cachename] =

 	if (cache ~=3D nil) then return cache end
-	-- TODO : see gHueLoader -- HueMesh(meshname,gHueLoader,iHue)  scripting.=
cpp:379
 	=

 	-- not in cache, so create mesh
 	local mygranny =3D GetGrannyModelLoader(modelid)
 	if (not mygranny) then gGrannyMeshCache[modelid] =3D false return end
 	--~ CheckGrannyModel(mygranny)
 	local matname =3D GetGrannyMat(modelid,hue,mygranny)
---	local modelinfo =3D GetGrannyModelInfo(modelid)
+
 	local meshname =3D mygranny:CreateOgreMesh(matname,skeletonname)
 	gGrannyMeshCache[cachename] =3D meshname
 	return meshname

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Mar 17 20:23:28 2008
@@ -48,7 +48,6 @@
 dofile(libpath .. "lib.terrain.multitex.lua")
 dofile(libpath .. "lib.static.lua")
 dofile(libpath .. "lib.compass.lua")
-dofile(libpath .. "lib.gfm.lua")
 dofile(libpath .. "lib.protocol.lua")
 dofile(libpath .. "lib.mousepick.lua")
 dofile(libpath .. "lib.data.lua")



From no-reply at zwischenwelt.org  Mon Mar 17 23:39:57 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 17 Mar 2008 22:39:57 -0000
Subject: [Iris-commit] [IRIS] r1970 - in /tools/archiv: gfm/ gui_varan/
Message-ID: <20080317223957.D6FE0152402A@zwischenwelt.org>

Author: sience
Date: Mon Mar 17 23:39:57 2008
New Revision: 1970

Log:
-several things moved to archive

Added:
    tools/archiv/gfm/
    tools/archiv/gfm/askquit.gfm
    tools/archiv/gfm/background.gfm
    tools/archiv/gfm/charlist.gfm
    tools/archiv/gfm/connecting.gfm
    tools/archiv/gfm/credits.gfm
    tools/archiv/gfm/healthbar.gfm
    tools/archiv/gfm/healthbar_npc.gfm
    tools/archiv/gfm/journal.gfm
    tools/archiv/gfm/loading.gfm
    tools/archiv/gfm/main_menu.gfm
    tools/archiv/gfm/neterror.gfm
    tools/archiv/gfm/npc_paperdoll.gfm
    tools/archiv/gfm/player_paperdoll.gfm
    tools/archiv/gfm/quickcast.gfm
    tools/archiv/gfm/secure_trade.gfm
    tools/archiv/gfm/serverlist.gfm
    tools/archiv/gfm/skill.gfm
    tools/archiv/gfm/status_aos.gfm
    tools/archiv/gui_varan/
    tools/archiv/gui_varan/Tut_gumpmanager.txt
    tools/archiv/gui_varan/gui.gumpmanager.lua
    tools/archiv/gui_varan/gui.widget.lua



From no-reply at zwischenwelt.org  Tue Mar 18 03:58:33 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 18 Mar 2008 02:58:33 -0000
Subject: [Iris-commit] [IRIS] r1971 - in /trunk: lua/lib.plugin.lua
 lua/main.lua plugins/ plugins/example.lua
Message-ID: <20080318025833.737E6152402A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 18 03:58:32 2008
New Revision: 1971

Log:
added plugin system

Added:
    trunk/lua/lib.plugin.lua
    trunk/plugins/
    trunk/plugins/example.lua
Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Mar 18 03:58:32 2008
@@ -10,6 +10,7 @@
 gConfigPathFallback	=3D datapath.."config.lua.dist"
 gMacroPath 			=3D datapath.."mymacros.lua"
 gMacroPathFallback	=3D datapath.."mymacros.lua.dist"
+gMainPluginDir 		=3D gMainWorkingDir.."plugins/"
 gSecondsSinceLastFrame =3D 0
 =

 gInGameStarted =3D false
@@ -80,6 +81,7 @@
 dofile(libpath .. "lib.bugreport.lua")
 dofile(libpath .. "lib.buff.lua")
 dofile(libpath .. "lib.unifont.lua")
+dofile(libpath .. "lib.plugin.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")
@@ -265,6 +267,9 @@
 	=

 	CheckUODir()
 	=

+	LoadPlugins_Iris()
+	NotifyListener("Hook_PluginsLoaded")
+	=

 	gMyTicks =3D Client_GetTicks()
 	=

 	LoadingProfile("initializing Ogre",true)
@@ -395,6 +400,9 @@
 -- called every frame, after all timer-steppers, see Step() in lib.time.lua
 function MainStep ()
 	LugreStep()
+	=

+	NotifyListener("Hook_MainStep") -- should called before physstep, so obje=
ct position changes affect the gfx correctly
+	=

 	NetStep()
 =

 	if (gInGameStarted) then
@@ -415,6 +423,9 @@
 	=

 =

 	StepDebugMenu()
+	=

+	NotifyListener("Hook_HUDStep") -- updates special hud elements dependant =
on object positions that don't have auto-tracking
+	=

 	InputStep() -- generate mouse_left_drag_* and mouse_left_click_single eve=
nts =

 	GUIStep() -- generate mouse_enter, mouse_leave events (might adjust curso=
r -> before CursorStep)
 	ToolTipStep() -- needs mouse_enter, should be after GUIStep



From no-reply at zwischenwelt.org  Wed Mar 19 12:35:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 19 Mar 2008 11:35:06 -0000
Subject: [Iris-commit] [IRIS] r1972 - in /trunk/lua: gui/gui.journal.lua
 lib.macrolist.lua lib.walking3.lua
Message-ID: <20080319120011.DD98C1524034@zwischenwelt.org>

Author: hagish
Date: Wed Mar 19 12:35:05 2008
New Revision: 1972

Log:
extended macro system

Modified:
    trunk/lua/gui/gui.journal.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.walking3.lua

Modified: trunk/lua/gui/gui.journal.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.journal.lua (original)
+++ trunk/lua/gui/gui.journal.lua Wed Mar 19 12:35:05 2008
@@ -70,6 +70,7 @@
 }
 =

 gJournalEntries =3D {}
+gJournalExtendedEntries =3D {}
 gJournalDialog =3D nil
 gJournalDialog_Pref =3D {}
 gJournalResizeStartX,gJournalResizeStartY =3D nil,nil
@@ -197,6 +198,15 @@
 		mytext =3D name.."> "..mytext
 	end   	=

 	table.insert(gJournalEntries,mytext)
+	=

+	-- add extendes journal entry for scripting
+	local entry =3D {}
+	entry.name =3D name
+	entry.message =3D message
+	entry.time =3D Client_GetTicks()
+	entry.line =3D mytext
+	table.insert(gJournalExtendedEntries,entry)
+	=

 	JournalUpdateText()
 end
 =


Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Wed Mar 19 12:35:05 2008
@@ -166,6 +166,22 @@
 end
 =

 =

+-- searches the journal for text
+-- if timestamp is not nil, only entries since timestamp are searched
+-- if the text is found it returns the complete line otherwise nil
+function MacroJournal_FindLineContainingSince	(text, timestamp)
+	for k,v in pairs(gJournalExtendedEntries) do
+		if timestamp =3D=3D nil or v.time >=3D timestamp then
+			if string.find(v.line, text) then
+				return v.line
+			end
+		end
+	end
+	=

+	return nil
+end
+
+
 function MacroReadAux_MobileStat			(mobile,statname,errormsg_funname)
 	if (not gInGameStarted) then return 0 end
 	if (not gMacroReadMobileStats[statname]) then =

@@ -219,6 +235,11 @@
 RegisterListener("keydown",function (keycode,char,bConsumed) =

 	if (not gActiveEditText) then TriggerMacros(keycode) end
 end)
+
+
+
+
+
 =

 =

 --[[

Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Wed Mar 19 12:35:05 2008
@@ -246,8 +246,8 @@
 		landBlocks =3D true
 	end
 =

-	local landZ =3D 0, =

-	local landCenter =3D 0, =

+	local landZ =3D 0
+	local landCenter =3D 0
 	local landTop =3D 0
 =

 	local landZ,landCenter,landTop =3D map.GetAverageZ( x, y)
@@ -483,7 +483,7 @@
 	if ( not isSet ) then
 		zLow =3D loc.Z
 		zTop =3D loc.Z
-	elseif ( loc.Z > zTop )
+	elseif ( loc.Z > zTop ) then
 		zTop =3D loc.Z
 	end
 	=




From no-reply at zwischenwelt.org  Thu Mar 20 00:54:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 19 Mar 2008 23:54:38 -0000
Subject: [Iris-commit] [IRIS] r1973 - /trunk/bin/iris2.exe
Message-ID: <20080320000012.42A1A1524034@zwischenwelt.org>

Author: sience
Date: Thu Mar 20 00:54:37 2008
New Revision: 1973

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Thu Mar 20 19:06:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 20 Mar 2008 18:06:34 -0000
Subject: [Iris-commit] [IRIS] r1974 - in /trunk/lua: lib.macrolist.lua
 lib.mousepick.lua lib.oldwalk.lua lib.pathfind.lua lib.tilefreewalk.lua
 main.lua
Message-ID: <20080320180634.2B286152402A@zwischenwelt.org>

Author: hagish
Date: Thu Mar 20 19:06:33 2008
New Revision: 1974

Log:
first pathfinding implemented (shift+leftdoubleclick), but slow and sometim=
es buggy

Added:
    trunk/lua/lib.pathfind.lua
Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/lib.oldwalk.lua
    trunk/lua/lib.tilefreewalk.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Mar 20 19:06:33 2008
@@ -179,6 +179,18 @@
 	end
 	=

 	return nil
+end
+
+function MacroRead_GetPlayerPosition	()
+	local sx,sy,sz
+	local mobile =3D GetPlayerMobile()
+	if mobile then
+		sx,sy,sz =3D mobile.xloc,mobile.yloc,mobile.zloc * 0.1
+	else
+		sx,sy,sz =3D gTileFreeWalk:GetExactLocalPos()
+		sx =3D -sx
+	end	=

+	return sx,sy,sz
 end
 =

 =


Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Thu Mar 20 19:06:33 2008
@@ -26,6 +26,8 @@
 			-- -50,-30 to place the dialog beneath the mouse
 			OpenHealthbar(mobile,iMouseX - 50,iMouseY - 30)
 		end
+	elseif gKeyPressed[key_lshift] then
+		Pathfinding_TriggeredByMouse()
 	else
 		-- normal doubleclick handling
 		local pm =3D GetPlayerMobile()

Modified: trunk/lua/lib.oldwalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.oldwalk.lua (original)
+++ trunk/lua/lib.oldwalk.lua Thu Mar 20 19:06:33 2008
@@ -9,13 +9,14 @@
 =

 -- sets the given tile coordinates as walk target
 -- bHaltBefore : if true, stop one field before the target
+--[[
 function SetAutoWalkTo (x, y, bHaltBefore) =

 	OldWalkWarn("SetAutoWalkTo")
 	--~ gAutoWalk =3D true
 	--~ gAutoWalkX, gAutoWalkY =3D x, y
 	--~ gAutoWalkHaltBefore =3D bHaltBefore and true or false
 end
-
+]]--
 =

 -- sets the current mousehit as walk target
 function SetAutoWalkTarget () =


Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Thu Mar 20 19:06:33 2008
@@ -131,10 +131,18 @@
 	local fRequestedSpeed =3D 0
 	local bRunRequested =3D false
 	=

+	-- should the wall collision be ignored? used for pathfinding
+	local bIgnoreCollision =3D false
+	=

 	-- hold rightmouse button to walk in mouse direction (depends on center o=
f screen, works good for 3rd person cam)
 	local bMoved =3D false
 	local x,y,z =3D self:GetPos_ClientSide()
 	local ox,oy =3D x,y
+	=

+	-- cancel autowalk if user interacts
+	if bWalkInMouseDir or bWalkForward or bWalkBackwards or bTurnLeft or bTur=
nRight then
+		gWalkPathToGo =3D nil
+	end
 	=

 	-- read input and calculate desired movement
 	if (bWalkInMouseDir) then
@@ -152,6 +160,41 @@
 		x =3D x + self.movedirx * fRequestedSpeed * gSecondsSinceLastFrame
 		y =3D y + self.movediry * fRequestedSpeed * gSecondsSinceLastFrame
 		bMoved =3D true
+	elseif gWalkPathToGo then
+		-- stores the path for pathfinding
+		-- the player runs along this path without user interaction
+		=

+		-- bIgnoreCollision =3D true
+		=

+		local onthemove =3D false
+		=

+		for k,v in pairs(gWalkPathToGo) do
+			local px,py =3D -v.x,v.y
+			local len =3D len2(x-px,y-py)
+			=

+			if len =3D=3D 0 then =

+				gWalkPathToGo[k] =3D nil
+			elseif not onthemove then
+				onthemove =3D true
+				=

+				local dx,dy =3D px-x,py-y
+				self.movedirx,self.movediry =3D norm2(dx,dy)
+		=

+				fRequestedSpeed =3D  self:GetClientSideSpeed(self.movedirx,self.movedi=
ry,0)
+				local maxspeed =3D fRequestedSpeed * gSecondsSinceLastFrame
+				if (bSlowWalk) then maxspeed =3D maxspeed * 0.5 end -- TODO : bSlowWal=
k-speed
+				bRunRequested =3D not bSlowWalk
+				bMoved =3D true
+				=

+				maxspeed =3D math.min(maxspeed, len)
+				=

+				x =3D x + self.movedirx * maxspeed
+				y =3D y + self.movediry * maxspeed
+			end
+		end
+		=

+		if countarr(gWalkPathToGo) =3D=3D 0 then gWalkPathToGo =3D nil end
+		=

 	else
 		local angadd =3D 0
 		if (bTurnLeft ) then  angadd =3D angadd + 240 * gfDeg2Rad * gSecondsSinc=
eLastFrame end
@@ -193,12 +236,16 @@
 			x,y =3D ox,oy
 			for i=3D1,steps do -- multisample movement
 				x,y =3D x+sx,y+sy
-				-- 1st collision : with wall center, to avoid speed bumps while walkin=
g along a wall
-				x,y =3D self:CollideWithWallMid(x,y)
-				-- 2nd collision : with wall edges, otherwise it would be possible to =
move into an edge between 2 non-parallel walls
-				x,y =3D self:CollideWithWallEdge(x,y)
-				-- 3rd collision : with wall center again, to avoid the edge collision=
s pushing the player slowly inside the walls
-				x,y =3D self:CollideWithWallMid(x,y)
+				=

+				if not bIgnoreCollision then
+					-- 1st collision : with wall center, to avoid speed bumps while walki=
ng along a wall
+					x,y =3D self:CollideWithWallMid(x,y)
+					-- 2nd collision : with wall edges, otherwise it would be possible to=
 move into an edge between 2 non-parallel walls
+					x,y =3D self:CollideWithWallEdge(x,y)
+					-- 3rd collision : with wall center again, to avoid the edge collisio=
ns pushing the player slowly inside the walls
+					x,y =3D self:CollideWithWallMid(x,y)
+				end
+				=

 				rx,ry,rz =3D self:RoundPos(x,y,z)
 				self:PathPoint_Push(rx,ry,rz)
 				self:ScanGroundIfNeeded(rx,ry,rz)
@@ -756,3 +803,6 @@
 	mymarker.gfx_dir:SetPosition(x+dx,y+dy,z+dz)
 end
 =

+function SetAutoWalkTo (x, y)
+	gWalkPathToGo =3D {{x=3Dx,y=3Dy,z=3D0}}
+end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Mar 20 19:06:33 2008
@@ -81,6 +81,7 @@
 dofile(libpath .. "lib.bugreport.lua")
 dofile(libpath .. "lib.buff.lua")
 dofile(libpath .. "lib.unifont.lua")
+dofile(libpath .. "lib.pathfind.lua")
 dofile(libpath .. "lib.plugin.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")



From no-reply at zwischenwelt.org  Thu Mar 20 20:19:01 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 20 Mar 2008 19:19:01 -0000
Subject: [Iris-commit] [IRIS] r1975 - in /trunk: data/mymacros.lua.dist
 lua/lib.input.iris.lua lua/lib.keybinds.lua lua/lib.macrolist.lua
 lua/lib.mousepick.lua lua/lib.oldwalk.lua lua/lib.renderer.lua lua/main.lua
Message-ID: <20080320191901.38F29152402A@zwischenwelt.org>

Author: sience
Date: Thu Mar 20 20:18:59 2008
New Revision: 1975

Log:
-two old files removed and functions removed from other files (mostly keyha=
ndlings)

Removed:
    trunk/lua/lib.input.iris.lua
    trunk/lua/lib.oldwalk.lua
Modified:
    trunk/data/mymacros.lua.dist
    trunk/lua/lib.keybinds.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/lib.renderer.lua
    trunk/lua/main.lua

Modified: trunk/data/mymacros.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/mymacros.lua.dist (original)
+++ trunk/data/mymacros.lua.dist Thu Mar 20 20:18:59 2008
@@ -55,10 +55,8 @@
 SetMacro("h",			function() MacroCmd_RepeatLastDoubleClick() end)
 SetMacro("q",			function() MacroCmd_SelectNearestMobile() end)
 SetMacro("e",			function() MacroCmd_SelectNextMobile() end)
-SetMacro("space",		function() MacroCmd_AttackSelectedMobile() end) -- curr=
ently broken
+--SetMacro("space",		function() MacroCmd_AttackSelectedMobile() end) -- cu=
rrently broken
 --SetMacro("z",			function() MacroCmd_ActivateNextRenderer() end) -- curre=
ntly broken
-SetMacro("u",			function() MacroCmd_WalkToMouse() end) -- currently broken
-
 =

 SetMacro("ctrl+f1",		function() MacroCmd_ItemSlot_Set(1) end)
 SetMacro("ctrl+f2",		function() MacroCmd_ItemSlot_Set(2) end)

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Thu Mar 20 20:18:59 2008
@@ -1,4 +1,6 @@
-local function BindGeneralKeys ()
+gDoubleClickIntervall =3D 800 -- override lugre default interval
+
+function BindGeneralKeys ()
 	Bind("escape",	function (state) =

 			if (state > 0) then =

 			if (not gActiveEditText) then =

@@ -8,13 +10,22 @@
 			end =

 			end =

 		end)
+
+	RegisterListener("keydown",		function (key,char,bConsumed) if (not bConsu=
med) then gCurrentRenderer:CamKeyDown(key) end end)
+	RegisterListener("keyup",		function (key) gCurrentRenderer:CamKeyUp(key) =
end)
+	=

+	RegisterListener("mouse_left_down",			function () IrisSingleClick() end)
+	RegisterListener("mouse_right_down",		function () IrisRightClick() end)
+	RegisterListener("mouse_left_up",			function () MouseUpUODragDrop() end)
+	=

+	RegisterListener("mouse_left_click_double",	function () IrisDoubleClick()=
 end)
+	RegisterListener("mouse_left_down",			function () MouseDownUODragDrop() e=
nd)
 end
 =

 function BindInGameKeys()
 	UnbindAll()
 	gLastCursor =3D 0
-	BindGeneralKeys()
-	=

+
     -- most keybinds have been moved to the macrosystem, see data/mymacros=
.lua
 =

     -- chatline
@@ -23,12 +34,10 @@
 	Bind("ins",		function (state) if (not gActiveEditText) then if (state > 0=
) then
 		ShowDebugMenuArtList(0,kDebugMode_Online)
 	end end end)
-	=

+
 	-- additional movement key handling in lib.tilefreewalk (for pressed keys)
-	Bind("right",   function (state) if (not gActiveEditText) then if (state =
> 0) then CancelAutoWalk() end end end) =

-	Bind("left",    function (state) if (not gActiveEditText) then if (state =
> 0) then CancelAutoWalk() end end end) =

-	Bind("down",    function (state) if (not gActiveEditText) then if (state =
> 0) then CancelAutoWalk() end else ChatLine_HistoryUpDown(-1) end end) =

-	Bind("up",      function (state) if (not gActiveEditText) then if (state =
> 0) then CancelAutoWalk() end else ChatLine_HistoryUpDown(1) end end)
+	Bind("down",    function (state) if (gActiveEditText) then ChatLine_Histo=
ryUpDown(-1) end end) =

+	Bind("up",      function (state) if (gActiveEditText) then ChatLine_Histo=
ryUpDown(1) end end)
 	=

 	-------------------------------------------------------------------------=
----------
 =

@@ -67,7 +76,6 @@
 				OgreAddCompositor(GetMainViewport(), "B&W")
 				gCompositor =3D true
 			end
-			--Send_AOSCommand(kPacket_AOS_Command_WeaponAbilityRequest,hex2num("0x1=
"),2)
 		 end end end)
 	=

 		Bind("f2",		function (state) if (not gActiveEditText) then if (state > 0=
) then

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Mar 20 20:18:59 2008
@@ -40,7 +40,7 @@
 function MacroCmd_RepeatLastDoubleClick	()		if (gInGameStarted) then Repea=
tLastDoubleClick() end end
 function MacroCmd_SelectNearestMobile	()		if (gInGameStarted) then SelectN=
earestMobile() end end
 function MacroCmd_SelectNextMobile		()		if (gInGameStarted) then SelectNex=
tMobile() end end
-function MacroCmd_AttackSelectedMobile	()		if (gInGameStarted) then Attack=
SelectedMobile() end end
+function MacroCmd_AttackSelectedMobile	()		if (gInGameStarted) then print(=
"not implemented yet") end end
 function MacroCmd_ToggleWarmode			()		if (gInGameStarted) then Send_Combat=
Mode((gActWarmode=3D=3DgWarmode_Normal) and gWarmode_Combat or gWarmode_Nor=
mal) end end
 function MacroCmd_Open					(dialogtype)
 	if (not gInGameStarted) then return end
@@ -83,7 +83,6 @@
 		end)
 end
 =

-function MacroCmd_WalkToMouse			() 				if (gInGameStarted) then SetAutoWal=
kTarget() end end
 function MacroCmd_ShowFallBackTool		() 				if (gInGameStarted) then ShowFa=
llBackTool() end end
 function MacroCmd_ShowDevTool			() 				if (gInGameStarted) then ShowDevToo=
l() end end =

 function MacroCmd_ZoomCompass			(zoomfactor)	if (gInGameStarted) then Zoom=
Compass(zoomfactor) end end

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Thu Mar 20 20:18:59 2008
@@ -133,15 +133,3 @@
 		end
 	end
 end
-
--- attack the current selected mobile or just go to it (depends in warmode=
 on/off)
-function AttackSelectedMobile ()
-	if (giSelectedMobile ~=3D 0) then
-		-- who shall i kill, master?
-		local target =3D GetMobile(giSelectedMobile)
-		if target then
-			-- run to the target
-			SetFollowMobile(giSelectedMobile)
-		end
-	end
-end

Modified: trunk/lua/lib.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.renderer.lua (original)
+++ trunk/lua/lib.renderer.lua Thu Mar 20 20:18:59 2008
@@ -1,6 +1,4 @@
 -- common utils for all renderers
-
-
 =

 function GetRendererName (renderer) =

 	for k,v in pairs(gRendererList) do
@@ -24,6 +22,11 @@
 	printf("########## change renderer successful\n")
 end
 =

+-- called from c
+function NotifyMainWindowResized (w,h)
+	gCurrentRenderer:NotifyMainWindowResized(w,h) -- set aspect ratio
+end
+
 --###############################
 --###         DUMMYS          ###
 --###############################

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Mar 20 20:18:59 2008
@@ -26,7 +26,6 @@
 dofile(lugreluapath .. "lugre.lua")
 lugre_include_libs(lugreluapath)
 dofile(libpath .. "lib.sound.iris.lua")
-dofile(libpath .. "lib.input.iris.lua")
 dofile(libpath .. "lib.keybinds.lua")
 dofile(libpath .. "lib.xml.lua")
 dofile(libpath .. "lib.net.lua")
@@ -74,10 +73,9 @@
 dofile(libpath .. "lib.3d.walksmooth.lua")
 dofile(libpath .. "lib.mount.lua")
 dofile(libpath .. "lib.debug.lua")
-dofile(libpath .. "lib.uodragdrop.lua")  --(new dragdrop system not yet us=
ed in trunk, see for old)
+dofile(libpath .. "lib.uodragdrop.lua")
 dofile(libpath .. "lib.corpse.lua")
 dofile(libpath .. "lib.tilefreewalk.lua")
-dofile(libpath .. "lib.oldwalk.lua")
 dofile(libpath .. "lib.bugreport.lua")
 dofile(libpath .. "lib.buff.lua")
 dofile(libpath .. "lib.unifont.lua")
@@ -319,6 +317,8 @@
 	gFadeLineH =3D gFadeLineTextH
 	gFadeLineOffY =3D 30 + gFadeLineTextH
 =

+	BindGeneralKeys()
+
 	StartMainMenu()
 	=

 	if (gCommandLineSwitches["-fonttest"]) then FontTest() end



From no-reply at zwischenwelt.org  Fri Mar 21 14:04:43 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 21 Mar 2008 13:04:43 -0000
Subject: [Iris-commit] [IRIS] r1976 - /trunk/data/profiles/gfx_ultrahigh.lua
Message-ID: <20080321140014.A7442152402A@zwischenwelt.org>

Author: sience
Date: Fri Mar 21 14:04:42 2008
New Revision: 1976

Log:
-humanskinshader currently doesn't work when dead

Modified:
    trunk/data/profiles/gfx_ultrahigh.lua

Modified: trunk/data/profiles/gfx_ultrahigh.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/profiles/gfx_ultrahigh.lua (original)
+++ trunk/data/profiles/gfx_ultrahigh.lua Fri Mar 21 14:04:42 2008
@@ -7,7 +7,7 @@
 gDynamicsCastShadows =3D true
 gMobileCastShadows =3D true
 =

-gUseHumanSkinShader =3D true
+--gUseHumanSkinShader =3D true -- currently doesn't work
 =

 gSightRange	=3D 6
 =




From no-reply at zwischenwelt.org  Fri Mar 21 16:31:50 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 21 Mar 2008 15:31:50 -0000
Subject: [Iris-commit] [IRIS] r1977 - /trunk/src/data.cpp
Message-ID: <20080321153150.4FEEC152402A@zwischenwelt.org>

Author: hagish
Date: Fri Mar 21 16:31:49 2008
New Revision: 1977

Log:
64bit fix

Modified:
    trunk/src/data.cpp

Modified: trunk/src/data.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data.cpp (original)
+++ trunk/src/data.cpp Fri Mar 21 16:31:49 2008
@@ -871,9 +871,9 @@
 =

 const int cUniFontFileLoader::GetLetterNumbers(){return 0xFFFF;}
 const float cUniFontFileLoader::GetLetterUsage(){
-	std::map<int,int> lCache;
+	std::map<const char *,int> lCache;
 	for(int i=3D0;i<GetLetterNumbers();++i){
-		int data =3D int(GetLetterData(i));
+		const char * data =3D GetLetterData(i);
 		if(lCache.find(data) =3D=3D lCache.end())lCache[data] =3D 1;
 		else lCache[data] =3D lCache[data] + 1;
 	}



From no-reply at zwischenwelt.org  Fri Mar 21 16:40:47 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 21 Mar 2008 15:40:47 -0000
Subject: [Iris-commit] [IRIS] r1978 - /trunk/src/builder.cpp
Message-ID: <20080321154047.C32CA152402A@zwischenwelt.org>

Author: hagish
Date: Fri Mar 21 16:40:46 2008
New Revision: 1978

Log:
64bit fix

Modified:
    trunk/src/builder.cpp

Modified: trunk/src/builder.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/builder.cpp (original)
+++ trunk/src/builder.cpp Fri Mar 21 16:40:46 2008
@@ -631,7 +631,7 @@
 	// number of letters to load
 	unsigned int letters =3D last - first + 1;
 =

-	std::map<int,Ogre::Rectangle> lCache;
+	std::map<const char *,Ogre::Rectangle> lCache;
 =

 	// max letter size (without border space)
 	unsigned int maxw =3D oUniFontFileLoader.GetMaxWidth();
@@ -686,7 +686,7 @@
 		if(data =3D=3D 0)continue;
 =

 		// letter already rendered?
-		if(lCache.find(int(data)) =3D=3D lCache.end()){
+		if(lCache.find(data) =3D=3D lCache.end()){
 			// decode letter and store in image
 =

 			// iterator over all pixels (letw,leth)
@@ -741,11 +741,11 @@
 				Ogre::Rectangle r;
 				r.left =3D u1;r.right =3D u2;
 				r.top =3D v1;r.bottom =3D v2;
-				lCache[int(data)] =3D r;
+				lCache[data] =3D r;
 			}
 		} else {
 			// use already written part if the image
-			Ogre::Rectangle r(lCache.find(int(data))->second);
+			Ogre::Rectangle r(lCache.find(data)->second);
 			// set glyphe text coords
 			font->setGlyphTexCoords(i,r.left,r.top,r.right,r.bottom,float(texw)/flo=
at(texh));
 		}



From no-reply at zwischenwelt.org  Sat Mar 22 14:37:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 22 Mar 2008 13:37:14 -0000
Subject: [Iris-commit] [IRIS] r1979 - in /trunk: bin/iris2.exe
 lua/lib.compass.lua lua/lib.static.lua lua/main.lua
Message-ID: <20080322133715.1F4BC152402A@zwischenwelt.org>

Author: sience
Date: Sat Mar 22 14:37:13 2008
New Revision: 1979

Log:
-some compass optimizations
-new win32 binary
-loading order changed for resources

Modified:
    trunk/bin/iris2.exe
    trunk/lua/lib.compass.lua
    trunk/lua/lib.static.lua
    trunk/lua/main.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Sat Mar 22 14:37:13 2008
@@ -30,8 +30,6 @@
 		gIrisCompassDialog.bDoUpdate =3D true
 		=

 		local z =3D GetMaxZ()
-		local vw =3D GetMainViewport():GetActualWidth()
-		local vh =3D GetMainViewport():GetActualHeight()
 		local mx =3D vw - gCompassSize/2 - gCompassOff
 		local my =3D 15 + gCompassSize/2 + gCompassOff
 		local halfwidth =3D 128
@@ -66,17 +64,28 @@
 			mygfx:RenderableIndex3(1,3,2)
 			mygfx:RenderableEnd()
 		end
-		=

+
 		-- rotating compass part (north indicator)
 		if (gIrisCompassDialog.compassframe_rot) then
 			local mygfx =3D gIrisCompassDialog.compassframe_rot.gfx
 			mygfx:InitRROC()
 			mygfx:SetMaterial("compassframe_rot")
-		end
-		=

-		=

+			local ax, iCamOverBlockX, iCamOverBlockY, MirrorX =3D gCurrentRenderer:=
UpdateCompass()
+			local r =3D math.sqrt( halfwidth*halfwidth + halfwidth*halfwidth )
+			local rsin =3D halfwidth * math.sin(- ax + gfDeg2Rad*90)
+			local rcos =3D halfwidth * math.cos(- ax + gfDeg2Rad*90)
+			mygfx:RenderableBegin(4,6,true,false,OT_TRIANGLE_LIST)
+			mygfx:RenderableVertex((mx - rcos - rsin)/vw * 2.0 - 1.0,(my - rcos + r=
sin)/vh * (-2.0) + 1.0,z, 0,0)
+			mygfx:RenderableVertex((mx + rcos - rsin)/vw * 2.0 - 1.0,(my - rcos - r=
sin)/vh * (-2.0) + 1.0,z, 1,0)
+			mygfx:RenderableVertex((mx - rcos + rsin)/vw * 2.0 - 1.0,(my + rcos + r=
sin)/vh * (-2.0) + 1.0,z, 0,1)
+			mygfx:RenderableVertex((mx + rcos + rsin)/vw * 2.0 - 1.0,(my + rcos - r=
sin)/vh * (-2.0) + 1.0,z, 1,1)
+			mygfx:RenderableIndex3(0,1,2)
+			mygfx:RenderableIndex3(1,3,2)
+			mygfx:RenderableEnd()
+		end
+
 		--zoom buttons
-		local x,y,e =3D gCompassSize*0.9,gCompassSize*0.9,7
+		local x,y,e =3D gCompassSize*0.9, gCompassSize*0.9, 7
 		gIrisCompassDialog.compassframe_zoomin =3D guimaker.MakePlane(gIrisCompa=
ssDialog.rootwidget,"compassframe_zoomin",x+e,y-e,24,24)
 		gIrisCompassDialog.compassframe_zoomin.gfx:SetUV(4/32,4/32,28/32,28/32)
 		gIrisCompassDialog.compassframe_zoomin.mbIgnoreMouseOver =3D false
@@ -185,16 +194,18 @@
 	if (gDisableCompass) then return end
 	if (gIrisCompassDialog and gIrisCompassDialog.bDoUpdate) then	=

 		local ax, iCamOverBlockX, iCamOverBlockY, MirrorX =3D gCurrentRenderer:U=
pdateCompass()
-		=

-		local vw =3D GetMainViewport():GetActualWidth()
-		local vh =3D GetMainViewport():GetActualHeight()
-		=

+		local vw,vh =3D GetViewportSize() -- uses overlay manager
+		local z =3D GetMaxZ()
+		local mx =3D vw - gCompassSize/2 - gCompassOff
+		local my =3D 15 + gCompassSize/2 + gCompassOff
+		local halfwidth =3D 128
+
 		if (gIrisCompassDialog.radar) then
 			--MemProfile("a")
 			gIrisCompassDialog.radar:SetLocation( iCamOverBlockX*8, iCamOverBlockY*=
8 ) -- TODO : memleak, old tiles (and textures?) not freed
 			--MemProfile("c")
 			gIrisCompassDialog.radar:SetAngle( ax )
-			gIrisCompassDialog.radar:SetPosition( vw - gCompassSize - gCompassOff +=
 gCompassSize/2, 15 + gCompassOff + gCompassSize/2 )
+			gIrisCompassDialog.radar:SetPosition( mx, my )
 		=

 			if (MirrorX) then
 				gIrisCompassDialog.radar:SetMirrorX( true )
@@ -202,23 +213,18 @@
 				gIrisCompassDialog.radar:SetMirrorX( false )
 			end
 		end
-		=

+
 		if (gIrisCompassDialog.compass.gfx) then
 			gIrisCompassDialog.compass.gfx:SetAngBias(ax)
-			gIrisCompassDialog.compass.gfx:SetUVMid(iCamOverBlockX/gCompassMapW,
-								iCamOverBlockY/gCompassMapH)
-		end
-		=

+			gIrisCompassDialog.compass.gfx:SetUVMid(iCamOverBlockX/gCompassMapW, iC=
amOverBlockY/gCompassMapH)
+		end
+
 		-- rotating compass part
 		if (gIrisCompassDialog.compassframe_rot) then
-			local z =3D GetMaxZ()
-			local mx =3D vw - gCompassSize/2 - gCompassOff
-			local my =3D 15 + gCompassSize/2 + gCompassOff
-			local halfwidth =3D 128
+			local mygfx =3D gIrisCompassDialog.compassframe_rot.gfx
 			local r =3D math.sqrt( halfwidth*halfwidth + halfwidth*halfwidth )
 			local rsin =3D halfwidth * math.sin(- ax + gfDeg2Rad*90)
 			local rcos =3D halfwidth * math.cos(- ax + gfDeg2Rad*90)
-			local mygfx =3D gIrisCompassDialog.compassframe_rot.gfx
 			mygfx:RenderableBegin(4,6,true,false,OT_TRIANGLE_LIST)
 			mygfx:RenderableVertex((mx - rcos - rsin)/vw * 2.0 - 1.0,(my - rcos + r=
sin)/vh * (-2.0) + 1.0,z, 0,0)
 			mygfx:RenderableVertex((mx + rcos - rsin)/vw * 2.0 - 1.0,(my - rcos - r=
sin)/vh * (-2.0) + 1.0,z, 1,0)
@@ -228,7 +234,28 @@
 			mygfx:RenderableIndex3(1,3,2)
 			mygfx:RenderableEnd()
 		end
-	end
-end
-
-
+
+		-- TODO: only update when viewport is resized
+
+		if (Viewportresized) then
+			if (gIrisCompassDialog.compassframe_static) then
+				local mygfx =3D gIrisCompassDialog.compassframe_static.gfx
+				mygfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
+				mygfx:RenderableVertex(((mx - halfwidth)/vw * 2.0 - 1.0),((my - halfwi=
dth)/vh * (-2.0) + 1.0),z, 0,0)
+				mygfx:RenderableVertex(((mx + halfwidth)/vw * 2.0 - 1.0),((my - halfwi=
dth)/vh * (-2.0) + 1.0),z, 1,0)
+				mygfx:RenderableVertex(((mx - halfwidth)/vw * 2.0 - 1.0),((my + halfwi=
dth)/vh * (-2.0) + 1.0),z, 0,1)
+				mygfx:RenderableVertex(((mx + halfwidth)/vw * 2.0 - 1.0),((my + halfwi=
dth)/vh * (-2.0) + 1.0),z, 1,1)
+				mygfx:RenderableIndex3(0,1,2)
+				mygfx:RenderableIndex3(1,3,2)
+				mygfx:RenderableEnd()
+			end
+
+--			local x,y,e =3D gCompassSize*0.9, gCompassSize*0.9, 7
+--			gIrisCompassDialog.compassframe_zoomin.gfx:SetPos( x+e, y-e)
+--			gIrisCompassDialog.compassframe_zoomout.gfx:SetPos(x-e, y+e)
+		end
+
+	end
+end
+
+

Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Sat Mar 22 14:37:13 2008
@@ -34,6 +34,7 @@
 =

 -- generates or retrieves meshname for static model
 -- TODO : not flexible enough, what if model should be skipped, or multipl=
e models set ? or model depending on surrounding ?
+-- TODO: remove hueing from her, not needed for fastbatch here
 gLegacyModelCache =3D {}
 function GetMeshName (iTileTypeID, iHue)
 	-- hue default value is 0

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Mar 22 14:37:13 2008
@@ -179,17 +179,17 @@
 	OgreAddResLoc(mydatapath.."guis/gorgui"					,"FileSystem","General")
 	OgreAddResLoc(mydatapath.."guis/naked"					,"FileSystem","General")
 =

-	--~ # custom models
-	OgreAddResLoc(mydatapath.."custom/materials"			,"FileSystem","General")
-	OgreAddResLoc(mydatapath.."custom/models"				,"FileSystem","General")
-	OgreAddResLoc(mydatapath.."custom/textures"				,"FileSystem","General")
-
 	--~ # distributet models
 	OgreAddResLoc(mydatapath.."models/materials"			,"FileSystem","General")
 	OgreAddResLoc(mydatapath.."models/meta"					,"FileSystem","General")
 	for i=3D1,20 do OgreAddResLoc(mydatapath.."models/models/"..sprintf("to_%=
03d000",i)	,"FileSystem","General") end
 	OgreAddResLoc(mydatapath.."models/textures/"			,"FileSystem","General")
 	OgreAddResLoc(mydatapath.."models/atlas"				,"FileSystem","General")
+
+	--~ # custom models
+	OgreAddResLoc(mydatapath.."custom/materials"			,"FileSystem","General")
+	OgreAddResLoc(mydatapath.."custom/models"				,"FileSystem","General")
+	OgreAddResLoc(mydatapath.."custom/textures"				,"FileSystem","General")
 =

 	--~ # new Terrain Shaderengine
 	OgreAddResLoc(mydatapath.."terrain/materials"			,"FileSystem","General")



From no-reply at zwischenwelt.org  Sun Mar 23 16:27:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 23 Mar 2008 15:27:28 -0000
Subject: [Iris-commit] [IRIS] r1980 - /trunk/lua/lib.3d.dynamic.lua
Message-ID: <20080323152729.B0917152402A@zwischenwelt.org>

Author: hagish
Date: Sun Mar 23 16:27:26 2008
New Revision: 1980

Log:
fallback cache

Modified:
    trunk/lua/lib.3d.dynamic.lua

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Sun Mar 23 16:27:26 2008
@@ -255,25 +255,108 @@
 	end
 end
 =

+--[[
+currently unused
+
+gArtImageTexAtlasSize =3D 512
+gArtImageLastTextureAtlas =3D nil
+gArtImageTexAtlasCounter =3D 0
+-- texname,u0,v0,u1,v1 or nil on error
+function ArtImage_AddImageToAtlas (iArtID,iHue)
+	local w =3D gArtImageTexAtlasSize
+	if (gArtImageLastTextureAtlas =3D=3D nil) then gArtImageLastTextureAtlas =
=3D CreateTexAtlas(w,w) end -- only first time
+	=

+	local img =3D CreateImage()
+	if gArtMapLoader and gArtMapLoader:ExportToImage(img,iArtID,gHueLoader,iH=
ue) then	-- + 16384
+	=

+		-- add to exisiting texatlas or start a new one if it doesn't fit
+		local bSuccess,l,r,t,b =3D gArtImageLastTextureAtlas:AddImage(img)
+		if (not bSuccess) then =

+			-- not more space in the old atlas, start a new one
+			=

+			local img2 =3D CreateImage()
+			gArtImageLastTextureAtlas:MakeImage(img2)
+			img2:SaveAsFile("artatlas_"..gArtImageTexAtlasCounter..".png")
+			img2:Destroy()
+			gArtImageTexAtlasCounter =3D gArtImageTexAtlasCounter + 1
+	=

+			gArtImageLastTextureAtlas =3D CreateTexAtlas(w,w)
+			bSuccess,l,r,t,b =3D gArtImageLastTextureAtlas:AddImage(img)
+			if (not bSuccess) then print("warning, art image too big for texatlas")=
 return end
+		end
+		=

+		-- create or update texatlas
+		if (gArtImageLastTextureAtlas.texname) then =

+			gArtImageLastTextureAtlas:LoadToTexture(gArtImageLastTextureAtlas.texna=
me) -- update existing texture
+		else
+			gArtImageLastTextureAtlas.texname =3D gArtImageLastTextureAtlas:MakeTex=
ture() -- generate new texture
+		end
+		=

+		img:Destroy()
+
+		local img2 =3D CreateImage()
+		gArtImageLastTextureAtlas:MakeImage(img2)
+		img2:SaveAsFile("artatlas_"..gArtImageTexAtlasCounter..".png")
+		img2:Destroy()
+
+		-- return info about the allocated area for this glyph
+		return gArtImageLastTextureAtlas.texname,l,t,r,b
+	else
+		return nil
+	end
+end
+]]--
+
+
+gArtBillBoardCache =3D {}
 function Renderer3D:CreateArtBillBoard( gfx, iArtID, iHue )
 	if (iArtID > gMaxArtValue) then return end
-	local matname =3D GetArtBillBoardMat(iArtID,iHue)
+
 	local isotilew =3D 44 / math.sqrt(2)
-	local w,h =3D GetArtSize(iArtID,iHue)
-	if (not w or w =3D=3D 0) then w =3D isotilew end
-	if (not h or h =3D=3D 0) then h =3D isotilew end
-	gfx:SetSimpleRenderable()
-	gfx:SetMaterial(matname)
-	gfx:SetCastShadows(false)
-	gfx:SetForceRotCam(GetMainCam())
-	gfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
-	gfx:RenderableVertex( 0.5*w / isotilew,-0.5					,0, 1*w/texsize(w),h/texs=
ize(h))
-	gfx:RenderableVertex(-0.5*w / isotilew,-0.5					,0, 0*w/texsize(w),h/texs=
ize(h))
-	gfx:RenderableVertex( 0.5*w / isotilew,-0.5 + h / isotilew	,0, 1*w/texsiz=
e(w),0)
-	gfx:RenderableVertex(-0.5*w / isotilew,-0.5 + h / isotilew	,0, 0*w/texsiz=
e(w),0)
-	gfx:RenderableIndex3(0,1,2)
-	gfx:RenderableIndex3(1,3,2)
-	gfx:RenderableEnd()
+	=

+	local matname,l,t,r,b,w,h
+	=

+	-- caching
+	if gArtBillBoardCache[iArtID.."_"..iHue] then =

+		matname,l,t,r,b,w,h =3D unpack(gArtBillBoardCache[iArtID.."_"..iHue])
+	else
+		matname =3D GetArtBillBoardMat(iArtID,iHue)
+		=

+		if matname then
+			w,h =3D GetArtSize(iArtID,iHue)
+			if (not w or w =3D=3D 0) then w =3D isotilew end
+			if (not h or h =3D=3D 0) then h =3D isotilew end
+
+			l =3D 0*w/texsize(w)
+			r =3D 1*w/texsize(w)
+			t =3D 0*w/texsize(w)
+			b =3D h/texsize(h)
+			gArtBillBoardCache[iArtID.."_"..iHue] =3D {matname,l,t,r,b,w,h}
+			-- print("CreateArtBillBoard",matname,l,t,r,b,w,h)
+		else
+			gArtBillBoardCache[iArtID.."_"..iHue] =3D {nil}
+		end
+	end
+	=

+	-- set billboard
+	if matname then
+	=

+		gfx:SetSimpleRenderable()
+		gfx:SetMaterial(matname)
+		gfx:SetCastShadows(false)
+		gfx:SetForceRotCam(GetMainCam())
+		gfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
+		gfx:RenderableVertex( 0.5*w / isotilew,-0.5					,0, r,b)
+		gfx:RenderableVertex(-0.5*w / isotilew,-0.5					,0, l,b)
+		gfx:RenderableVertex( 0.5*w / isotilew,-0.5 + h / isotilew	,0, r,t)
+		gfx:RenderableVertex(-0.5*w / isotilew,-0.5 + h / isotilew	,0, l,t)
+		gfx:RenderableIndex3(0,1,2)
+		gfx:RenderableIndex3(1,3,2)
+		gfx:RenderableEnd()
+		=

+	else
+		print("WARNING art id",iArtID,"not stored in atlas")
+	end
 end
 =

 function Renderer3D:RemoveDynamicItem( item )



From no-reply at zwischenwelt.org  Sun Mar 23 16:54:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 23 Mar 2008 15:54:29 -0000
Subject: [Iris-commit] [IRIS] r1981 -
	/trunk/data/models/textures/tex_grass_alpha.png
Message-ID: <20080323155429.57FCE152402A@zwischenwelt.org>

Author: sience
Date: Sun Mar 23 16:54:28 2008
New Revision: 1981

Log:
-obsolete

Removed:
    trunk/data/models/textures/tex_grass_alpha.png



From no-reply at zwischenwelt.org  Sun Mar 23 17:03:50 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 23 Mar 2008 16:03:50 -0000
Subject: [Iris-commit] [IRIS] r1982 -
	/trunk/data/models/models/textures_skipped_in_atlas.txt
Message-ID: <20080323160350.BA913152402A@zwischenwelt.org>

Author: sience
Date: Sun Mar 23 17:03:49 2008
New Revision: 1982

Log:
-small update

Modified:
    trunk/data/models/models/textures_skipped_in_atlas.txt

Modified: trunk/data/models/models/textures_skipped_in_atlas.txt
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/models/textures_skipped_in_atlas.txt (original)
+++ trunk/data/models/models/textures_skipped_in_atlas.txt Sun Mar 23 17:03=
:49 2008
@@ -1,3 +1,2 @@
 tex_grass
 tex_fernleaf
-firneedle_texture



From no-reply at zwischenwelt.org  Sun Mar 23 17:10:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 23 Mar 2008 16:10:49 -0000
Subject: [Iris-commit] [IRIS] r1983 -
	/trunk/data/models/textures/tex_grass.png
Message-ID: <20080323161050.90643152402A@zwischenwelt.org>

Author: sience
Date: Sun Mar 23 17:10:47 2008
New Revision: 1983

Log:
-grass texture converted to 256x256 not 253x253

Modified:
    trunk/data/models/textures/tex_grass.png

Modified: trunk/data/models/textures/tex_grass.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Mar 23 17:30:48 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 23 Mar 2008 16:30:48 -0000
Subject: [Iris-commit] [IRIS] r1984 -
	/trunk/data/models/materials/textures.material
Message-ID: <20080323163049.1D869152402A@zwischenwelt.org>

Author: sience
Date: Sun Mar 23 17:30:48 2008
New Revision: 1984

Log:
-some material corrections

Modified:
    trunk/data/models/materials/textures.material

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Sun Mar 23 17:30:48 2008
@@ -8103,9 +8103,6 @@
 	{
 		pass =

 		{
-			cull_hardware clockwise
-			cull_software back
-		=

 			texture_unit =

 			{
 				texture armoire_2637.png
@@ -8120,9 +8117,6 @@
 	{
 		pass =

 		{
-			cull_hardware clockwise
-			cull_software back
-
 			texture_unit =

 			{
 				texture armoire_2639.png
@@ -8132,12 +8126,13 @@
 }
 =

 =

-material tex_5351 : tex_base =

-{ =

-	technique =

-	{ =

-		pass =

-		{		=

+material tex_5351
+// : tex_base =

+{ =

+	technique =

+	{ =

+		pass =

+		{
 			texture_unit =

 			{ =

 				texture tex_5351.png =

@@ -8150,7 +8145,7 @@
 	technique =

 	{ =

 		pass =

-		{		=

+		{
 			texture_unit =

 			{ =

 				texture tex_5634.png =

@@ -8337,9 +8332,6 @@
 		pass
 		{
 			alpha_rejection greater_equal 55
-//			scene_blend alpha_blend
-//			depth_write off
-//			depth_check on
 =

 			texture_unit
 			{



From no-reply at zwischenwelt.org  Mon Mar 24 11:15:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 24 Mar 2008 10:15:03 -0000
Subject: [Iris-commit] [IRIS] r1986 -
	/trunk/data/models/materials/textures.material
Message-ID: <20080324101504.122641C184C9@zwischenwelt.org>

Author: sience
Date: Mon Mar 24 11:15:03 2008
New Revision: 1986

Log:
-some material optimizations (bloodspot & spiderweb)

Modified:
    trunk/data/models/materials/textures.material

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Mon Mar 24 11:15:03 2008
@@ -4387,7 +4387,7 @@
 	} =

 }
 =

-material tex_378 : tex_base_alpha =

+material tex_378 : tex_base_sceneblend =

 { =

 	technique =

 	{ =

@@ -4401,7 +4401,7 @@
 	} =

 }
 =

-material tex_379 : tex_base_alpha =

+material tex_379 : tex_base_sceneblend =

 { =

 	technique =

 	{ =

@@ -8055,12 +8055,13 @@
 	} =

 }
 =

-material tex_996 : tex_base_alpha
+material tex_996 : tex_base_sceneblend
 { =

 	technique
 	{ =

 		pass =

-		{		=

+		{
+			depth_bias 5
 			texture_unit =

 			{ =

 				texture blood.png
@@ -8069,12 +8070,13 @@
 	} =

 }
 =

-material tex_997 : tex_base_alpha
+material tex_997 : tex_base_sceneblend
 { =

 	technique
 	{ =

 		pass =

-		{		=

+		{
+			depth_bias 5
 			texture_unit =

 			{ =

 				texture blood_spot.png



From no-reply at zwischenwelt.org  Mon Mar 24 18:19:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 24 Mar 2008 17:19:36 -0000
Subject: [Iris-commit] [IRIS] r1987 - in /trunk/data/models: materials/
 models/to_004000/ models/to_012000/ textures/
Message-ID: <20080324171936.E3200152402A@zwischenwelt.org>

Author: hagish
Date: Mon Mar 24 18:19:35 2008
New Revision: 1987

Log:
added some new models

Added:
    trunk/data/models/models/to_004000/mdl_003895.mesh   (with props)
    trunk/data/models/models/to_012000/mdl_010762.mesh   (with props)
    trunk/data/models/models/to_012000/mdl_010763.mesh   (with props)
    trunk/data/models/models/to_012000/mdl_010764.mesh   (with props)
    trunk/data/models/models/to_012000/mdl_011767.mesh   (with props)
    trunk/data/models/models/to_012000/mdl_011768.mesh   (with props)
    trunk/data/models/models/to_012000/mdl_011769.mesh   (with props)
    trunk/data/models/models/to_012000/mdl_011770.mesh   (with props)
    trunk/data/models/textures/tex_marblewall.png   (with props)
    trunk/data/models/textures/tex_sattel.png   (with props)
Modified:
    trunk/data/models/materials/textures.material

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Mon Mar 24 18:19:35 2008
@@ -8285,6 +8285,33 @@
 	} =

 }
 =

+material tex_marblewall : tex_base
+{ =

+	technique =

+	{ =

+		pass =

+		{		=

+			texture_unit =

+			{ =

+				texture tex_marblewall.png =

+			}	=

+		}
+	} =

+}
+material tex_sattel : tex_base
+{ =

+	technique =

+	{ =

+		pass =

+		{		=

+			texture_unit =

+			{ =

+				texture tex_sattel.png =

+			}	=

+		}
+	} =

+}
+
 material fern : tex_base_sceneblend
 { =

 	technique =




From no-reply at zwischenwelt.org  Tue Mar 25 00:58:15 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 24 Mar 2008 23:58:15 -0000
Subject: [Iris-commit] [IRIS] r1988 - in /trunk: bin/iris2.exe lua/main.lua
Message-ID: <20080325000006.0807F1C181B7@zwischenwelt.org>

Author: sience
Date: Tue Mar 25 00:58:13 2008
New Revision: 1988

Log:
-new win32 binary (fix for fastbatch)
-custom material fix, should be loaded before normal materials

Modified:
    trunk/bin/iris2.exe
    trunk/lua/main.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Mar 25 00:58:13 2008
@@ -179,6 +179,9 @@
 	OgreAddResLoc(mydatapath.."guis/gorgui"					,"FileSystem","General")
 	OgreAddResLoc(mydatapath.."guis/naked"					,"FileSystem","General")
 =

+	--~ # custom materials
+	OgreAddResLoc(mydatapath.."custom/materials"			,"FileSystem","General")
+
 	--~ # distributet models
 	OgreAddResLoc(mydatapath.."models/materials"			,"FileSystem","General")
 	OgreAddResLoc(mydatapath.."models/meta"					,"FileSystem","General")
@@ -187,7 +190,6 @@
 	OgreAddResLoc(mydatapath.."models/atlas"				,"FileSystem","General")
 =

 	--~ # custom models
-	OgreAddResLoc(mydatapath.."custom/materials"			,"FileSystem","General")
 	OgreAddResLoc(mydatapath.."custom/models"				,"FileSystem","General")
 	OgreAddResLoc(mydatapath.."custom/textures"				,"FileSystem","General")
 =




From no-reply at zwischenwelt.org  Tue Mar 25 10:15:17 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 09:15:17 -0000
Subject: [Iris-commit] [IRIS] r1989 - in /rawdata/sd_pd: houseparts.blend
 tex_marblewall.png tex_sattel.png
Message-ID: <20080325100007.1BCA91C185EA@zwischenwelt.org>

Author: hagish
Date: Tue Mar 25 10:15:17 2008
New Revision: 1989

Log:
updated model file

Added:
    rawdata/sd_pd/tex_marblewall.png   (with props)
    rawdata/sd_pd/tex_sattel.png   (with props)
Modified:
    rawdata/sd_pd/houseparts.blend

Modified: rawdata/sd_pd/houseparts.blend
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Tue Mar 25 10:29:15 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 09:29:15 -0000
Subject: [Iris-commit] [IRIS] r1990 - in /trunk/lua: lib.3d.map.lua
	lib.tilefreewalk.lua
Message-ID: <20080325100007.27F0D1C18635@zwischenwelt.org>

Author: hagish
Date: Tue Mar 25 10:29:14 2008
New Revision: 1990

Log:
blend out upper floors in offline mode

Modified:
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.tilefreewalk.lua

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Tue Mar 25 10:29:14 2008
@@ -4,7 +4,7 @@
 Renderer3D.giMapOriginY =3D 0
 Renderer3D.ROBMAP_CHUNK_SIZE =3D 2  -- size of one chunk, should be 2^n
 Renderer3D.ROBMAP_RECENTER_DIST =3D 200   -- if cur position is off by mor=
e than ROBMAP_RECENTER_DIST blocks, clear cache and recenter
-Renderer3D.giBlendOutPlayerHeight =3D 18	--eriminator: es galt grob, alles=
 was 18z =C3=BCberm char war wurd ausgebledent
+Renderer3D.giBlendOutPlayerHeight =3D 18	--eriminator: es galt grob, alles=
 was 18z =C3=AF=C2=BF=C2=BDberm char war wurd ausgebledent
 Renderer3D.giBlendOutCurZ =3D nil
 Renderer3D.gbBlendOutTerrainVisible =3D true
 Renderer3D.gMapUpdateInterval =3D 100 -- update the map not every frame, d=
ecrease for fly-videos
@@ -602,13 +602,14 @@
 -- TODO: blend out mounts
 function Renderer3D:BlendOutLayersAbovePlayer ()
 	local x,y,z =3D GetPlayerPos()
+	=

 	if (not z or not gStaticBlockLoader or not gGroundBlockLoader) then retur=
n end
 	=

 	--[[
-	osi =3D wenn dach min 18z h=C3=B6her als char, dann alles von zdach aufw=
=C3=A4rts ausblenden
-	atm blendet iris statics aus, die 10 =C3=BCber dem char liegen
-	man geht in eine halle die ne art tronsaal sein soll, und hat keine hohen=
 w=C3=A4nde, sondern ne sandkasten umrandung ^^
-	ich  hab f=C3=BCr iris h=C3=B6her gebaut als normal uo etagen vorsah, bei=
 osi war 20die h=C3=B6he f=C3=BCr ne wand, =

+	osi =3D wenn dach min 18z h=C3=AF=C2=BF=C2=BDher als char, dann alles von=
 zdach aufw=C3=AF=C2=BF=C2=BDrts ausblenden
+	atm blendet iris statics aus, die 10 =C3=AF=C2=BF=C2=BDber dem char liegen
+	man geht in eine halle die ne art tronsaal sein soll, und hat keine hohen=
 w=C3=AF=C2=BF=C2=BDnde, sondern ne sandkasten umrandung ^^
+	ich  hab f=C3=AF=C2=BF=C2=BDr iris h=C3=AF=C2=BF=C2=BDher gebaut als norm=
al uo etagen vorsah, bei osi war 20die h=C3=AF=C2=BF=C2=BDhe f=C3=AF=C2=BF=
=C2=BDr ne wand, =

 	]]--
 	=

 	local playerheadpos =3D z + self.giBlendOutPlayerHeight

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Tue Mar 25 10:29:14 2008
@@ -553,6 +553,15 @@
 		gTileFreeTestBodyGfx:SetState(bMoving,bTurning,bWarMode,bRunFlag)
 		gTileFreeTestBodyGfx.modelgfx:SetPosition(x,y,z)
 		gTileFreeTestBodyGfx.modelgfx:SetOrientation(qw,qx,qy,qz)
+		=

+		-- handle offline blend out
+		gCurrentRenderer:BlendOutLayersAbovePlayer()
+		gPlayerXLoc,gPlayerYLoc,gPlayerZLoc =3D Renderer3D:LocalToUOPos(x,y,z * =
10)
+		=

+		gPlayerXLoc =3D math.floor(gPlayerXLoc)
+		gPlayerYLoc =3D math.floor(gPlayerYLoc)
+		gPlayerZLoc =3D math.floor(gPlayerZLoc)
+		=

 	else -- online mode, set mobile pos
 		local mobile =3D GetPlayerMobile()
 		if (mobile) then =




From no-reply at zwischenwelt.org  Tue Mar 25 11:38:52 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 10:38:52 -0000
Subject: [Iris-commit] [IRIS] r1991 - in /trunk:
 data/models/materials/textures.material
 data/models/models/to_004000/mdl_003752.mesh
 data/models/textures/tex_portrait.png data/skippedfallbacks.lua
 lua/filter/filter.art.lua lua/lib.mainmenu.lua lua/lib.static.lua
 lua/main.lua
Message-ID: <20080325103852.647E31C18072@zwischenwelt.org>

Author: hagish
Date: Tue Mar 25 11:38:51 2008
New Revision: 1991

Log:
added new models: portrait

Added:
    trunk/data/models/models/to_004000/mdl_003752.mesh   (with props)
    trunk/data/models/textures/tex_portrait.png   (with props)
Modified:
    trunk/data/models/materials/textures.material
    trunk/data/skippedfallbacks.lua
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.static.lua
    trunk/lua/main.lua

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Tue Mar 25 11:38:51 2008
@@ -8298,6 +8298,7 @@
 		}
 	} =

 }
+
 material tex_sattel : tex_base
 { =

 	technique =

@@ -8307,6 +8308,20 @@
 			texture_unit =

 			{ =

 				texture tex_sattel.png =

+			}	=

+		}
+	} =

+}
+
+material tex_portrait : tex_base
+{ =

+	technique =

+	{ =

+		pass =

+		{		=

+			texture_unit =

+			{ =

+				texture tex_portrait.png =

 			}	=

 		}
 	} =


Modified: trunk/data/skippedfallbacks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/skippedfallbacks.lua (original)
+++ trunk/data/skippedfallbacks.lua Tue Mar 25 11:38:51 2008
@@ -425,4 +425,4 @@
 RegisterSkippedArtBillboardFallBack(3691) -- 0x0e6b name=3Dcannon
 RegisterSkippedArtBillboardFallBack(4564) -- 0x11d4 name=3Dbed
 RegisterSkippedArtBillboardFallBack(4565) -- 0x11d5 name=3Dbed
-RegisterSkippedArtBillboardFallBack(4563) -- 0x11d3 name=3Dbed
+RegisterSkippedArtBillboardFallBack(4563) -- 0x11d3 name=3Dbed

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Tue Mar 25 11:38:51 2008
@@ -1,5 +1,15 @@
 --here we map ArtIDs to another ID, Model, Mesh or we change tiledata entr=
y, add particles or skeletons
 gArtFilter =3D {}
+
+-- adds all the skipped meshes to the skip art fallback file
+function InitArtFilter	()
+	for k,v in pairs(gArtFilter) do
+		if v.skip then
+			print("SKIP",k,v)
+			RegisterSkippedArtBillboardFallBack(k)
+		end
+	end
+end
 =

 --FILTER: map Mesh to other Mesh
 function FilterMesh(iTranslatedTileTypeID)
@@ -178,6 +188,23 @@
 --plate
 gArtFilter[2519]=3D{xadd=3D0,yadd=3D0,zadd=3D0.34}
 =

+--chimney
+gArtFilter[2264]=3D{maptoid=3D2269}
+gArtFilter[2261]=3D{maptoid=3D2269}
+gArtFilter[2258]=3D{maptoid=3D2269}
+gArtFilter[2268]=3D{skip=3Dtrue}
+
+-- portrait
+gArtFilter[3784]=3D{maptoid=3D3752}
+gArtFilter[3785]=3D{maptoid=3D3752}
+gArtFilter[3749]=3D{maptoid=3D3752}
+gArtFilter[3750]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
+gArtFilter[3743]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
+gArtFilter[3744]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
+gArtFilter[3756]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
+gArtFilter[3757]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
+gArtFilter[3751]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
+
 ----------------------------------------------------------------------
 =

 -- Seasonal Dynamic & Static Art Translation (run tiles)	-- eventuell (iTi=
leTypeID + 16384)

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Tue Mar 25 11:38:51 2008
@@ -88,6 +88,8 @@
 end
 =

 local function StartOfflineMode ()
+	gDialog_IrisLogo:SetVisible(false)
+
 	gStartGameWithoutNetwork =3D true
 	MultiTexTerrain_NotifyMapChange()
 	=


Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Tue Mar 25 11:38:51 2008
@@ -97,7 +97,8 @@
 	-- dump missing models as images
 	if gDumpMissingModels then
 		local skip =3D gSkippedArtBillboardFallBacks[iTranslatedTileTypeID]
-		local filename =3D "missing/"..iTileTypeID..".png"
+		local filename =3D "missing/"..iTranslatedTileTypeID..".png"
+		local filename_unmapped =3D "missing/"..iTileTypeID..".png"
 		=

 		if not meshname and not skip and not file_exists(filename) and gArtMapLo=
ader then
 			print("dump missing art",iTranslatedTileTypeID,filename)
@@ -107,10 +108,17 @@
 				img:SaveAsFile(filename)
 			end
 			img:Destroy()
-		elseif (meshname or skip) and file_exists(filename) then
-			-- remove existing missing images
-			print("remove missing art image because there is now a model",iTranslat=
edTileTypeID,filename)
-			remove_file(filename)
+		elseif (meshname or skip) then
+			if file_exists(filename) then
+				-- remove existing missing images
+				print("remove missing art image because there is now a model",iTransla=
tedTileTypeID,filename)
+				remove_file(filename)
+			end
+			if file_exists(filename_unmapped) then
+				-- remove existing missing images
+				print("remove missing art image because there is now a model",iTileTyp=
eID,filename_unmapped)
+				remove_file(filename_unmapped)
+			end
 		end
 	end
 	=


Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Mar 25 11:38:51 2008
@@ -299,7 +299,9 @@
 	CreateIrisLogo()
 =

 	LoadBasicData()
-
+	=

+	InitArtFilter()
+	=

 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
 =

 	NotifyListener("Hook_PreLoad")



From no-reply at zwischenwelt.org  Tue Mar 25 15:48:40 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 14:48:40 -0000
Subject: [Iris-commit] [IRIS] r1992 - in /trunk: data/models/atlas/
 data/models/materials/ data/models/models/to_004000/ data/models/textures/
 lua/ lua/filter/
Message-ID: <20080325144840.C63261C18777@zwischenwelt.org>

Author: hagish
Date: Tue Mar 25 15:48:39 2008
New Revision: 1992

Log:
more models and improved display of ground part fallbacks

Added:
    trunk/data/models/models/to_004000/mdl_003805.mesh   (with props)
    trunk/data/models/models/to_004000/mdl_003810.mesh   (with props)
    trunk/data/models/textures/tex_gravestone_big.png   (with props)
    trunk/data/models/textures/tex_mud.png   (with props)
Modified:
    trunk/data/models/atlas/tex_atlas_alpha_low.lua
    trunk/data/models/atlas/tex_atlas_alpha_low0.png
    trunk/data/models/atlas/tex_atlas_alpha_med.lua
    trunk/data/models/atlas/tex_atlas_alpha_med1.png
    trunk/data/models/atlas/tex_atlas_alpha_ultralow.lua
    trunk/data/models/atlas/tex_atlas_alpha_ultralow0.png
    trunk/data/models/atlas/tex_atlas_low.lua
    trunk/data/models/atlas/tex_atlas_low1.png
    trunk/data/models/atlas/tex_atlas_med.lua
    trunk/data/models/atlas/tex_atlas_med2.png
    trunk/data/models/atlas/tex_atlas_med3.png
    trunk/data/models/atlas/tex_atlas_med4.png
    trunk/data/models/atlas/tex_atlas_ultralow.lua
    trunk/data/models/atlas/tex_atlas_ultralow0.png
    trunk/data/models/materials/textures.material
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.static.lua

Modified: trunk/data/models/atlas/tex_atlas_alpha_low.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_alpha_low.lua (original)
+++ trunk/data/models/atlas/tex_atlas_alpha_low.lua Tue Mar 25 15:48:39 2008
@@ -138,6 +138,7 @@
 TexAtlas_RegisterMatTransform('tex_521', 'tex_atlas_alpha_low0', 0.5273437=
5,0.49609375,0.58984375,0.55859375)
 TexAtlas_RegisterMatTransform('tex_2481', 'tex_atlas_alpha_low0', 0.597656=
25,0.49609375,0.66015625,0.55859375)
 TexAtlas_RegisterMatTransform('tex_flowers', 'tex_atlas_alpha_low0', 0.667=
96875,0.49609375,0.73046875,0.55859375)
+TexAtlas_RegisterMatTransform('tex_gravestone_big', 'tex_atlas_alpha_low0'=
, 0.73828125,0.49609375,0.80078125,0.55859375)
 TexAtlas_RegisterMatTransform('tex_163', 'tex_atlas_alpha_low0', 0.0039062=
5,0.56640625,0.06640625,0.59765625)
 TexAtlas_RegisterMatTransform('tex_172', 'tex_atlas_alpha_low0', 0.0742187=
5,0.56640625,0.13671875,0.59765625)
 TexAtlas_RegisterMatTransform('tex_155', 'tex_atlas_alpha_low0', 0.1445312=
5,0.56640625,0.20703125,0.59765625)

Modified: trunk/data/models/atlas/tex_atlas_alpha_low0.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/atlas/tex_atlas_alpha_med.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_alpha_med.lua (original)
+++ trunk/data/models/atlas/tex_atlas_alpha_med.lua Tue Mar 25 15:48:39 2008
@@ -108,6 +108,7 @@
 TexAtlas_RegisterMatTransform('tex_521', 'tex_atlas_alpha_med1', 0.0019531=
25,0.392578125,0.126953125,0.517578125)
 TexAtlas_RegisterMatTransform('tex_2481', 'tex_atlas_alpha_med1', 0.130859=
375,0.392578125,0.255859375,0.517578125)
 TexAtlas_RegisterMatTransform('tex_flowers', 'tex_atlas_alpha_med1', 0.259=
765625,0.392578125,0.384765625,0.517578125)
+TexAtlas_RegisterMatTransform('tex_gravestone_big', 'tex_atlas_alpha_med1'=
, 0.388671875,0.392578125,0.513671875,0.517578125)
 TexAtlas_RegisterMatTransform('tex_163', 'tex_atlas_alpha_med1', 0.0019531=
25,0.521484375,0.126953125,0.583984375)
 TexAtlas_RegisterMatTransform('tex_531', 'tex_atlas_alpha_med1', 0.1308593=
75,0.521484375,0.193359375,0.583984375)
 TexAtlas_RegisterMatTransform('tex_172', 'tex_atlas_alpha_med1', 0.1972656=
25,0.521484375,0.322265625,0.583984375)

Modified: trunk/data/models/atlas/tex_atlas_alpha_med1.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/atlas/tex_atlas_alpha_ultralow.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_alpha_ultralow.lua (original)
+++ trunk/data/models/atlas/tex_atlas_alpha_ultralow.lua Tue Mar 25 15:48:3=
9 2008
@@ -138,6 +138,7 @@
 TexAtlas_RegisterMatTransform('tex_521', 'tex_atlas_alpha_ultralow0', 0.36=
71875,0.2421875,0.3984375,0.2734375)
 TexAtlas_RegisterMatTransform('tex_2481', 'tex_atlas_alpha_ultralow0', 0.4=
140625,0.2421875,0.4453125,0.2734375)
 TexAtlas_RegisterMatTransform('tex_flowers', 'tex_atlas_alpha_ultralow0', =
0.4609375,0.2421875,0.4921875,0.2734375)
+TexAtlas_RegisterMatTransform('tex_gravestone_big', 'tex_atlas_alpha_ultra=
low0', 0.5078125,0.2421875,0.5390625,0.2734375)
 TexAtlas_RegisterMatTransform('tex_163', 'tex_atlas_alpha_ultralow0', 0.00=
78125,0.2890625,0.0390625,0.3046875)
 TexAtlas_RegisterMatTransform('tex_172', 'tex_atlas_alpha_ultralow0', 0.05=
46875,0.2890625,0.0859375,0.3046875)
 TexAtlas_RegisterMatTransform('tex_155', 'tex_atlas_alpha_ultralow0', 0.10=
15625,0.2890625,0.1328125,0.3046875)

Modified: trunk/data/models/atlas/tex_atlas_alpha_ultralow0.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/atlas/tex_atlas_low.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_low.lua (original)
+++ trunk/data/models/atlas/tex_atlas_low.lua Tue Mar 25 15:48:39 2008
@@ -335,18 +335,22 @@
 TexAtlas_RegisterMatTransform('tex_51', 'tex_atlas_low1', 0.35546875,0.503=
90625,0.38671875,0.56640625)
 TexAtlas_RegisterMatTransform('tex_16', 'tex_atlas_low1', 0.39453125,0.503=
90625,0.45703125,0.56640625)
 TexAtlas_RegisterMatTransform('tex_200', 'tex_atlas_low1', 0.46484375,0.50=
390625,0.52734375,0.56640625)
-TexAtlas_RegisterMatTransform('tex_405', 'tex_atlas_low1', 0.53515625,0.50=
390625,0.59765625,0.56640625)
-TexAtlas_RegisterMatTransform('tex_243', 'tex_atlas_low1', 0.60546875,0.50=
390625,0.66796875,0.56640625)
-TexAtlas_RegisterMatTransform('tex_324', 'tex_atlas_low1', 0.67578125,0.50=
390625,0.73828125,0.56640625)
-TexAtlas_RegisterMatTransform('tex_208', 'tex_atlas_low1', 0.74609375,0.50=
390625,0.80859375,0.56640625)
-TexAtlas_RegisterMatTransform('tex_5351', 'tex_atlas_low1', 0.81640625,0.5=
0390625,0.87890625,0.56640625)
-TexAtlas_RegisterMatTransform('tex_5634', 'tex_atlas_low1', 0.88671875,0.5=
0390625,0.94921875,0.56640625)
-TexAtlas_RegisterMatTransform('tex_mushroom', 'tex_atlas_low1', 0.00390625=
,0.57421875,0.06640625,0.63671875)
-TexAtlas_RegisterMatTransform('tex_mushroom2', 'tex_atlas_low1', 0.0742187=
5,0.57421875,0.13671875,0.63671875)
-TexAtlas_RegisterMatTransform('tex_slidingdoor', 'tex_atlas_low1', 0.14453=
125,0.57421875,0.20703125,0.63671875)
-TexAtlas_RegisterMatTransform('tex_lantern', 'tex_atlas_low1', 0.21484375,=
0.57421875,0.27734375,0.63671875)
-TexAtlas_RegisterMatTransform('tex_stoneplate', 'tex_atlas_low1', 0.285156=
25,0.57421875,0.34765625,0.63671875)
-TexAtlas_RegisterMatTransform('tex_rune1', 'tex_atlas_low1', 0.35546875,0.=
57421875,0.41796875,0.63671875)
+TexAtlas_RegisterMatTransform('tex_mud', 'tex_atlas_low1', 0.53515625,0.50=
390625,0.59765625,0.56640625)
+TexAtlas_RegisterMatTransform('tex_405', 'tex_atlas_low1', 0.60546875,0.50=
390625,0.66796875,0.56640625)
+TexAtlas_RegisterMatTransform('tex_243', 'tex_atlas_low1', 0.67578125,0.50=
390625,0.73828125,0.56640625)
+TexAtlas_RegisterMatTransform('tex_324', 'tex_atlas_low1', 0.74609375,0.50=
390625,0.80859375,0.56640625)
+TexAtlas_RegisterMatTransform('tex_208', 'tex_atlas_low1', 0.81640625,0.50=
390625,0.87890625,0.56640625)
+TexAtlas_RegisterMatTransform('tex_5351', 'tex_atlas_low1', 0.88671875,0.5=
0390625,0.94921875,0.56640625)
+TexAtlas_RegisterMatTransform('tex_5634', 'tex_atlas_low1', 0.00390625,0.5=
7421875,0.06640625,0.63671875)
+TexAtlas_RegisterMatTransform('tex_mushroom', 'tex_atlas_low1', 0.07421875=
,0.57421875,0.13671875,0.63671875)
+TexAtlas_RegisterMatTransform('tex_mushroom2', 'tex_atlas_low1', 0.1445312=
5,0.57421875,0.20703125,0.63671875)
+TexAtlas_RegisterMatTransform('tex_slidingdoor', 'tex_atlas_low1', 0.21484=
375,0.57421875,0.27734375,0.63671875)
+TexAtlas_RegisterMatTransform('tex_lantern', 'tex_atlas_low1', 0.28515625,=
0.57421875,0.34765625,0.63671875)
+TexAtlas_RegisterMatTransform('tex_stoneplate', 'tex_atlas_low1', 0.355468=
75,0.57421875,0.41796875,0.63671875)
+TexAtlas_RegisterMatTransform('tex_rune1', 'tex_atlas_low1', 0.42578125,0.=
57421875,0.48828125,0.63671875)
+TexAtlas_RegisterMatTransform('tex_marblewall', 'tex_atlas_low1', 0.496093=
75,0.57421875,0.55859375,0.63671875)
+TexAtlas_RegisterMatTransform('tex_sattel', 'tex_atlas_low1', 0.56640625,0=
.57421875,0.62890625,0.63671875)
+TexAtlas_RegisterMatTransform('tex_portrait', 'tex_atlas_low1', 0.63671875=
,0.57421875,0.69921875,0.63671875)
 TexAtlas_RegisterMatTransform('tex_483', 'tex_atlas_low1', 0.00390625,0.64=
453125,0.06640625,0.67578125)
 TexAtlas_RegisterMatTransform('tex_564', 'tex_atlas_low1', 0.07421875,0.64=
453125,0.13671875,0.67578125)
 TexAtlas_RegisterMatTransform('tex_286', 'tex_atlas_low1', 0.14453125,0.64=
453125,0.20703125,0.67578125)

Modified: trunk/data/models/atlas/tex_atlas_low1.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/atlas/tex_atlas_med.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_med.lua (original)
+++ trunk/data/models/atlas/tex_atlas_med.lua Tue Mar 25 15:48:39 2008
@@ -173,248 +173,252 @@
 TexAtlas_RegisterMatTransform('tex_277', 'tex_atlas_med2', 0.259765625,0.5=
21484375,0.384765625,0.646484375)
 TexAtlas_RegisterMatTransform('tex_51', 'tex_atlas_med2', 0.388671875,0.52=
1484375,0.451171875,0.646484375)
 TexAtlas_RegisterMatTransform('tex_16', 'tex_atlas_med2', 0.455078125,0.52=
1484375,0.580078125,0.646484375)
-TexAtlas_RegisterMatTransform('tex_405', 'tex_atlas_med2', 0.583984375,0.5=
21484375,0.708984375,0.646484375)
-TexAtlas_RegisterMatTransform('tex_5351', 'tex_atlas_med2', 0.712890625,0.=
521484375,0.837890625,0.646484375)
-TexAtlas_RegisterMatTransform('tex_5634', 'tex_atlas_med2', 0.841796875,0.=
521484375,0.966796875,0.646484375)
-TexAtlas_RegisterMatTransform('tex_mushroom', 'tex_atlas_med2', 0.00195312=
5,0.650390625,0.126953125,0.775390625)
-TexAtlas_RegisterMatTransform('tex_mushroom2', 'tex_atlas_med2', 0.1308593=
75,0.650390625,0.255859375,0.775390625)
-TexAtlas_RegisterMatTransform('tex_slidingdoor', 'tex_atlas_med2', 0.25976=
5625,0.650390625,0.384765625,0.775390625)
-TexAtlas_RegisterMatTransform('tex_lantern', 'tex_atlas_med2', 0.388671875=
,0.650390625,0.513671875,0.775390625)
-TexAtlas_RegisterMatTransform('tex_stoneplate', 'tex_atlas_med2', 0.517578=
125,0.650390625,0.642578125,0.775390625)
-TexAtlas_RegisterMatTransform('tex_483', 'tex_atlas_med2', 0.001953125,0.7=
79296875,0.126953125,0.841796875)
-TexAtlas_RegisterMatTransform('tex_564', 'tex_atlas_med2', 0.130859375,0.7=
79296875,0.255859375,0.841796875)
-TexAtlas_RegisterMatTransform('tex_367', 'tex_atlas_med2', 0.259765625,0.7=
79296875,0.322265625,0.841796875)
-TexAtlas_RegisterMatTransform('tex_286', 'tex_atlas_med2', 0.326171875,0.7=
79296875,0.451171875,0.841796875)
-TexAtlas_RegisterMatTransform('tex_333', 'tex_atlas_med2', 0.455078125,0.7=
79296875,0.517578125,0.841796875)
-TexAtlas_RegisterMatTransform('tex_171', 'tex_atlas_med2', 0.521484375,0.7=
79296875,0.646484375,0.841796875)
-TexAtlas_RegisterMatTransform('tex_136', 'tex_atlas_med2', 0.650390625,0.7=
79296875,0.775390625,0.841796875)
-TexAtlas_RegisterMatTransform('tex_217', 'tex_atlas_med2', 0.779296875,0.7=
79296875,0.841796875,0.841796875)
-TexAtlas_RegisterMatTransform('tex_342', 'tex_atlas_med2', 0.845703125,0.7=
79296875,0.908203125,0.841796875)
-TexAtlas_RegisterMatTransform('tex_145', 'tex_atlas_med2', 0.001953125,0.8=
45703125,0.126953125,0.908203125)
-TexAtlas_RegisterMatTransform('tex_226', 'tex_atlas_med2', 0.130859375,0.8=
45703125,0.193359375,0.908203125)
-TexAtlas_RegisterMatTransform('tex_307', 'tex_atlas_med2', 0.197265625,0.8=
45703125,0.259765625,0.908203125)
-TexAtlas_RegisterMatTransform('tex_188', 'tex_atlas_med2', 0.263671875,0.8=
45703125,0.326171875,0.908203125)
-TexAtlas_RegisterMatTransform('tex_154', 'tex_atlas_med2', 0.330078125,0.8=
45703125,0.455078125,0.908203125)
-TexAtlas_RegisterMatTransform('tex_235', 'tex_atlas_med2', 0.458984375,0.8=
45703125,0.521484375,0.908203125)
-TexAtlas_RegisterMatTransform('tex_316', 'tex_atlas_med2', 0.525390625,0.8=
45703125,0.587890625,0.908203125)
-TexAtlas_RegisterMatTransform('tex_556', 'tex_atlas_med2', 0.591796875,0.8=
45703125,0.654296875,0.908203125)
-TexAtlas_RegisterMatTransform('tex_197', 'tex_atlas_med2', 0.658203125,0.8=
45703125,0.720703125,0.908203125)
-TexAtlas_RegisterMatTransform('tex_201', 'tex_atlas_med2', 0.724609375,0.8=
45703125,0.787109375,0.908203125)
-TexAtlas_RegisterMatTransform('tex_325', 'tex_atlas_med2', 0.791015625,0.8=
45703125,0.853515625,0.908203125)
-TexAtlas_RegisterMatTransform('tex_244', 'tex_atlas_med2', 0.857421875,0.8=
45703125,0.919921875,0.908203125)
-TexAtlas_RegisterMatTransform('tex_209', 'tex_atlas_med2', 0.923828125,0.8=
45703125,0.986328125,0.908203125)
-TexAtlas_RegisterMatTransform('tex_128', 'tex_atlas_med2', 0.001953125,0.9=
12109375,0.126953125,0.974609375)
-TexAtlas_RegisterMatTransform('tex_484', 'tex_atlas_med2', 0.130859375,0.9=
12109375,0.255859375,0.974609375)
-TexAtlas_RegisterMatTransform('tex_368', 'tex_atlas_med2', 0.259765625,0.9=
12109375,0.322265625,0.974609375)
-TexAtlas_RegisterMatTransform('tex_26', 'tex_atlas_med2', 0.326171875,0.91=
2109375,0.388671875,0.974609375)
-TexAtlas_RegisterMatTransform('tex_210', 'tex_atlas_med2', 0.392578125,0.9=
12109375,0.455078125,0.974609375)
-TexAtlas_RegisterMatTransform('tex_334', 'tex_atlas_med2', 0.458984375,0.9=
12109375,0.521484375,0.974609375)
-TexAtlas_RegisterMatTransform('tex_137', 'tex_atlas_med2', 0.525390625,0.9=
12109375,0.650390625,0.974609375)
-TexAtlas_RegisterMatTransform('tex_493', 'tex_atlas_med2', 0.654296875,0.9=
12109375,0.716796875,0.974609375)
-TexAtlas_RegisterMatTransform('tex_70', 'tex_atlas_med2', 0.720703125,0.91=
2109375,0.845703125,0.974609375)
-TexAtlas_RegisterMatTransform('tex_343', 'tex_atlas_med2', 0.849609375,0.9=
12109375,0.912109375,0.974609375)
-TexAtlas_RegisterMatTransform('tex_146', 'tex_atlas_med3', 0.001953125,0.0=
05859375,0.126953125,0.068359375)
-TexAtlas_RegisterMatTransform('tex_227', 'tex_atlas_med3', 0.130859375,0.0=
05859375,0.193359375,0.068359375)
-TexAtlas_RegisterMatTransform('tex_308', 'tex_atlas_med3', 0.197265625,0.0=
05859375,0.259765625,0.068359375)
-TexAtlas_RegisterMatTransform('tex_386', 'tex_atlas_med3', 0.263671875,0.0=
05859375,0.326171875,0.068359375)
-TexAtlas_RegisterMatTransform('tex_189', 'tex_atlas_med3', 0.330078125,0.0=
05859375,0.392578125,0.068359375)
-TexAtlas_RegisterMatTransform('tex_190', 'tex_atlas_med3', 0.396484375,0.0=
05859375,0.458984375,0.068359375)
-TexAtlas_RegisterMatTransform('tex_236', 'tex_atlas_med3', 0.462890625,0.0=
05859375,0.525390625,0.068359375)
-TexAtlas_RegisterMatTransform('tex_317', 'tex_atlas_med3', 0.529296875,0.0=
05859375,0.591796875,0.068359375)
-TexAtlas_RegisterMatTransform('tex_198', 'tex_atlas_med3', 0.595703125,0.0=
05859375,0.658203125,0.068359375)
-TexAtlas_RegisterMatTransform('tex_202', 'tex_atlas_med3', 0.662109375,0.0=
05859375,0.724609375,0.068359375)
-TexAtlas_RegisterMatTransform('tex_121', 'tex_atlas_med3', 0.728515625,0.0=
05859375,0.791015625,0.068359375)
-TexAtlas_RegisterMatTransform('tex_326', 'tex_atlas_med3', 0.794921875,0.0=
05859375,0.857421875,0.068359375)
-TexAtlas_RegisterMatTransform('tex_245', 'tex_atlas_med3', 0.861328125,0.0=
05859375,0.923828125,0.068359375)
-TexAtlas_RegisterMatTransform('tex_129', 'tex_atlas_med3', 0.001953125,0.0=
72265625,0.126953125,0.134765625)
-TexAtlas_RegisterMatTransform('tex_369', 'tex_atlas_med3', 0.130859375,0.0=
72265625,0.193359375,0.134765625)
-TexAtlas_RegisterMatTransform('tex_27', 'tex_atlas_med3', 0.197265625,0.07=
2265625,0.259765625,0.134765625)
-TexAtlas_RegisterMatTransform('tex_2', 'tex_atlas_med3', 0.263671875,0.072=
265625,0.326171875,0.134765625)
-TexAtlas_RegisterMatTransform('tex_130', 'tex_atlas_med3', 0.330078125,0.0=
72265625,0.455078125,0.134765625)
-TexAtlas_RegisterMatTransform('tex_211', 'tex_atlas_med3', 0.458984375,0.0=
72265625,0.521484375,0.134765625)
-TexAtlas_RegisterMatTransform('tex_370', 'tex_atlas_med3', 0.525390625,0.0=
72265625,0.587890625,0.134765625)
-TexAtlas_RegisterMatTransform('tex_335', 'tex_atlas_med3', 0.591796875,0.0=
72265625,0.654296875,0.134765625)
-TexAtlas_RegisterMatTransform('tex_138', 'tex_atlas_med3', 0.658203125,0.0=
72265625,0.783203125,0.134765625)
-TexAtlas_RegisterMatTransform('tex_494', 'tex_atlas_med3', 0.787109375,0.0=
72265625,0.849609375,0.134765625)
-TexAtlas_RegisterMatTransform('tex_220', 'tex_atlas_med3', 0.853515625,0.0=
72265625,0.916015625,0.134765625)
-TexAtlas_RegisterMatTransform('tex_344', 'tex_atlas_med3', 0.919921875,0.0=
72265625,0.982421875,0.134765625)
-TexAtlas_RegisterMatTransform('tex_147', 'tex_atlas_med3', 0.001953125,0.1=
38671875,0.126953125,0.201171875)
-TexAtlas_RegisterMatTransform('tex_228', 'tex_atlas_med3', 0.130859375,0.1=
38671875,0.193359375,0.201171875)
-TexAtlas_RegisterMatTransform('tex_309', 'tex_atlas_med3', 0.197265625,0.1=
38671875,0.259765625,0.201171875)
-TexAtlas_RegisterMatTransform('tex_310', 'tex_atlas_med3', 0.263671875,0.1=
38671875,0.326171875,0.201171875)
-TexAtlas_RegisterMatTransform('tex_113', 'tex_atlas_med3', 0.330078125,0.1=
38671875,0.455078125,0.201171875)
-TexAtlas_RegisterMatTransform('tex_515', 'tex_atlas_med3', 0.458984375,0.1=
38671875,0.521484375,0.201171875)
-TexAtlas_RegisterMatTransform('tex_191', 'tex_atlas_med3', 0.525390625,0.1=
38671875,0.587890625,0.201171875)
-TexAtlas_RegisterMatTransform('tex_237', 'tex_atlas_med3', 0.591796875,0.1=
38671875,0.654296875,0.201171875)
-TexAtlas_RegisterMatTransform('tex_318', 'tex_atlas_med3', 0.658203125,0.1=
38671875,0.720703125,0.201171875)
-TexAtlas_RegisterMatTransform('tex_477', 'tex_atlas_med3', 0.724609375,0.1=
38671875,0.787109375,0.201171875)
-TexAtlas_RegisterMatTransform('tex_396', 'tex_atlas_med3', 0.791015625,0.1=
38671875,0.853515625,0.201171875)
-TexAtlas_RegisterMatTransform('tex_199', 'tex_atlas_med3', 0.857421875,0.1=
38671875,0.919921875,0.201171875)
-TexAtlas_RegisterMatTransform('tex_400', 'tex_atlas_med3', 0.923828125,0.1=
38671875,0.986328125,0.201171875)
-TexAtlas_RegisterMatTransform('tex_203', 'tex_atlas_med3', 0.001953125,0.2=
05078125,0.064453125,0.267578125)
-TexAtlas_RegisterMatTransform('tex_524', 'tex_atlas_med3', 0.068359375,0.2=
05078125,0.130859375,0.267578125)
-TexAtlas_RegisterMatTransform('tex_327', 'tex_atlas_med3', 0.134765625,0.2=
05078125,0.197265625,0.267578125)
-TexAtlas_RegisterMatTransform('tex_246', 'tex_atlas_med3', 0.201171875,0.2=
05078125,0.263671875,0.267578125)
-TexAtlas_RegisterMatTransform('tex_131', 'tex_atlas_med3', 0.267578125,0.2=
05078125,0.392578125,0.267578125)
-TexAtlas_RegisterMatTransform('tex_212', 'tex_atlas_med3', 0.396484375,0.2=
05078125,0.458984375,0.267578125)
-TexAtlas_RegisterMatTransform('tex_371', 'tex_atlas_med3', 0.462890625,0.2=
05078125,0.525390625,0.267578125)
-TexAtlas_RegisterMatTransform('tex_336', 'tex_atlas_med3', 0.529296875,0.2=
05078125,0.591796875,0.267578125)
-TexAtlas_RegisterMatTransform('tex_139', 'tex_atlas_med3', 0.595703125,0.2=
05078125,0.720703125,0.267578125)
-TexAtlas_RegisterMatTransform('tex_495', 'tex_atlas_med3', 0.724609375,0.2=
05078125,0.787109375,0.267578125)
-TexAtlas_RegisterMatTransform('tex_140', 'tex_atlas_med3', 0.791015625,0.2=
05078125,0.916015625,0.267578125)
-TexAtlas_RegisterMatTransform('tex_221', 'tex_atlas_med3', 0.919921875,0.2=
05078125,0.982421875,0.267578125)
-TexAtlas_RegisterMatTransform('tex_461', 'tex_atlas_med3', 0.001953125,0.2=
71484375,0.033203125,0.333984375)
-TexAtlas_RegisterMatTransform('tex_345', 'tex_atlas_med3', 0.037109375,0.2=
71484375,0.099609375,0.333984375)
-TexAtlas_RegisterMatTransform('tex_183', 'tex_atlas_med3', 0.103515625,0.2=
71484375,0.166015625,0.333984375)
-TexAtlas_RegisterMatTransform('tex_148', 'tex_atlas_med3', 0.169921875,0.2=
71484375,0.294921875,0.333984375)
-TexAtlas_RegisterMatTransform('tex_229', 'tex_atlas_med3', 0.298828125,0.2=
71484375,0.361328125,0.333984375)
-TexAtlas_RegisterMatTransform('tex_230', 'tex_atlas_med3', 0.365234375,0.2=
71484375,0.427734375,0.333984375)
-TexAtlas_RegisterMatTransform('tex_311', 'tex_atlas_med3', 0.431640625,0.2=
71484375,0.494140625,0.333984375)
-TexAtlas_RegisterMatTransform('tex_551', 'tex_atlas_med3', 0.498046875,0.2=
71484375,0.560546875,0.333984375)
-TexAtlas_RegisterMatTransform('tex_516', 'tex_atlas_med3', 0.564453125,0.2=
71484375,0.626953125,0.333984375)
-TexAtlas_RegisterMatTransform('tex_192', 'tex_atlas_med3', 0.630859375,0.2=
71484375,0.693359375,0.333984375)
-TexAtlas_RegisterMatTransform('tex_157', 'tex_atlas_med3', 0.697265625,0.2=
71484375,0.822265625,0.333984375)
-TexAtlas_RegisterMatTransform('tex_238', 'tex_atlas_med3', 0.826171875,0.2=
71484375,0.888671875,0.333984375)
-TexAtlas_RegisterMatTransform('tex_319', 'tex_atlas_med3', 0.892578125,0.2=
71484375,0.955078125,0.333984375)
-TexAtlas_RegisterMatTransform('tex_397', 'tex_atlas_med3', 0.001953125,0.3=
37890625,0.064453125,0.400390625)
-TexAtlas_RegisterMatTransform('tex_401', 'tex_atlas_med3', 0.068359375,0.3=
37890625,0.130859375,0.400390625)
-TexAtlas_RegisterMatTransform('tex_320', 'tex_atlas_med3', 0.134765625,0.3=
37890625,0.197265625,0.400390625)
-TexAtlas_RegisterMatTransform('tex_204', 'tex_atlas_med3', 0.201171875,0.3=
37890625,0.263671875,0.400390625)
-TexAtlas_RegisterMatTransform('tex_525', 'tex_atlas_med3', 0.267578125,0.3=
37890625,0.330078125,0.400390625)
-TexAtlas_RegisterMatTransform('tex_409', 'tex_atlas_med3', 0.333984375,0.3=
37890625,0.458984375,0.400390625)
-TexAtlas_RegisterMatTransform('tex_328', 'tex_atlas_med3', 0.462890625,0.3=
37890625,0.525390625,0.400390625)
-TexAtlas_RegisterMatTransform('tex_166', 'tex_atlas_med3', 0.529296875,0.3=
37890625,0.654296875,0.400390625)
-TexAtlas_RegisterMatTransform('tex_132', 'tex_atlas_med3', 0.658203125,0.3=
37890625,0.783203125,0.400390625)
-TexAtlas_RegisterMatTransform('tex_213', 'tex_atlas_med3', 0.787109375,0.3=
37890625,0.849609375,0.400390625)
-TexAtlas_RegisterMatTransform('tex_453', 'tex_atlas_med3', 0.853515625,0.3=
37890625,0.916015625,0.400390625)
-TexAtlas_RegisterMatTransform('tex_337', 'tex_atlas_med3', 0.919921875,0.3=
37890625,0.982421875,0.400390625)
-TexAtlas_RegisterMatTransform('tex_256', 'tex_atlas_med3', 0.001953125,0.4=
04296875,0.126953125,0.466796875)
-TexAtlas_RegisterMatTransform('tex_496', 'tex_atlas_med3', 0.130859375,0.4=
04296875,0.193359375,0.466796875)
-TexAtlas_RegisterMatTransform('tex_141', 'tex_atlas_med3', 0.197265625,0.4=
04296875,0.322265625,0.466796875)
-TexAtlas_RegisterMatTransform('tex_222', 'tex_atlas_med3', 0.326171875,0.4=
04296875,0.388671875,0.466796875)
-TexAtlas_RegisterMatTransform('tex_303', 'tex_atlas_med3', 0.392578125,0.4=
04296875,0.455078125,0.466796875)
-TexAtlas_RegisterMatTransform('tex_462', 'tex_atlas_med3', 0.458984375,0.4=
04296875,0.490234375,0.466796875)
-TexAtlas_RegisterMatTransform('tex_184', 'tex_atlas_med3', 0.494140625,0.4=
04296875,0.556640625,0.466796875)
-TexAtlas_RegisterMatTransform('tex_149', 'tex_atlas_med3', 0.560546875,0.4=
04296875,0.685546875,0.466796875)
-TexAtlas_RegisterMatTransform('tex_150', 'tex_atlas_med3', 0.689453125,0.4=
04296875,0.814453125,0.466796875)
-TexAtlas_RegisterMatTransform('tex_231', 'tex_atlas_med3', 0.818359375,0.4=
04296875,0.880859375,0.466796875)
-TexAtlas_RegisterMatTransform('tex_312', 'tex_atlas_med3', 0.884765625,0.4=
04296875,0.947265625,0.466796875)
-TexAtlas_RegisterMatTransform('tex_517', 'tex_atlas_med3', 0.001953125,0.4=
70703125,0.064453125,0.533203125)
-TexAtlas_RegisterMatTransform('tex_193', 'tex_atlas_med3', 0.068359375,0.4=
70703125,0.130859375,0.533203125)
-TexAtlas_RegisterMatTransform('tex_158', 'tex_atlas_med3', 0.134765625,0.4=
70703125,0.259765625,0.533203125)
-TexAtlas_RegisterMatTransform('tex_239', 'tex_atlas_med3', 0.263671875,0.4=
70703125,0.326171875,0.533203125)
-TexAtlas_RegisterMatTransform('tex_479', 'tex_atlas_med3', 0.330078125,0.4=
70703125,0.392578125,0.533203125)
-TexAtlas_RegisterMatTransform('tex_398', 'tex_atlas_med3', 0.396484375,0.4=
70703125,0.458984375,0.533203125)
-TexAtlas_RegisterMatTransform('tex_402', 'tex_atlas_med3', 0.462890625,0.4=
70703125,0.525390625,0.533203125)
-TexAtlas_RegisterMatTransform('tex_240', 'tex_atlas_med3', 0.529296875,0.4=
70703125,0.591796875,0.533203125)
-TexAtlas_RegisterMatTransform('tex_321', 'tex_atlas_med3', 0.595703125,0.4=
70703125,0.658203125,0.533203125)
-TexAtlas_RegisterMatTransform('tex_205', 'tex_atlas_med3', 0.662109375,0.4=
70703125,0.724609375,0.533203125)
-TexAtlas_RegisterMatTransform('tex_124', 'tex_atlas_med3', 0.728515625,0.4=
70703125,0.853515625,0.533203125)
-TexAtlas_RegisterMatTransform('tex_561', 'tex_atlas_med3', 0.857421875,0.4=
70703125,0.982421875,0.533203125)
-TexAtlas_RegisterMatTransform('tex_526', 'tex_atlas_med3', 0.001953125,0.5=
37109375,0.064453125,0.599609375)
-TexAtlas_RegisterMatTransform('tex_329', 'tex_atlas_med3', 0.068359375,0.5=
37109375,0.130859375,0.599609375)
-TexAtlas_RegisterMatTransform('tex_167', 'tex_atlas_med3', 0.134765625,0.5=
37109375,0.259765625,0.599609375)
-TexAtlas_RegisterMatTransform('tex_22', 'tex_atlas_med3', 0.263671875,0.53=
7109375,0.326171875,0.599609375)
-TexAtlas_RegisterMatTransform('tex_330', 'tex_atlas_med3', 0.330078125,0.5=
37109375,0.392578125,0.599609375)
-TexAtlas_RegisterMatTransform('tex_133', 'tex_atlas_med3', 0.396484375,0.5=
37109375,0.521484375,0.599609375)
-TexAtlas_RegisterMatTransform('tex_214', 'tex_atlas_med3', 0.525390625,0.5=
37109375,0.587890625,0.599609375)
-TexAtlas_RegisterMatTransform('tex_338', 'tex_atlas_med3', 0.591796875,0.5=
37109375,0.654296875,0.599609375)
-TexAtlas_RegisterMatTransform('tex_142', 'tex_atlas_med3', 0.658203125,0.5=
37109375,0.783203125,0.599609375)
-TexAtlas_RegisterMatTransform('tex_223', 'tex_atlas_med3', 0.787109375,0.5=
37109375,0.849609375,0.599609375)
-TexAtlas_RegisterMatTransform('tex_304', 'tex_atlas_med3', 0.853515625,0.5=
37109375,0.916015625,0.599609375)
-TexAtlas_RegisterMatTransform('tex_463', 'tex_atlas_med3', 0.919921875,0.5=
37109375,0.982421875,0.599609375)
-TexAtlas_RegisterMatTransform('tex_185', 'tex_atlas_med3', 0.001953125,0.6=
03515625,0.064453125,0.666015625)
-TexAtlas_RegisterMatTransform('tex_232', 'tex_atlas_med3', 0.068359375,0.6=
03515625,0.130859375,0.666015625)
-TexAtlas_RegisterMatTransform('tex_313', 'tex_atlas_med3', 0.134765625,0.6=
03515625,0.197265625,0.666015625)
-TexAtlas_RegisterMatTransform('tex_194', 'tex_atlas_med3', 0.201171875,0.6=
03515625,0.263671875,0.666015625)
-TexAtlas_RegisterMatTransform('tex_159', 'tex_atlas_med3', 0.267578125,0.6=
03515625,0.392578125,0.666015625)
-TexAtlas_RegisterMatTransform('tex_399', 'tex_atlas_med3', 0.396484375,0.6=
03515625,0.458984375,0.666015625)
-TexAtlas_RegisterMatTransform('tex_403', 'tex_atlas_med3', 0.462890625,0.6=
03515625,0.587890625,0.666015625)
-TexAtlas_RegisterMatTransform('tex_241', 'tex_atlas_med3', 0.591796875,0.6=
03515625,0.654296875,0.666015625)
-TexAtlas_RegisterMatTransform('tex_322', 'tex_atlas_med3', 0.658203125,0.6=
03515625,0.720703125,0.666015625)
-TexAtlas_RegisterMatTransform('tex_206', 'tex_atlas_med3', 0.724609375,0.6=
03515625,0.787109375,0.666015625)
-TexAtlas_RegisterMatTransform('tex_125', 'tex_atlas_med3', 0.791015625,0.6=
03515625,0.916015625,0.666015625)
-TexAtlas_RegisterMatTransform('tex_168', 'tex_atlas_med3', 0.001953125,0.6=
69921875,0.126953125,0.732421875)
-TexAtlas_RegisterMatTransform('tex_23', 'tex_atlas_med3', 0.130859375,0.66=
9921875,0.255859375,0.732421875)
-TexAtlas_RegisterMatTransform('tex_331', 'tex_atlas_med3', 0.259765625,0.6=
69921875,0.322265625,0.732421875)
-TexAtlas_RegisterMatTransform('tex_134', 'tex_atlas_med3', 0.326171875,0.6=
69921875,0.451171875,0.732421875)
-TexAtlas_RegisterMatTransform('tex_215', 'tex_atlas_med3', 0.455078125,0.6=
69921875,0.517578125,0.732421875)
-TexAtlas_RegisterMatTransform('tex_571', 'tex_atlas_med3', 0.521484375,0.6=
69921875,0.646484375,0.732421875)
-TexAtlas_RegisterMatTransform('tex_339', 'tex_atlas_med3', 0.650390625,0.6=
69921875,0.712890625,0.732421875)
-TexAtlas_RegisterMatTransform('tex_258', 'tex_atlas_med3', 0.716796875,0.6=
69921875,0.779296875,0.732421875)
-TexAtlas_RegisterMatTransform('tex_340', 'tex_atlas_med3', 0.783203125,0.6=
69921875,0.845703125,0.732421875)
-TexAtlas_RegisterMatTransform('tex_143', 'tex_atlas_med3', 0.849609375,0.6=
69921875,0.974609375,0.732421875)
-TexAtlas_RegisterMatTransform('tex_224', 'tex_atlas_med3', 0.001953125,0.7=
36328125,0.064453125,0.798828125)
-TexAtlas_RegisterMatTransform('tex_305', 'tex_atlas_med3', 0.068359375,0.7=
36328125,0.130859375,0.798828125)
-TexAtlas_RegisterMatTransform('tex_464', 'tex_atlas_med3', 0.134765625,0.7=
36328125,0.197265625,0.798828125)
-TexAtlas_RegisterMatTransform('tex_186', 'tex_atlas_med3', 0.201171875,0.7=
36328125,0.263671875,0.798828125)
-TexAtlas_RegisterMatTransform('tex_152', 'tex_atlas_med3', 0.267578125,0.7=
36328125,0.392578125,0.798828125)
-TexAtlas_RegisterMatTransform('tex_233', 'tex_atlas_med3', 0.396484375,0.7=
36328125,0.458984375,0.798828125)
-TexAtlas_RegisterMatTransform('tex_314', 'tex_atlas_med3', 0.462890625,0.7=
36328125,0.525390625,0.798828125)
-TexAtlas_RegisterMatTransform('tex_195', 'tex_atlas_med3', 0.529296875,0.7=
36328125,0.591796875,0.798828125)
-TexAtlas_RegisterMatTransform('tex_161', 'tex_atlas_med3', 0.595703125,0.7=
36328125,0.720703125,0.798828125)
-TexAtlas_RegisterMatTransform('tex_242', 'tex_atlas_med3', 0.724609375,0.7=
36328125,0.787109375,0.798828125)
-TexAtlas_RegisterMatTransform('tex_323', 'tex_atlas_med3', 0.791015625,0.7=
36328125,0.853515625,0.798828125)
-TexAtlas_RegisterMatTransform('tex_207', 'tex_atlas_med3', 0.857421875,0.7=
36328125,0.919921875,0.798828125)
-TexAtlas_RegisterMatTransform('tex_126', 'tex_atlas_med3', 0.001953125,0.8=
02734375,0.126953125,0.865234375)
-TexAtlas_RegisterMatTransform('tex_366', 'tex_atlas_med3', 0.130859375,0.8=
02734375,0.193359375,0.865234375)
-TexAtlas_RegisterMatTransform('tex_169', 'tex_atlas_med3', 0.197265625,0.8=
02734375,0.322265625,0.865234375)
-TexAtlas_RegisterMatTransform('tex_332', 'tex_atlas_med3', 0.326171875,0.8=
02734375,0.388671875,0.865234375)
-TexAtlas_RegisterMatTransform('tex_170', 'tex_atlas_med3', 0.392578125,0.8=
02734375,0.517578125,0.865234375)
-TexAtlas_RegisterMatTransform('tex_251', 'tex_atlas_med3', 0.521484375,0.8=
02734375,0.646484375,0.865234375)
-TexAtlas_RegisterMatTransform('tex_135', 'tex_atlas_med3', 0.650390625,0.8=
02734375,0.775390625,0.865234375)
-TexAtlas_RegisterMatTransform('tex_216', 'tex_atlas_med3', 0.779296875,0.8=
02734375,0.841796875,0.865234375)
-TexAtlas_RegisterMatTransform('tex_572', 'tex_atlas_med3', 0.845703125,0.8=
02734375,0.970703125,0.865234375)
-TexAtlas_RegisterMatTransform('tex_259', 'tex_atlas_med3', 0.001953125,0.8=
69140625,0.064453125,0.931640625)
-TexAtlas_RegisterMatTransform('tex_33', 'tex_atlas_med3', 0.068359375,0.86=
9140625,0.130859375,0.931640625)
-TexAtlas_RegisterMatTransform('tex_260', 'tex_atlas_med3', 0.134765625,0.8=
69140625,0.197265625,0.931640625)
-TexAtlas_RegisterMatTransform('tex_144', 'tex_atlas_med3', 0.201171875,0.8=
69140625,0.326171875,0.931640625)
-TexAtlas_RegisterMatTransform('tex_225', 'tex_atlas_med3', 0.330078125,0.8=
69140625,0.392578125,0.931640625)
-TexAtlas_RegisterMatTransform('tex_306', 'tex_atlas_med3', 0.396484375,0.8=
69140625,0.458984375,0.931640625)
-TexAtlas_RegisterMatTransform('tex_465', 'tex_atlas_med3', 0.462890625,0.8=
69140625,0.525390625,0.931640625)
-TexAtlas_RegisterMatTransform('tex_187', 'tex_atlas_med3', 0.529296875,0.8=
69140625,0.591796875,0.931640625)
-TexAtlas_RegisterMatTransform('tex_110', 'tex_atlas_med3', 0.595703125,0.8=
69140625,0.720703125,0.931640625)
-TexAtlas_RegisterMatTransform('tex_234', 'tex_atlas_med3', 0.724609375,0.8=
69140625,0.787109375,0.931640625)
-TexAtlas_RegisterMatTransform('tex_315', 'tex_atlas_med3', 0.791015625,0.8=
69140625,0.853515625,0.931640625)
-TexAtlas_RegisterMatTransform('tex_555', 'tex_atlas_med3', 0.857421875,0.8=
69140625,0.919921875,0.931640625)
-TexAtlas_RegisterMatTransform('tex_474', 'tex_atlas_med3', 0.923828125,0.8=
69140625,0.986328125,0.931640625)
-TexAtlas_RegisterMatTransform('tex_196', 'tex_atlas_med3', 0.001953125,0.9=
35546875,0.064453125,0.998046875)
-TexAtlas_RegisterMatTransform('tex_200', 'tex_atlas_med3', 0.068359375,0.9=
35546875,0.130859375,0.998046875)
-TexAtlas_RegisterMatTransform('tex_162', 'tex_atlas_med3', 0.134765625,0.9=
35546875,0.259765625,0.998046875)
-TexAtlas_RegisterMatTransform('tex_243', 'tex_atlas_med3', 0.263671875,0.9=
35546875,0.326171875,0.998046875)
-TexAtlas_RegisterMatTransform('tex_324', 'tex_atlas_med3', 0.330078125,0.9=
35546875,0.392578125,0.998046875)
-TexAtlas_RegisterMatTransform('tex_208', 'tex_atlas_med3', 0.396484375,0.9=
35546875,0.458984375,0.998046875)
-TexAtlas_RegisterMatTransform('tex_127', 'tex_atlas_med3', 0.462890625,0.9=
35546875,0.587890625,0.998046875)
-TexAtlas_RegisterMatTransform('tex_25', 'tex_atlas_med4', 0.001953125,0.00=
5859375,0.064453125,0.037109375)
-TexAtlas_RegisterMatTransform('tex_492', 'tex_atlas_med4', 0.068359375,0.0=
05859375,0.099609375,0.037109375)
-TexAtlas_RegisterMatTransform('tex_394', 'tex_atlas_med4', 0.103515625,0.0=
05859375,0.134765625,0.037109375)
-TexAtlas_RegisterMatTransform('tex_540', 'tex_atlas_med4', 0.138671875,0.0=
05859375,0.169921875,0.037109375)
-TexAtlas_RegisterMatTransform('tex_395', 'tex_atlas_med4', 0.173828125,0.0=
05859375,0.205078125,0.037109375)
-TexAtlas_RegisterMatTransform('tex_523', 'tex_atlas_med4', 0.208984375,0.0=
05859375,0.271484375,0.037109375)
-TexAtlas_RegisterMatTransform('tex_36', 'tex_atlas_med4', 0.275390625,0.00=
5859375,0.337890625,0.037109375)
-TexAtlas_RegisterMatTransform('tex_486', 'tex_atlas_med4', 0.341796875,0.0=
05859375,0.357421875,0.037109375)
-TexAtlas_RegisterMatTransform('tex_3', 'tex_atlas_med4', 0.361328125,0.005=
859375,0.423828125,0.037109375)
-TexAtlas_RegisterMatTransform('tex_388', 'tex_atlas_med4', 0.427734375,0.0=
05859375,0.458984375,0.037109375)
-TexAtlas_RegisterMatTransform('tex_247', 'tex_atlas_med4', 0.462890625,0.0=
05859375,0.587890625,0.037109375)
-TexAtlas_RegisterMatTransform('tex_487', 'tex_atlas_med4', 0.591796875,0.0=
05859375,0.607421875,0.037109375)
-TexAtlas_RegisterMatTransform('tex_21', 'tex_atlas_med4', 0.611328125,0.00=
5859375,0.736328125,0.037109375)
-TexAtlas_RegisterMatTransform('tex_30', 'tex_atlas_med4', 0.740234375,0.00=
5859375,0.865234375,0.037109375)
-TexAtlas_RegisterMatTransform('tex_389', 'tex_atlas_med4', 0.869140625,0.0=
05859375,0.900390625,0.037109375)
-TexAtlas_RegisterMatTransform('tex_390', 'tex_atlas_med4', 0.904296875,0.0=
05859375,0.935546875,0.037109375)
-TexAtlas_RegisterMatTransform('tex_248', 'tex_atlas_med4', 0.001953125,0.0=
41015625,0.126953125,0.072265625)
-TexAtlas_RegisterMatTransform('tex_488', 'tex_atlas_med4', 0.130859375,0.0=
41015625,0.146484375,0.072265625)
-TexAtlas_RegisterMatTransform('tex_31', 'tex_atlas_med4', 0.150390625,0.04=
1015625,0.275390625,0.072265625)
-TexAtlas_RegisterMatTransform('tex_107', 'tex_atlas_med4', 0.279296875,0.0=
41015625,0.404296875,0.072265625)
-TexAtlas_RegisterMatTransform('tex_391', 'tex_atlas_med4', 0.408203125,0.0=
41015625,0.439453125,0.072265625)
-TexAtlas_RegisterMatTransform('tex_249', 'tex_atlas_med4', 0.443359375,0.0=
41015625,0.568359375,0.072265625)
-TexAtlas_RegisterMatTransform('tex_489', 'tex_atlas_med4', 0.572265625,0.0=
41015625,0.587890625,0.072265625)
-TexAtlas_RegisterMatTransform('tex_250', 'tex_atlas_med4', 0.591796875,0.0=
41015625,0.654296875,0.072265625)
-TexAtlas_RegisterMatTransform('tex_32', 'tex_atlas_med4', 0.658203125,0.04=
1015625,0.783203125,0.072265625)
-TexAtlas_RegisterMatTransform('tex_421', 'tex_atlas_med4', 0.787109375,0.0=
41015625,0.818359375,0.072265625)
-TexAtlas_RegisterMatTransform('tex_108', 'tex_atlas_med4', 0.822265625,0.0=
41015625,0.947265625,0.072265625)
-TexAtlas_RegisterMatTransform('tex_392', 'tex_atlas_med4', 0.951171875,0.0=
41015625,0.982421875,0.072265625)
-TexAtlas_RegisterMatTransform('tex_563', 'tex_atlas_med4', 0.001953125,0.0=
76171875,0.126953125,0.107421875)
-TexAtlas_RegisterMatTransform('tex_491', 'tex_atlas_med4', 0.130859375,0.0=
76171875,0.162109375,0.107421875)
-TexAtlas_RegisterMatTransform('tex_393', 'tex_atlas_med4', 0.166015625,0.0=
76171875,0.197265625,0.107421875)
-TexAtlas_RegisterMatTransform('tex_rune1', 'tex_atlas_med4', 0.201171875,0=
.076171875,0.232421875,0.107421875)
-TexAtlas_RegisterMatTransform('tex_174', 'tex_atlas_med4', 0.001953125,0.1=
11328125,0.064453125,0.126953125)
+TexAtlas_RegisterMatTransform('tex_mud', 'tex_atlas_med2', 0.583984375,0.5=
21484375,0.708984375,0.646484375)
+TexAtlas_RegisterMatTransform('tex_405', 'tex_atlas_med2', 0.712890625,0.5=
21484375,0.837890625,0.646484375)
+TexAtlas_RegisterMatTransform('tex_5351', 'tex_atlas_med2', 0.841796875,0.=
521484375,0.966796875,0.646484375)
+TexAtlas_RegisterMatTransform('tex_5634', 'tex_atlas_med2', 0.001953125,0.=
650390625,0.126953125,0.775390625)
+TexAtlas_RegisterMatTransform('tex_mushroom', 'tex_atlas_med2', 0.13085937=
5,0.650390625,0.255859375,0.775390625)
+TexAtlas_RegisterMatTransform('tex_mushroom2', 'tex_atlas_med2', 0.2597656=
25,0.650390625,0.384765625,0.775390625)
+TexAtlas_RegisterMatTransform('tex_slidingdoor', 'tex_atlas_med2', 0.38867=
1875,0.650390625,0.513671875,0.775390625)
+TexAtlas_RegisterMatTransform('tex_lantern', 'tex_atlas_med2', 0.517578125=
,0.650390625,0.642578125,0.775390625)
+TexAtlas_RegisterMatTransform('tex_stoneplate', 'tex_atlas_med2', 0.646484=
375,0.650390625,0.771484375,0.775390625)
+TexAtlas_RegisterMatTransform('tex_marblewall', 'tex_atlas_med2', 0.775390=
625,0.650390625,0.900390625,0.775390625)
+TexAtlas_RegisterMatTransform('tex_sattel', 'tex_atlas_med2', 0.001953125,=
0.779296875,0.126953125,0.904296875)
+TexAtlas_RegisterMatTransform('tex_portrait', 'tex_atlas_med2', 0.13085937=
5,0.779296875,0.255859375,0.904296875)
+TexAtlas_RegisterMatTransform('tex_483', 'tex_atlas_med2', 0.001953125,0.9=
08203125,0.126953125,0.970703125)
+TexAtlas_RegisterMatTransform('tex_564', 'tex_atlas_med2', 0.130859375,0.9=
08203125,0.255859375,0.970703125)
+TexAtlas_RegisterMatTransform('tex_367', 'tex_atlas_med2', 0.259765625,0.9=
08203125,0.322265625,0.970703125)
+TexAtlas_RegisterMatTransform('tex_286', 'tex_atlas_med2', 0.326171875,0.9=
08203125,0.451171875,0.970703125)
+TexAtlas_RegisterMatTransform('tex_333', 'tex_atlas_med2', 0.455078125,0.9=
08203125,0.517578125,0.970703125)
+TexAtlas_RegisterMatTransform('tex_171', 'tex_atlas_med2', 0.521484375,0.9=
08203125,0.646484375,0.970703125)
+TexAtlas_RegisterMatTransform('tex_136', 'tex_atlas_med2', 0.650390625,0.9=
08203125,0.775390625,0.970703125)
+TexAtlas_RegisterMatTransform('tex_217', 'tex_atlas_med2', 0.779296875,0.9=
08203125,0.841796875,0.970703125)
+TexAtlas_RegisterMatTransform('tex_342', 'tex_atlas_med2', 0.845703125,0.9=
08203125,0.908203125,0.970703125)
+TexAtlas_RegisterMatTransform('tex_145', 'tex_atlas_med3', 0.001953125,0.0=
05859375,0.126953125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_226', 'tex_atlas_med3', 0.130859375,0.0=
05859375,0.193359375,0.068359375)
+TexAtlas_RegisterMatTransform('tex_307', 'tex_atlas_med3', 0.197265625,0.0=
05859375,0.259765625,0.068359375)
+TexAtlas_RegisterMatTransform('tex_188', 'tex_atlas_med3', 0.263671875,0.0=
05859375,0.326171875,0.068359375)
+TexAtlas_RegisterMatTransform('tex_154', 'tex_atlas_med3', 0.330078125,0.0=
05859375,0.455078125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_235', 'tex_atlas_med3', 0.458984375,0.0=
05859375,0.521484375,0.068359375)
+TexAtlas_RegisterMatTransform('tex_316', 'tex_atlas_med3', 0.525390625,0.0=
05859375,0.587890625,0.068359375)
+TexAtlas_RegisterMatTransform('tex_556', 'tex_atlas_med3', 0.591796875,0.0=
05859375,0.654296875,0.068359375)
+TexAtlas_RegisterMatTransform('tex_197', 'tex_atlas_med3', 0.658203125,0.0=
05859375,0.720703125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_201', 'tex_atlas_med3', 0.724609375,0.0=
05859375,0.787109375,0.068359375)
+TexAtlas_RegisterMatTransform('tex_325', 'tex_atlas_med3', 0.791015625,0.0=
05859375,0.853515625,0.068359375)
+TexAtlas_RegisterMatTransform('tex_244', 'tex_atlas_med3', 0.857421875,0.0=
05859375,0.919921875,0.068359375)
+TexAtlas_RegisterMatTransform('tex_209', 'tex_atlas_med3', 0.923828125,0.0=
05859375,0.986328125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_128', 'tex_atlas_med3', 0.001953125,0.0=
72265625,0.126953125,0.134765625)
+TexAtlas_RegisterMatTransform('tex_484', 'tex_atlas_med3', 0.130859375,0.0=
72265625,0.255859375,0.134765625)
+TexAtlas_RegisterMatTransform('tex_368', 'tex_atlas_med3', 0.259765625,0.0=
72265625,0.322265625,0.134765625)
+TexAtlas_RegisterMatTransform('tex_26', 'tex_atlas_med3', 0.326171875,0.07=
2265625,0.388671875,0.134765625)
+TexAtlas_RegisterMatTransform('tex_210', 'tex_atlas_med3', 0.392578125,0.0=
72265625,0.455078125,0.134765625)
+TexAtlas_RegisterMatTransform('tex_334', 'tex_atlas_med3', 0.458984375,0.0=
72265625,0.521484375,0.134765625)
+TexAtlas_RegisterMatTransform('tex_137', 'tex_atlas_med3', 0.525390625,0.0=
72265625,0.650390625,0.134765625)
+TexAtlas_RegisterMatTransform('tex_493', 'tex_atlas_med3', 0.654296875,0.0=
72265625,0.716796875,0.134765625)
+TexAtlas_RegisterMatTransform('tex_70', 'tex_atlas_med3', 0.720703125,0.07=
2265625,0.845703125,0.134765625)
+TexAtlas_RegisterMatTransform('tex_343', 'tex_atlas_med3', 0.849609375,0.0=
72265625,0.912109375,0.134765625)
+TexAtlas_RegisterMatTransform('tex_146', 'tex_atlas_med3', 0.001953125,0.1=
38671875,0.126953125,0.201171875)
+TexAtlas_RegisterMatTransform('tex_227', 'tex_atlas_med3', 0.130859375,0.1=
38671875,0.193359375,0.201171875)
+TexAtlas_RegisterMatTransform('tex_308', 'tex_atlas_med3', 0.197265625,0.1=
38671875,0.259765625,0.201171875)
+TexAtlas_RegisterMatTransform('tex_386', 'tex_atlas_med3', 0.263671875,0.1=
38671875,0.326171875,0.201171875)
+TexAtlas_RegisterMatTransform('tex_189', 'tex_atlas_med3', 0.330078125,0.1=
38671875,0.392578125,0.201171875)
+TexAtlas_RegisterMatTransform('tex_190', 'tex_atlas_med3', 0.396484375,0.1=
38671875,0.458984375,0.201171875)
+TexAtlas_RegisterMatTransform('tex_236', 'tex_atlas_med3', 0.462890625,0.1=
38671875,0.525390625,0.201171875)
+TexAtlas_RegisterMatTransform('tex_317', 'tex_atlas_med3', 0.529296875,0.1=
38671875,0.591796875,0.201171875)
+TexAtlas_RegisterMatTransform('tex_198', 'tex_atlas_med3', 0.595703125,0.1=
38671875,0.658203125,0.201171875)
+TexAtlas_RegisterMatTransform('tex_202', 'tex_atlas_med3', 0.662109375,0.1=
38671875,0.724609375,0.201171875)
+TexAtlas_RegisterMatTransform('tex_121', 'tex_atlas_med3', 0.728515625,0.1=
38671875,0.791015625,0.201171875)
+TexAtlas_RegisterMatTransform('tex_326', 'tex_atlas_med3', 0.794921875,0.1=
38671875,0.857421875,0.201171875)
+TexAtlas_RegisterMatTransform('tex_245', 'tex_atlas_med3', 0.861328125,0.1=
38671875,0.923828125,0.201171875)
+TexAtlas_RegisterMatTransform('tex_129', 'tex_atlas_med3', 0.001953125,0.2=
05078125,0.126953125,0.267578125)
+TexAtlas_RegisterMatTransform('tex_369', 'tex_atlas_med3', 0.130859375,0.2=
05078125,0.193359375,0.267578125)
+TexAtlas_RegisterMatTransform('tex_27', 'tex_atlas_med3', 0.197265625,0.20=
5078125,0.259765625,0.267578125)
+TexAtlas_RegisterMatTransform('tex_2', 'tex_atlas_med3', 0.263671875,0.205=
078125,0.326171875,0.267578125)
+TexAtlas_RegisterMatTransform('tex_130', 'tex_atlas_med3', 0.330078125,0.2=
05078125,0.455078125,0.267578125)
+TexAtlas_RegisterMatTransform('tex_211', 'tex_atlas_med3', 0.458984375,0.2=
05078125,0.521484375,0.267578125)
+TexAtlas_RegisterMatTransform('tex_370', 'tex_atlas_med3', 0.525390625,0.2=
05078125,0.587890625,0.267578125)
+TexAtlas_RegisterMatTransform('tex_335', 'tex_atlas_med3', 0.591796875,0.2=
05078125,0.654296875,0.267578125)
+TexAtlas_RegisterMatTransform('tex_138', 'tex_atlas_med3', 0.658203125,0.2=
05078125,0.783203125,0.267578125)
+TexAtlas_RegisterMatTransform('tex_494', 'tex_atlas_med3', 0.787109375,0.2=
05078125,0.849609375,0.267578125)
+TexAtlas_RegisterMatTransform('tex_220', 'tex_atlas_med3', 0.853515625,0.2=
05078125,0.916015625,0.267578125)
+TexAtlas_RegisterMatTransform('tex_344', 'tex_atlas_med3', 0.919921875,0.2=
05078125,0.982421875,0.267578125)
+TexAtlas_RegisterMatTransform('tex_147', 'tex_atlas_med3', 0.001953125,0.2=
71484375,0.126953125,0.333984375)
+TexAtlas_RegisterMatTransform('tex_228', 'tex_atlas_med3', 0.130859375,0.2=
71484375,0.193359375,0.333984375)
+TexAtlas_RegisterMatTransform('tex_309', 'tex_atlas_med3', 0.197265625,0.2=
71484375,0.259765625,0.333984375)
+TexAtlas_RegisterMatTransform('tex_310', 'tex_atlas_med3', 0.263671875,0.2=
71484375,0.326171875,0.333984375)
+TexAtlas_RegisterMatTransform('tex_113', 'tex_atlas_med3', 0.330078125,0.2=
71484375,0.455078125,0.333984375)
+TexAtlas_RegisterMatTransform('tex_515', 'tex_atlas_med3', 0.458984375,0.2=
71484375,0.521484375,0.333984375)
+TexAtlas_RegisterMatTransform('tex_191', 'tex_atlas_med3', 0.525390625,0.2=
71484375,0.587890625,0.333984375)
+TexAtlas_RegisterMatTransform('tex_237', 'tex_atlas_med3', 0.591796875,0.2=
71484375,0.654296875,0.333984375)
+TexAtlas_RegisterMatTransform('tex_318', 'tex_atlas_med3', 0.658203125,0.2=
71484375,0.720703125,0.333984375)
+TexAtlas_RegisterMatTransform('tex_477', 'tex_atlas_med3', 0.724609375,0.2=
71484375,0.787109375,0.333984375)
+TexAtlas_RegisterMatTransform('tex_396', 'tex_atlas_med3', 0.791015625,0.2=
71484375,0.853515625,0.333984375)
+TexAtlas_RegisterMatTransform('tex_199', 'tex_atlas_med3', 0.857421875,0.2=
71484375,0.919921875,0.333984375)
+TexAtlas_RegisterMatTransform('tex_400', 'tex_atlas_med3', 0.923828125,0.2=
71484375,0.986328125,0.333984375)
+TexAtlas_RegisterMatTransform('tex_203', 'tex_atlas_med3', 0.001953125,0.3=
37890625,0.064453125,0.400390625)
+TexAtlas_RegisterMatTransform('tex_524', 'tex_atlas_med3', 0.068359375,0.3=
37890625,0.130859375,0.400390625)
+TexAtlas_RegisterMatTransform('tex_327', 'tex_atlas_med3', 0.134765625,0.3=
37890625,0.197265625,0.400390625)
+TexAtlas_RegisterMatTransform('tex_246', 'tex_atlas_med3', 0.201171875,0.3=
37890625,0.263671875,0.400390625)
+TexAtlas_RegisterMatTransform('tex_131', 'tex_atlas_med3', 0.267578125,0.3=
37890625,0.392578125,0.400390625)
+TexAtlas_RegisterMatTransform('tex_212', 'tex_atlas_med3', 0.396484375,0.3=
37890625,0.458984375,0.400390625)
+TexAtlas_RegisterMatTransform('tex_371', 'tex_atlas_med3', 0.462890625,0.3=
37890625,0.525390625,0.400390625)
+TexAtlas_RegisterMatTransform('tex_336', 'tex_atlas_med3', 0.529296875,0.3=
37890625,0.591796875,0.400390625)
+TexAtlas_RegisterMatTransform('tex_139', 'tex_atlas_med3', 0.595703125,0.3=
37890625,0.720703125,0.400390625)
+TexAtlas_RegisterMatTransform('tex_495', 'tex_atlas_med3', 0.724609375,0.3=
37890625,0.787109375,0.400390625)
+TexAtlas_RegisterMatTransform('tex_140', 'tex_atlas_med3', 0.791015625,0.3=
37890625,0.916015625,0.400390625)
+TexAtlas_RegisterMatTransform('tex_221', 'tex_atlas_med3', 0.919921875,0.3=
37890625,0.982421875,0.400390625)
+TexAtlas_RegisterMatTransform('tex_461', 'tex_atlas_med3', 0.001953125,0.4=
04296875,0.033203125,0.466796875)
+TexAtlas_RegisterMatTransform('tex_345', 'tex_atlas_med3', 0.037109375,0.4=
04296875,0.099609375,0.466796875)
+TexAtlas_RegisterMatTransform('tex_183', 'tex_atlas_med3', 0.103515625,0.4=
04296875,0.166015625,0.466796875)
+TexAtlas_RegisterMatTransform('tex_148', 'tex_atlas_med3', 0.169921875,0.4=
04296875,0.294921875,0.466796875)
+TexAtlas_RegisterMatTransform('tex_229', 'tex_atlas_med3', 0.298828125,0.4=
04296875,0.361328125,0.466796875)
+TexAtlas_RegisterMatTransform('tex_230', 'tex_atlas_med3', 0.365234375,0.4=
04296875,0.427734375,0.466796875)
+TexAtlas_RegisterMatTransform('tex_311', 'tex_atlas_med3', 0.431640625,0.4=
04296875,0.494140625,0.466796875)
+TexAtlas_RegisterMatTransform('tex_551', 'tex_atlas_med3', 0.498046875,0.4=
04296875,0.560546875,0.466796875)
+TexAtlas_RegisterMatTransform('tex_516', 'tex_atlas_med3', 0.564453125,0.4=
04296875,0.626953125,0.466796875)
+TexAtlas_RegisterMatTransform('tex_192', 'tex_atlas_med3', 0.630859375,0.4=
04296875,0.693359375,0.466796875)
+TexAtlas_RegisterMatTransform('tex_157', 'tex_atlas_med3', 0.697265625,0.4=
04296875,0.822265625,0.466796875)
+TexAtlas_RegisterMatTransform('tex_238', 'tex_atlas_med3', 0.826171875,0.4=
04296875,0.888671875,0.466796875)
+TexAtlas_RegisterMatTransform('tex_319', 'tex_atlas_med3', 0.892578125,0.4=
04296875,0.955078125,0.466796875)
+TexAtlas_RegisterMatTransform('tex_397', 'tex_atlas_med3', 0.001953125,0.4=
70703125,0.064453125,0.533203125)
+TexAtlas_RegisterMatTransform('tex_401', 'tex_atlas_med3', 0.068359375,0.4=
70703125,0.130859375,0.533203125)
+TexAtlas_RegisterMatTransform('tex_320', 'tex_atlas_med3', 0.134765625,0.4=
70703125,0.197265625,0.533203125)
+TexAtlas_RegisterMatTransform('tex_204', 'tex_atlas_med3', 0.201171875,0.4=
70703125,0.263671875,0.533203125)
+TexAtlas_RegisterMatTransform('tex_525', 'tex_atlas_med3', 0.267578125,0.4=
70703125,0.330078125,0.533203125)
+TexAtlas_RegisterMatTransform('tex_409', 'tex_atlas_med3', 0.333984375,0.4=
70703125,0.458984375,0.533203125)
+TexAtlas_RegisterMatTransform('tex_328', 'tex_atlas_med3', 0.462890625,0.4=
70703125,0.525390625,0.533203125)
+TexAtlas_RegisterMatTransform('tex_166', 'tex_atlas_med3', 0.529296875,0.4=
70703125,0.654296875,0.533203125)
+TexAtlas_RegisterMatTransform('tex_132', 'tex_atlas_med3', 0.658203125,0.4=
70703125,0.783203125,0.533203125)
+TexAtlas_RegisterMatTransform('tex_213', 'tex_atlas_med3', 0.787109375,0.4=
70703125,0.849609375,0.533203125)
+TexAtlas_RegisterMatTransform('tex_453', 'tex_atlas_med3', 0.853515625,0.4=
70703125,0.916015625,0.533203125)
+TexAtlas_RegisterMatTransform('tex_337', 'tex_atlas_med3', 0.919921875,0.4=
70703125,0.982421875,0.533203125)
+TexAtlas_RegisterMatTransform('tex_256', 'tex_atlas_med3', 0.001953125,0.5=
37109375,0.126953125,0.599609375)
+TexAtlas_RegisterMatTransform('tex_496', 'tex_atlas_med3', 0.130859375,0.5=
37109375,0.193359375,0.599609375)
+TexAtlas_RegisterMatTransform('tex_141', 'tex_atlas_med3', 0.197265625,0.5=
37109375,0.322265625,0.599609375)
+TexAtlas_RegisterMatTransform('tex_222', 'tex_atlas_med3', 0.326171875,0.5=
37109375,0.388671875,0.599609375)
+TexAtlas_RegisterMatTransform('tex_303', 'tex_atlas_med3', 0.392578125,0.5=
37109375,0.455078125,0.599609375)
+TexAtlas_RegisterMatTransform('tex_462', 'tex_atlas_med3', 0.458984375,0.5=
37109375,0.490234375,0.599609375)
+TexAtlas_RegisterMatTransform('tex_184', 'tex_atlas_med3', 0.494140625,0.5=
37109375,0.556640625,0.599609375)
+TexAtlas_RegisterMatTransform('tex_149', 'tex_atlas_med3', 0.560546875,0.5=
37109375,0.685546875,0.599609375)
+TexAtlas_RegisterMatTransform('tex_150', 'tex_atlas_med3', 0.689453125,0.5=
37109375,0.814453125,0.599609375)
+TexAtlas_RegisterMatTransform('tex_231', 'tex_atlas_med3', 0.818359375,0.5=
37109375,0.880859375,0.599609375)
+TexAtlas_RegisterMatTransform('tex_312', 'tex_atlas_med3', 0.884765625,0.5=
37109375,0.947265625,0.599609375)
+TexAtlas_RegisterMatTransform('tex_517', 'tex_atlas_med3', 0.001953125,0.6=
03515625,0.064453125,0.666015625)
+TexAtlas_RegisterMatTransform('tex_193', 'tex_atlas_med3', 0.068359375,0.6=
03515625,0.130859375,0.666015625)
+TexAtlas_RegisterMatTransform('tex_158', 'tex_atlas_med3', 0.134765625,0.6=
03515625,0.259765625,0.666015625)
+TexAtlas_RegisterMatTransform('tex_239', 'tex_atlas_med3', 0.263671875,0.6=
03515625,0.326171875,0.666015625)
+TexAtlas_RegisterMatTransform('tex_479', 'tex_atlas_med3', 0.330078125,0.6=
03515625,0.392578125,0.666015625)
+TexAtlas_RegisterMatTransform('tex_398', 'tex_atlas_med3', 0.396484375,0.6=
03515625,0.458984375,0.666015625)
+TexAtlas_RegisterMatTransform('tex_402', 'tex_atlas_med3', 0.462890625,0.6=
03515625,0.525390625,0.666015625)
+TexAtlas_RegisterMatTransform('tex_240', 'tex_atlas_med3', 0.529296875,0.6=
03515625,0.591796875,0.666015625)
+TexAtlas_RegisterMatTransform('tex_321', 'tex_atlas_med3', 0.595703125,0.6=
03515625,0.658203125,0.666015625)
+TexAtlas_RegisterMatTransform('tex_205', 'tex_atlas_med3', 0.662109375,0.6=
03515625,0.724609375,0.666015625)
+TexAtlas_RegisterMatTransform('tex_124', 'tex_atlas_med3', 0.728515625,0.6=
03515625,0.853515625,0.666015625)
+TexAtlas_RegisterMatTransform('tex_561', 'tex_atlas_med3', 0.857421875,0.6=
03515625,0.982421875,0.666015625)
+TexAtlas_RegisterMatTransform('tex_526', 'tex_atlas_med3', 0.001953125,0.6=
69921875,0.064453125,0.732421875)
+TexAtlas_RegisterMatTransform('tex_329', 'tex_atlas_med3', 0.068359375,0.6=
69921875,0.130859375,0.732421875)
+TexAtlas_RegisterMatTransform('tex_167', 'tex_atlas_med3', 0.134765625,0.6=
69921875,0.259765625,0.732421875)
+TexAtlas_RegisterMatTransform('tex_22', 'tex_atlas_med3', 0.263671875,0.66=
9921875,0.326171875,0.732421875)
+TexAtlas_RegisterMatTransform('tex_330', 'tex_atlas_med3', 0.330078125,0.6=
69921875,0.392578125,0.732421875)
+TexAtlas_RegisterMatTransform('tex_133', 'tex_atlas_med3', 0.396484375,0.6=
69921875,0.521484375,0.732421875)
+TexAtlas_RegisterMatTransform('tex_214', 'tex_atlas_med3', 0.525390625,0.6=
69921875,0.587890625,0.732421875)
+TexAtlas_RegisterMatTransform('tex_338', 'tex_atlas_med3', 0.591796875,0.6=
69921875,0.654296875,0.732421875)
+TexAtlas_RegisterMatTransform('tex_142', 'tex_atlas_med3', 0.658203125,0.6=
69921875,0.783203125,0.732421875)
+TexAtlas_RegisterMatTransform('tex_223', 'tex_atlas_med3', 0.787109375,0.6=
69921875,0.849609375,0.732421875)
+TexAtlas_RegisterMatTransform('tex_304', 'tex_atlas_med3', 0.853515625,0.6=
69921875,0.916015625,0.732421875)
+TexAtlas_RegisterMatTransform('tex_463', 'tex_atlas_med3', 0.919921875,0.6=
69921875,0.982421875,0.732421875)
+TexAtlas_RegisterMatTransform('tex_185', 'tex_atlas_med3', 0.001953125,0.7=
36328125,0.064453125,0.798828125)
+TexAtlas_RegisterMatTransform('tex_232', 'tex_atlas_med3', 0.068359375,0.7=
36328125,0.130859375,0.798828125)
+TexAtlas_RegisterMatTransform('tex_313', 'tex_atlas_med3', 0.134765625,0.7=
36328125,0.197265625,0.798828125)
+TexAtlas_RegisterMatTransform('tex_194', 'tex_atlas_med3', 0.201171875,0.7=
36328125,0.263671875,0.798828125)
+TexAtlas_RegisterMatTransform('tex_159', 'tex_atlas_med3', 0.267578125,0.7=
36328125,0.392578125,0.798828125)
+TexAtlas_RegisterMatTransform('tex_399', 'tex_atlas_med3', 0.396484375,0.7=
36328125,0.458984375,0.798828125)
+TexAtlas_RegisterMatTransform('tex_403', 'tex_atlas_med3', 0.462890625,0.7=
36328125,0.587890625,0.798828125)
+TexAtlas_RegisterMatTransform('tex_241', 'tex_atlas_med3', 0.591796875,0.7=
36328125,0.654296875,0.798828125)
+TexAtlas_RegisterMatTransform('tex_322', 'tex_atlas_med3', 0.658203125,0.7=
36328125,0.720703125,0.798828125)
+TexAtlas_RegisterMatTransform('tex_206', 'tex_atlas_med3', 0.724609375,0.7=
36328125,0.787109375,0.798828125)
+TexAtlas_RegisterMatTransform('tex_125', 'tex_atlas_med3', 0.791015625,0.7=
36328125,0.916015625,0.798828125)
+TexAtlas_RegisterMatTransform('tex_168', 'tex_atlas_med3', 0.001953125,0.8=
02734375,0.126953125,0.865234375)
+TexAtlas_RegisterMatTransform('tex_23', 'tex_atlas_med3', 0.130859375,0.80=
2734375,0.255859375,0.865234375)
+TexAtlas_RegisterMatTransform('tex_331', 'tex_atlas_med3', 0.259765625,0.8=
02734375,0.322265625,0.865234375)
+TexAtlas_RegisterMatTransform('tex_134', 'tex_atlas_med3', 0.326171875,0.8=
02734375,0.451171875,0.865234375)
+TexAtlas_RegisterMatTransform('tex_215', 'tex_atlas_med3', 0.455078125,0.8=
02734375,0.517578125,0.865234375)
+TexAtlas_RegisterMatTransform('tex_571', 'tex_atlas_med3', 0.521484375,0.8=
02734375,0.646484375,0.865234375)
+TexAtlas_RegisterMatTransform('tex_339', 'tex_atlas_med3', 0.650390625,0.8=
02734375,0.712890625,0.865234375)
+TexAtlas_RegisterMatTransform('tex_258', 'tex_atlas_med3', 0.716796875,0.8=
02734375,0.779296875,0.865234375)
+TexAtlas_RegisterMatTransform('tex_340', 'tex_atlas_med3', 0.783203125,0.8=
02734375,0.845703125,0.865234375)
+TexAtlas_RegisterMatTransform('tex_143', 'tex_atlas_med3', 0.849609375,0.8=
02734375,0.974609375,0.865234375)
+TexAtlas_RegisterMatTransform('tex_224', 'tex_atlas_med3', 0.001953125,0.8=
69140625,0.064453125,0.931640625)
+TexAtlas_RegisterMatTransform('tex_305', 'tex_atlas_med3', 0.068359375,0.8=
69140625,0.130859375,0.931640625)
+TexAtlas_RegisterMatTransform('tex_464', 'tex_atlas_med3', 0.134765625,0.8=
69140625,0.197265625,0.931640625)
+TexAtlas_RegisterMatTransform('tex_186', 'tex_atlas_med3', 0.201171875,0.8=
69140625,0.263671875,0.931640625)
+TexAtlas_RegisterMatTransform('tex_152', 'tex_atlas_med3', 0.267578125,0.8=
69140625,0.392578125,0.931640625)
+TexAtlas_RegisterMatTransform('tex_233', 'tex_atlas_med3', 0.396484375,0.8=
69140625,0.458984375,0.931640625)
+TexAtlas_RegisterMatTransform('tex_314', 'tex_atlas_med3', 0.462890625,0.8=
69140625,0.525390625,0.931640625)
+TexAtlas_RegisterMatTransform('tex_195', 'tex_atlas_med3', 0.529296875,0.8=
69140625,0.591796875,0.931640625)
+TexAtlas_RegisterMatTransform('tex_161', 'tex_atlas_med3', 0.595703125,0.8=
69140625,0.720703125,0.931640625)
+TexAtlas_RegisterMatTransform('tex_242', 'tex_atlas_med3', 0.724609375,0.8=
69140625,0.787109375,0.931640625)
+TexAtlas_RegisterMatTransform('tex_323', 'tex_atlas_med3', 0.791015625,0.8=
69140625,0.853515625,0.931640625)
+TexAtlas_RegisterMatTransform('tex_207', 'tex_atlas_med3', 0.857421875,0.8=
69140625,0.919921875,0.931640625)
+TexAtlas_RegisterMatTransform('tex_126', 'tex_atlas_med3', 0.001953125,0.9=
35546875,0.126953125,0.998046875)
+TexAtlas_RegisterMatTransform('tex_366', 'tex_atlas_med3', 0.130859375,0.9=
35546875,0.193359375,0.998046875)
+TexAtlas_RegisterMatTransform('tex_169', 'tex_atlas_med3', 0.197265625,0.9=
35546875,0.322265625,0.998046875)
+TexAtlas_RegisterMatTransform('tex_332', 'tex_atlas_med3', 0.326171875,0.9=
35546875,0.388671875,0.998046875)
+TexAtlas_RegisterMatTransform('tex_170', 'tex_atlas_med3', 0.392578125,0.9=
35546875,0.517578125,0.998046875)
+TexAtlas_RegisterMatTransform('tex_251', 'tex_atlas_med3', 0.521484375,0.9=
35546875,0.646484375,0.998046875)
+TexAtlas_RegisterMatTransform('tex_135', 'tex_atlas_med3', 0.650390625,0.9=
35546875,0.775390625,0.998046875)
+TexAtlas_RegisterMatTransform('tex_216', 'tex_atlas_med3', 0.779296875,0.9=
35546875,0.841796875,0.998046875)
+TexAtlas_RegisterMatTransform('tex_572', 'tex_atlas_med3', 0.845703125,0.9=
35546875,0.970703125,0.998046875)
+TexAtlas_RegisterMatTransform('tex_259', 'tex_atlas_med4', 0.001953125,0.0=
05859375,0.064453125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_33', 'tex_atlas_med4', 0.068359375,0.00=
5859375,0.130859375,0.068359375)
+TexAtlas_RegisterMatTransform('tex_260', 'tex_atlas_med4', 0.134765625,0.0=
05859375,0.197265625,0.068359375)
+TexAtlas_RegisterMatTransform('tex_144', 'tex_atlas_med4', 0.201171875,0.0=
05859375,0.326171875,0.068359375)
+TexAtlas_RegisterMatTransform('tex_225', 'tex_atlas_med4', 0.330078125,0.0=
05859375,0.392578125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_306', 'tex_atlas_med4', 0.396484375,0.0=
05859375,0.458984375,0.068359375)
+TexAtlas_RegisterMatTransform('tex_465', 'tex_atlas_med4', 0.462890625,0.0=
05859375,0.525390625,0.068359375)
+TexAtlas_RegisterMatTransform('tex_187', 'tex_atlas_med4', 0.529296875,0.0=
05859375,0.591796875,0.068359375)
+TexAtlas_RegisterMatTransform('tex_110', 'tex_atlas_med4', 0.595703125,0.0=
05859375,0.720703125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_234', 'tex_atlas_med4', 0.724609375,0.0=
05859375,0.787109375,0.068359375)
+TexAtlas_RegisterMatTransform('tex_315', 'tex_atlas_med4', 0.791015625,0.0=
05859375,0.853515625,0.068359375)
+TexAtlas_RegisterMatTransform('tex_555', 'tex_atlas_med4', 0.857421875,0.0=
05859375,0.919921875,0.068359375)
+TexAtlas_RegisterMatTransform('tex_474', 'tex_atlas_med4', 0.923828125,0.0=
05859375,0.986328125,0.068359375)
+TexAtlas_RegisterMatTransform('tex_196', 'tex_atlas_med4', 0.001953125,0.0=
72265625,0.064453125,0.134765625)
+TexAtlas_RegisterMatTransform('tex_200', 'tex_atlas_med4', 0.068359375,0.0=
72265625,0.130859375,0.134765625)
+TexAtlas_RegisterMatTransform('tex_162', 'tex_atlas_med4', 0.134765625,0.0=
72265625,0.259765625,0.134765625)
+TexAtlas_RegisterMatTransform('tex_243', 'tex_atlas_med4', 0.263671875,0.0=
72265625,0.326171875,0.134765625)
+TexAtlas_RegisterMatTransform('tex_324', 'tex_atlas_med4', 0.330078125,0.0=
72265625,0.392578125,0.134765625)
+TexAtlas_RegisterMatTransform('tex_208', 'tex_atlas_med4', 0.396484375,0.0=
72265625,0.458984375,0.134765625)
+TexAtlas_RegisterMatTransform('tex_127', 'tex_atlas_med4', 0.462890625,0.0=
72265625,0.587890625,0.134765625)
+TexAtlas_RegisterMatTransform('tex_25', 'tex_atlas_med4', 0.001953125,0.13=
8671875,0.064453125,0.169921875)
+TexAtlas_RegisterMatTransform('tex_492', 'tex_atlas_med4', 0.068359375,0.1=
38671875,0.099609375,0.169921875)
+TexAtlas_RegisterMatTransform('tex_394', 'tex_atlas_med4', 0.103515625,0.1=
38671875,0.134765625,0.169921875)
+TexAtlas_RegisterMatTransform('tex_540', 'tex_atlas_med4', 0.138671875,0.1=
38671875,0.169921875,0.169921875)
+TexAtlas_RegisterMatTransform('tex_395', 'tex_atlas_med4', 0.173828125,0.1=
38671875,0.205078125,0.169921875)
+TexAtlas_RegisterMatTransform('tex_523', 'tex_atlas_med4', 0.208984375,0.1=
38671875,0.271484375,0.169921875)
+TexAtlas_RegisterMatTransform('tex_36', 'tex_atlas_med4', 0.275390625,0.13=
8671875,0.337890625,0.169921875)
+TexAtlas_RegisterMatTransform('tex_486', 'tex_atlas_med4', 0.341796875,0.1=
38671875,0.357421875,0.169921875)
+TexAtlas_RegisterMatTransform('tex_3', 'tex_atlas_med4', 0.361328125,0.138=
671875,0.423828125,0.169921875)
+TexAtlas_RegisterMatTransform('tex_388', 'tex_atlas_med4', 0.427734375,0.1=
38671875,0.458984375,0.169921875)
+TexAtlas_RegisterMatTransform('tex_247', 'tex_atlas_med4', 0.462890625,0.1=
38671875,0.587890625,0.169921875)
+TexAtlas_RegisterMatTransform('tex_487', 'tex_atlas_med4', 0.591796875,0.1=
38671875,0.607421875,0.169921875)
+TexAtlas_RegisterMatTransform('tex_21', 'tex_atlas_med4', 0.611328125,0.13=
8671875,0.736328125,0.169921875)
+TexAtlas_RegisterMatTransform('tex_30', 'tex_atlas_med4', 0.740234375,0.13=
8671875,0.865234375,0.169921875)
+TexAtlas_RegisterMatTransform('tex_389', 'tex_atlas_med4', 0.869140625,0.1=
38671875,0.900390625,0.169921875)
+TexAtlas_RegisterMatTransform('tex_390', 'tex_atlas_med4', 0.904296875,0.1=
38671875,0.935546875,0.169921875)
+TexAtlas_RegisterMatTransform('tex_248', 'tex_atlas_med4', 0.001953125,0.1=
73828125,0.126953125,0.205078125)
+TexAtlas_RegisterMatTransform('tex_488', 'tex_atlas_med4', 0.130859375,0.1=
73828125,0.146484375,0.205078125)
+TexAtlas_RegisterMatTransform('tex_31', 'tex_atlas_med4', 0.150390625,0.17=
3828125,0.275390625,0.205078125)
+TexAtlas_RegisterMatTransform('tex_107', 'tex_atlas_med4', 0.279296875,0.1=
73828125,0.404296875,0.205078125)
+TexAtlas_RegisterMatTransform('tex_391', 'tex_atlas_med4', 0.408203125,0.1=
73828125,0.439453125,0.205078125)
+TexAtlas_RegisterMatTransform('tex_249', 'tex_atlas_med4', 0.443359375,0.1=
73828125,0.568359375,0.205078125)
+TexAtlas_RegisterMatTransform('tex_489', 'tex_atlas_med4', 0.572265625,0.1=
73828125,0.587890625,0.205078125)
+TexAtlas_RegisterMatTransform('tex_250', 'tex_atlas_med4', 0.591796875,0.1=
73828125,0.654296875,0.205078125)
+TexAtlas_RegisterMatTransform('tex_32', 'tex_atlas_med4', 0.658203125,0.17=
3828125,0.783203125,0.205078125)
+TexAtlas_RegisterMatTransform('tex_421', 'tex_atlas_med4', 0.787109375,0.1=
73828125,0.818359375,0.205078125)
+TexAtlas_RegisterMatTransform('tex_108', 'tex_atlas_med4', 0.822265625,0.1=
73828125,0.947265625,0.205078125)
+TexAtlas_RegisterMatTransform('tex_392', 'tex_atlas_med4', 0.951171875,0.1=
73828125,0.982421875,0.205078125)
+TexAtlas_RegisterMatTransform('tex_563', 'tex_atlas_med4', 0.001953125,0.2=
08984375,0.126953125,0.240234375)
+TexAtlas_RegisterMatTransform('tex_491', 'tex_atlas_med4', 0.130859375,0.2=
08984375,0.162109375,0.240234375)
+TexAtlas_RegisterMatTransform('tex_393', 'tex_atlas_med4', 0.166015625,0.2=
08984375,0.197265625,0.240234375)
+TexAtlas_RegisterMatTransform('tex_rune1', 'tex_atlas_med4', 0.201171875,0=
.208984375,0.232421875,0.240234375)
+TexAtlas_RegisterMatTransform('tex_174', 'tex_atlas_med4', 0.001953125,0.2=
44140625,0.064453125,0.259765625)

Modified: trunk/data/models/atlas/tex_atlas_med2.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/atlas/tex_atlas_med3.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/atlas/tex_atlas_med4.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/atlas/tex_atlas_ultralow.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_ultralow.lua (original)
+++ trunk/data/models/atlas/tex_atlas_ultralow.lua Tue Mar 25 15:48:39 2008
@@ -335,18 +335,22 @@
 TexAtlas_RegisterMatTransform('tex_51', 'tex_atlas_ultralow0', 0.6015625,0=
.6640625,0.6171875,0.6953125)
 TexAtlas_RegisterMatTransform('tex_16', 'tex_atlas_ultralow0', 0.6328125,0=
.6640625,0.6640625,0.6953125)
 TexAtlas_RegisterMatTransform('tex_200', 'tex_atlas_ultralow0', 0.6796875,=
0.6640625,0.7109375,0.6953125)
-TexAtlas_RegisterMatTransform('tex_405', 'tex_atlas_ultralow0', 0.7265625,=
0.6640625,0.7578125,0.6953125)
-TexAtlas_RegisterMatTransform('tex_243', 'tex_atlas_ultralow0', 0.7734375,=
0.6640625,0.8046875,0.6953125)
-TexAtlas_RegisterMatTransform('tex_324', 'tex_atlas_ultralow0', 0.8203125,=
0.6640625,0.8515625,0.6953125)
-TexAtlas_RegisterMatTransform('tex_208', 'tex_atlas_ultralow0', 0.8671875,=
0.6640625,0.8984375,0.6953125)
-TexAtlas_RegisterMatTransform('tex_5351', 'tex_atlas_ultralow0', 0.9140625=
,0.6640625,0.9453125,0.6953125)
-TexAtlas_RegisterMatTransform('tex_5634', 'tex_atlas_ultralow0', 0.9609375=
,0.6640625,0.9921875,0.6953125)
-TexAtlas_RegisterMatTransform('tex_mushroom', 'tex_atlas_ultralow0', 0.007=
8125,0.7109375,0.0390625,0.7421875)
-TexAtlas_RegisterMatTransform('tex_mushroom2', 'tex_atlas_ultralow0', 0.05=
46875,0.7109375,0.0859375,0.7421875)
-TexAtlas_RegisterMatTransform('tex_slidingdoor', 'tex_atlas_ultralow0', 0.=
1015625,0.7109375,0.1328125,0.7421875)
-TexAtlas_RegisterMatTransform('tex_lantern', 'tex_atlas_ultralow0', 0.1484=
375,0.7109375,0.1796875,0.7421875)
-TexAtlas_RegisterMatTransform('tex_stoneplate', 'tex_atlas_ultralow0', 0.1=
953125,0.7109375,0.2265625,0.7421875)
-TexAtlas_RegisterMatTransform('tex_rune1', 'tex_atlas_ultralow0', 0.242187=
5,0.7109375,0.2734375,0.7421875)
+TexAtlas_RegisterMatTransform('tex_mud', 'tex_atlas_ultralow0', 0.7265625,=
0.6640625,0.7578125,0.6953125)
+TexAtlas_RegisterMatTransform('tex_405', 'tex_atlas_ultralow0', 0.7734375,=
0.6640625,0.8046875,0.6953125)
+TexAtlas_RegisterMatTransform('tex_243', 'tex_atlas_ultralow0', 0.8203125,=
0.6640625,0.8515625,0.6953125)
+TexAtlas_RegisterMatTransform('tex_324', 'tex_atlas_ultralow0', 0.8671875,=
0.6640625,0.8984375,0.6953125)
+TexAtlas_RegisterMatTransform('tex_208', 'tex_atlas_ultralow0', 0.9140625,=
0.6640625,0.9453125,0.6953125)
+TexAtlas_RegisterMatTransform('tex_5351', 'tex_atlas_ultralow0', 0.9609375=
,0.6640625,0.9921875,0.6953125)
+TexAtlas_RegisterMatTransform('tex_5634', 'tex_atlas_ultralow0', 0.0078125=
,0.7109375,0.0390625,0.7421875)
+TexAtlas_RegisterMatTransform('tex_mushroom', 'tex_atlas_ultralow0', 0.054=
6875,0.7109375,0.0859375,0.7421875)
+TexAtlas_RegisterMatTransform('tex_mushroom2', 'tex_atlas_ultralow0', 0.10=
15625,0.7109375,0.1328125,0.7421875)
+TexAtlas_RegisterMatTransform('tex_slidingdoor', 'tex_atlas_ultralow0', 0.=
1484375,0.7109375,0.1796875,0.7421875)
+TexAtlas_RegisterMatTransform('tex_lantern', 'tex_atlas_ultralow0', 0.1953=
125,0.7109375,0.2265625,0.7421875)
+TexAtlas_RegisterMatTransform('tex_stoneplate', 'tex_atlas_ultralow0', 0.2=
421875,0.7109375,0.2734375,0.7421875)
+TexAtlas_RegisterMatTransform('tex_rune1', 'tex_atlas_ultralow0', 0.289062=
5,0.7109375,0.3203125,0.7421875)
+TexAtlas_RegisterMatTransform('tex_marblewall', 'tex_atlas_ultralow0', 0.3=
359375,0.7109375,0.3671875,0.7421875)
+TexAtlas_RegisterMatTransform('tex_sattel', 'tex_atlas_ultralow0', 0.38281=
25,0.7109375,0.4140625,0.7421875)
+TexAtlas_RegisterMatTransform('tex_portrait', 'tex_atlas_ultralow0', 0.429=
6875,0.7109375,0.4609375,0.7421875)
 TexAtlas_RegisterMatTransform('tex_483', 'tex_atlas_ultralow0', 0.0078125,=
0.7578125,0.0390625,0.7734375)
 TexAtlas_RegisterMatTransform('tex_564', 'tex_atlas_ultralow0', 0.0546875,=
0.7578125,0.0859375,0.7734375)
 TexAtlas_RegisterMatTransform('tex_286', 'tex_atlas_ultralow0', 0.1015625,=
0.7578125,0.1328125,0.7734375)

Modified: trunk/data/models/atlas/tex_atlas_ultralow0.png
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Tue Mar 25 15:48:39 2008
@@ -8257,6 +8257,34 @@
 	} =

 }
 =

+material tex_gravestone_big : tex_base
+{ =

+	technique =

+	{ =

+		pass =

+		{		=

+			texture_unit =

+			{ =

+				texture tex_gravestone_big.png =

+			}	=

+		}
+	} =

+}
+
+material tex_mud : tex_base
+{ =

+	technique =

+	{ =

+		pass =

+		{		=

+			texture_unit =

+			{ =

+				texture tex_mud.png =

+			}	=

+		}
+	} =

+}
+
 material tex_flowers : tex_base_sceneblend
 { =

 	technique =


Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Tue Mar 25 15:48:39 2008
@@ -5,7 +5,6 @@
 function InitArtFilter	()
 	for k,v in pairs(gArtFilter) do
 		if v.skip then
-			print("SKIP",k,v)
 			RegisterSkippedArtBillboardFallBack(k)
 		end
 	end
@@ -205,6 +204,31 @@
 gArtFilter[3757]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
 gArtFilter[3751]=3D{maptoid=3D3752,rotation=3D"x:0,y:0,z:270",xadd=3D0,yad=
d=3D0,zadd=3D0}
 =

+-- lantern
+gArtFilter[9412]=3D{maptoid=3D9411}
+gArtFilter[9410]=3D{maptoid=3D9411,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+gArtFilter[9409]=3D{maptoid=3D9411,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+
+-- gravestone & mud
+gArtFilter[3799]=3D{maptoid=3D3800,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+
+gArtFilter[3806]=3D{maptoid=3D3805,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+
+gArtFilter[3808]=3D{skip=3Dtrue}
+gArtFilter[3809]=3D{maptoid=3D3810,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+gArtFilter[3807]=3D{skip=3Dtrue}
+
+-- grass
+gArtFilter[3259]=3D{maptoid=3D3253}
+gArtFilter[3270]=3D{maptoid=3D3253}
+gArtFilter[3260]=3D{maptoid=3D3253}
+gArtFilter[3250]=3D{maptoid=3D3253}
+gArtFilter[3258]=3D{maptoid=3D3253}
+gArtFilter[3268]=3D{maptoid=3D3253}
+gArtFilter[3257]=3D{maptoid=3D3253}
+gArtFilter[3255]=3D{maptoid=3D3253}
+gArtFilter[3256]=3D{maptoid=3D3253}
+
 ----------------------------------------------------------------------
 =

 -- Seasonal Dynamic & Static Art Translation (run tiles)	-- eventuell (iTi=
leTypeID + 16384)
@@ -284,3 +308,106 @@
 --Foliage multiple tiles
 ["d45"]=3D-1
 })
+
+
+-- display the following fallbacks as ground plates
+gArtFallbackGroundPlateList =3D {
+	2739, 2740, 2741, 2742, 2743, =

+	2744, 2745, 2746, 2747, 4253, =

+	2729, 2730, 2731, 2732, 2733, =

+	2734, 2735, 2736, 2737, 4248, =

+	4249, 4250, 4251, 4252, 4254, =

+	4255, 4256, 4258, 4259, 13001,
+	6951, 6952, 6953, 6954, 6959,
+	6960, 6961, 6962, 10404, 10405,
+	9257, 9258, 9259, 9260, 9261,
+	9262, 9263, 9264, 9269, 9276, =

+	9286, 7635, 7637, 7639, 7641, =

+	7646, 7647, 7643, 7648, 7659,
+	1037, 1040, 1036, 1041, 10054,
+	10064, 10056, 10059, 10062, 10063,
+	10065, 9281, 9182, 9284, 9293,
+	9294, 10592, 10597, 11723, 11724, =

+	11725, 11726, 9256, 9272, =

+}
+
+
+function IsGroundPlate	(artid)
+	artid =3D tonumber(artid)
+	if artid >=3D 0x270 and artid <=3D 0x276 then return true end
+	if artid >=3D 0x40b and artid <=3D 0x41e then return true end
+	if artid >=3D 0x491 and artid <=3D 0x585 then return true end
+	if artid >=3D 0x5e1 and artid <=3D 0x5eb then return true end
+	if artid >=3D 0x62b and artid <=3D 0x632 then return true end
+	if artid >=3D 0x637 and artid <=3D 0x63e then return true end
+	if artid >=3D 0x81d and artid <=3D 0x81d then return true end
+	if artid >=3D 0xaa9 and artid <=3D 0xafa then return true end
+	if artid >=3D 0x1098 and artid <=3D 0x10a3 then return true end
+	if artid >=3D 0x11c0 and artid <=3D 0x11c5 then return true end
+	if artid >=3D 0x120e and artid <=3D 0x1216 then return true end
+	if artid >=3D 0x1274 and artid <=3D 0x1275 then return true end
+	if artid >=3D 0x1278 and artid <=3D 0x1279 then return true end
+	if artid >=3D 0x1281 and artid <=3D 0x1285 then return true end
+	if artid >=3D 0x1287 and artid <=3D 0x1291 then return true end
+	if artid >=3D 0x1293 and artid <=3D 0x1295 then return true end
+	if artid >=3D 0x12ee and artid <=3D 0x134d then return true end
+	if artid >=3D 0x136e and artid <=3D 0x136e then return true end
+	if artid >=3D 0x137e and artid <=3D 0x1386 then return true end
+	if artid >=3D 0x149f and artid <=3D 0x14d6 then return true end
+	if artid >=3D 0x150a and artid <=3D 0x1511 then return true end
+	if artid >=3D 0x177d and artid <=3D 0x1781 then return true end
+	if artid >=3D 0x1796 and artid <=3D 0x180d then return true end
+	if artid >=3D 0x1b27 and artid <=3D 0x1b3e then return true end
+	if artid >=3D 0x1b82 and artid <=3D 0x1b92 then return true end
+	if artid >=3D 0x1cc7 and artid <=3D 0x1cdc then return true end
+	if artid >=3D 0x1cf1 and artid <=3D 0x1d12 then return true end
+	if artid >=3D 0x1dd3 and artid <=3D 0x1dfc then return true end
+	if artid >=3D 0x1f24 and artid <=3D 0x1f27 then return true end
+	if artid >=3D 0x213f and artid <=3D 0x2144 then return true end
+	if artid >=3D 0x2425 and artid <=3D 0x2438 then return true end
+	if artid >=3D 0x243b and artid <=3D 0x246b then return true end
+	if artid >=3D 0x2720 and artid <=3D 0x2751 then return true end
+	if artid >=3D 0x286e and artid <=3D 0x2885 then return true end
+	if artid >=3D 0x28a4 and artid <=3D 0x28af then return true end
+	if artid >=3D 0x2960 and artid <=3D 0x298f then return true end
+	if artid >=3D 0x29c0 and artid <=3D 0x29cb then return true end
+	if artid >=3D 0x29d6 and artid <=3D 0x29db then return true end
+	if artid >=3D 0x2a1d and artid <=3D 0x2a29 then return true end
+	if artid >=3D 0x2a3c and artid <=3D 0x2a44 then return true end
+	if artid >=3D 0x2b3e and artid <=3D 0x2b65 then return true end
+	if artid >=3D 0x2bb5 and artid <=3D 0x2bb8 then return true end
+	if artid >=3D 0x2bcf and artid <=3D 0x2bcf then return true end
+	if artid >=3D 0x2cec and artid <=3D 0x2cee then return true end
+	if artid >=3D 0x2d38 and artid <=3D 0x2d3b then return true end
+	if artid >=3D 0x2dcb and artid <=3D 0x2dce then return true end
+	if artid >=3D 0x2e01 and artid <=3D 0x2e3b then return true end
+	if artid >=3D 0x2e40 and artid <=3D 0x2e47 then return true end
+	if artid >=3D 0x2e69 and artid <=3D 0x2f0e then return true end
+	if artid >=3D 0x2f62 and artid <=3D 0x2fb5 then return true end
+	if artid >=3D 0x3004 and artid <=3D 0x3007 then return true end
+	if artid >=3D 0x30e7 and artid <=3D 0x3109 then return true end
+	if artid >=3D 0x31f4 and artid <=3D 0x322a then return true end
+	if artid >=3D 0x3236 and artid <=3D 0x32a5 then return true end
+	if artid >=3D 0x32ac and artid <=3D 0x32ad then return true end
+	if artid >=3D 0x32b0 and artid <=3D 0x32b1 then return true end
+	if artid >=3D 0x32c9 and artid <=3D 0x32ca then return true end
+	if artid >=3D 0x337a and artid <=3D 0x337a then return true end
+	if artid >=3D 0x343b and artid <=3D 0x3457 then return true end
+	if artid >=3D 0x3462 and artid <=3D 0x3485 then return true end
+	if artid >=3D 0x3490 and artid <=3D 0x34ab then return true end
+	if artid >=3D 0x34b5 and artid <=3D 0x34d5 then return true end
+	if artid >=3D 0x3505 and artid <=3D 0x3504 then return true end
+	if artid >=3D 0x3523 and artid <=3D 0x3530 then return true end
+	if artid >=3D 0x3546 and artid <=3D 0x354e then return true end
+	if artid >=3D 0x3551 and artid <=3D 0x3552 then return true end
+	if artid >=3D 0x35b2 and artid <=3D 0x35bd then return true end
+	if artid >=3D 0x361a and artid <=3D 0x3622 then return true end
+	if artid >=3D 0x39d4 and artid <=3D 0x39e6 then return true end
+	if artid >=3D 0x3a1f and artid <=3D 0x3a32 then return true end
+	if artid >=3D 0x3a45 and artid <=3D 0x3a54 then return true end
+	if artid >=3D 0x3af0 and artid <=3D 0x3af8 then return true end
+	=

+	-- if in_array(artid, gArtFallbackGroundPlateList) then return true end
+	=

+	return false
+end

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Tue Mar 25 15:48:39 2008
@@ -307,7 +307,6 @@
 end
 ]]--
 =

-
 gArtBillBoardCache =3D {}
 function Renderer3D:CreateArtBillBoard( gfx, iArtID, iHue )
 	if (iArtID > gMaxArtValue) then return end
@@ -329,10 +328,9 @@
 =

 			l =3D 0*w/texsize(w)
 			r =3D 1*w/texsize(w)
-			t =3D 0*w/texsize(w)
+			t =3D 0*w/texsize(h)
 			b =3D h/texsize(h)
 			gArtBillBoardCache[iArtID.."_"..iHue] =3D {matname,l,t,r,b,w,h}
-			-- print("CreateArtBillBoard",matname,l,t,r,b,w,h)
 		else
 			gArtBillBoardCache[iArtID.."_"..iHue] =3D {nil}
 		end
@@ -344,14 +342,35 @@
 		gfx:SetSimpleRenderable()
 		gfx:SetMaterial(matname)
 		gfx:SetCastShadows(false)
-		gfx:SetForceRotCam(GetMainCam())
-		gfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
-		gfx:RenderableVertex( 0.5*w / isotilew,-0.5					,0, r,b)
-		gfx:RenderableVertex(-0.5*w / isotilew,-0.5					,0, l,b)
-		gfx:RenderableVertex( 0.5*w / isotilew,-0.5 + h / isotilew	,0, r,t)
-		gfx:RenderableVertex(-0.5*w / isotilew,-0.5 + h / isotilew	,0, l,t)
-		gfx:RenderableIndex3(0,1,2)
-		gfx:RenderableIndex3(1,3,2)
+		=

+		if IsGroundPlate(iArtID - 16384) then
+			-- ground plate fallback
+			local tw =3D 0.5*w/texsize(w)
+			local th =3D 0.5*h/texsize(h)
+			local dz =3D -0.49
+			local dx =3D -0.5
+			local dy =3D -0.5
+			=

+			gfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
+			gfx:RenderableVertex( 1+dx,0+dy,dz, tw,0)
+			gfx:RenderableVertex( 1+dx,1+dy,dz, 0,th)
+			gfx:RenderableVertex( 0+dx,0+dy,dz, r,th)
+			gfx:RenderableVertex( 0+dx,1+dy,dz, tw,b)
+			gfx:RenderableIndex3(0,1,2)
+			gfx:RenderableIndex3(1,3,2)
+			=

+		else		=

+			-- billboard
+			gfx:SetForceRotCam(GetMainCam())
+			gfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
+			gfx:RenderableVertex( 0.5*w / isotilew,-0.5					,0, r,b)
+			gfx:RenderableVertex(-0.5*w / isotilew,-0.5					,0, l,b)
+			gfx:RenderableVertex( 0.5*w / isotilew,-0.5 + h / isotilew	,0, r,t)
+			gfx:RenderableVertex(-0.5*w / isotilew,-0.5 + h / isotilew	,0, l,t)
+			gfx:RenderableIndex3(0,1,2)
+			gfx:RenderableIndex3(1,3,2)
+		end
+
 		gfx:RenderableEnd()
 		=

 	else

Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Tue Mar 25 15:48:39 2008
@@ -96,7 +96,7 @@
 	=

 	-- dump missing models as images
 	if gDumpMissingModels then
-		local skip =3D gSkippedArtBillboardFallBacks[iTranslatedTileTypeID]
+		local skip =3D gSkippedArtBillboardFallBacks[iTranslatedTileTypeID] or I=
sGroundPlate(iTranslatedTileTypeID)
 		local filename =3D "missing/"..iTranslatedTileTypeID..".png"
 		local filename_unmapped =3D "missing/"..iTileTypeID..".png"
 		=




From no-reply at zwischenwelt.org  Tue Mar 25 20:15:52 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 19:15:52 -0000
Subject: [Iris-commit] [IRIS] r1993 - /trunk/lua/lib.keybinds.lua
Message-ID: <20080325191554.564C8152402A@zwischenwelt.org>

Author: hagish
Date: Tue Mar 25 20:15:52 2008
New Revision: 1993

Log:
esc cancels target and closes game

Modified:
    trunk/lua/lib.keybinds.lua

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Tue Mar 25 20:15:52 2008
@@ -24,6 +24,9 @@
 =

 function BindInGameKeys()
 	UnbindAll()
+	=

+	BindGeneralKeys()
+	=

 	gLastCursor =3D 0
 =

     -- most keybinds have been moved to the macrosystem, see data/mymacros=
.lua



From no-reply at zwischenwelt.org  Tue Mar 25 20:30:26 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 19:30:26 -0000
Subject: [Iris-commit] [IRIS] r1994 - in /trunk: data/config.lua.dist
 lua/filter/filter.art.lua lua/lib.3d.dynamic.lua lua/lib.3d.map.lua
Message-ID: <20080325193030.137271C184C9@zwischenwelt.org>

Author: hagish
Date: Tue Mar 25 20:30:25 2008
New Revision: 1994

Log:
ground plate fallback option added

Modified:
    trunk/data/config.lua.dist
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.3d.map.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Tue Mar 25 20:30:25 2008
@@ -260,6 +260,7 @@
 -- incorrect fallbacks can be added to the skiplist using the fallbacktool=
 (f11)
 gEnableFallBackBillboards_Statics =3D false
 gEnableFallBackBillboards_Dynamics =3D true
+gEnableFallBackGroundPlates =3D true
 gForceFallBackBillboards_Statics =3D false
 gForceFallBackBillboards_Dynamics =3D false
 =


Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Tue Mar 25 20:30:25 2008
@@ -228,6 +228,7 @@
 gArtFilter[3257]=3D{maptoid=3D3253}
 gArtFilter[3255]=3D{maptoid=3D3253}
 gArtFilter[3256]=3D{maptoid=3D3253}
+gArtFilter[3261]=3D{maptoid=3D3253}
 =

 ----------------------------------------------------------------------
 =


Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Tue Mar 25 20:30:25 2008
@@ -221,10 +221,13 @@
 			self:UpdateDynamicVisibility(item)
 		=

 		-- Fallback billboard rendering
-		elseif (gEnableFallBackBillboards_Dynamics) then
+		else
 			local iTranslatedTileTypeID =3D SeasonalStaticTranslation(item.artid, g=
SeasonSetting)
 			-- fallback to billboard with original art
-			if (not IsArtBillboardFallBackSkipped(iTranslatedTileTypeID)) then
+			if ((gEnableFallBackBillboards_Dynamics or =

+				(gEnableFallBackGroundPlates and IsGroundPlate(iTranslatedTileTypeID))=
) and =

+				not IsArtBillboardFallBackSkipped(iTranslatedTileTypeID)) =

+			then
 				item.gfx =3D CreateRootGfx3D()
 				item.gfx.billboard =3D item.gfx:CreateChild()
 				item.xadd =3D item.xadd + 0.5
@@ -237,9 +240,9 @@
 				self:UpdateDynamicItemPos(item)
 				-- updates the layer-visibility
 				self:UpdateDynamicVisibility(item)
+			else
+				print("no mesh found & no dynamic billboard used for this artID=3D"..i=
tem.artid, item.meshname)
 			end
-		else
-			print("no mesh found & no dynamic billboard used for this artID=3D"..it=
em.artid, item.meshname)
 		end
 	end
 =


Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Tue Mar 25 20:30:25 2008
@@ -340,9 +340,13 @@
 =

 	-- if no *.mesh is available, a fallback billboard with original uo_art i=
s generated
 	-- What about cahing here ??
-	elseif (gEnableFallBackBillboards_Statics) then
+	else
 		local iTranslatedTileTypeID =3D SeasonalStaticTranslation(iTileTypeID, g=
SeasonSetting)
-		if (not IsArtBillboardFallBackSkipped(iTranslatedTileTypeID)) then
+		if (
+			(gEnableFallBackBillboards_Statics or =

+			(gEnableFallBackGroundPlates and IsGroundPlate(iTranslatedTileTypeID))
+			) and not IsArtBillboardFallBackSkipped(iTranslatedTileTypeID)) =

+		then
 			entity.x,entity.y,entity.z =3D self:UOPosToLocal(entity.xloc+0.5,entity=
.yloc+0.5,entity.zloc*0.1 + 0.5)
 			entity.gfx =3D CreateRootGfx3D()
 			entity.gfx:SetPosition(entity.x,entity.y,entity.z)



From no-reply at zwischenwelt.org  Tue Mar 25 21:54:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 20:54:14 -0000
Subject: [Iris-commit] [IRIS] r1995 - in /trunk/lua:
 filter/filter.granny.lua lib.bodygfx.lua lib.granny.lua
Message-ID: <20080325205415.3B0551C18778@zwischenwelt.org>

Author: sience
Date: Tue Mar 25 21:54:13 2008
New Revision: 1995

Log:
-small update to use custom granny meshes

Modified:
    trunk/lua/filter/filter.granny.lua
    trunk/lua/lib.bodygfx.lua
    trunk/lua/lib.granny.lua

Modified: trunk/lua/filter/filter.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.granny.lua (original)
+++ trunk/lua/filter/filter.granny.lua Tue Mar 25 21:54:13 2008
@@ -29,6 +29,7 @@
 -- custom models can be applyed instead to grannys, just tell the meshname
 --gGrannyFilter[153]	=3D{meshname=3D"Lich.mesh"}
 --gGrannyFilter[154]	=3D{meshname=3D"mummy.mesh"}
+--gGrannyFilter[618]	=3D{meshname=3D"sword.mesh"}
 =

 gGrannyFilter[987]	=3D{grannyid=3D400}
 gGrannyFilter[1987]	=3D{grannyid=3D401}

Modified: trunk/lua/lib.bodygfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bodygfx.lua (original)
+++ trunk/lua/lib.bodygfx.lua Tue Mar 25 21:54:13 2008
@@ -147,13 +147,8 @@
 	local bodyid =3D self:GetBodyID()
 	self.modelparts =3D {}
 	=

-	local meshname =3D GrannyMeshOverride(bodyid)
-	if meshname then
-		CreateBodyFromMesh (meshname,self.groupgfx,self.modelparts)
-	else
-		local modelidarr,iPrimaryHandItem,iSecondaryHandItem =3D self:GetModelPa=
rtModelIDs()
-		CreateBodyGfxPartsFromModelIDArray(bodyid,self.groupgfx,self.modelparts,=
modelidarr,iPrimaryHandItem,iSecondaryHandItem)
-	end
+	local modelidarr,iPrimaryHandItem,iSecondaryHandItem =3D self:GetModelPar=
tModelIDs()
+	CreateBodyGfxPartsFromModelIDArray(bodyid,self.groupgfx,self.modelparts,m=
odelidarr,iPrimaryHandItem,iSecondaryHandItem)
 =

 	-- create mount gfx (todo : replace by CreateBodyGfx or update bodygfx fo=
r mount)
 	local mount =3D self:GetEquipmentAtLayer(kLayer_Mount)
@@ -257,21 +252,13 @@
 =

 -- ##### ##### ##### ##### ##### generating gfx
 =

--- helper function for CreateBodyFromMesh
-function MakeBodyGfx	(meshname,partgfx,forcescalex,forcescaley,forcescalez)
-	partgfx:SetMesh(meshname)
-	partgfx:SetCastShadows(gMobileCastShadows)
-	return partgfx
-end
--- Add Custom Mobile Meshes
-function CreateBodyFromMesh (meshname,parentgfx,partsarr)
-	local partgfx =3D MakeBodyGfx(meshname,parentgfx:CreateChild(),1,1,1)
-	table.insert(partsarr,partgfx)
-end
-
 -- helper function for CreateBodyGfxPartsFromModelIDArray
 function MakeBodyPartGfx	(modelid,meshname,partgfx,forcescalex,forcescaley=
,forcescalez)
-	partgfx:SetMesh(meshname)
+	-- Override default Granny-Mesh with custom defined Ogre-Mesh from filter=
.granny.lua
+	local meshnameoverride =3D GrannyMeshOverride(modelid)
+	if (meshnameoverride) then meshname =3D meshnameoverride end
+
+	partgfx:SetMesh(GrannyMeshOverride(modelid) or meshname)
 	partgfx:SetCastShadows(gMobileCastShadows)	=

 	=

 	local modelinfo =3D GetGrannyModelInfo(modelid)
@@ -303,14 +290,14 @@
 	local rightHandBoneName1
 	local rightHandBoneName2
 	local handname =

-	=

+
 	local fsx,fsy,fsz -- force the scale  of the main body to all bodyparts
 	local modelinfo =3D GetGrannyModelInfo(bodyid)
 	if (IsBodyIDHuman(bodyid)) then =

 		local s =3D gGrannyScaleFactor
 		fsx,fsy,fsz =3D s*modelinfo.scalex,s*modelinfo.scaley,s*modelinfo.scalez
 	end
-	=

+		=

 	for k,element in pairs(modelidarr) do
 		local modelid =3D element.modelid
 		if (modelid ~=3D (iPrimaryHandItem and iPrimaryHandItem.modelid) and mod=
elid ~=3D (iSecondaryHandItem and iSecondaryHandItem.modelid)) then
@@ -326,7 +313,7 @@
 			end
 		end
 	end
-	=

+
 	-- prefer rightHandEntity1(grasp) over rightHandEntity2
 	if (not rightHandEntity1) then rightHandEntity1 =3D rightHandEntity2 righ=
tHandBoneName1 =3D rightHandBoneName2 end
 	if (not  leftHandEntity1) then  leftHandEntity1 =3D  leftHandEntity2  lef=
tHandBoneName1 =3D  leftHandBoneName2 end

Modified: trunk/lua/lib.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.lua (original)
+++ trunk/lua/lib.granny.lua Tue Mar 25 21:54:13 2008
@@ -244,7 +244,6 @@
 		=

 		-- uses defaulthue=3Ddefhue from models.txt (FFFFFFFF : alpha-r-g-b)
 		if (hue =3D=3D 0) then
---			local modelinfo =3D GetGrannyModelInfo(modelid) =

 			if (modelinfo) then
 				local r =3D tonumber(string.sub(modelinfo.defhue,3,3 + 1),16) / 255.0
 				local g =3D tonumber(string.sub(modelinfo.defhue,5,5 + 1),16) / 255.0



From no-reply at zwischenwelt.org  Tue Mar 25 23:21:16 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 22:21:16 -0000
Subject: [Iris-commit] [IRIS] r1996 - /trunk/lua/lib.3d.dynamic.lua
Message-ID: <20080325222116.66B3F152402A@zwischenwelt.org>

Author: sience
Date: Tue Mar 25 23:21:14 2008
New Revision: 1996

Log:
-small check added for skippedfallbacks

Modified:
    trunk/lua/lib.3d.dynamic.lua

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Tue Mar 25 23:21:14 2008
@@ -240,7 +240,7 @@
 				self:UpdateDynamicItemPos(item)
 				-- updates the layer-visibility
 				self:UpdateDynamicVisibility(item)
-			else
+			elseif (not IsArtBillboardFallBackSkipped(iTranslatedTileTypeID)) then
 				print("no mesh found & no dynamic billboard used for this artID=3D"..i=
tem.artid, item.meshname)
 			end
 		end



From no-reply at zwischenwelt.org  Wed Mar 26 00:47:12 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Mar 2008 23:47:12 -0000
Subject: [Iris-commit] [IRIS] r1997 - in /rawdata/sd_pd: houseparts.blend
 tex_gravestone_big.png tex_mud.png tex_portrait.png
Message-ID: <20080326000018.229FF1C18749@zwischenwelt.org>

Author: hagish
Date: Wed Mar 26 00:47:10 2008
New Revision: 1997

Log:
updated model file

Added:
    rawdata/sd_pd/tex_gravestone_big.png   (with props)
    rawdata/sd_pd/tex_mud.png   (with props)
    rawdata/sd_pd/tex_portrait.png   (with props)
Modified:
    rawdata/sd_pd/houseparts.blend

Modified: rawdata/sd_pd/houseparts.blend
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Wed Mar 26 21:49:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 26 Mar 2008 20:49:54 -0000
Subject: [Iris-commit] [IRIS] r1998 - in /trunk/lua: filter/filter.art.lua
 filter/filter.granny.lua lib.3d.dynamic.lua
Message-ID: <20080326204954.C0E781C1879E@zwischenwelt.org>

Author: sience
Date: Wed Mar 26 21:49:53 2008
New Revision: 1998

Log:
-some small fixes to filters
-debuginfo removed from lib.3d.dynamic.lua

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/filter/filter.granny.lua
    trunk/lua/lib.3d.dynamic.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Wed Mar 26 21:49:53 2008
@@ -1,4 +1,5 @@
---here we map ArtIDs to another ID, Model, Mesh or we change tiledata entr=
y, add particles or skeletons
+--This Array holds a list with modifications: map ArtIDs to another ArtID,=
 Ogre-Mesh, Orientation, Position
+--later we can change Scaling, tiledata entry, add particles or skeletons =
too
 gArtFilter =3D {}
 =

 -- adds all the skipped meshes to the skip art fallback file
@@ -60,6 +61,8 @@
 	end
 end
 =

+----------------------------------------------------------------------
+
 --armoire - left
 --opened
 gArtFilter[2636]=3D{maptoid=3D2637}
@@ -86,53 +89,57 @@
 gArtFilter[3344]=3D{maptoid=3D3342,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 gArtFilter[3345]=3D{maptoid=3D3341,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 =

-
---Groundtiles (static)
---dirt
-gArtFilter[12789]=3D{maptoid=3D12788}
-gArtFilter[12790]=3D{maptoid=3D12788}
-gArtFilter[12791]=3D{maptoid=3D12788}
-gArtFilter[12792]=3D{maptoid=3D12788}
-gArtFilter[12793]=3D{maptoid=3D12788}
-gArtFilter[12794]=3D{maptoid=3D12788}
-gArtFilter[12795]=3D{maptoid=3D12788}
-
---lava
+-- lava
 gArtFilter[6682]=3D{maptoid=3D6681}
 gArtFilter[6683]=3D{maptoid=3D6681}
 gArtFilter[6684]=3D{maptoid=3D6681}
 gArtFilter[6685]=3D{maptoid=3D6681}
 =

+-- Blood
 gArtFilter[4651]=3D{maptoid=3D4650}
 gArtFilter[4652]=3D{maptoid=3D4650}
 gArtFilter[4653]=3D{maptoid=3D4650}
 gArtFilter[4654]=3D{maptoid=3D4650}
 gArtFilter[4655]=3D{maptoid=3D4650}
 =

---grass
--- map to 0xcb5 / 3253
-gArtFilter[hex2num("0xcac")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcad")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcae")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcaf")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcb0")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcb1")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcb2")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcb3")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcb4")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xcb6")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xd32")]=3D{maptoid=3D3253}
-gArtFilter[hex2num("0xd33")]=3D{maptoid=3D3253}
-
---fern / farne
-gArtFilter[hex2num("0xca1")]=3D{maptoid=3D3232}
-gArtFilter[hex2num("0xca2")]=3D{maptoid=3D3232}
-gArtFilter[hex2num("0xca3")]=3D{maptoid=3D3232}
-gArtFilter[hex2num("0xca4")]=3D{maptoid=3D3232}
-gArtFilter[hex2num("0xc9f")]=3D{maptoid=3D3232}
+--Vegetation
+-- grass
+gArtFilter[3244]=3D{maptoid=3D3253}
+gArtFilter[3245]=3D{maptoid=3D3253}
+gArtFilter[3246]=3D{maptoid=3D3253}
+gArtFilter[3247]=3D{maptoid=3D3253}
+gArtFilter[3248]=3D{maptoid=3D3253}
+gArtFilter[3249]=3D{maptoid=3D3253}
+gArtFilter[3250]=3D{maptoid=3D3253}
+gArtFilter[3251]=3D{maptoid=3D3253}
+gArtFilter[3252]=3D{maptoid=3D3253}
+gArtFilter[3254]=3D{maptoid=3D3253}
+gArtFilter[3257]=3D{maptoid=3D3253}
+gArtFilter[3258]=3D{maptoid=3D3253}
+gArtFilter[3259]=3D{maptoid=3D3253}
+gArtFilter[3260]=3D{maptoid=3D3253}
+gArtFilter[3261]=3D{maptoid=3D3253}
+gArtFilter[3378]=3D{maptoid=3D3253}
+gArtFilter[3379]=3D{maptoid=3D3253}
+gArtFilter[3259]=3D{maptoid=3D3253}
+gArtFilter[3270]=3D{maptoid=3D3253}
+gArtFilter[3260]=3D{maptoid=3D3253}
+gArtFilter[3250]=3D{maptoid=3D3253}
+gArtFilter[3258]=3D{maptoid=3D3253}
+gArtFilter[3268]=3D{maptoid=3D3253}
+gArtFilter[3257]=3D{maptoid=3D3253}
+gArtFilter[3255]=3D{maptoid=3D3253}
+gArtFilter[3256]=3D{maptoid=3D3253}
+gArtFilter[3261]=3D{maptoid=3D3253}
+
+-- fern / farne
+gArtFilter[3233]=3D{maptoid=3D3232}
+gArtFilter[3234]=3D{maptoid=3D3232}
+gArtFilter[3235]=3D{maptoid=3D3232}
+gArtFilter[3236]=3D{maptoid=3D3232}
+gArtFilter[3231]=3D{maptoid=3D3232}
 =

 -- barks
--- map to 3274
 gArtFilter[3275]=3D{maptoid=3D3274}
 gArtFilter[3276]=3D{maptoid=3D3274}
 gArtFilter[3277]=3D{maptoid=3D3274}
@@ -163,6 +170,7 @@
 gArtFilter[3353]=3D{maptoid=3D3351}
 gArtFilter[3349]=3D{maptoid=3D3350}
 =

+--Rest
 -- houseparts
 gArtFilter[10761]=3D{maptoid=3D10763}
 gArtFilter[10759]=3D{maptoid=3D10763,rotation=3D"x:0,y:0,z:90",xadd=3D0,ya=
dd=3D1.85,zadd=3D0}
@@ -217,18 +225,6 @@
 gArtFilter[3808]=3D{skip=3Dtrue}
 gArtFilter[3809]=3D{maptoid=3D3810,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
 gArtFilter[3807]=3D{skip=3Dtrue}
-
--- grass
-gArtFilter[3259]=3D{maptoid=3D3253}
-gArtFilter[3270]=3D{maptoid=3D3253}
-gArtFilter[3260]=3D{maptoid=3D3253}
-gArtFilter[3250]=3D{maptoid=3D3253}
-gArtFilter[3258]=3D{maptoid=3D3253}
-gArtFilter[3268]=3D{maptoid=3D3253}
-gArtFilter[3257]=3D{maptoid=3D3253}
-gArtFilter[3255]=3D{maptoid=3D3253}
-gArtFilter[3256]=3D{maptoid=3D3253}
-gArtFilter[3261]=3D{maptoid=3D3253}
 =

 ----------------------------------------------------------------------
 =

@@ -310,6 +306,7 @@
 ["d45"]=3D-1
 })
 =

+----------------------------------------------------------------------
 =

 -- display the following fallbacks as ground plates
 gArtFallbackGroundPlateList =3D {

Modified: trunk/lua/filter/filter.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.granny.lua (original)
+++ trunk/lua/filter/filter.granny.lua Wed Mar 26 21:49:53 2008
@@ -30,6 +30,7 @@
 --gGrannyFilter[153]	=3D{meshname=3D"Lich.mesh"}
 --gGrannyFilter[154]	=3D{meshname=3D"mummy.mesh"}
 --gGrannyFilter[618]	=3D{meshname=3D"sword.mesh"}
+--gGrannyFilter[577] =3D {meshname=3D"shield.mesh"}
 =

 gGrannyFilter[987]	=3D{grannyid=3D400}
 gGrannyFilter[1987]	=3D{grannyid=3D401}

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Wed Mar 26 21:49:53 2008
@@ -240,8 +240,6 @@
 				self:UpdateDynamicItemPos(item)
 				-- updates the layer-visibility
 				self:UpdateDynamicVisibility(item)
-			elseif (not IsArtBillboardFallBackSkipped(iTranslatedTileTypeID)) then
-				print("no mesh found & no dynamic billboard used for this artID=3D"..i=
tem.artid, item.meshname)
 			end
 		end
 	end



From no-reply at zwischenwelt.org  Fri Mar 28 21:40:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 28 Mar 2008 20:40:41 -0000
Subject: [Iris-commit] [IRIS] r1999 - in /trunk/lua: lib.keybinds.lua
	main.lua
Message-ID: <20080328210017.0FAAA1C18787@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Mar 28 21:40:40 2008
New Revision: 1999

Log:
profiler keybind

Modified:
    trunk/lua/lib.keybinds.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Fri Mar 28 21:40:40 2008
@@ -1,10 +1,22 @@
 gDoubleClickIntervall =3D 800 -- override lugre default interval
 =

 function BindGeneralKeys ()
+	Bind("f12", function (state) if (state > 0) then
+		if gKeyPressed[key_lshift] then
+			StartGlobalProfiler()
+		elseif gKeyPressed[key_lcontrol] then
+			StopGlobalProfiler()
+		elseif gKeyPressed[key_lalt] then
+			GlobalProfilerClearData()
+		else
+			GlobalProfilerOutput()
+		end
+	end end)
+
 	Bind("escape",	function (state) =

 			if (state > 0) then =

 			if (not gActiveEditText) then =

-				if gTargetModeActive then CancelTargetMode() else Terminate() end =

+				if gTargetModeActive then CancelTargetMode() else GlobalProfilerOutput=
() Terminate() end =

 			else
 				DeactivateCurEditText()
 			end =


Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Fri Mar 28 21:40:40 2008
@@ -266,6 +266,8 @@
 	=

 	HandleCommandLine()
 	=

+	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end
+	=

 	CheckUODir()
 	=

 	LoadPlugins_Iris()



From no-reply at zwischenwelt.org  Fri Mar 28 23:53:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 28 Mar 2008 22:53:59 -0000
Subject: [Iris-commit] [IRIS] r2000 - in /trunk/lua: lib.protocol.lua
 lib.tilefreewalk.lua lib.walking3.lua
Message-ID: <20080328225403.ADD2D1C18749@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Mar 28 23:53:55 2008
New Revision: 2000

Log:
worked a bit on runuo1 walking code port

Modified:
    trunk/lua/lib.protocol.lua
    trunk/lua/lib.tilefreewalk.lua
    trunk/lua/lib.walking3.lua

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Fri Mar 28 23:53:55 2008
@@ -35,7 +35,7 @@
 	for k,v in pairs(gPacketType) do gPacketTypeId2Name[v.id] =3D k end
 	for k,v in pairs(gPacketType) do _G[k] =3D v.id end -- make names availab=
le as global constants, like kPacket_Account_Login_Request, needed for send=
ing
 	=

-function DirWrap (iDir) -- wraps into [0,7]
+function DirWrap (iDir) -- wraps into [0,7], also removes runflag automati=
cally, but a bit expensive for that
 	while (iDir < 0) do iDir =3D iDir + 8 end
 	while (iDir > 7) do iDir =3D iDir - 8 end
 	return iDir
@@ -53,7 +53,7 @@
 function GetDirYLocal (dir) return GetDirY(dir) end
 =

 -- interpret dircode in uo coordinate system  uneven numbers (1,3,5,7) are=
 diagonal
-function DirisDiagonal (dir) return dir =3D=3D 1 or dir =3D=3D 3 or dir =
=3D=3D 5 or dir =3D=3D 7 end
+function DirIsDiagonal (dir) return dir =3D=3D 1 or dir =3D=3D 3 or dir =
=3D=3D 5 or dir =3D=3D 7 end
 function GetDirX (dir) =

 	if (dir =3D=3D 1 or dir =3D=3D 2 or dir =3D=3D 3) then return 1 -- east
 	elseif (dir =3D=3D 5 or dir =3D=3D 6 or dir =3D=3D 7) then return -1 -- w=
est

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Fri Mar 28 23:53:55 2008
@@ -595,7 +595,7 @@
 		local iNewZ =3D self:Impl_CalcWalkStep(xloc2,yloc2,zloc,iDir)
 		RegisterZ(ldx,ldy,iNewZ)
 		if (iNewZ) then iSelfZ =3D self:Impl_CalcWalkStep(xloc,yloc,zloc,DirWrap=
(iDir+4)) or iSelfZ end
-		--~ if (iNewZ and (not DirisDiagonal(iDir))) then =

+		--~ if (iNewZ and (not DirIsDiagonal(iDir))) then =

 			--~ local iDirL,iDirR =3D DirWrap(iDir-2),DirWrap(iDir+2) =

 			--~ RegisterZ(ldx+GetDirXLocal(iDirL),ldy+GetDirYLocal(iDirL),self:Impl=
_CalcWalkStep(xloc2+GetDirX(iDirL),yloc2+GetDirY(iDirL),iNewZ,iDirL))
 			--~ RegisterZ(ldx+GetDirXLocal(iDirR),ldy+GetDirYLocal(iDirR),self:Impl=
_CalcWalkStep(xloc2+GetDirX(iDirR),yloc2+GetDirY(iDirR),iNewZ,iDirR))

Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Fri Mar 28 23:53:55 2008
@@ -10,8 +10,8 @@
 end
 ]]--
 =

-kHex_4000 =3D hex2num("0x4000")
-kHex_3FFF =3D hex2num("0x3FFF")
+kHex_4000 =3D 0x4000
+kHex_3FFF =3D 0x3FFF
 =

 kTileFlag =3D {}
 kTileFlag.Wet			=3D kTileDataFlag_Wet
@@ -26,7 +26,7 @@
 kTileData.LandTable =3D {}
 -- kTileData.ItemTable[BitwiseAND(check.ID,kHex_3FFF)]  itemData.Flags  .H=
eight  .CalcHeight  .Bridge
 --~ kTileData.LandTable[BitwiseAND(landTile.ID,kHex_3FFF)]  .Flags
--- m.CanSwim m.CantWalk  m.CantWalk  m.Alive) or m.Body.BodyID =3D=3D hex2=
num("0x3DB") or m.IsDeadBondedPet m.Z    m.IsDeadBondedPet
+-- m.CanSwim m.CantWalk  m.CantWalk  m.Alive) or m.Body.BodyID =3D=3D 0x3D=
B or m.IsDeadBondedPet m.Z    m.IsDeadBondedPet
 -- item.ItemData.Impassable  item.ItemData.Flags
 -- item.Movable item.Z =

 -- item.AtWorldPoint( xStart, yStart ) and item.ItemID =

@@ -44,139 +44,51 @@
 =

 =

 function ApplyDir (dir,posx,posy) =

-	dir =3D DirWrap(BitwiseAND(dir,7)) -- warp and remove run bit
+	dir =3D DirWrap(dir) -- warp and remove run bit
 	return posx+GetDirX(dir),posy+GetDirY(dir)
 end =

 =

 --- bMoveIsOk,newZ =3D CheckMovement( Mobile m, Map map, Point3D loc, Dire=
ction d, out int newZ )
 -- see also RunUO1.0/Scripts/Engines/Pathing/Movement.cs : CheckMovement a=
nd Check
 -- TODO : see also RunUO1.0/src/Mobile.cs : Move : checks items(dynamics?)=
 and mobiles
+-- m=3Dmobile , d=3Ddir
 function CheckMovement( m, map, posx,posy,posz, d)
-	d =3D DirWrap(d)
-	local newZ =3D 0
+	d =3D DirWrap(d) -- alsor removes runflag
+	local moveIsOk,newZ =3D false,0
 	if (map =3D=3D nil) then return false,newZ end
 =

 	local xStart =3D posx -- ints
 	local yStart =3D posy
-	local xForward	, yForward	=3D xStart,yStart
-	local xRight	, yRight	=3D xStart,yStart
-	local xLeft		, yLeft		=3D xStart,yStart
-
-	local checkDiagonals =3D DirisDiagonal(d) -- see lib.protocol.lua:56:
-
-	xForward,yForward	=3D ApplyDir( d, xForward,yForward )
-	xLeft,yLeft			=3D ApplyDir( d - 1, xLeft,yLeft )
-	xRight,yRight		=3D ApplyDir( d + 1, xRight,yRight )
+	local xForward	, yForward	=3D ApplyDir( d    , xForward	,yForward	)
+	local xLeft		, yLeft		=3D ApplyDir( d - 1, xLeft	,yLeft		)
+	local xRight	, yRight	=3D ApplyDir( d + 1, xRight	,yRight		)
 =

 	if ( xForward < 0 or yForward < 0 or xForward >=3D map.Width or yForward =
>=3D map.Height ) then return false,newZ end
-
-	local startZ, startTop -- int
-
-	local itemsStart	=3D {} -- ArrayList
-	local itemsForward	=3D {}
-	local itemsLeft		=3D {}
-	local itemsRight	=3D {}
-	local items
+	=

+	local checkDiagonals =3D DirIsDiagonal(d) -- see lib.protocol.lua:56:
 =

 	local ignoreMovableImpassables =3D kIgnoreMovableImpassables -- bool
 	local reqFlags =3D kImpassableSurface -- TileFlag
 =

 	if ( m.CanSwim ) then reqFlags =3D BitwiseOR(reqFlags,kTileFlag.Wet) end
 =

-	if ( checkDiagonals ) then
-		local sectorStart	=3D map.GetSector( xStart, yStart ) -- Sector
-		local sectorForward	=3D map.GetSector( xForward, yForward )
-		local sectorLeft	=3D map.GetSector( xLeft, yLeft )
-		local sectorRight	=3D map.GetSector( xRight, yRight )
-
-		local sectors =3D {} -- ArrayList
-
-		table.insert(sectors, sectorStart )
-
-		if ( not sectors.Contains( sectorForward	) ) then table.insert(sectors, =
sectorForward ) end
-		if ( not sectors.Contains( sectorLeft		) ) then table.insert(sectors, se=
ctorLeft ) end
-		if ( not sectors.Contains( sectorRight		) ) then table.insert(sectors, s=
ectorRight ) end
-
-		for i,sector in pairs(sectors)  do -- Sector
-			items =3D sector.Items
-
-			for j,item in pairs(items) do -- Item
+	local filterItemFun =3D function (item)
+		if ( ignoreMovableImpassables and item.Movable and item.ItemData.Impassa=
ble ) then return false end
+		if ( BitwiseAND(item.ItemData.Flags,reqFlags) =3D=3D 0 ) then return fal=
se end
+		return item.ItemID < kHex_4000
+	end
 	=

-				if ( ignoreMovableImpassables and item.Movable and item.ItemData.Impas=
sable ) then =

-					-- continue
-				elseif ( BitwiseAND(item.ItemData.Flags,reqFlags) =3D=3D 0 ) then =

-					-- continue
-				else
-					if ( sector =3D=3D sectorStart and item.AtWorldPoint( xStart, yStart =
) and item.ItemID < kHex_4000 ) then
-						table.insert(itemsStart, item )
-					elseif ( sector =3D=3D sectorForward and item.AtWorldPoint( xForward,=
 yForward ) and item.ItemID < kHex_4000 ) then
-						table.insert(itemsForward, item )
-					elseif ( sector =3D=3D sectorLeft and item.AtWorldPoint( xLeft, yLeft=
 ) and item.ItemID < kHex_4000 ) then
-						table.insert(itemsLeft, item )
-					elseif ( sector =3D=3D sectorRight and item.AtWorldPoint( xRight, yRi=
ght ) and item.ItemID < kHex_4000 ) then
-						table.insert(itemsRight, item )
-					end
-				end
-			end
-		end
-	else
-		local sectorStart =3D map.GetSector( xStart, yStart ) -- Sector
-		local sectorForward =3D map.GetSector( xForward, yForward )
-
-		if ( sectorStart =3D=3D sectorForward ) then
-			items =3D sectorStart.Items
-
-			for i,item in pairs(items) do -- Item
-				if ( ignoreMovableImpassables and item.Movable and item.ItemData.Impas=
sable ) then
-					-- continue
-				elseif ( BitwiseAND(item.ItemData.Flags,reqFlags) =3D=3D 0 ) then
-					-- continue
-				else
-					if ( item.AtWorldPoint( xStart, yStart ) and item.ItemID < kHex_4000 =
) then
-						table.insert(itemsStart, item )
-					elseif ( item.AtWorldPoint( xForward, yForward ) and item.ItemID < kH=
ex_4000 ) then
-						table.insert(itemsForward, item )
-					end
-				end
-			end
-		else
-			items =3D sectorForward.Items
-
-			for i,item in pairs(items) do -- Item
-				if ( ignoreMovableImpassables and item.Movable and item.ItemData.Impas=
sable ) then
-					--continue
-				elseif ( BitwiseAND(item.ItemData.Flags,reqFlags) =3D=3D 0 ) then
-					--continue
-				else =

-					if ( item.AtWorldPoint( xForward, yForward ) and item.ItemID < kHex_4=
000 ) then
-						table.insert(itemsForward, item )
-					end
-				end
-			end
-
-			items =3D sectorStart.Items
-
-			for i,item in pairs(items) do -- Item
-
-				if ( ignoreMovableImpassables and item.Movable and item.ItemData.Impas=
sable ) then
-					-- continue
-				elseif ( BitwiseAND(item.ItemData.Flags,reqFlags) =3D=3D 0 ) then
-					--continue
-				else
-					if ( item.AtWorldPoint( xStart, yStart ) and item.ItemID < kHex_4000 =
) then
-						table.insert(itemsStart, item )
-					end
-				end
-			end
-		end
-	end
-
-	startZ,startTop =3D GetStartZ( m, map, posx,posy,posz, itemsStart)
-
-	local moveIsOk
+	local itemsStart	=3D FilterArray(map.GetItemsAtPos(xStart	,yStart		),filt=
erItemFun)
+	local itemsForward	=3D FilterArray(map.GetItemsAtPos(xForward	,yForward	)=
,filterItemFun)
+	local items
+	=

+	local startZ,startTop =3D GetStartZ( m, map, posx,posy,posz, itemsStart)
+
 	moveIsOk,newZ =3D Check( map, m, itemsForward, xForward, yForward, startT=
op, startZ, m.CanSwim, m.CantWalk)
 =

 	if ( moveIsOk and checkDiagonals ) then
+		local itemsLeft		=3D FilterArray(map.GetItemsAtPos(xLeft	,yLeft		),filte=
rItemFun)
+		local itemsRight	=3D FilterArray(map.GetItemsAtPos(xRight	,yRight		),fil=
terItemFun)
 		local myok1,ignored_z =3D Check( map, m, itemsLeft , xLeft , yLeft , sta=
rtTop, startZ, m.CanSwim, m.CantWalk)
 		local myok2,ignored_z =3D Check( map, m, itemsRight, xRight, yRight, sta=
rtTop, startZ, m.CanSwim, m.CantWalk)
 		if ( (not myok1) and (not myok2) ) then  moveIsOk =3D false  end
@@ -192,8 +104,7 @@
 	for i,check in pairs(tiles) do -- Tile  ( check.ID check.Z )
 		local itemData =3D kTileData.ItemTable[BitwiseAND(check.ID,kHex_3FFF)] -=
- ItemData
 =

-		if ( BitwiseAND(itemData.Flags,kImpassableSurface) ~=3D 0 ) -- Impassabl=
e or Surface
-		then
+		if ( BitwiseAND(itemData.Flags,kImpassableSurface) ~=3D 0 ) then -- Impa=
ssable or Surface
 			local checkZ =3D check.Z -- int
 			local checkTop =3D checkZ + itemData.CalcHeight -- int
 =

@@ -211,10 +122,10 @@
 		if ( BitwiseAND(flags,kImpassableSurface) ~=3D 0 ) -- Impassable or Surf=
ace
 		then
 			if ( ignoreDoors and (BitwiseAND(flags,kTileFlag.Door) ~=3D 0 or =

-				itemID =3D=3D hex2num("0x692") or =

-				itemID =3D=3D hex2num("0x846") or =

-				itemID =3D=3D hex2num("0x873") or =

-				(itemID >=3D hex2num("0x6F5") and itemID <=3D hex2num("0x6F6"))) ) then
+				itemID =3D=3D 0x692 or =

+				itemID =3D=3D 0x846 or =

+				itemID =3D=3D 0x873 or =

+				(itemID >=3D 0x6F5 and itemID <=3D 0x6F6)) ) then
 				--continue
 			else
 				local checkZ =3D item.Z -- int
@@ -234,8 +145,8 @@
 function Check(  map,  m,  items,  x,  y,  startTop,  startZ,  canSwim,  c=
antWalk )
 	local newZ =3D 0
 =

-	local tiles =3D map.Tiles.GetStaticTiles( x, y, true ) -- Tile[]
-	local landTile =3D map.Tiles.GetLandTile( x, y ) -- Tile
+	local tiles		=3D map.Tiles.GetStaticTiles( x, y, true ) -- Tile[]
+	local landTile	=3D map.Tiles.GetLandTile( x, y ) -- Tile
 =

 	local landBlocks =3D BitwiseAND(kTileData.LandTable[BitwiseAND(landTile.I=
D,kHex_3FFF)].Flags,kTileFlag.Impassable) ~=3D 0 -- bool
 	local considerLand =3D not landTile.Ignored -- bool
@@ -257,7 +168,7 @@
 	local stepTop =3D startTop + kStepHeight
 	local checkTop =3D startZ + kPersonHeight
 =

-	local ignoreDoors =3D ( kAlwaysIgnoreDoors or (not m.Alive) or m.Body.Bod=
yID =3D=3D hex2num("0x3DB") or m.IsDeadBondedPet )
+	local ignoreDoors =3D ( kAlwaysIgnoreDoors or (not m.Alive) or m.Body.Bod=
yID =3D=3D 0x3DB or m.IsDeadBondedPet )
 =

 	for i,tile in pairs(tiles) do -- Tile
 		local itemData =3D kTileData.ItemTable[BitwiseAND(tile.ID,kHex_3FFF)] --=
 ItemData



From no-reply at zwischenwelt.org  Sat Mar 29 02:06:22 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 29 Mar 2008 01:06:22 -0000
Subject: [Iris-commit] [IRIS] r2001 - /trunk/lua/lib.keybinds.lua
Message-ID: <20080329020013.11DB21C18749@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Mar 29 02:06:21 2008
New Revision: 2001

Log:
bugfix : listeners should only be registered once as they are not cleared b=
y input:UnBindAll

Modified:
    trunk/lua/lib.keybinds.lua

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Sat Mar 29 02:06:21 2008
@@ -23,15 +23,18 @@
 			end =

 		end)
 =

-	RegisterListener("keydown",		function (key,char,bConsumed) if (not bConsu=
med) then gCurrentRenderer:CamKeyDown(key) end end)
-	RegisterListener("keyup",		function (key) gCurrentRenderer:CamKeyUp(key) =
end)
-	=

-	RegisterListener("mouse_left_down",			function () IrisSingleClick() end)
-	RegisterListener("mouse_right_down",		function () IrisRightClick() end)
-	RegisterListener("mouse_left_up",			function () MouseUpUODragDrop() end)
-	=

-	RegisterListener("mouse_left_click_double",	function () IrisDoubleClick()=
 end)
-	RegisterListener("mouse_left_down",			function () MouseDownUODragDrop() e=
nd)
+	if (not gKeyBindListenersRegistered) then =

+		gKeyBindListenersRegistered =3D true
+		RegisterListener("keydown",		function (key,char,bConsumed) if (not bCons=
umed) then gCurrentRenderer:CamKeyDown(key) end end)
+		RegisterListener("keyup",		function (key) gCurrentRenderer:CamKeyUp(key)=
 end)
+		=

+		RegisterListener("mouse_left_down",			function () IrisSingleClick() end)
+		RegisterListener("mouse_right_down",		function () IrisRightClick() end)
+		RegisterListener("mouse_left_up",			function () MouseUpUODragDrop() end)
+		=

+		RegisterListener("mouse_left_click_double",	function () IrisDoubleClick(=
) end)
+		RegisterListener("mouse_left_down",			function () MouseDownUODragDrop() =
end)
+	end
 end
 =

 function BindInGameKeys()



From no-reply at zwischenwelt.org  Sat Mar 29 03:35:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 29 Mar 2008 02:35:41 -0000
Subject: [Iris-commit] [IRIS] r2002 - in /trunk/lua: filter/filter.art.lua
 lib.3d.dynamic.lua lib.3d.map.lua lib.3d.renderer.lua lib.debugmenu.lua
 lib.pathfind.lua lib.walking2.lua main.lua
Message-ID: <20080329023542.3E9D61C18787@zwischenwelt.org>

Author: hagish
Date: Sat Mar 29 03:35:41 2008
New Revision: 2002

Log:
minor walking speedups, faster pathfinding, config files gets loaded again =
after profile to overwrite profile settings, disabled quite slow water bord=
er code

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.debugmenu.lua
    trunk/lua/lib.pathfind.lua
    trunk/lua/lib.walking2.lua
    trunk/lua/main.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Sat Mar 29 03:35:41 2008
@@ -30,23 +30,14 @@
 	end
 	return nil
 end
-function FilterPositionX(iTranslatedTileTypeID)
-	if (gArtFilter[iTranslatedTileTypeID]) then
-		return gArtFilter[iTranslatedTileTypeID].xadd
-	end
-	return nil
-end
-function FilterPositionY(iTranslatedTileTypeID)
-	if (gArtFilter[iTranslatedTileTypeID]) then
-		return gArtFilter[iTranslatedTileTypeID].yadd
-	end
-	return nil
-end
-function FilterPositionZ(iTranslatedTileTypeID)
-	if (gArtFilter[iTranslatedTileTypeID]) then
-		return gArtFilter[iTranslatedTileTypeID].zadd
-	end
-	return nil
+
+function FilterPositionXYZ(iTranslatedTileTypeID)
+	local x =3D gArtFilter[iTranslatedTileTypeID] =

+	if x then
+		return x.xadd or 0, x.yadd or 0, x.zadd or 0
+	else
+		return 0,0,0
+	end
 end
 =

 -- checks if the given tiletype is a water tile
@@ -199,6 +190,8 @@
 gArtFilter[2264]=3D{maptoid=3D2269}
 gArtFilter[2261]=3D{maptoid=3D2269}
 gArtFilter[2258]=3D{maptoid=3D2269}
+gArtFilter[2262]=3D{skip=3Dtrue}
+gArtFilter[2257]=3D{skip=3Dtrue}
 gArtFilter[2268]=3D{skip=3Dtrue}
 =

 -- portrait

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Sat Mar 29 03:35:41 2008
@@ -78,9 +78,7 @@
 -- rebuilds the graphic of the dynamics
 function Renderer3D:RebuildDynamic ( dynamic )
 	-- update position adjustments
-	dynamic.xadd =3D FilterPositionX(dynamic.artid) or 0
-	dynamic.yadd =3D FilterPositionY(dynamic.artid) or 0
-	dynamic.zadd =3D FilterPositionZ(dynamic.artid) or 0
+	dynamic.xadd,dynamic.yadd,dynamic.zadd =3D FilterPositionXYZ(dynamic.arti=
d)
 =

 	if gFastBatchDynamics then
 		Renderer3D.gFastBatchDynamicsUpdateNeeded =3D true
@@ -110,9 +108,7 @@
 	-- item.artid=3DCheckIfCorpse(item.artid)
 =

 	-- FILTER: get correction
-	item.xadd =3D FilterPositionX(item.artid) or 0
-	item.yadd =3D FilterPositionY(item.artid) or 0
-	item.zadd =3D FilterPositionZ(item.artid) or 0
+	item.xadd,item.yadd,item.zadd =3D FilterPositionXYZ(item.artid)
 =

 	-- Detect Multis
 	if item.artid >=3D gMulti_ID then

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Sat Mar 29 03:35:41 2008
@@ -266,9 +266,7 @@
 	local entity =3D {}
 =

 	-- FILTER: correction
-	entity.xadd =3D FilterPositionX(iTileTypeID) or 0
-	entity.yadd =3D FilterPositionY(iTileTypeID) or 0
-	entity.zadd =3D FilterPositionZ(iTileTypeID) or 0
+	entity.xadd,entity.yadd,entity.zadd =3D FilterPositionXYZ(iTileTypeID)
 =

 	entity.xloc =3D iXLoc + entity.xadd
 	entity.yloc =3D iYLoc + entity.yadd
@@ -369,6 +367,7 @@
 	end
 =

 	self:UpdateStaticVisibility(entity)
+
 end
 =

 -- coords in chunks
@@ -388,12 +387,15 @@
 		chunk.mWaterZMap =3D {}		-- local z height [x.."_"..y]
 		chunk.SetWaterZWithoutBorder =3D function(self, tx, ty, z)
 			if (tx >=3D 0 and ty >=3D 0 and tx < Renderer3D.ROBMAP_CHUNK_SIZE * 8 a=
nd ty < Renderer3D.ROBMAP_CHUNK_SIZE * 8) then
-				self.mWaterZMap[tx.."_"..ty] =3D math.max(self.mWaterZMap[tx.."_"..ty]=
 or z, z)
+				Array2DSet(self.mWaterZMap, tx,ty, math.max(Array2DGet(self.mWaterZMap=
, tx,ty) or z, z))
+				-- self.mWaterZMap[tx.."_"..ty] =3D math.max(self.mWaterZMap[tx.."_"..=
ty] or z, z)
 			end
 		end
 		chunk.SetWaterZ =3D function(self, tx, ty, z)
 			self:SetWaterZWithoutBorder(tx,ty,z)
 			-- set border of 1 tile
+			-- TODO this is slow!!!
+			--[[
 			self:SetWaterZWithoutBorder(tx+1,ty+0,z)
 			self:SetWaterZWithoutBorder(tx-1,ty+0,z)
 			self:SetWaterZWithoutBorder(tx+0,ty+1,z)
@@ -403,6 +405,7 @@
 			self:SetWaterZWithoutBorder(tx-1,ty-1,z)
 			self:SetWaterZWithoutBorder(tx+1,ty-1,z)
 			self:SetWaterZWithoutBorder(tx-1,ty+1,z)
+			]]--
 		end
 	end
 	=

@@ -436,6 +439,7 @@
 			end
 		end
 	end
+
 =

 	-- GROUNDMAP
 	if (gGroundBlockLoader) then -- probably needs gTexMapLoader
@@ -532,12 +536,11 @@
 =

 	-- WATER
 	if gEnableMultiTexTerrain and (not gDisableMultiTexWater) then
-		local count =3D countarr(chunk.mWaterZMap) -- might be slow
-		=

+		local count =3D Array2DGetElementCount(chunk.mWaterZMap) -- might be slow
+		=

+		local tiles =3D self.ROBMAP_CHUNK_SIZE * 8
+
 		if (gEnableMultiTexTerrain and count and count > 0) then
-		=

-			local tiles =3D self.ROBMAP_CHUNK_SIZE * 8
-			=

 			-- print("DEBUG",chunk,"mostz",mostz)
 			=

 			-- create water
@@ -552,9 +555,11 @@
 			-- print("DEBUG","WATERSTART",count,vc,ic)
 			local index =3D 0
 			local x,y,z
-			for k,v in pairs(chunk.mWaterZMap) do
-				x,y =3D unpack(strsplit("_",k))
-				z =3D chunk.mWaterZMap[x.."_"..y] * 0.1
+
+			-- k,v in pairs(chunk.mWaterZMap) do
+			Array2DForAll(chunk.mWaterZMap, function(z, x,y)
+				--x,y =3D unpack(strsplit("_",k))
+				z =3D z * 0.1
 =

 				-- print("DEBUG","water tile",x,y,z,k,v)
 =

@@ -567,7 +572,7 @@
 				gfx:RenderableIndex3(index+1, index+2, index+3)
 				=

 				index =3D index + 4
-			end
+			end)
 =

 			gfx:RenderableEnd()
 =


Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Sat Mar 29 03:35:41 2008
@@ -326,9 +326,7 @@
 		effect.gfx:SetRenderingDistance(self.gDynamicMaxRenderDist)
 =

 		-- position adjustment for statics and dynamics
-		effect.xadd =3D FilterPositionX(effect.itemid) or 0
-		effect.yadd =3D FilterPositionY(effect.itemid) or 0
-		effect.zadd =3D FilterPositionZ(effect.itemid) or 0
+		effect.xadd,effect.yadd,effect.zadd =3D FilterPositionXYZ(effect.itemid)
 =

 		effect.gfx:SetPosition(self:UOPosToLocal(effect.current_locx + relx,
 												 effect.current_locy + rely,

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Sat Mar 29 03:35:41 2008
@@ -413,7 +413,7 @@
 =

 	-- llamas_llama_pack - broken (crash) -> mapped to id: 220 (grannyfilter)
 	{artid=3D 292 , content=3D{}},
-	-- k=C3=A4fer - broken animation
+	-- k=C3=83=C2=A4fer - broken animation
 	{artid=3D hex2num("0xA9") , content=3D{}},
 	--791 broken horse
 	{artid=3D hex2num("0x317"), content=3D{}},
@@ -590,9 +590,7 @@
 				HueMeshEntity(gDebugRootGfx,r,g,b,r,g,b)
 			end
 			-- position adjustment for statics and dynamics
-			xadd =3D FilterPositionX(iTileType) or 0
-			yadd =3D FilterPositionY(iTileType) or 0
-			zadd =3D FilterPositionZ(iTileType) or 0
+			xadd,yadd,zadd =3D FilterPositionXYZ(iTileType)
 		end
 		Renderer3D:CreateArtBillBoard(gDebugRootGfx2,iTileType+16384,iHue)
 	end

Modified: trunk/lua/lib.pathfind.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.pathfind.lua (original)
+++ trunk/lua/lib.pathfind.lua Sat Mar 29 03:35:41 2008
@@ -144,6 +144,8 @@
 =

 		local finish =3D false
 =

+		local count =3D 10
+
 		while not finish and countarr(lOpen) > 0 do
 			-- print("OPEN",countarr(lOpen))
 			-- print("CLOSE",countarr(lClose))
@@ -156,7 +158,11 @@
 			=

 			-- print("BEST",bestid,len,best.g,best.h,best.g+best.h)
 			=

-			job.yield()
+			if count > 0 then count =3D count - 1 end
+			if count =3D=3D 0 then
+				job.yield()
+				if OgreAvgFPS() > 15 then count =3D 15 else count =3D 1 end
+			end
 =

 			--add new valid points around it to the open list and calc the costs of=
 the new ones and add parent link
 			local n =3D Pathfinding_GetNeighbours(x,y,z,dx,dy,dz,best["g"])

Modified: trunk/lua/lib.walking2.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking2.lua (original)
+++ trunk/lua/lib.walking2.lua Sat Mar 29 03:35:41 2008
@@ -106,6 +106,10 @@
 	end
 end
 =

+gStaticCache =3D nil
+gStaticCacheBlockX =3D nil
+gStaticCacheBlockY =3D nil
+gStaticCacheHits =3D 0
 -- returns an array of flags (impassable, surface, maptile)
 -- array might contain empty entries (meaning on the specific z level is n=
either something blocking nor a surface/maptile)
 function GetWalkingBlockFlags(bx, by, tx, ty)
@@ -134,28 +138,61 @@
 		--~ printwalkdebug("----Map Name=3D" .. msName .."  Heigt=3D" .. iMapTil=
eZ .."   bSurface=3Dtrue  bImpassable=3D" .. tostring(flaglist[iMapTileZ].b=
Impassable))
 	end
 	=

-	=

 	-- statics
 	--~ printwalkdebug("---Statics")
+
+	local iTileTypeID,iX,iY,iZ,iHue
 	=

 	local iStaticCount
-	if (gStaticBlockLoader) then
+	if (gStaticBlockLoader and (bx ~=3D gStaticCacheBlockX or by ~=3D gStatic=
CacheBlockY) ) then
 		gStaticBlockLoader:Load(bx,by)
 		iStaticCount =3D gStaticBlockLoader:Count() -- operates on the block tha=
t was last loaded using :Load()
+
+		gStaticCache =3D {}
+		gStaticCacheBlockX =3D bx
+		gStaticCacheBlockY =3D by
+
+		gStaticCacheHits =3D 0
+
+		-- optimize block
+		for i =3D 0,iStaticCount-1 do
+			iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i)
+			local l =3D Array2DGet(gStaticCache, iX,iY)
+			if not l then l =3D {} end
+			table.insert(l, {iTileTypeID,iX,iY,iZ,iHue})
+			Array2DSet(gStaticCache, iX,iY, l)
+		end
 	else
 		iStaticCount =3D 0
 	end
 	-- TODO : maybe include Seasonal translation for Statics also here!?
 	=

-	local iTileTypeID,iX,iY,iZ,iHue
-	for i =3D 0,iStaticCount-1 do
-		iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i)
-		if (iX =3D=3D tx and iY =3D=3D ty) then
-			--~ printwalkdebug("----new Static ID=3D" .. iTileTypeID)
-			GetWalkingBlockFlagsHelper(iZ,iTileTypeID,flaglist)
-		end
-	end
-
+	-- TODO very very very slow
+
+	if gStaticCache then
+		--print("OPTIMIZED STATIC START")
+		local l =3D Array2DGet(gStaticCache, tx,ty)
+		if l then
+			for k,v in pairs(l) do
+				iTileTypeID,iX,iY,iZ,iHue =3D unpack(v)
+				--print("X",iX,"Y",iY,"Z",iZ)
+				GetWalkingBlockFlagsHelper(iZ,iTileTypeID,flaglist)
+			end
+		end
+		gStaticCacheHits =3D gStaticCacheHits + 1
+		--print("OPTIMIZED STATIC END",gStaticCacheHits)
+	else
+		--print("STATIC START")
+		for i =3D 0,iStaticCount-1 do
+			iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i)
+			--print("X",iX,"Y",iY,"Z",iZ)
+			if (iX =3D=3D tx and iY =3D=3D ty) then
+				--~ printwalkdebug("----new Static ID=3D" .. iTileTypeID)
+				GetWalkingBlockFlagsHelper(iZ,iTileTypeID,flaglist)
+			end
+		end
+		--print("STATIC END")
+	end
 =

 	local xloc=3Dbx*8+tx
 	local yloc=3Dby*8+ty
@@ -170,7 +207,7 @@
 		end
 	end
 	end
-	=

+
 	-- dynamics
 	--~ printwalkdebug("---Dynamics")
 	=


Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Mar 29 03:35:41 2008
@@ -151,6 +151,11 @@
 	end
 end
 =

+-- reparse config to overwrite profile settings
+if (file_exists(gConfigPath)) then
+	-- execute local config
+	dofile(gConfigPath)
+end
 =

 --###############################
 --##  OGRE RESOURCE LOCATIONS  ##



From no-reply at zwischenwelt.org  Sat Mar 29 04:22:12 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 29 Mar 2008 03:22:12 -0000
Subject: [Iris-commit] [IRIS] r2003 - /trunk/lua/lib.walking3.lua
Message-ID: <20080329032212.6716B1C18787@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Mar 29 04:22:12 2008
New Revision: 2003

Log:
working on walk3

Modified:
    trunk/lua/lib.walking3.lua

Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Sat Mar 29 04:22:12 2008
@@ -10,8 +10,6 @@
 end
 ]]--
 =

-kHex_4000 =3D 0x4000
-kHex_3FFF =3D 0x3FFF
 =

 kTileFlag =3D {}
 kTileFlag.Wet			=3D kTileDataFlag_Wet
@@ -21,20 +19,6 @@
 =

 kTileFlag.kImpassableSurface =3D kTileFlag.Impassable + kTileFlag.Surface
 =

-kTileData =3D {}
-kTileData.ItemTable =3D {}
-kTileData.LandTable =3D {}
--- kTileData.ItemTable[BitwiseAND(check.ID,kHex_3FFF)]  itemData.Flags  .H=
eight  .CalcHeight  .Bridge
---~ kTileData.LandTable[BitwiseAND(landTile.ID,kHex_3FFF)]  .Flags
--- m.CanSwim m.CantWalk  m.CantWalk  m.Alive) or m.Body.BodyID =3D=3D 0x3D=
B or m.IsDeadBondedPet m.Z    m.IsDeadBondedPet
--- item.ItemData.Impassable  item.ItemData.Flags
--- item.Movable item.Z =

--- item.AtWorldPoint( xStart, yStart ) and item.ItemID =

---~ public int CalcHeight : if ( (m_Flags & TileFlag.Bridge) !=3D 0 ) and =
math.floor(m_Height / 2) or m_Height;   RunUO1/src/TileData.cs:153:
--- Tile  ( check.ID check.Z )
---~ local tiles =3D map.Tiles.GetStaticTiles( x, y, true ) -- Tile[]
---~ local landTile =3D map.Tiles.GetLandTile( x, y ) -- Tile    landTile.I=
D       local considerLand =3D not landTile.Ignored
---~ landZ,landCenter,landTop =3D map.GetAverageZ( xCheck, yCheck)
 =

 =

 kPersonHeight				=3D 16
@@ -48,14 +32,31 @@
 	return posx+GetDirX(dir),posy+GetDirY(dir)
 end =

 =

---- bMoveIsOk,newZ =3D CheckMovement( Mobile m, Map map, Point3D loc, Dire=
ction d, out int newZ )
+function W3_GetItemsAtPos (xloc,yloc) =

+	local res =3D {}
+	-- TODO : consider multis as well ! (serverside & clientside)
+	-- TODO : local item=3D{ItemID=3D123,Z=3D0,Movable=3Dtrue,ItemID=3D123,It=
emData=3D{Impassable=3Dfalse,Flags=3D123}}
+	-- table.insert(res,item)
+	return res
+end
+
+function W3_GetMobile			(irismobile)			assert(false,"TODO") return {Z=3D0,=
CanSwim=3Dfalse,CantWalk=3Dfalse,Alive=3Dtrue,Body=3D{BodyID=3D123},IsDeadB=
ondedPet=3Dfalse} end
+function W3_GetMapW				()						assert(false,"TODO") return 0 end
+function W3_GetMapH				()						assert(false,"TODO") return 0 end
+function W3_GetLandTile			(xloc,yloc)				assert(false,"TODO") return {ID=
=3D123,Ignored=3Dfalse} end -- ID : iTileType for W3_GetLandTypeFlags, Igno=
red : =

+function W3_GetStaticTiles		(xloc,yloc,bUnknown)	assert(false,"TODO") retu=
rn {{ID=3D123,Z=3D0}} end --  : IsOK : check
+function W3_GetAverageZ			(xloc,yloc)				assert(false,"TODO") local landZ,=
landCenter,landTop =3D 0,0,0 return landZ,landCenter,landTop end -- min,avg=
,max of 4 vertices
+function W3_GetLandTypeFlags	(iTileType)				assert(false,"TODO") return 0 =
end -- LandTable[landTileTypeID] =

+function W3_GetTileType			(iTileType)				assert(false,"TODO") return {Flag=
s=3D0,Height=3D0,CalcHeight=3D0,Bridge=3Dfalse} end -- ItemTable[iTileType]=
 itemData
+
+--~ public int CalcHeight : if ( (m_Flags & TileFlag.Bridge) !=3D 0 ) and =
math.floor(m_Height / 2) or m_Height;   RunUO1/src/TileData.cs:153:
+ =

+--- bMoveIsOk,newZ =3D CheckMovement( Mobile mobile, Point3D loc, Directio=
n d, out int newZ )
 -- see also RunUO1.0/Scripts/Engines/Pathing/Movement.cs : CheckMovement a=
nd Check
 -- TODO : see also RunUO1.0/src/Mobile.cs : Move : checks items(dynamics?)=
 and mobiles
--- m=3Dmobile , d=3Ddir
-function CheckMovement( m, map, posx,posy,posz, d)
+function CheckMovement( mobile, posx,posy,posz, d)
 	d =3D DirWrap(d) -- alsor removes runflag
 	local moveIsOk,newZ =3D false,0
-	if (map =3D=3D nil) then return false,newZ end
 =

 	local xStart =3D posx -- ints
 	local yStart =3D posy
@@ -63,34 +64,34 @@
 	local xLeft		, yLeft		=3D ApplyDir( d - 1, xLeft	,yLeft		)
 	local xRight	, yRight	=3D ApplyDir( d + 1, xRight	,yRight		)
 =

-	if ( xForward < 0 or yForward < 0 or xForward >=3D map.Width or yForward =
>=3D map.Height ) then return false,newZ end
+	if ( xForward < 0 or yForward < 0 or xForward >=3D W3_GetMapW() or yForwa=
rd >=3D W3_GetMapH() ) then return false,newZ end
 	=

 	local checkDiagonals =3D DirIsDiagonal(d) -- see lib.protocol.lua:56:
 =

 	local ignoreMovableImpassables =3D kIgnoreMovableImpassables -- bool
 	local reqFlags =3D kImpassableSurface -- TileFlag
 =

-	if ( m.CanSwim ) then reqFlags =3D BitwiseOR(reqFlags,kTileFlag.Wet) end
+	if ( mobile.CanSwim ) then reqFlags =3D BitwiseOR(reqFlags,kTileFlag.Wet)=
 end
 =

 	local filterItemFun =3D function (item)
 		if ( ignoreMovableImpassables and item.Movable and item.ItemData.Impassa=
ble ) then return false end
 		if ( BitwiseAND(item.ItemData.Flags,reqFlags) =3D=3D 0 ) then return fal=
se end
-		return item.ItemID < kHex_4000
+		return item.ItemID < 0x4000
 	end
 	=

-	local itemsStart	=3D FilterArray(map.GetItemsAtPos(xStart	,yStart		),filt=
erItemFun)
-	local itemsForward	=3D FilterArray(map.GetItemsAtPos(xForward	,yForward	)=
,filterItemFun)
+	local itemsStart	=3D FilterArray(W3_GetItemsAtPos(xStart		,yStart		),filt=
erItemFun)
+	local itemsForward	=3D FilterArray(W3_GetItemsAtPos(xForward	,yForward	),=
filterItemFun)
 	local items
 	=

-	local startZ,startTop =3D GetStartZ( m, map, posx,posy,posz, itemsStart)
-
-	moveIsOk,newZ =3D Check( map, m, itemsForward, xForward, yForward, startT=
op, startZ, m.CanSwim, m.CantWalk)
+	local startZ,startTop =3D GetStartZ( mobile, posx,posy,posz, itemsStart)
+
+	moveIsOk,newZ =3D Check( mobile, itemsForward, xForward, yForward, startT=
op, startZ, mobile.CanSwim, mobile.CantWalk)
 =

 	if ( moveIsOk and checkDiagonals ) then
-		local itemsLeft		=3D FilterArray(map.GetItemsAtPos(xLeft	,yLeft		),filte=
rItemFun)
-		local itemsRight	=3D FilterArray(map.GetItemsAtPos(xRight	,yRight		),fil=
terItemFun)
-		local myok1,ignored_z =3D Check( map, m, itemsLeft , xLeft , yLeft , sta=
rtTop, startZ, m.CanSwim, m.CantWalk)
-		local myok2,ignored_z =3D Check( map, m, itemsRight, xRight, yRight, sta=
rtTop, startZ, m.CanSwim, m.CantWalk)
+		local itemsLeft		=3D FilterArray(W3_GetItemsAtPos(xLeft	,yLeft		),filter=
ItemFun)
+		local itemsRight	=3D FilterArray(W3_GetItemsAtPos(xRight	,yRight		),filt=
erItemFun)
+		local myok1,ignored_z =3D Check( mobile, itemsLeft , xLeft , yLeft , sta=
rtTop, startZ, mobile.CanSwim, mobile.CantWalk)
+		local myok2,ignored_z =3D Check( mobile, itemsRight, xRight, yRight, sta=
rtTop, startZ, mobile.CanSwim, mobile.CantWalk)
 		if ( (not myok1) and (not myok2) ) then  moveIsOk =3D false  end
 	end
 =

@@ -102,30 +103,25 @@
 --~ private bool IsOk( bool ignoreDoors, int ourZ, int ourTop, Tile[] tile=
s, ArrayList items )
 function IsOk(  ignoreDoors,  ourZ, ourTop, tiles, items )
 	for i,check in pairs(tiles) do -- Tile  ( check.ID check.Z )
-		local itemData =3D kTileData.ItemTable[BitwiseAND(check.ID,kHex_3FFF)] -=
- ItemData
-
-		if ( BitwiseAND(itemData.Flags,kImpassableSurface) ~=3D 0 ) then -- Impa=
ssable or Surface
-			local checkZ =3D check.Z -- int
-			local checkTop =3D checkZ + itemData.CalcHeight -- int
-
-			if ( checkTop > ourZ and ourTop > checkZ ) then
-				return false
-			end
+		local itemData =3D W3_GetTileType(BitwiseAND(check.ID,0x3FFF))
+		if ( TestMask(itemData.Flags,kImpassableSurface) ) then -- Impassable or=
 Surface
+			if ( check.Z + itemData.CalcHeight > ourZ and ourTop > check.Z ) then r=
eturn false end -- intersection =

 		end
 	end
 =

 	for i,item in pairs(items) do -- Item
-		local itemID =3D BitwiseAND(item.ItemID,kHex_3FFF) -- int
-		local itemData =3D kTileData.ItemTable[itemID] -- ItemData
+		local itemID =3D BitwiseAND(item.ItemID,0x3FFF) -- int
+		local itemData =3D W3_GetTileType(itemID) -- ItemData
 		local flags =3D itemData.Flags -- TileFlag
 =

-		if ( BitwiseAND(flags,kImpassableSurface) ~=3D 0 ) -- Impassable or Surf=
ace
-		then
-			if ( ignoreDoors and (BitwiseAND(flags,kTileFlag.Door) ~=3D 0 or =

-				itemID =3D=3D 0x692 or =

-				itemID =3D=3D 0x846 or =

-				itemID =3D=3D 0x873 or =

-				(itemID >=3D 0x6F5 and itemID <=3D 0x6F6)) ) then
+		if (TestMask(flags,kImpassableSurface)) then -- Impassable or Surface
+			if (ignoreDoors and -- doors
+				(	TestMask(flags,kTileFlag.Door) or =

+					itemID =3D=3D 0x692 or =

+					itemID =3D=3D 0x846 or =

+					itemID =3D=3D 0x873 or =

+					(itemID >=3D 0x6F5 and itemID <=3D 0x6F6)
+				) ) then
 				--continue
 			else
 				local checkZ =3D item.Z -- int
@@ -140,20 +136,23 @@
 end
 =

 =

---~ private bool Check( Map map, Mobile m, ArrayList items, int x, int y, =
int startTop, int startZ, bool canSwim, bool cantWalk, out int newZ )
+--~ private bool Check( Map map, Mobile mobile, ArrayList items, int x, in=
t y, int startTop, int startZ, bool canSwim, bool cantWalk, out int newZ )
 -- returns bla,newZ
-function Check(  map,  m,  items,  x,  y,  startTop,  startZ,  canSwim,  c=
antWalk )
+function Check(  mobile,  items,  x,  y,  startTop,  startZ,  canSwim,  ca=
ntWalk )
 	local newZ =3D 0
 =

-	local tiles		=3D map.Tiles.GetStaticTiles( x, y, true ) -- Tile[]
-	local landTile	=3D map.Tiles.GetLandTile( x, y ) -- Tile
-
-	local landBlocks =3D BitwiseAND(kTileData.LandTable[BitwiseAND(landTile.I=
D,kHex_3FFF)].Flags,kTileFlag.Impassable) ~=3D 0 -- bool
+	local tiles			 =3D W3_GetStaticTiles( x, y, true ) -- Tile[]
+	local landTile		 =3D W3_GetLandTile( x, y ) -- Tile
+	local landTileTypeID =3D BitwiseAND(landTile.ID,0x3FFF)
+	local landTileFlags  =3D W3_GetLandTypeFlags(landTileTypeID)
+	local landTileIsWet	 =3D TestMask(landTileFlags,kTileFlag.Wet)
+
+	local landBlocks =3D TestMask(landTileFlags,kTileFlag.Impassable) -- bool
 	local considerLand =3D not landTile.Ignored -- bool
 =

-	if ( landBlocks and canSwim and BitwiseAND(kTileData.LandTable[BitwiseAND=
(landTile.ID,kHex_3FFF)].Flags,kTileFlag.Wet) ~=3D 0 ) then
+	if ( landBlocks and canSwim and landTileIsWet ) then
 		landBlocks =3D false
-	elseif ( cantWalk and BitwiseAND(kTileData.LandTable[BitwiseAND(landTile.=
ID,kHex_3FFF)].Flags,kTileFlag.Wet) =3D=3D 0 ) then
+	elseif ( cantWalk and (not landTileIsWet) ) then
 		landBlocks =3D true
 	end
 =

@@ -161,21 +160,20 @@
 	local landCenter =3D 0
 	local landTop =3D 0
 =

-	local landZ,landCenter,landTop =3D map.GetAverageZ( x, y)
+	local landZ,landCenter,landTop =3D W3_GetAverageZ(x, y)
 =

 	local moveIsOk =3D false
 =

 	local stepTop =3D startTop + kStepHeight
 	local checkTop =3D startZ + kPersonHeight
 =

-	local ignoreDoors =3D ( kAlwaysIgnoreDoors or (not m.Alive) or m.Body.Bod=
yID =3D=3D 0x3DB or m.IsDeadBondedPet )
+	local ignoreDoors =3D ( kAlwaysIgnoreDoors or (not mobile.Alive) or mobil=
e.Body.BodyID =3D=3D 0x3DB or mobile.IsDeadBondedPet )
 =

 	for i,tile in pairs(tiles) do -- Tile
-		local itemData =3D kTileData.ItemTable[BitwiseAND(tile.ID,kHex_3FFF)] --=
 ItemData
+		local itemData =3D W3_GetTileType(BitwiseAND(tile.ID,0x3FFF)) -- ItemData
 		local flags =3D itemData.Flags -- TileFlag
 =

-		if ( BitwiseAND(flags,kImpassableSurface) =3D=3D kTileFlag.Surface or (c=
anSwim and BitwiseAND(flags , kTileFlag.Wet) ~=3D 0) ) -- Surface and (not =
Impassable)
-		then
+		if ( BitwiseAND(flags,kImpassableSurface) =3D=3D kTileFlag.Surface or (c=
anSwim and TestMask(flags , kTileFlag.Wet)) ) then -- Surface and (not Impa=
ssable)
 			if ( cantWalk and BitwiseAND(flags , kTileFlag.Wet) =3D=3D 0 ) then
 				--continue
 			else
@@ -189,7 +187,60 @@
 				local bMyContinue =3D false
 				if ( moveIsOk )
 				then
-					local cmp =3D math.abs( ourZ - m.Z ) - math.abs( newZ - m.Z )
+					local cmp =3D math.abs( ourZ - mobile.Z ) - math.abs( newZ - mobile.Z=
 )
+
+					if ( cmp > 0 or (cmp =3D=3D 0 and ourZ > newZ) ) then bMyContinue =3D=
 true end
+				end
+
+				if (not bMyContinue) then
+					if ( ourZ + kPersonHeight > testTop ) then testTop =3D ourZ + kPerson=
Height end
+
+					if ( not itemData.Bridge ) then itemTop =3D itemTop + itemData.Height=
 end
+
+					if ( stepTop >=3D itemTop ) then
+						local landCheck =3D itemZ
+
+						if ( itemData.Height >=3D kStepHeight ) then
+							landCheck =3D landCheck + kStepHeight
+						else
+							landCheck =3D landCheck + itemData.Height
+						end
+
+						if ( considerLand and landCheck < landCenter and landCenter > ourZ a=
nd testTop > landZ ) then
+							--continue
+						else
+							if ( IsOk( ignoreDoors, ourZ, testTop, tiles, items ) ) then
+								newZ =3D ourZ
+								moveIsOk =3D true
+							end
+						end
+					end
+				end
+			end
+		end
+	end
+
+	for i,item in pairs(items) do  -- Item
+		local itemData =3D item.ItemData --W3_GetTileType(BitwiseAND(item.ItemID=
 , 0x3FFF)) ItemData
+		local flags =3D itemData.Flags -- TileFlag
+
+		if ( BitwiseAND(flags , kImpassableSurface) =3D=3D kTileFlag.Surface or =
(mobile.CanSwim and TestMask(flags , kTileFlag.Wet)) ) -- Surface and (not =
Impassable)
+		then
+			if ( cantWalk and BitwiseAND(flags , kTileFlag.Wet) =3D=3D 0 ) then
+				--~ continue
+			else
+
+				local itemZ =3D item.Z
+				local itemTop =3D itemZ
+				local ourZ =3D itemZ + itemData.CalcHeight
+				local ourTop =3D ourZ + kPersonHeight
+				local testTop =3D checkTop
+
+				local bMyContinue =3D false
+				=

+				if ( moveIsOk )
+				then
+					local cmp =3D math.abs( ourZ - mobile.Z ) - math.abs( newZ - mobile.Z=
 )
 =

 					if ( cmp > 0 or (cmp =3D=3D 0 and ourZ > newZ) ) then bMyContinue =3D=
 true end
 				end
@@ -224,61 +275,6 @@
 		end
 	end
 =

-	for i,item in pairs(items) do  -- Item
-		local itemData =3D item.ItemData --kTileData.ItemTable[BitwiseAND(item.I=
temID , kHex_3FFF)] ItemData
-		local flags =3D itemData.Flags -- TileFlag
-
-		if ( BitwiseAND(flags , kImpassableSurface) =3D=3D kTileFlag.Surface or =
(m.CanSwim and BitwiseAND(flags , kTileFlag.Wet) ~=3D 0) ) -- Surface and (=
not Impassable)
-		then
-			if ( cantWalk and BitwiseAND(flags , kTileFlag.Wet) =3D=3D 0 ) then
-				--~ continue
-			else
-
-				local itemZ =3D item.Z
-				local itemTop =3D itemZ
-				local ourZ =3D itemZ + itemData.CalcHeight
-				local ourTop =3D ourZ + kPersonHeight
-				local testTop =3D checkTop
-
-				local bMyContinue =3D false
-				=

-				if ( moveIsOk )
-				then
-					local cmp =3D math.abs( ourZ - m.Z ) - math.abs( newZ - m.Z )
-
-					if ( cmp > 0 or (cmp =3D=3D 0 and ourZ > newZ) ) then bMyContinue =3D=
 true end
-				end
-
-				if (not bMyContinue) then
-					if ( ourZ + kPersonHeight > testTop ) then testTop =3D ourZ + kPerson=
Height end
-
-					if ( not itemData.Bridge ) then itemTop =3D itemTop + itemData.Height=
 end
-
-					if ( stepTop >=3D itemTop )
-					then
-						local landCheck =3D itemZ
-
-						if ( itemData.Height >=3D kStepHeight ) then
-							landCheck =3D landCheck + kStepHeight
-						else
-							landCheck =3D landCheck + itemData.Height
-						end
-
-						if ( considerLand and landCheck < landCenter and landCenter > ourZ a=
nd testTop > landZ ) then
-							--continue
-						else
-							if ( IsOk( ignoreDoors, ourZ, testTop, tiles, items ) )
-							then
-								newZ =3D ourZ
-								moveIsOk =3D true
-							end
-						end
-					end
-				end
-			end
-		end
-	end
-
 	if ( considerLand and (not landBlocks) and stepTop >=3D landZ )
 	then
 		local ourZ =3D landCenter
@@ -291,7 +287,7 @@
 =

 		if ( moveIsOk )
 		then
-			local cmp =3D math.abs( ourZ - m.Z ) - math.abs( newZ - m.Z ) -- int
+			local cmp =3D math.abs( ourZ - mobile.Z ) - math.abs( newZ - mobile.Z )=
 -- int
 =

 			if ( cmp > 0 or (cmp =3D=3D 0 and ourZ > newZ) ) then shouldCheck =3D f=
alse end
 		end
@@ -306,33 +302,33 @@
 	return moveIsOk,newZ
 end
 =

---~ private void GetStartZ( Mobile m, Map map, Point3D loc, ArrayList item=
List, out int zLow, out int zTop )
+--~ private void GetStartZ( Mobile mobile, Map map, Point3D loc, ArrayList=
 itemList, out int zLow, out int zTop )
 -- returns zLow,zTop
-function GetStartZ(  m,  map,  loc,  itemList )
+function GetStartZ(  mobile,  posx,posy,posz,  itemList )
 	local zLow,zTop =3D 0,0
-	local xCheck =3D loc.X
-	local yCheck =3D loc.Y
-
-	local landTile =3D map.Tiles.GetLandTile( xCheck, yCheck ) -- Tile
+
+	local landTile =3D W3_GetLandTile( posx, posy ) -- Tile
 	local landZ =3D 0
 	local landCenter =3D 0
 	local landTop =3D 0
-	local landBlocks =3D BitwiseAND(kTileData.LandTable[BitwiseAND(landTile.I=
D , kHex_3FFF)].Flags , kTileFlag.Impassable) ~=3D 0
-
-	if ( landBlocks and m.CanSwim and BitwiseAND(kTileData.LandTable[BitwiseA=
ND(landTile.ID , kHex_3FFF)].Flags , kTileFlag.Wet) ~=3D 0 ) then
+	local landTileID =3D BitwiseAND(landTile.ID , 0x3FFF)
+	local landTileFlags =3D W3_GetLandTypeFlags(landTileID)
+	local landBlocks =3D TestMask(landTileFlags, kTileFlag.Impassable)
+
+	if ( landBlocks and mobile.CanSwim and TestMask(landTileFlags , kTileFlag=
.Wet) ) then
 		landBlocks =3D false
-	elseif ( m.CantWalk and BitwiseAND(kTileData.LandTable[BitwiseAND(landTil=
e.ID , kHex_3FFF)].Flags , kTileFlag.Wet) =3D=3D 0 ) then
+	elseif ( mobile.CantWalk and BitwiseAND(landTileFlags , kTileFlag.Wet) =
=3D=3D 0 ) then
 		landBlocks =3D true
 	end
 =

-	landZ,landCenter,landTop =3D map.GetAverageZ( xCheck, yCheck)
+	landZ,landCenter,landTop =3D W3_GetAverageZ( posx, posy)
 =

 	local considerLand =3D not landTile.Ignored
 =

 	local zCenter =3D 0
 	local isSet =3D false
 =

-	if ( considerLand and (not landBlocks) and loc.Z >=3D landCenter )
+	if ( considerLand and (not landBlocks) and posz >=3D landCenter )
 	then
 		zLow =3D landZ
 		zCenter =3D landCenter
@@ -342,16 +338,16 @@
 		isSet =3D true
 	end
 =

-	local staticTiles =3D map.Tiles.GetStaticTiles( xCheck, yCheck, true ) --=
 Tile[]
+	local staticTiles =3D W3_GetStaticTiles( posx, posy, true ) -- Tile[]
 =

 	for i,tile in pairs(staticTiles) do -- Tile
-		local id =3D kTileData.ItemTable[BitwiseAND(tile.ID , kHex_3FFF)] -- Ite=
mData
+		local id =3D W3_GetTileType(BitwiseAND(tile.ID , 0x3FFF)) -- ItemData
 =

 		local calcTop =3D (tile.Z + id.CalcHeight)
 =

-		if ( ((not isSet) or calcTop >=3D zCenter) and ( BitwiseAND(id.Flags , k=
TileFlag.Surface) ~=3D 0 or ( m.CanSwim and BitwiseAND(id.Flags,kTileFlag.W=
et) ~=3D 0 ) ) and loc.Z >=3D calcTop )
-		then
-			if ( m.CantWalk and BitwiseAND(id.Flags , kTileFlag.Wet) =3D=3D 0 ) then
+		if ( ((not isSet) or calcTop >=3D zCenter) and ( TestMask(id.Flags , kTi=
leFlag.Surface) or ( mobile.CanSwim and TestMask(id.Flags,kTileFlag.Wet) ) =
) and posz >=3D calcTop )
+		then
+			if ( mobile.CantWalk and BitwiseAND(id.Flags , kTileFlag.Wet) =3D=3D 0 =
) then
 				--continue
 			else
 				zLow =3D tile.Z
@@ -372,11 +368,11 @@
 		local calcTop =3D item.Z + id.CalcHeight
 =

 		if (	((not isSet) or calcTop >=3D zCenter) and =

-				(	BitwiseAND(id.Flags , kTileFlag.Surface) ~=3D 0 or =

-					( m.CanSwim and BitwiseAND(id.Flags,kTileFlag.Wet) ~=3D 0 ) ) and =

-				loc.Z >=3D calcTop )
-		then
-			if ( m.CantWalk and BitwiseAND(id.Flags , kTileFlag.Wet) =3D=3D 0 ) then
+				(	TestMask(id.Flags , kTileFlag.Surface) or =

+					( mobile.CanSwim and TestMask(id.Flags,kTileFlag.Wet) ) ) and =

+				posz >=3D calcTop )
+		then
+			if ( mobile.CantWalk and BitwiseAND(id.Flags , kTileFlag.Wet) =3D=3D 0 =
) then
 				--continue
 			else =

 				zLow =3D item.Z
@@ -392,10 +388,10 @@
 	end
 =

 	if ( not isSet ) then
-		zLow =3D loc.Z
-		zTop =3D loc.Z
-	elseif ( loc.Z > zTop ) then
-		zTop =3D loc.Z
+		zLow =3D posz
+		zTop =3D posz
+	elseif ( posz > zTop ) then
+		zTop =3D posz
 	end
 	=

 	return zLow,zTop



From no-reply at zwischenwelt.org  Sat Mar 29 16:10:20 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 29 Mar 2008 15:10:20 -0000
Subject: [Iris-commit] [IRIS] r2004 - /trunk/lua/gui/gui.securetrade.lua
Message-ID: <20080329151023.553681C187A1@zwischenwelt.org>

Author: sience
Date: Sat Mar 29 16:10:17 2008
New Revision: 2004

Log:
-small fix: please test

Modified:
    trunk/lua/gui/gui.securetrade.lua

Modified: trunk/lua/gui/gui.securetrade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.securetrade.lua (original)
+++ trunk/lua/gui/gui.securetrade.lua Sat Mar 29 16:10:17 2008
@@ -7,8 +7,8 @@
 securetrading.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2150 securepic }" ..
-	 "{ checkbox 52 30 2151 2153 0 cbmy }" ..
-	 "{ checkbox 268 162 2151 2153 0 cbtheir }" ..
+	 "{ checkbox 52 30 2151 2153 0 0 cbmy }" ..
+	 "{ checkbox 268 162 2151 2153 0 0 cbtheir }" ..
 	 "{ text 85 36 0 0 namemy }" ..
 	 "{ text 70 166 0 1 nametheir }"
 securetrading.textline =3D {



From no-reply at zwischenwelt.org  Sat Mar 29 19:04:02 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 29 Mar 2008 18:04:02 -0000
Subject: [Iris-commit] [IRIS] r2005 - in /trunk/lua/gui: gui.skill.lua
	gui.spellbook.lua
Message-ID: <20080329180402.B80911C1879E@zwischenwelt.org>

Author: hagish
Date: Sat Mar 29 19:04:02 2008
New Revision: 2005

Log:
possible to drag the blue cast icon from the spellbook out of the spellbook

Modified:
    trunk/lua/gui/gui.skill.lua
    trunk/lua/gui/gui.spellbook.lua

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Sat Mar 29 19:04:02 2008
@@ -325,7 +325,7 @@
 					skill.button_use_drag.CustomMoveStop =3D function(widget)
 						-- reset button to source and create quick use/cast button
 						-- current position
-						local x,y =3D skill.button_use_drag.gfx:GetPos()
+						local x,y =3D GetMousePos()
 						CreateQuickCastButton(x,y,glSkillNames[skill.skillid],function () =

 							-- quick cast function
 							Send_Request_SkillUse(skill.skillid)

Modified: trunk/lua/gui/gui.spellbook.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.spellbook.lua (original)
+++ trunk/lua/gui/gui.spellbook.lua Sat Mar 29 19:04:02 2008
@@ -157,6 +157,29 @@
 						spellbutton.onLeftClick =3D function (widget)
 													Send_Spell(spellbutton.spell+gSpellBooks[spellbook.itemid].st=
artindex,gSpellbookExpansion["AOS"])
 												end
+						=

+						local spellname =3D gSpellBooks[spellbook.itemid].spells[circle][spe=
ll]
+						-- TODO finish spell drag buttons
+						spellbutton.onMouseDown =3D function (widget,mousebutton)
+							if (mousebutton =3D=3D 1) then =

+								spellbutton.mStartX,spellbutton.mStartY =3D spellbutton.gfx:GetPos=
()
+								spellbutton.dialog:BringToFront() =

+								gui.StartMoveDialog(spellbutton) =

+							end
+						end
+						spellbutton.CustomMoveStop =3D function(widget)
+							-- reset button to source and create quick use/cast button
+							-- current position
+							local x,y =3D GetMousePos()
+							CreateQuickCastButton(x,y,spellname,function () =

+								-- quick cast function
+								print("CAST SPELL",spellname)
+								Send_Spell(spellbutton.spell+gSpellBooks[spellbook.itemid].startin=
dex,gSpellbookExpansion["AOS"])
+							end)
+							spellbutton.gfx:SetPos(spellbutton.mStartX,spellbutton.mStartY)
+						end
+						=

+						=

 						local spellname =3D guimaker.MakeText (curparent, 80 + rightspacer, =
20+((spellcounter+1)*15) - top_align,
 															gSpellBooks[spellbook.itemid].spells[circle][spell], gFontG=
umpSize,
 															{190/255,237/255,231/255,1.0}, gFontNameDefault)



From no-reply at zwischenwelt.org  Sat Mar 29 19:28:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 29 Mar 2008 18:28:54 -0000
Subject: [Iris-commit] [IRIS] r2006 - /trunk/lua/lib.walking3.lua
Message-ID: <20080329182855.581AD1C1879E@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Mar 29 19:28:54 2008
New Revision: 2006

Log:
worked on lib.walking3.lua

Modified:
    trunk/lua/lib.walking3.lua

Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Sat Mar 29 19:28:54 2008
@@ -40,11 +40,21 @@
 	return res
 end
 =

+-- returns tiletype,z
+function W3_GetGround		(xloc,yloc)	=

+	-- todo : cached access			=

+	local tiletype,z =3D gGroundBlockLoader:GetTile(xloc,yloc)
+	return tiletype,z
+end
+
 function W3_GetMobile			(irismobile)			assert(false,"TODO") return {Z=3D0,=
CanSwim=3Dfalse,CantWalk=3Dfalse,Alive=3Dtrue,Body=3D{BodyID=3D123},IsDeadB=
ondedPet=3Dfalse} end
-function W3_GetMapW				()						assert(false,"TODO") return 0 end
-function W3_GetMapH				()						assert(false,"TODO") return 0 end
-function W3_GetLandTile			(xloc,yloc)				assert(false,"TODO") return {ID=
=3D123,Ignored=3Dfalse} end -- ID : iTileType for W3_GetLandTypeFlags, Igno=
red : =

-function W3_GetStaticTiles		(xloc,yloc,bUnknown)	assert(false,"TODO") retu=
rn {{ID=3D123,Z=3D0}} end --  : IsOK : check
+function W3_GetMapW				()						assert(false,"TODO") return gGroundBlockLoa=
der:GetMapW() end
+function W3_GetMapH				()						assert(false,"TODO") return gGroundBlockLoa=
der:GetMapH() end
+function W3_GetLandTile			(xloc,yloc)				assert(false,"TODO")
+	local tiletype,z =3D W3_GetGround(xloc,yloc)
+	return {ID=3Dtiletype,Ignored=3Dfalse}
+end -- ID : iTileType for W3_GetLandTypeFlags, Ignored : =

+function W3_GetStaticTiles		(xloc,yloc,bUnknown)	assert(false,"TODO") retu=
rn {{ID=3D123,Z=3D0}} end --  : W3_IsOK : check
 function W3_GetAverageZ			(xloc,yloc)				assert(false,"TODO") local landZ,=
landCenter,landTop =3D 0,0,0 return landZ,landCenter,landTop end -- min,avg=
,max of 4 vertices
 function W3_GetLandTypeFlags	(iTileType)				assert(false,"TODO") return 0 =
end -- LandTable[landTileTypeID] =

 function W3_GetTileType			(iTileType)				assert(false,"TODO") return {Flag=
s=3D0,Height=3D0,CalcHeight=3D0,Bridge=3Dfalse} end -- ItemTable[iTileType]=
 itemData
@@ -54,7 +64,7 @@
 --- bMoveIsOk,newZ =3D CheckMovement( Mobile mobile, Point3D loc, Directio=
n d, out int newZ )
 -- see also RunUO1.0/Scripts/Engines/Pathing/Movement.cs : CheckMovement a=
nd Check
 -- TODO : see also RunUO1.0/src/Mobile.cs : Move : checks items(dynamics?)=
 and mobiles
-function CheckMovement( mobile, posx,posy,posz, d)
+function W3_CheckMovement( mobile, posx,posy,posz, d)
 	d =3D DirWrap(d) -- alsor removes runflag
 	local moveIsOk,newZ =3D false,0
 =

@@ -83,15 +93,15 @@
 	local itemsForward	=3D FilterArray(W3_GetItemsAtPos(xForward	,yForward	),=
filterItemFun)
 	local items
 	=

-	local startZ,startTop =3D GetStartZ( mobile, posx,posy,posz, itemsStart)
-
-	moveIsOk,newZ =3D Check( mobile, itemsForward, xForward, yForward, startT=
op, startZ, mobile.CanSwim, mobile.CantWalk)
+	local startZ,startTop =3D W3_GetStartZ( mobile, posx,posy,posz, itemsStar=
t)
+
+	moveIsOk,newZ =3D W3_Check( mobile, itemsForward, xForward, yForward, sta=
rtTop, startZ, mobile.CanSwim, mobile.CantWalk)
 =

 	if ( moveIsOk and checkDiagonals ) then
 		local itemsLeft		=3D FilterArray(W3_GetItemsAtPos(xLeft	,yLeft		),filter=
ItemFun)
 		local itemsRight	=3D FilterArray(W3_GetItemsAtPos(xRight	,yRight		),filt=
erItemFun)
-		local myok1,ignored_z =3D Check( mobile, itemsLeft , xLeft , yLeft , sta=
rtTop, startZ, mobile.CanSwim, mobile.CantWalk)
-		local myok2,ignored_z =3D Check( mobile, itemsRight, xRight, yRight, sta=
rtTop, startZ, mobile.CanSwim, mobile.CantWalk)
+		local myok1,ignored_z =3D W3_Check( mobile, itemsLeft , xLeft , yLeft , =
startTop, startZ, mobile.CanSwim, mobile.CantWalk)
+		local myok2,ignored_z =3D W3_Check( mobile, itemsRight, xRight, yRight, =
startTop, startZ, mobile.CanSwim, mobile.CantWalk)
 		if ( (not myok1) and (not myok2) ) then  moveIsOk =3D false  end
 	end
 =

@@ -101,7 +111,7 @@
 =

 =

 --~ private bool IsOk( bool ignoreDoors, int ourZ, int ourTop, Tile[] tile=
s, ArrayList items )
-function IsOk(  ignoreDoors,  ourZ, ourTop, tiles, items )
+function W3_IsOK(  ignoreDoors,  ourZ, ourTop, tiles, items )
 	for i,check in pairs(tiles) do -- Tile  ( check.ID check.Z )
 		local itemData =3D W3_GetTileType(BitwiseAND(check.ID,0x3FFF))
 		if ( TestMask(itemData.Flags,kImpassableSurface) ) then -- Impassable or=
 Surface
@@ -138,7 +148,7 @@
 =

 --~ private bool Check( Map map, Mobile mobile, ArrayList items, int x, in=
t y, int startTop, int startZ, bool canSwim, bool cantWalk, out int newZ )
 -- returns bla,newZ
-function Check(  mobile,  items,  x,  y,  startTop,  startZ,  canSwim,  ca=
ntWalk )
+function W3_Check(  mobile,  items,  x,  y,  startTop,  startZ,  canSwim, =
 cantWalk )
 	local newZ =3D 0
 =

 	local tiles			 =3D W3_GetStaticTiles( x, y, true ) -- Tile[]
@@ -209,7 +219,7 @@
 						if ( considerLand and landCheck < landCenter and landCenter > ourZ a=
nd testTop > landZ ) then
 							--continue
 						else
-							if ( IsOk( ignoreDoors, ourZ, testTop, tiles, items ) ) then
+							if ( W3_IsOK( ignoreDoors, ourZ, testTop, tiles, items ) ) then
 								newZ =3D ourZ
 								moveIsOk =3D true
 							end
@@ -263,7 +273,7 @@
 						if ( considerLand and landCheck < landCenter and landCenter > ourZ a=
nd testTop > landZ ) then
 							--continue
 						else
-							if ( IsOk( ignoreDoors, ourZ, testTop, tiles, items ) )
+							if ( W3_IsOK( ignoreDoors, ourZ, testTop, tiles, items ) )
 							then
 								newZ =3D ourZ
 								moveIsOk =3D true
@@ -292,7 +302,7 @@
 			if ( cmp > 0 or (cmp =3D=3D 0 and ourZ > newZ) ) then shouldCheck =3D f=
alse end
 		end
 =

-		if ( shouldCheck and IsOk( ignoreDoors, ourZ, testTop, tiles, items ) )
+		if ( shouldCheck and W3_IsOK( ignoreDoors, ourZ, testTop, tiles, items )=
 )
 		then
 			newZ =3D ourZ
 			moveIsOk =3D true
@@ -304,7 +314,7 @@
 =

 --~ private void GetStartZ( Mobile mobile, Map map, Point3D loc, ArrayList=
 itemList, out int zLow, out int zTop )
 -- returns zLow,zTop
-function GetStartZ(  mobile,  posx,posy,posz,  itemList )
+function W3_GetStartZ(  mobile,  posx,posy,posz,  itemList )
 	local zLow,zTop =3D 0,0
 =

 	local landTile =3D W3_GetLandTile( posx, posy ) -- Tile



From no-reply at zwischenwelt.org  Sun Mar 30 17:18:07 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 30 Mar 2008 15:18:07 -0000
Subject: [Iris-commit] [IRIS] r2007 - /trunk/bin/iris2.exe
Message-ID: <20080330151807.438241C1879D@zwischenwelt.org>

Author: sience
Date: Sun Mar 30 17:18:06 2008
New Revision: 2007

Log:
-new win32 Binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Mar 30 22:06:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 30 Mar 2008 20:06:55 -0000
Subject: [Iris-commit] [IRIS] r2008 - in /trunk/lua/net: net.buff.lua
 net.corpse.lua net.other.lua net.uodragdrop.lua net.world.lua
Message-ID: <20080330200656.CE3691C187A1@zwischenwelt.org>

Author: sience
Date: Sun Mar 30 22:06:54 2008
New Revision: 2008

Log:
-some print infos deactivated

Modified:
    trunk/lua/net/net.buff.lua
    trunk/lua/net/net.corpse.lua
    trunk/lua/net/net.other.lua
    trunk/lua/net/net.uodragdrop.lua
    trunk/lua/net/net.world.lua

Modified: trunk/lua/net/net.buff.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.buff.lua (original)
+++ trunk/lua/net/net.buff.lua Sun Mar 30 22:06:54 2008
@@ -112,7 +112,7 @@
 	local id =3D input:PopNetUint8()
 	local packetsize =3D input:PopNetUint16()
 =

-	print("spell buff packet received !!!!!!!!!!",packetsize)
+	--print("spell buff packet received !!!!!!!!!!",packetsize)
 	buffinfos.player_serial	=3D input:PopNetUint32()
 =

 	buffinfos.icon_buffid1		=3D input:PopNetUint16()
@@ -142,20 +142,20 @@
 		if (buffinfos.argumentsmode_start =3D=3D 1) then
 	=

 			local argument_string =3D ""
-			local argument_char
+			local argument_char
 			repeat
 				argument_char	=3D input:PopNetUint8()
 				argument_string =3D argument_string .. argument_char
-				print(argument_char)
+				--print(argument_char)
 			until (argument_char =3D=3D 1)
 			=

-			print(argument_string)
+			--print(argument_string)
 		end
 	=

 		buffinfos.argumentsmode_end		=3D input:PopNetUint16()
 	end
 	=

-	print(vardump2(buffinfos))
+	--print(vardump2(buffinfos))
 	HandleBuffInfo(buffinfos)
 end
 =


Modified: trunk/lua/net/net.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.corpse.lua (original)
+++ trunk/lua/net/net.corpse.lua Sun Mar 30 22:06:54 2008
@@ -51,7 +51,6 @@
 	local player_serial =3D input:PopNetUint32()
 	local corpse_serial =3D input:PopNetUint32()
 	local terminator =3D input:PopNetUint32()
-	print("kPacket_Death_Animation",player_serial,corpse_serial,terminator)
 	printdebug("animation",sprintf("NET: kPacket_Death_Animation: player_seri=
al: 0x%08x corpse_serial=3D0x%08x\n",player_serial,corpse_serial))
 --[[
 	local anim =3D {}

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sun Mar 30 22:06:54 2008
@@ -90,7 +90,7 @@
 	out:PushNetUint8(kPacket_Ping)
 	out:PushNetUint8(0) -- value, usually 0
 	out:SendPacket()
-	print("PingPong")
+	--print("PingPong")
 end
 =

 =

@@ -820,7 +820,7 @@
 -- see runuo1 sourcecode ./Network/PacketHandlers.cs:1176: UnicodeSpeech  =
  for details of encoding/decoding
 -- see also lib.speech.lua for  SpeechParseKeywords
 function Send_UnicodeSpeech (ascistr, mode, huecolor, font)	-- (0xAD)
-	print("Send_UnicodeSpeech",gSpeechLoader,ascistr, mode, huecolor, font)
+	--print("Send_UnicodeSpeech",gSpeechLoader,ascistr, mode, huecolor, font)
 	if not ascistr then print("Send_UnicodeSpeech:missing text") return end
 	=

 	local ascilen		=3D string.len(ascistr)

Modified: trunk/lua/net/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.uodragdrop.lua (original)
+++ trunk/lua/net/net.uodragdrop.lua Sun Mar 30 22:06:54 2008
@@ -11,7 +11,7 @@
 =

 -- This is sent by the client when the player picks up an item. 0x07
 function Send_Take_Object(serial,amount)
-	print("NET: Send_Take_Object:",sprintf("0x%08x",serial),serial,amount)
+	--print("NET: Send_Take_Object:",sprintf("0x%08x",serial),serial,amount)
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Take_Object)
 	out:PushNetUint32(serial)

Modified: trunk/lua/net/net.world.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.world.lua (original)
+++ trunk/lua/net/net.world.lua Sun Mar 30 22:06:54 2008
@@ -90,6 +90,5 @@
 	local nightsoundfx =3D input:PopNetUint16()
 	local dungeon =3D input:PopNetUint8()
 	local light =3D input:PopNetUint8()
-	print("kPacket_New_Region packet !! checkout what emu is used.")
 	printdebug("net",sprintf("NET (todo): Areaname: %s Description: %s Music:=
 %i Dungeon: %i Light: %i\n",areaname, description, music, dungeon, light))
 end



From no-reply at zwischenwelt.org  Sun Mar 30 22:19:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 30 Mar 2008 20:19:36 -0000
Subject: [Iris-commit] [IRIS] r2009 - /branches/stable_release/
Message-ID: <20080330201937.E2B911C1879D@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Mar 30 22:19:35 2008
New Revision: 2009

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Sun Mar 30 22:19:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 30 Mar 2008 20:19:38 -0000
Subject: [Iris-commit] [IRIS] r2010 - /branches/stable_release/
Message-ID: <20080330201938.766931C1879D@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Mar 30 22:19:38 2008
New Revision: 2010

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r2009, trunk/



From no-reply at zwischenwelt.org  Mon Mar 31 13:09:43 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 31 Mar 2008 11:09:43 -0000
Subject: [Iris-commit] [IRIS] r2012 - /trunk/lua/lib.mousepick.lua
Message-ID: <20080331120003.5E2111C18176@zwischenwelt.org>

Author: hagish
Date: Mon Mar 31 13:09:43 2008
New Revision: 2012

Log:
currently in warmode only double click on mobiles triggers an attack

Modified:
    trunk/lua/lib.mousepick.lua

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Mon Mar 31 13:09:43 2008
@@ -31,7 +31,9 @@
 	else
 		-- normal doubleclick handling
 		local pm =3D GetPlayerMobile()
-		if (gActWarmode =3D=3D gWarmode_Normal or (pm and iSerial =3D=3D pm.seri=
al) ) then
+		local othermobile =3D gMobiles[iSerial]
+		=

+		if (gActWarmode =3D=3D gWarmode_Normal or (pm and iSerial =3D=3D pm.seri=
al) or not othermobile) then
 			if (iSerial and iSerial ~=3D 0) then
 				printdebug("net",sprintf("IrisDoubleClick: serial=3D0x%08x\n",iSerial))
 				Send_DoubleClick(iSerial)



From no-reply at zwischenwelt.org  Mon Mar 31 13:43:07 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 31 Mar 2008 11:43:07 -0000
Subject: [Iris-commit] [IRIS] r2013 - in /trunk/lua/gui: gui.gumpmaker.lua
	gui.gumpparser.lua
Message-ID: <20080331120003.846471C187B6@zwischenwelt.org>

Author: hagish
Date: Mon Mar 31 13:43:05 2008
New Revision: 2013

Log:
secure trade working

Modified:
    trunk/lua/gui/gui.gumpmaker.lua
    trunk/lua/gui/gui.gumpparser.lua

Modified: trunk/lua/gui/gui.gumpmaker.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpmaker.lua (original)
+++ trunk/lua/gui/gui.gumpmaker.lua Mon Mar 31 13:43:05 2008
@@ -59,8 +59,12 @@
 	end
 	=

 	widget.SetChecked =3D	function (widget,bChecked)
-		widget.bChecked =3D not bChecked
-		widget.gfx:SetMaterial(widget.bChecked and widget.mat_checked or widget.=
mat_normal)
+		widget.bChecked =3D bChecked
+		if widget.bChecked then
+			widget.gfx:SetMaterial(widget.mat_checked)
+		else
+			widget.gfx:SetMaterial(widget.mat_normal)
+		end
 	end
 	=

 	-- not called if you call SetChecked manually
@@ -72,6 +76,7 @@
 								if (widget.dialog.onMouseLeave) then widget.dialog.onMouseLeave(wi=
dget) end
 							end
 	widget.onMouseDown =3D	function (widget,mousebutton)
+								-- NOTE SetChecked changes teh the widget.bChecked status
 								if (mousebutton =3D=3D 1) then widget:SetChecked(not widget.bCheck=
ed) widget:onChange(widget.bChecked) end
 								if (widget.bCallDialogDefault and widget.dialog.onMouseDown) then =
widget.dialog.onMouseDown(widget,mousebutton) end
 							end
@@ -79,6 +84,7 @@
 								if (widget.bCallDialogDefault and widget.dialog.onMouseUp) then wi=
dget.dialog.onMouseUp(widget,mousebutton) end
 							end
 =

+	widget:SetChecked(bChecked)
 	return widget
 end
 =


Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Mon Mar 31 13:43:05 2008
@@ -481,7 +481,10 @@
 				local check_down =3D bToken[5]
 				local check_state =3D tonumber(bToken[6])
 				local check_rtn =3D tonumber(bToken[7])
-				local widget
+
+				local widget =3D MakeGumpCheckBox(curparent, check_state > 0, check_no=
rm, check_down, check_x, check_y)
+				=

+				--[[
 				if (check_state=3D=3D0) then
 					widget =3D MakeBorderGumpPart(curparent, check_norm, check_x, check_y)
 				else
@@ -505,6 +508,7 @@
 											printdebug("gump","Checkbox changed : id=3D"..widget.returnmsg.=
." state=3D"..widget.state)
 										end
 									  end
+									  ]]
 				if (Clientsidemode) then dialog.controls[ bToken[8] ] =3D widget end
 				table.insert(dialog.uo_check,widget)
 =




From no-reply at zwischenwelt.org  Mon Mar 31 13:05:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 31 Mar 2008 11:05:36 -0000
Subject: [Iris-commit] [IRIS] r2011 - in /trunk/lua: lib.macrolist.lua
 lib.pathfind.lua lib.tilefreewalk.lua
Message-ID: <20080331120003.4157B1C18749@zwischenwelt.org>

Author: hagish
Date: Mon Mar 31 13:05:34 2008
New Revision: 2011

Log:
space to start fighting

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.pathfind.lua
    trunk/lua/lib.tilefreewalk.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Mar 31 13:05:34 2008
@@ -40,7 +40,7 @@
 function MacroCmd_RepeatLastDoubleClick	()		if (gInGameStarted) then Repea=
tLastDoubleClick() end end
 function MacroCmd_SelectNearestMobile	()		if (gInGameStarted) then SelectN=
earestMobile() end end
 function MacroCmd_SelectNextMobile		()		if (gInGameStarted) then SelectNex=
tMobile() end end
-function MacroCmd_AttackSelectedMobile	()		if (gInGameStarted) then print(=
"not implemented yet") end end
+function MacroCmd_AttackSelectedMobile	()		if (gInGameStarted) then if giS=
electedMobile then AttackMobile(giSelectedMobile) end end end
 function MacroCmd_ToggleWarmode			()		if (gInGameStarted) then Send_Combat=
Mode((gActWarmode=3D=3DgWarmode_Normal) and gWarmode_Combat or gWarmode_Nor=
mal) end end
 function MacroCmd_Open					(dialogtype)
 	if (not gInGameStarted) then return end
@@ -329,3 +329,56 @@
 function CloseMacroListDialog_OLD () =

 	if (gMacroListDialog) then gMacroListDialog:Destroy() gMacroListDialog =
=3D nil end
 end
+
+function MacroCmd_WalkToMouse	()
+	gCurrentRenderer:MousePick()
+	local x,y,z =3D gCurrentRenderer:GetMouseHitTileCoords()
+	SetAutoWalkTo(x,y)
+end
+
+
+gAttackRunning =3D false
+function StopAttack	()
+	gAttackRunning =3D false
+end
+
+gAttackMobile =3D nil
+function AttackMobile	(mobileserial)
+	gAttackMobile =3D mobileserial
+	if gAttackRunning then return end
+	gAttackRunning =3D true
+	=

+	job.create(function()
+		print("START ATTACK")
+		local reqsend =3D false
+		while gAttackRunning and gAttackMobile do
+			local mobile =3D gMobiles[gAttackMobile]
+			if not mobile then =

+				gAttackRunning =3D false
+			else
+				local tx,ty,tz =3D mobile.xloc,mobile.yloc,mobile.zloc
+				local px,py,pz =3D GetPlayerTilePosition()
+				local dx,dy,dz =3D Vector.sub(px,py,pz, tx,ty,tz)
+				dx,dy,dz =3D Vector.normalise_to_len(dx,dy,dz, 1)
+				gTileFreeWalk:SetViewDir(dx,dy)
+				dx,dy,dz =3D Vector.add(tx,ty,tz, dx,dy,dz)
+				dx =3D round(dx)
+				dy =3D round(dy)
+				SetAutoWalkTo(dx,dy)
+				=

+				if (gActWarmode =3D=3D gWarmode_Combat) then
+					if not reqsend then
+						print("REQUEST SEND")
+						Send_AttackReq(gAttackMobile)
+						reqsend =3D true
+					end
+				else =

+					reqsend =3D false
+				end
+				=

+				job.wait(500)
+			end
+		end
+		print("STOP ATTACK")
+	end)
+end

Modified: trunk/lua/lib.pathfind.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.pathfind.lua (original)
+++ trunk/lua/lib.pathfind.lua Mon Mar 31 13:05:34 2008
@@ -1,26 +1,30 @@
 -- a star pathfinding
 =

 function Pathfinding_TriggeredByMouse	()
-	if gMousePickFoundHit and gMousePickFoundHit.hittype =3D=3D kMousePickHit=
Type_Terrain then
-		local dx,dy,dz =3D gMousePickFoundHit.x, gMousePickFoundHit.y, gMousePic=
kFoundHit.maxz
-		Pathfinding_TriggeredByDestination(dx,dy,dz)
-	end
-end
-
-function Pathfinding_TriggeredByDestination	(dx,dy,dz)
+	gCurrentRenderer:MousePick()
+	local x,y,z =3D gCurrentRenderer:GetMouseHitTileCoords()
+	z =3D math.floor(z * 0.1)
+	Pathfinding_TriggeredByDestination(x,y,z)
+end
+
+function GetPlayerTilePosition	()
+	local mobile =3D GetPlayerMobile()
 	local sx,sy,sz
-	=

-	local mobile =3D GetPlayerMobile()
 	if mobile then
-		sx,sy,sz =3D mobile.xloc,mobile.yloc,mobile.zloc * 0.1
+		sx,sy,sz =3D mobile.xloc,mobile.yloc,mobile.zloc
 	else
 		sx,sy,sz =3D gTileFreeWalk:GetExactLocalPos()
 		sx =3D -sx
+		sz =3D sz * 10
 	end
-	=

-	sx =3D math.floor(sx)
-	sy =3D math.floor(sy)
-	sz =3D math.floor(sz)
+	return math.floor(sx),math.floor(sy),math.floor(sz)
+end
+
+function Pathfinding_TriggeredByDestination	(dx,dy,dz)
+	local sx,sy,sz =3D GetPlayerTilePosition()
+	=

+	sz =3D math.floor(sz * 0.1)
+	=

 	dx =3D math.floor(dx)
 	dy =3D math.floor(dy)
 	dz =3D math.floor(dz)

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Mon Mar 31 13:05:34 2008
@@ -139,9 +139,10 @@
 	local x,y,z =3D self:GetPos_ClientSide()
 	local ox,oy =3D x,y
 	=

-	-- cancel autowalk if user interacts
+	-- cancel autowalk and attack if user interacts
 	if bWalkInMouseDir or bWalkForward or bWalkBackwards or bTurnLeft or bTur=
nRight then
 		gWalkPathToGo =3D nil
+		StopAttack()
 	end
 	=

 	-- read input and calculate desired movement



