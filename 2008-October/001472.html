<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r2668 - in /trunk/lua: lib.macrolist.lua lib.uoutils.lua net/net.extended.lua net/net.generic.lua net/net.gump.lua net/net.main.lua net/net.other.lua net/net.text.lua widgets/widget.uoquickcasticon.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2668%20-%20in%20/trunk/lua%3A%20lib.macrolist.lua%0A%20lib.uoutils.lua%20net/net.extended.lua%20net/net.generic.lua%20net/net.gump.lua%0A%20net/net.main.lua%20net/net.other.lua%20net/net.text.lua%0A%20widgets/widget.uoquickcasticon.lua&In-Reply-To=%3C20081029174144.390E01C18638%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001471.html">
   <LINK REL="Next"  HREF="001473.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r2668 - in /trunk/lua: lib.macrolist.lua lib.uoutils.lua net/net.extended.lua net/net.generic.lua net/net.gump.lua net/net.main.lua net/net.other.lua net/net.text.lua widgets/widget.uoquickcasticon.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2668%20-%20in%20/trunk/lua%3A%20lib.macrolist.lua%0A%20lib.uoutils.lua%20net/net.extended.lua%20net/net.generic.lua%20net/net.gump.lua%0A%20net/net.main.lua%20net/net.other.lua%20net/net.text.lua%0A%20widgets/widget.uoquickcasticon.lua&In-Reply-To=%3C20081029174144.390E01C18638%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r2668 - in /trunk/lua: lib.macrolist.lua lib.uoutils.lua net/net.extended.lua net/net.generic.lua net/net.gump.lua net/net.main.lua net/net.other.lua net/net.text.lua widgets/widget.uoquickcasticon.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Wed Oct 29 18:41:43 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001471.html">[Iris-commit] [IRIS] r2667 - in /trunk: lua/lib.packetvideo.lua	videos/
</A></li>
        <LI>Next message: <A HREF="001473.html">[Iris-commit] [IRIS] r2669 - /trunk/lua/lib.loading.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1472">[ date ]</a>
              <a href="thread.html#1472">[ thread ]</a>
              <a href="subject.html#1472">[ subject ]</a>
              <a href="author.html#1472">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Wed Oct 29 18:41:43 2008
New Revision: 2668

Log:
split net.other.lua into a few seperate files

Added:
    trunk/lua/net/net.extended.lua
    trunk/lua/net/net.generic.lua
    trunk/lua/net/net.gump.lua
    trunk/lua/net/net.text.lua
Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.uoutils.lua
    trunk/lua/net/net.main.lua
    trunk/lua/net/net.other.lua
    trunk/lua/widgets/widget.uoquickcasticon.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Wed Oct 29 18:41:43 2008
@@ -276,6 +276,13 @@
 =

 -- doesn't sum stack-amount
 function MacroCmd_Item_CountByArtID	(artid,hue,container) local list =3D M=
acroCmd_Item_FindByArtID(artid,hue,container) return list and #list or 0 end
+function MacroCmd_Item_SumByArtID	(artid,hue,container) -- does sum stack
+	local list =3D MacroCmd_Item_FindByArtID(artid,hue,container) =

+	if (not list) then return 0 end
+	local c =3D 0
+	for k,item in pairs(list) do c =3D c + item.amount end
+	return c
+end
 =

 -- container defaults to player-backpack
 function MacroCmd_Item_FindByName	(itemnamepart,container)

Modified: trunk/lua/lib.uoutils.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoutils.lua (original)
+++ trunk/lua/lib.uoutils.lua Wed Oct 29 18:41:43 2008
@@ -67,3 +67,22 @@
 	text =3D string.gsub(text,&quot;\223&quot;,&quot;ss&quot;)
 	return text
 end
+
+
+function UniCodeDualPop (fifo,number_of_unicode_chars)
+	--~ return input:PopUnicodeString(textlen) -- old, only asci part , TODO =
:<i> see also PopUnicodeLEString
</I>+	local ascipart =3D &quot;&quot;
+	local unicode_charcodes =3D {}
+	for i =3D 1,number_of_unicode_chars do
+		local head =3D fifo:PopUint8()
+		local data =3D fifo:PopUint8()
+		if (head ~=3D 0) then
+			ascipart =3D ascipart .. &quot;?&quot; .. (data ~=3D 0 and string.format(&quot;%c&quot;,dat=
a) or &quot;&quot;)
+		else
+			ascipart =3D ascipart .. string.format(&quot;%c&quot;,data)
+		end
+		table.insert(unicode_charcodes,head*256 + data)
+	end
+	return ascipart,unicode_charcodes
+end
+

Modified: trunk/lua/net/net.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.main.lua (original)
+++ trunk/lua/net/net.main.lua Wed Oct 29 18:41:43 2008
@@ -14,6 +14,10 @@
 dofile(libpath .. &quot;net/net.aoscommand.lua&quot;)
 dofile(libpath .. &quot;net/net.cursor.lua&quot;)
 dofile(libpath .. &quot;net/net.other.lua&quot;)
+dofile(libpath .. &quot;net/net.text.lua&quot;)
+dofile(libpath .. &quot;net/net.generic.lua&quot;)
+dofile(libpath .. &quot;net/net.gump.lua&quot;)
+dofile(libpath .. &quot;net/net.extended.lua&quot;)
 dofile(libpath .. &quot;net/net.securetrade.lua&quot;)
 dofile(libpath .. &quot;net/net.trade.lua&quot;)
 =


Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Wed Oct 29 18:41:43 2008
@@ -1,100 +1,8 @@
 -- packet handlers for all other packets that don't fit into the other cat=
egories
 -- see also lib.packet.lua and lib.protocol.lua
 -- see also net.popup.lua
-
-gGenericSubCommands =3D {}
-gGenericSubCommands.kPacket_Generic_SubCommand_FastWalkInit			=3D 0x01
-gGenericSubCommands.kPacket_Generic_SubCommand_FastWalkAddKey		=3D 0x02
-gGenericSubCommands.kPacket_Generic_SubCommand_CloseGenericGump		=3D 0x04
-gGenericSubCommands.kPacket_Generic_SubCommand_Screensize			=3D 0x05
-gGenericSubCommands.kPacket_Generic_SubCommand_PartySystem			=3D 0x06
-gGenericSubCommands.kPacket_Generic_SubCommand_QuestArrow			=3D 0x07
-gGenericSubCommands.kPacket_Generic_SubCommand_MapChange			=3D 0x08
-gGenericSubCommands.kPacket_Generic_SubCommand_DisarmRequest		=3D 0x09
-gGenericSubCommands.kPacket_Generic_SubCommand_AOSTooltip			=3D 0x10
---(0x0A) Sent by using the client Wrestle Stun Macro key in Options.
---This is no longer used since AoS was introduced. The Macro selection tha=
t used it was removed.
-gGenericSubCommands.kPacket_Generic_SubCommand_Wrestling_Stun		=3D 0x0A
-gGenericSubCommands.kPacket_Generic_SubCommand_ClientLanguage		=3D 0x0B	--=
 Client sends Client-language to Server
-gGenericSubCommands.kPacket_Generic_SubCommand_CloseStatus			=3D 0x0C
-gGenericSubCommands.kPacket_Generic_SubCommand_3DClientAction		=3D 0x0E	--=
 Client Sent. Server responds with Play Animation packets.
-gGenericSubCommands.kPacket_Generic_SubCommand_PopupRequest			=3D 0x13	-- =
Client -&gt; Server packet
-gGenericSubCommands.kPacket_Generic_SubCommand_DisplayPopup			=3D 0x14
-gGenericSubCommands.kPacket_Generic_SubCommand_PopupEntrySelect		=3D 0x15
-gGenericSubCommands.kPacket_Generic_SubCommand_CodexOfWisdom		=3D 0x17
-gGenericSubCommands.kPacket_Generic_SubCommand_EnableMapDiff		=3D 0x18
-gGenericSubCommands.kPacket_Generic_SubCommand_ExtendedStats		=3D 0x19
-gGenericSubCommands.kPacket_Generic_SubCommand_ExtendedStats2		=3D 0x1A
-gGenericSubCommands.kPacket_Generic_SubCommand_NewSpellbook			=3D 0x1B	-- =
Create New Spellbook
-gGenericSubCommands.kPacket_Generic_SubCommand_SpellSelected		=3D 0x1C	-- =
Client -&gt; Server packet ! Doppelclick auf Spell
-gGenericSubCommands.kPacket_Generic_SubCommand_RevisionCustomHouse	=3D 0x1=
D	-- Sends a house Revision number for handling client multi cache.
-															-- If revision is newer than what client has it asks for th=
e new multi packets to cache it.
-gGenericSubCommands.kPacket_Generic_SubCommand_HouseSerial			=3D 0x1E
-gGenericSubCommands.kPacket_Generic_SubCommand_Ability_Icon			=3D 0x21	-- =
nodata just (bf 00 05 21) , used together with weapon abilities / combat sk=
ills
-gGenericSubCommands.kPacket_Generic_SubCommand_OldDamage			=3D 0x22	-- Don=
e!
-gGenericSubCommands.kPacket_Generic_SubCommand_UnknownSE			=3D 0x24	-- Cli=
ent -&gt; Server packet
-gGenericSubCommands.kPacket_Generic_SubCommand_EnableSESpellIcons	=3D 0x25
-gGenericSubCommands.kPacket_Generic_SubCommand_SpeedMode			=3D 0x26
-gGenericSubCommands.kPacket_Generic_SubCommand_NewRaceGender		=3D 0x2A
-gGenericSubCommands.kPacket_Generic_SubCommand_IrisInfo				=3D 0xA0 -- iri=
s-special, for iris aware servers
---[[
--race_gender-packet
-Client -&gt; Server =

-BYTE 	0xBF =

-WORD 	Length ( 15 ) =

-WORD 	Subcommand - 0x2A =

-WORD 	BodyHue =

-WORD 	HairId =

-WORD 	HairHue =

-WORD 	BeardId =

-WORD 	BeardHue
-]]--
-gGenericSubCommands.kPacket_Generic_SubCommand_BandageTarget		=3D hex2num(=
&quot;0x2C&quot;)	-- Client -&gt; Server packet,For use with the new Bandage Self client=
 macro. Introduced in 5.0.4x
-
-function SendBandageSelf (bandageid) return SendBandageCommand(bandageid,G=
etPlayerSerial()) end
-function SendBandageCommand (bandageid,targetid) =

-	if (not bandageid) then
-		local bandage =3D MacroCmd_Item_FindFirstByArtID(3617,0) -- find bandage=
 in backpack
-		if (not bandage) then return end
-		bandageid =3D bandage.serial
-	end
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(0x0D) -- packet size
-	out:PushNetUint16(kPacket_Generic_SubCommand_BandageTarget) -- 2C
-	out:PushNetUint32(bandageid)
-	out:PushNetUint32(targetid)
-	out:SendPacket()
-	-- 0000   BF 00 0D 00 2C 41 3D BC  CD 00 0D BA 5B            ....,A=3D...=
..[
-	-- kPacket_Generic_SubCommand_BandageTarget=3D0x2D : bandages=3D0x413dbcc=
d targetid=3D0x000dba5b
-	return true
-end
-
-
---[[
---new sincec KR
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse =3D he=
x2num(&quot;0x2F&quot;)	-- BF.2F - KR House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_defaul=
t =3D hex2num(&quot;0x63&quot;)	--BF.2F.63 - KR Default House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_pubpri=
v =3D hex2num(&quot;0x65&quot;)	--BF.2F.65 - KR Change Public/Private House Menu Gump=
 Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_conver=
t =3D hex2num(&quot;0x66&quot;)	--BF.2F.66 - KR Convert into the customizable House M=
enu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_reloca=
te=3D hex2num(&quot;0x68&quot;)	--BF.2F.68 - KR Relocate Moving Crate House Menu Gump=
 Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_sign	=
=3D hex2num(&quot;0x69&quot;)	--BF.2F.69 - KR Change Sign House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_hanger=
	=3D hex2num(&quot;0x6A&quot;)	--BF.2F.6A - KR Change Sign Hanger House Menu Gump Res=
ponse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_post	=
=3D hex2num(&quot;0x6B&quot;)	--BF.2F.6B - KR Change Sign Post House Menu Gump Respon=
se
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_founda=
tion=3D hex2num(&quot;0x6C&quot;)	--BF.2F.6C - KR Change Foundation Style House Menu =
Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_rename=
	=3D hex2num(&quot;0x6D&quot;)	--BF.2F.6D - KR Rename House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_demoli=
sh=3D hex2num(&quot;0x6E&quot;)	--BBF.2F.6E - KR Demolish House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_trade	=
=3D hex2num(&quot;0x6F&quot;)	--BF.2F.6F - KR Trade House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_primar=
y	=3D hex2num(&quot;0x70&quot;)	--BF.2F.70 - KR Make Primary House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_coowne=
r	=3D hex2num(&quot;0x71&quot;)	--BF.2F.71 - KR Change To Co-Owner House Menu Gump Re=
sponse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_friend=
	=3D hex2num(&quot;0x72&quot;)	--BF.2F.72 - KR Change To Friend House Menu Gump Respo=
nse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_access=
	=3D hex2num(&quot;0x73&quot;)	--BF.2F.73 - KR Change To Access House Menu Gump Respo=
nse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_primar=
y	=3D hex2num(&quot;0x74&quot;)	--BF.2F.74 - KR Ban House Menu Gump Response
---a.s.o. to BF.2F.80
-gGenericSubCommands.kPacket_Generic_SubCommand_TargetbyResource		=3D hex2n=
um(&quot;0x30&quot;)	---BF.30 - KR Target By Resource Macro
-]]--
-gGenericSubCommandNamesByID =3D {}
-for k,v in pairs(gGenericSubCommands) do _G[k] =3D v gGenericSubCommandNam=
esByID[v] =3D k end
+-- see also net.generic.lua
+-- see also net.extended.lua
 =

 gActWarmode =3D 0
 		=

@@ -117,379 +25,8 @@
 	--print(&quot;PingPong&quot;)
 end
 =

--- triggers -- which came from kPacket_Generic_SubCommand_DisplayPopup
-function Send_PopupRequest (serial)
-	--- if there is already one open, close it
-	if gPopupMenu ~=3D nil then gPopupMenu:Close() end
-	gRunningPopupRequestTimeOut =3D gMyTicks + kRunningPopupRequestTimeOutInt=
erval
-
-	gPopupMenuSavedPosX,gPopupMenuSavedPosY =3D GetMousePos() -- TODO : maybe=
 save mousepos at the time of contextrequest ?
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(hex2num(&quot;0x09&quot;)) -- packet size
-	out:PushNetUint16(kPacket_Generic_SubCommand_PopupRequest) -- Popup Reque=
st Sub-Command
-	out:PushNetUint32(serial) -- Popup Request Sub-Command
-	out:SendPacket()
-end
-
--- sends kPacket_Generic_SubCommand_PopupEntrySelect after the user has ch=
oosen an answer to the popup
--- which came from kPacket_Generic_SubCommand_DisplayPopup
--- see also SendPopupChoice() from old iris
-function Send_PopupAnswer (popupserial,entrytag)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(hex2num(&quot;0x0B&quot;)) -- packet size
-	out:PushNetUint16(kPacket_Generic_SubCommand_PopupEntrySelect) -- Popup R=
equest Sub-Command
-	out:PushNetUint32(popupserial)
-	out:PushNetUint16(entrytag)
-	out:SendPacket()
-end
-
--- sends the server the lock state of one stat
--- stat (0=3Dstr, 1=3Ddex, 2=3Dint)
--- lockstate (0=3Dup, 1=3Ddown, 2=3Dlocked)
-function Send_StatsLockState(stat, lockstate)
-	-- print(&quot;DEBUG&quot;,&quot;Send_StatsLockState&quot;,stat,lockstate)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(7)
-	out:PushNetUint16(kPacket_Generic_SubCommand_ExtendedStats2)
-	out:PushNetUint8(stat)
-	out:PushNetUint8(lockstate)
-	out:SendPacket()
-end
-
-kPacket_ExtSubCommand_PartyQueryPos		=3D 0x00
-kPacket_ExtSubCommand_PartyPosAck		=3D 0x01
-
--- answer : kPacket_ExtBundledPacket
-function	PartySendQueryPos () =

-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_ExtBundledPacket) -- 0xF0
-	out:PushNetUint16(4)
-	out:PushNetUint8(kPacket_ExtSubCommand_PartyQueryPos)  =

-	out:SendPacket()
-end
-
-
--- party positon, has to be requested regularly : PartySendQueryPos
-function gPacketHandler.kPacket_ExtBundledPacket() -- 0xF0
-	local input =3D GetRecvFIFO()
-	local popped_start =3D input:GetTotalPopped()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local subcmd =3D input:PopNetUint8()
-	=

-	if (subcmd =3D=3D kPacket_ExtSubCommand_PartyPosAck) then
-		local partyposlist =3D {}
-		while (true) do
-			local memberpos =3D {}
-			memberpos.serial	=3D input:PopNetUint32()
-			if (memberpos.serial =3D=3D 0) then break end -- termination
-			memberpos.xloc		=3D input:PopNetUint16()
-			memberpos.yloc		=3D input:PopNetUint16()
-			memberpos.facet		=3D input:PopNetUint8() -- mapid
-			--~ print(&quot;partypos&quot;,memberpos.serial,memberpos.xloc,memberpos.yloc,mem=
berpos.facet)
-			partyposlist[memberpos.serial] =3D memberpos
-		end
-		NotifyListener(&quot;Hook_PartyPos&quot;,partyposlist) -- {[serial]=3D{serial=3D?,=
xloc=3D?,yloc=3D?,facet=3D?},...}
-	end
-	=

-
-	-- check if all data was used
-	local used =3D input:GetTotalPopped() - popped_start
-	local rest =3D size - used
-	if (rest &lt; 0) then
-		printf(&quot;FATAL ! kPacket_ExtBundledPacket : subcmd 0x%02x (used=3D%d size=
=3D%d) popped too much\n&quot;,subcmd,used,size)
-		print(&quot;FATAL ! kPacket_ExtBundledPacket -&gt; forced Crash&quot;)
-		Crash()
-	end
-	if (rest &gt; 0) then
-		printf(&quot;WARNING ! kPacket_ExtBundledPacket : subcmd 0x%02x (used=3D%d si=
ze=3D%d) popped to few\n&quot;,subcmd,used,size)
-		input:PopRaw(rest)
-	end
-end
-
-
-
-
-
-
-
-
--- TODO : implement all subpackets
-function gPacketHandler.kPacket_Generic_Command()
-	local input =3D GetRecvFIFO()
-	local popped_start =3D input:GetTotalPopped()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local subcmd =3D input:PopNetUint16()
-	--~ printf(&quot;NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D=
%s\n&quot;,size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
-	printdebug(&quot;net&quot;,sprintf(&quot;NET: kPacket_Generic_Command size=3D0x%04x subc=
md=3D0x%04x=3D%s\n&quot;,size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd=
])))
-
-	-- FastWalkInit : 6 keys (runuo's fifosize 0-255)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_FastWalkInit) then -- 0x01
-		local keys =3D {}
-		for i =3D 1,6 do table.insert(keys,input:PopNetUint32()) end
-		FastWalk_Init(keys)
-	end
-
-	-- FastWalkAddKey
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_FastWalkAddKey) then
-		FastWalk_PushKey(input:PopNetUint32())
-	end
-
-	--Subcommand 4: &quot;Close Generic Gump&quot; =

-	--BYTE[4] dialogID // which gump to destroy (second ID in 0xB0 packet) =

-	--BYTE[4] buttonId // response buttonID for packet 0xB1
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_CloseGenericGump) then -- 0x=
04
-		local dialogId =3D input:PopNetUint32()
-		local buttonId =3D (size &gt;=3D 5+4+4) and input:PopNetUint32() or 0
-		local playermobile =3D GetPlayerMobile()
-		CloseServerSideGump(playermobile.serial,dialogId,buttonId)
-		printdebug(&quot;net&quot;,sprintf(&quot;NET: kPacket_Generic_SubCommand_CloseGenericGu=
mp (0xbf sub=3D0x04)&quot;))
-	end
-
-	-- Party System
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_PartySystem) then -- 0x06
-		HandlePartySystemMessage(input,size)
-	end
-
-	-- Quest Arrow (mobile)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_QuestArrow) then --0x07
-		-- TODO: check ... specification is: byte - Right Click (1=3Dyes, 0=3Dno)
-		for i =3D 0, size-6 do
-			local temp =3D input:PopNetUint8()
-			print(&quot;NET (todo): 0xbf Quest_Arrow subcmd 0x07: &quot;..temp)
-		end
-	end
-
-	-- Map Change
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_MapChange) then -- 0x08
-		local mapid =3D input:PopNetUint8()
-		MapChangeRequest(mapid)
-	end
-
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_CloseStatus) then	--0x0C
-		local mobilestatus_serial =3D input:PopNetUint8()
-		CloseHealthbar(mobilestatus_serial)
-	end
-
-	-- AOSTooltip
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_AOSTooltip) then -- 0x10
-		local objserial =3D input:PopNetUint32()
-		local listID =3D input:PopNetUint32()
-		printdebug(&quot;net&quot;, sprintf(&quot;0xbf sub: kPacket_Generic_SubCommand_AOSToolt=
ip objserial=3D0x%08x listID=3D0x%08x\n&quot;,
-									objserial,listID) )
-		Send_AosToolTipRequest(objserial)
-	end
-
-	-- display popup
-	-- TODO : check if PopUp is already opened - use a popuplist with serials=
 !?
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_DisplayPopup) then -- 0x14
-		local popupmenu =3D {}
-		popupmenu.unknown		=3D input:PopNetUint16() -- always 0x0001
-		popupmenu.serial		=3D input:PopNetUint32()
-		popupmenu.numentries	=3D input:PopNetUint8() -- Number of entries in the=
 popup
-		popupmenu.entries		=3D {}
-		for i =3D 1, popupmenu.numentries do =

-			local entry =3D {}
-			entry.popupmenu =3D popupmenu
-			entry.tag		=3D input:PopNetUint16() -- Entry Tag (this will be returned=
 by the client on selection)
-			entry.textid	=3D input:PopNetUint16() -- ID is the file number for intl=
oc#.language e.g intloc6.enu and the index into that
-			entry.text 		=3D GetPopupEntryText(entry.textid) or &quot;unknown&quot;
-			entry.flags		=3D input:PopNetUint16() -- 0x01 =3D locked, 0x02 =3D arro=
w, 0x20 =3D color
-			if (TestBit(entry.flags,kPopupEntryFlag_Color)) then
-				entry.color	=3D input:PopNetUint16() =

-				-- rgb 1555 color (ex, 0 =3D transparent, 0x8000 =3D solid black, 0x1F=
 =3D blue, 0x3E0 =3D green, 0x7C00 =3D red)
-			else
-				entry.color	=3D 0
-			end
-			popupmenu.entries[i] =3D entry
-		end
-		=

-		DisplayPopupMenu(popupmenu) -- see net.popup.lua
-		NotifyListener(&quot;Hook_OpenPopupMenu&quot;,popupmenu)	=

-	end
-
-	-- enable diff files for felucca,trammel,ilshenar,malas
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableMapDiff) then -- 0x18
-		local mapnumbers =3D input:PopNetUint32()
-		local myEnableDiff =3D {}
-		for i =3D 0, mapnumbers-1 do
-			myEnableDiff[i] =3D {}
-			myEnableDiff[i].iNumPatchesMap 		=3D input:PopNetUint32() -- Number of =
map patches in this map
-			myEnableDiff[i].iNumPatchesStatic	=3D input:PopNetUint32() -- Number of=
 static patches in this map
-		end
-		EnableDiff(myEnableDiff) -- see lib.diff.lua
-	end
-	=

-	-- States LockInfo	-- bonded status
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_ExtendedStats) then -- 0x19
-		local party_cmd =3D input:PopNetUint8()
-		--~ print(&quot;kPacket_Generic_SubCommand_ExtendedStats&quot;,party_cmd)
-		if (party_cmd =3D=3D hex2num(&quot;0x00&quot;)) then
-			local party_serial =3D input:PopNetUint32()
-			local party_value  =3D input:PopNetUint8()
-			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x p=
arty_value: 0x%02x\n&quot;,party_cmd,party_serial,party_value)
-		end
-		-- statlock info
-		--[[
-			sent by server SERVER
-			Subcommand: 0x19: Extended stats
-			BYTE[1] type // always 2 ? never seen other value
-			BYTE[4] serial
-			BYTE[1] unknown // always 0 ?
-			BYTE[1] lockBits // Bits: XXSS DDII (s=3Dstrength, d=3Ddex, i=3Dint), 0=
 =3D up, 1 =3D down, 2 =3D locked
-		]]--
-		if (party_cmd =3D=3D hex2num(&quot;0x02&quot;)) then
-			local serial =3D input:PopNetUint32()
-			local value  =3D input:PopNetUint8()
-			local lockflags  =3D input:PopNetUint8()
-			local int =3D BitwiseAND(BitwiseSHR(lockflags, 0), 3)
-			local dex =3D BitwiseAND(BitwiseSHR(lockflags, 2), 3)
-			local str =3D BitwiseAND(BitwiseSHR(lockflags, 4), 3)
-			=

-			local mobile =3D GetMobile(serial)
-			if mobile then
-				mobile:UpdateStatsLockState(str, dex, int)
-			else
-				print(&quot;NET: got statsLockStats from unknown mobile&quot;, serial, str, dex,=
 int)
-			end
-			=

-			-- printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x =
party_value: 0x%02x party_lockflags: 0x%02x\n&quot;,party_cmd,party_serial,party=
_value,party_lockflags)
-		end
-		if (party_cmd =3D=3D hex2num(&quot;0x1a&quot;)) then
-			local party_stattype  =3D input:PopNetUint8()
-			local party_lockvalue  =3D input:PopNetUint8()
-			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_stattype: 0x%02x=
 party_lockvalue: 0x%02x\n&quot;,party_cmd,party_stattype,party_lockvalue)
-		end
-	end
-
-	-- first bit of first byte =3D spell #1, second bit of first byte =3D spe=
ll #2, first bit of second byte =3D spell #8, etc
-	-- Create Spellbook Container
-	-- matix 0xff030000
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_NewSpellbook) then -- 0x1B
-		local spellbook =3D {}
-		spellbook.old=3Dfalse
-		spellbook.matrix =3D {}
-		spellbook.unknown =3D input:PopNetUint16()
-		spellbook.serial =3D input:PopNetUint32()
-		spellbook.itemid =3D input:PopNetUint16()
-		spellbook.scrolloffset =3D input:PopNetUint16()	-- 1=3D=3Dregular, 101=
=3Dnecro, 201=3Dpaladin, 401=3Dbushido, 501=3Dninjitsu, 601=3Dspellweaving
-		spellbook.matrix[1] =3D input:PopNetUint8()
-		spellbook.matrix[2] =3D input:PopNetUint8()
-		spellbook.matrix[3] =3D input:PopNetUint8()
-		spellbook.matrix[4] =3D input:PopNetUint8()
-		spellbook.matrix[5] =3D input:PopNetUint8()
-		spellbook.matrix[6] =3D input:PopNetUint8()
-		spellbook.matrix[7] =3D input:PopNetUint8()
-		spellbook.matrix[8] =3D input:PopNetUint8()
-		print(&quot;kPacket_Generic_SubCommand_NewSpellbook&quot;,spellbook.scrolloffset,s=
pellbook.unknown,spellbook.serial,spellbook.itemid)
-		printdebug(&quot;net&quot;,sprintf(&quot;NET: kPacket_Generic_SubCommand_NewSpellbook s=
erial=3D0x%08x itemId=3D0x%04x offset=3D0x%04x\n&quot;,
-								spellbook.serial, spellbook.itemid, spellbook.scrolloffset))
-		Open_Spellbook(spellbook)
-	end
-
-	--Enable/Disable SE Spell Icons
-	--OnCastSuccessful(spellid), OnEffectEnd (spellid), ClearCurrentMove, Cle=
arAllMoves, SetCurrentMove
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableSESpellIcons) then -- =
0x25
-		local temp =3D input:PopNetUint8()		--always 1
-		local abilityID =3D input:PopNetUint8()	--abilityID
-		local active =3D input:PopNetUint8()		--0/1 On/Off
-		printf(&quot;ABILITY\tSE Spell Icons abilityID: 0x%02x active: 0x%02x\n&quot;, abi=
lityID, active)
-	end
-
-	-- Subcommand 0x21: (AOS) weapon-Ability icon confirm/end.  see also Send=
_AOSCommand_WeaponAbility
-	-- Note: no data, just (bf 00 05 21) =

-	if (subcmd =3D=3D kPacket_Generic_SubCommand_Ability_Icon) then	-- 0x21
-		EndWeaponAbility()
-		NotifyListener(&quot;Hook_Deactivate_Ability&quot;)
-	end
-
-	-- Receives a CustomHouse Serial &amp; Revision Hash Number
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_RevisionCustomHouse) then	--=
 0x1D
-		local customhouseserial =3D input:PopNetUint32()
-		local customhouserevision =3D input:PopNetUint32()
-		printdebug(&quot;net&quot;,sprintf(&quot;NET: kPacket_Generic_SubCommand_RevisionCustom=
House customhouseserial=3D0x%08x customhouserevision=3D0x%08x\n&quot;,
-								customhouseserial, customhouserevision))
-
-		local dyn =3D GetDynamic(customhouseserial)
-		-- check if houserevision exists
-		if (dyn) then
-			if (dyn.customhouserevision) then
-				-- compare new_houserevisiont with old_houserevision, if different cha=
nge to new
-				if (customhouserevision~=3Ddyn.customhouserevision) then
-					Send_CustomHouseRevision(customhouseserial)
-					printdebug(&quot;net&quot;,sprintf(&quot;NET: old-customhouse -&gt; request new revisio=
n\n&quot;))
-				end
-			else
-				Send_CustomHouseRevision(customhouseserial)
-				printdebug(&quot;net&quot;,sprintf(&quot;NET: old-customhouse -&gt; request new revision=
\n&quot;))
-			end
-		end
-	end
-
-	-- old-damage receive packet	(not used by RunUO?)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_OldDamage)	then	-- 0x22
-		local olddamage_temp  =3D input:PopNetUint8()	-- always 1	?
-		local olddamage_serial =3D input:PopNetUint32()
-		local olddamage_amount =3D input:PopNetUint8()
---		printf(&quot;NET: Generic_SubCommand_OldDamage: mobile-serial: 0x%08x Damag=
e_Amount: %i\n&quot;,olddamage_serial,olddamage_amount)
-		if (olddamage_serial =3D=3D gPlayerBodySerial) then
-			GuiAddChatLine(sprintf(&quot;%s&quot;,olddamage_amount)..&quot; Damage received&quot;)
-		else
-			GuiAddChatLine(sprintf(&quot;%s&quot;,olddamage_amount)..&quot; Damage done&quot;)
-		end
-		=

-		-- show fading damage over the mobile
-		-- TODO totally untested
-		gCurrentRenderer:NotifyDamage(olddamage_serial,olddamage_amount)
-	end
-
-	--Speed Mode: 0x0 =3D Normal movement, 0x1 =3D Fast movement, 0x2 =3D Slo=
w movement, 0x3 and above =3D Hybrid movement
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_SpeedMode) then -- 0x26
-		local speedboost =3D input:PopNetUint8()	--0/1 On/Off
-		--printf(&quot;NET: Speed Mode	Speedboost: %i\n&quot;,speedboost)
-	end
-	=

-	--nerw Race/Gender packet (since Elfes) Lenght (7bytes)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_NewRaceGender) then -- 0x2a
-		local player_gender =3D input:PopNetUint8()
-		local player_race =3D input:PopNetUint8()
---		printf(&quot;NET: Gender: %s Race: %s\n&quot;, gGender[player_gender], gRace[pla=
yer_race])
-	end
-	=

-	-- iris info request, only sent by iris aware servers
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_IrisInfo) then
-		Send_IrisInfo()
-	end
-
-	-- check if all data was used
-	local used =3D input:GetTotalPopped() - popped_start
-	local rest =3D size - used
-	if (rest &lt; 0) then
-		printf(&quot;FATAL ! kPacket_Generic_Command : subcmd 0x%02x (used=3D%d size=
=3D%d) popped too much\n&quot;,subcmd,used,size)
-		print(&quot;FATAL ! kPacket_Generic_Command -&gt; forced Crash&quot;)
-		Crash()
-	end
-	if (rest &gt; 0) then
-		printf(&quot;WARNING ! kPacket_Generic_Command : subcmd 0x%02x (used=3D%d siz=
e=3D%d) popped to few\n&quot;,subcmd,used,size)
-		input:PopRaw(rest)
-	end
-end
-
-
--- sends iris specific infos to the server, in response to kPacket_Generic=
_SubCommand_IrisInfo
-function Send_IrisInfo()
-	print(&quot;Send_IrisInfo&quot;)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(0x06)
-	out:PushNetUint16(kPacket_Generic_SubCommand_IrisInfo) -- 0x00A0
-	out:PushNetUint8(0x01)
-	out:SendPacket()
-end
+
+
 =

 -- answered by kPacket_Change_Update_Range from server
 function Send_UpdateRangeRequest(range)	-- 0xC8
@@ -532,31 +69,6 @@
 end
 =

 =

-
--- request profile 0xB8
-function Send_RequestCharacterProfile()
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Character_Profile)
-	out:PushNetUint16(8)
-	out:PushNetUint8(0)
-	out:PushNetUint32(GetPlayerSerial())
-	out:SendPacket()
-end
-
-
--- servers answer to Send_RequestCharacterProfile() 0xB8
-function gPacketHandler.kPacket_Character_Profile () -- 0xB8
-	local input =3D GetRecvFIFO()
-	local id		=3D input:PopNetUint8()
-	local size		=3D input:PopNetUint16()
-	local data =3D {}
-	data.serial	=3D input:PopNetUint32()
-	data.title,size =3D FIFO_PopZeroTerminatedString(input,size)
-	data.pstatic_plaintext,data.pstatic_unicodebytearr,size =3D FIFO_PopZeroT=
erminatedUnicode(input,size) -- static profile (can't be edited)
-	data.p_plaintext,data.p_unicodebytearr,size =3D FIFO_PopZeroTerminatedUni=
code(input,size) -- profile (can be edited)
-	print(&quot;kPacket_Character_Profile : todo:nice gump&quot;)
-	GuiAddChatLine (&quot;Character Profile:&quot;..data.title..&quot;,&quot;..data.pstatic_plain=
text..&quot;,&quot;..data.p_plaintext)
-end
 =

 =

 --[[
@@ -591,297 +103,6 @@
 								map_serial, map_cmd, map_plot_state, map_plot_x, map_plot_y) )
 end
 =

--- Text (Speech) receive 0x1C
--- Pol use thi spacket to send names when you single click on items or NPC=
s. OSI's method uses 0xC1
--- TODO : handle System messages
-function gPacketHandler.kPacket_Text ()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local mobile_serial =3D input:PopNetUint32()
-	local text_item_model =3D input:PopNetUint16() -- model ? artid ?
-	local text_type =3D input:PopNetUint8()
-	local text_color =3D input:PopNetUint16()
-	local text_font =3D input:PopNetUint16()
-	local text_charname =3D input:PopFilledString(30)
-	local text_message =3D input:PopFilledString(size-44)
-	=

-	Mobile_NameHint(mobile_serial,text_item_model,text_charname,text_message)
-
-	-- check if System Message
-	if (mobile_serial =3D=3D hex2num(&quot;0xffffffff&quot;) and text_item_model =3D=3D=
 hex2num(&quot;0xffff&quot;)) then
-		printdebug(&quot;net&quot;,sprintf(&quot;NET: System Message %s:%s\n&quot;,text_charname,tex=
t_message) )
-	end
-
-	printdebug(&quot;net&quot;,sprintf(&quot;NET: Text id: 0x%08x model id: 0x%08x Message: =
%s\n&quot;,mobile_serial,text_item_model,text_message) )
-	local plaintext =3D string.gsub(text_message,&quot;&lt;br&gt;&quot;,&quot;\n&quot;)
-	plaintext =3D UnicodeFix(plaintext)
-	GuiAddChatLine(sprintf(&quot;%s: %s&quot;,text_charname,plaintext)) -- TODO : color=
,font,...
-	JournalAddText(text_charname,plaintext)
-	NotifyListener(&quot;Hook_Text&quot;,text_charname,plaintext)
-	=

-	-- check if player -&gt; then show text over player head
-	local mobilespeaker=3DGetMobile(mobile_serial)
-	if (mobilespeaker) then mobilespeaker:NoZombie() mobilespeaker:DisplayTex=
tOverHead(string.gsub(text_message,&quot;&lt;br&gt;&quot;,&quot;\n&quot;),Uo16Color2Rgb(text_color)) =
end
-	-- TODO : text_item ?!?
-	NotifyListener(&quot;Hook_Packet_Text&quot;,mobile_serial,plaintext)
-	NotifyListener(&quot;Hook_MobName&quot;,mobile_serial,text_charname)
-end
-
-
--- server requests text entry 0xC2, e.g. rename rune
-function gPacketHandler.kPacket_Unicode_Text_Entry ()
-	local input =3D GetRecvFIFO()
-	local id	=3D input:PopNetUint8()	-- 1
-	local size	=3D input:PopNetUint16()	-- 2
-	local data =3D {}
-	data.player_serial		=3D input:PopNetUint32()
-	data.message_id			=3D input:PopNetUint32()
-	gUnicodeTextEntryRequest =3D data
-	size =3D size - 11
-	input:PopRaw(size) -- 10 zero-bytes usually
-	print(&quot;kPacket_Unicode_Text_Entry request&quot;)
-end
-
-
--- 0xC2, like the request, see above
--- TODO : real unicode support
-function Send_Unicode_Text_Entry (text)
-	local out =3D GetSendFIFO()
-	local textlen =3D string.len(text)
-	local unicode_bytelen =3D textlen*2
-	local size =3D 1 + 2 + 4 + 4 + 4 + 3 + unicode_bytelen + 1
-	out:PushNetUint8(kPacket_Unicode_Text_Entry)
-	out:PushNetUint16(size)
-	out:PushNetUint32(gUnicodeTextEntryRequest.player_serial)
-	out:PushNetUint32(gUnicodeTextEntryRequest.message_id)
-	out:PushNetUint32(1)
-	out:PushFilledString(gLanguage or &quot;ENU&quot;,3)
-	for i =3D 1 , textlen do
-		out:PushNetUint16(string.byte(text,i))
-	end
-	out:PushNetUint8(0) -- zero termination ??
-	gUnicodeTextEntryRequest =3D nil -- clear request
-	print(&quot;Send_Unicode_Text_Entry&quot;,text)
-	out:SendPacket()
-end
-
-
--- response =3D 0x9a as well
-function gPacketHandler.kPacket_Text_Entry () -- 0x9a =

-	local input =3D GetRecvFIFO()
-	local id	=3D input:PopNetUint8()	-- 1
-	local size	=3D input:PopNetUint16()	-- 2
-	local data =3D {}
-	data.player_serial		=3D input:PopNetUint32() -- pol:objectID
-	data.message_id			=3D input:PopNetUint32() -- pol:prompt#
-	data.reply				=3D input:PopNetUint32() -- pol:0=3Drequest/esc, 1=3Dreply
-	gPlaintextTextEntryRequest =3D data
-	size =3D size - 15
-	input:PopRaw(size) -- 10 zero-bytes usually
-end
-
-
-function Send_Plain_Text_Entry (text) =

-	local out =3D GetSendFIFO()
-	local textlen =3D string.len(text)
-	local size =3D 1 + 2 + 4 + 4 + 4 + textlen + 1
-	out:PushNetUint8(kPacket_Text_Entry)
-	out:PushNetUint16(size)
-	out:PushNetUint32(gPlaintextTextEntryRequest.player_serial)
-	out:PushNetUint32(gPlaintextTextEntryRequest.message_id)
-	out:PushNetUint32(1)
-	out:PushFilledString(text,textlen)
-	out:PushNetUint8(0) -- zero termination
-	gPlaintextTextEntryRequest =3D nil -- clear request
-	print(&quot;Send_Plain_Text_Entry&quot;,text)
-	out:SendPacket()
-end
-
--- aka Cliloc Message Affix  : see also <A HREF="http://docs.polserver.com/packets/=">http://docs.polserver.com/packets/=</A>
index.php?Packet=3D0xCC
--- e.g. skilltrainer npc says how much gold he wants
-function gPacketHandler.kPacket_Localized_Text_Plus_String () -- 0xCC
-	local input =3D GetRecvFIFO()
-	local id				=3D input:PopNetUint8()	-- 1
-	local size				=3D input:PopNetUint16()	-- 2
-	local data =3D {}
-	data.speaker_serial		=3D input:PopNetUint32()	-- 4 (0xffff for system mes=
sage)
-	data.speaker_body		=3D input:PopNetUint16()	-- 2 (0xff for system message)
-	data.speaker_align		=3D input:PopNetUint8()	-- 1 type (6 - lower left, 7 =
on player)
-	data.hue				=3D input:PopNetUint16()	-- 2
-	data.font				=3D input:PopNetUint16()	-- 2
-	data.cliloc_id			=3D input:PopNetUint32()	-- 4
-	data.flags				=3D input:PopNetUint8() 	-- 1
-	data.speaker_name		=3D input:PopFilledString(30)	=

-	size =3D size - 49
-	=

-	local mobile =3D GetMobile(data.speaker_serial) if (mobile) then mobile:N=
oZombie() end
-	-- flags : (0x02 is unknown, 0x04 signals the message doesn't move on scr=
een) =

-	=

-	=

-	local affixlen =3D size
-	for i =3D 0,size-1 do if (input:PeekNetUint8(i) =3D=3D 0) then affixlen =
=3D i + 1 break end end -- search zero terminator
-	=

-	data.affixlen		=3D affixlen	=

-	data.text_affix		=3D input:PopFilledString(affixlen) --  null terminated	=

-	size =3D size - affixlen
-	data.paramlen		=3D size	=

-	=

-	--~ BYTE[?]*2] arguments; // _big-endian_ unicode string, tabs ('\t') sep=
erate arguments, see 0xC1 for argument example
-	data.text_params	=3D (size &gt;=3D 2) and input:PopUnicodeString(size / 2) o=
r &quot;&quot;
-	data.text_base 		=3D gClilocLoader and gClilocLoader:Get(data.cliloc_id) =
or (&quot;unknown_cliloc_&quot;..data.cliloc_id)
-	data.plaintext 		=3D ParameterizedClilocText(data.cliloc_id,strsplit(&quot;\t&quot;=
,data.text_params))
-	=

-	if (TestBit(data.flags,0x01)) then
-		data.plaintext =3D data.text_affix .. data.plaintext  -- prepend
-	else =

-		data.plaintext =3D data.plaintext .. data.text_affix  -- appended
-	end
-	=

-	-- todo : this is a hack to get unicode somewhat readable, no real unicod=
e support
-	data.plaintext =3D UnicodeFix(data.plaintext)
-	=

-	-- output
-	=

-	local name =3D data.speaker_name
-	local plaintext =3D data.plaintext
-	=

-	if string.len(name) &gt; 0 then =

-		GuiAddChatLine(sprintf(&quot;%s: %s&quot;,name,plaintext)) -- TODO : color,font,...
-	else
-		GuiAddChatLine(plaintext) -- TODO : color,font,...
-	end
-	JournalAddText(name,plaintext)
-	NotifyListener(&quot;Hook_Text&quot;,name,plaintext)
-	NotifyListener(&quot;Hook_MobName&quot;,data.speaker_serial,name)
-	=

-	--~ print(&quot;kPacket_Localized_Text_Plus_String&quot;)
-	--~ for k,v in pairs(data) do print(&quot;++&quot;,k,v) end
-end
-
-
--- Predefined Message (localized Message) 0xC1
-function gPacketHandler.kPacket_Localized_Text ()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local text_item_serial =3D input:PopNetUint32() -- (0xffffffff for system=
 message)
-	local text_item_model =3D input:PopNetUint16() -- (0xffff for system mess=
age)
-	local text_type =3D input:PopNetUint8() -- see &quot;Text types&quot; in lib.uoids.=
lua
-	local text_color =3D input:PopNetUint16()
-	local text_font =3D input:PopNetUint16()
-	local text_messagenum =3D input:PopNetUint32()
-	local text_charname =3D input:PopFilledString(30)
-	local text_params =3D input:PopUnicodeLEString((size - 48 - 2)/2)	--littl=
e-endian_ unicode string, tabs ('\t') seperate the arguments. Null Terminat=
ed 0x0000
-	local text_terminator =3D input:PopNetUint16() -- probably the seperator =
unicode char for text_params, &quot;\t&quot; is hardcoded below, string.char(math.flo=
or(terminator)/256)
-	=

-	local plaintext =3D string.gsub(ParameterizedClilocText(text_messagenum,s=
trsplit(&quot;\t&quot;,text_params)),&quot;&lt;br&gt;&quot;,&quot;\n&quot;)
-	--~ print(&quot;kPacket_Localized_Text&quot;,plaintext)
-	=

-	-- TODO : Display as TOOLTIP !
-	plaintext =3D UnicodeFix(plaintext)
-	=

-	local show_below =3D true	-- display as fadeline
-	local show_journal =3D true	-- display in journal
-	=

-	local mobile =3D GetMobile(text_item_serial) if (mobile) then mobile:NoZo=
mbie() end
-	=

-	if text_type =3D=3D kTextType_Label then	-- label
-		show_journal =3D false
-		if GetMobile(text_item_serial) then
-			Mobile_SetName(text_item_serial, text_charname, plaintext)
-			show_below =3D false
-		end
-	end
-	=

-	if show_below then
-		if string.len(text_charname) &gt; 0 then =

-			GuiAddChatLine(sprintf(&quot;%s: %s&quot;,text_charname,plaintext)) -- TODO : col=
or,font,...
-		else
-			GuiAddChatLine(plaintext) -- TODO : color,font,...
-		end
-	end
-	=

-	if show_journal then
-		JournalAddText(text_charname,plaintext)
-	end
-	=

-	NotifyListener(&quot;Hook_Text&quot;,text_charname,plaintext)
-	NotifyListener(&quot;Hook_Packet_Localized_Text&quot;,text_item_serial,plaintext,te=
xt_messagenum,text_type)
-	NotifyListener(&quot;Hook_MobName&quot;,text_item_serial,plaintext,text_messagenum)
-	=

-	-- print(&quot;###&quot;,text_item_serial,text_item_model,text_type,text_color,text=
_charname,text_params,text_terminator)
-end
-
---server response packet for kPacket_Speech_Unicode (0xAD)
-function gPacketHandler.kPacket_Text_Unicode()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local unitext_size =3D input:PopNetUint16()
-	local mobile_serial =3D input:PopNetUint32()
-	local unitext_item_model =3D input:PopNetUint16()
-	local unitext_type =3D input:PopNetUint8()
-	local unitext_hue =3D input:PopNetUint16()	=

-	local unitext_font =3D input:PopNetUint16()
-	local unitext_lang =3D input:PopNetUint32()
-	local unitext_name =3D input:PopFilledString(30)
-	local unitext_message,unitext_message_unicode_charcodes =3D UniCodeDualPo=
p(input,(unitext_size-48)/2)
-
-	local show_below =3D true	-- display as fadeline
-	local show_journal =3D true	-- display in journal
-	=

-	unitext_message =3D UnicodeFix(unitext_message)
-
-	local r,g,b =3D 1,1,1
-	=

-	=

-	if unitext_type =3D=3D kTextType_Normal then r,g,b =3D 1,1,1 end
-	if unitext_type =3D=3D kTextType_System then r,g,b =3D 0,0,1 end
-	if unitext_type =3D=3D kTextType_Emote then r,g,b =3D 0,1,0 end
-	if unitext_type =3D=3D kTextType_Label then =

-		show_journal =3D false =

-		if GetMobile(mobile_serial) then
-			show_below =3D false =

-			Mobile_NameHint(mobile_serial,unitext_item_model,unitext_name,unitext_m=
essage)
-			r,g,b =3D 1,1,1 =

-		end
-	end	-- 0x06 - System/Lower Corner, label?
-	if unitext_type =3D=3D kTextType_Corner			 	 then r,g,b =3D 1,0,0 end	=

-	if unitext_type =3D=3D kTextType_Whisper			 then r,g,b =3D 1,1,1 end	=

-	if unitext_type =3D=3D kTextType_Yell				 then r,g,b =3D 1,1,1 end	=

-	if unitext_type =3D=3D kTextType_Spell				 then r,g,b =3D 0,1,1 end	=

-	if unitext_type =3D=3D kTextType_Guild				 then r,g,b =3D 0,1,0 end	 =

-	if unitext_type =3D=3D kTextType_Alliance			 then r,g,b =3D 0,1,0 end	=

-	if unitext_type =3D=3D kTextType_CommandPrompt		 then r,g,b =3D 1,0,1 end=
		=

-	=

-	if unitext_hue then r,g,b =3D Uo16Color2Rgb(unitext_hue) end
-	=

-	-- brighten up the color
-	local h,s,v =3D ColorRGB2HSV(r,g,b)
-	v =3D math.min(1,v + gFontDefs[&quot;Chat&quot;].brigth)
-	s =3D math.max(0,s - gFontDefs[&quot;Chat&quot;].brigth/2)
-	r,g,b =3D ColorHSV2RGB(h,s,v)
-	=

-	printdebug(&quot;net&quot;,sprintf(&quot;NET: UnicodeText speakerid: %i name: %s txtsize=
:<i> %i msg: %s\n&quot;,mobile_serial,unitext_name,(unitext_size-48)/2,unitext_mess=
</I>age) )
-
-	if show_below then =

-		GuiAddChatLine(unitext_name..&quot;: &quot;..string.gsub(unitext_message,&quot;&lt;br&gt;&quot;,&quot;\=
n&quot;),{r,g,b,1}) -- TODO : unicode
-	end
-	if show_journal then
-		JournalAddText(unitext_name,unitext_message)
-	end
-	=

-	NotifyListener(&quot;Hook_Text&quot;,unitext_name,unitext_message)
-	=

-	NotifyListener(&quot;Hook_Packet_Text_Unicode&quot;,mobile_serial,unitext_message,u=
nitext_type)
-	NotifyListener(&quot;Hook_MobName&quot;,mobile_serial,unitext_name)
-
-	-- check if player -&gt; then show text over player head
-	local mobilespeaker=3DGetMobile(mobile_serial)
-	if (mobilespeaker) then mobilespeaker:NoZombie() end
-	if (mobilespeaker and show_below) then mobilespeaker:DisplayTextOverHead(=
string.gsub(unitext_message,&quot;&lt;br&gt;&quot;,&quot;\n&quot;),Uo16Color2Rgb(unitext_hue)) end
-end
-
 -- TODO : question : ghoulsblade : is this only for combat ? sience: don't=
 know -&gt; verify
 -- currently we use this for the warmode target system
 -- Target current Mobile
@@ -919,86 +140,6 @@
 	printf(&quot;NET: (ignored): kPacket_Server_Change: &quot;..vardump2(serverchange).=
.&quot;\n&quot;)
 end
 =

---TODO : implement switches
---[[
-Generic Gump Choice
-______________________________________
-BYTE[1]	ID (B1)
-BYTE[2]	-Packet Size
-BYTE[4]	-Gump Serial		--?? gumpserial (first Id in 0xb0)  (mislabled as pl=
ayerserial sometimes...)
-BYTE[4]	-Gump ID			--?? gumptypeid (second Id in 0xb0)
-BYTE[4]	-Button ID			--which button pressed or 0 if closed
-BYTE[4]	-Switches Count		--(response info for radio buttons and checkboxes=
, any switches listed here are switched on)
-
-loop	-Switch
-BYTE[4]	-Switch ID
-endloop -Switch
-
-BYTE[4]	-Text Entry Count	--response info for textentries
-
-loop	-Text Entry
-BYTE[2]	-Text Entry ID
-BYTE[2]	-Text Entry Length
-BYTE[length*2] Unicode text (not nullterminated)
-endloop	-Text Entry
-
-BYTE[4]	-Switches Count (Only if Gump ID =3D 461)
-BYTE[4]	-Beheld Serial (Only if (Gump ID =3D 461 &amp;&amp; Button ID =3D 1 &amp;&amp; Swi=
tches Count &gt; 0))
-]]--
-
---table: switches: 10940BA0 returnmessage: 108
-
---TODO : readout checkboxes,radiobuttons and edit text fields
-function GumpReturnMsg(playerserial, gumptypeid, ret_value, params, switch=
count, textcount)	-- len 0x17
-	local packetlen =3D 23	--(1 + 2 + 4*5) size for empty params
-	if (params) then
-		packetlen =3D packetlen + 4 * table.getn(params.switches)
-		for k,v in pairs(params.texts) do =

-			packetlen =3D packetlen + 2 + 2 + 2*string.len(v.text) -- 2*stringsize =
because of unicode
-		end
-	end
-
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Gump_Trigger) -- 0xB1
-	out:PushNetUint16(packetlen)
-	out:PushNetUint32(playerserial)
-	out:PushNetUint32(gumptypeid)
-	out:PushNetUint32(ret_value)
-	=

-	--print(&quot;GumpReturnMsg player,gump,retval:&quot;,playerserial,gumptypeid,ret_v=
alue)
-	--~ printf(&quot;###### 0xB1 0x%04x 0x%08x 0x%08x 0x%08x\n&quot;,packetlen,playerse=
rial,gumptypeid,ret_value)
-	--~ 0000   B1 00 0F 00 0D BA 5B 00  00 01 CD 00 00 00 70      ......[....=
...p   -- virtue request (valor, 70 =3D gumpid of image)
-	=

-	if (params) then
-		--~ print(&quot;param&quot;,params)
-		out:PushNetUint32(table.getn(params.switches))	--switchcount
-		for k,v in pairs(params.switches) do =

-			out:PushNetUint32(v) =

-			--print(&quot;GumpReturnMsg switch:&quot;,v) =

-		end
-		=

-		out:PushNetUint32(table.getn(params.texts))	--textcount
-		for k,v in pairs(params.texts) do =

-			local len =3D string.len(v.text)
-			out:PushNetUint16(v.id) =

-			out:PushNetUint16(len) =

-			out:PushFilledUnicodeString(v.text,len)
-			--print(&quot;GumpReturnMsg text:&quot;,v.id,len,v.text)
-		end
-	else
-		--~ print(&quot;noparam&quot;,switchcount,textcount)
-		if (switchcount and textcount) then
-			out:PushNetUint32(switchcount)	--switchcount
-			out:PushNetUint32(textcount)	--textcount
-		else
-			out:PushNetUint32(0)	--switchcount
-			out:PushNetUint32(0)	--textcount
-		end
-	end
-
-	out:SendPacket()
-end
-
 -- send combat request to server, triggers kPacket_SetPlayerWarmode
 function Send_CombatMode(iWarMode)
 	local out =3D GetSendFIFO()
@@ -1018,134 +159,6 @@
 	printdebug(&quot;net&quot;, sprintf(&quot;NET: Attack -&gt; serial=3D0x%08x\n&quot;,mobile_seria=
l) )
 end
 =

--- Generic Gump
-function gPacketHandler.kPacket_Generic_Gump ()	--0xB0
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local newgump =3D {}
-	newgump.playerid =3D input:PopNetUint32()
-	newgump.dialogId =3D input:PopNetUint32()
-	newgump.x =3D input:PopNetUint32()
-	newgump.y =3D input:PopNetUint32()
-	newgump.Length_Data =3D input:PopNetUint16() -- TODO : special case if th=
is is 0xffff ?
-	=

-	if (1 + 2 + 4*4 + 2 + newgump.Length_Data &gt; size) then =

-		printf(&quot;NET: broken kPacket_Generic_Gump packet, gumplen =3D 0x%08x\n&quot;,n=
ewgump.Length_Data)
-		print(&quot;FATAL ! kPacket_Generic_Gump -&gt; forced Crash&quot;)
-		Crash()
-	end
-	=

-	newgump.Data =3D input:PopFilledString(newgump.Length_Data) -- includes z=
ero terminator
-	newgump.numTextLines =3D input:PopNetUint16()
-
-	for k,v in pairs(newgump) do printdebug(&quot;gump&quot;,sprintf(&quot;newgump.%s =3D &quot;,=
k),v) end
-	=

-	local textlen =3D 0
-	newgump.textline =3D {}
-	newgump.textline_unicode =3D {}
-	--Index 0 because Serverside Gump Commands use this Index as textline ref=
erences
-	for i =3D 0,newgump.numTextLines-1 do
-		textlen =3D input:PopNetUint16() -- =3D number_of_unicode_chars
-		printdebug(&quot;gump&quot;,&quot;reading text line &quot;,i,&quot; with length &quot;,textlen)
-		newgump.textline[i],newgump.textline_unicode[i] =3D UniCodeDualPop(input=
,textlen)
-		printdebug(&quot;gump&quot;,sprintf(&quot;newgump.textline[%d](len=3D%d)=3D\n&quot;,i,textle=
n),newgump.textline[i])
-	end
-
-	local dialog =3D GumpParser(newgump)
-	NotifyListener(&quot;Hook_OpenServersideGump&quot;,dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data)	=

-end
-
-function UniCodeDualPop (fifo,number_of_unicode_chars)
-	--~ return input:PopUnicodeString(textlen) -- old, only asci part , TODO =
:<i> see also PopUnicodeLEString
</I>-	local ascipart =3D &quot;&quot;
-	local unicode_charcodes =3D {}
-	for i =3D 1,number_of_unicode_chars do
-		local head =3D fifo:PopUint8()
-		local data =3D fifo:PopUint8()
-		if (head ~=3D 0) then
-			ascipart =3D ascipart .. &quot;?&quot; .. (data ~=3D 0 and string.format(&quot;%c&quot;,dat=
a) or &quot;&quot;)
-		else
-			ascipart =3D ascipart .. string.format(&quot;%c&quot;,data)
-		end
-		table.insert(unicode_charcodes,head*256 + data)
-	end
-	return ascipart,unicode_charcodes
-end
-
-
--- compressed Gump
-function gPacketHandler.kPacket_Compressed_Gump ()	--0xDD
-	local input =3D GetRecvFIFO()
-	local popped_start =3D input:GetTotalPopped()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local newgump =3D {}
-
-	newgump.playerid =3D input:PopNetUint32()
-	newgump.dialogId =3D input:PopNetUint32()
-	newgump.x =3D input:PopNetUint32()
-	newgump.y =3D input:PopNetUint32()
-
-	newgump.Length_CompressedData =3D input:PopNetUint32() - 4
-	newgump.Length_Data =3D input:PopNetUint32()
-
-	printdebug(&quot;net&quot;,sprintf(&quot;NET: Length_CompressedData=3D%d Length_Uncompre=
ssedData=3D%d\n&quot;,newgump.Length_CompressedData,newgump.Length_Data))
-
-	if (28 + newgump.Length_CompressedData &gt; size) then =

-		printf(&quot;NET: BROKEN - kPacket_Compressed_Gump packet, compressed gumplen=
 =3D 0x%08x\n&quot;,newgump.Length_CompressedData)
-		print(&quot;Error: Server Sends bad Compressed Gumpdata ! Please report.&quot;)
-		print(&quot;FATAL ! kPacket_Compressed_Gump -&gt; forced Crash&quot;)
-		Crash()
-	end
-
-	--- Data Part ---
-	local decompressed =3D CreateFIFO()
-	-- pop and decompress data into decompress fifo
-	input:PeekDecompressIntoFifo(newgump.Length_CompressedData,newgump.Length=
_Data,decompressed)
-	-- skip compressed part (peeked)
-	input:PopRaw(newgump.Length_CompressedData)
-	newgump.Data =3D decompressed:PopFilledString(decompressed:Size())
-	-- and clear the decompress fifo for later usage
-	decompressed:Clear()
-	=

-	-- WARNING  strange -4 on compression ahead (see runuo2 source)
-	--- Textlines Part ---
-	newgump.numTextLines =3D input:PopNetUint32()
-
-	if (newgump.numTextLines ~=3D 0) then
-		newgump.Length_CompressedTextLines =3D input:PopNetUint32() - 4
-		newgump.Length_TextLines =3D input:PopNetUint32()
-	=

-		-- pop and decompress data into decompress fifo
-		input:PeekDecompressIntoFifo(newgump.Length_CompressedTextLines,newgump.=
Length_TextLines,decompressed)
-		-- skip compressed part (peeked)
-		input:PopRaw(newgump.Length_CompressedTextLines)
-		=

-		-- print gumpdata
-		for k,v in pairs(newgump) do printdebug(&quot;gump&quot;,sprintf(&quot;newgump.%s =3D &quot;=
,k),v) end
-		=

-		local textlen =3D 0
-		newgump.textline =3D {}
-		newgump.textline_unicode =3D {}
-		--Index 0 because Serverside Gump Commands use this Index as textline re=
ferences
-		for i =3D 0,newgump.numTextLines-1 do
-			textlen =3D decompressed:PopNetUint16()
-			printdebug(&quot;gump&quot;,&quot;reading text line &quot;,i,&quot; with length &quot;,textlen)
-			newgump.textline[i],newgump.textline_unicode[i] =3D UniCodeDualPop(deco=
mpressed,textlen)
-			printdebug(&quot;gump&quot;,sprintf(&quot;newgump.textline[%d](len=3D%d)=3D\n&quot;,i,textl=
en),newgump.textline[i])
-		end
-	end
-
-	decompressed:Destroy()
-
-	if ( (input:Size() &gt;=3D 4) and (input:GetTotalPopped()-popped_start &lt; siz=
e) ) then
-		local unknownterminator=3Dinput:PopNetUint32()
-	end
-
-	local dialog =3D (not gNoRender) and GumpParser(newgump)
-	NotifyListener(&quot;Hook_OpenServersideGump&quot;,dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data,true)	=

-end
 =

 =

 -- rename a mobile
@@ -1216,120 +229,3 @@
 ]]--
 end
 =

--- TODO : at first check speech.mul keywords and send them to server
-function Send_Speech(speech)
-	if not speech then print(&quot;unknown speech=3D&quot;,speech) return end
-	local speechlen =3D string.len(speech)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Speech)
-	out:PushNetUint16(speechlen+8+1)
-	out:PushNetUint8(0)
-	out:PushNetUint16(10)
-	out:PushNetUint16(3)
-	out:PushFilledString(speech, speechlen)
-	out:PushNetUint8(0)			-- add a Null-Terminator to sendstring
-	out:SendPacket()
-	printf(&quot;NET: Send_Speech : speech=3D%s\n&quot;,speech)
-end
-
--- kPacket_Speech_Unicode 0xAD
--- see runuo1 sourcecode ./Network/PacketHandlers.cs:1176: UnicodeSpeech  =
  for details of encoding/decoding
--- see also lib.speech.lua for  SpeechParseKeywords
-function Send_UnicodeSpeech (ascistr, mode, huecolor, font)	-- (0xAD)
-	--print(&quot;Send_UnicodeSpeech&quot;,gSpeechLoader,ascistr, mode, huecolor, font)
-	if not ascistr then print(&quot;Send_UnicodeSpeech:missing text&quot;) return end
-	=

-	local ascilen		=3D string.len(ascistr)
-	local keywords		=3D SpeechParseKeywords(ascistr)
-	local keywordcount	=3D table.getn(keywords)
-	local bEncoded		=3D keywordcount &gt; 0
-	if (gNoSpeechKeyWords) then bEncoded =3D false end -- pre aos pol shards =
? (cloudstrive/zulu)
-	local hue			=3D hex2num(&quot;0x34&quot;)
-	local font			=3D 0 -- ignored by runuo 1
-	local msgtype		=3D kTextType_Normal + (bEncoded and kTextType_Encoded or =
0)
-	local packetlen		=3D 1+2+1+2+2+4+ (bEncoded and (2+0+ascilen+1) or (ascil=
en*2+2))
-	for i =3D 0,keywordcount-1 do packetlen =3D packetlen + ((math.mod(i,2) =
=3D=3D 0) and 1 or 2) end -- calc packetlength for encoding
-	=

-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Speech_Unicode)
-	out:PushNetUint16(packetlen)
-	out:PushNetUint8(msgtype)
-	out:PushNetUint16(hue)
-	out:PushNetUint16(font)
-	out:PushFilledString(gLanguage or &quot;ENU&quot;, 4)
-	=

-	if (bEncoded) then
-		local count	=3D keywordcount -- should be in [0,50]
-		local hold	=3D BitwiseAND(BitwiseSHR(keywords[1],8),hex2num(&quot;0xf&quot;)) -- s=
hould be in [0,0xF]
-		local value	=3D BitwiseSHL(keywordcount,4) + hold
-		out:PushNetUint16(value)
-		for i =3D 0,keywordcount-1 do
-			if (math.mod(i,2) =3D=3D 0) then
-				out:PushNetUint8(BitwiseAND(keywords[i+1],hex2num(&quot;0xff&quot;)))
-			else
-				local hold	=3D BitwiseAND(BitwiseSHR(keywords[i+2] or 0,8),hex2num(&quot;0x=
f&quot;)) -- should be in [0,0xF]
-				local value	=3D BitwiseSHL(keywords[i+1],4) + hold
-				out:PushNetUint16(value)
-			end
-		end
-		out:PushFilledString(ascistr, ascilen)  -- utf8
-		out:PushNetUint8(0) -- zero terminate
-	else =

-		print(&quot;#sendchat,plain&quot;,gLanguage)
-		out:PushFilledUnicodeString(ascistr, ascilen) -- unicode, 16 bit per let=
ter
-		out:PushNetUint16(0) -- zero terminate
-	end
-	=

-	out:SendPacket()
-end =

-
-
---[[
-Packet ID: 0xAD
-Packet Name: Unicode/Ascii speech request
-
-BYTE[1] cmd
-BYTE[2] length
-BYTE[1] Type
-BYTE[2] Color
-BYTE[2] Font
-BYTE[4] Language (Null Terminated)
-=C2=B7 =C2=93enu=C2=93 - United States English
-=C2=B7 =C2=93des=C2=94 - German Swiss
-=C2=B7 =C2=93dea=C2=94 - German Austria
-=C2=B7 =C2=93deu=C2=94 - German Germany
-=C2=B7 ... for a complete list see langcode.iff
-
-if (Type &amp; 0xc0)
-=C2=B7 BYTE[1,5] Number of distinct Trigger words (NUMWORDS). 12 Bit numbe=
r, Byte #13 =3D Bit 11=C2=854 of NUMWORDS, Hi-Nibble of Byte #14 (Bit 7=C2=
=854) =3D Bit 0=C2=853 of NUMWORDS
-=C2=B7 BYTE[1,5] Index to speech.mul. 12 Bit number, Low Nibble of Byte #1=
4 (Bits 3=C2=850) =3D Bits 11..8 of Index, Byte #15 =3D Bits 7=C2=850 of In=
dex
-=C2=B7 UNKNOWNS =3D ( (NUMWORDS div 2) *3 ) + (NUMWORDS % 2) =C2=96 1. div=
 =3D Integeger division, % =3D modulo operation, NUMWORDS &gt;=3D 1. examples:=
 UNKNOWNS(1)=3D0, UNKNOWNS(2)=3D2, UNKNOWNS(3)=3D3, UNKNOWNS(4)=3D5, UNKNOW=
NS(5)=3D6, UNKNOWNS(6)=3D8, UNKNOWNS(7)=3D9, UNKNOWNS(8)=3D11, UNKNOWNS(9)=
=3D12
-=C2=B7 BYTE[UNKNOWNS] Idea behind this is getting speech parsing load clie=
nt side.
-				 Thus this contains data OSI server use for easier parsing. It=C2=92s =
client side hardcoded and exact details are unkown.
-=C2=B7 BYTE[?] Ascii Msg =C2=96 Null Terminated(blockSize =C2=96 (15+UNKNO=
WNS) )
-
-else
-=C2=B7 BYTE[?][2] Unicode Msg - Null Terminated (blockSize - 12)
-
-Notes
-For pre 2.0.7 clients Type is always &lt; 0xc0. Uox based emus convert post 2=
.0.7 data of this packet to pre 2.0.7 data if Type &gt;=3D0xc0.
-
-(different view of it)
-If Mode&amp;0xc0 then there are keywords (from speech.mul) present.
-Keywords:
-The first 12 bits =3D the number of keywords present. The keywords are inc=
luded right after this, each one is 12 bits also.
-The keywords are padded to the closest byte. For example, if there are 2 k=
eywords, it will take up 5 bytes. 12bits for the number, and 12 bits for ea=
ch keyword. 12+12+12=3D36. Which will be padded 4 bits to 40 bits or 5 byte=
s.
-
-The various types of text is as follows:
-0x00 - Normal
-0x01 - Broadcast/System
-0x02 - Emote
-0x06 - System/Lower Corner
-0x07 - Message/Corner With Name
-0x08 - Whisper
-0x09 - Yell
-0x0A - Spell
-0x0D - Guild Chat
-0x0E - Alliance Chat
-0x0F - Command Prompts
-]]--

Modified: trunk/lua/widgets/widget.uoquickcasticon.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uoquickcasticon.lua (original)
+++ trunk/lua/widgets/widget.uoquickcasticon.lua Wed Oct 29 18:41:43 2008
@@ -55,6 +55,7 @@
 		dialog.on_mouse_left_click_double =3D function (widget) fun() end
 	end
 	=

+	dialog.debugname =3D sprintf(&quot;CreateQuickCastButton(%s,%s,%s,%s,%s)&quot;,tost=
ring(x),tostring(y),tostring(name),tostring(fun),tostring(gumpid))..tostrin=
g(GetStackTrace())
 	glQuickCastDialog[dialog] =3D true
 	dialog:BringToFront()
 	return dialog


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001471.html">[Iris-commit] [IRIS] r2667 - in /trunk: lua/lib.packetvideo.lua	videos/
</A></li>
	<LI>Next message: <A HREF="001473.html">[Iris-commit] [IRIS] r2669 - /trunk/lua/lib.loading.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1472">[ date ]</a>
              <a href="thread.html#1472">[ thread ]</a>
              <a href="subject.html#1472">[ subject ]</a>
              <a href="author.html#1472">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
