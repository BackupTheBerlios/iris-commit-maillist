<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r2502 - in /trunk/lua: lib.2d.effect.lua	lib.2d.renderer.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2008-October/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2502%20-%20in%20/trunk/lua%3A%20lib.2d.effect.lua%0A%09lib.2d.renderer.lua&In-Reply-To=%3C20081003040014.84A181C18042%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001306.html">
   <LINK REL="Next"  HREF="001308.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r2502 - in /trunk/lua: lib.2d.effect.lua	lib.2d.renderer.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2502%20-%20in%20/trunk/lua%3A%20lib.2d.effect.lua%0A%09lib.2d.renderer.lua&In-Reply-To=%3C20081003040014.84A181C18042%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r2502 - in /trunk/lua: lib.2d.effect.lua	lib.2d.renderer.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Fri Oct  3 05:01:07 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001306.html">[Iris-commit] [IRIS] r2501 - /trunk/lua/lib.2d.dynamic.lua
</A></li>
        <LI>Next message: <A HREF="001308.html">[Iris-commit] [IRIS] r2503 - in /trunk/lua: lib.2d.cam.lua lib.2d.effect.lua lib.2d.hudfx.lua lib.2d.renderer.lua net/net.mobile.lua widgets/widget.uotext.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1307">[ date ]</a>
              <a href="thread.html#1307">[ thread ]</a>
              <a href="subject.html#1307">[ subject ]</a>
              <a href="author.html#1307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Fri Oct  3 05:01:04 2008
New Revision: 2502

Log:
effects moving with mobs

Modified:
    trunk/lua/lib.2d.effect.lua
    trunk/lua/lib.2d.renderer.lua

Modified: trunk/lua/lib.2d.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.effect.lua (original)
+++ trunk/lua/lib.2d.effect.lua Fri Oct  3 05:01:04 2008
@@ -73,31 +73,53 @@
 --~ Renderer2D:UpdateEffectGfx A    14186   {miUnknown3=3D0,miHue=3D0,miQu=
ality=3D14=3D0x0e,miAnimID=3D0,bBackGround=3Dfalse,iSortBonus2D=3D6,iCalcHe=
ight=3D0,miFlags=3D0x01000000,miWeight=3D-1,miQuantity=3D0,msName=3D&quot;sparkl=
e&quot;,bSurface=3Dfalse,miUnknown=3D0,miHeight=3D0,miUnknown1=3D0,bBridge=3Dfal=
se,miUnknown2=3D0,}
 --~ Renderer2D:UpdateEffectGfx B    1741    158     166     14186   table:=
 0xbb8b838        0
 =

+-- lightning =

+--~ Renderer2D:AddEffect    {explodes=3D0,rendermode=3D0,duration=3D0,targ=
et_locz=3D7,effect_type=3D1,current_locz=3D7,speed=3D0,current_locy=3D2437=
=3D0x0985,hue=3D0,
+	--huedeffect=3Dtrue,unkown=3D0,target_locx=3D1827=3D0x0723,current_locx=
=3D1827=3D0x0723,targetserial=3D0,
+		-- sourceserial=3D0x000dba5b,target_locy=3D2437=3D0x0985,itemid=3D0,fixe=
ddirection=3D0,}
+--~ Renderer2D:UpdateEffectGfx A    0       {miUnknown3=3D0,miHue=3D0,miQu=
ality=3D0,miAnimID=3D0,bBackGround=3Dfalse,
+	--iSortBonus2D=3D6,iCalcHeight=3D0,miFlags=3D0,miWeight=3D0,miQuantity=3D=
0,msName=3D&quot;MissingName&quot;,bSurface=3Dfalse,miUnknown=3D0,miHeight=3D0,
+		--miUnknown1=3D0,bBridge=3Dfalse,miUnknown2=3D0,}
+--~ Renderer2D:UpdateEffectGfx B    1827    2437    7       0       table:=
 0xb154fe8        0
+
 =

 k2DEffectTimeScale =3D 50
 =

 function Renderer2D:UpdateEffectGfx (effect,t) =

 	if (t &lt; effect.nextstept) then return end
 	local effectdata		=3D effect.effectdata
-	if (effectdata.duration &gt; 0 and effect.endt &gt; 0 and t &gt;=3D effect.endt) t=
hen self:DestroyEffect(effect) return end
-
+	if (t &gt;=3D effect.endt) then self:DestroyEffect(effect) return end
+
+	=

+	local mob_source =3D GetMobile(effectdata.sourceserial)
+	if mob_source then effectdata.current_locx,effectdata.current_locy,effect=
data.current_locz =3D mob_source.xloc,mob_source.yloc,mob_source.zloc end
+	local mob_target =3D GetMobile(effectdata.targetserial)
+	if mob_target then effectdata.target_locx,effectdata.target_locy,effectda=
ta.target_locz =3D mob_target.xloc,mob_target.yloc,mob_target.zloc end
 	=

 	local xloc,yloc,zloc	=3D effectdata.current_locx,effectdata.current_locy,=
effectdata.current_locz
 	local xloc2,yloc2,zloc2	=3D effectdata.target_locx,effectdata.target_locy=
,effectdata.target_locz
+	=

+	=

+	=

+	=

 	local iTileTypeID		=3D effectdata.itemid
 	local iHue				=3D effectdata.hue
-	local arttype =3D GetStaticTileType(iTileTypeID)
+	--~ local arttype =3D GetStaticTileType(iTileTypeID)
 	--~ print(&quot;Renderer2D:UpdateEffectGfx A&quot;,iTileTypeID,arttype and SmartDum=
p(arttype))
-	if (not arttype) then return end
+	--~ if (not arttype) then return end
 	--~ print(&quot;Renderer2D:UpdateEffectGfx B&quot;,xloc,yloc,zloc,effectdata.itemid=
,arttype,arttype and arttype.miAnimID)
 	--~ if (not arttype) then return end
 	--~ local iModelID		=3D arttype.miAnimID
+	=

+	if (iTileTypeID =3D=3D 0 and effectdata.effect_type =3D=3D kEffectType_Li=
ghtningStrikeAtSource) then
+		iTileTypeID =3D 0x3967 -- couldn't find out how lightning effect is supp=
osed to work, so we use paralyse field for now
+	end
 	=

 	local animinfo =3D GetAnimDataInfo(iTileTypeID)
 	local o =3D animinfo
 	local iTileTypeBaseID	=3D iTileTypeID
 	if (o) then =

-		local iFrameInterval =3D o.miFrameInterval * k2DEffectTimeScale -- orig =
is in 10ths of seconds
+		local iFrameInterval =3D o.miFrameInterval * k2DEffectTimeScale / (effec=
tdata.fastspeed or 1)-- orig is in 10ths of seconds
 		local iFrame =3D floor((t - effect.startt) / iFrameInterval),o.miCount
 		effect.nextstept =3D effect.startt + iFrameInterval * (iFrame + 1)
 		iFrame =3D iFrame % o.miCount
@@ -120,7 +142,7 @@
 	end
 	=

 	=

-	if (arttype.miAnimID =3D=3D 0) then
+	--~ if ((not arttype) or arttype.miAnimID =3D=3D 0) then
 		local tx,ty,tz,fIndexRel =3D 0,0,0,0
 		local sorttx =3D xloc-floor(xloc/8)*8
 		local sortty =3D yloc-floor(yloc/8)*8
@@ -140,7 +162,7 @@
 		end
 		=

 		spriteblock:SetPosition(x,y,z)
-	end
+	--~ end
 	=

 	=

 	=

@@ -178,6 +200,10 @@
 	if (effectdata.effect_type =3D=3D kEffectType_FromSourceToDest and effect=
data.duration =3D=3D 0) then
 		effectdata.duration =3D 10
 	end
+	if (effectdata.effect_type =3D=3D kEffectType_LightningStrikeAtSource and=
 effectdata.duration =3D=3D 0) then
+		effectdata.duration =3D 10
+		effectdata.fastspeed =3D 2
+	end
 	local dur =3D effectdata.duration * k2DEffectTimeScale
 	local effect =3D { startt=3Dt, endt=3Dt+dur, dur=3Ddur, nextstept=3D0, ef=
fectdata=3Deffectdata }
 	self.gEffectList[effect] =3D true

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Oct  3 05:01:04 2008
@@ -81,7 +81,6 @@
 function Renderer2D:MainStep ()
 	self:CamStep()
 	self:MobileAnimStep()
-	self:EffectAnimStep()
 	=

 	local uodir,pixeldist =3D Get2DMouseDirAndDist()
 	=

@@ -127,6 +126,7 @@
 		if (dx ~=3D 0 or dy ~=3D 0) then self:SetCamPos(xloc+dx,yloc+dy) end
 	end
 =

+	self:EffectAnimStep() -- should be after player pos is updated, for effec=
ts moving with player
 	self:MapStep()
 end
 =



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001306.html">[Iris-commit] [IRIS] r2501 - /trunk/lua/lib.2d.dynamic.lua
</A></li>
	<LI>Next message: <A HREF="001308.html">[Iris-commit] [IRIS] r2503 - in /trunk/lua: lib.2d.cam.lua lib.2d.effect.lua lib.2d.hudfx.lua lib.2d.renderer.lua net/net.mobile.lua widgets/widget.uotext.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1307">[ date ]</a>
              <a href="thread.html#1307">[ thread ]</a>
              <a href="subject.html#1307">[ subject ]</a>
              <a href="author.html#1307">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
