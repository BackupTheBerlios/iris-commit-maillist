From no-reply at zwischenwelt.org  Sat Nov  1 04:15:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 01 Nov 2008 03:15:59 -0000
Subject: [Iris-commit] [IRIS] r2679 - in /trunk/lua: lib.charcreate.lua
	lib.loading.lua
Message-ID: <20081101031559.6F3A91C18632@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov  1 04:15:58 2008
New Revision: 2679

Log:
small fixes for norender mode

Modified:
    trunk/lua/lib.charcreate.lua
    trunk/lua/lib.loading.lua

Modified: trunk/lua/lib.charcreate.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.charcreate.lua (original)
+++ trunk/lua/lib.charcreate.lua Sat Nov  1 04:15:58 2008
@@ -39,6 +39,7 @@
 function LoadProfInfo (filepath) =

 	local profinfo =3D {}
 	local lastinfo
+	if (filepath and file_exists(filepath)) then
 	for line in io.lines(filepath) do
 		line =3D TrimNewLines(line)
 		local tokens =3D strsplit("[\t]+",line)
@@ -52,6 +53,7 @@
 			elseif (tokens[2] =3D=3D "Stat")	then lastinfo.stats[trim(tokens[3])] =
=3D val
 			else lastinfo[trim(tokens[2])] =3D trim(tokens[3]) end
 		end
+	end
 	end
 	return profinfo
 end

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Sat Nov  1 04:15:58 2008
@@ -185,12 +185,12 @@
 end
 =

 function Load_Anim () =

-	LoadBodyDef(		CorrectPath( Addfilepath("Body.def") ))
-	LoadBodyConfDef(	CorrectPath( Addfilepath("Bodyconv.def") ))
-	LoadEquipConvDef(	CorrectPath( Addfilepath("Equipconv.def") ))
 	gAnimLoader =3D {}
 	if (gAnimLoaderType) then
 		LoadingProfile("init AnimLoader")
+		LoadBodyDef(		CorrectPath( Addfilepath("Body.def") ))
+		LoadBodyConfDef(	CorrectPath( Addfilepath("Bodyconv.def") ))
+		LoadEquipConvDef(	CorrectPath( Addfilepath("Equipconv.def") ))
 		-- old : gAnimFile,gAnimidxFile =

 		local path
 		path =3D CorrectPath( Addfilepath("anim.idx" ) ) if (file_exists(path)) =
then gAnimLoader[1] =3D CreateAnimLoader(gAnimLoaderType,200,200,path,Corre=
ctPath( Addfilepath("anim.mul" ) )) end	=




From no-reply at zwischenwelt.org  Sat Nov  1 13:39:46 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 01 Nov 2008 12:39:46 -0000
Subject: [Iris-commit] [IRIS] r2680 - /trunk/bin/iris2.exe
Message-ID: <20081101123946.BE0211C18422@zwischenwelt.org>

Author: sience
Date: Sat Nov  1 13:39:46 2008
New Revision: 2680

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sat Nov  1 18:48:21 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 01 Nov 2008 17:48:21 -0000
Subject: [Iris-commit] [IRIS] r2681 - /trunk/lua/lib.unifont.lua
Message-ID: <20081101174821.511FE1C18422@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov  1 18:48:20 2008
New Revision: 2681

Log:
unifont : attempted fix for directx

Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Sat Nov  1 18:48:20 2008
@@ -151,16 +151,16 @@
 		local uvw, uvh =3D u1-u0,v1-v0
 		res.matname	=3D matname
 		res.xmove	=3D ceil(w - overlapx*s + xoff*s)
-		res.xoff	=3D xoff
-		res.yoff	=3D yoff - 1*self.defaultlineh
-		res.w	=3D w
-		res.h	=3D h
-		res.u0	=3D u0
-		res.v0	=3D v0
-		res.ux	=3D uvw
+		res.xoff	=3D floor(xoff)
+		res.yoff	=3D floor(yoff - 1*self.defaultlineh)
+		res.w	=3D floor(w) if (floor(w) ~=3D floor(uvw*gUniFontTexAtlasSize)) th=
en print(") end
+		res.h	=3D floor(h) if (floor(h) ~=3D floor(uvh*gUniFontTexAtlasSize))
+		res.u0	=3D floor(u0*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
+		res.v0	=3D floor(v0*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
+		res.ux	=3D floor(uvw*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
 		res.vx	=3D 0
 		res.uy	=3D 0
-		res.vy	=3D uvh
+		res.vy	=3D floor(uvh*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
 		return res
 	end
 	return myfont



From no-reply at zwischenwelt.org  Sat Nov  1 20:40:16 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 01 Nov 2008 19:40:16 -0000
Subject: [Iris-commit] [IRIS] r2682 - /trunk/lua/lib.unifont.lua
Message-ID: <20081101194016.956B01C18650@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov  1 20:40:16 2008
New Revision: 2682

Log:
removed accidentally comittet unfinished code

Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Sat Nov  1 20:40:16 2008
@@ -153,8 +153,8 @@
 		res.xmove	=3D ceil(w - overlapx*s + xoff*s)
 		res.xoff	=3D floor(xoff)
 		res.yoff	=3D floor(yoff - 1*self.defaultlineh)
-		res.w	=3D floor(w) if (floor(w) ~=3D floor(uvw*gUniFontTexAtlasSize)) th=
en print(") end
-		res.h	=3D floor(h) if (floor(h) ~=3D floor(uvh*gUniFontTexAtlasSize))
+		res.w	=3D floor(w) -- if (floor(w) ~=3D floor(uvw*gUniFontTexAtlasSize))=
 then print(") end
+		res.h	=3D floor(h) -- if (floor(h) ~=3D floor(uvh*gUniFontTexAtlasSize))
 		res.u0	=3D floor(u0*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
 		res.v0	=3D floor(v0*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
 		res.ux	=3D floor(uvw*gUniFontTexAtlasSize) / gUniFontTexAtlasSize



From no-reply at zwischenwelt.org  Sat Nov  1 20:46:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 01 Nov 2008 19:46:29 -0000
Subject: [Iris-commit] [IRIS] r2683 - /trunk/premake.lua
Message-ID: <20081101194629.0EB791C18650@zwischenwelt.org>

Author: hagish
Date: Sat Nov  1 20:46:28 2008
New Revision: 2683

Log:
added wx to premake.lua

Modified:
    trunk/premake.lua

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Sat Nov  1 20:46:28 2008
@@ -34,7 +34,7 @@
 gLugreDir =3D "lugre"
 if (io.open("mylugre/lua/lugre.lua")) then print("using mylugre dir overri=
de") gLugreDir =3D "mylugre" end
 =

-gLugreLuaSrcDir =3D "./"..gLugreDir.."/lib/lua-5.1.3/"
+gLugreLuaSrcDir =3D "./"..gLugreDir.."/lib/lua-5.1.4/"
 gLugreOisDir =3D "./"..gLugreDir.."/baselib/ois/"
 =

 -- list of easy libs inclusion (located in lugre/lib/NAME). this will add =
lugre/lib/NAME/src and lugre/lib/NAME/include.
@@ -63,7 +63,7 @@
 	addpkgconfiglib(package, "openal")
 	addpkgconfiglib(package, "vorbisfile")
 =

-	--~ addcustomconfiglib(package, "ode-config")
+	addcustomconfiglib(package, "wx-config")
 =

 	addcustomlib(package,"boost_thread")
 	addcustomlib(package,"boost_thread-mt")	=




From no-reply at zwischenwelt.org  Sat Nov  1 21:08:45 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 01 Nov 2008 20:08:45 -0000
Subject: [Iris-commit] [IRIS] r2684 - /trunk/lua/lib.unifont.lua
Message-ID: <20081101200845.62E9D1C18403@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov  1 21:08:44 2008
New Revision: 2684

Log:
unifont warning added

Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Sat Nov  1 21:08:44 2008
@@ -153,8 +153,8 @@
 		res.xmove	=3D ceil(w - overlapx*s + xoff*s)
 		res.xoff	=3D floor(xoff)
 		res.yoff	=3D floor(yoff - 1*self.defaultlineh)
-		res.w	=3D floor(w) -- if (floor(w) ~=3D floor(uvw*gUniFontTexAtlasSize))=
 then print(") end
-		res.h	=3D floor(h) -- if (floor(h) ~=3D floor(uvh*gUniFontTexAtlasSize))
+		res.w	=3D floor(w) local a,b =3D floor(w),floor(uvw*gUniFontTexAtlasSize=
) if (a ~=3D b) then print("### unifont bad rounding w",a,b) end
+		res.h	=3D floor(h) local a,b =3D floor(h),floor(uvh*gUniFontTexAtlasSize=
) if (a ~=3D b) then print("### unifont bad rounding h",a,b) end
 		res.u0	=3D floor(u0*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
 		res.v0	=3D floor(v0*gUniFontTexAtlasSize) / gUniFontTexAtlasSize
 		res.ux	=3D floor(uvw*gUniFontTexAtlasSize) / gUniFontTexAtlasSize



From no-reply at zwischenwelt.org  Sun Nov  2 01:25:17 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 00:25:17 -0000
Subject: [Iris-commit] [IRIS] r2685 - in /trunk: bin/iris2.exe
	lua/gui/gui.helper.lua
Message-ID: <20081102002517.7ED191C18650@zwischenwelt.org>

Author: sience
Date: Sun Nov  2 01:25:16 2008
New Revision: 2685

Log:
-new win32 binary (fontbug is always there :-/ )
-ogre stats adjusted

Modified:
    trunk/bin/iris2.exe
    trunk/lua/gui/gui.helper.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Sun Nov  2 01:25:16 2008
@@ -107,7 +107,7 @@
 			gMemoryUsageField.text.gfx:SetText(text)
 		end
 		local tw,th =3D gMemoryUsageField.text.gfx:GetTextBounds()
-		gMemoryUsageField.text.gfx:SetPos(-tw+90,0)
+		gMemoryUsageField.text.gfx:SetPos(-tw+140,0)
 	end
 end
 =




From no-reply at zwischenwelt.org  Sun Nov  2 03:04:18 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 02:04:18 -0000
Subject: [Iris-commit] [IRIS] r2686 - /trunk/installdeps.ubuntu.sh
Message-ID: <20081102020419.1D8FB1C18403@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov  2 03:04:18 2008
New Revision: 2686

Log:
added wx libs to installdeps.ubuntu.sh

Modified:
    trunk/installdeps.ubuntu.sh

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Sun Nov  2 03:04:18 2008
@@ -1,4 +1,4 @@
 #!/bin/bash
-DEPS=3D"nvidia-cg-toolkit ccache liblua50-dev liblualib50-dev libalut-dev =
libopenal-dev libvorbisfile3 libvorbis-dev libogg-dev libboost-dev libboost=
-thread-dev libogre14 libogre-dev libois-dev g++ gcc"
+DEPS=3D"nvidia-cg-toolkit libwxbase2.8-dev libwxgtk2.8-dev wx2.8-headers c=
cache liblua50-dev liblualib50-dev libalut-dev libopenal-dev libvorbisfile3=
 libvorbis-dev libogg-dev libboost-dev libboost-thread-dev libogre14 libogr=
e-dev libois-dev g++ gcc"
 echo apt-get install $DEPS
 sudo apt-get install $DEPS



From no-reply at zwischenwelt.org  Sun Nov  2 14:54:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 13:54:29 -0000
Subject: [Iris-commit] [IRIS] r2687 - in /trunk: bin/iris2.exe
	vc8/iris.vcproj
Message-ID: <20081102135434.F00C31C18443@zwischenwelt.org>

Author: sience
Date: Sun Nov  2 14:54:28 2008
New Revision: 2687

Log:
-new win32 binary
-small project update

Modified:
    trunk/bin/iris2.exe
    trunk/vc8/iris.vcproj

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/vc8/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc8/iris.vcproj (original)
+++ trunk/vc8/iris.vcproj Sun Nov  2 14:54:28 2008
@@ -151,7 +151,7 @@
 			/>
 			<Tool
 				Name=3D"VCLinkerTool"
-				AdditionalDependencies=3D"AdvAPI32.Lib User32.Lib ws2_32.lib zlib.lib =
OgreMain.lib OIS.lib lua5.1.lib fmodex_vc.lib"
+				AdditionalDependencies=3D"AdvAPI32.Lib Comdlg32.lib User32.Lib ws2_32.=
lib zlib.lib OgreMain.lib OIS.lib lua5.1.lib fmodex_vc.lib"
 				OutputFile=3D"$(OutDir)\..\..\bin\iris2.exe"
 				AdditionalLibraryDirectories=3D"&quot;$(LIB)&quot;;&quot;C:\Programme\=
Microsoft SDKs\Windows\v6.1\Lib\&quot;;&quot;$(OGRE_HOME)\lib\&quot;;..\lib=
s\fmodx;..\libs\zlib;&quot;..\lugre\lib\lua-5.1.4\lib\static&quot;;..\lugre=
\lib\caelum\lib\static;..\lugre\lib\paged_geometry\lib\static;c:\Programme\=
boost\boost_1_34_1\lib"
 				GenerateManifest=3D"true"
@@ -779,6 +779,10 @@
 					>
 				</File>
 				<File
+					RelativePath=3D"..\lugre\src\lugre_commondialog.cpp"
+					>
+				</File>
+				<File
 					RelativePath=3D"..\lugre\src\lugre_CompassOverlay.cpp"
 					>
 				</File>
@@ -1020,25 +1024,85 @@
 				</File>
 			</Filter>
 			<Filter
-				Name=3D"candune_tree"
+				Name=3D"caelum"
 				>
 				<Filter
 					Name=3D"src"
 					>
 					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTParameters.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTSection.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTSerializer.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTStem.cpp"
+						RelativePath=3D"..\lugre\lib\caelum\src\Astronomy.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\BrightStarCatalogue.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\CaelumPrecompiled.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\CaelumSystem.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\CameraBoundElement.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\CloudSystem.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\DepthComposer.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\FlatCloudLayer.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\GeometryFactory.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\GroundFog.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\ImageHelper.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\ImageStarfield.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\Moon.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\PointStarfield.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\PrecipitationController.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\SkyDome.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\SkyLight.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\Sun.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\src\UniversalClock.cpp"
 						>
 					</File>
 				</Filter>
@@ -1046,199 +1110,139 @@
 					Name=3D"include"
 					>
 					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\include\CaduneTree.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTParameters.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTPrerequisites.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTSection.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTSerializer.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTStem.h"
+						RelativePath=3D"..\lugre\lib\caelum\include\Astronomy.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\Caelum.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\CaelumExceptions.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\CaelumPrecompiled.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\CaelumPrerequisites.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\CaelumSystem.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\CameraBoundElement.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\CloudSystem.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\DepthComposer.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\FlatCloudLayer.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\GeometryFactory.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\GroundFog.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\ImageHelper.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\ImageStarfield.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\Moon.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\PointStarfield.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\PrecipitationController.=
h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\SkyDome.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\SkyLight.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\Sun.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\caelum\include\UniversalClock.h"
 						>
 					</File>
 				</Filter>
 			</Filter>
 			<Filter
-				Name=3D"caelum"
-				>
+				Name=3D"cadunetree"
+				>
+				<Filter
+					Name=3D"include"
+					>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\include\CaduneTree.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTParameters.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTPrerequisites.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTSection.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTSerializer.h"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\include\CTStem.h"
+						>
+					</File>
+				</Filter>
 				<Filter
 					Name=3D"src"
 					>
 					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\Astronomy.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\BrightStarCatalogue.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\CaelumPrecompiled.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\CaelumSystem.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\CameraBoundElement.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\CloudSystem.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\DepthComposer.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\FlatCloudLayer.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\GeometryFactory.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\GroundFog.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\ImageHelper.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\ImageStarfield.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\Moon.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\PointStarfield.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\PrecipitationController.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\SkyDome.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\SkyLight.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\Sun.cpp"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\src\UniversalClock.cpp"
-						>
-					</File>
-				</Filter>
-				<Filter
-					Name=3D"include"
-					>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\Astronomy.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\Caelum.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\CaelumExceptions.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\CaelumPrecompiled.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\CaelumPrerequisites.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\CaelumSystem.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\CameraBoundElement.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\CloudSystem.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\DepthComposer.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\FlatCloudLayer.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\GeometryFactory.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\GroundFog.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\ImageHelper.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\ImageStarfield.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\Moon.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\PointStarfield.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\PrecipitationController.=
h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\SkyDome.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\SkyLight.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\Sun.h"
-						>
-					</File>
-					<File
-						RelativePath=3D"..\lugre\lib\caelum\include\UniversalClock.h"
+						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTParameters.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTSection.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTSerializer.cpp"
+						>
+					</File>
+					<File
+						RelativePath=3D"..\lugre\lib\cadune_tree\src\CTStem.cpp"
 						>
 					</File>
 				</Filter>



From no-reply at zwischenwelt.org  Sun Nov  2 15:39:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 14:39:35 -0000
Subject: [Iris-commit] [IRIS] r2688 - /trunk/src/pathsearch.cpp
Message-ID: <20081102143935.E99701C18443@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov  2 15:39:35 2008
New Revision: 2688

Log:
64 bit fix

Modified:
    trunk/src/pathsearch.cpp

Modified: trunk/src/pathsearch.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/pathsearch.cpp (original)
+++ trunk/src/pathsearch.cpp Sun Nov  2 15:39:35 2008
@@ -28,7 +28,7 @@
 	const char* Registry3d =3D "Software\\Origin Worlds Online\\Ultima Online=
 Third Dawn\\1.0";
 	const char* Registry2d =3D "Software\\Origin Worlds Online\\Ultima Online=
\\1.0";
 	unsigned char exePath[MAX_PATH] =3D {0,};
-	unsigned long pathLen =3D MAX_PATH;
+	DWORD pathLen =3D MAX_PATH; // 64 bit fix
 =

 	HKEY tempKey;
 =




From no-reply at zwischenwelt.org  Sun Nov  2 15:56:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 14:56:41 -0000
Subject: [Iris-commit] [IRIS] r2689 - /trunk/lua/main.lua
Message-ID: <20081102145641.A433B1C187D4@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov  2 15:56:40 2008
New Revision: 2689

Log:
uodir file browser

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Nov  2 15:56:40 2008
@@ -13,6 +13,7 @@
 gMacroPathFallback	=3D datapath.."mymacros.lua.dist"
 gMainPluginDir 		=3D gMainWorkingDir.."plugins/"
 gIrisWidgetDir 		=3D libpath.."widgets/"
+gTempPath			=3D datapath.."tmp/"
 gSecondsSinceLastFrame =3D 0
 =

 gInGameStarted =3D false
@@ -253,10 +254,21 @@
 =

 -- checks if iris has found the uo directory and displays an error box if =
not
 function CheckUODir ()
-	if (not file_exists(CorrectPath( Addfilepath(gArtFile) ))) then
+	--~ gUOPath
+
+	if (not file_exists(CorrectPath(Addfilepath(gArtFile)))) then
 		gUOPath =3D gUOPath .. "/"  -- append slash and try again
-		if (not file_exists(CorrectPath( Addfilepath(gArtFile) ))) then
-			FatalErrorMessage(sprintf("iris2 could not find your ultima-online dire=
ctory (searchpath : %s),\n please set gUOPath in data/config.lua",gUOPath))
+		if (not file_exists(CorrectPath(Addfilepath(gArtFile)))) then
+			gUOPath =3D gRegistry:Get("gUOPath")
+			if ((not gUOPath) or (not file_exists(CorrectPath(Addfilepath(gArtFile)=
)))) then
+				gUOPath =3D FileOpenDialog("..","*","Select a file in the UO Folder")
+				if (gUOPath) then gUOPath =3D string.gsub(gUOPath,"/[^/]+$","/") print=
("gUOPath browsed",gUOPath) end
+				if ((not gUOPath) or (not file_exists(CorrectPath(Addfilepath(gArtFile=
))))) then
+					FatalErrorMessage(sprintf("iris2 could not find your ultima-online di=
rectory (searchpath : %s),\n please set gUOPath in data/config.lua",gUOPath=
 or "??"))
+				else =

+					gRegistry:Set("gUOPath",gUOPath)
+				end
+			end
 		end
 	end
 	-- check for character(granny) models
@@ -292,6 +304,8 @@
 =

 --- main function, when it returns, the program ends
 function Main ()
+	gRegistry =3D cRegistry:New(gTempPath.."global.reg")
+
 	-- detect UOPath
 	if (not gUOPath) then AutoDetectUOPath() end
 	if (ClientVersionIsPost6017()) then =

@@ -386,6 +400,7 @@
 		MainStep() =

 	end
 	NotifyListener("Hook_Terminate")
+	gRegistry:Destroy() gRegistry =3D nil
 end
 =

 =




From no-reply at zwischenwelt.org  Sun Nov  2 17:29:23 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 16:29:23 -0000
Subject: [Iris-commit] [IRIS] r2690 - in /trunk/lua: gui/gui.trade.lua
 lib.pathfind.lua net/net.sound.lua
Message-ID: <20081102162923.A6CCE1C18443@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov  2 17:29:23 2008
New Revision: 2690

Log:
uoshop : mousewheel for scrolling, shiftclick for add max instead of 1

Modified:
    trunk/lua/gui/gui.trade.lua
    trunk/lua/lib.pathfind.lua
    trunk/lua/net/net.sound.lua

Modified: trunk/lua/gui/gui.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.trade.lua (original)
+++ trunk/lua/gui/gui.trade.lua Sun Nov  2 17:29:23 2008
@@ -31,6 +31,7 @@
 function ShopAddToBill (shop,good,amount)
 	amount =3D amount or 1
 	local newamount =3D math.max(0,math.min(good.itemamount,good.tradeamount =
+ amount))
+	if (gKeyPressed[key_lshift]) then newamount =3D good.itemamount end
 	if (good.tradeamount ~=3D newamount) then
 		good.tradeamount =3D newamount
 		shop.dialog_bill:RebuildCurrentPage() =

@@ -160,7 +161,7 @@
 	=

 			incr.good =3D good
 			decr.good =3D good
-			incr.onMouseDown =3D function (widget,mousebutton) if (mousebutton =3D=
=3D 1) then widget.dialog.uoShop:AddToBill(widget.good, 1) end end
+			incr.onMouseDown =3D function (widget,mousebutton) if (mousebutton =3D=
=3D 1) then widget.dialog.uoShop:AddToBill(widget.good,1) end end
 			decr.onMouseDown =3D function (widget,mousebutton) if (mousebutton =3D=
=3D 1) then widget.dialog.uoShop:AddToBill(widget.good,-1) end end
 =

 			table.insert(dialog.curpagewidgets,incr)
@@ -174,6 +175,14 @@
 	-- update total price
 	dialog.total.gfx:SetText(totalprice)
 end
+
+
+RegisterListener("keydown",function (key,char,bConsumed)
+	local list =3D gLastShop and gLastShop.dialog_list
+	if ((not list) or (not list:IsAlive())) then return end
+	if (key =3D=3D key_wheeldown) then	list:NextPage() end
+	if (key =3D=3D key_wheelup) then	list:PrevPage() end
+end)
 =

 -- npc trading
 -- see also old iris trade.csl : net_buywindow
@@ -184,6 +193,7 @@
 	local dialog_bill	=3D guimaker.MakeSortedDialog()
 	dialog_list.uoShop	=3D shop
 	dialog_bill.uoShop	=3D shop
+	gLastShop =3D shop
 	shop.dialog_list	=3D dialog_list
 	shop.dialog_bill	=3D dialog_bill
 	shop.defaultOnMouseDown =3D function (widget,mousebutton)

Modified: trunk/lua/lib.pathfind.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.pathfind.lua (original)
+++ trunk/lua/lib.pathfind.lua Sun Nov  2 17:29:23 2008
@@ -3,6 +3,7 @@
 function Pathfinding_TriggeredByMouse	()
 	MainMousePick()
 	local x,y,z =3D GetMouseHitTileCoords()
+	if (not z) then return end
 	z =3D math.floor(z * 0.1)
 	Pathfinding_TriggeredByDestination(x,y,z)
 end

Modified: trunk/lua/net/net.sound.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.sound.lua (original)
+++ trunk/lua/net/net.sound.lua Sun Nov  2 17:29:23 2008
@@ -11,7 +11,7 @@
 	local z =3D input:PopNetUint16()
 	printdebug("sound",sprintf("NET: kPacket_Sound: effect: %i singular: %i x=
: %i y: %i z: %i\n",effect,singular,x,y,z))
 	=

-	if (not gUseDisableUOSounds) then SoundPlayEffect_UO(x,y,z * 0.1,effect) =
end
+	if (not gDisableUOSounds) then SoundPlayEffect_UO(x,y,z * 0.1,effect) end
 	=

 	gSoundCounter =3D gSoundCounter or {}
 	gSoundCounter[effect] =3D (gSoundCounter[effect] or 0) + 1



From no-reply at zwischenwelt.org  Sun Nov  2 19:23:10 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 18:23:10 -0000
Subject: [Iris-commit] [IRIS] r2691 - /trunk/bin/iris2.exe
Message-ID: <20081102182310.68B691C1877A@zwischenwelt.org>

Author: sience
Date: Sun Nov  2 19:23:09 2008
New Revision: 2691

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Nov  2 22:02:16 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 21:02:16 -0000
Subject: [Iris-commit] [IRIS] r2692 - /trunk/lua/main.lua
Message-ID: <20081102210216.E3FD51C187D4@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov  2 22:02:16 2008
New Revision: 2692

Log:
win fileopen dialog : replaced \\ by /

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Nov  2 22:02:16 2008
@@ -262,7 +262,11 @@
 			gUOPath =3D gRegistry:Get("gUOPath")
 			if ((not gUOPath) or (not file_exists(CorrectPath(Addfilepath(gArtFile)=
)))) then
 				gUOPath =3D FileOpenDialog("..","*","Select a file in the UO Folder")
-				if (gUOPath) then gUOPath =3D string.gsub(gUOPath,"/[^/]+$","/") print=
("gUOPath browsed",gUOPath) end
+				if (gUOPath) then =

+					gUOPath =3D string.gsub(gUOPath,"\\","/") =

+					gUOPath =3D string.gsub(gUOPath,"/[^/]+$","/") =

+					print("gUOPath browsed",gUOPath) =

+				end
 				if ((not gUOPath) or (not file_exists(CorrectPath(Addfilepath(gArtFile=
))))) then
 					FatalErrorMessage(sprintf("iris2 could not find your ultima-online di=
rectory (searchpath : %s),\n please set gUOPath in data/config.lua",gUOPath=
 or "??"))
 				else =




From no-reply at zwischenwelt.org  Sun Nov  2 22:08:52 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 21:08:52 -0000
Subject: [Iris-commit] [IRIS] r2693 - /trunk/lua/lib.unifont.lua
Message-ID: <20081102210852.67D5A1C18400@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov  2 22:08:51 2008
New Revision: 2693

Log:
unifont glyph : added charcode for debug

Modified:
    trunk/lua/lib.unifont.lua

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Sun Nov  2 22:08:51 2008
@@ -149,6 +149,7 @@
 		=

 		local res	=3D {}
 		local uvw, uvh =3D u1-u0,v1-v0
+		res.iCharCode =3D iCharCode
 		res.matname	=3D matname
 		res.xmove	=3D ceil(w - overlapx*s + xoff*s)
 		res.xoff	=3D floor(xoff)



From no-reply at zwischenwelt.org  Mon Nov  3 00:47:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 23:47:29 -0000
Subject: [Iris-commit] [IRIS] r2694 - in /trunk/lua: ./ filter/ gui/
Message-ID: <20081102234729.C9FB01C187D4@zwischenwelt.org>

Author: hagish
Date: Mon Nov  3 00:47:29 2008
New Revision: 2694

Log:
*improved block spawner and sheduler (only blocks that are not idle are sor=
ted and stepped, added cam distance to priority)
*bb early out checks for 3d mousepicking (now its possible to load big area=
s)
*config option to display water as uo tiles
*removed debug output
*improved dump missing models
*added some models (artfilter)

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.3d.waterspawner.lua
    trunk/lua/lib.debugmenu.lua
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mapblock.3d.dynamics.lua
    trunk/lua/lib.mapblock.3d.statics.lua
    trunk/lua/lib.mapblock.3d.terrain.lua
    trunk/lua/lib.mapblock.3d.water.lua
    trunk/lua/lib.mapblock.base.lua
    trunk/lua/lib.mapblock.scheduler.lua
    trunk/lua/lib.mapblock.spawner.lua
    trunk/lua/lib.sound.iris.lua
    trunk/lua/lib.static.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Mon Nov  3 00:47:29 2008
@@ -81,6 +81,30 @@
 gArtFilter[3343]=3D{maptoid=3D3340,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 gArtFilter[3344]=3D{maptoid=3D3342,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 gArtFilter[3345]=3D{maptoid=3D3341,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+
+-- ceramic roof red
+gArtFilter[9173]=3D{maptoid=3D9172,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+
+gArtFilter[9175]=3D{maptoid=3D9174,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+gArtFilter[9176]=3D{maptoid=3D9174,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
+gArtFilter[9177]=3D{maptoid=3D9174,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+
+gArtFilter[9180]=3D{maptoid=3D9178,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+gArtFilter[9181]=3D{maptoid=3D9179,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+
+gArtFilter[9182]=3D{maptoid=3D9178,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+gArtFilter[9183]=3D{maptoid=3D9179,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+
+gArtFilter[9184]=3D{maptoid=3D9178,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
+gArtFilter[9185]=3D{maptoid=3D9179,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
+
+gArtFilter[9186]=3D{maptoid=3D9188,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+gArtFilter[9190]=3D{maptoid=3D9188,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
+gArtFilter[9192]=3D{maptoid=3D9188,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+
+gArtFilter[9187]=3D{maptoid=3D9189,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
+gArtFilter[9191]=3D{maptoid=3D9189,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
+gArtFilter[9193]=3D{maptoid=3D9189,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
 =

 -- ceramic roof blue
 gArtFilter[9157]=3D{maptoid=3D9155,rotation=3D"x:0,y:0,z:-180",xadd=3D1,ya=
dd=3D1,zadd=3D0}
@@ -282,18 +306,18 @@
 gArtFilter[10014]=3D{maptoid=3D10011,rotation=3D"x:0,y:0,z:90",xadd=3D0,ya=
dd=3D1.95,zadd=3D0}
 gArtFilter[10015]=3D{maptoid=3D10012,rotation=3D"x:0,y:0,z:90",xadd=3D0,ya=
dd=3D1.95,zadd=3D0}
 =

-gArtFilter[2242]=3D{maptoid=3D2241,rotation=3D"x:0,y:0,z:-90",xadd=3D-1.9,=
yadd=3D0,zadd=3D0}
-gArtFilter[2232]=3D{maptoid=3D2237,rotation=3D"x:0,y:0,z:0",xadd=3D-1,yadd=
=3D0,zadd=3D0}
+gArtFilter[2242]=3D{maptoid=3D2241,rotation=3D"x:0,y:0,z:-90",xadd=3D1.9,y=
add=3D0,zadd=3D0}
+gArtFilter[2232]=3D{maptoid=3D2237,rotation=3D"x:0,y:0,z:0",xadd=3D1,yadd=
=3D0,zadd=3D0}
 gArtFilter[2231]=3D{maptoid=3D2237,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D0.9,zadd=3D0}
 gArtFilter[2236]=3D{maptoid=3D2237,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D0,zadd=3D0}
-gArtFilter[2239]=3D{maptoid=3D2238,rotation=3D"x:0,y:0,z:-90",xadd=3D0,yad=
d=3D0,zadd=3D0}
-gArtFilter[2227]=3D{maptoid=3D2228,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,ya=
dd=3D0,zadd=3D0}
-gArtFilter[2226]=3D{maptoid=3D2228,rotation=3D"x:0,y:0,z:-90",xadd=3D-0.1,=
yadd=3D0,zadd=3D0}
+gArtFilter[2239]=3D{maptoid=3D2238,rotation=3D"x:0,y:0,z:0",xadd=3D0,yadd=
=3D0,zadd=3D0}
+gArtFilter[2227]=3D{maptoid=3D2228,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+gArtFilter[2226]=3D{maptoid=3D2228,rotation=3D"x:0,y:0,z:-90",xadd=3D0.1,y=
add=3D0,zadd=3D0}
 gArtFilter[2229]=3D{maptoid=3D2228,rotation=3D"x:0,y:0,z:0",xadd=3D0,yadd=
=3D0.9,zadd=3D0}
 =

 gArtFilter[2234]=3D{maptoid=3D2238,rotation=3D"x:0,y:0,z:0",xadd=3D0,yadd=
=3D0.9,zadd=3D0}
-gArtFilter[2235]=3D{maptoid=3D2238,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,ya=
dd=3D0,zadd=3D0}
-gArtFilter[2233]=3D{maptoid=3D2240,rotation=3D"x:0,y:0,z:180",xadd=3D-1.9,=
yadd=3D1.45,zadd=3D0}
+gArtFilter[2235]=3D{maptoid=3D2238,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+gArtFilter[2233]=3D{maptoid=3D2240,xadd=3D1,yadd=3D0.9,zadd=3D0}
 =

 gArtFilter[9345]=3D{maptoid=3D9344,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1.95,zadd=3D0}
 gArtFilter[9348]=3D{maptoid=3D9347,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1.95,zadd=3D0}

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Mon Nov  3 00:47:29 2008
@@ -1,8 +1,7 @@
 -- number of currently running loading things
 -- used to show ie. block loading acitivity
 giShowLoading =3D 0
-function NotifyLoadingStart() giShowLoading =3D giShowLoading + 1 end
-function NotifyLoadingEnd() giShowLoading =3D giShowLoading - 1 end
+giShowLoadingUnfinished =3D 0
 function DisplayLoadingState ()
 	if (gNoRender) then return end
 	-- parameters
@@ -56,6 +55,7 @@
 		local t =3D OgreTriangleCount()
 		local j =3D job.count()
 		local l =3D giShowLoading
+		local lu =3D giShowLoadingUnfinished
 		local fps =3D OgreAvgFPS()
 	=

 		if gConfig:Get("gLogStatsToFile") then
@@ -88,11 +88,11 @@
 			end
 		end
 					=

-		local text =3D sprintf("%5.1ffps %dt %db gfx | %s OGRE %s LUA mem | %i j=
 %i l",
+		local text =3D sprintf("%5.1ffps %dt %db gfx | %s OGRE %s LUA mem | %i j=
 %i/%i l",
 			fps, t, b, =

 			DisplayMemoryUsageFormatHelper(memoryusage),
 			DisplayMemoryUsageFormatHelper(mem_dyn), =

-			j, l
+			j, l, lu
 		)
 		if (not gMemoryUsageField) then
 			local vw,vh =3D GetViewportSize()

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Mon Nov  3 00:47:29 2008
@@ -163,6 +163,7 @@
 -- skybox,fog etc for 3d
 function Renderer2D:SetMapEnvironment () =

 	GetMainViewport():SetBackCol(0,0,0)
+	Client_SetFog(0)
 end
 =

 function Renderer2D:UpdateMapEnvironment (hour,minute,second) end -- updat=
e time, lightscale and season

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Mon Nov  3 00:47:29 2008
@@ -19,9 +19,9 @@
 kMapLoad_3D_Statics_Rough		=3D {prio=3D2}
 kMapLoad_3D_Multis_Rough		=3D {prio=3D3}
 kMapLoad_3D_Terrain_Detail		=3D {prio=3D4}
-kMapLoad_3D_Water_Detail		=3D {prio=3D5}
-kMapLoad_3D_Statics_Detail		=3D {prio=3D6}
-kMapLoad_3D_Multis_Detail		=3D {prio=3D7}
+kMapLoad_3D_Statics_Detail		=3D {prio=3D5}
+kMapLoad_3D_Multis_Detail		=3D {prio=3D6}
+kMapLoad_3D_Water_Detail		=3D {prio=3D7}
 kMapLoad_3D_Dynamics_AddRemove	=3D {prio=3D8}
 kMapLoad_3D_Dynamics_Batch		=3D {prio=3D5}
 =


Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Mon Nov  3 00:47:29 2008
@@ -43,21 +43,32 @@
 	=

 	-- multi mousepicking
 	for k,v in pairs(gMultis) do
-		for kk,vv in pairs(k.lparts) do
-			local iTileTypeID,xloc,yloc,zloc,iHue =3D unpack(vv) -- see Multi_AddPa=
rtHelper
-			local mousepickdata =3D vv.multi_mousepick -- see cMapBlock_3D_Multis:W=
orkStep_LoadDetail
-			if mousepickdata and self:IsZLayerVisible(zloc) then  =

-				bHit,fHitDist =3D mousepickdata.meshbuffer:RayPick(rx,ry,rz,rvx,rvy,rv=
z,
-					mousepickdata.x,mousepickdata.y,mousepickdata.z,
-					mousepickdata.qw,mousepickdata.qx,mousepickdata.qy,mousepickdata.qz,
-					mousepickdata.sx,mousepickdata.sy,mousepickdata.sz)
-
-				if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePickFo=
undDist)) then
-					self.gMousePickFoundDist =3D fHitDist
-					gMousePickFoundHit =3D {}
-					gMousePickFoundHit.hittype =3D kMousePickHitType_Static
-					gMousePickFoundHit.entity =3D mousepickdata
-					--entity has to have the following properties: hue, x, y, z, iTileTyp=
eID
+		local skipcheck =3D false
+		=

+		-- bb ray pick for early out
+		if k.minx and k.maxx and k.miny and k.maxy then
+			local x,y,w,h =3D k.minx, k.miny, k.maxx - k.minx + 1, k.maxy - k.miny =
+ 1
+			local hit,dist =3D RayAABBQuery( rx, ry, rz, rvx, rvy, rvz, -x,y,-10000=
, w, h, 10000 )
+			if hit then skipcheck =3D true end
+		end
+		=

+		if skipcheck then
+			for kk,vv in pairs(k.lparts) do
+				local iTileTypeID,xloc,yloc,zloc,iHue =3D unpack(vv) -- see Multi_AddP=
artHelper
+				local mousepickdata =3D vv.multi_mousepick -- see cMapBlock_3D_Multis:=
WorkStep_LoadDetail
+				if mousepickdata and self:IsZLayerVisible(zloc) then  =

+					bHit,fHitDist =3D mousepickdata.meshbuffer:RayPick(rx,ry,rz,rvx,rvy,r=
vz,
+						mousepickdata.x,mousepickdata.y,mousepickdata.z,
+						mousepickdata.qw,mousepickdata.qx,mousepickdata.qy,mousepickdata.qz,
+						mousepickdata.sx,mousepickdata.sy,mousepickdata.sz)
+
+					if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePickF=
oundDist)) then
+						self.gMousePickFoundDist =3D fHitDist
+						gMousePickFoundHit =3D {}
+						gMousePickFoundHit.hittype =3D kMousePickHitType_Static
+						gMousePickFoundHit.entity =3D mousepickdata
+						--entity has to have the following properties: hue, x, y, z, iTileTy=
peID
+					end
 				end
 			end
 		end
@@ -76,41 +87,43 @@
 				local bx,by =3D iBlockUO_X,iBlockUO_Y
 				local tx,ty
 =

-				bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,bx,=
by,w,h,0.1, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
-				if (bHit) then
-					if (tx >=3D 8) then bx =3D bx + 1   tx =3D tx - 8 end
-					if (ty >=3D 8) then by =3D by + 1   ty =3D ty - 8 end
-				end
-				=

-				if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePickFo=
undDist)) then
-					self.gMousePickFoundDist =3D fHitDist
-					gMousePickFoundHit =3D {}
-					gMousePickFoundHit.hittype =3D kMousePickHitType_Terrain
-					gMousePickFoundHit.chunk =3D chunk
+				if block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
+					bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,bx=
,by,w,h,0.1, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
+
+					if (bHit) then
+						if (tx >=3D 8) then bx =3D bx + 1   tx =3D tx - 8 end
+						if (ty >=3D 8) then by =3D by + 1   ty =3D ty - 8 end
+					end
 					=

-					local x,y =3D Renderer3D:LocalToUOPos(rx + fHitDist * rvx, ry + fHitD=
ist * rvy)
-					x,y =3D math.floor(x),math.floor(y)
-					local iTileType,iZLoc =3D GetAbsTile(x,y) =

-					local bx =3D math.floor((x - iBlockUO_X)/8)
-					local by =3D math.floor((y - iBlockUO_Y)/8)
-					local origin_abs_x =3D self.giMapOriginX * self.ROBMAP_CHUNK_SIZE
-					local origin_abs_y =3D self.giMapOriginY * self.ROBMAP_CHUNK_SIZE
-					local originoffx =3D 8.0*(iBlockUO_X-origin_abs_x)
-					local originoffy =3D 8.0*(iBlockUO_Y-origin_abs_y)
-					=

-					gMousePickFoundHit.tiletype =3D iTileType
-					gMousePickFoundHit.minz =3D iZLoc*0.1 =

-					gMousePickFoundHit.maxz =3D iZLoc*0.1
-					gMousePickFoundHit.x =3D x
-					gMousePickFoundHit.y =3D y
-					gMousePickFoundHit.tx =3D math.mod(x,8)
-					gMousePickFoundHit.ty =3D math.mod(y,8)
-					gMousePickFoundHit.iBlockX =3D iBlockUO_X+bx
-					gMousePickFoundHit.iBlockY =3D iBlockUO_Y+by
-					gMousePickFoundHit.blockorigin_x =3D originoffx+bx*8
-					gMousePickFoundHit.blockorigin_y =3D originoffy+by*8
-				end
-								=

+					if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePickF=
oundDist)) then
+						self.gMousePickFoundDist =3D fHitDist
+						gMousePickFoundHit =3D {}
+						gMousePickFoundHit.hittype =3D kMousePickHitType_Terrain
+						gMousePickFoundHit.chunk =3D chunk
+						=

+						local x,y =3D Renderer3D:LocalToUOPos(rx + fHitDist * rvx, ry + fHit=
Dist * rvy)
+						x,y =3D math.floor(x),math.floor(y)
+						local iTileType,iZLoc =3D GetAbsTile(x,y) =

+						local bx =3D math.floor((x - iBlockUO_X)/8)
+						local by =3D math.floor((y - iBlockUO_Y)/8)
+						local origin_abs_x =3D self.giMapOriginX * self.ROBMAP_CHUNK_SIZE
+						local origin_abs_y =3D self.giMapOriginY * self.ROBMAP_CHUNK_SIZE
+						local originoffx =3D 8.0*(iBlockUO_X-origin_abs_x)
+						local originoffy =3D 8.0*(iBlockUO_Y-origin_abs_y)
+						=

+						gMousePickFoundHit.tiletype =3D iTileType
+						gMousePickFoundHit.minz =3D iZLoc*0.1 =

+						gMousePickFoundHit.maxz =3D iZLoc*0.1
+						gMousePickFoundHit.x =3D x
+						gMousePickFoundHit.y =3D y
+						gMousePickFoundHit.tx =3D math.mod(x,8)
+						gMousePickFoundHit.ty =3D math.mod(y,8)
+						gMousePickFoundHit.iBlockX =3D iBlockUO_X+bx
+						gMousePickFoundHit.iBlockY =3D iBlockUO_Y+by
+						gMousePickFoundHit.blockorigin_x =3D originoffx+bx*8
+						gMousePickFoundHit.blockorigin_y =3D originoffy+by*8
+					end
+				end			=

 			end
 		end)
 	end
@@ -120,48 +133,50 @@
 	local numcustomquads =3D 0
 	if self.map3d_spawners and self.map3d_spawners.statics then
 		self.map3d_spawners.statics:ForAllBlocks(function(block)
-			block:ForAllEntities(function(entity)
-				if (not entity.bLoaded) then return end
-				if (not entity.zloc) then print("mousepick warning, static entity has =
no zloc",entity.serial,entity.artid) end
-				if (Renderer3D:IsZLayerVisible(entity.zloc)) then -- zloc is in intege=
r tilecoords from uo
-					=

-					if (entity.gfx) then numgfx =3D numgfx + 1 end
-					if (entity.gfx and entity.gfx.billboard) then
-						-- fallback
-						local x,y,z =3D entity.gfx.billboard:GetDerivedPosition()
-						fHitDist =3D SphereRayPick(x,y,z,0.5,rx,ry,rz,rvx,rvy,rvz) -- 0.5 rad
-						bHit =3D (fHitDist ~=3D nil)
-					elseif (entity.staticentity) then
-						bHit,fHitDist =3D entity.staticentity:RayPick(rx,ry,rz,rvx,rvy,rvz,
-							entity.x,entity.y,entity.z,
-							entity.qw,entity.qx,entity.qy,entity.qz,
-							entity.sx,entity.sy,entity.sz)
-					elseif (entity.meshbuffer) then
-						bHit,fHitDist =3D entity.meshbuffer:RayPick(rx,ry,rz,rvx,rvy,rvz,
-							entity.x,entity.y,entity.z,
-							entity.qw,entity.qx,entity.qy,entity.qz,
-							entity.sx,entity.sy,entity.sz)
-					elseif (entity.gfx and entity.gfx.customquads) then
-						numcustomquads =3D numcustomquads + 1
-						--~ print("mousepick : entity.customquads",entity.x,entity.y,entity.=
z)
-						for k,quad in pairs(entity.gfx.customquads) do =

-							local x1,y1,z1 =3D unpack(quad[1])
-							local x2,y2,z2 =3D unpack(quad[2])
-							local x3,y3,z3 =3D unpack(quad[3])
-							local x4,y4,z4 =3D unpack(quad[4])
-							local dist =3D RayPickFace4(x1,y1,z1, x2,y2,z2, x3,y3,z3, x4,y4,z4,=
 entity.x,entity.y,entity.z, rx,ry,rz, rvx,rvy,rvz)
-							bHit,fHitDist =3D dist ~=3D nil,dist =

+			if block:BBRayPick(rx, ry, rz, rvx, rvy, rvz) then
+				block:ForAllEntities(function(entity)
+					if (not entity.bLoaded) then return end
+					if (not entity.zloc) then print("mousepick warning, static entity has=
 no zloc",entity.serial,entity.artid) end
+					if (Renderer3D:IsZLayerVisible(entity.zloc)) then -- zloc is in integ=
er tilecoords from uo
+						=

+						if (entity.gfx) then numgfx =3D numgfx + 1 end
+						if (entity.gfx and entity.gfx.billboard) then
+							-- fallback
+							local x,y,z =3D entity.gfx.billboard:GetDerivedPosition()
+							fHitDist =3D SphereRayPick(x,y,z,0.5,rx,ry,rz,rvx,rvy,rvz) -- 0.5 r=
ad
+							bHit =3D (fHitDist ~=3D nil)
+						elseif (entity.staticentity) then
+							bHit,fHitDist =3D entity.staticentity:RayPick(rx,ry,rz,rvx,rvy,rvz,
+								entity.x,entity.y,entity.z,
+								entity.qw,entity.qx,entity.qy,entity.qz,
+								entity.sx,entity.sy,entity.sz)
+						elseif (entity.meshbuffer) then
+							bHit,fHitDist =3D entity.meshbuffer:RayPick(rx,ry,rz,rvx,rvy,rvz,
+								entity.x,entity.y,entity.z,
+								entity.qw,entity.qx,entity.qy,entity.qz,
+								entity.sx,entity.sy,entity.sz)
+						elseif (entity.gfx and entity.gfx.customquads) then
+							numcustomquads =3D numcustomquads + 1
+							--~ print("mousepick : entity.customquads",entity.x,entity.y,entity=
.z)
+							for k,quad in pairs(entity.gfx.customquads) do =

+								local x1,y1,z1 =3D unpack(quad[1])
+								local x2,y2,z2 =3D unpack(quad[2])
+								local x3,y3,z3 =3D unpack(quad[3])
+								local x4,y4,z4 =3D unpack(quad[4])
+								local dist =3D RayPickFace4(x1,y1,z1, x2,y2,z2, x3,y3,z3, x4,y4,z4=
, entity.x,entity.y,entity.z, rx,ry,rz, rvx,rvy,rvz)
+								bHit,fHitDist =3D dist ~=3D nil,dist =

+							end
 						end
-					end
-					if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePickF=
oundDist)) then
-						self.gMousePickFoundDist =3D fHitDist
-						gMousePickFoundHit =3D {}
-						gMousePickFoundHit.hittype =3D kMousePickHitType_Static
-						gMousePickFoundHit.entity =3D entity
-						--entity has to have the following properties: hue, x, y, z, iTileTy=
peID
-					end
-				end
-			end)
+						if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePick=
FoundDist)) then
+							self.gMousePickFoundDist =3D fHitDist
+							gMousePickFoundHit =3D {}
+							gMousePickFoundHit.hittype =3D kMousePickHitType_Static
+							gMousePickFoundHit.entity =3D entity
+							--entity has to have the following properties: hue, x, y, z, iTileT=
ypeID
+						end
+					end
+				end)
+			end
 		end)
 	end
 	=


Modified: trunk/lua/lib.3d.waterspawner.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.waterspawner.lua (original)
+++ trunk/lua/lib.3d.waterspawner.lua Mon Nov  3 00:47:29 2008
@@ -10,7 +10,7 @@
 end
 =

 function cWaterSpawner:TriggerUpdate	(item)
-	if item.artid and FilterIsStaticWater(item.artid) then
+	if item.artid and FilterIsStaticWater(item.artid) and not gConfig:Get("gW=
aterAsGroundTiles") then
 		local b =3D self:GetBlockByUOLocation(item.xloc,item.yloc)
 		b:Rebuild()
 	end

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Mon Nov  3 00:47:29 2008
@@ -922,6 +922,10 @@
 function DebugFlipModel	(id)
 	print("###############################")
 	print("flip normals")
+	if gArtFilter[id] and gArtFilter[id].maptoid then
+		id =3D gArtFilter[id].maptoid
+	end
+	=

 	local base =3D id - math.mod(id,1000) + 1000
 	local relpath  =3D sprintf("models/to_%06d/",base)
 	local mdlname =3D GetModelName(id)
@@ -958,7 +962,7 @@
 	-- try to rotate and adjust blender like, only possible if meshmagick is =
installed (unix)
 	os.execute("cp '"..mdl.."' '"..expmdl.."'")
 	os.execute("meshmagick transform -rotate=3D90/1/0/0 '"..expmdl.."'")
-	os.execute("meshmagick transform -scale=3D10/-10/10 '"..expmdl.."'")
+	os.execute("meshmagick transform -scale=3D1/-1/1 '"..expmdl.."'")
 	os.execute("meshmagick transform -rotate=3D90/0/1/0 '"..expmdl.."'")
 =

 	-- create xml file

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Mon Nov  3 00:47:29 2008
@@ -268,7 +268,7 @@
 	for k,v in pairs(gDesktop) do
 		if gDesktopElementFactory[v.name] and gDesktopElementFactory[v.name].che=
ckpos then
 			if gDesktopElementFactory[v.name].checkpos(v,widget) then =

-				print("REPLACE",nx,ny)
+				--~ print("REPLACE",nx,ny)
 				ReplaceDesktopElementIn(v.name,nx,ny,v.param,gDesktopPositions)
 				SaveDesktop() =

 			end

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Nov  3 00:47:29 2008
@@ -583,7 +583,7 @@
 	gAttackRunning =3D true
 	=

 	job.create(function()
-		print("START ATTACK")
+		--~ print("START ATTACK")
 		local reqsend =3D false
 		while gAttackRunning and gAttackMobile do
 			local mobile =3D gMobiles[gAttackMobile]
@@ -606,7 +606,7 @@
 				=

 				if (IsWarModeActive()) then
 					if not reqsend then
-						print("REQUEST SEND")
+						--~ print("REQUEST SEND")
 						Send_AttackReq(gAttackMobile)
 						reqsend =3D true
 					end
@@ -617,7 +617,7 @@
 				job.wait(500)
 			end
 		end
-		print("STOP ATTACK")
+		--~ print("STOP ATTACK")
 	end)
 end
 =


Modified: trunk/lua/lib.mapblock.3d.dynamics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.dynamics.lua (original)
+++ trunk/lua/lib.mapblock.3d.dynamics.lua Mon Nov  3 00:47:29 2008
@@ -41,8 +41,7 @@
 =

 function cMapBlock_3D_Dynamics:AddDynamic (dynamic)
 	local iTileTypeID,xloc,yloc,iZ,iHue =3D self:GetRawDataFromDynamic(dynami=
c)
-	if iTileTypeID and xloc and yloc and iZ and not FilterIsStaticWater(iTile=
TypeID) then
-		--~ print("ADD",self,dynamic.serial)
+	if iTileTypeID and xloc and yloc and iZ and (gConfig:Get("gWaterAsGroundT=
iles") or not FilterIsStaticWater(iTileTypeID)) then
 		self.mUpdateNeeded =3D true
 =

 		self.lDynamics[dynamic.serial] =3D {
@@ -68,6 +67,12 @@
 -- called every frame, instant actions (destroy gfx), evaluate priority =

 function cMapBlock_3D_Dynamics:ShortStep (t,xloc,yloc,zloc)
 	if self.mUpdateNeeded then
+		local bx,by,w,h =3D self:GetAABB()
+		=

+		local camdist =3D hypot(	(bx+w/2)-xloc,
+								(by+h/2)-yloc)
+		self.last_camdist =3D camdist
+
 		-- big changes
 		self:SetPriority(kMapLoad_3D_Dynamics_AddRemove.prio)
 	--~ elseif self.mUnbatched > 0 and self.mLastChange < t - cMapBlock_3D_Dy=
namics.kBatchTimeout then
@@ -75,7 +80,7 @@
 		--~ self.mRebatchNeeded =3D true
 		--~ self:SetPriority(kMapLoad_3D_Dynamics_Batch.prio)
 	--~ else
-		self:SetPriority(kSchedulerIdlePriority)
+		--~ self:SetPriority(kSchedulerIdlePriority)
 	end
 		=

 	--~ elseif ((self.iNextLODUpdate or 0) < t) then
@@ -97,7 +102,11 @@
 =

 -- a single step during the thread
 function cMapBlock_3D_Dynamics:WorkStep ()
-	if self.mUpdateNeeded then
+	local dt =3D Client_GetTicks() - (self.last_update_time or 0)
+	=

+	if self.mUpdateNeeded and (dt > 500) then
+		self.rebuild_count =3D (self.rebuild_count or 0) + 1
+		self.last_update_time =3D Client_GetTicks()
 		=

 		if not self.mTileBatch then
 			self.mTileBatch =3D CreateClassInstance(cTileBatch)
@@ -126,5 +135,7 @@
 		--~ print("count",self,countarr(self.lDynamics))
 =

 		self:SetDisplayRange(gCurrentRenderer:BlendoutGetVisibleRange())
+
+		self:SetPriority(kSchedulerIdlePriority)
 	end
 end

Modified: trunk/lua/lib.mapblock.3d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.statics.lua (original)
+++ trunk/lua/lib.mapblock.3d.statics.lua Mon Nov  3 00:47:29 2008
@@ -15,7 +15,7 @@
 =

 cMapBlock_3D_Statics	=3D CreateClass(cMapBlockGrid)
 cMapBlock_3D_Statics.iBlockSize		=3D 8*2 -- in tiles
-cMapBlock_3D_Statics.iLoadRadius	=3D 4 -- in iBlockSize-blocks
+cMapBlock_3D_Statics.iLoadRadius	=3D 8 -- in iBlockSize-blocks
 cMapBlock_3D_Statics.kMaxDist_Visible		=3D cMapBlock_3D_Statics.iBlockSize=
 * 4 -- camdist in tiles  see mapblock.base for default
 cMapBlock_3D_Statics.kMaxDist_Detail		=3D cMapBlock_3D_Statics.iBlockSize =
* 2 -- camdist in tiles
 =

@@ -63,7 +63,7 @@
 			for k,s in pairs(l) do =

 				iTileTypeID,iX,iY,iZ,iHue =3D s.artid, s.tx, s.ty, s.zloc, s.hue
 				=

-				if (not FilterIsStaticWater(iTileTypeID)) and iTileTypeID and iX and i=
Y and iZ and (not FilterSkipStatic(iTileTypeID)) then =

+				if (gConfig:Get("gWaterAsGroundTiles") or not FilterIsStaticWater(iTil=
eTypeID)) and iTileTypeID and iX and iY and iZ and (not FilterSkipStatic(iT=
ileTypeID)) then =

 					-- uo tile pos
 					local xloc,yloc =3D (iBlockUO_X+x)*8+iX,(iBlockUO_Y+y)*8+iY
 					if =


Modified: trunk/lua/lib.mapblock.3d.terrain.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.terrain.lua (original)
+++ trunk/lua/lib.mapblock.3d.terrain.lua Mon Nov  3 00:47:29 2008
@@ -18,6 +18,6 @@
 =

 =

 function cMapBlock_3D_Terrain:UpdateBlendOutVisibility ()
-	print("terrain:UpdateBlendOutVisibility",Renderer3D.gbBlendOutTerrainVisi=
ble)
+	--~ print("terrain:UpdateBlendOutVisibility",Renderer3D.gbBlendOutTerrain=
Visible)
 	if (self.gfx_terrain) then self.gfx_terrain:SetVisible(Renderer3D.gbBlend=
OutTerrainVisible) end
 end

Modified: trunk/lua/lib.mapblock.3d.water.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.water.lua (original)
+++ trunk/lua/lib.mapblock.3d.water.lua Mon Nov  3 00:47:29 2008
@@ -193,19 +193,19 @@
 end
 =

 function cMapBlock_3D_Water:SetWaterZ	(tx, ty, z)
-	--~ self:SetWaterZWithoutBorder(tx,ty,z)
+	self:SetWaterZWithoutBorder(tx,ty,z)
 =

 	-- set border of 1 tile
 	-- this is slow
-	self:SetWaterZWithoutBorder(tx+1,ty+0,z)
-	self:SetWaterZWithoutBorder(tx-1,ty+0,z)
-	self:SetWaterZWithoutBorder(tx+0,ty+1,z)
-	self:SetWaterZWithoutBorder(tx+0,ty-1,z)
-	=

-	self:SetWaterZWithoutBorder(tx+1,ty+1,z)
-	self:SetWaterZWithoutBorder(tx-1,ty-1,z)
-	self:SetWaterZWithoutBorder(tx+1,ty-1,z)
-	self:SetWaterZWithoutBorder(tx-1,ty+1,z)
+	--~ self:SetWaterZWithoutBorder(tx+1,ty+0,z)
+	--~ self:SetWaterZWithoutBorder(tx-1,ty+0,z)
+	--~ self:SetWaterZWithoutBorder(tx+0,ty+1,z)
+	--~ self:SetWaterZWithoutBorder(tx+0,ty-1,z)
+	--~ =

+	--~ self:SetWaterZWithoutBorder(tx+1,ty+1,z)
+	--~ self:SetWaterZWithoutBorder(tx-1,ty-1,z)
+	--~ self:SetWaterZWithoutBorder(tx+1,ty-1,z)
+	--~ self:SetWaterZWithoutBorder(tx-1,ty+1,z)
 end
 =

 function cMapBlock_3D_Water:WorkStep_LoadDetail ()
@@ -233,7 +233,7 @@
 			for k,s in pairs(l) do =

 				iTileTypeID,iX,iY,iZ,iHue =3D s.artid, s.tx, s.ty, s.zloc, s.hue
 				=

-				if iTileTypeID and FilterIsStaticWater(iTileTypeID) and iX and iY and =
iZ then =

+				if not gConfig:Get("gWaterAsGroundTiles") and iTileTypeID and FilterIs=
StaticWater(iTileTypeID) and iX and iY and iZ then =

 					-- uo tile pos
 					local xloc,yloc =3D (iBlockUO_X+x)*8+iX,(iBlockUO_Y+y)*8+iY
 					--~ print("DEBUG","water",x,y,basex,basey,xloc,yloc,iZ)
@@ -248,7 +248,7 @@
 					local xloc,yloc =3D (iBlockUO_X+x)*8+lx,(iBlockUO_Y+y)*8+ly
 					local o =3D MapGetGround(xloc,yloc)
 					=

-					if o.iTileType and FilterIsMapWater(o.iTileType) then
+					if not gConfig:Get("gWaterAsGroundTiles") and o.iTileType and FilterI=
sMapWater(o.iTileType) then
 						self:SetWaterZ(xloc-basex,yloc-basey,o.zloc)					=

 						self:YieldIfOverTime()
 					end
@@ -256,11 +256,12 @@
 			end
 	end end
 	=

+	self:Yield()
+	=

 	-- check dynamics
 	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then
-		if dynamic.artid and FilterIsStaticWater(dynamic.artid) then
+		if not gConfig:Get("gWaterAsGroundTiles") and dynamic.artid and FilterIs=
StaticWater(dynamic.artid) then
 			self:SetWaterZ(dynamic.xloc-basex,dynamic.yloc-basey,dynamic.zloc)					=

-			self:YieldIfOverTime()
 		end
 	end end
 =


Modified: trunk/lua/lib.mapblock.base.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.base.lua (original)
+++ trunk/lua/lib.mapblock.base.lua Mon Nov  3 00:47:29 2008
@@ -18,6 +18,14 @@
 -- returns the bounding box of the map block (x,y,w,h) in tiles
 function cMapBlock:GetAABB	() return 0,0,0,0 end	-- override me !
 =

+-- check if the given ray hits the bounding box of the block
+-- returns hit and distance
+function cMapBlock:BBRayPick	(rx, ry, rz, rvx, rvy, rvz)
+	local x,y,w,h =3D self:GetAABB()
+	local hit,dist =3D RayAABBQuery( rx, ry, rz, rvx, rvy, rvz, -x,y,-10000, =
w, h, 10000 )
+	return hit,dist
+end
+
 function cMapBlock:GetPos	()
 	local x,y,w,h =3D self:GetAABB()
 	return x,y
@@ -29,7 +37,10 @@
 end
 =

 function cMapBlock:SetPriority		(prio)	self.prio =3D prio end
-function cMapBlock:Yield			()		coroutine.yield() end
+function cMapBlock:Yield			()		=

+	self.last_yield_stack =3D _TRACEBACK()
+	coroutine.yield() =

+end
 function cMapBlock:YieldIfOverTime	()		if (Client_GetTicks() > self.t_end)=
 then self:Yield() end end
 =

 function cMapBlock:Work			(t_end)	=

@@ -46,6 +57,7 @@
 function cMapBlock:CheckForResumeError	(status,r)
 	if not status then
 		print("ERROR: job terminated: ",r)
+		print(SmartDump(self,3))
 	end
 end
 =

@@ -107,19 +119,25 @@
 		=

 		local camdist =3D hypot(	(bx+w/2)-x,
 								(by+h/2)-y)
+		self.last_camdist =3D camdist
+
 		local newlod
 		if (	camdist <  self.kMaxDist_Detail ) then newlod =3D self.kLOD_Detail =

 		elseif (camdist <  self.kMaxDist_Visible) then newlod =3D self.kLOD_Roug=
h end
 		--~ if (newlod) then print("cMapBlock:ShortStep",newlod,camdist,self.kMa=
xDist_Detail) end
-		=

 		self:SetLOD(newlod)
 	end
 end
 =

 -- a single step during the thread
 function cMapBlock:WorkStep ()
-	if (self.lod_finished =3D=3D self.lod) then return end -- nothing to do
-	NotifyLoadingStart()
+	if (self.lod_finished =3D=3D self.lod) then =

+		-- sets priority to idle if the current lod level is the loaded one
+		-- changing the lod should change the prio later
+		self:SetPriority(kSchedulerIdlePriority)
+		return -- nothing to do
+	end
+	=

 	if (self.lod =3D=3D self.kLOD_Rough ) then =

 		self:WorkStep_LoadRough()  =

 		self:ClearDetail() =

@@ -131,7 +149,6 @@
 		self.lod_finished =3D self.lod =

 		self:SetPriority(kSchedulerIdlePriority)
 	end
-	NotifyLoadingEnd()
 end
 =

 function cMapBlock:ClearRough   () end -- override me !

Modified: trunk/lua/lib.mapblock.scheduler.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.scheduler.lua (original)
+++ trunk/lua/lib.mapblock.scheduler.lua Mon Nov  3 00:47:29 2008
@@ -34,14 +34,23 @@
 	local t =3D Client_GetTicks()
 	local t_end =3D gMyTicks + self.kAllowedTicksPerFrame
 	=

+	local active_blocks =3D {}
+	=

 	-- shortsteps, re-evaluate prio, release gfx
-	for k,process in ipairs(self.pProcessList) do process:ShortStep(t,x,y,z) =
end =

+	for k,process in ipairs(self.pProcessList) do =

+		process:ShortStep(t,x,y,z) =

+		if process.prio ~=3D kSchedulerIdlePriority then
+			table.insert(active_blocks, process)
+		end
+	end =

+	=

+	giShowLoading =3D countarr(active_blocks)
 	=

 	-- sort by priority
-	table.sort(self.pProcessList,self.CmpProcess)
+	table.sort(active_blocks,self.CmpProcess)
 	=

 	-- work until no time left
-	for k,process in ipairs(self.pProcessList) do =

+	for k,process in ipairs(active_blocks) do =

 		local t1 =3D Client_GetTicks()
 		process:Work(t_end)
 		local t2 =3D Client_GetTicks()
@@ -52,7 +61,16 @@
 end
 =

 -- true when the first is less than the second       (NOT less-equal)
-function cScheduler.CmpProcess	(a,b) return a.prio < b.prio end
+function cScheduler.CmpProcess	(a,b) =

+	local da =3D math.floor((a.last_camdist or 1000)/8)
+	local db =3D math.floor((b.last_camdist or 1000)/8)
+	=

+	if da ~=3D db then =

+		return da < db
+	else =

+		return a.prio < b.prio =

+	end
+end
 =

 function cScheduler:Destroy ()
 	for k,v in pairs(self.pProcessList) do

Modified: trunk/lua/lib.mapblock.spawner.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.spawner.lua (original)
+++ trunk/lua/lib.mapblock.spawner.lua Mon Nov  3 00:47:29 2008
@@ -12,6 +12,7 @@
 	self.pBlockClass	=3D pBlockClass
 	self.pScheduler		=3D pScheduler
 	self.mlUnfinishedBlock =3D {}
+	self.mlToBeDestroyedBlock =3D {}
 end
 =

 -- calls fun(block) for all blocks
@@ -38,7 +39,8 @@
 				block.by < by-r or =

 				block.by > by+r) then
 				-- outside, destroyed
-				self:DestroyMapBlock(block)
+				self.mlToBeDestroyedBlock[block] =3D true
+				--~ self:DestroyMapBlock(block)
 			end
 		end
 		=

@@ -50,6 +52,8 @@
 		end
 	end
 	=

+	giShowLoadingUnfinished =3D countarr(self.mlUnfinishedBlock) + countarr(s=
elf.mlToBeDestroyedBlock)
+	=

 	-- check unfinished jobs and remove them if finished
 	for k,v in pairs(self.mlUnfinishedBlock) do
 		if k:IsDead() then
@@ -57,6 +61,13 @@
 			self.pScheduler:RemoveProcess(k)
 			self.mlUnfinishedBlock[k] =3D nil
 		end
+	end
+	=

+	-- destroy blocks
+	for k,v in pairs(self.mlToBeDestroyedBlock) do
+		self.mlToBeDestroyedBlock[k] =3D nil
+		self:DestroyMapBlock(k)
+		if not TimeLeftInFrame() then break end
 	end
 end
 =


Modified: trunk/lua/lib.sound.iris.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.sound.iris.lua (original)
+++ trunk/lua/lib.sound.iris.lua Mon Nov  3 00:47:29 2008
@@ -3,13 +3,13 @@
 =

 -- same like lugre:SoundPlayEffect but written for UO specific sound.mul
 function SoundPlayEffect_UO (x,y,z,effect)
-	print("SoundPlayEffect_UO",x,y,z,effect,gSoundLoader,gUseEffect,gSoundSys=
tem)
+	--~ print("SoundPlayEffect_UO",x,y,z,effect,gSoundLoader,gUseEffect,gSoun=
dSystem)
 	if gSoundLoader then
 		if gUseEffect and gSoundSystem then
 			printdebug("sound",sprintf("SoundPlayEffect(%f,%f,%f,%i)\n",x,y,z,effec=
t))
 			FlushSoundEffects()
 			local e =3D CreateSoundSource3DFromEffect(gSoundSystem,gSoundLoader,x,y=
,z,effect)
-			print("soundcreated",e)
+			--~ print("soundcreated",e)
 			if e then
 				e.file =3D "uosound:"..effect
 				e:SetMinMaxDistance(50,100000)

Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Mon Nov  3 00:47:29 2008
@@ -42,6 +42,7 @@
 -- TODO: remove hueing from her, not needed for fastbatch here
 -- bDontGenerateFallback is used during preload to not generate uo art fal=
lback models
 gLegacyModelCache =3D {}
+gbModelIsFallback =3D {}
 function GetMeshName (iTileTypeID, bDontGenerateFallback)
 	--1st: Seasonal Translation
 	local iTranslatedTileTypeID =3D SeasonalStaticTranslation(iTileTypeID, gS=
easonSetting)
@@ -72,7 +73,7 @@
 	end
 	=

 	-- dump missing models as images
-	if gDumpMissingModels then
+	if gDumpMissingModels and not bDontGenerateFallback then
 		local skip =3D gSkippedArtBillboardFallBacks[iTranslatedTileTypeID] or I=
sGroundPlate(iTranslatedTileTypeID)
 		local filename =3D "missing/"..iTranslatedTileTypeID..".png"
 		local filename_unmapped =3D "missing/"..iTileTypeID..".png"
@@ -91,7 +92,7 @@
 				end
 			end
 			img:Destroy()
-		elseif (meshname or skip) then
+		elseif (meshname or skip) and not gbModelIsFallback[iTranslatedTileTypeI=
D] then
 			if file_exists(filename) then
 				-- remove existing missing images
 				print("remove missing art image because there is now a model",iTransla=
tedTileTypeID,filename)
@@ -115,6 +116,7 @@
 		meshname =3D GetFallbackMeshName(iTranslatedTileTypeID)
 		if meshname then
 			gLegacyModelCache[iTranslatedTileTypeID] =3D meshname
+			gbModelIsFallback[iTranslatedTileTypeID] =3D true
 			--~ giStaticFallbackCount =3D (giStaticFallbackCount or 0) + 1
 			--~ print("giStaticFallbackCount",giStaticFallbackCount)
 		end



From no-reply at zwischenwelt.org  Mon Nov  3 00:47:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 02 Nov 2008 23:47:55 -0000
Subject: [Iris-commit] [IRIS] r2695 - /trunk/data/skippedfallbacks.lua
Message-ID: <20081102234756.F0BC91C187D4@zwischenwelt.org>

Author: hagish
Date: Mon Nov  3 00:47:52 2008
New Revision: 2695

Log:
missed

Modified:
    trunk/data/skippedfallbacks.lua

Modified: trunk/data/skippedfallbacks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/skippedfallbacks.lua (original)
+++ trunk/data/skippedfallbacks.lua Mon Nov  3 00:47:52 2008
@@ -1,29 +1,13 @@
 RegisterSkippedArtBillboardFallBack(3732) -- 0x0e94 name=3Dcannon
 RegisterSkippedArtBillboardFallBack(3733) -- 0x0e95 name=3Dcannon
-RegisterSkippedArtBillboardFallBack(6051) -- 0x17a3 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6060) -- 0x17ac name=3Dwater
-RegisterSkippedArtBillboardFallBack(6064) -- 0x17b0 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6052) -- 0x17a4 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6061) -- 0x17ad name=3Dwater
-RegisterSkippedArtBillboardFallBack(6059) -- 0x17ab name=3Dwater
-RegisterSkippedArtBillboardFallBack(6057) -- 0x17a9 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6053) -- 0x17a5 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6054) -- 0x17a6 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6048) -- 0x17a0 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6047) -- 0x179f name=3Dwater
-RegisterSkippedArtBillboardFallBack(6063) -- 0x17af name=3Dwater
-RegisterSkippedArtBillboardFallBack(6066) -- 0x17b2 name=3Dwater
 RegisterSkippedArtBillboardFallBack(3731) -- 0x0e93 name=3Dcannon
 RegisterSkippedArtBillboardFallBack(3730) -- 0x0e92 name=3Dcannon
-RegisterSkippedArtBillboardFallBack(6062) -- 0x17ae name=3Dwater
 RegisterSkippedArtBillboardFallBack(3728) -- 0x0e90 name=3Dcannon
 RegisterSkippedArtBillboardFallBack(3727) -- 0x0e8f name=3Dcannon
 RegisterSkippedArtBillboardFallBack(3725) -- 0x0e8d name=3Dcannon
 RegisterSkippedArtBillboardFallBack(3723) -- 0x0e8b name=3Dcannon
 RegisterSkippedArtBillboardFallBack(2943) -- 0x0b7f name=3Dtable
 RegisterSkippedArtBillboardFallBack(2944) -- 0x0b80 name=3Dtable
-RegisterSkippedArtBillboardFallBack(6056) -- 0x17a8 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6038) -- 0x1796 name=3Dwater
 RegisterSkippedArtBillboardFallBack(3428) -- 0x0d64 name=3Dleaves
 RegisterSkippedArtBillboardFallBack(3414) -- 0x0d56 name=3Dvines
 RegisterSkippedArtBillboardFallBack(3427) -- 0x0d63 name=3Dleaves
@@ -123,7 +107,6 @@
 RegisterSkippedArtBillboardFallBack(5023) -- 0x139f name=3Dstatue
 RegisterSkippedArtBillboardFallBack(5024) -- 0x13a0 name=3Dstatue
 RegisterSkippedArtBillboardFallBack(2265) -- 0x08d9 name=3Dchimney
-RegisterSkippedArtBillboardFallBack(6058) -- 0x17aa name=3Dwater
 RegisterSkippedArtBillboardFallBack(4799) -- 0x12bf name=3DYew tree
 RegisterSkippedArtBillboardFallBack(4790) -- 0x12b6 name=3DYew tree
 RegisterSkippedArtBillboardFallBack(4791) -- 0x12b7 name=3DYew tree
@@ -140,11 +123,6 @@
 RegisterSkippedArtBillboardFallBack(4806) -- 0x12c6 name=3DYew tree
 RegisterSkippedArtBillboardFallBack(4807) -- 0x12c7 name=3DYew tree
 RegisterSkippedArtBillboardFallBack(4798) -- 0x12be name=3DYew tree
-RegisterSkippedArtBillboardFallBack(6049) -- 0x17a1 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6055) -- 0x17a7 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6046) -- 0x179e name=3Dwater
-RegisterSkippedArtBillboardFallBack(6050) -- 0x17a2 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6045) -- 0x179d name=3Dwater
 RegisterSkippedArtBillboardFallBack(2962) -- 0x0b92 name=3Dbench
 RegisterSkippedArtBillboardFallBack(2963) -- 0x0b93 name=3Dbench
 RegisterSkippedArtBillboardFallBack(4194) -- 0x1062 name=3Dupright loom
@@ -301,13 +279,6 @@
 RegisterSkippedArtBillboardFallBack(7738) -- 0x1e3a name=3Dbearskin rug
 RegisterSkippedArtBillboardFallBack(7739) -- 0x1e3b name=3Dbearskin rug
 RegisterSkippedArtBillboardFallBack(7737) -- 0x1e39 name=3Dbearskin rug
-RegisterSkippedArtBillboardFallBack(6042) -- 0x179a name=3Dwater
-RegisterSkippedArtBillboardFallBack(6044) -- 0x179c name=3Dwater
-RegisterSkippedArtBillboardFallBack(6039) -- 0x1797 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6041) -- 0x1799 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6040) -- 0x1798 name=3Dwater
-RegisterSkippedArtBillboardFallBack(6043) -- 0x179b name=3Dwater
-RegisterSkippedArtBillboardFallBack(6065) -- 0x17b1 name=3Dwater
 RegisterSkippedArtBillboardFallBack(6795) -- 0x1a8b name=3Dore cart
 RegisterSkippedArtBillboardFallBack(6790) -- 0x1a86 name=3Dore cart
 RegisterSkippedArtBillboardFallBack(8611) -- 0x21a3 name=3Dnodraw



From no-reply at zwischenwelt.org  Mon Nov  3 01:17:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 03 Nov 2008 00:17:41 -0000
Subject: [Iris-commit] [IRIS] r2696 - in /trunk: lua/main.lua premake.lua
Message-ID: <20081103001741.9DCDB1C187DA@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov  3 01:17:41 2008
New Revision: 2696

Log:
additional ois header for mousehide at runtime option (not currently used)

Modified:
    trunk/lua/main.lua
    trunk/premake.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Nov  3 01:17:41 2008
@@ -339,6 +339,7 @@
 	gMyTicks =3D Client_GetTicks()
 	=

 	LoadingProfile("initializing Ogre",true)
+	if (SetOgreInputOptions) then SetOgreInputOptions(gbHideMouse,gbGrabInput=
) end
 	gPreOgreTime =3D gLoadingProfileLastTime
 	if (not gNoOgre) then
 		if (not InitOgre("Iris2",gOgrePluginPathOverride or lugre_detect_ogre_pl=
ugin_path(),"../bin/")) then Exit() end

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Mon Nov  3 01:17:41 2008
@@ -36,6 +36,7 @@
 =

 gLugreLuaSrcDir =3D "./"..gLugreDir.."/lib/lua-5.1.4/"
 gLugreOisDir =3D "./"..gLugreDir.."/baselib/ois/"
+gLugreOisIncludeDir =3D "./"..gLugreDir.."/baselib/ois/includes/"  -- for =
linux specific mouse functions
 =

 -- list of easy libs inclusion (located in lugre/lib/NAME). this will add =
lugre/lib/NAME/src and lugre/lib/NAME/include.
 gLugreLibList =3D {
@@ -191,7 +192,7 @@
 package.links =3D {  }
 package.buildflags =3D { bExtraWarnings and "extra-warnings" or nil, gbOpt=
imize and "optimize" or nil, gbNo64BitChecks and "no-64bit-checks" or nil }
 package.buildoptions =3D {}
-package.includepaths =3D { gLugreLuaSrcDir.."/src", gLugreDir.."/include" }
+package.includepaths =3D { gLugreLuaSrcDir.."/src", gLugreDir.."/include",=
 gLugreOisIncludeDir }
 package.files =3D {
   matchrecursive(gLugreDir.."/include/*.h", gLugreDir.."/src/*.cpp"),
 }



From no-reply at zwischenwelt.org  Mon Nov  3 21:52:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 03 Nov 2008 20:52:53 -0000
Subject: [Iris-commit] [IRIS] r2697 - /trunk/bin/iris2.exe
Message-ID: <20081103205253.E663C1C187D4@zwischenwelt.org>

Author: sience
Date: Mon Nov  3 21:52:51 2008
New Revision: 2697

Log:
-win-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Tue Nov  4 21:35:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 20:35:29 -0000
Subject: [Iris-commit] [IRIS] r2698 - /trunk/include/
Message-ID: <20081104203530.617A51C18652@zwischenwelt.org>

Author: hagish
Date: Tue Nov  4 21:35:27 2008
New Revision: 2698

Log:
added include gards, mac compile

Modified:
    trunk/include/data_anim.h
    trunk/include/data_artmap.h
    trunk/include/data_common.h
    trunk/include/data_font.h
    trunk/include/data_groundblock.h
    trunk/include/data_gump.h
    trunk/include/data_hue.h
    trunk/include/data_indexed.h
    trunk/include/data_light.h
    trunk/include/data_lookup.h
    trunk/include/data_mapinfo.h
    trunk/include/data_multi.h
    trunk/include/data_radar.h
    trunk/include/data_raw.h
    trunk/include/data_sound.h
    trunk/include/data_staticblock.h
    trunk/include/data_texmap.h
    trunk/include/data_tiletype.h

Modified: trunk/include/data_anim.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_anim.h (original)
+++ trunk/include/data_anim.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_ANIM_H_
+#define _DATA_ANIM_H_
 // ***** ***** ***** ***** ***** AnimData
 =

 class cAnimDataLoader : public Lugre::cSmartPointable, public cFullFileLoa=
der { public :
@@ -161,4 +163,4 @@
 	virtual	cAnim*	GetAnim	(const int iID) ; ///< result of Get is only valid=
 until next Get call
 };
 =

-
+#endif

Modified: trunk/include/data_artmap.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_artmap.h (original)
+++ trunk/include/data_artmap.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_ARTMAP_H_
+#define _DATA_ARTMAP_H_
 // ***** ***** ***** ***** ***** cArtMap
 =

 =

@@ -104,3 +106,4 @@
 	virtual unsigned int	GetCount	();	///< number of artmaps
 };
 =

+#endif

Modified: trunk/include/data_common.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_common.h (original)
+++ trunk/include/data_common.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_COMMON_H_
+#define _DATA_COMMON_H_
 // common header for the builder*.cpp files
 =

 #include "lugre_prefix.h"
@@ -37,3 +39,6 @@
 			(uint32(float(0xff)*float((x >>  0) & 0x1F)/float(0x1f)) << 0); // b
 	// using float instead of <<3 to map 0 to 0 and max to max
 }
+
+
+#endif

Modified: trunk/include/data_font.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_font.h (original)
+++ trunk/include/data_font.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_FONT_H_
+#define _DATA_FONT_H_
 // ***** ***** ***** ***** ***** cUniFontFileLoader
 =

 /// loads a complete uo unifont, =

@@ -27,3 +29,5 @@
 	/// returns true if the pixel is a border pixel (has visible non border n=
eightbours, a normal visible pixel is no border)
 	const bool		IsPixelBorder	(const char *data, const int w, const int h, co=
nst int x, const int y);
 };
+
+#endif

Modified: trunk/include/data_groundblock.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_groundblock.h (original)
+++ trunk/include/data_groundblock.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_GROUNDBLOCK_H_
+#define _DATA_GROUNDBLOCK_H_
 // ***** ***** ***** ***** ***** GroundBlock
 =

 =

@@ -74,3 +76,5 @@
 	cLookupFile *mpDiffLookupFile;
 	cGroundBlockLoader_FullFile *mpDiffLoader;
 };
+
+#endif

Modified: trunk/include/data_gump.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_gump.h (original)
+++ trunk/include/data_gump.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_GUMP_H_
+#define _DATA_GUMP_H_
 // ***** ***** ***** ***** ***** cGump
 =

 =

@@ -57,3 +59,5 @@
 	cGumpLoader_IndexedOnDemand	(const char* szIndexFile,const char* szDataFi=
le);
 	virtual	cGump*	GetGump	(const int iID) ; ///< result of Get is only valid=
 until next Get call
 };
+
+#endif

Modified: trunk/include/data_hue.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_hue.h (original)
+++ trunk/include/data_hue.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_HUE_H_
+#define _DATA_HUE_H_
 //	***** ***** ***** ***** ***** cHue
 	=

 =

@@ -36,3 +38,5 @@
 	}
 } };
 =

+
+#endif

Modified: trunk/include/data_indexed.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_indexed.h (original)
+++ trunk/include/data_indexed.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_INDEXED_H_
+#define _DATA_INDEXED_H_
 // ***** ***** ***** ***** ***** cIndexedRawData
 =

 =

@@ -84,3 +86,4 @@
 };
 =

 /// todo : variant with blockwise caching
+#endif

Modified: trunk/include/data_light.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_light.h (original)
+++ trunk/include/data_light.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_LIGHT_H_
+#define _DATA_LIGHT_H_
 // ***** ***** ***** ***** ***** cLight
 =

 class cLight : public cIndexedRawData { public :
@@ -28,3 +30,5 @@
 	cLightLoader_IndexedFullFile	(const char* szIndexFile,const char* szDataF=
ile);
 	virtual	cLight*		GetLight	(const int iID); ///< result of Get is only val=
id until next Get call
 };
+
+#endif

Modified: trunk/include/data_lookup.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_lookup.h (original)
+++ trunk/include/data_lookup.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,6 @@
+#ifndef _DATA_LOOKUP_H_
+#define _DATA_LOOKUP_H_
+
 // diff files, for groundblock and staticblock, and potentially other inde=
xed files ?
 =

 // ***** ***** ***** ***** ***** lookup table
@@ -13,3 +16,5 @@
 private:
 	std::map<uint32,uint32>	mLookupTable;
 };
+
+#endif

Modified: trunk/include/data_mapinfo.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_mapinfo.h (original)
+++ trunk/include/data_mapinfo.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,6 @@
+#ifndef _DATA_MAPINFO_H_
+#define _DATA_MAPINFO_H_
+
 // ***** ***** ***** ***** ***** cMapInfo
 	=

 		=

@@ -17,3 +20,5 @@
 	void	Print	();
 };
 =

+
+#endif

Modified: trunk/include/data_multi.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_multi.h (original)
+++ trunk/include/data_multi.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_MULTI_H_
+#define _DATA_MULTI_H_
 // ***** ***** ***** ***** ***** multi loader
 =

 /// abstract base class
@@ -14,3 +16,4 @@
 };
 =

 =

+#endif

Modified: trunk/include/data_radar.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_radar.h (original)
+++ trunk/include/data_radar.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_RADAR_H_
+#define _DATA_RADAR_H_
 // ***** ***** ***** ***** ***** RadarColors
 	=

 	=

@@ -8,3 +10,4 @@
 	inline short	GetCol16	(const int iID) { return (iID < 0 || iID >=3D miFul=
lFileSize/sizeof(short)) ? 0 : ((short*)mpFullFileBuffer)[iID]; } 	///< for=
 Ogre::PF_A1R5G5B5
 };
 =

+#endif

Modified: trunk/include/data_raw.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_raw.h (original)
+++ trunk/include/data_raw.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_RAW_H_
+#define _DATA_RAW_H_
 /// packed structs used by uo
 =

 // Compiler directives for packed structs (not 4byte aligned)
@@ -115,3 +117,6 @@
 #ifdef WIN32
 #pragma pack(pop)
 #endif
+
+
+#endif

Modified: trunk/include/data_sound.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_sound.h (original)
+++ trunk/include/data_sound.h Tue Nov  4 21:35:27 2008
@@ -1,5 +1,8 @@
+#ifndef _DATA_SOUND_H_
+#define _DATA_SOUND_H_
 // ***** ***** ***** ***** ***** cSound
 =

+#include "data_indexed.h"
 =

 class cSound : public cIndexedRawData { public :
 	cSound();
@@ -30,3 +33,5 @@
 	virtual	cSound*	GetSound	(const int iID) ; ///< result of Get is only val=
id until next Get call
 };
 =

+
+#endif

Modified: trunk/include/data_staticblock.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_staticblock.h (original)
+++ trunk/include/data_staticblock.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_STATICBLOCK_H_
+#define _DATA_STATICBLOCK_H_
 // ***** ***** ***** ***** ***** statics
 	=

 =

@@ -34,3 +36,5 @@
 	cIndexedFullFile *mpDiffIndexedFullFile;
 };
 =

+
+#endif

Modified: trunk/include/data_texmap.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_texmap.h (original)
+++ trunk/include/data_texmap.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_TEXMAP_H_
+#define _DATA_TEXMAP_H_
 // ***** ***** ***** ***** ***** cTexMap
 =

 =

@@ -38,3 +40,5 @@
 	virtual	cTexMap*		GetTexMap	(const int iID); ///< result of Get is only v=
alid until next Get call
 	virtual unsigned int	GetCount	() { return mIndexFile.miFullFileSize / 12;=
 }
 };
+
+#endif

Modified: trunk/include/data_tiletype.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_tiletype.h (original)
+++ trunk/include/data_tiletype.h Tue Nov  4 21:35:27 2008
@@ -1,3 +1,5 @@
+#ifndef _DATA_TILETYPE_H_
+#define _DATA_TILETYPE_H_
 // ***** ***** ***** ***** ***** TileType
 	=

 	=

@@ -45,3 +47,4 @@
 	virtual	int					GetEndID			();
 };
 =

+#endif



From no-reply at zwischenwelt.org  Wed Nov  5 00:20:39 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:20:39 -0000
Subject: [Iris-commit] [IRIS] r2699 - in /trunk: cmake.obsolete.sh cmake.sh
Message-ID: <20081104232039.8E46F1C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:20:39 2008
New Revision: 2699

Log:
marked cmake.sh as obsolete

Added:
    trunk/cmake.obsolete.sh
      - copied unchanged from r2696, trunk/cmake.sh
Removed:
    trunk/cmake.sh



From no-reply at zwischenwelt.org  Wed Nov  5 00:29:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:29:06 -0000
Subject: [Iris-commit] [IRIS] r2701 - /branches/stable_release/
Message-ID: <20081104232906.257641C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:29:06 2008
New Revision: 2701

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r2700, trunk/



From no-reply at zwischenwelt.org  Wed Nov  5 00:29:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:29:06 -0000
Subject: [Iris-commit] [IRIS] r2702 - /branches/stable_release/
Message-ID: <20081104232906.67C431C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:29:06 2008
New Revision: 2702

Log:
lugre -r616 svn://zwischenwelt.org/lugre/trunk/lugre

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Wed Nov  5 00:29:05 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:29:05 -0000
Subject: [Iris-commit] [IRIS] r2700 - /branches/stable_release/
Message-ID: <20081104232905.E274B1C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:29:05 2008
New Revision: 2700

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Wed Nov  5 00:38:26 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:38:26 -0000
Subject: [Iris-commit] [IRIS] r2703 - in /trunk: bootstrap
 bootstrap.obsolete remake.obsolete.sh remake.sh
Message-ID: <20081104233826.7F22F1C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:38:26 2008
New Revision: 2703

Log:
obsoleted old make scripts

Added:
    trunk/bootstrap.obsolete
      - copied unchanged from r2696, trunk/bootstrap
    trunk/remake.obsolete.sh
      - copied unchanged from r2696, trunk/remake.sh
Removed:
    trunk/bootstrap
    trunk/remake.sh



From no-reply at zwischenwelt.org  Wed Nov  5 00:39:31 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:39:31 -0000
Subject: [Iris-commit] [IRIS] r2704 - /trunk/obsolete/
Message-ID: <20081104233932.013BF1C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:39:31 2008
New Revision: 2704

Log:
created obsolete folder

Added:
    trunk/obsolete/



From no-reply at zwischenwelt.org  Wed Nov  5 00:41:16 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:41:16 -0000
Subject: [Iris-commit] [IRIS] r2705 - in /trunk: ./ obsolete/ obsolete/vc7/
	obsolete/vc9/ vc7/ vc9/
Message-ID: <20081104234116.A6F971C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:41:14 2008
New Revision: 2705

Log:
moved old build stuff to obsolete folder

Added:
    trunk/obsolete/bootstrap.obsolete
      - copied unchanged from r2703, trunk/bootstrap.obsolete
    trunk/obsolete/cmake.obsolete.sh
      - copied unchanged from r2699, trunk/cmake.obsolete.sh
    trunk/obsolete/obsolete.startbinary.sh
      - copied unchanged from r2696, trunk/obsolete.startbinary.sh
    trunk/obsolete/remake.obsolete.sh
      - copied unchanged from r2703, trunk/remake.obsolete.sh
    trunk/obsolete/vc7/
      - copied from r2696, trunk/vc7/
    trunk/obsolete/vc9/
      - copied from r2696, trunk/vc9/
Removed:
    trunk/bootstrap.obsolete
    trunk/cmake.obsolete.sh
    trunk/obsolete.startbinary.sh
    trunk/remake.obsolete.sh
    trunk/vc7/
    trunk/vc9/



From no-reply at zwischenwelt.org  Wed Nov  5 00:46:57 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:46:57 -0000
Subject: [Iris-commit] [IRIS] r2706 - in /trunk: obsolete/vc7/ obsolete/vc9/
	vc7/ vc9/
Message-ID: <20081104234658.71CC11C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:46:56 2008
New Revision: 2706

Log:
moved vc7 and vc9 from obsolete folder back to main dir, should work with m=
inor adjustments according to sience

Added:
    trunk/vc7/
      - copied from r2705, trunk/obsolete/vc7/
    trunk/vc9/
      - copied from r2705, trunk/obsolete/vc9/
Removed:
    trunk/obsolete/vc7/
    trunk/obsolete/vc9/



From no-reply at zwischenwelt.org  Wed Nov  5 00:52:45 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:52:45 -0000
Subject: [Iris-commit] [IRIS] r2707 - /trunk/edit.sh
Message-ID: <20081104235245.E954B1C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:52:45 2008
New Revision: 2707

Log:
removed old edit.sh

Removed:
    trunk/edit.sh



From no-reply at zwischenwelt.org  Wed Nov  5 00:55:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 04 Nov 2008 23:55:28 -0000
Subject: [Iris-commit] [IRIS] r2708 - in /trunk: makemultitex.php
 mapdata.php mapinfo.php mask_rotmir.php ravenal_terrain.php
 scripts/makemultitex.php scripts/mapdata.php scripts/mapinfo.php
 scripts/mask_rotmir.php scripts/ravenal_terrain.php
Message-ID: <20081104235528.C65AB1C18652@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov  5 00:55:26 2008
New Revision: 2708

Log:
moved php scripts to scripts dir

Added:
    trunk/scripts/makemultitex.php
      - copied unchanged from r2696, trunk/makemultitex.php
    trunk/scripts/mapdata.php
      - copied unchanged from r2696, trunk/mapdata.php
    trunk/scripts/mapinfo.php
      - copied unchanged from r2696, trunk/mapinfo.php
    trunk/scripts/mask_rotmir.php
      - copied unchanged from r2696, trunk/mask_rotmir.php
    trunk/scripts/ravenal_terrain.php
      - copied unchanged from r2696, trunk/ravenal_terrain.php
Removed:
    trunk/makemultitex.php
    trunk/mapdata.php
    trunk/mapinfo.php
    trunk/mask_rotmir.php
    trunk/ravenal_terrain.php



From no-reply at zwischenwelt.org  Sun Nov  9 20:15:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 09 Nov 2008 19:15:28 -0000
Subject: [Iris-commit] [IRIS] r2709 - in /trunk/lua: gui/gui.gumpparser.lua
 main.lua net/net.gump.lua
Message-ID: <20081109191528.6D56D1C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov  9 20:15:26 2008
New Revision: 2709

Log:
CollectOgreResLocs option to use different folders for ogre 1.6 : ogreversi=
onadd .ogre1.6 or .ogre1.4

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/main.lua
    trunk/lua/net/net.gump.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sun Nov  9 20:15:26 2008
@@ -11,6 +11,8 @@
 dofile(libpath .. "lib.gump.samples.lua")
 =

 function GumpParser (Gumpdata, Clientsidemode)
+	--~ if ((not Clientsidemode) and Gumpdata.dialogId =3D=3D 0xDD8B146A) the=
n GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, 1, {switches=3D{},tex=
ts=3D{},}) return end
+	=

 	if (gNoRender) then return end
 	if ((not Clientsidemode) or Gumpdata.bSupportsGuiSys2) then return GumpPa=
rser_New(Gumpdata, Clientsidemode) end
 	return GumpParser_Old(Gumpdata, Clientsidemode)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Nov  9 20:15:26 2008
@@ -183,6 +183,8 @@
 --###############################
 =

 function CollectOgreResLocs	()
+	local ogreversionadd =3D (GetOgreVersion and GetOgreVersion() >=3D 0x1060=
0) and ".ogre1.6" or ".ogre1.4"
+	print("GetOgreVersion",GetOgreVersion and sprintf("0x%x",GetOgreVersion()=
),ogreversionadd)
 	local mydatapath =3D gMainWorkingDir.."data/"
 	OgreAddResLoc(mydatapath.."base/OgreCore.zip"			,"Zip","Bootstrap")
 	=


Modified: trunk/lua/net/net.gump.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.gump.lua (original)
+++ trunk/lua/net/net.gump.lua Sun Nov  9 20:15:26 2008
@@ -190,7 +190,7 @@
 		local unknownterminator=3Dinput:PopNetUint32()
 	end
 =

-	local dialog =3D (not gNoRender) and GumpParser(newgump)
+	local dialog =3D GumpParser(newgump)
 	NotifyListener("Hook_OpenServersideGump",dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data,true)	=

 end
 =




From no-reply at zwischenwelt.org  Mon Nov 10 00:05:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 09 Nov 2008 23:05:08 -0000
Subject: [Iris-commit] [IRIS] r2710 - in /trunk/lua: lib.macrolist.lua
	net/net.other.lua
Message-ID: <20081109230508.EC15A1C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 10 00:05:08 2008
New Revision: 2710

Log:
added MacroCmd_OpenDoors

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.other.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Nov 10 00:05:08 2008
@@ -61,6 +61,7 @@
 function MacroCmd_SelectNextMobile		()		if (gInGameStarted) then SelectNex=
tMobile() end end
 function MacroCmd_AttackSelectedMobile	()		if (gInGameStarted) then if giS=
electedMobile then AttackMobile(giSelectedMobile) end end end
 function MacroCmd_ToggleWarmode			()		if (gInGameStarted) then Send_Combat=
Mode(IsWarModeActive() and gWarmode_Normal or gWarmode_Combat) end end
+function MacroCmd_OpenDoors				() 		Send_OpenDoors() end
 function MacroCmd_Open					(dialogtype)
 	if (not gInGameStarted) then return end
 	local f =3D gMacroOpenCommands[dialogtype] =


Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Mon Nov 10 00:05:08 2008
@@ -171,6 +171,22 @@
 end
 =

 =

+
+-- open door  kPacket_Request_SkillOrSpell 0x12
+function Send_OpenDoors ()
+	print("Send_OpenDoors")
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Request_SkillOrSpell)
+	out:PushNetUint16(5)
+	out:PushNetUint8(0x58)
+	out:PushNetUint8(0x00)
+	out:SendPacket()
+	--~ 23:33:20.8944: Razor -> Server 0x12 (Length: 5)
+	--~ 0000   12 00 05 58 00                                     ...X.
+end
+
+
+
 --Subcommand 0x1c: Spell selected, client side
 --[[
 word	Has Spellbook or Spell(2=3Dno spell,1=3Dhas spellbook,0=3Dno spellboo=
k, but has spell)



From no-reply at zwischenwelt.org  Mon Nov 10 03:18:10 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 10 Nov 2008 02:18:10 -0000
Subject: [Iris-commit] [IRIS] r2711 - in /trunk/lua: lib.mainmenu.lua
	net.walk.lua
Message-ID: <20081110021810.6759D1C187DC@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 10 03:18:09 2008
New Revision: 2711

Log:
walk-code : mounted-run hickup on uogamers fixed

Modified:
    trunk/lua/lib.mainmenu.lua
    trunk/lua/net.walk.lua

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Mon Nov 10 03:18:09 2008
@@ -280,7 +280,7 @@
 	local autologin_charname
 	if (gCommandLineSwitches["-co"]) then autologin_charname =3D gCommandLine=
Arguments[gCommandLineSwitches["-co"]+2] end -- autologin
 	for k,v in pairs(charlist.chars) do if (v.name ~=3D "") then
-		if (v.name =3D=3D autologin_charname or autologin_charname =3D=3D "1") t=
hen =

+		if (v.name =3D=3D autologin_charname or tonumber(autologin_charname) =3D=
=3D k + 1) then =

 			local iCharNum =3D k
 			Send_Character_Select(iCharNum,gGameServerAccount)
 			gSelectedCharName =3D v.name

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Mon Nov 10 03:18:09 2008
@@ -157,6 +157,7 @@
 end
 	=

 function WalkGetInterval (bRunFlag)
+	--~ print("WalkGetInterval run,hasmount",bRunFlag,PlayerHasMount())
 	return	( PlayerHasMount() or PlayerHasInreasedMovementSpeed() )
 								and	(	bRunFlag and gWalkTimeout_MountRunningSpeed	or gWalkTimeout_=
MountMovingSpeed) or =

 									(	bRunFlag and gWalkTimeout_RunningSpeed		or gWalkTimeout_MovingS=
peed)
@@ -169,7 +170,7 @@
 =

 -- returns false if the walk queue is full and the next request should wait
 function WalkQueueOkForNextSend ()
-	return countarr(gWalkRequests) <=3D 1
+	return countarr(gWalkRequests) <=3D 3
 end
 	=

 -- internal, don't call directly, no check for walkable, only checks for t=
ime



From no-reply at zwischenwelt.org  Mon Nov 10 04:06:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 10 Nov 2008 03:06:03 -0000
Subject: [Iris-commit] [IRIS] r2712 - /trunk/lua/net/net.trade.lua
Message-ID: <20081110030603.ED98B1C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 10 04:06:03 2008
New Revision: 2712

Log:
npc shop : fixed ordering for uogamers

Modified:
    trunk/lua/net/net.trade.lua

Modified: trunk/lua/net/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.trade.lua (original)
+++ trunk/lua/net/net.trade.lua Mon Nov 10 04:06:03 2008
@@ -125,7 +125,7 @@
 		-- goods are associate with items in container sorted by serial, ascendi=
ng or descending, depending on server Emu
 		local sorteditems =3D {}
 		for k,v in pairs(container:GetContent()) do table.insert(sorteditems,v) =
end
-		if (gPolServer) then
+		if (not gPolServer) then
 			table.sort(sorteditems,CompareSerialAsc)
 		else
 			table.sort(sorteditems,CompareSerialDesc)



From no-reply at zwischenwelt.org  Tue Nov 11 00:54:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 10 Nov 2008 23:54:29 -0000
Subject: [Iris-commit] [IRIS] r2713 - in /trunk/lua: lib.loading.lua main.lua
Message-ID: <20081110235429.EE3F51C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 11 00:54:29 2008
New Revision: 2713

Log:
automatically use 2d mode when no models folder is found instead of crashing

Modified:
    trunk/lua/lib.loading.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Tue Nov 11 00:54:29 2008
@@ -223,6 +223,7 @@
 end
 =

 function Load_Granny () =

+	if (gCurrentRenderer =3D=3D Renderer2D) then return end
 	if (gGrannyLoaderType) then
 		LoadingProfile("init GrannyLoader")
 		gGrannyLoader =3D CreateGrannyLoader(gGrannyLoaderType)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Nov 11 00:54:29 2008
@@ -279,7 +279,9 @@
 	end
 	-- check for character(granny) models
 	if (gCurrentRenderer =3D=3D Renderer3D and (not file_exists( CorrectGrann=
yPath(gGrannyConfigFile) ))) then
-		FatalErrorMessage(sprintf("iris2 could not find character models in your=
 uo dir\n please install AOS or ML (see README)"))
+		gCurrentRenderer =3D Renderer2D
+		print("WARNING ! using 2d mode because iris could not find 3d character =
models in your uo dir (try the ML/Mondains legacy installer linked on http:=
//iris2.de)")
+		--~ FatalErrorMessage(sprintf("iris2 could not find character models in =
your uo dir\n please install AOS or ML (see README)"))
 	end
 end
 =




From no-reply at zwischenwelt.org  Tue Nov 11 19:02:10 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Nov 2008 18:02:10 -0000
Subject: [Iris-commit] [IRIS] r2714 - in /trunk/lua: config_declarations.lua
 gui/gui.popup.lua gui/gui.trade.lua lib.macrolist.lua lib.net.lua
 lib.walking3.lua net/net.dynamic.lua net/net.login.lua net/net.text.lua
 net/net.trade.lua
Message-ID: <20081111180211.EC0B51C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 11 19:02:08 2008
New Revision: 2714

Log:
login reject error messages fixed and extended, shop ordering fix, speech-d=
isable-option fixed (pol), walking diagonal block on uogamers fixed, macro-=
commands for popup menu usage

Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/gui/gui.popup.lua
    trunk/lua/gui/gui.trade.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.net.lua
    trunk/lua/lib.walking3.lua
    trunk/lua/net/net.dynamic.lua
    trunk/lua/net/net.login.lua
    trunk/lua/net/net.text.lua
    trunk/lua/net/net.trade.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Tue Nov 11 19:02:08 2008
@@ -152,6 +152,7 @@
 		gPassword =3D "",		-- Password
 		gLoginServerIP =3D "shard.vetus-mundus.de",
 		gLoginServerPort =3D 2594,
+		gWalkMinDiagonalBlock =3D true,
 		gServerSeed =3D hex2num("0xFFFFFFFF"),
 		gPolServer =3D false
 	}

Modified: trunk/lua/gui/gui.popup.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.popup.lua (original)
+++ trunk/lua/gui/gui.popup.lua Tue Nov 11 19:02:08 2008
@@ -49,7 +49,10 @@
 function DisplayPopupMenu (popupmenu)
 	if (not gGumpLoader) then return end
 	gRunningPopupRequestTimeOut =3D nil
-
+	=

+	-- close old
+	ClosePopUpMenu() =

+	=

 	-- update global entry
 	gPopupMenu =3D popupmenu
 	=


Modified: trunk/lua/gui/gui.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.trade.lua (original)
+++ trunk/lua/gui/gui.trade.lua Tue Nov 11 19:02:08 2008
@@ -1,5 +1,7 @@
 gShop =3D {}
 =

+function CompareContainerContentOrderAsc  (a,b) return (a.container_conten=
t_order or 0) < (b.container_content_order or 0) end
+function CompareContainerContentOrderDesc  (a,b) return (a.container_conte=
nt_order or 0) > (b.container_content_order or 0) end
 function CompareSerialAsc  (a,b) return a.serial < b.serial end
 function CompareSerialDesc (a,b) return a.serial > b.serial end
 =


Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Tue Nov 11 19:02:08 2008
@@ -72,10 +72,29 @@
 function MacroCmd_ToggleHideGUI () GuiToggleHide() Client_RenderOneFrame()=
 end
 =

 =

-
-
-
-
+function MacroCmd_PopupCommandByTag (serial,tag,timeout)
+	local timeout_endt =3D Client_GetTicks() + (timeout or 1000)
+	Send_PopupRequest(serial)
+	Send_PopupAnswer(serial,tag)
+	RegisterListener("Hook_OpenPopupMenu",function (popupmenu)
+		if (popupmenu.serial =3D=3D serial or Client_GetTicks() < timeout_endt) =
then ClosePopUpMenu() end
+		return true
+	end)
+end =

+
+function MacroCmd_PopupCommandByName (serial,name,timeout)
+	local timeout_endt =3D Client_GetTicks() + (timeout or 1000)
+	Send_PopupRequest(serial)
+	RegisterListener("Hook_OpenPopupMenu",function (popupmenu)
+		if (popupmenu.serial =3D=3D serial or Client_GetTicks() < timeout_endt) =
then =

+			for k,entry in pairs(popupmenu.entries) do =

+				if (StringContains(entry.text,name)) then Send_PopupAnswer(popupmenu.s=
erial,entry.tag) break end
+			end
+			ClosePopUpMenu()
+		end =

+		return true
+	end)
+end
 =

 =

 function MacroCmd_SendTargetSerial	(serial) =


Modified: trunk/lua/lib.net.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.net.lua (original)
+++ trunk/lua/lib.net.lua Tue Nov 11 19:02:08 2008
@@ -64,8 +64,7 @@
 	if (not gMainConnection) then return end
 	if gMainConnection and not gMainConnection:IsConnected() then
 		-- TODO handle me
-		print("FATAL ! NetTrafficStep (not connected anymore) -> forced Crash")
-		Crash()
+		FatalErrorMessage("FATAL ! NetTrafficStep (not connected anymore) -> for=
ced Crash")
 	end
 	-- EncodeOut
 	-- TODO : later : encryption for osi here ?

Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Tue Nov 11 19:02:08 2008
@@ -7,6 +7,8 @@
 =

 gMapsWithMobileMovementBlocking =3D { [0]=3Dtrue } -- on felucca, you need=
 full stamina to shove through other mobiles
 =

+gWalkMinDiagonalBlock =3D 1   -- 2 on some run shards (vm) but not all (uo=
gamers:1) , 2 means you can move better through forests for example
+		=

 kPersonHeight				=3D 16
 kStepHeight					=3D 2
 kAlwaysIgnoreDoors			=3D false
@@ -206,7 +208,10 @@
 		local itemsRight	=3D {} W3_ForAllItemsAtPos(xRight	,yRight	,filterItemFu=
n	,itemsRight)
 		local myok1,ignored_z =3D W3_Check( mobile, itemsLeft , xLeft , yLeft , =
startTop, startZ, mobile.CanSwim, mobile.CantWalk)
 		local myok2,ignored_z =3D W3_Check( mobile, itemsRight, xRight, yRight, =
startTop, startZ, mobile.CanSwim, mobile.CantWalk)
-		if ( (not myok1) and (not myok2) ) then  moveIsOk =3D false  end
+		local blockd =3D 0
+		if (not myok1) then blockd =3D blockd + 1 end
+		if (not myok2) then blockd =3D blockd + 1 end
+		if (blockd >=3D gWalkMinDiagonalBlock) then moveIsOk =3D false end
 	end
 =

 	if ( not moveIsOk ) then newZ =3D startZ end

Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Tue Nov 11 19:02:08 2008
@@ -103,6 +103,7 @@
 =

 	for i=3D1,itemcount do
 		local dynamicdata =3D {}
+		dynamicdata.container_content_order =3D i
 		dynamicdata.serial				=3D input:PopNetUint32()
 		dynamicdata.artid_base			=3D input:PopNetUint16()
 		dynamicdata.artid_addstack		=3D input:PopNetUint8()

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Tue Nov 11 19:02:08 2008
@@ -274,44 +274,44 @@
 	--~ StartInGame()
 end
 =

+kLoginRejectReason =3D {}
+kLoginRejectReason.CharNoExist		=3D {code=3D1,text=3D"CharNoExist(characte=
r deleted?)"}
+kLoginRejectReason.CharExists		=3D {code=3D2,text=3D"CharExists(charname t=
aken?)"}
+kLoginRejectReason.CharInWorld		=3D {code=3D5,text=3D"another character is=
 already online"}
+kLoginRejectReason.LoginSyncError	=3D {code=3D6,text=3D"LoginSyncError"}
+kLoginRejectReason.IdleWarning		=3D {code=3D7,text=3D"server is idle"}
+
 -- Loginserver Login rejected - Errorcode returned
-function gPacketHandler.kPacket_Login_Reject()
+function gPacketHandler.kPacket_Login_Reject() -- 0x53
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local value =3D input:PopNetUint8()
-	if (value =3D=3D 5) then
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: another char=
acter is online\n",id))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: another charac=
ter is online") =

-	elseif (value =3D=3D 7) then
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: server is id=
le\n",id))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: server is idle=
") =

-	else
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: %i\n",id,val=
ue))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: " .. value ) =

-	end
-end
-
+	local txt =3D "?"
+	for k,v in pairs(kLoginRejectReason) do if (value =3D=3D v.code) then txt=
 =3D v.text end end
+	local msg =3D sprintf("Login_Reject %d %s",value,txt)
+	print(msg)
+	FatalErrorMessage(msg) =

+end
+
+kAccountLoginRejectReason =3D {}
+kAccountLoginRejectReason.Invalid		=3D {code=3D0x00,text=3D"Invalid userna=
me"}
+kAccountLoginRejectReason.InUse			=3D {code=3D0x01,text=3D"account is alre=
ady in use"}
+kAccountLoginRejectReason.Blocked		=3D {code=3D0x02,text=3D"Banned account=
"}
+kAccountLoginRejectReason.BadPass		=3D {code=3D0x03,text=3D"wrong password=
"}
+kAccountLoginRejectReason.Idle			=3D {code=3D0xFE,text=3D"idle"}
+kAccountLoginRejectReason.BadComm		=3D {code=3D0xFF,text=3D"badcom or ille=
gal username/pw"}
+		=

 -- GameServer Login failed - Errorcode returned
-function gPacketHandler.kPacket_Account_Login_Failed()
+function gPacketHandler.kPacket_Account_Login_Failed() -- 0x82
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local value =3D input:PopNetUint8()
-	if (value =3D=3D 0) then
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: unknown user=
\n",id))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: unknown user") =

-	elseif (value =3D=3D 1) then
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: account is a=
lready in use\n",id))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: account is alr=
eady in use") =

-	elseif (value =3D=3D 2) then
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: account disa=
bled\n",id))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: account disabl=
ed") =

-	elseif (value =3D=3D 3) then
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: account disa=
bled\n",id))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: account disabl=
ed") =

-	else -- 0x04 and higher =3D communications failed
-		printdebug("login",sprintf("NET: Login_Reject id: %i value: communicatio=
ns failed\n",id))
-		GuiAddChatLine("NET: Login_Reject id: " .. id .. " value: communications=
 failed")
-	end
+	=

+	local txt =3D "communications failed"
+	for k,v in pairs(kAccountLoginRejectReason) do if (value =3D=3D v.code) t=
hen txt =3D k.." "..v.text end end
+	local msg =3D sprintf("Account_Login_Failed %d %s",value,txt)
+	print(msg)
+	FatalErrorMessage(msg) =

 end
 =

 -- Server requests Clientversion (NEW?)

Modified: trunk/lua/net/net.text.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.text.lua (original)
+++ trunk/lua/net/net.text.lua Tue Nov 11 19:02:08 2008
@@ -344,7 +344,7 @@
 	local keywords		=3D SpeechParseKeywords(ascistr)
 	local keywordcount	=3D table.getn(keywords)
 	local bEncoded		=3D keywordcount > 0
-	if (gNoSpeechKeyWords) then bEncoded =3D false end -- pre aos pol shards =
? (cloudstrive/zulu)
+	if (gNoSpeechKeyWords) then bEncoded =3D false keywordcount =3D 0 end -- =
pre aos pol shards ? (cloudstrive/zulu)
 	local hue			=3D hex2num("0x34")
 	local font			=3D 0 -- ignored by runuo 1
 	local msgtype		=3D kTextType_Normal + (bEncoded and kTextType_Encoded or =
0)

Modified: trunk/lua/net/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.trade.lua (original)
+++ trunk/lua/net/net.trade.lua Tue Nov 11 19:02:08 2008
@@ -104,7 +104,7 @@
 	local id 		=3D input:PopNetUint8()
 	local size 		=3D input:PopNetUint16()
 	local shop =3D {}
-	shop.shopContainerID 	=3D input:PopNetUint32() -- containerid !
+	shop.shopContainerID 	=3D input:PopNetUint32() -- containerid ! (or vendo=
rserial-1)
 	local oldshop =3D gShop[shop.shopContainerID]
 	if (oldshop) then oldshop:Close() end -- TODO : cancel ?
 	gShop[shop.shopContainerID] =3D shop
@@ -124,10 +124,19 @@
 =

 		-- goods are associate with items in container sorted by serial, ascendi=
ng or descending, depending on server Emu
 		local sorteditems =3D {}
-		for k,v in pairs(container:GetContent()) do table.insert(sorteditems,v) =
end
-		if (not gPolServer) then
+		local allbycontainer_content =3D true
+		for k,v in pairs(container:GetContent()) do =

+			table.insert(sorteditems,v)
+			if (not v.container_content_order) then allbycontainer_content =3D fals=
e end
+		end
+		if (allbycontainer_content) then =

+			print("##SHOP-Sort by content order")
+			table.sort(sorteditems,CompareContainerContentOrderDesc) -- container_c=
ontent_order
+		elseif (gPolServer) then
+			print("##SHOP-Sort asc (pol)")
 			table.sort(sorteditems,CompareSerialAsc)
 		else
+			print("##SHOP-Sort desc (fallback)")
 			table.sort(sorteditems,CompareSerialDesc)
 		end
 		=




From no-reply at zwischenwelt.org  Tue Nov 11 21:50:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Nov 2008 20:50:29 -0000
Subject: [Iris-commit] [IRIS] r2715 - in /trunk: lua/lib.uoutils.lua
 lua/net/net.mobile.lua lua/net/net.text.lua lua/net/net.trade.lua
 lua/obj/obj.mobile.lua lua/obj/obj.player.lua
 lua/widgets/widget.uotooltip.lua plugins/moblist.lua
Message-ID: <20081111205029.E71781C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 11 21:50:28 2008
New Revision: 2715

Log:
uogamers : amount added to tiletype-name-tooltip, net.text handling unified=
, moblist target line name : ??? fixed, exact pos used, color dark if dead/=
out of range,  removed mobile zombie marker code, fixed shopgump crash if o=
ut of sight

Modified:
    trunk/lua/lib.uoutils.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/net/net.text.lua
    trunk/lua/net/net.trade.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/obj/obj.player.lua
    trunk/lua/widgets/widget.uotooltip.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.uoutils.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoutils.lua (original)
+++ trunk/lua/lib.uoutils.lua Tue Nov 11 21:50:28 2008
@@ -51,6 +51,7 @@
 	else return 0 end
 end
 =

+function GetItemTooltipOrLabel (serial) return AosToolTip_GetText(serial) =
or GetItemLabel(serial) end
 =

 -- hack to replace german umlauts by two letters (ae)
 function UnicodeFix (text) =


Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Tue Nov 11 21:50:28 2008
@@ -23,7 +23,6 @@
 	end
 	=

 	local mobile =3D CreateOrUpdateMobile(mobiledata)
-	if (mobile) then mobile:NoZombie() end
 end
 =

 -- Equipped_MOB packet (0x78)
@@ -217,7 +216,7 @@
 =

 	--printf("NET : kPacket_Mobile_Stats mobile=3D0x%08x name=3D%s\n",mobiles=
erial,stats.name)
 	=

-	local mobile =3D GetMobile(mobileserial) if (mobile) then mobile:NoZombie=
() end
+	local mobile =3D GetMobile(mobileserial)
 	Mobile_UpdateStats(mobileserial,stats)
 end
 =


Modified: trunk/lua/net/net.text.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.text.lua (original)
+++ trunk/lua/net/net.text.lua Tue Nov 11 21:50:28 2008
@@ -1,40 +1,195 @@
+gItemLabelCache =3D {} -- gItemLabelCache[serial]=3D{t=3D?,label=3D?}
+
+function GetItemLabel (serial) =

+	local o =3D gItemLabelCache[serial] =

+	return o and o.label
+end
+
+
+-- ***** ***** ***** ***** ***** incoming text
+
+function HandleUOText (data)
+	local mobile =3D GetMobile(data.serial) =

+	local serial =3D data.serial
+	--~ if (data.type =3D=3D kTextType_Label) then ItemLabel(data.serial,text=
_charname,text_message) end
+	=

+	local r,g,b =3D 1,1,1
+	local show_below =3D true	-- display as fadeline
+	local show_journal =3D true	-- display in journal
+	=

+	if data.type =3D=3D kTextType_Normal then	r,g,b =3D 1,1,1 end
+	if data.type =3D=3D kTextType_System then	r,g,b =3D 0,0,1 end
+	if data.type =3D=3D kTextType_Emote then	r,g,b =3D 0,1,0 end
+	if data.type =3D=3D kTextType_Label then =

+		show_journal =3D false =

+		if mobile then
+			show_below =3D false =

+			Mobile_NameHint(data.serial,data.artid,data.name,data.text)
+			r,g,b =3D 1,1,1 =

+		end
+	end	-- 0x06 - System/Lower Corner, label?
+	if data.type =3D=3D kTextType_Corner			 then r,g,b =3D 1,0,0 end	=

+	if data.type =3D=3D kTextType_Whisper			 then r,g,b =3D 1,1,1 end	=

+	if data.type =3D=3D kTextType_Yell				 then r,g,b =3D 1,1,1 end	=

+	if data.type =3D=3D kTextType_Spell				 then r,g,b =3D 0,1,1 end	=

+	if data.type =3D=3D kTextType_Guild				 then r,g,b =3D 0,1,0 end	 =

+	if data.type =3D=3D kTextType_Alliance			 then r,g,b =3D 0,1,0 end	=

+	if data.type =3D=3D kTextType_CommandPrompt		 then r,g,b =3D 1,0,1 end		=

+	=

+	if data.hue then r,g,b =3D Uo16Color2Rgb(data.hue) end
+	=

+	-- update label
+	if data.type =3D=3D kTextType_Label then
+		local label
+		if (beginswith(data.text,data.name)) then =

+			label =3D data.text  -- name=3Dmina plaintext=3Dmina the banker
+		else
+			label =3D data.name .. " " .. data.text -- name=3Dmandrake plaintext=3D=
15  ??? =

+		end
+		gItemLabelCache[serial] =3D {t=3DClient_GetTicks(),label=3Dlabel}
+	else
+		-- no label yet, so use name
+		if (not gItemLabelCache[serial]) then gItemLabelCache[serial] =3D {t=3DC=
lient_GetTicks(),label=3Ddata.name} end
+	end
+	=

+	--[[
+	-- brighten up the color
+	local h,s,v =3D ColorRGB2HSV(r,g,b)
+	v =3D math.min(1,v + gFontDefs["Chat"].brigth)
+	s =3D math.max(0,s - gFontDefs["Chat"].brigth/2)
+	r,g,b =3D ColorHSV2RGB(h,s,v)
+	]]--
+	=

+	=

+	--~ Mobile_NameHint(data.serial,data.artid,data.name,data.text)  -- name =
alone ??
+	=

+	local plaintext =3D UnicodeFix(string.gsub(data.text,"<br>","\n"))
+	=

+	if show_below then
+		if string.len(data.name) > 0 then =

+			GuiAddChatLine(sprintf("%s: %s",data.name,plaintext),{r,g,b,1})
+		else
+			GuiAddChatLine(plaintext,{r,g,b,1})
+		end
+	end
+	=

+	if show_journal then
+		JournalAddText(data.name,plaintext)
+	end
+	=

+	NotifyListener("Hook_Text",data.name,plaintext,data.serial)
+	=

+	if (mobile) then mobile:DisplayTextOverHead(plaintext,r,g,b) end
+	=

+	NotifyListener("Hook_MobName",data.serial,data.name)
+	=

+	=

+	=

+	--~ if (data.serial =3D=3D 0xffffffff and data.artid =3D=3D 0xffff) then =
sysmessage ?? decide by type
+end
+
+-- ***** ***** ***** ***** ***** incoming text packets
 =

 -- Text (Speech) receive 0x1C
 -- Pol use thi spacket to send names when you single click on items or NPC=
s. OSI's method uses 0xC1
 -- TODO : handle System messages
 function gPacketHandler.kPacket_Text ()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local mobile_serial =3D input:PopNetUint32()
-	local text_item_model =3D input:PopNetUint16() -- model ? artid ?
-	local text_type =3D input:PopNetUint8()
-	local text_color =3D input:PopNetUint16()
-	local text_font =3D input:PopNetUint16()
-	local text_charname =3D input:PopFilledString(30)
-	local text_message =3D input:PopFilledString(size-44)
-	=

-	Mobile_NameHint(mobile_serial,text_item_model,text_charname,text_message)
-
-	-- check if System Message
-	if (mobile_serial =3D=3D hex2num("0xffffffff") and text_item_model =3D=3D=
 hex2num("0xffff")) then
-		printdebug("net",sprintf("NET: System Message %s:%s\n",text_charname,tex=
t_message) )
-	end
-
-	printdebug("net",sprintf("NET: Text id: 0x%08x model id: 0x%08x Message: =
%s\n",mobile_serial,text_item_model,text_message) )
-	local plaintext =3D string.gsub(text_message,"<br>","\n")
-	plaintext =3D UnicodeFix(plaintext)
-	GuiAddChatLine(sprintf("%s: %s",text_charname,plaintext)) -- TODO : color=
,font,...
-	JournalAddText(text_charname,plaintext)
-	NotifyListener("Hook_Text",text_charname,plaintext,mobile_serial)
-	=

-	-- check if player -> then show text over player head
-	local mobilespeaker=3DGetMobile(mobile_serial)
-	if (mobilespeaker) then mobilespeaker:NoZombie() mobilespeaker:DisplayTex=
tOverHead(string.gsub(text_message,"<br>","\n"),Uo16Color2Rgb(text_color)) =
end
-	-- TODO : text_item ?!?
-	NotifyListener("Hook_Packet_Text",mobile_serial,plaintext)
-	NotifyListener("Hook_MobName",mobile_serial,text_charname)
-end
+	local input		=3D GetRecvFIFO()
+	local id		=3D input:PopNetUint8()
+	local size		=3D input:PopNetUint16()
+	local data		=3D {}
+	data.serial		=3D input:PopNetUint32()
+	data.artid		=3D input:PopNetUint16()
+	data.type		=3D input:PopNetUint8() -- see "Text types" in lib.uoids.lua
+	data.color		=3D input:PopNetUint16()
+	data.font		=3D input:PopNetUint16()
+	data.name		=3D input:PopFilledString(30)
+	data.text		=3D input:PopFilledString(size-44)
+	HandleUOText(data)
+	NotifyListener("Hook_Packet_Text",data.serial,data.text)
+end
+
+
+-- aka Cliloc Message Affix  : see also http://docs.polserver.com/packets/=
index.php?Packet=3D0xCC
+-- e.g. skilltrainer npc says how much gold he wants
+function gPacketHandler.kPacket_Localized_Text_Plus_String () -- 0xCC
+	local input 	=3D GetRecvFIFO()
+	local id		=3D input:PopNetUint8()	-- 1
+	local size		=3D input:PopNetUint16()	-- 2
+	local data 		=3D {}
+	data.serial		=3D input:PopNetUint32()	-- 4
+	data.artid		=3D input:PopNetUint16()	-- 2
+	data.type		=3D input:PopNetUint8()	-- 1 -- see "Text types" in lib.uoids.=
lua
+	data.hue		=3D input:PopNetUint16()	-- 2
+	data.font		=3D input:PopNetUint16()	-- 2
+	data.clilocid	=3D input:PopNetUint32()	-- 4
+	data.flags		=3D input:PopNetUint8() 	-- 1 (0x02 is unknown, 0x04 signals =
the message doesn't move on screen) =

+	data.name		=3D input:PopFilledString(30)	=

+	=

+	size =3D size - 49
+	local affixlen =3D size
+	for i =3D 0,size-1 do if (input:PeekNetUint8(i) =3D=3D 0) then affixlen =
=3D i + 1 break end end -- search zero terminator
+	=

+	local text_affix =3D input:PopFilledString(affixlen) --  null terminated	=

+	size =3D size - affixlen	=

+	=

+	--~ BYTE[?]*2] arguments; // _big-endian_ unicode string, tabs ('\t') sep=
erate arguments, see 0xC1 for argument example
+	data.params			=3D (size >=3D 2) and strsplit("\t",input:PopUnicodeString(=
size / 2)) or {}
+	data.text 			=3D ParameterizedClilocText(data.clilocid,data.params)
+	=

+	if (TestBit(data.flags,0x01)) then
+		data.text =3D text_affix .. data.text  -- prepend
+	else =

+		data.text =3D data.text .. text_affix  -- appended
+	end
+	HandleUOText(data)
+end
+
+
+-- Predefined Message (localized Message) 0xC1
+function gPacketHandler.kPacket_Localized_Text ()
+	local input		=3D GetRecvFIFO()
+	local id		=3D input:PopNetUint8()
+	local size		=3D input:PopNetUint16()
+	local data 		=3D {}
+	data.serial		=3D input:PopNetUint32()
+	data.artid		=3D input:PopNetUint16()
+	data.type		=3D input:PopNetUint8() -- see "Text types" in lib.uoids.lua
+	data.hue		=3D input:PopNetUint16()
+	data.font		=3D input:PopNetUint16()
+	data.clilocid	=3D input:PopNetUint32()
+	data.name		=3D input:PopFilledString(30)
+	=

+	data.params		=3D strsplit("\t",input:PopUnicodeLEString((size - 48 - 2)/2=
))	--little-endian_ unicode string, tabs ('\t') seperate the arguments. Nul=
l Terminated 0x0000
+	local terminator =3D input:PopNetUint16() -- probably the seperator unico=
de char for text_params, "\t" is hardcoded below, string.char(math.floor(te=
rminator)/256)
+	=

+	data.text 		=3D ParameterizedClilocText(data.clilocid,data.params)
+	=

+	NotifyListener("Hook_Packet_Localized_Text",data.serial,data.text,data.cl=
ilocid,data.type)
+end
+
+--server response packet for kPacket_Speech_Unicode (0xAD)
+function gPacketHandler.kPacket_Text_Unicode()
+	local input	=3D GetRecvFIFO()
+	local id	=3D input:PopNetUint8()
+	local size	=3D input:PopNetUint16()
+	local data 	=3D {}
+	data.serial	=3D input:PopNetUint32()
+	data.artid	=3D input:PopNetUint16()
+	data.type	=3D input:PopNetUint8()
+	data.hue	=3D input:PopNetUint16()	=

+	data.font	=3D input:PopNetUint16()
+	data.lang	=3D input:PopNetUint32() -- ?
+	data.name	=3D input:PopFilledString(30)
+	data.text,data.unicode =3D UniCodeDualPop(input,(size-48)/2)
+	NotifyListener("Hook_Packet_Text_Unicode",data.serial,data.text,data.type)
+	HandleUOText(data)
+end
+
+
+
+
+-- ***** ***** ***** ***** ***** text entry
 =

 =

 -- server requests text entry 0xC2, e.g. rename rune
@@ -106,190 +261,8 @@
 	out:SendPacket()
 end
 =

--- aka Cliloc Message Affix  : see also http://docs.polserver.com/packets/=
index.php?Packet=3D0xCC
--- e.g. skilltrainer npc says how much gold he wants
-function gPacketHandler.kPacket_Localized_Text_Plus_String () -- 0xCC
-	local input =3D GetRecvFIFO()
-	local id				=3D input:PopNetUint8()	-- 1
-	local size				=3D input:PopNetUint16()	-- 2
-	local data =3D {}
-	data.speaker_serial		=3D input:PopNetUint32()	-- 4 (0xffff for system mes=
sage)
-	data.speaker_body		=3D input:PopNetUint16()	-- 2 (0xff for system message)
-	data.speaker_align		=3D input:PopNetUint8()	-- 1 type (6 - lower left, 7 =
on player)
-	data.hue				=3D input:PopNetUint16()	-- 2
-	data.font				=3D input:PopNetUint16()	-- 2
-	data.cliloc_id			=3D input:PopNetUint32()	-- 4
-	data.flags				=3D input:PopNetUint8() 	-- 1
-	data.speaker_name		=3D input:PopFilledString(30)	=

-	size =3D size - 49
-	=

-	local mobile =3D GetMobile(data.speaker_serial) if (mobile) then mobile:N=
oZombie() end
-	-- flags : (0x02 is unknown, 0x04 signals the message doesn't move on scr=
een) =

-	=

-	=

-	local affixlen =3D size
-	for i =3D 0,size-1 do if (input:PeekNetUint8(i) =3D=3D 0) then affixlen =
=3D i + 1 break end end -- search zero terminator
-	=

-	data.affixlen		=3D affixlen	=

-	data.text_affix		=3D input:PopFilledString(affixlen) --  null terminated	=

-	size =3D size - affixlen
-	data.paramlen		=3D size	=

-	=

-	--~ BYTE[?]*2] arguments; // _big-endian_ unicode string, tabs ('\t') sep=
erate arguments, see 0xC1 for argument example
-	data.text_params	=3D (size >=3D 2) and input:PopUnicodeString(size / 2) o=
r ""
-	data.text_base 		=3D gClilocLoader and gClilocLoader:Get(data.cliloc_id) =
or ("unknown_cliloc_"..data.cliloc_id)
-	data.plaintext 		=3D ParameterizedClilocText(data.cliloc_id,strsplit("\t"=
,data.text_params))
-	=

-	if (TestBit(data.flags,0x01)) then
-		data.plaintext =3D data.text_affix .. data.plaintext  -- prepend
-	else =

-		data.plaintext =3D data.plaintext .. data.text_affix  -- appended
-	end
-	=

-	-- todo : this is a hack to get unicode somewhat readable, no real unicod=
e support
-	data.plaintext =3D UnicodeFix(data.plaintext)
-	=

-	-- output
-	=

-	local name =3D data.speaker_name
-	local plaintext =3D data.plaintext
-	=

-	if string.len(name) > 0 then =

-		GuiAddChatLine(sprintf("%s: %s",name,plaintext)) -- TODO : color,font,...
-	else
-		GuiAddChatLine(plaintext) -- TODO : color,font,...
-	end
-	JournalAddText(name,plaintext)
-	NotifyListener("Hook_Text",name,plaintext,data.speaker_serial)
-	NotifyListener("Hook_MobName",data.speaker_serial,name)
-	=

-	--~ print("kPacket_Localized_Text_Plus_String")
-	--~ for k,v in pairs(data) do print("++",k,v) end
-end
-
-
--- Predefined Message (localized Message) 0xC1
-function gPacketHandler.kPacket_Localized_Text ()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local text_item_serial =3D input:PopNetUint32() -- (0xffffffff for system=
 message)
-	local text_item_model =3D input:PopNetUint16() -- (0xffff for system mess=
age)
-	local text_type =3D input:PopNetUint8() -- see "Text types" in lib.uoids.=
lua
-	local text_color =3D input:PopNetUint16()
-	local text_font =3D input:PopNetUint16()
-	local text_messagenum =3D input:PopNetUint32()
-	local text_charname =3D input:PopFilledString(30)
-	local text_params =3D input:PopUnicodeLEString((size - 48 - 2)/2)	--littl=
e-endian_ unicode string, tabs ('\t') seperate the arguments. Null Terminat=
ed 0x0000
-	local text_terminator =3D input:PopNetUint16() -- probably the seperator =
unicode char for text_params, "\t" is hardcoded below, string.char(math.flo=
or(terminator)/256)
-	=

-	local plaintext =3D string.gsub(ParameterizedClilocText(text_messagenum,s=
trsplit("\t",text_params)),"<br>","\n")
-	--~ print("kPacket_Localized_Text",plaintext)
-	=

-	-- TODO : Display as TOOLTIP !
-	plaintext =3D UnicodeFix(plaintext)
-	=

-	local show_below =3D true	-- display as fadeline
-	local show_journal =3D true	-- display in journal
-	=

-	local mobile =3D GetMobile(text_item_serial) if (mobile) then mobile:NoZo=
mbie() end
-	=

-	if text_type =3D=3D kTextType_Label then	-- label
-		show_journal =3D false
-		if GetMobile(text_item_serial) then
-			Mobile_SetName(text_item_serial, text_charname, plaintext)
-			show_below =3D false
-		end
-	end
-	=

-	if show_below then
-		if string.len(text_charname) > 0 then =

-			GuiAddChatLine(sprintf("%s: %s",text_charname,plaintext)) -- TODO : col=
or,font,...
-		else
-			GuiAddChatLine(plaintext) -- TODO : color,font,...
-		end
-	end
-	=

-	if show_journal then
-		JournalAddText(text_charname,plaintext)
-	end
-	=

-	NotifyListener("Hook_Text",text_charname,plaintext,text_item_serial)
-	NotifyListener("Hook_Packet_Localized_Text",text_item_serial,plaintext,te=
xt_messagenum,text_type)
-	NotifyListener("Hook_MobName",text_item_serial,plaintext,text_messagenum)
-	=

-	-- print("###",text_item_serial,text_item_model,text_type,text_color,text=
_charname,text_params,text_terminator)
-end
-
---server response packet for kPacket_Speech_Unicode (0xAD)
-function gPacketHandler.kPacket_Text_Unicode()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local unitext_size =3D input:PopNetUint16()
-	local mobile_serial =3D input:PopNetUint32()
-	local unitext_item_model =3D input:PopNetUint16()
-	local unitext_type =3D input:PopNetUint8()
-	local unitext_hue =3D input:PopNetUint16()	=

-	local unitext_font =3D input:PopNetUint16()
-	local unitext_lang =3D input:PopNetUint32()
-	local unitext_name =3D input:PopFilledString(30)
-	local unitext_message,unitext_message_unicode_charcodes =3D UniCodeDualPo=
p(input,(unitext_size-48)/2)
-
-	local show_below =3D true	-- display as fadeline
-	local show_journal =3D true	-- display in journal
-	=

-	unitext_message =3D UnicodeFix(unitext_message)
-
-	local r,g,b =3D 1,1,1
-	=

-	=

-	if unitext_type =3D=3D kTextType_Normal then r,g,b =3D 1,1,1 end
-	if unitext_type =3D=3D kTextType_System then r,g,b =3D 0,0,1 end
-	if unitext_type =3D=3D kTextType_Emote then r,g,b =3D 0,1,0 end
-	if unitext_type =3D=3D kTextType_Label then =

-		show_journal =3D false =

-		if GetMobile(mobile_serial) then
-			show_below =3D false =

-			Mobile_NameHint(mobile_serial,unitext_item_model,unitext_name,unitext_m=
essage)
-			r,g,b =3D 1,1,1 =

-		end
-	end	-- 0x06 - System/Lower Corner, label?
-	if unitext_type =3D=3D kTextType_Corner			 	 then r,g,b =3D 1,0,0 end	=

-	if unitext_type =3D=3D kTextType_Whisper			 then r,g,b =3D 1,1,1 end	=

-	if unitext_type =3D=3D kTextType_Yell				 then r,g,b =3D 1,1,1 end	=

-	if unitext_type =3D=3D kTextType_Spell				 then r,g,b =3D 0,1,1 end	=

-	if unitext_type =3D=3D kTextType_Guild				 then r,g,b =3D 0,1,0 end	 =

-	if unitext_type =3D=3D kTextType_Alliance			 then r,g,b =3D 0,1,0 end	=

-	if unitext_type =3D=3D kTextType_CommandPrompt		 then r,g,b =3D 1,0,1 end=
		=

-	=

-	if unitext_hue then r,g,b =3D Uo16Color2Rgb(unitext_hue) end
-	=

-	-- brighten up the color
-	local h,s,v =3D ColorRGB2HSV(r,g,b)
-	v =3D math.min(1,v + gFontDefs["Chat"].brigth)
-	s =3D math.max(0,s - gFontDefs["Chat"].brigth/2)
-	r,g,b =3D ColorHSV2RGB(h,s,v)
-	=

-	printdebug("net",sprintf("NET: UnicodeText speakerid: %i name: %s txtsize=
: %i msg: %s\n",mobile_serial,unitext_name,(unitext_size-48)/2,unitext_mess=
age) )
-
-	if show_below then =

-		GuiAddChatLine(unitext_name..": "..string.gsub(unitext_message,"<br>","\=
n"),{r,g,b,1}) -- TODO : unicode
-	end
-	if show_journal then
-		JournalAddText(unitext_name,unitext_message)
-	end
-	=

-	NotifyListener("Hook_Text",unitext_name,unitext_message,mobile_serial)
-	=

-	NotifyListener("Hook_Packet_Text_Unicode",mobile_serial,unitext_message,u=
nitext_type)
-	NotifyListener("Hook_MobName",mobile_serial,unitext_name)
-
-	-- check if player -> then show text over player head
-	local mobilespeaker=3DGetMobile(mobile_serial)
-	if (mobilespeaker) then mobilespeaker:NoZombie() end
-	if (mobilespeaker and show_below) then mobilespeaker:DisplayTextOverHead(=
string.gsub(unitext_message,"<br>","\n"),Uo16Color2Rgb(unitext_hue)) end
-end
-
+
+-- ***** ***** ***** ***** ***** char profile
 =

 -- request profile 0xB8
 function Send_RequestCharacterProfile()
@@ -316,6 +289,8 @@
 	GuiAddChatLine ("Character Profile:"..data.title..","..data.pstatic_plain=
text..","..data.p_plaintext)
 end
 =

+
+-- ***** ***** ***** ***** ***** send speech
 =

 -- TODO : at first check speech.mul keywords and send them to server
 function Send_Speech(speech)

Modified: trunk/lua/net/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.trade.lua (original)
+++ trunk/lua/net/net.trade.lua Tue Nov 11 21:50:28 2008
@@ -105,6 +105,10 @@
 	local size 		=3D input:PopNetUint16()
 	local shop =3D {}
 	shop.shopContainerID 	=3D input:PopNetUint32() -- containerid ! (or vendo=
rserial-1)
+	=

+	local shopContainerItem =3D GetObjectBySerial(shop.shopContainerID)
+	if (shopContainerItem and shopContainerItem.mobile) then shop.shopMobileI=
D =3D shopContainerItem.mobile.serial end
+	=

 	local oldshop =3D gShop[shop.shopContainerID]
 	if (oldshop) then oldshop:Close() end -- TODO : cancel ?
 	gShop[shop.shopContainerID] =3D shop
@@ -193,6 +197,7 @@
 	local out =3D GetSendFIFO()
 	local numitems =3D goods and table.getn(goods) or 0
 	local shopMobileID =3D GetShopMobileID(shop)
+	if (not shopMobileID) then return end
 	printdebug("net",sprintf("SendBuyAccept : numitems=3D%d shopContainerID=
=3D0x%08x mobileserial=3D0x%08x\n",numitems,shop.shopContainerID,shopMobile=
ID))
 	local len =3D 8 + (numitems * 7)
 	out:PushNetUint8(kPacket_Accept_Offer)
@@ -218,6 +223,7 @@
 	local out =3D GetSendFIFO()
 	local numitems =3D goods and table.getn(goods) or 0
 	local shopMobileID =3D GetShopMobileID(shop)
+	if (not shopMobileID) then return end
 	printdebug("net",sprintf("SendSellAccept : numitems=3D%d mobileserial=3D0=
x%08x\n",numitems,shopMobileID))
 	local len =3D 9 + (numitems * 6)
 	out:PushNetUint8(kPacket_Shop_Offer)

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Tue Nov 11 21:50:28 2008
@@ -114,29 +114,6 @@
 =

 function gMobilePrototype:SetNotoriety(notoriety) self.notoriety =3D notor=
iety end -- also written by other means, don't use for notify, only used fo=
r walk-ack
 =

--- see gUpdateRange_MobileZombie  (hide to prevent desync with server for =
dead mobs)
-function gMobilePrototype:NoZombie	() self:SetZombie(false) end -- mark as=
 alive, triggered by chat/label or naked-mob/mob-move
-function gMobilePrototype:SetZombie	(bZombie,t)
-	--~ t =3D t or Client_GetTicks()
-	--~ -- print("mobile:SetZombie",self.serial,bZombie,((self.iZombiePingCou=
nt or 0) >=3D 1 and bZombie) and "KILLED" or "")
-	--~ if (self.bZombie ~=3D bZombie) then =

-		--~ self.bZombie =3D bZombie
-		--~ if (not bZombie) then self.iZombiePingCount =3D 0 end
-		--~ gCurrentRenderer:MobileSetVisible(self,not bZombie)
-	--~ end
-	--~ if (bZombie and t > (self.iZombieNextPing or 0)) then
-		--~ local oldpingc =3D self.iZombiePingCount or 0
-		--~ if (oldpingc >=3D 1) then =

-			--~ self:Destroy() -- click timeout -> kill
-		--~ else
-			--~ self.iZombiePingCount =3D oldpingc + 1
-			--~ self.iZombieNextPing =3D t + 3000
-			--~ Send_SingleClick(self.serial)
-			--~ -- Send_ClientQuery(gRequest_States,self.serial)
-		--~ end
-	--~ end
-end
-
 function gMobilePrototype:GetSqDistToPos (xloc,yloc)
 	local dx =3D self.xloc - xloc
 	local dy =3D self.yloc - yloc

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Tue Nov 11 21:50:28 2008
@@ -157,8 +157,6 @@
 	for k,mobile in pairs(GetMobileList()) do =

 		if (IsOutsideRange(mobile.xloc,mobile.yloc,player_xloc,player_yloc,range=
_destroy)) then
 			DestroyObjectBySerial(mobile.serial)
-		elseif (IsOutsideRange(mobile.xloc,mobile.yloc,player_xloc,player_yloc,r=
ange_zombie)) then =

-			mobile:SetZombie(true,t)
 		end =

 	end
 end

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Tue Nov 11 21:50:28 2008
@@ -76,7 +76,10 @@
 			else
 				local item =3D GetDynamic(serial)
 				local artid =3D item and item.artid
-				if (artid) then tooltiptext =3D GetStaticTileTypeName(artid) end
+				if (artid) then =

+					tooltiptext =3D string.gsub(GetStaticTileTypeName(artid) or "","%%s%%=
","") =

+					if (item.amount > 0) then tooltiptext =3D item.amount .. " " .. toolt=
iptext end
+				end
 			end
 		end
 	end

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Tue Nov 11 21:50:28 2008
@@ -172,7 +172,7 @@
 	if (self.maintarget_serial) then
 		gfx:SetVisible(true)
 		gfx2:SetVisible(true)
-		name =3D name or MobListShortenName(AosToolTip_GetText(serial) or "???")
+		name =3D name or MobListShortenName(GetItemTooltipOrLabel(serial) or "??=
?")
 		gfx:SetText(name)
 		MacroSetLastTarget(serial)
 	else
@@ -204,7 +204,7 @@
 		local xloc,yloc,zloc
 		local bInRange =3D true
 		if (mobile) then =

-			xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
+			xloc,yloc,zloc =3D gCurrentRenderer:GetExactMobilePos(mobile)
 			self.maintarget_last_xloc =3D xloc
 			self.maintarget_last_yloc =3D yloc
 			self.maintarget_last_zloc =3D zloc
@@ -229,6 +229,7 @@
 		local y =3D max(miny,min(maxy,(py or 0)))
 		local x2 =3D x*fi + f*gViewportW*0.5
 		local y2 =3D y*fi + f*gViewportH*0.5
+		if (bInRange) then gfx2:SetColParam(1,0,0) else gfx2:SetColParam(0.2,0,0=
) end
 		gfx2:SetLineList({{x2,y2,0,x,y,0}})
 	end
 end



From no-reply at zwischenwelt.org  Tue Nov 11 22:08:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Nov 2008 21:08:35 -0000
Subject: [Iris-commit] [IRIS] r2716 - in /trunk: lua/lib.corpse.lua
 lua/widgets/widget.uotooltip.lua plugins/moblist.lua
Message-ID: <20081111210836.10BB91C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 11 22:08:35 2008
New Revision: 2716

Log:
uogamers : moblist names : added job if available.  amount tooltip fix

Modified:
    trunk/lua/lib.corpse.lua
    trunk/lua/widgets/widget.uotooltip.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.corpse.lua (original)
+++ trunk/lua/lib.corpse.lua Tue Nov 11 22:08:35 2008
@@ -2,6 +2,7 @@
 -- see also net.corpse.lua
 =

 kCorpseDynamicArtID =3D 0x2006
+kBonesDynamicArtID =3D 0xeca
 =

 =

 --[[

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Tue Nov 11 22:08:35 2008
@@ -78,7 +78,9 @@
 				local artid =3D item and item.artid
 				if (artid) then =

 					tooltiptext =3D string.gsub(GetStaticTileTypeName(artid) or "","%%s%%=
","") =

-					if (item.amount > 0) then tooltiptext =3D item.amount .. " " .. toolt=
iptext end
+					if (item.amount > 1 and =

+						item.artid ~=3D kCorpseDynamicArtID and =

+						item.artid ~=3D kBonesDynamicArtID) then tooltiptext =3D item.amount=
 .. " " .. tooltiptext end
 				end
 			end
 		end

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Tue Nov 11 22:08:35 2008
@@ -49,7 +49,7 @@
 function gWidgetPrototype.UOMobList:UpdatePartyNameTooltip	(serial)
 	local widget =3D self.partyWidgetList[serial]
 	if (not widget) then return end
-	widget.name =3D MobListShortenName(AosToolTip_GetText(serial) or "???+")
+	widget.name =3D MobListShortenName(GetItemTooltipOrLabel(serial) or "???+=
")
 	widget:SetText(widget.name)
 end
 =

@@ -59,7 +59,7 @@
 	for serial,v in pairs(partylist) do
 		local widget =3D partyWidgetList[serial]
 		if ((not widget) and serial ~=3D GetPlayerSerial()) then
-			local name =3D MobListShortenName(AosToolTip_GetText(serial) or "???#")
+			local name =3D MobListShortenName(GetItemTooltipOrLabel(serial) or "???=
#")
 			widget =3D gRootWidget.tooltip:CreateChild("UOText",{x=3D0,y=3D0,text=
=3Dname,col=3D{r=3D0,g=3D1,b=3D0},bold=3Dtrue})
 			widget.name =3D name
 			partyWidgetList[serial] =3D widget
@@ -267,7 +267,7 @@
 =

 function gWidgetPrototype.UOMobListItem:UpdateName(name,clilocid)
 	if (name and (not self.lowname)) then self.lowname =3D name self.nameclil=
oc =3D clilocid end
-	local tooltip =3D AosToolTip_GetText(self.serial)
+	local tooltip =3D GetItemTooltipOrLabel(self.serial)
 	local text =3D tooltip or self.lowname
 	self.bNameUnknown =3D false
 	if (not text) then self.bNameUnknown =3D true text =3D "unknown" end



From no-reply at zwischenwelt.org  Tue Nov 11 23:57:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 11 Nov 2008 22:57:49 -0000
Subject: [Iris-commit] [IRIS] r2717 - in /trunk/lua: config_declarations.lua
 lib.uoutils.lua net/net.partysystem.lua net/net.text.lua
Message-ID: <20081111225750.690151C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 11 23:57:49 2008
New Revision: 2717

Log:
fixed textcoloring (hue id instead of 16bit col), vm config fix, party gump=
 mobile labels as fallback if there is no tooltip (uogamers)

Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/lib.uoutils.lua
    trunk/lua/net/net.partysystem.lua
    trunk/lua/net/net.text.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Tue Nov 11 23:57:49 2008
@@ -152,7 +152,7 @@
 		gPassword =3D "",		-- Password
 		gLoginServerIP =3D "shard.vetus-mundus.de",
 		gLoginServerPort =3D 2594,
-		gWalkMinDiagonalBlock =3D true,
+		gWalkMinDiagonalBlock =3D 2,
 		gServerSeed =3D hex2num("0xFFFFFFFF"),
 		gPolServer =3D false
 	}

Modified: trunk/lua/lib.uoutils.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoutils.lua (original)
+++ trunk/lua/lib.uoutils.lua Tue Nov 11 23:57:49 2008
@@ -44,6 +44,12 @@
 	else return 0 end
 end
 =

+-- use this instead of Uo16Color2Rgb
+-- returns r,g,b =

+function GetHueColor (hue)
+	if (gHueLoader) then return gHueLoader:GetColor(hue,31) end
+	return 1,1,1
+end
 =

 function GetDirY (dir) =

 	if (dir =3D=3D 0 or dir =3D=3D 1 or dir =3D=3D 7) then return -1 -- north

Modified: trunk/lua/net/net.partysystem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.partysystem.lua (original)
+++ trunk/lua/net/net.partysystem.lua Tue Nov 11 23:57:49 2008
@@ -43,7 +43,7 @@
 function PartySystem_UpdateMemberList (memberlist)
 	gPartySystemMemberList =3D memberlist
 	gPartySystemMemberListByID =3D {}
-	for k,serial in pairs(gPartySystemMemberList) do AosToolTip_GetText(seria=
l) gPartySystemMemberListByID[serial] =3D true end
+	for k,serial in pairs(gPartySystemMemberList) do AosToolTip_GetText(seria=
l) Send_SingleClick(serial) gPartySystemMemberListByID[serial] =3D true end
 	PartyListDialog_Rebuild()
 	NotifyListener("Hook_UpdatePartyMemberList")
 end
@@ -183,7 +183,7 @@
 	local speakerID =3D input:PopNetUint32()
 	size =3D size - 4
 	local mobile =3D GetMobile(speakerID)
-	local name =3D AosToolTip_GetText(speakerID) or (mobile and mobile.name) =
or ("unknown"..speakerID)
+	local name =3D GetItemTooltipOrLabel(speakerID) or (mobile and mobile.nam=
e) or ("unknown"..speakerID)
 	name =3D UOShortenName(name)
 	print("partysystem:test message",speakerID,name, input, size)
 	local plaintext,unicodebytearr,size =3D FIFO_PopZeroTerminatedUnicode(inp=
ut,size)

Modified: trunk/lua/net/net.text.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.text.lua (original)
+++ trunk/lua/net/net.text.lua Tue Nov 11 23:57:49 2008
@@ -36,7 +36,7 @@
 	if data.type =3D=3D kTextType_Alliance			 then r,g,b =3D 0,1,0 end	=

 	if data.type =3D=3D kTextType_CommandPrompt		 then r,g,b =3D 1,0,1 end		=

 	=

-	if data.hue then r,g,b =3D Uo16Color2Rgb(data.hue) end
+	if data.hue then r,g,b =3D GetHueColor(data.hue-1) end
 	=

 	-- update label
 	if data.type =3D=3D kTextType_Label then
@@ -52,14 +52,11 @@
 		if (not gItemLabelCache[serial]) then gItemLabelCache[serial] =3D {t=3DC=
lient_GetTicks(),label=3Ddata.name} end
 	end
 	=

-	--[[
 	-- brighten up the color
-	local h,s,v =3D ColorRGB2HSV(r,g,b)
-	v =3D math.min(1,v + gFontDefs["Chat"].brigth)
-	s =3D math.max(0,s - gFontDefs["Chat"].brigth/2)
-	r,g,b =3D ColorHSV2RGB(h,s,v)
-	]]--
-	=

+	--~ local h,s,v =3D ColorRGB2HSV(r,g,b)
+	--~ v =3D math.min(1,v + gFontDefs["Chat"].brigth)
+	--~ s =3D math.max(0,s - gFontDefs["Chat"].brigth/2)
+	--~ r,g,b =3D ColorHSV2RGB(h,s,v)
 	=

 	--~ Mobile_NameHint(data.serial,data.artid,data.name,data.text)  -- name =
alone ??
 	=

@@ -83,6 +80,7 @@
 	=

 	NotifyListener("Hook_MobName",data.serial,data.name)
 	=

+	print("HandleUOText",sprintf("0x%02x",data.packet or 0),data.type,data.na=
me,plaintext)
 	=

 	=

 	--~ if (data.serial =3D=3D 0xffffffff and data.artid =3D=3D 0xffff) then =
sysmessage ?? decide by type
@@ -97,7 +95,7 @@
 	local input		=3D GetRecvFIFO()
 	local id		=3D input:PopNetUint8()
 	local size		=3D input:PopNetUint16()
-	local data		=3D {}
+	local data		=3D {packet=3Did}
 	data.serial		=3D input:PopNetUint32()
 	data.artid		=3D input:PopNetUint16()
 	data.type		=3D input:PopNetUint8() -- see "Text types" in lib.uoids.lua
@@ -116,7 +114,7 @@
 	local input 	=3D GetRecvFIFO()
 	local id		=3D input:PopNetUint8()	-- 1
 	local size		=3D input:PopNetUint16()	-- 2
-	local data 		=3D {}
+	local data 		=3D {packet=3Did}
 	data.serial		=3D input:PopNetUint32()	-- 4
 	data.artid		=3D input:PopNetUint16()	-- 2
 	data.type		=3D input:PopNetUint8()	-- 1 -- see "Text types" in lib.uoids.=
lua
@@ -151,7 +149,7 @@
 	local input		=3D GetRecvFIFO()
 	local id		=3D input:PopNetUint8()
 	local size		=3D input:PopNetUint16()
-	local data 		=3D {}
+	local data 		=3D {packet=3Did}
 	data.serial		=3D input:PopNetUint32()
 	data.artid		=3D input:PopNetUint16()
 	data.type		=3D input:PopNetUint8() -- see "Text types" in lib.uoids.lua
@@ -173,7 +171,7 @@
 	local input	=3D GetRecvFIFO()
 	local id	=3D input:PopNetUint8()
 	local size	=3D input:PopNetUint16()
-	local data 	=3D {}
+	local data 	=3D {packet=3Did}
 	data.serial	=3D input:PopNetUint32()
 	data.artid	=3D input:PopNetUint16()
 	data.type	=3D input:PopNetUint8()



From no-reply at zwischenwelt.org  Wed Nov 12 03:01:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 02:01:59 -0000
Subject: [Iris-commit] [IRIS] r2718 - in /trunk: lua/gui/gui.trade.lua
 lua/lib.corpse.lua lua/net/net.generic.lua lua/net/net.text.lua
 lua/widgets/widget.uotooltip.lua plugins/lib.spellbar.lua
Message-ID: <20081112020200.32FA51C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 03:01:58 2008
New Revision: 2718

Log:
detect snoop and steal attempts, improved 2d text display, shop : hold ctrl=
 for inc/dec in 10ths, corpse-skeleton ids, mobile tooltip fixed for uogame=
rs (guildtag), uogamers/preaos text/label fixes and guildtag detection, tex=
t hue fix

Modified:
    trunk/lua/gui/gui.trade.lua
    trunk/lua/lib.corpse.lua
    trunk/lua/net/net.generic.lua
    trunk/lua/net/net.text.lua
    trunk/lua/widgets/widget.uotooltip.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/gui/gui.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.trade.lua (original)
+++ trunk/lua/gui/gui.trade.lua Wed Nov 12 03:01:58 2008
@@ -32,6 +32,7 @@
 =

 function ShopAddToBill (shop,good,amount)
 	amount =3D amount or 1
+	if (gKeyPressed[key_lcontrol]) then amount =3D 10 end
 	local newamount =3D math.max(0,math.min(good.itemamount,good.tradeamount =
+ amount))
 	if (gKeyPressed[key_lshift]) then newamount =3D good.itemamount end
 	if (good.tradeamount ~=3D newamount) then

Modified: trunk/lua/lib.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.corpse.lua (original)
+++ trunk/lua/lib.corpse.lua Wed Nov 12 03:01:58 2008
@@ -1,9 +1,15 @@
 -- handles special cases for corpses
 -- see also net.corpse.lua
 =

-kCorpseDynamicArtID =3D 0x2006
-kBonesDynamicArtID =3D 0xeca
+kCorpseDynamicArtID 		=3D 0x2006
+kBonesDynamicArtID_First	=3D 0xeca
+kBonesDynamicArtID_Last		=3D 0xecf
 =

+
+function IsCorpseArtID (artid)
+	return	artid =3D=3D kCorpseDynamicArtID or
+			(artid >=3D kBonesDynamicArtID_First and artid <=3D kBonesDynamicArtID_=
Last)
+end
 =

 --[[
 kPacket_Equipped_MOB

Modified: trunk/lua/net/net.generic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.generic.lua (original)
+++ trunk/lua/net/net.generic.lua Wed Nov 12 03:01:58 2008
@@ -84,7 +84,7 @@
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local subcmd =3D input:PopNetUint16()
-	--~ printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D=
%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
+	if (gNetGenericCmdDebug) then printf("NET: kPacket_Generic_Command size=
=3D0x%04x subcmd=3D0x%04x=3D%s\n",size,subcmd,tostring(gGenericSubCommandNa=
mesByID[subcmd])) end
 	printdebug("net",sprintf("NET: kPacket_Generic_Command size=3D0x%04x subc=
md=3D0x%04x=3D%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd=
])))
 =

 	-- FastWalkInit : 6 keys (runuo's fifosize 0-255)

Modified: trunk/lua/net/net.text.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.text.lua (original)
+++ trunk/lua/net/net.text.lua Wed Nov 12 03:01:58 2008
@@ -1,8 +1,9 @@
 gItemLabelCache =3D {} -- gItemLabelCache[serial]=3D{t=3D?,label=3D?}
+gItemGuildLabelCache =3D {}
 =

 function GetItemLabel (serial) =

 	local o =3D gItemLabelCache[serial] =

-	return o and o.label
+	return o and o.label and (o.label..(gItemGuildLabelCache[serial] or ""))
 end
 =

 =

@@ -14,19 +15,15 @@
 	--~ if (data.type =3D=3D kTextType_Label) then ItemLabel(data.serial,text=
_charname,text_message) end
 	=

 	local r,g,b =3D 1,1,1
-	local show_below =3D true	-- display as fadeline
-	local show_journal =3D true	-- display in journal
+	local bIsLabel =3D false
 	=

 	if data.type =3D=3D kTextType_Normal then	r,g,b =3D 1,1,1 end
 	if data.type =3D=3D kTextType_System then	r,g,b =3D 0,0,1 end
 	if data.type =3D=3D kTextType_Emote then	r,g,b =3D 0,1,0 end
 	if data.type =3D=3D kTextType_Label then =

-		show_journal =3D false =

-		if mobile then
-			show_below =3D false =

-			Mobile_NameHint(data.serial,data.artid,data.name,data.text)
-			r,g,b =3D 1,1,1 =

-		end
+		bIsLabel =3D true
+		if mobile then Mobile_NameHint(data.serial,data.artid,data.name,data.tex=
t) end
+		r,g,b =3D 1,1,1 =

 	end	-- 0x06 - System/Lower Corner, label?
 	if data.type =3D=3D kTextType_Corner			 then r,g,b =3D 1,0,0 end	=

 	if data.type =3D=3D kTextType_Whisper			 then r,g,b =3D 1,1,1 end	=

@@ -38,19 +35,27 @@
 	=

 	if data.hue then r,g,b =3D GetHueColor(data.hue-1) end
 	=

+	=

 	-- update label
-	if data.type =3D=3D kTextType_Label then
-		local label
-		if (beginswith(data.text,data.name)) then =

-			label =3D data.text  -- name=3Dmina plaintext=3Dmina the banker
-		else
-			label =3D data.name .. " " .. data.text -- name=3Dmandrake plaintext=3D=
15  ??? =

-		end
+	=

+	if (data.type =3D=3D kTextType_Label) then
+		local label =3D data.text -- name=3Dmina plaintext=3Dmina the banker =

+		if ((not beginswith(data.text,data.name)) and =

+			(not beginswith(data.text,"Lord "..data.name)) and =

+			(not beginswith(data.text,"Lady "..data.name)) ) then label =3D data.na=
me .. " " .. data.text end  -- name=3Dmandrake plaintext=3D15  ??? =

 		gItemLabelCache[serial] =3D {t=3DClient_GetTicks(),label=3Dlabel}
 	else
 		-- no label yet, so use name
 		if (not gItemLabelCache[serial]) then gItemLabelCache[serial] =3D {t=3DC=
lient_GetTicks(),label=3Ddata.name} end
 	end
+	if (data.type =3D=3D kTextType_Normal and beginswith(data.text,"[")) then =

+		bIsLabel =3D true
+		data.bIsGuildTagLabel =3D true =

+		gItemGuildLabelCache[serial] =3D data.text =

+	end -- guild tag
+	=

+	local show_below =3D not bIsLabel	-- display as fadeline
+	local show_journal =3D not bIsLabel	-- display in journal
 	=

 	-- brighten up the color
 	--~ local h,s,v =3D ColorRGB2HSV(r,g,b)
@@ -74,15 +79,15 @@
 		JournalAddText(data.name,plaintext)
 	end
 	=

-	NotifyListener("Hook_Text",data.name,plaintext,data.serial)
-	=

-	if (mobile) then mobile:DisplayTextOverHead(plaintext,r,g,b) end
+	NotifyListener("Hook_Text",data.name,plaintext,data.serial,data)
+	=

+	if (mobile and (not bIsLabel)) then mobile:DisplayTextOverHead(plaintext,=
r,g,b) end
 	=

 	NotifyListener("Hook_MobName",data.serial,data.name)
 	=

-	print("HandleUOText",sprintf("0x%02x",data.packet or 0),data.type,data.na=
me,plaintext)
-	=

-	=

+	if (gDebugUOTextMessages and (not data.bIsGuildTagLabel) and (data.type ~=
=3D kTextType_Label)) then =

+		print("HandleUOText",sprintf("0x%02x",data.packet or 0),data.type,data.n=
ame,plaintext)
+	end
 	--~ if (data.serial =3D=3D 0xffffffff and data.artid =3D=3D 0xffff) then =
sysmessage ?? decide by type
 end
 =

@@ -99,7 +104,7 @@
 	data.serial		=3D input:PopNetUint32()
 	data.artid		=3D input:PopNetUint16()
 	data.type		=3D input:PopNetUint8() -- see "Text types" in lib.uoids.lua
-	data.color		=3D input:PopNetUint16()
+	data.hue		=3D input:PopNetUint16()
 	data.font		=3D input:PopNetUint16()
 	data.name		=3D input:PopFilledString(30)
 	data.text		=3D input:PopFilledString(size-44)

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Wed Nov 12 03:01:58 2008
@@ -68,7 +68,7 @@
 	local tooltiptext =3D self.params.text
 	local serial =3D self.params.serial
 	if (serial) then =

-		tooltiptext =3D AosToolTip_GetText(serial)
+		tooltiptext =3D GetItemTooltipOrLabel(serial)
 		if (not tooltiptext) then
 			local mobile =3D GetMobile(serial)
 			if (mobile) then =

@@ -78,9 +78,7 @@
 				local artid =3D item and item.artid
 				if (artid) then =

 					tooltiptext =3D string.gsub(GetStaticTileTypeName(artid) or "","%%s%%=
","") =

-					if (item.amount > 1 and =

-						item.artid ~=3D kCorpseDynamicArtID and =

-						item.artid ~=3D kBonesDynamicArtID) then tooltiptext =3D item.amount=
 .. " " .. tooltiptext end
+					if (item.amount > 1 and (not IsCorpseArtID(item.artid))) then tooltip=
text =3D item.amount .. " " .. tooltiptext end
 				end
 			end
 		end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Wed Nov 12 03:01:58 2008
@@ -90,17 +90,29 @@
 end
      =

 =

-RegisterListener("Hook_Packet_Text_Unicode",	function (serial,plaintext,te=
xttype)  -- kPacket_Text_Unicode
-	local r,g,b =3D 1,1,0 -- yellow
-	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
-	--~ print("Hook_Packet_Text_Unicode",serial,plaintext) =

-end)
-RegisterListener("Hook_Packet_Text",			function (serial,plaintext)  -- kPa=
cket_Text
-	local r,g,b =3D 1,1,0 -- yellow
+RegisterListener("Hook_Text",function (name,plaintext,serial,data)
+	if (data.packet =3D=3D kPacket_Localized_Text) then return end
+	if (data.type =3D=3D kTextType_Label) then return end -- label
+	if (data.bIsGuildTagLabel) then return end -- guildtag
+	local r,g,b =3D GetHueColor(data.hue-1)
 	local spellname =3D GetSpellNameFromMantra(plaintext)
 	if (spellname) then plaintext =3D spellname r,g,b =3D 0.5,0.5,0.5 end
+		=

 	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
-	--~ print("Hook_Packet_Text",serial,plaintext) =

+	if (serial =3D=3D 0xffffffff) then
+		local a,b,attacker,victim =3D string.find(plaintext,"You notice (.+) att=
empting to peek into (.+)'s belongings.")
+		if (attacker) then =

+			local bOnSelf =3D StringContains(victim,GetPlayerName() or "?") if (bOn=
Self) then r,g,b =3D 1,0,0 else r,g,b =3D 1,0.5,0 end
+			SpellBarRiseTextOnMob(GetPlayerSerial(),r,g,b,sprintf("SNOOP %s:%s",att=
acker,victim))
+			NotifyListener("Hook_Notice_Snoop",attacker,victim,bOnSelf)
+		end
+		local a,b,attacker,victim =3D string.find(plaintext,"You notice (.+) try=
ing to steal from (.+).")
+		if (attacker) then =

+			local bOnSelf =3D StringContains(victim,GetPlayerName() or "?") if (bOn=
Self) then r,g,b =3D 1,0,0 else r,g,b =3D 1,0.5,0 end
+			SpellBarRiseTextOnMob(GetPlayerSerial(),r,g,b,sprintf("STEAL %s:%s",att=
acker,victim))
+			NotifyListener("Hook_Notice_Steal",attacker,victim,bOnSelf)
+		end
+	end
 end)
 =

 RegisterListener("Mobile_UpdateMana",			function (mobile,oldcur,oldmax,cur=
value,maxvalue)
@@ -145,8 +157,9 @@
 gSpellbarShortMessages[500113] =3D {r=3D0.5,g=3D0,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

 gSpellbarShortMessages[501942] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"locatio=
n blocked"	} -- That location is blocked.           =

 gSpellbarShortMessages[500119] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"actionw=
ait"		} -- You must wait to perform another action.     =

-gSpellbarShortMessages[500118] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"skillwa=
it"		} -- You must wait a few moments to use another skill.  =

+gSpellbarShortMessages[500118] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"skillwa=
it"			} -- You must wait a few moments to use another skill.  =

 gSpellbarShortMessages[500446] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"too far=
"			} -- That is too far away. =

+gSpellbarShortMessages[500616] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"peace"	=
			} -- You hear lovely music, and forget to continue battling!
  =

 gSpellbarShortMessages[1019043] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"!!shov=
e-invis!!" } -- Being perfectly rested, you shove something invisible out o=
f the way.
 =




From no-reply at zwischenwelt.org  Wed Nov 12 13:35:24 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 12:35:24 -0000
Subject: [Iris-commit] [IRIS] r2719 - in /trunk: lua/lib.macrolist.lua
 lua/obj/obj.dynamic.lua lua/obj/obj.player.lua
 lua/widgets/widget.gumpdialog.lua plugins/lib.spellbar.lua
Message-ID: <20081112123524.79FFD1C187DC@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 13:35:23 2008
New Revision: 2719

Log:
added MacroCmd_UseRuneBookPreAOS MacroCmd_Item_FindNearByArtID

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/obj/obj.dynamic.lua
    trunk/lua/obj/obj.player.lua
    trunk/lua/widgets/widget.gumpdialog.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Wed Nov 12 13:35:23 2008
@@ -154,6 +154,20 @@
 end
 =

 =

+function MacroCmd_UseRuneBookPreAOS (runebookid,runeidx,bGate,timeout) -- =
for pre-aos (uogamers)   runeidx:0-15      =

+	Send_DoubleClick(runebookid)
+	MacroCmd_NextGumpContaining("Charges",timeout or 1000,function (dialog) =

+			if (dialog) then =

+				dialog:ShowPage(floor(runeidx/2)+2)
+				local side =3D (runeidx%2)
+				if (bGate) then
+					dialog:SendClick((side =3D=3D 0) and 230 or 390,160) =

+				else	=

+					dialog:SendClick((side =3D=3D 0) and 160 or 320,160) -- recall
+				end
+			end
+		end) =

+end
 =

 =

 =

@@ -293,6 +307,7 @@
 =

 function MacroCmd_Item_FindFirstByName	(itemnamepart,container) local list=
 =3D MacroCmd_Item_FindByName(itemnamepart,container) return list[1] end
 function MacroCmd_Item_FindFirstByArtID	(artid,hue,container) local list =
=3D MacroCmd_Item_FindByArtID(artid,hue,container) return list[1] end
+function MacroCmd_Item_FindFirstNearByArtID	(artid,hue,dist) local list =
=3D MacroCmd_Item_FindNearByArtID(artid,hue,dist) return list[1] end
 =

 -- doesn't sum stack-amount
 function MacroCmd_Item_CountByArtID	(artid,hue,container) local list =3D M=
acroCmd_Item_FindByArtID(artid,hue,container) return list and #list or 0 end
@@ -317,6 +332,17 @@
 	end
 	return res
 end
+
+function MacroCmd_Item_FindNearByArtID	(artid,hue,dist) -- equals easyuo t=
ype
+	local res =3D {}
+	for k,item in pairs(GetDynamicList()) do =

+		if (item.artid =3D=3D artid and (hue =3D=3D nil or hue =3D=3D item.hue) =
and DynamicIsInWorld(item) and =

+			(dist =3D=3D nil or item:GetUODistToPlayer() <=3D dist) ) then
+			table.insert(res,item)
+		end
+	end
+	return res
+end =

 =

 -- container defaults to player-backpack
 -- hue can be nil for any

Modified: trunk/lua/obj/obj.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.dynamic.lua (original)
+++ trunk/lua/obj/obj.dynamic.lua Wed Nov 12 13:35:23 2008
@@ -156,6 +156,8 @@
 end
 =

 function gDynamicPrototype:UpdateContent () self:Update() end
+
+function gDynamicPrototype:GetUODistToPlayer () return GetUODistToPlayer(s=
elf.xloc,self.yloc) end =

 =

 function gDynamicPrototype:Destroy	()
 	self.bDestructionInProgress =3D true

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Wed Nov 12 13:35:23 2008
@@ -137,6 +137,8 @@
 end
 function PlayerHasMount () return PlayerGetMount() ~=3D nil end
 =

+function GetUODistToPlayer(xloc,yloc) return gPlayerXLoc and max(abs(xloc-=
gPlayerXLoc),abs(yloc-gPlayerYLoc)) or 0 end
+
 function IsOutsideRange (xloc,yloc,xloc2,yloc2,range)
 	return abs(xloc - xloc2) > range or abs(yloc - yloc2) > range
 end

Modified: trunk/lua/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.gumpdialog.lua (original)
+++ trunk/lua/widgets/widget.gumpdialog.lua Wed Nov 12 13:35:23 2008
@@ -37,6 +37,7 @@
 end
 =

 function gWidgetPrototype.GumpDialog:SendClick		(relx,rely)
+	if (not self:IsAlive()) then return end
 	local x,y =3D self:GetPos()
 	local widget =3D self:GetWidgetUnderPos(x+relx,y+rely) =

 	if (not widget) then return end
@@ -79,7 +80,7 @@
 -- shows pages 0 and pagenum
 function gWidgetPrototype.GumpDialog:ShowPage	(pagenum) =

 	self.page =3D pagenum
-	for k,page in pairs(self.pages) do page:SetVisible(k =3D=3D 0 or k =3D=3D=
 pagenum) end
+	for k,page in pairs(self.pages) do if (page:IsAlive()) then page:SetVisib=
le(k =3D=3D 0 or k =3D=3D pagenum) end end
 end
 =

 function gWidgetPrototype.GumpDialog:on_mouse_left_down		() self:BringToFr=
ont() self:StartMouseMove() end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Wed Nov 12 13:35:23 2008
@@ -170,6 +170,7 @@
 gSpellbarShortMessages[1060160] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"bleed"=
 			} -- You are bleeding!  (serial=3D0xfff)
 gSpellbarShortMessages[1060757] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"bleeds=
tart" 		} -- You are bleeding profusely  (serial=3Dself=3D899675)
 gSpellbarShortMessages[1060167] =3D {r=3D0.0,g=3D0.5,b=3D0.0,txt=3D"bleeds=
top" 		} -- The bleeding wounds have healed, you are no longer bleeding!
+gSpellbarShortMessages[1042809] =3D {r=3D1,g=3D0.5,b=3D0.0,txt=3D"EscortDo=
ne"			} -- We have arrived! I thank thee, CHARNAME! I have no further need =
of thy services. Here is thy pay.
 =

 --[[
 =




From no-reply at zwischenwelt.org  Wed Nov 12 16:01:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 15:01:08 -0000
Subject: [Iris-commit] [IRIS] r2720 - in /trunk: lua/lib.corpse.lua
 lua/net/net.text.lua lua/widgets/widget.uotooltip.lua
 plugins/itemcounter.lua
Message-ID: <20081112150109.497591C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 16:01:07 2008
New Revision: 2720

Log:
plugin:itemcounter, small fixes, several text fixes (preaos,label/journal)

Added:
    trunk/plugins/itemcounter.lua
Modified:
    trunk/lua/lib.corpse.lua
    trunk/lua/net/net.text.lua
    trunk/lua/widgets/widget.uotooltip.lua

Modified: trunk/lua/lib.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.corpse.lua (original)
+++ trunk/lua/lib.corpse.lua Wed Nov 12 16:01:07 2008
@@ -3,7 +3,7 @@
 =

 kCorpseDynamicArtID 		=3D 0x2006
 kBonesDynamicArtID_First	=3D 0xeca
-kBonesDynamicArtID_Last		=3D 0xecf
+kBonesDynamicArtID_Last		=3D 0xed1
 =

 =

 function IsCorpseArtID (artid)

Modified: trunk/lua/net/net.text.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.text.lua (original)
+++ trunk/lua/net/net.text.lua Wed Nov 12 16:01:07 2008
@@ -54,8 +54,9 @@
 		gItemGuildLabelCache[serial] =3D data.text =

 	end -- guild tag
 	=

-	local show_below =3D not bIsLabel	-- display as fadeline
-	local show_journal =3D not bIsLabel	-- display in journal
+	if (data.clilocid =3D=3D 502006 or data.clilocid =3D=3D 1049608) then bIs=
Label =3D true end -- (tame) (bonded)
+	local show_below =3D (not mobile) or (not bIsLabel)	-- display as fadeline
+	local show_journal =3D (not mobile) or (not bIsLabel)	-- display in journ=
al
 	=

 	-- brighten up the color
 	--~ local h,s,v =3D ColorRGB2HSV(r,g,b)
@@ -78,7 +79,7 @@
 	if show_journal then
 		JournalAddText(data.name,plaintext)
 	end
-	=

+
 	NotifyListener("Hook_Text",data.name,plaintext,data.serial,data)
 	=

 	if (mobile and (not bIsLabel)) then mobile:DisplayTextOverHead(plaintext,=
r,g,b) end
@@ -86,7 +87,7 @@
 	NotifyListener("Hook_MobName",data.serial,data.name)
 	=

 	if (gDebugUOTextMessages and (not data.bIsGuildTagLabel) and (data.type ~=
=3D kTextType_Label)) then =

-		print("HandleUOText",sprintf("0x%02x",data.packet or 0),data.type,data.n=
ame,plaintext)
+		print("HandleUOText",sprintf("0x%02x",data.packet or 0),data.type,bIsLab=
el,data.name,plaintext)
 	end
 	--~ if (data.serial =3D=3D 0xffffffff and data.artid =3D=3D 0xffff) then =
sysmessage ?? decide by type
 end
@@ -169,6 +170,7 @@
 	data.text 		=3D ParameterizedClilocText(data.clilocid,data.params)
 	=

 	NotifyListener("Hook_Packet_Localized_Text",data.serial,data.text,data.cl=
ilocid,data.type)
+	HandleUOText(data)
 end
 =

 --server response packet for kPacket_Speech_Unicode (0xAD)

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Wed Nov 12 16:01:07 2008
@@ -77,7 +77,7 @@
 				local item =3D GetDynamic(serial)
 				local artid =3D item and item.artid
 				if (artid) then =

-					tooltiptext =3D string.gsub(GetStaticTileTypeName(artid) or "","%%s%%=
","") =

+					tooltiptext =3D string.gsub(GetStaticTileTypeName(artid) or "","%%s%%=
",(item.amount > 1) and "s" or "") =

 					if (item.amount > 1 and (not IsCorpseArtID(item.artid))) then tooltip=
text =3D item.amount .. " " .. tooltiptext end
 				end
 			end



From no-reply at zwischenwelt.org  Wed Nov 12 16:27:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 15:27:25 -0000
Subject: [Iris-commit] [IRIS] r2721 - in /trunk: include/data_artmap.h
 lua/lib.data.lua plugins/itemcounter.lua src/data_artmap.cpp
 src/data_artmap_L.cpp
Message-ID: <20081112152725.EA6871C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 16:27:24 2008
New Revision: 2721

Log:
removed broken cArtMap::CalcVisibleAABB from c code, not used in lua, item =
counter art-bbox used

Modified:
    trunk/include/data_artmap.h
    trunk/lua/lib.data.lua
    trunk/plugins/itemcounter.lua
    trunk/src/data_artmap.cpp
    trunk/src/data_artmap_L.cpp

Modified: trunk/include/data_artmap.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_artmap.h (original)
+++ trunk/include/data_artmap.h Wed Nov 12 16:27:24 2008
@@ -7,7 +7,6 @@
 	cArtMap();
 	int	GetWidth	();
 	int	GetHeight	();
-	void	CalcVisibleAABB(int& minx, int& miny, int& maxx, int& maxy);
 	void	SearchCursorHotspot		(int& iX,int& iY); ///< returns hotspot coords =
in iX,iY. search using different pixel on image border
 	=

 	// http://uo.stratics.com/heptazane/fileformats.shtml#3.4

Modified: trunk/lua/lib.data.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.data.lua (original)
+++ trunk/lua/lib.data.lua Wed Nov 12 16:27:24 2008
@@ -164,54 +164,41 @@
 	return res
 end
 =

+
+function BitMaskTestRow (bitmask,x1,x2,y) for x =3D x1,x2 do if bitmask:Te=
stBit(x,y) then return true end end end
+function BitMaskTestCol (bitmask,x,y1,y2) for y =3D y1,y2 do if bitmask:Te=
stBit(x,y) then return true end end end
+
+gArtMatVisibleAABBCache =3D {}
 -- minx,miny,maxx,maxy =3D GetArtVisibleAABB(artid) : from gArtMatCache or=
 calculateSize
-gArtMatVisibleAABBCache =3D {}
 function GetArtVisibleAABB (iArtID)
 	local res =3D gArtMatVisibleAABBCache[iArtID]
-
-	if (not res and gArtMapLoader) then
-		--[[
-		TODO this does not work correctly so its implemented via bitmask
-		=

-		gArtMapLoader:Load(iArtID)
-		local minx,miny,maxx,maxy =3D gArtMapLoader:CalcVisibleAABB()
-		gArtMatVisibleAABBCache[iArtID] =3D {minx,miny,maxx,maxy}
-		]]
-		=

-		local bitmask =3D GetArtBitMask (iArtID)
-		local minx,miny,maxx,maxy
-		=

-		local w,h =3D GetArtSize(iArtID)
-		=

-		for y =3D 1,h-1 do
-		for x =3D 1,w-1 do
-			if bitmask:TestBit(x,y) then
-				if minx =3D=3D nil then
-					minx =3D x
-					miny =3D y
-					maxx =3D x
-					maxy =3D y
-				else
-					minx =3D math.min(minx,x)
-					miny =3D math.min(miny,y)
-					maxx =3D math.max(maxx,x)
-					maxy =3D math.max(maxy,y)
-				end
+	if (res) then return unpack(res) end
+	if (not gArtMapLoader) then return 0,0,0,0 end
+	=

+	local bitmask =3D GetArtBitMask(iArtID)
+	local minx,miny,maxx,maxy
+	local w,h =3D bitmask:GetSize()
+	=

+	for y =3D 1,h-1 do
+	for x =3D 1,w-1 do
+		if bitmask:TestBit(x,y) then
+			if minx =3D=3D nil then
+				minx =3D x
+				miny =3D y
+				maxx =3D x
+				maxy =3D y
+			else
+				minx =3D math.min(minx,x)
+				miny =3D math.min(miny,y)
+				maxx =3D math.max(maxx,x)
+				maxy =3D math.max(maxy,y)
 			end
 		end
-		end
-		=

-		bitmask:Destroy()
-		=

-		gArtMatVisibleAABBCache[iArtID] =3D {minx,miny,maxx,maxy}
-		return minx,miny,maxx,maxy
-	end
-
-	if (res) then
-		return unpack(res)
-	end
-	=

-	return 0, 0
+	end
+	end
+	=

+	gArtMatVisibleAABBCache[iArtID] =3D {minx or 0,miny or 0,maxx or 0,maxy o=
r 0}
+	return minx,miny,maxx,maxy
 end
 =

 =


Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Wed Nov 12 16:27:24 2008
@@ -68,13 +68,15 @@
 	local r,g,b =3D 1,1,1
 	if (amount < kItemCounterLowAmount) then r,g,b =3D 1,0,0 end
 	if (amount =3D=3D 0) then r,g,b =3D 0.3,0,0 end
-	self:AddWidget(self:CreateChild("UOImage",{x=3Dself.nextx,y=3D0,art_id=3D=
artid}))
+	=

+	local minx,miny,maxx,maxy =3D GetArtVisibleAABB(artid+0x4000)  print("UOI=
temCounter GetArtVisibleAABB",minx,miny,maxx,maxy)
+	self:AddWidget(self:CreateChild("UOImage",{x=3Dself.nextx-minx,y=3D0,art_=
id=3Dartid}),maxx-minx)
 	self:AddWidget(self:CreateChild("UOText",{x=3Dself.nextx,y=3D0,text=3Damo=
unt,col=3D{r=3Dr,g=3Dg,b=3Db},bold=3Dtrue}))
 end
-function gWidgetPrototype.UOItemCounter:AddWidget (widget)
+function gWidgetPrototype.UOItemCounter:AddWidget (widget,xmove)
 	table.insert(self.widgets,widget)
-	local l,t,r,b =3D widget:GetRelBounds()
-	self.nextx =3D self.nextx + r
+	if (not xmove) then local l,t,r,b =3D widget:GetRelBounds() xmove =3D r e=
nd
+	self.nextx =3D self.nextx + xmove
 end
 =

 function gWidgetPrototype.UOItemCounter:Clear ()

Modified: trunk/src/data_artmap.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data_artmap.cpp (original)
+++ trunk/src/data_artmap.cpp Wed Nov 12 16:27:24 2008
@@ -35,43 +35,6 @@
 int	cArtMap::GetHeight	() {
 	if(miID < 0x4000)return 44;
 	else return ((short *)mpRawData)[3];
-}
-
-void	cArtMap::CalcVisibleAABB(int& minx, int& miny, int& maxx, int& maxy) =
{	=

-	// TODO this returns strange results so this functionality is implemented=
 via bitmasks
-	=

-	// read the size
-	int w =3D GetWidth();
-	int h =3D GetHeight();
-	short *pBuffer =3D new short[w*h];
-	cIdentityFilter Filter;
-	Decode(pBuffer,w*sizeof(short),Filter,0);
-	=

-	bool found =3D false;
-	=

-	int offset;
-	// this ignores and 1px border because of broken images or strange data i=
n the border
-	for(int y=3D1;y<h-2;++y){
-		for(int x=3D1;x<w-2;++x){
-			offset =3D y*w+x;
-			if(pBuffer[offset]){
-				if(!found){
-					minx =3D x;
-					maxx =3D x;
-					miny =3D y;
-					maxy =3D y;
-					found =3D true;
-				} else {
-					minx =3D mymin(x,minx);
-					maxx =3D mymax(x,maxx);
-					miny =3D mymin(y,miny);
-					maxy =3D mymax(y,maxy);
-				}
-			}
-		}
-	}
-
-	delete [] pBuffer;
 }
 =

 void	cArtMap::SearchCursorHotspot		(int& iX,int& iY) { PROFILE

Modified: trunk/src/data_artmap_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data_artmap_L.cpp (original)
+++ trunk/src/data_artmap_L.cpp Wed Nov 12 16:27:24 2008
@@ -15,7 +15,6 @@
 			REGISTER_METHOD(CreateBitMask);
 			REGISTER_METHOD(Load);
 			REGISTER_METHOD(GetSize);
-			REGISTER_METHOD(CalcVisibleAABB);
 			REGISTER_METHOD(SearchCursorHotspot);
 			REGISTER_METHOD(GetCount);
 			REGISTER_METHOD(ExportToFile);
@@ -123,19 +122,6 @@
 			return 2; =

 		}
 		=

-		/// minx,miny,maxx,maxy =3D gArtMapLoader:CalcVisibleAABB() for last chu=
nk loaded by Load() for lua
-		static int	CalcVisibleAABB			(lua_State *L) { PROFILE =

-			cArtMap* pLastChunk =3D mLastChunk[checkudata_alive(L)];
-			int minx,miny,maxx,maxy;
-			=

-			if (pLastChunk) pLastChunk->CalcVisibleAABB(minx,miny,maxx,maxy);
-			lua_pushnumber(L,minx); =

-			lua_pushnumber(L,miny); =

-			lua_pushnumber(L,maxx); =

-			lua_pushnumber(L,maxy); =

-			return 4; =

-		}
-		=

 		virtual const char* GetLuaTypeName () { return "iris.artmaploader"; }
 };
 std::map<cArtMapLoader*,cArtMap*>	cArtMapLoader_L::mLastChunk;



From no-reply at zwischenwelt.org  Wed Nov 12 16:34:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 15:34:35 -0000
Subject: [Iris-commit] [IRIS] r2722 - in /trunk/lua: lib.3d.renderer.lua
	lib.3d.walksmooth.lua
Message-ID: <20081112153435.6DDF91C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 16:34:33 2008
New Revision: 2722

Log:
fix targetline for 3d, 3d exact mobile pos

Modified:
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.3d.walksmooth.lua

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Nov 12 16:34:33 2008
@@ -31,6 +31,19 @@
 	-- load texture atlas
 	LoadTexAtlas()
 	RegisterListener("Hook_MainWindowResized",function () Renderer3D.gbNeedCo=
rrectAspectRatio =3D true end)
+end
+
+function Renderer3D:GetExactMobilePos (mobile)
+	if (not mobile) then return end
+	-- todo : tilefree ? =

+	if (mobile.exactxloc) then -- walksmooth
+		return	mobile.exactxloc,
+				mobile.exactyloc,
+				mobile.exactzloc
+	end
+	return	mobile.xloc,
+			mobile.yloc,
+			mobile.zloc
 end
 =

 function Renderer3D:Init ()

Modified: trunk/lua/lib.3d.walksmooth.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.walksmooth.lua (original)
+++ trunk/lua/lib.3d.walksmooth.lua Wed Nov 12 16:34:33 2008
@@ -91,6 +91,9 @@
 	local dir  =3D dir1 + factor * dirdiff
 	=

 	local x,y,z =3D Renderer3D:UOPosToLocal(xloc,yloc,zloc * 0.1)
+	mobile.exactxloc =3D xloc
+	mobile.exactyloc =3D yloc
+	mobile.exactzloc =3D zloc
 	local ang_in_degrees =3D (dir + 0) * 45.0
 	local qw,qx,qy,qz =3D Quaternion.fromAngleAxis(- gfDeg2Rad * ang_in_degre=
es,0,0,1)
 	Renderer3D:UpdateMobilePos(mobile,x,y,z,qw,qx,qy,qz)



From no-reply at zwischenwelt.org  Wed Nov 12 16:53:02 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 15:53:02 -0000
Subject: [Iris-commit] [IRIS] r2723 - in /trunk/plugins: itemcounter.lua
	lib.spellbar.lua
Message-ID: <20081112155304.7B6FA1C187DC@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 16:53:00 2008
New Revision: 2723

Log:
noreg, nospell warnigns detected by spellbar

Modified:
    trunk/plugins/itemcounter.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Wed Nov 12 16:53:00 2008
@@ -49,12 +49,11 @@
 	=

 	gItemCounterDialog:Clear()
 	=

-	print("itemcounter")
+	print("itemcounter update")
 	local baglist =3D MacroCmd_Item_FindByArtID(kItemCounterBagType)
 	for k,v in pairs(gItemCounterTypes) do
 		local amount =3D ItemCounterOne(v.artid,baglist)
 		gItemCounterDialog:AddItem(v,amount)
-		print("+itemcounter",amount,GetStaticTileTypeName(v.artid))
 	end
 end
 =

@@ -69,7 +68,7 @@
 	if (amount < kItemCounterLowAmount) then r,g,b =3D 1,0,0 end
 	if (amount =3D=3D 0) then r,g,b =3D 0.3,0,0 end
 	=

-	local minx,miny,maxx,maxy =3D GetArtVisibleAABB(artid+0x4000)  print("UOI=
temCounter GetArtVisibleAABB",minx,miny,maxx,maxy)
+	local minx,miny,maxx,maxy =3D GetArtVisibleAABB(artid+0x4000)
 	self:AddWidget(self:CreateChild("UOImage",{x=3Dself.nextx-minx,y=3D0,art_=
id=3Dartid}),maxx-minx)
 	self:AddWidget(self:CreateChild("UOText",{x=3Dself.nextx,y=3D0,text=3Damo=
unt,col=3D{r=3Dr,g=3Dg,b=3Db},bold=3Dtrue}))
 end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Wed Nov 12 16:53:00 2008
@@ -144,6 +144,9 @@
 gSpellbarShortMessages[500641 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"disturbed"		=
	,bInterrupt=3Dtrue} -- Your concentration is disturbed, thus ruining thy s=
pell.	=

 gSpellbarShortMessages[502625 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"no mana"			,=
bInterrupt=3Dtrue} -- Insufficient mana for this spell.						=

 gSpellbarShortMessages[1049645] =3D {r=3D1,g=3D0,b=3D0,txt=3D"too many fol=
lowers"	,bInterrupt=3Dtrue} -- You have too many followers to summon that c=
reature.  	   =

+gSpellbarShortMessages[500015 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"don't have s=
pell"	,bInterrupt=3Dtrue} -- You do not have that spell!
+gSpellbarShortMessages[502630 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"regs"				,bI=
nterrupt=3Dtrue} -- More reagents are needed for this spell.
+
 =

 -- weapon specials
 gSpellbarShortMessages[1060163] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"PARABL=
OW"			}--~ You deliver a paralyzing blow!  =

@@ -195,6 +198,7 @@
 Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091
 Hook_Packet_Localized_Text      4294967295      You inflict a Death Strike=
 upon your opponent!  1063094  (different message for 2nd..)
 Hook_Packet_Localized_Text      4294967295      You missed your opponent w=
ith a Death Strike.   1070779  =

+
 =

 ]]--
 =




From no-reply at zwischenwelt.org  Wed Nov 12 16:58:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 15:58:58 -0000
Subject: [Iris-commit] [IRIS] r2724 - /trunk/plugins/itemcounter.lua
Message-ID: <20081112155859.290521C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 16:58:57 2008
New Revision: 2724

Log:
added arrows to itemcounter

Modified:
    trunk/plugins/itemcounter.lua

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Wed Nov 12 16:58:57 2008
@@ -24,6 +24,7 @@
 	=

 	{name=3Dgold			,artid=3D0xeef},
 	{name=3Dbandas		,artid=3D0xe21},
+	{name=3Darrows		,artid=3D3903},
 	}
                                                   =

 gItemCounterTypesByArtID 	=3D {}



From no-reply at zwischenwelt.org  Wed Nov 12 17:30:18 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 16:30:18 -0000
Subject: [Iris-commit] [IRIS] r2725 - /trunk/plugins/itemcounter.lua
Message-ID: <20081112163018.C3D421C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 17:30:18 2008
New Revision: 2725

Log:
added weight display to itemcounter

Modified:
    trunk/plugins/itemcounter.lua

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Wed Nov 12 17:30:18 2008
@@ -37,6 +37,7 @@
 end
 =

 -- dynamicdata.iContainerSerial
+RegisterListener("Mobile_UpdateStats", function (mobile) if (IsPlayerMobil=
e(mobile)) then gItemCounterNeedsUpdate =3D true end end)
 RegisterListener("Dynamic_Update", function (item) if (gItemCounterTypesBy=
ArtID[item.artid]) then gItemCounterNeedsUpdate =3D true end end)
 RegisterListener("Dynamic_Destroy", function (item) if (gItemCounterTypesB=
yArtID[item.artid]) then gItemCounterNeedsUpdate =3D true end end)
 RegisterStepper(function () if (gItemCounterNeedsUpdate) then ItemCounterU=
pdate() end end)
@@ -45,22 +46,37 @@
 function ItemCounterUpdate ()
 	if (not gInGameStarted) then return end
 	gItemCounterNeedsUpdate =3D false
+	print("itemcounter update")
 	=

 	if (not gItemCounterDialog) then gItemCounterDialog =3D GetDesktopWidget(=
):CreateChild("UOItemCounter") end
 	=

 	gItemCounterDialog:Clear()
 	=

-	print("itemcounter update")
+	-- items
 	local baglist =3D MacroCmd_Item_FindByArtID(kItemCounterBagType)
 	for k,v in pairs(gItemCounterTypes) do
 		local amount =3D ItemCounterOne(v.artid,baglist)
 		gItemCounterDialog:AddItem(v,amount)
 	end
+	=

+	-- weight
+	local curw,maxw =3D GetPlayerWeight()
+	local r,g,b =3D 1,1,1
+	if (curw > maxw*0.75) then r,g,b =3D 1,1,0 end
+	if (curw > maxw) then r,g,b =3D 1,0,0 end
+	gItemCounterDialog:AddText("W:")
+	gItemCounterDialog:AddText(curw or 0,r,g,b)
+	gItemCounterDialog:AddText("/")
+	gItemCounterDialog:AddText(maxw or 0)
 end
 =

 gWidgetClass["UOItemCounter"] =3D nil -- unregister for reload
 RegisterWidgetClass("UOItemCounter")
 =

+
+function gWidgetPrototype.UOItemCounter:AddText (text,r,g,b)
+	self:AddWidget(self:CreateChild("UOText",{x=3Dself.nextx,y=3D0,text=3Dtex=
t,col=3D{r=3Dr or 1,g=3Dg or 1,b=3Db or 1},bold=3Dtrue}))
+end
 =

 function gWidgetPrototype.UOItemCounter:AddItem (data,amount)
 	local artid =3D data.artid
@@ -68,14 +84,17 @@
 	local r,g,b =3D 1,1,1
 	if (amount < kItemCounterLowAmount) then r,g,b =3D 1,0,0 end
 	if (amount =3D=3D 0) then r,g,b =3D 0.3,0,0 end
-	=

 	local minx,miny,maxx,maxy =3D GetArtVisibleAABB(artid+0x4000)
 	self:AddWidget(self:CreateChild("UOImage",{x=3Dself.nextx-minx,y=3D0,art_=
id=3Dartid}),maxx-minx)
-	self:AddWidget(self:CreateChild("UOText",{x=3Dself.nextx,y=3D0,text=3Damo=
unt,col=3D{r=3Dr,g=3Dg,b=3Db},bold=3Dtrue}))
+	self:AddText(amount,r,g,b)
+	self:AddSpace(2)
 end
 function gWidgetPrototype.UOItemCounter:AddWidget (widget,xmove)
 	table.insert(self.widgets,widget)
 	if (not xmove) then local l,t,r,b =3D widget:GetRelBounds() xmove =3D r e=
nd
+	self.nextx =3D self.nextx + xmove
+end
+function gWidgetPrototype.UOItemCounter:AddSpace (xmove)
 	self.nextx =3D self.nextx + xmove
 end
 =




From no-reply at zwischenwelt.org  Wed Nov 12 18:23:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 17:23:53 -0000
Subject: [Iris-commit] [IRIS] r2726 - /trunk/lua/gui/gui.trade.lua
Message-ID: <20081112172353.D1D281C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 12 18:23:53 2008
New Revision: 2726

Log:
shop comfort, wheel over good item to increase/decrease, fixed ctrl

Modified:
    trunk/lua/gui/gui.trade.lua

Modified: trunk/lua/gui/gui.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.trade.lua (original)
+++ trunk/lua/gui/gui.trade.lua Wed Nov 12 18:23:53 2008
@@ -32,7 +32,7 @@
 =

 function ShopAddToBill (shop,good,amount)
 	amount =3D amount or 1
-	if (gKeyPressed[key_lcontrol]) then amount =3D 10 end
+	if (gKeyPressed[key_lcontrol]) then amount =3D (amount > 0) and 10 or -10=
 end
 	local newamount =3D math.max(0,math.min(good.itemamount,good.tradeamount =
+ amount))
 	if (gKeyPressed[key_lshift]) then newamount =3D good.itemamount end
 	if (good.tradeamount ~=3D newamount) then
@@ -164,9 +164,11 @@
 	=

 			incr.good =3D good
 			decr.good =3D good
+			name.good =3D good
+			amount.good =3D good
 			incr.onMouseDown =3D function (widget,mousebutton) if (mousebutton =3D=
=3D 1) then widget.dialog.uoShop:AddToBill(widget.good,1) end end
 			decr.onMouseDown =3D function (widget,mousebutton) if (mousebutton =3D=
=3D 1) then widget.dialog.uoShop:AddToBill(widget.good,-1) end end
-
+			=

 			table.insert(dialog.curpagewidgets,incr)
 			table.insert(dialog.curpagewidgets,decr)
 			table.insert(dialog.curpagewidgets,name)
@@ -183,6 +185,13 @@
 RegisterListener("keydown",function (key,char,bConsumed)
 	local list =3D gLastShop and gLastShop.dialog_list
 	if ((not list) or (not list:IsAlive())) then return end
+	local widget =3D GetWidgetUnderMouse()
+	if (widget and widget.good and widget.dialog.uoShop) then
+		if (key =3D=3D key_wheelup) then	widget.dialog.uoShop:AddToBill(widget.g=
ood,1) end
+		if (key =3D=3D key_wheeldown) then	widget.dialog.uoShop:AddToBill(widget=
.good,-1) end
+		return
+	end
+	=

 	if (key =3D=3D key_wheeldown) then	list:NextPage() end
 	if (key =3D=3D key_wheelup) then	list:PrevPage() end
 end)



From no-reply at zwischenwelt.org  Wed Nov 12 19:41:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 12 Nov 2008 18:41:03 -0000
Subject: [Iris-commit] [IRIS] r2727 - in /trunk: bin/iris2.exe
	src/spritemanager.cpp
Message-ID: <20081112184103.645C81C1879B@zwischenwelt.org>

Author: sience
Date: Wed Nov 12 19:41:02 2008
New Revision: 2727

Log:
-new win32 binary
-small fix for shoggoth (ogre 1.6)

Modified:
    trunk/bin/iris2.exe
    trunk/src/spritemanager.cpp

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/src/spritemanager.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/spritemanager.cpp (original)
+++ trunk/src/spritemanager.cpp Wed Nov 12 19:41:02 2008
@@ -268,7 +268,13 @@
 	RenderSys->unbindGpuProgram( Ogre::GPT_FRAGMENT_PROGRAM );
 	RenderSys->unbindGpuProgram( Ogre::GPT_VERTEX_PROGRAM );
 	RenderSys->_setSceneBlending( Ogre::SBF_SOURCE_ALPHA, Ogre::SBF_ONE_MINUS=
_SOURCE_ALPHA );
+
+#if OGRE_VERSION >=3D 0x10600
+	RenderSys->_setAlphaRejectSettings( Ogre::CMPF_GREATER, 128, true );
+#else
 	RenderSys->_setAlphaRejectSettings( Ogre::CMPF_GREATER, 128 );
+#endif =

+
 	RenderSys->setLightingEnabled( mLightningEnabled );
 }
 =




From no-reply at zwischenwelt.org  Thu Nov 13 23:43:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 13 Nov 2008 22:43:08 -0000
Subject: [Iris-commit] [IRIS] r2728 - in /trunk: lua/lib.razorconfig.lua
 lua/main.lua plugins/itemcounter.lua
Message-ID: <20081113224309.06FBC1C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Nov 13 23:43:08 2008
New Revision: 2728

Log:
started work on razor config importer

Added:
    trunk/lua/lib.razorconfig.lua
Modified:
    trunk/lua/main.lua
    trunk/plugins/itemcounter.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Nov 13 23:43:08 2008
@@ -94,6 +94,7 @@
 dofile(libpath .. "lib.blendout.lua")
 dofile(libpath .. "lib.packetvideo.lua")
 dofile(libpath .. "lib.objectpicker.lua")
+dofile(libpath .. "lib.razorconfig.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Thu Nov 13 23:43:08 2008
@@ -46,7 +46,7 @@
 function ItemCounterUpdate ()
 	if (not gInGameStarted) then return end
 	gItemCounterNeedsUpdate =3D false
-	print("itemcounter update")
+	--~ print("itemcounter update")
 	=

 	if (not gItemCounterDialog) then gItemCounterDialog =3D GetDesktopWidget(=
):CreateChild("UOItemCounter") end
 	=

@@ -108,10 +108,6 @@
 	self:InitAsGroup(parentwidget,params)
 	self.widgets =3D {}
 	self.nextx =3D 0
-	=

-	print("create UOItemCounter dialog")
-	=

-	--~ local vw,vh =3D GetViewportSize()
 	self:SetPos(160,16)
 end
 =




From no-reply at zwischenwelt.org  Fri Nov 14 22:11:09 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 14 Nov 2008 21:11:09 -0000
Subject: [Iris-commit] [IRIS] r2729 - /trunk/premake.lua
Message-ID: <20081114211109.C202A1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Nov 14 22:11:09 2008
New Revision: 2729

Log:
gbUseSystemOis set to false, as it didn't compile with true after the lates=
t changes

Modified:
    trunk/premake.lua

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Fri Nov 14 22:11:09 2008
@@ -11,7 +11,7 @@
 gbExtraWarnings =3D false
 gbOptimize =3D true
 gOisPlatform =3D "linux"
-gbUseSystemOis =3D true -- static compile ois segfaultet at mKeyboard->set=
TextTranslation, ois-headers in system incompatible ?
+gbUseSystemOis =3D false -- static compile ois segfaultet at mKeyboard->se=
tTextTranslation, ois-headers in system incompatible ?
 gbNo64BitChecks =3D false
 gbDisableProfiling =3D true
 gbDisableAssert =3D false



From no-reply at zwischenwelt.org  Sat Nov 15 03:10:31 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 15 Nov 2008 02:10:31 -0000
Subject: [Iris-commit] [IRIS] r2730 - /trunk/lua/lib.uoanim.lua
Message-ID: <20081115021031.650421524030@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov 15 03:10:30 2008
New Revision: 2730

Log:
uoanims : non-mounted run anim fixed

Modified:
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Sat Nov 15 03:10:30 2008
@@ -282,11 +282,13 @@
 	if (iModelID < high + low	) then return 10 end
 	return bHasMount and 125 or 20  -- Human
 end
+
+
 function Anim_GetMoveAnim (iModelID,iLoaderIndex,bHasMount,bRun)
 	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
 	if (iModelID < high			) then return  0 end
 	if (iModelID < high + low	) then return bRun and 5 or 0 end
-	return bHasMount and (bRun and 120 or 115) or (bRun and 5 or 0)  -- Human
+	return bHasMount and (bRun and 120 or 115) or (bRun and 10 or 0)  -- Human
 end
 =

 =




From no-reply at zwischenwelt.org  Sat Nov 15 03:15:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 15 Nov 2008 02:15:11 -0000
Subject: [Iris-commit] [IRIS] r2731 - in /trunk/lua: gui/gui.paperdoll.lua
 lib.corpse.lua lib.macrolist.lua lib.razorconfig.lua net/net.aoscommand.lua
 obj/obj.mobile.lua obj/obj.player.lua widgets/widget.gumpdialog.lua
Message-ID: <20081115021511.B839D1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov 15 03:15:11 2008
New Revision: 2731

Log:
added a bunch of new macro commands while working on razor macro parser : M=
acroCmd_JobWaitForTarget MacroCmd_TargetLastNow MacroCmd_TargetSelfNow Macr=
oCmd_WeaponAbilityPrimary MacroCmd_WeaponAbilitySecondary  MacroCmd_TargetG=
roundNow  MacroCmd_WalkInDir

Modified:
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.corpse.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.razorconfig.lua
    trunk/lua/net/net.aoscommand.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/obj/obj.player.lua
    trunk/lua/widgets/widget.gumpdialog.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Sat Nov 15 03:15:11 2008
@@ -85,23 +85,11 @@
  -- weaponability
  [9]	=3D function (widget,mousebutton)
  			if (mousebutton =3D=3D 1) then
- 				-- get artid of current equipped weapon
- 				local playermobile =3D GetPlayerMobile()
- 				local item1 =3D GetMobileEquipmentItem(playermobile,gLayerType.kLayer=
_OneHanded)
- 				local item2 =3D GetMobileEquipmentItem(playermobile,gLayerType.kLayer=
_TwoHanded) -- might be shield,lantern...
- 				local artid =3D (item1 and item1.artid) or (item2 and item2.artid)
- 				--~ print("artid",artid)
- 				local skills =3D glWeaponAbilitiesWeapons[artid] or glWeaponAbilities=
Weapons[0] -- 0:wrestl
- 				if skills then
- 					local first =3D glWeaponAbilities[skills.first]
- 					local second =3D glWeaponAbilities[skills.second]
- 					--~ print("first",first.name)
- 					--~ print("second",second.name)
- 					=

- 					local mx,my =3D GetMousePos()
- 					CreateQuickCastButtonWeaponability(mx-48,my,skills.first)
- 					CreateQuickCastButtonWeaponability(mx+16,my,skills.second)
- 				end
+ 				-- current equipped weapon
+				local a,b =3D GetWeaponSpecialsForMobile(GetPlayerMobile())
+				local mx,my =3D GetMousePos()
+				if (a) then CreateQuickCastButtonWeaponability(mx-48,my,a) end
+ 				if (b) then CreateQuickCastButtonWeaponability(mx+16,my,b) end
  			end
  		  end,
 		  =


Modified: trunk/lua/lib.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.corpse.lua (original)
+++ trunk/lua/lib.corpse.lua Sat Nov 15 03:15:11 2008
@@ -3,7 +3,7 @@
 =

 kCorpseDynamicArtID 		=3D 0x2006
 kBonesDynamicArtID_First	=3D 0xeca
-kBonesDynamicArtID_Last		=3D 0xed1
+kBonesDynamicArtID_Last		=3D 0xed2
 =

 =

 function IsCorpseArtID (artid)

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Nov 15 03:15:11 2008
@@ -134,8 +134,15 @@
 RegisterListener("Hook_Spell_Interrupt",	function ()
 	if (gMacroQueuedTarget_FailBySpellInterrupt) then MacroCmd_QueuedTargetEn=
d(false,"spell-interrupt") end
 end)
+gMacroJobsWaitingForTarget =3D {}
+function MacroCmd_JobWaitForTarget(timeout) -- returns true if IsTargetMod=
eActive
+	gMacroJobsWaitingForTarget[job.running_id()] =3D true
+	job.wait(timeout or 30000)
+	return IsTargetModeActive()
+end
 RegisterListener("Hook_TargetMode_Start",	function () =

 	if (gMacroQueuedTarget_Serial) then MacroCmd_SendTargetSerial(gMacroQueue=
dTarget_Serial) MacroCmd_QueuedTargetEnd(true) end
+	for jobid,v in pairs(gMacroJobsWaitingForTarget) do job.wakeup(jobid,true=
) end gMacroJobsWaitingForTarget =3D {}
 end)
 RegisterListener("Hook_TargetMode_Start",	function () =

 	if (gMacroQueuedTarget_Serial) then MacroCmd_SendTargetSerial(gMacroQueue=
dTarget_Serial) MacroCmd_QueuedTargetEnd(true) end
@@ -197,6 +204,12 @@
 end
 =

 =

+function MacroCmd_TargetLastNow	() if (gMacroLastTargetMemory) then Comple=
teTargetMode(gMacroLastTargetMemory) end end
+function MacroCmd_TargetSelfNow	() CompleteTargetModeWithTargetMobile(GetP=
layerMobile()) end
+
+function MacroCmd_WeaponAbilityPrimary		() local a,b =3D GetWeaponSpecials=
ForMobile(GetPlayerMobile()) Send_AOSCommand_WeaponAbility(a) end
+function MacroCmd_WeaponAbilitySecondary	() local a,b =3D GetWeaponSpecial=
sForMobile(GetPlayerMobile()) Send_AOSCommand_WeaponAbility(b) end
+
 -- timeout in ms, defaults to 30 seconds
 function MacroCmd_TargetLast	(completefun,timeout) 		-- repeat the last ta=
rget	=

 	timeout =3D timeout or 30000
@@ -205,7 +218,7 @@
 	=

 	gMacroTargetLastRunning =3D true
 	local listener =3D RegisterListener("Hook_TargetMode_Start",function () =

-			if (gMacroLastTargetMemory) then CompleteTargetMode(gMacroLastTargetMem=
ory) end
+			MacroCmd_TargetLastNow()
 			gMacroTargetLastRunning =3D false
 			if (completefun) then completefun() end
 			return true
@@ -221,19 +234,24 @@
 end
 =

 =

-function MacroCmd_TargetGround	(x,y,z, completefun)
+function MacroCmd_TargetGround	(xloc,yloc,zloc_or_nil, completefun)
 	if (gMacroWaitForTargetActive) then return end
 	gMacroWaitForTargetActive =3D true
 	RegisterListener("Hook_TargetMode_Start",function () =

 			print("MacroCmd_TargetGround hook triggered")
-			if x and y and z then =

-				print("#",x,y,z)
-				CompleteTargetMode({hittype=3DkMousePickHitType_Ground,x=3Dx,y=3Dy,z=
=3Dz}) =

-			end
+			MacroCmd_TargetGroundNow(xloc,yloc,zloc_or_nil)
 			gMacroWaitForTargetActive =3D false
 			if (completefun) then completefun() end
 			return true
 		end)
+end
+
+-- zloc_or_nil : determined automatically if nil
+function MacroCmd_TargetGroundNow (xloc,yloc,zloc_or_nil)
+	if (xloc and yloc) then
+		local zloc =3D zloc_or_nil or GetGroundZAtAbsPos(xloc,yloc) or 0
+		CompleteTargetMode({hittype=3DkMousePickHitType_Ground,x=3Dxloc,y=3Dyloc=
,z=3Dzloc}) =

+	end
 end
 =

 function MacroCmd_TargetSelf	(completefun) 		-- target self
@@ -610,6 +628,8 @@
 	if (gMacroListDialog) then gMacroListDialog:Destroy() gMacroListDialog =
=3D nil end
 end
 =

+function MacroCmd_WalkInDir		(iDir,bRunFlag) ExecWalkRequestIfPossible(iDi=
r,bRunFlag) end
+
 function MacroCmd_WalkToMouse	()
 	MainMousePick()
 	local x,y,z =3D GetMouseHitTileCoords()

Modified: trunk/lua/lib.razorconfig.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.razorconfig.lua (original)
+++ trunk/lua/lib.razorconfig.lua Sat Nov 15 03:15:11 2008
@@ -25,17 +25,17 @@
 =

 =

 --~ ImportRazorHotkeys      /home/ghoul/Desktop/cavern/razorprofile/defaul=
t.xml
---~ 66      b       1       L:1311  nil
---~ 65      a       0       L:1044092       nil  spiritspeak
---~ 79      o       0       L:1013  nil	-- set primary ability aos (weapon=
 special)
---~ -2              0       L:1058  nil -- target last
---~ -1              0       L:1059  nil -- target self
---~ -3              0       L:1195  nil -- clear target queue
---~ ltarget : wheeldown
---~ targetself : wheelup
---~ clear target queue : mouse middle
-
---~ number keys 1-8  : keycode 49 bis x
+--~ 66      b       1       L:1311 			 =

+--~ 65      a       0       L:1044092         spiritspeak
+
+gRazorHotKeyAction =3D {}
+gRazorHotKeyAction[1473] =3D function () Send_DoubleClick(GetPlayerSerial(=
)) end -- dismount
+gRazorHotKeyAction[1195] =3D function () end -- clear target queue
+gRazorHotKeyAction[1059] =3D function () MacroCmd_TargetSelfNow() end -- t=
argetself
+gRazorHotKeyAction[1058] =3D function () MacroCmd_TargetLastNow() end -- t=
argetlast
+gRazorHotKeyAction[1013] =3D function () MacroCmd_WeaponAbilityPrimary() e=
nd
+
+
 =

 gRazorSpellConfig =3D {}
 --~ zirkel1"
@@ -187,7 +187,8 @@
 		local keymod =3D hotkey.attr.mod
 		local action =3D hotkey[1]
 		local spellname =3D gRazorSpellConfig[action]
-		print(key,GetKeyName(key),keymod,action,spellname)
+		local a,b,macroname =3D string.find(action,"Play: (.+)")
+		print(key,GetKeyName(key),keymod,action,spellname,macroname)
 	end
 	--~ <key mod=3D"7" key=3D"49" send=3D"False">L:3002011</key>Clumsy
 end
@@ -202,7 +203,6 @@
 			local command =3D strsplit("|",string.gsub(line,"[\n\r]",""))
 			if (command[1]) then command[1] =3D string.gsub(command[1],"Assistant.M=
acros.","") end
 			table.insert(macro,command)
-			ExecRazorMacroCommand(command) -- DEBUG
 		end
 		gRazorMacros[macroname] =3D macro
 	end
@@ -210,56 +210,62 @@
 end
 =

 gRazorMacroCmd =3D {}
-function gRazorMacroCmd.WalkAction (dir) print("walkdir",dir) end
+
+--~ WalkAction|2
+function gRazorMacroCmd.WalkAction (dir) MacroCmd_WalkInDir(dir,TestBit(di=
r,0x80)) end
 =

 --~ DoubleClickTypeAction|10229|True
-function gRazorMacroCmd.DoubleClickTypeAction (artid,u1) print("DoubleClic=
kTypeAction",artid) end
-
---~ HotKeyAction|1473| -- dismount (bola macro part)
-function gRazorMacroCmd.HotKeyAction (hotkey,param) =

-	print("HotKeyAction",hotkey) =

-	if (hotkey =3D=3D "1473") then print("dismount") end
-end
+function gRazorMacroCmd.DoubleClickTypeAction (artid,u1) MacroCmd_Item_Use=
ByArtID(artid) end
+
+--~ DoubleClickAction|546224|220
+function gRazorMacroCmd.DoubleClickAction (serial,u1) Send_DoubleClick(ser=
ial) end
 =

 --~ PauseAction|00:00:00.5550000
+--~ PauseAction|00:00:02
 function gRazorMacroCmd.PauseAction (dur)
-	local a,b,h,m,s =3D string.find(dur,"%d+:%d+:%d+")
-	print("pause",dur,h,m,s)
-	--~ local ms =3D 1000*(s + 60*(m + 60*h))
-	--~ print("PauseAction",ms) job.wait(ms)
-end
-
-
---[[
-WaitForTargetAction|1
-
-LastTargetAction
-TargetRelLocAction|2|0
-AbsoluteTargetAction|0|0|41651|1657|310|-85|118
-
-PauseAction|00:00:00.5550000
-ExtCastSpellAction|507|4294967295
-
-WalkAction|2   -- dir
-SpeechAction|0|198|3|enu|5|48|232|22|49|108|all follow me
-DoubleClickAction|546224|220
-
-MacroCastSpellAction|44 -- (magetrain.macro) (lastspell)
-HotKeyAction|1059| -- (magetrain.macro) (target self) =

-PauseAction|00:00:02
-HotKeyAction|1195| -- target:clear target_clear+last
-HotKeyAction|1058| -- target:last target_clear+last
-
-GumpResponseAction|21|0|0
-WaitForGumpAction|949095101|False|300
-
-IfAction|4|0|you prepare to perform a shadowjump.
-ElseAction
-EndIfAction
-
-ForAction|10
-EndForAction
-]]--
+	local a,b,h,m,s =3D string.find(dur,"(%d+):(%d+):(.+)")
+	local ms =3D 1000*(tonumber(s) + 60*(tonumber(m) + 60*tonumber(h)))
+	job.wait(ms)
+end
+
+--~ WaitForTargetAction|1
+function gRazorMacroCmd.WaitForTargetAction (timeout) MacroCmd_JobWaitForT=
arget(timeout*1000) end
+
+--~ LastTargetAction
+function gRazorMacroCmd.LastTargetAction () MacroCmd_TargetLastNow() end
+
+--~ TargetRelLocAction|2|0
+function gRazorMacroCmd.TargetRelLocAction (dx,dy) if (gPlayerXLoc) then M=
acroCmd_TargetGroundNow(gPlayerXLoc+dx,gPlayerYLoc+dy) end end
+
+--~ AbsoluteTargetAction|0|0|41651|1657|310|-85|118
+function gRazorMacroCmd.AbsoluteTargetAction (u1,u2,uartid,u4,u5,u6,u7) pr=
int("AbsoluteTargetAction",u1,u2,uartid,u4,u5,u6,u7) end
+
+--~ HotKeyAction|1195| -- clear target queue
+function gRazorMacroCmd.HotKeyAction (hotkeyaction,param) =

+	local handler =3D gRazorHotKeyAction[tonumber(hotkeyaction)]
+	print("HotKeyAction",hotkeyaction,handler,param)
+	if (handler) then handler(param) end
+end
+
+--~ SpeechAction|0|198|3|enu|5|48|232|22|49|108|all follow me
+function gRazorMacroCmd.SpeechAction (u1,u2,u3,enu,u4,u5,u6,u7,u8,u9,text)=
 MacroCmd_Say(text) end
+
+--~ ExtCastSpellAction|507|4294967295
+function gRazorMacroCmd.ExtCastSpellAction (uspellid,u2) print("ExtCastSpe=
llAction",uspellid,u2) end
+
+--~ MacroCastSpellAction|44 -- (magetrain.macro) (lastspell?)
+function gRazorMacroCmd.MacroCastSpellAction (spellid) print("MacroCastSpe=
llAction",spellid) end
+
+
+--~ GumpResponseAction|21|0|0
+function gRazorMacroCmd.GumpResponseAction (a,b,c) print("HotKeyAction",a,=
b,c) end
+
+--~ WaitForGumpAction|949095101|False|300
+function gRazorMacroCmd.WaitForGumpAction (gumptype,u1,timeout) print("Wai=
tForGumpAction",gumptype,u1,timeout) end
+
+-- dummy
+gRazorMacroCmd["!Loop"] =3D function () end
+
 =

 function ExecRazorMacroCommand (command) =

 	if (not command[1]) then return end
@@ -268,28 +274,85 @@
 	handler(unpack(command,2))
 end
 =

+function RazorEvaluateIf (command)
+	print("TODO:RazorEvaluateIf",unpack(command))
+	return true
+end
+
+
+function StopRazorMacro ()
+	if (not gLastRazorMacroJobID) then return end
+	job.terminate(gLastRazorMacroJobID)
+	gLastRazorMacroJobID =3D nil
+end
+
 function StartRazorMacroJob (macroname)
 	local macro =3D gRazorMacros[macroname]
 	if (not macro) then return end
 	local bLoop =3D (macro[1] and macro[1][1]) =3D=3D "!Loop"
 	print("StartRazorMacroJob name,loop=3D",macroname,bLoop)
-	--~ job.create(function()
-			--~ repeat =

-				-- TODO : for,if,...
-				for i,command in ipairs(macro) do ExecRazorMacroCommand(command) end
-				--~ job.wait(1)
-			--~ until (not bLoop)
-		--~ end)
+	StopRazorMacro()
+	gLastRazorMacroJobID =3D job.create(function()
+			repeat =

+				local stack =3D {} -- if,for
+				local i =3D 1
+				local cmd
+				local iSkipUntilEndIfOrElseDepth =3D 0
+				repeat 	=

+					local command =3D macro[i] =

+					local top =3D stack[#stack]
+					print("macroline",i,iSkipUntilEndIfOrElseDepth,command[1])
+					if (command[1] =3D=3D "IfAction") then --~ IfAction|4|0|you prepare t=
o perform a shadowjump.
+						if (iSkipUntilEndIfOrElseDepth > 0) then
+							iSkipUntilEndIfOrElseDepth =3D iSkipUntilEndIfOrElseDepth + 1
+						elseif (not RazorEvaluateIf(command)) then =

+							iSkipUntilEndIfOrElseDepth =3D 1
+						end
+					elseif (command[1] =3D=3D "ElseAction") then
+						if (iSkipUntilEndIfOrElseDepth =3D=3D 1) then =

+							iSkipUntilEndIfOrElseDepth =3D 0 -- if (false) then .. else =

+						elseif (iSkipUntilEndIfOrElseDepth =3D=3D 0) then
+							iSkipUntilEndIfOrElseDepth =3D 1 -- if (true) then .. else =

+						end
+					elseif (command[1] =3D=3D "EndIfAction") then
+						if (iSkipUntilEndIfOrElseDepth > 0) then  =

+							iSkipUntilEndIfOrElseDepth =3D iSkipUntilEndIfOrElseDepth - 1
+						end -- otherwise it was a non-nested and non-skipped -- if (true) th=
en ... endif
+					elseif (iSkipUntilEndIfOrElseDepth =3D=3D 0) then
+						job.wait(1)
+						if (command[1] =3D=3D "ForAction") then --~ ForAction|10
+							local times =3D tonumber(command[2]) or 1
+							table.insert(stack,{times,i})
+							print("for loop start",times,i)
+						elseif (command[1] =3D=3D "EndForAction") then
+							assert(type(top) =3D=3D "table","razor macro : malformed for : endf=
or")
+							local times,forstart =3D unpack(top)
+							table.remove(stack)
+							if (times >=3D 2) then
+								print("razor macro : for loop start,left",forstart,times-1)
+								i =3D forstart =

+								table.insert(stack,{times-1,i})
+							end
+						else
+							ExecRazorMacroCommand(command)
+						end
+					end
+					i =3D i + 1
+				until i > #macro
+				job.wait(1)
+			until (not bLoop)
+		end)
 end
 =

 =

 =

 local filepath =3D "/home/ghoul/Desktop/cavern/razorprofile/default.xml" -=
- FileOpenDialog_RazorProfile()
---~ ImportRazorHotkeys(filepath)
---~ LoadRazorMacros("/cavern/razorcopy/".."Macros/")
-
 --~ local xml =3D LuaXML_ParseFile(filepath)[1]
 --~ print(SmartDump(xml[1]))
 --~ LuaXML_SaveFile("../bla.xml",xml)
+--~ ImportRazorHotkeys(filepath)
+--~ LoadRazorMacros("/cavern/razorcopy/".."Macros/")
 --~ StartRazorMacroJob("bola")
+--~ StartRazorMacroJob("mine")
+--~ StartRazorMacroJob("trainnin")
 --~ os.exit(0)

Modified: trunk/lua/net/net.aoscommand.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.aoscommand.lua (original)
+++ trunk/lua/net/net.aoscommand.lua Sat Nov 15 03:15:11 2008
@@ -129,6 +129,15 @@
 		Send_AOSCommand_WeaponAbility(gLastSelectedWeaponAbility)
 	end
 end)
+
+function GetWeaponSpecialsForMobile (mobile) =

+	if (not mobile) then return end
+	local item1 =3D GetMobileEquipmentItem(mobile,gLayerType.kLayer_OneHanded)
+	local item2 =3D GetMobileEquipmentItem(mobile,gLayerType.kLayer_TwoHanded=
) -- might be shield,lantern...
+	local artid =3D (item1 and item1.artid) or (item2 and item2.artid) or 0 -=
- 0 if barehanded
+	local skills =3D glWeaponAbilitiesWeapons[artid] or glWeaponAbilitiesWeap=
ons[0] -- could have a nonweapon in second hand : fall back to barehanded
+	if skills then return skills.first,skills.second end
+end =

 =

 -- icon hueing
 function UpdateWeaponAbilityIcons ()

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Sat Nov 15 03:15:11 2008
@@ -396,6 +396,7 @@
 -- ##### ##### ##### ##### ##### the rest
 =

 =

+function gMobilePrototype:GetWeapon() return self:GetEquipmentAtLayer(kLay=
er_OneHanded) or self:GetEquipmentAtLayer(kLayer_TwoHanded) end
 function gMobilePrototype:GetEquipmentAtLayer(layer)
 	for k,dynamic in pairs(self:GetContent()) do if (dynamic.layer =3D=3D lay=
er) then return dynamic end end
 end

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Sat Nov 15 03:15:11 2008
@@ -130,6 +130,7 @@
 	end
 end
 =

+function GetPlayerWeapon () local playermobile =3D GetPlayerMobile() retur=
n playermobile and playermobile:GetWeapon() end =

 =

 function PlayerGetMount ()
 	local playermobile =3D GetPlayerMobile()

Modified: trunk/lua/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.gumpdialog.lua (original)
+++ trunk/lua/widgets/widget.gumpdialog.lua Sat Nov 15 03:15:11 2008
@@ -55,7 +55,7 @@
 	end
 	if (gumpdata.textline) then =

 		for k,line in pairs(gumpdata.textline) do =

-			print("GumpDialog:Search line",search,line) =

+			--~ print("GumpDialog:Search line",search,line) =

 			if (StringContains(line,search)) then return true end =

 		end
 	end



From no-reply at zwischenwelt.org  Sun Nov 16 14:00:27 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Nov 2008 13:00:27 -0000
Subject: [Iris-commit] [IRIS] r2732 - in /trunk/lua: filter/filter.art.lua
 lib.3d.dynamic.lua lib.tilefreewalk.lua
Message-ID: <20081116130029.6C03F1C1879B@zwischenwelt.org>

Author: hagish
Date: Sun Nov 16 14:00:22 2008
New Revision: 2732

Log:
bugfix: after opening a door in 3d its not passable until you walk a step

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.tilefreewalk.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Sun Nov 16 14:00:22 2008
@@ -105,6 +105,10 @@
 gArtFilter[9187]=3D{maptoid=3D9189,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 gArtFilter[9191]=3D{maptoid=3D9189,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
 gArtFilter[9193]=3D{maptoid=3D9189,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+
+
+-- wood
+gArtFilter[7138]=3D{maptoid=3D7135,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
 =

 -- ceramic roof blue
 gArtFilter[9157]=3D{maptoid=3D9155,rotation=3D"x:0,y:0,z:-180",xadd=3D1,ya=
dd=3D1,zadd=3D0}

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Sun Nov 16 14:00:22 2008
@@ -318,6 +318,11 @@
 function Renderer3D:AddDynamicItem( item )
 	assert(not item.gfx)
 =

+	-- clear walk cache around dynamic
+	if item and item.xloc and item.yloc and gTileFreeWalk then
+		gTileFreeWalk:IvalidateCacheAround(item.xloc, item.yloc)
+	end
+
 	item.artid =3D CheckIfBoat(item.artid)
 	=

 	-- FILTER: get correction
@@ -585,6 +590,11 @@
 		Renderer3D:DestroyMultiGraphic(dynamic.serial)
 	end
 	=

+	-- clear walk cache around dynamic
+	if dynamic and dynamic.xloc and dynamic.yloc and gTileFreeWalk then
+		gTileFreeWalk:IvalidateCacheAround(dynamic.xloc, dynamic.yloc)
+	end
+
 	-- remove lightsource from dynamic
 	if (dynamic.lightname) then Renderer3D:RemovePointLight(dynamic.lightname=
) dynamic.lightname =3D nil end
 	=


Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Sun Nov 16 14:00:22 2008
@@ -392,6 +392,17 @@
 	self.groundcache =3D groundcache
 end
 =

+-- triggers a rescan of the collision information around the given location
+function gTileFreeWalk:IvalidateCacheAround(xloc,yloc,radius)
+	radius =3D radius or 5
+	if self.lastscanxloc and self.lastscanyloc then
+		if dist2(xloc,yloc, self.lastscanxloc,self.lastscanyloc) < radius then
+			self.lastscanxloc =3D nil
+			self.lastscanyloc =3D nil
+		end
+	end
+end
+
 -- scans the ground if clientpos entered a new tile, calculates walls
 function gTileFreeWalk:ScanGroundIfNeeded (xloc,yloc,zloc,rx,ry,rz)
 	if (self.lastscanxloc ~=3D xloc or self.lastscanyloc ~=3D yloc) then



From no-reply at zwischenwelt.org  Sun Nov 16 16:33:24 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 16 Nov 2008 15:33:24 -0000
Subject: [Iris-commit] [IRIS] r2733 - in /trunk: data/base/main.material
 data/terrain/textures/watertrans.png lua/config_declarations.lua
 lua/lib.2d.mousepick.lua lua/lib.2d.spriteblock.lua lua/lib.macrolist.lua
 lua/lib.razorconfig.lua lua/lib.uoids.lua
Message-ID: <20081116153325.216EC1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov 16 16:33:24 2008
New Revision: 2733

Log:
2d animated and transparent water experiment

Added:
    trunk/data/terrain/textures/watertrans.png   (with props)
Modified:
    trunk/data/base/main.material
    trunk/lua/config_declarations.lua
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.razorconfig.lua
    trunk/lua/lib.uoids.lua

Modified: trunk/data/base/main.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/main.material (original)
+++ trunk/data/base/main.material Sun Nov 16 16:33:24 2008
@@ -496,3 +496,37 @@
 		}
 	}
 }
+
+
+
+
+material Water2D
+{
+	receive_shadows on
+	technique
+	{
+		pass
+		{
+			scene_blend alpha_blend  =

+			ambient 1.0 1.0 1.0 1.0
+			specular 0 0 0 1.0
+
+			texture_unit
+			{
+				//texture water.jpg =

+				texture watertrans.png =

+				// watertrans.png
+				tex_address_mode wrap
+				=

+				// animate using texcoords
+				// wave_xform <xform_type> <wave_type> <base> <frequency> <phase> <amp=
litude>
+				wave_xform scroll_x sine 1.0 0.1 0.0 0.1
+				wave_xform scroll_y sine 1.0 0.1 0.1 0.1
+				//scroll_anim 0.2 0.1
+			}
+		}
+	}
+}
+
+
+

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sun Nov 16 16:33:24 2008
@@ -477,12 +477,14 @@
 =

 gConfig:DeclareBoolean("gIgnoreGlobalLightLevel", "gfx", "ignore global li=
ght", 'if this is true the world is always day bright', false)
 =

+gConfig:DeclareBoolean("gEnable2DWaterAnim", "gfx", "2D : Water Animation"=
, 'enable/disable Water Animation in 2d mode', false)
 gConfig:DeclareBoolean("gUseWaterShader", "gfx", "water shader", 'TODO', f=
alse)
 gConfig:DeclareBoolean("gWaterAsGroundTiles", "gfx", "water as ground tile=
s", 'TODO', false)
 =

 gConfig:DeclareBoolean("gShowHealthBarOverEveryMobile", "gui", "healthbar =
over mobile", 'TODO', false)
 =

 gConfig:DeclareBoolean("gLogStatsToFile", "debug", "log stats to file", 'd=
umps statistical informations into stats.dat', false)
+
 =

 =

 -- port me to new config system ! (or extend system for complex stuff)

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Sun Nov 16 16:33:24 2008
@@ -111,7 +111,16 @@
 			hitinfo =3D hitinfo..sprintf("container(id=3D0x%08x)",o.container and o=
.container.serial or 0) =

 			--~ print(sprintf("container(id=3D0x%08x)",o.container and o.container.=
serial or 0))
 		end
-	end
+		=

+	end
+	=

+	local dialog =3D GetDialogUnderMouse()
+	if (dialog and dialog.GetPos) then
+		local xd,yd =3D dialog:GetPos()
+		local x,y =3D GetMousePos()
+		hitinfo =3D hitinfo..sprintf("mouserel(%d,%d)",x-xd,y-yd) =

+	end
+	=

 	Client_SetBottomLine(hitinfo)
 end
 =


Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sun Nov 16 16:33:24 2008
@@ -11,6 +11,7 @@
 	self.pTileTypeAtlasMats =3D {} -- self.pTileTypeAtlasMats[iTileTypeID][iH=
ue] =3D pAtlasPiece (see ArtAtlasLoadAndLock)
 	self.pGroupGfx =3D {}
 	self.pSpritesByAtlas =3D {}
+	self.pWaterTiles =3D {}
 	self.bVisible =3D true
 end
 =

@@ -41,6 +42,7 @@
 function cUOSpriteBlock:Clear ()
 	self:ClearGfx()
 	self.pSpritesByAtlas =3D {}
+	self.pWaterTiles =3D {}
 end
 =

 function TileOffsetToPixelOffset (tx,ty)
@@ -122,6 +124,7 @@
 -- static comes from MapGetBlockStatics(bx,by) : {zloc=3D?,artid=3D?,hue=
=3D?,xloc=3D?,yloc=3D?,tx=3D?,ty=3D?,bx=3D?,by=3D?,bIsStatic=3Dtrue}
 function cUOSpriteBlock:AddStatic (static)
 	local artid =3D SeasonalStaticTranslation(static.artid, gSeasonSetting,tr=
ue) -- bUseFoliageSkip
+	if (gEnable2DWaterAnim and gStaticWaterByArtIDs[artid]) then self:AddStat=
icWaterTile(static) return end
 	local tx =3D static.tx
 	local ty =3D static.ty
 	local zloc =3D static.zloc
@@ -274,10 +277,48 @@
 =

 function cUOSpriteBlock:LoadAtlasMat	(atlas,basemat)
 	-- works for art and uoanim (see atlasgroup system)
+	if (atlas.forced_matname) then return atlas.forced_matname end
 	if (atlas.atlasgroup) then return atlas.atlasgroup:LoadAtlasMat(atlas,bas=
emat) end
 end
 =

 -- bUseRootGfxForFirst : default false, can be set to true if there is onl=
y one sprite
+function cUOSpriteBlock:AddStaticWaterTile 	(static)
+	local multitile =3D 8 -- gWater2DMatName
+	local e =3D 1/multitile
+	local tx =3D static.tx
+	local ty =3D static.ty
+	local u0,v0 =3D (tx%multitile)*e,(ty%multitile)*e
+	local zloc =3D static.zloc
+	local sortbonus =3D CalcSortBonus(static.artid,tx,ty,zloc,static.fBlockIn=
dexRel)
+	=

+	local pw =3D 44
+	local ph =3D 44
+	=

+	local x,y,z =3D -tx,ty,zloc * kRenderer2D_ZScale
+	local sortadd =3D sortbonus * kRenderer2D_ZScale + 1
+	local movedown =3D 1 -- ox-1,oy+1 : sprites are too high normally, this m=
oves them down =

+	x =3D x +   -1 * sortadd - movedown  =

+	y =3D y +    1 * sortadd + movedown
+	z =3D z + kSq2 * sortadd
+	local xa =3D 0.5 * pw * kRenderer2D_XPixelScale
+	local za =3D       ph * kRenderer2D_YPixelScale	=

+	=

+	local watertile =3D {
+		x =3D x,
+		y =3D y,
+		z =3D z,
+		xa =3D xa,
+		za =3D za,
+		u0 =3D u0,
+		v0 =3D v0,
+		u1 =3D u0+e,
+		v1 =3D v0+e,
+		data =3D static
+	}
+	table.insert(self.pWaterTiles,watertile)
+end
+
+gWater2DMatName =3D "Water2D"
 function cUOSpriteBlock:Build 	(basemat,bUseRootGfxForFirst)
 	self:ClearGfx()
 	self.rootgfx =3D CreateRootGfx3D()
@@ -286,6 +327,52 @@
 	-- -so 1420,1550
 	-- -so 552,2088
 	-- -so 632,1488
+	=

+	-- watertiles
+	local spritecount =3D #self.pWaterTiles
+	if (spritecount > 0) then
+		local gfx
+		if (bUseRootGfxForFirst) then
+			bUseRootGfxForFirst =3D false
+			gfx =3D self.rootgfx
+		else
+			gfx =3D self.rootgfx:CreateChild()
+			table.insert(self.pGroupGfx,gfx)
+		end
+		gfx:SetSimpleRenderable()
+		gfx:SetMaterial(gWater2DMatName)
+		=

+		-- generate geometry
+		local vc =3D 4*spritecount
+		local ic =3D 6*spritecount
+		gfx:RenderableBegin(vc,ic,false,false,OT_TRIANGLE_LIST)
+		vc =3D 0
+		for k,sprite in pairs(self.pWaterTiles) do
+			local x 		=3D sprite.x
+			local y 		=3D sprite.y
+			local z 		=3D sprite.z
+			local xa 		=3D sprite.xa
+			local za 		=3D sprite.za
+			local u0 		=3D sprite.u0
+			local v0 		=3D sprite.v0
+			local u1 		=3D sprite.u1
+			local v1 		=3D sprite.v1
+			gfx:RenderableVertex(x,y,z  			, u1,v1)
+			gfx:RenderableVertex(x+xa,y+xa,z+za*0.5	, u0,v1)
+			gfx:RenderableVertex(x-xa,y-xa,z+za*0.5	, u1,v0)
+			gfx:RenderableVertex(x,y,z+za			, u0,v0)
+			--~ gfx:RenderableVertex(x-xa,y-xa,z  	, u1,v1)
+			--~ gfx:RenderableVertex(x+xa,y+xa,z  	, u0,v1)
+			--~ gfx:RenderableVertex(x-xa,y-xa,z+za	, u1,v0)
+			--~ gfx:RenderableVertex(x+xa,y+xa,z+za	, u0,v0)
+			gfx:RenderableIndex3(vc+0,vc+2,vc+1)
+			gfx:RenderableIndex3(vc+1,vc+2,vc+3)
+			vc =3D vc + 4
+		end
+		gfx:RenderableEnd()
+	end
+		=

+	-- sprites
 	for atlas,group in pairs(self.pSpritesByAtlas) do
 		local matname =3D self:LoadAtlasMat(atlas,basemat)
 		if (not matname) then

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Nov 16 16:33:24 2008
@@ -147,10 +147,18 @@
 RegisterListener("Hook_TargetMode_Start",	function () =

 	if (gMacroQueuedTarget_Serial) then MacroCmd_SendTargetSerial(gMacroQueue=
dTarget_Serial) MacroCmd_QueuedTargetEnd(true) end
 end)
+
+gMacroJobsWaitingForGump =3D {}
+function MacroCmd_JobWaitForGump(timeout,callback) -- returns true if IsTa=
rgetModeActive
+	gMacroJobsWaitingForGump[job.running_id()] =3D callback
+	job.wait(timeout or 30000)
+end
 RegisterListener("Hook_OpenServersideGump",	function (dialog,playerid,dial=
ogId,Length_Data)	=

 	for data,v in pairs(gMacroGumpWaiters) do
 		if ((not data.search) or dialog:Search(data.search)) then data.callback(=
dialog) gMacroGumpWaiters[data] =3D nil end
 	end
+	=

+	for jobid,v in pairs(gMacroJobsWaitingForTarget) do job.wakeup(jobid,true=
) end gMacroJobsWaitingForTarget =3D {}
 end)
 =

 gMacroGumpWaiters =3D {} =


Modified: trunk/lua/lib.razorconfig.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.razorconfig.lua (original)
+++ trunk/lua/lib.razorconfig.lua Sun Nov 16 16:33:24 2008
@@ -173,6 +173,34 @@
 gRazorSpellConfig["L:1071041"] =3D "Arcane Empowerment"
 gRazorSpellConfig["L:1071026"] =3D "Arcane Circle"
 	=

+	=

+--[[
+Assistant.Macros.HotKeyAction|1044061| Anato
+Assistant.Macros.HotKeyAction|1044062| Animal Lore
+Assistant.Macros.HotKeyAction|1044095| Animal Taming
+Assistant.Macros.HotKeyAction|1044064| Arms Lore
+Assistant.Macros.HotKeyAction|1044066| Begging
+Assistant.Macros.HotKeyAction|1044072| Carthography
+Assistant.Macros.HotKeyAction|1044074| Detect Hidden
+Assistant.Macros.HotKeyAction|1044108| Disamring ??????
+Assistant.Macros.HotKeyAction|1044075| Discordance
+Assistant.Macros.HotKeyAction|1044076| Eval Int
+Assistant.Macros.HotKeyAction|1044079| Foren
+Assistant.Macros.HotKeyAction|1044081| Hide
+Assistant.Macros.HotKeyAction|1044083| Inscri
+Assistant.Macros.HotKeyAction|1044063| Item Id
+Assistant.Macros.HotKeyAction|1044106| Medi
+Assistant.Macros.HotKeyAction|1044069| Peace
+Assistant.Macros.HotKeyAction|1044090| Poison
+Assistant.Macros.HotKeyAction|1044082| Provo
+Assistant.Macros.HotKeyAction|1044092| Spirit Speak
+Assistant.Macros.HotKeyAction|1044093| Stealing
+Assistant.Macros.HotKeyAction|1044107| Stealth
+Assistant.Macros.HotKeyAction|1044096| TasteID
+Assistant.Macros.HotKeyAction|1044096| TasteID
+Assistant.Macros.HotKeyAction|1044098| Tracking
+]]--
+	=

 function FileOpenDialog_RazorProfile ()
 	return FileOpenDialog(WIN32 and "C:\Program Files\Razor\Profiles" or ".",=
"*.xml","select a razor profile to load, often Razor\\Profiles\\default.xml=
")
 end

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sun Nov 16 16:33:24 2008
@@ -641,3 +641,7 @@
 	[11572] =3D {first=3D5,second=3D4},
 	[11573] =3D {first=3D17,second=3D24},
 }
+
+gStaticWaterArtIDs =3D {0x1559,0x1796,0x1797,0x1798,0x1799,0x179a,0x179b,0=
x179c,0x179d,0x179e,0x179f,0x17a0,0x17a1,0x17a2,0x17a3,0x17a4,0x17a5,0x17a6=
,0x17a7,0x17a8,0x17a9,0x17aa,0x17ab,0x17ac,0x17ad,0x17ae,0x17af,0x17b0,0x17=
b1,0x17b2,0x346e,0x346f,0x3470,0x3471,0x3472,0x3473,0x3474,0x3475,0x3476,0x=
3477,0x3478,0x3479,0x347a,0x347b,0x347c,0x347d,0x347e,0x347f,0x3480,0x3481,=
0x3482,0x3483,0x3484,0x3485,0x3494,0x3495,0x3496,0x3497,0x3498,0x349a,0x349=
b,0x349c,0x349d,0x349e,0x34a0,0x34a1,0x34a2,0x34a3,0x34a4,0x34a6,0x34a7,0x3=
4a8,0x34a9,0x34aa,0x34ab,0x34b8,0x34b9,0x34ba,0x34bb,0x34bd,0x34be,0x34bf,0=
x34c0,0x34c2,0x34c3,0x34c4,0x34c5,0x34c7,0x34c8,0x34c9,0x34ca}
+gStaticWaterByArtIDs =3D {}
+for k,artid in ipairs(gStaticWaterArtIDs) do gStaticWaterByArtIDs[artid] =
=3D true end



From no-reply at zwischenwelt.org  Mon Nov 17 19:17:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 17 Nov 2008 18:17:54 -0000
Subject: [Iris-commit] [IRIS] r2734 - in /trunk/lua: lib.2d.mobile.lua
 lib.2d.mousepick.lua lib.macrolist.lua lib.mount.lua lib.uoanim.lua
Message-ID: <20081117181754.84A0C1C187E4@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 17 19:17:53 2008
New Revision: 2734

Log:
2d : chimera gfx fixed, improved 2d fallback anim, new macro commands : Mac=
roCmd_JobWaitForGumpWithKeyword MacroCmd_FindGumpByKeyword

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mount.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Mon Nov 17 19:17:53 2008
@@ -118,6 +118,7 @@
 	spriteblock:Clear()
 	=

 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
+	--~ if (mount) then mount.artid =3D 0x3e90 print("mount:chimera test") en=
d  -- =

 	=

 	local fTimeSinceLastMove =3D gMyTicks - (mobile.r2d_lastmoved or 0)
 	local bRun =3D TestBit(mobile.dir or 0,0x80)
@@ -165,14 +166,21 @@
 			local iAnimID =3D		bMoving and	(Anim_GetMoveAnim(iModelID,iLoaderIndex,=
mount,bRun) + iDirAdd) or
 											(Anim_GetIdleAnim(iModelID,iLoaderIndex,mount) + iDirAdd)
 			=

+			--~ if (iOldModelID =3D=3D 0x114) then iHue=3D0 print("chim anim",iAnim=
ID-iDirAdd) iAnimID =3D 55 + iDirAdd end
+			=

+			=

+			local iFallBackAnim =3D iFallBackModel and (bMoving and	(Anim_GetMoveAn=
im(iFallBackModel,1,mount,bRun) + iDirAdd) or
+																	(Anim_GetIdleAnim(iFallBackModel,1,mount) + iDirAdd))
+																	=

 			if (gMy2DMobileDebugAnim) then iAnimID =3D gMy2DMobileDebugAnim end
 			=

 			=

-			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID,iLoaderIndex),iLoaderIndex) or 1
+			local iFrameCount =3D		Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAn=
imID,iLoaderIndex),iLoaderIndex) or
+									(iFallBackModel and Anim2D_GetFrameCount(Anim_GetRealID(iFallBack=
Model,iFallBackAnim,1),1)) or =

+									1
 			if (iFrameCount < 1) then iFrameCount =3D 1 end
 			--~ local iFrame =3D floor((gMy2DDebugFrame or 0) / 15) % iFrameCount
 			local iFrame =3D (floor(gMyTicks/100)) % iFrameCount
-			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del,1)
 			spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackM=
odel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,=
sorttz,fIndexRel,4),mobile) =

 		end
 	end

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Mon Nov 17 19:17:53 2008
@@ -100,6 +100,14 @@
 			local tx,ty =3D xloc % 8,yloc % 8
 			hitinfo =3D hitinfo..sprintf("pos=3D(%d,%d,%d),b=3D(%d,%d),txty=3D(%d,%=
d),",xloc,yloc,zloc,bx,by,tx,ty)
 		end
+		if (o.hittype =3D=3D kMousePickHitType_Container 		) then =

+			hitinfo =3D hitinfo..sprintf("container(0x%08x),",o.container and o.con=
tainer.serial or 0) =

+			--~ print(sprintf("container(id=3D0x%08x)",o.container and o.container.=
serial or 0))
+		end
+		if (o.hittype =3D=3D kMousePickHitType_Mobile 			) then =

+			local mount =3D o.mobile and o.mobile:GetEquipmentAtLayer(kLayer_Mount)
+			if (mount) then hitinfo =3D hitinfo..sprintf("mount-artid(id=3D0x%04x),=
",mount.artid) end =

+		end
 		if (o.hittype =3D=3D kMousePickHitType_Static			) then hitinfo =3D hitin=
fo.."static" end
 		if (o.hittype =3D=3D kMousePickHitType_Terrain 			) then hitinfo =3D hit=
info.."terrain" end
 		if (o.hittype =3D=3D kMousePickHitType_Dynamic 			) then hitinfo =3D hit=
info.."dynamic" end
@@ -107,11 +115,6 @@
 		if (o.hittype =3D=3D kMousePickHitType_ContainerItem 	) then hitinfo =3D=
 hitinfo.."containeritem" end
 		if (o.hittype =3D=3D kMousePickHitType_PaperdollItem 	) then hitinfo =3D=
 hitinfo.."paperdollitem" end
 		if (o.hittype =3D=3D kMousePickHitType_Ground 			) then hitinfo =3D hiti=
nfo.."ground" end
-		if (o.hittype =3D=3D kMousePickHitType_Container 		) then =

-			hitinfo =3D hitinfo..sprintf("container(id=3D0x%08x)",o.container and o=
.container.serial or 0) =

-			--~ print(sprintf("container(id=3D0x%08x)",o.container and o.container.=
serial or 0))
-		end
-		=

 	end
 	=

 	local dialog =3D GetDialogUnderMouse()

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Nov 17 19:17:53 2008
@@ -138,6 +138,7 @@
 function MacroCmd_JobWaitForTarget(timeout) -- returns true if IsTargetMod=
eActive
 	gMacroJobsWaitingForTarget[job.running_id()] =3D true
 	job.wait(timeout or 30000)
+	gMacroJobsWaitingForTarget[job.running_id()] =3D nil
 	return IsTargetModeActive()
 end
 RegisterListener("Hook_TargetMode_Start",	function () =

@@ -149,16 +150,34 @@
 end)
 =

 gMacroJobsWaitingForGump =3D {}
-function MacroCmd_JobWaitForGump(timeout,callback) -- returns true if IsTa=
rgetModeActive
+function MacroCmd_JobWaitForGump(callback,timeout) -- callback(dialog,play=
erid,dialogId) should return true for the gump that it waited for
 	gMacroJobsWaitingForGump[job.running_id()] =3D callback
 	job.wait(timeout or 30000)
-end
+	gMacroJobsWaitingForGump[job.running_id()] =3D nil
+end
+function MacroCmd_JobWaitForGumpWithKeyword(keyword,timeout) =

+	local dialog =3D MacroCmd_FindGumpByKeyword(keyword)
+	if (dialog) then return dialog end
+	MacroCmd_JobWaitForGump(function(dialog) return dialog:Search(keyword) en=
d,timeout) =

+	return MacroCmd_FindGumpByKeyword(keyword)
+end
+function MacroCmd_FindGumpByKeyword(keyword)
+	for k,dialog in pairs(gServerSideGump) do =

+		if (dialog:Search(keyword)) then return dialog end
+	end
+end
+
 RegisterListener("Hook_OpenServersideGump",	function (dialog,playerid,dial=
ogId,Length_Data)	=

 	for data,v in pairs(gMacroGumpWaiters) do
 		if ((not data.search) or dialog:Search(data.search)) then data.callback(=
dialog) gMacroGumpWaiters[data] =3D nil end
 	end
 	=

-	for jobid,v in pairs(gMacroJobsWaitingForTarget) do job.wakeup(jobid,true=
) end gMacroJobsWaitingForTarget =3D {}
+	for jobid,callback in pairs(gMacroJobsWaitingForGump) do =

+		if ((not callback) or callback(dialog,playerid,dialogId)) then =

+			job.wakeup(jobid,true) =

+			gMacroJobsWaitingForGump[jobid] =3D nil =

+		end
+	end
 end)
 =

 gMacroGumpWaiters =3D {} =


Modified: trunk/lua/lib.mount.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mount.lua (original)
+++ trunk/lua/lib.mount.lua Mon Nov 17 19:17:53 2008
@@ -30,7 +30,8 @@
 gMountHueOverride[0x3E9C] =3D 0 --Ethereal Kirin		=

 gMountHueOverride[0x3E98] =3D 0 --Ethereal SwampDragon
   =

-gMountTranslate[0x3E90] =3D 0x69  -- chimera (temporary placeholder model)=
 original is 0x114, but wing broken
+gMountTranslate[0x3E90] =3D 0x114   -- chimera     wing broken in 3d, but =
these ids are needed for 2d as well, override 3d specific stuff below
+
 gMountTranslate[0x3E91] =3D 0x115  -- cusidhe (correct model?)  0x7f 0x64 =
0x62 0x17
 gMountTranslate[0x3E95] =3D 0x317  -- giantfirebeetle (temporary placehold=
er model)
 					=

@@ -78,6 +79,7 @@
 =

 -- currently broken granny anims
 gMountGrannyOverride =3D {}
+gMountGrannyOverride[0x114] =3D 0x69 -- chimera : wing broken in 3d
 gMountGrannyOverride[0xCC] =3D gStandardHorse -- dark brown horse
 gMountGrannyOverride[0xE2] =3D gStandardHorse -- light grey horse
 gMountGrannyOverride[0xE4] =3D gStandardHorse -- grey brown horse

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Mon Nov 17 19:17:53 2008
@@ -220,6 +220,7 @@
 end
 =

 =

+
 -- returns atlaspiece
 function Anim2DAtlas_LoadAtlasPiece (iModelID,iAnimID,iFrame,iHue,iLoaderI=
ndex)
 	return Anim2DAtlas_LoadAtlasPieceEx(Anim_GetRealID(iModelID,iAnimID,iLoad=
erIndex),iFrame,iHue,iLoaderIndex)
@@ -283,6 +284,21 @@
 	return bHasMount and 125 or 20  -- Human
 end
 =

+-- chimera loader=3D5 iModelID=3D0x66=3D102
+-- chim : RealID =3D 11210,11274  =

+-- 11210 : walk  don't move wings, only feet
+-- 11215 : run   flap with wings and move feet
+-- 11220 : idle
+-- 11225 : idle-anim (move a bit)
+-- 11230 : cast (roar and flap wings)
+-- 11235 : attack (meelee, stand up and claw)
+-- 11240 : attack2 (meelee, bite)
+-- 11245 : gethit
+-- 11250 : die
+-- 11255 : cast? roar and flap wings
+-- 11260 : gethit ? short anim
+-- 11265 : sit on ground
+-- 11270 : die forward
 =

 function Anim_GetMoveAnim (iModelID,iLoaderIndex,bHasMount,bRun)
 	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
@@ -310,11 +326,21 @@
 	return 175
 end
 =

-
+-- 1760 - 1870 =3D 110 =

+-- 4070 - 4180 =3D 110    37*110
+-- 4180 - 4290 =3D 110    38*110
+-- 4290 - 4385 =3D 95 ???
+-- chim : RealID =3D 11210,11274 : 65 anims  .. 65*2 =3D 130
+-- first : 11210 : walk =

+-- last  : 11270 : die forward
+	--~ Anim2DAtlas_LoadAtlasPiece      iModelID=3D102     iAnimID=3D0       =
iLoaderIndex=3D5       iFrame=3D0
+	--~ Anim2DAtlas_LoadAtlasPieceEx    11220   0       1009    5
+	=

 -- iID is probably bodyid, and animid the animation ? ported from varans c=
ode
-gUOAnimRealIDCatBoundsByLoaderIndex =3D { [1]=3D{200,200}, [2]=3D{200,200}=
, [3]=3D{700,700}, [4]=3D{200,200}, [5]=3D{200,200}}
+gUOAnimRealIDCatBoundsByLoaderIndex =3D { [1]=3D{200,200}, [2]=3D{200,200}=
, [3]=3D{700,700}, [4]=3D{200,200}, [5]=3D{100,200,102,11210}}
 function Anim_GetRealID (iModelID,iAnimID,iLoaderIndex)
-	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
+	local high,low,exminmodel,exminreal =3D unpack(gUOAnimRealIDCatBoundsByLo=
aderIndex[iLoaderIndex])
+	if (exminmodel and iModelID >=3D exminmodel) then return exminreal + (iMo=
delID-exminmodel)*65 + iAnimID end -- chimera
 	if (iModelID < high) then return iAnimID + iModelID*110 end
 	if (iModelID < high + low) then
 		return iAnimID + high*110 + (iModelID-high)*65
@@ -356,6 +382,12 @@
 =

 -- returns iNewModelID,iNewHue,iLoaderIndex
 function UOAnimTranslateBodyID (iOrigModelID,iOrigHue)
+	local iNewModelID,iNewHue,iLoaderIndex =3D UOAnimTranslateBodyIDAux(iOrig=
ModelID,iOrigHue)
+	if (iLoaderIndex =3D=3D 5 and iNewModelID =3D=3D 34) then iNewModelID =3D=
 102 end -- chimera
+	return iNewModelID,iNewHue,iLoaderIndex
+end
+
+function UOAnimTranslateBodyIDAux (iOrigModelID,iOrigHue)
 	local iModelID,iHue,iLoaderIndex =3D iOrigModelID,iOrigHue,1
 	local bodyConfDef =3D gBodyConfDef[iModelID] -- gBodyConfDef[bodyid] =3D =
{anim2,anim3,anim4,anim5}
 	if (bodyConfDef) then



From no-reply at zwischenwelt.org  Mon Nov 17 19:35:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 17 Nov 2008 18:35:38 -0000
Subject: [Iris-commit] [IRIS] r2735 - in /trunk/lua: lib.2d.dynamic.lua
	lib.uoanim.lua lib.uoids.lua
Message-ID: <20081117183538.2762D1C187E3@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 17 19:35:37 2008
New Revision: 2735

Log:
2d : fixed broken water barrel gfx

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.uoanim.lua
    trunk/lua/lib.uoids.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Mon Nov 17 19:35:37 2008
@@ -102,7 +102,7 @@
 			else -- regular item
 				local iTileTypeID	=3D item.artid
 				=

-				local animinfo =3D GetAnimDataInfo(iTileTypeID)
+				local animinfo =3D (not gBroken2DArtAnimsByID[iTileTypeID]) and GetAni=
mDataInfo(iTileTypeID)
 				if (animinfo) then
 					if (animinfo.miCount > 1) then
 						iTileTypeID =3D iTileTypeID + (animinfo.miFrames[floor(animinfo.miCo=
unt/2)] or 0)

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Mon Nov 17 19:35:37 2008
@@ -284,6 +284,7 @@
 	return bHasMount and 125 or 20  -- Human
 end
 =

+--~ chimera : mount item artid =3D 0x3e90 -> 0x114=3D276  bodyconf.def : 2=
76 -1 -1 -1 34  mulpatcher graphic : anim5 : 0x66=3D102
 -- chimera loader=3D5 iModelID=3D0x66=3D102
 -- chim : RealID =3D 11210,11274  =

 -- 11210 : walk  don't move wings, only feet
@@ -299,6 +300,13 @@
 -- 11260 : gethit ? short anim
 -- 11265 : sit on ground
 -- 11270 : die forward
+-- anim5:1760 - 1870 =3D 110 =

+-- anim5:4070 - 4180 =3D 110    37*110
+-- anim5:4180 - 4290 =3D 110    38*110
+-- anim5:4290 - 4385 =3D 95 ???
+-- chim : RealID =3D 11210,11274 : 65 anims  .. 65*2 =3D 130
+-- first : 11210 : walk =

+-- last  : 11270 : die forward
 =

 function Anim_GetMoveAnim (iModelID,iLoaderIndex,bHasMount,bRun)
 	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
@@ -325,16 +333,6 @@
 	if (iModelCat =3D=3D 2) then return 65 end
 	return 175
 end
-
--- 1760 - 1870 =3D 110 =

--- 4070 - 4180 =3D 110    37*110
--- 4180 - 4290 =3D 110    38*110
--- 4290 - 4385 =3D 95 ???
--- chim : RealID =3D 11210,11274 : 65 anims  .. 65*2 =3D 130
--- first : 11210 : walk =

--- last  : 11270 : die forward
-	--~ Anim2DAtlas_LoadAtlasPiece      iModelID=3D102     iAnimID=3D0       =
iLoaderIndex=3D5       iFrame=3D0
-	--~ Anim2DAtlas_LoadAtlasPieceEx    11220   0       1009    5
 	=

 -- iID is probably bodyid, and animid the animation ? ported from varans c=
ode
 gUOAnimRealIDCatBoundsByLoaderIndex =3D { [1]=3D{200,200}, [2]=3D{200,200}=
, [3]=3D{700,700}, [4]=3D{200,200}, [5]=3D{100,200,102,11210}}

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Mon Nov 17 19:35:37 2008
@@ -642,6 +642,10 @@
 	[11573] =3D {first=3D17,second=3D24},
 }
 =

+gBroken2DArtAnims =3D {0x154d}
+gBroken2DArtAnimsByID =3D {}
+for k,artid in ipairs(gBroken2DArtAnims) do gBroken2DArtAnimsByID[artid] =
=3D true end
+
 gStaticWaterArtIDs =3D {0x1559,0x1796,0x1797,0x1798,0x1799,0x179a,0x179b,0=
x179c,0x179d,0x179e,0x179f,0x17a0,0x17a1,0x17a2,0x17a3,0x17a4,0x17a5,0x17a6=
,0x17a7,0x17a8,0x17a9,0x17aa,0x17ab,0x17ac,0x17ad,0x17ae,0x17af,0x17b0,0x17=
b1,0x17b2,0x346e,0x346f,0x3470,0x3471,0x3472,0x3473,0x3474,0x3475,0x3476,0x=
3477,0x3478,0x3479,0x347a,0x347b,0x347c,0x347d,0x347e,0x347f,0x3480,0x3481,=
0x3482,0x3483,0x3484,0x3485,0x3494,0x3495,0x3496,0x3497,0x3498,0x349a,0x349=
b,0x349c,0x349d,0x349e,0x34a0,0x34a1,0x34a2,0x34a3,0x34a4,0x34a6,0x34a7,0x3=
4a8,0x34a9,0x34aa,0x34ab,0x34b8,0x34b9,0x34ba,0x34bb,0x34bd,0x34be,0x34bf,0=
x34c0,0x34c2,0x34c3,0x34c4,0x34c5,0x34c7,0x34c8,0x34c9,0x34ca}
 gStaticWaterByArtIDs =3D {}
 for k,artid in ipairs(gStaticWaterArtIDs) do gStaticWaterByArtIDs[artid] =
=3D true end



From no-reply at zwischenwelt.org  Mon Nov 17 20:48:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 17 Nov 2008 19:48:44 -0000
Subject: [Iris-commit] [IRIS] r2736 - in /trunk: data/mymacros.lua.dist
 lua/lib.razorconfig.lua lua/lib.razormacro.lua lua/main.lua
Message-ID: <20081117194845.413791C187E3@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 17 20:48:43 2008
New Revision: 2736

Log:
razor config importer starts working

Added:
    trunk/lua/lib.razormacro.lua
Modified:
    trunk/data/mymacros.lua.dist
    trunk/lua/lib.razorconfig.lua
    trunk/lua/main.lua

Modified: trunk/data/mymacros.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/mymacros.lua.dist (original)
+++ trunk/data/mymacros.lua.dist Mon Nov 17 20:48:43 2008
@@ -98,3 +98,6 @@
 SetMacro("alt+Z",	function() MacroCmd_Spell("Invisibility") end)
 SetMacro("alt+X",	function() MacroCmd_Spell("Meteor Swarm") end)
 ]]--
+
+SetMacro("shift+f11",	function() ImportRazorProfileDialog() end)
+ImportRazorProfile("C:\\Program Files\\Razor\\Profiles\\default.xml") -- i=
mport default config

Modified: trunk/lua/lib.razorconfig.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.razorconfig.lua (original)
+++ trunk/lua/lib.razorconfig.lua Mon Nov 17 20:48:43 2008
@@ -29,150 +29,175 @@
 --~ 65      a       0       L:1044092         spiritspeak
 =

 gRazorHotKeyAction =3D {}
-gRazorHotKeyAction[1473] =3D function () Send_DoubleClick(GetPlayerSerial(=
)) end -- dismount
-gRazorHotKeyAction[1195] =3D function () end -- clear target queue
-gRazorHotKeyAction[1059] =3D function () MacroCmd_TargetSelfNow() end -- t=
argetself
-gRazorHotKeyAction[1058] =3D function () MacroCmd_TargetLastNow() end -- t=
argetlast
-gRazorHotKeyAction[1013] =3D function () MacroCmd_WeaponAbilityPrimary() e=
nd
-
-
-
-gRazorSpellConfig =3D {}
+gRazorHotKeyAction[1473] =3D {name=3D"dismount",fun=3Dfunction () Send_Dou=
bleClick(GetPlayerSerial()) end} -- dismount
+gRazorHotKeyAction[1195] =3D {name=3D"clear target queue",fun=3Dfunction (=
) end} -- clear target queue
+gRazorHotKeyAction[1059] =3D {name=3D"targetself",fun=3Dfunction () MacroC=
md_TargetSelfNow() end} -- targetself
+gRazorHotKeyAction[1058] =3D {name=3D"targetlast",fun=3Dfunction () MacroC=
md_TargetLastNow() end} -- targetlast
+gRazorHotKeyAction[1013] =3D {name=3D"weapon:primary",fun=3Dfunction () Ma=
croCmd_WeaponAbilityPrimary() end}
+
+
+
+gRazorSpellID =3D {}
 --~ zirkel1"
-gRazorSpellConfig["L:3002018"] =3D "Weaken"
-gRazorSpellConfig["L:3002017"] =3D "Reactive Armor"
-gRazorSpellConfig["L:3002016"] =3D "Night Sight"
-gRazorSpellConfig["L:3002015"] =3D "Magic Arrow"
-gRazorSpellConfig["L:3002014"] =3D "Heal"
-gRazorSpellConfig["L:3002013"] =3D "FeebleMind"
-gRazorSpellConfig["L:3002012"] =3D "Create Food"
-gRazorSpellConfig["L:3002011"] =3D "Clumsy"
+gRazorSpellID[3002018] =3D "Weaken"
+gRazorSpellID[3002017] =3D "Reactive Armor"
+gRazorSpellID[3002016] =3D "Night Sight"
+gRazorSpellID[3002015] =3D "Magic Arrow"
+gRazorSpellID[3002014] =3D "Heal"
+gRazorSpellID[3002013] =3D "FeebleMind"
+gRazorSpellID[3002012] =3D "Create Food"
+gRazorSpellID[3002011] =3D "Clumsy"
 --~ zirkel2"
-gRazorSpellConfig["L:3002026"] =3D "Strength"
-gRazorSpellConfig["L:3002025"] =3D "Protection"
-gRazorSpellConfig["L:3002024"] =3D "Magic Untrap"
-gRazorSpellConfig["L:3002023"] =3D "Magic Trap"
-gRazorSpellConfig["L:3002022"] =3D "Harm"
-gRazorSpellConfig["L:3002021"] =3D "Cure"
-gRazorSpellConfig["L:3002020"] =3D "Cunning"
-gRazorSpellConfig["L:3002019"] =3D "Agility"
+gRazorSpellID[3002026] =3D "Strength"
+gRazorSpellID[3002025] =3D "Protection"
+gRazorSpellID[3002024] =3D "Magic Untrap"
+gRazorSpellID[3002023] =3D "Magic Trap"
+gRazorSpellID[3002022] =3D "Harm"
+gRazorSpellID[3002021] =3D "Cure"
+gRazorSpellID[3002020] =3D "Cunning"
+gRazorSpellID[3002019] =3D "Agility"
 --~ zirkel3
-gRazorSpellConfig["L:3002034"] =3D "Wall of Stone"
-gRazorSpellConfig["L:3002033"] =3D "Unlock"
-gRazorSpellConfig["L:3002032"] =3D "Teleport"
-gRazorSpellConfig["L:3002031"] =3D "Telekinesis"
-gRazorSpellConfig["L:3002030"] =3D "Poison"
-gRazorSpellConfig["L:3002029"] =3D "Magic Lock"
-gRazorSpellConfig["L:3002028"] =3D "Fire Ball"
-gRazorSpellConfig["L:3002027"] =3D "Bless"
+gRazorSpellID[3002034] =3D "Wall of Stone"
+gRazorSpellID[3002033] =3D "Unlock"
+gRazorSpellID[3002032] =3D "Teleport"
+gRazorSpellID[3002031] =3D "Telekinesis"
+gRazorSpellID[3002030] =3D "Poison"
+gRazorSpellID[3002029] =3D "Magic Lock"
+gRazorSpellID[3002028] =3D "Fire Ball"
+gRazorSpellID[3002027] =3D "Bless"
 --~ zirkel4"
-gRazorSpellConfig["L:3002042"] =3D "Recall"
-gRazorSpellConfig["L:3002041"] =3D "Mana Drain"
-gRazorSpellConfig["L:3002040"] =3D "Lightning"
-gRazorSpellConfig["L:3002039"] =3D "Greater Heal"
-gRazorSpellConfig["L:3002038"] =3D "Fire Field"
-gRazorSpellConfig["L:3002037"] =3D "Curse"
-gRazorSpellConfig["L:3002036"] =3D "Arch Protection"
-gRazorSpellConfig["L:3002035"] =3D "Arch Cure"
+gRazorSpellID[3002042] =3D "Recall"
+gRazorSpellID[3002041] =3D "Mana Drain"
+gRazorSpellID[3002040] =3D "Lightning"
+gRazorSpellID[3002039] =3D "Greater Heal"
+gRazorSpellID[3002038] =3D "Fire Field"
+gRazorSpellID[3002037] =3D "Curse"
+gRazorSpellID[3002036] =3D "Arch Protection"
+gRazorSpellID[3002035] =3D "Arch Cure"
 --~ zirkel5"
-gRazorSpellConfig["L:3002050"] =3D "Summ.Creature"
-gRazorSpellConfig["L:3002049"] =3D "Poison Field"
-gRazorSpellConfig["L:3002048"] =3D "Paralyze"
-gRazorSpellConfig["L:3002047"] =3D "Mind Blast"
-gRazorSpellConfig["L:3002046"] =3D "Spell Reflection"
-gRazorSpellConfig["L:3002045"] =3D "Incognito"
-gRazorSpellConfig["L:3002044"] =3D "Dispel Field"
-gRazorSpellConfig["L:3002043"] =3D "Blade Spirit"
+gRazorSpellID[3002050] =3D "Summ.Creature"
+gRazorSpellID[3002049] =3D "Poison Field"
+gRazorSpellID[3002048] =3D "Paralyze"
+gRazorSpellID[3002047] =3D "Mind Blast"
+gRazorSpellID[3002046] =3D "Spell Reflection"
+gRazorSpellID[3002045] =3D "Incognito"
+gRazorSpellID[3002044] =3D "Dispel Field"
+gRazorSpellID[3002043] =3D "Blade Spirit"
 --~ zirkel6 "
-gRazorSpellConfig["L:3002058"] =3D "Reveal"
-gRazorSpellConfig["L:3002057"] =3D "Paralyze Field"
-gRazorSpellConfig["L:3002056"] =3D "Mass Curse"
-gRazorSpellConfig["L:3002055"] =3D "Mark"
-gRazorSpellConfig["L:3002054"] =3D "Invisibility"
-gRazorSpellConfig["L:3002053"] =3D "Explosion"
-gRazorSpellConfig["L:3002052"] =3D "Energy Bolt"
-gRazorSpellConfig["L:3002051"] =3D "Dispel"
+gRazorSpellID[3002058] =3D "Reveal"
+gRazorSpellID[3002057] =3D "Paralyze Field"
+gRazorSpellID[3002056] =3D "Mass Curse"
+gRazorSpellID[3002055] =3D "Mark"
+gRazorSpellID[3002054] =3D "Invisibility"
+gRazorSpellID[3002053] =3D "Explosion"
+gRazorSpellID[3002052] =3D "Energy Bolt"
+gRazorSpellID[3002051] =3D "Dispel"
 --~ zirkel7"
-gRazorSpellConfig["L:3002066"] =3D "Polymorph"
-gRazorSpellConfig["L:3002065"] =3D "Meteor Swarm"
-gRazorSpellConfig["L:3002064"] =3D "Mass Dispel"
-gRazorSpellConfig["L:3002063"] =3D "Mana Vampire"
-gRazorSpellConfig["L:3002062"] =3D "Gate"
-gRazorSpellConfig["L:3002061"] =3D "FlameStrike"
-gRazorSpellConfig["L:3002060"] =3D "Energy Field"
-gRazorSpellConfig["L:3002059"] =3D "Chain Lightning"
+gRazorSpellID[3002066] =3D "Polymorph"
+gRazorSpellID[3002065] =3D "Meteor Swarm"
+gRazorSpellID[3002064] =3D "Mass Dispel"
+gRazorSpellID[3002063] =3D "Mana Vampire"
+gRazorSpellID[3002062] =3D "Gate"
+gRazorSpellID[3002061] =3D "FlameStrike"
+gRazorSpellID[3002060] =3D "Energy Field"
+gRazorSpellID[3002059] =3D "Chain Lightning"
 --~ zirkel8"
-gRazorSpellConfig["L:3002074"] =3D "Water Elemental"
-gRazorSpellConfig["L:3002071"] =3D "Summon Daemon"
-gRazorSpellConfig["L:3002069"] =3D "Resurrection"
-gRazorSpellConfig["L:3002073"] =3D "Fire Elemental"
-gRazorSpellConfig["L:3002068"] =3D "Energy Vortex"
-gRazorSpellConfig["L:3002067"] =3D "Earthquake"
-gRazorSpellConfig["L:3002072"] =3D "Earth Elemental"
-gRazorSpellConfig["L:3002070"] =3D "Air Elemental"
+gRazorSpellID[3002074] =3D "Water Elemental"
+gRazorSpellID[3002071] =3D "Summon Daemon"
+gRazorSpellID[3002069] =3D "Resurrection"
+gRazorSpellID[3002073] =3D "Fire Elemental"
+gRazorSpellID[3002068] =3D "Energy Vortex"
+gRazorSpellID[3002067] =3D "Earthquake"
+gRazorSpellID[3002072] =3D "Earth Elemental"
+gRazorSpellID[3002070] =3D "Air Elemental"
 --~ bush"
-gRazorSpellConfig["L:1060600"] =3D "Momentum Strike"
-gRazorSpellConfig["L:1060599"] =3D "Lightning Strike"
-gRazorSpellConfig["L:1060595"] =3D "Honorable Execution"
-gRazorSpellConfig["L:1060597"] =3D "Evasion"
-gRazorSpellConfig["L:1060598"] =3D "Counter Attack"
-gRazorSpellConfig["L:1060596"] =3D "Confidence"
+gRazorSpellID[1060600] =3D "Momentum Strike"
+gRazorSpellID[1060599] =3D "Lightning Strike"
+gRazorSpellID[1060595] =3D "Honorable Execution"
+gRazorSpellID[1060597] =3D "Evasion"
+gRazorSpellID[1060598] =3D "Counter Attack"
+gRazorSpellID[1060596] =3D "Confidence"
 --~ chiv"
-gRazorSpellConfig["L:1060594"] =3D "Sacred Journey"
-gRazorSpellConfig["L:1060593"] =3D "Remove Curse"
-gRazorSpellConfig["L:1060592"] =3D "Noble Sacrifice"
-gRazorSpellConfig["L:1060591"] =3D "Holy Light"
-gRazorSpellConfig["L:1060590"] =3D "Enemy of one"
-gRazorSpellConfig["L:1060589"] =3D "Divine Fury"
-gRazorSpellConfig["L:1060588"] =3D "Dispel Evil"
-gRazorSpellConfig["L:1060587"] =3D "Consecrate Weapon"
-gRazorSpellConfig["L:1060586"] =3D "Close Wounds"
-gRazorSpellConfig["L:1060585"] =3D "Cleanse By Fire"
+gRazorSpellID[1060594] =3D "Sacred Journey"
+gRazorSpellID[1060593] =3D "Remove Curse"
+gRazorSpellID[1060592] =3D "Noble Sacrifice"
+gRazorSpellID[1060591] =3D "Holy Light"
+gRazorSpellID[1060590] =3D "Enemy of one"
+gRazorSpellID[1060589] =3D "Divine Fury"
+gRazorSpellID[1060588] =3D "Dispel Evil"
+gRazorSpellID[1060587] =3D "Consecrate Weapon"
+gRazorSpellID[1060586] =3D "Close Wounds"
+gRazorSpellID[1060585] =3D "Cleanse By Fire"
 --~ necro"				=

-gRazorSpellConfig["L:1060524"] =3D "WraithForm"				=

-gRazorSpellConfig["L:1060523"] =3D "Wither"			=

-gRazorSpellConfig["L:1060522"] =3D "Vengeful Spirit"		=

-gRazorSpellConfig["L:1060521"] =3D "Vampiric Embrace"			=

-gRazorSpellConfig["L:1060520"] =3D "Summon Familiar"			=

-gRazorSpellConfig["L:1060519"] =3D "Strangle"				=

-gRazorSpellConfig["L:1060518"] =3D "Poison Strike"		=

-gRazorSpellConfig["L:1060517"] =3D "Pain Spike"				=

-gRazorSpellConfig["L:1060516"] =3D "Mind Rot"			=

-gRazorSpellConfig["L:1060515"] =3D "Lich Form"			=

-gRazorSpellConfig["L:1060514"] =3D "Horrific Beast"		=

-gRazorSpellConfig["L:1060525"] =3D "Exorcism"
-gRazorSpellConfig["L:1060513"] =3D "Evil Omen"			=

-gRazorSpellConfig["L:1060512"] =3D "Curse Weapon"
-gRazorSpellConfig["L:1060511"] =3D "Corpse Skin"
-gRazorSpellConfig["L:1060510"] =3D "Blood Oath"
-gRazorSpellConfig["L:1060509"] =3D "Animate Dead"
+gRazorSpellID[1060524] =3D "WraithForm"				=

+gRazorSpellID[1060523] =3D "Wither"			=

+gRazorSpellID[1060522] =3D "Vengeful Spirit"		=

+gRazorSpellID[1060521] =3D "Vampiric Embrace"			=

+gRazorSpellID[1060520] =3D "Summon Familiar"			=

+gRazorSpellID[1060519] =3D "Strangle"				=

+gRazorSpellID[1060518] =3D "Poison Strike"		=

+gRazorSpellID[1060517] =3D "Pain Spike"				=

+gRazorSpellID[1060516] =3D "Mind Rot"			=

+gRazorSpellID[1060515] =3D "Lich Form"			=

+gRazorSpellID[1060514] =3D "Horrific Beast"		=

+gRazorSpellID[1060525] =3D "Exorcism"
+gRazorSpellID[1060513] =3D "Evil Omen"			=

+gRazorSpellID[1060512] =3D "Curse Weapon"
+gRazorSpellID[1060511] =3D "Corpse Skin"
+gRazorSpellID[1060510] =3D "Blood Oath"
+gRazorSpellID[1060509] =3D "Animate Dead"
 --~ nin"
-gRazorSpellConfig["L:1060614"] =3D "Mirror Image"
-gRazorSpellConfig["L:1060616"] =3D "Suprise Attack"
-gRazorSpellConfig["L:1060617"] =3D "Shadowjump"
-gRazorSpellConfig["L:1060613"] =3D "Ki Attack"
-gRazorSpellConfig["L:1060610"] =3D "Focus Attack"
-gRazorSpellConfig["L:1060611"] =3D "Death Strike"
-gRazorSpellConfig["L:1060615"] =3D "Backstab"
-gRazorSpellConfig["L:1060612"] =3D "Animal Form"
+gRazorSpellID[1060614] =3D "Mirror Image"
+gRazorSpellID[1060616] =3D "Suprise Attack"
+gRazorSpellID[1060617] =3D "Shadowjump"
+gRazorSpellID[1060613] =3D "Ki Attack"
+gRazorSpellID[1060610] =3D "Focus Attack"
+gRazorSpellID[1060611] =3D "Death Strike"
+gRazorSpellID[1060615] =3D "Backstab"
+gRazorSpellID[1060612] =3D "Animal Form"
 --~ spellw"
-gRazorSpellConfig["L:1071039"] =3D "Word Of Death"
-gRazorSpellConfig["L:1071035"] =3D "Wildfire"
-gRazorSpellConfig["L:1071030"] =3D "Thunderstorm"
-gRazorSpellConfig["L:1071033"] =3D "Summon Fiend"
-gRazorSpellConfig["L:1071032"] =3D "Summon Fey"
-gRazorSpellConfig["L:1071034"] =3D "Reaper Form"
-gRazorSpellConfig["L:1071031"] =3D "Nature Fury"
-gRazorSpellConfig["L:1071028"] =3D "Immolating Weapon"
-gRazorSpellConfig["L:1071027"] =3D "Gift Of Renewal"
-gRazorSpellConfig["L:1071040"] =3D "Gift Of Life"
-gRazorSpellConfig["L:1071038"] =3D "Ethereal Voyage"
-gRazorSpellConfig["L:1071036"] =3D "Essence Of Wind"
-gRazorSpellConfig["L:1071037"] =3D "Dryad Allure"
-gRazorSpellConfig["L:1071029"] =3D "Attunement"
-gRazorSpellConfig["L:1071041"] =3D "Arcane Empowerment"
-gRazorSpellConfig["L:1071026"] =3D "Arcane Circle"
+gRazorSpellID[1071039] =3D "Word Of Death"
+gRazorSpellID[1071035] =3D "Wildfire"
+gRazorSpellID[1071030] =3D "Thunderstorm"
+gRazorSpellID[1071033] =3D "Summon Fiend"
+gRazorSpellID[1071032] =3D "Summon Fey"
+gRazorSpellID[1071034] =3D "Reaper Form"
+gRazorSpellID[1071031] =3D "Nature Fury"
+gRazorSpellID[1071028] =3D "Immolating Weapon"
+gRazorSpellID[1071027] =3D "Gift Of Renewal"
+gRazorSpellID[1071040] =3D "Gift Of Life"
+gRazorSpellID[1071038] =3D "Ethereal Voyage"
+gRazorSpellID[1071036] =3D "Essence Of Wind"
+gRazorSpellID[1071037] =3D "Dryad Allure"
+gRazorSpellID[1071029] =3D "Attunement"
+gRazorSpellID[1071041] =3D "Arcane Empowerment"
+gRazorSpellID[1071026] =3D "Arcane Circle"
 	=

+gRazorSkillID =3D {}
+gRazorSkillID[1044061] =3D "Anatomy"
+gRazorSkillID[1044062] =3D "Animal Lore"
+gRazorSkillID[1044095] =3D "Animal Taming"
+gRazorSkillID[1044064] =3D "Arms Lore"
+gRazorSkillID[1044066] =3D "Begging"
+gRazorSkillID[1044072] =3D "Cartography"
+gRazorSkillID[1044074] =3D "Detecting Hidden"
+gRazorSkillID[1044075] =3D "Discordance"
+gRazorSkillID[1044076] =3D "Evaluate Intelligence"
+gRazorSkillID[1044079] =3D "Forensic Evaluation"
+gRazorSkillID[1044081] =3D "Hiding"
+gRazorSkillID[1044083] =3D "Inscription"
+gRazorSkillID[1044063] =3D "Item Identification"
+gRazorSkillID[1044106] =3D "Meditation"
+gRazorSkillID[1044069] =3D "Peacemaking"
+gRazorSkillID[1044090] =3D "Poisoning"
+gRazorSkillID[1044082] =3D "Provocation"
+gRazorSkillID[1044092] =3D "Spirit Speak"
+gRazorSkillID[1044093] =3D "Stealing"
+gRazorSkillID[1044107] =3D "Stealth"
+gRazorSkillID[1044096] =3D "Taste Identification"
+gRazorSkillID[1044098] =3D "Tracking"
+--~ gRazorSkillID[1044108] =3D "Disarming"  -- ??? preaos ?
+-- Snooping,Remove Trap,Lockpicking,Herding,Cooking,Camping"
 	=

 --[[
 Assistant.Macros.HotKeyAction|1044061| Anato
@@ -207,174 +232,72 @@
 =

 function ImportRazorHotkeys (filepath)
 	print("ImportRazorHotkeys",filepath)
-	if (not filepath) then return end
+	if (not file_exists(filepath)) then return end
 	local profile =3D LuaXML_ParseFile(filepath)[1]
 	for k,hotkey in ipairs(xmlchild(profile,"hotkeys")) do =

-		local key =3D hotkey.attr.key
-		key =3D gRazorKeyCodeTranslate[key] or key
-		local keymod =3D hotkey.attr.mod
+		local keycode =3D tonumber(hotkey.attr.key)
+		keycode =3D gRazorKeyCodeTranslate[keycode] or keycode
+		local keymod =3D tonumber(hotkey.attr.mod)
 		local action =3D hotkey[1]
-		local spellname =3D gRazorSpellConfig[action]
+		local a,b,actionid =3D string.find(action,"L:(.+)")
 		local a,b,macroname =3D string.find(action,"Play: (.+)")
-		print(key,GetKeyName(key),keymod,action,spellname,macroname)
+		local spellname =3D actionid and gRazorSpellID[tonumber(actionid)]
+		local skillname =3D actionid and gRazorSkillID[tonumber(actionid)]
+		local hotkeyaction =3D actionid and gRazorHotKeyAction[tonumber(actionid=
)]
+		=

+		local bCtrl		=3D TestBit(keymod,kRazorMod_Ctrl)
+		local bAlt		=3D TestBit(keymod,kRazorMod_Alt)
+		local bShift	=3D TestBit(keymod,kRazorMod_Shift)
+		local keycomboname =3D GetMacroKeyComboName(keycode,"?",bCtrl,bAlt,bShif=
t) =

+		--~ print(keycode,keymod,keycomboname,action,actionid,macroname,spellnam=
e,skillname)
+		=

+		if (spellname) then =

+			print("razor:spell",keycomboname,spellname) =

+			SetMacro(keycomboname,function () MacroCmd_Spell(spellname) end)
+		elseif (skillname) then =

+			print("razor:skill",keycomboname,skillname) =

+			SetMacro(keycomboname,function () MacroCmd_Skill(skillname) end)
+		elseif (macroname) then =

+			print("razor:macro",keycomboname,macroname) =

+			SetMacro(keycomboname,function () StartRazorMacroJob(macroname) end)
+		elseif (hotkeyaction) then =

+			print("razor:action",keycomboname,hotkeyaction.name) =

+			SetMacro(keycomboname,function () hotkeyaction.fun() end)
+		else
+			print("razor:unknown",keycomboname,action)
+		end
 	end
 	--~ <key mod=3D"7" key=3D"49" send=3D"False">L:3002011</key>Clumsy
 end
 =

-gRazorMacros =3D {}
-function LoadRazorMacros (folderpath) =

-	local files =3D dirlist(folderpath,false,true) -- (dirpath,bDirs,bFiles)
-	for k,filename in pairs(files) do =

-		local macroname =3D string.gsub(filename,".macro$","")
-		local macro =3D {}
-		for line in io.lines(folderpath..filename) do
-			local command =3D strsplit("|",string.gsub(line,"[\n\r]",""))
-			if (command[1]) then command[1] =3D string.gsub(command[1],"Assistant.M=
acros.","") end
-			table.insert(macro,command)
-		end
-		gRazorMacros[macroname] =3D macro
-	end
-	--~ print("LoadRazorMacros",SmartDump(files))
+--[[
+
+razor:unknown   wheeldown   L:1058
+razor:unknown   wheelup 	L:1059
+razor:unknown   mouse3  	L:1195
+razor:unknown   ctrl+f1 	Dress: ghongolas
+razor:unknown   alt+b   	L:1311
+razor:unknown   o       	L:1013
+
+ExtCastSpellAction      29      4294967295
+
+]]--
+
+function ImportRazorProfileDialog ()
+	local profile_filepath =3D FileOpenDialog_RazorProfile()
+	if (profile_filepath) then ImportRazorProfile(profile_filepath) end
 end
-
-gRazorMacroCmd =3D {}
-
---~ WalkAction|2
-function gRazorMacroCmd.WalkAction (dir) MacroCmd_WalkInDir(dir,TestBit(di=
r,0x80)) end
-
---~ DoubleClickTypeAction|10229|True
-function gRazorMacroCmd.DoubleClickTypeAction (artid,u1) MacroCmd_Item_Use=
ByArtID(artid) end
-
---~ DoubleClickAction|546224|220
-function gRazorMacroCmd.DoubleClickAction (serial,u1) Send_DoubleClick(ser=
ial) end
-
---~ PauseAction|00:00:00.5550000
---~ PauseAction|00:00:02
-function gRazorMacroCmd.PauseAction (dur)
-	local a,b,h,m,s =3D string.find(dur,"(%d+):(%d+):(.+)")
-	local ms =3D 1000*(tonumber(s) + 60*(tonumber(m) + 60*tonumber(h)))
-	job.wait(ms)
+function ImportRazorProfile (profile_filepath)
+	profile_filepath =3D string.gsub(profile_filepath,"\\","/") -- \ to /
+	if (not file_exists(profile_filepath)) then print("warning, ImportRazorPr=
ofile file not found",profile_filepath) return end
+	print("importing razor profile : ",profile_filepath)
+	local basefilepath =3D string.gsub(profile_filepath,"[^/]+/[^/]+$","")
+	LoadRazorMacros(basefilepath.."Macros/")
+	ImportRazorHotkeys(profile_filepath)
 end
-
---~ WaitForTargetAction|1
-function gRazorMacroCmd.WaitForTargetAction (timeout) MacroCmd_JobWaitForT=
arget(timeout*1000) end
-
---~ LastTargetAction
-function gRazorMacroCmd.LastTargetAction () MacroCmd_TargetLastNow() end
-
---~ TargetRelLocAction|2|0
-function gRazorMacroCmd.TargetRelLocAction (dx,dy) if (gPlayerXLoc) then M=
acroCmd_TargetGroundNow(gPlayerXLoc+dx,gPlayerYLoc+dy) end end
-
---~ AbsoluteTargetAction|0|0|41651|1657|310|-85|118
-function gRazorMacroCmd.AbsoluteTargetAction (u1,u2,uartid,u4,u5,u6,u7) pr=
int("AbsoluteTargetAction",u1,u2,uartid,u4,u5,u6,u7) end
-
---~ HotKeyAction|1195| -- clear target queue
-function gRazorMacroCmd.HotKeyAction (hotkeyaction,param) =

-	local handler =3D gRazorHotKeyAction[tonumber(hotkeyaction)]
-	print("HotKeyAction",hotkeyaction,handler,param)
-	if (handler) then handler(param) end
-end
-
---~ SpeechAction|0|198|3|enu|5|48|232|22|49|108|all follow me
-function gRazorMacroCmd.SpeechAction (u1,u2,u3,enu,u4,u5,u6,u7,u8,u9,text)=
 MacroCmd_Say(text) end
-
---~ ExtCastSpellAction|507|4294967295
-function gRazorMacroCmd.ExtCastSpellAction (uspellid,u2) print("ExtCastSpe=
llAction",uspellid,u2) end
-
---~ MacroCastSpellAction|44 -- (magetrain.macro) (lastspell?)
-function gRazorMacroCmd.MacroCastSpellAction (spellid) print("MacroCastSpe=
llAction",spellid) end
-
-
---~ GumpResponseAction|21|0|0
-function gRazorMacroCmd.GumpResponseAction (a,b,c) print("HotKeyAction",a,=
b,c) end
-
---~ WaitForGumpAction|949095101|False|300
-function gRazorMacroCmd.WaitForGumpAction (gumptype,u1,timeout) print("Wai=
tForGumpAction",gumptype,u1,timeout) end
-
--- dummy
-gRazorMacroCmd["!Loop"] =3D function () end
-
-
-function ExecRazorMacroCommand (command) =

-	if (not command[1]) then return end
-	local handler =3D gRazorMacroCmd[command[1]]
-	if (not handler) then print("ExecRazorMacroCommand warning, unknown comma=
nd",command[1]) return end
-	handler(unpack(command,2))
-end
-
-function RazorEvaluateIf (command)
-	print("TODO:RazorEvaluateIf",unpack(command))
-	return true
-end
-
-
-function StopRazorMacro ()
-	if (not gLastRazorMacroJobID) then return end
-	job.terminate(gLastRazorMacroJobID)
-	gLastRazorMacroJobID =3D nil
-end
-
-function StartRazorMacroJob (macroname)
-	local macro =3D gRazorMacros[macroname]
-	if (not macro) then return end
-	local bLoop =3D (macro[1] and macro[1][1]) =3D=3D "!Loop"
-	print("StartRazorMacroJob name,loop=3D",macroname,bLoop)
-	StopRazorMacro()
-	gLastRazorMacroJobID =3D job.create(function()
-			repeat =

-				local stack =3D {} -- if,for
-				local i =3D 1
-				local cmd
-				local iSkipUntilEndIfOrElseDepth =3D 0
-				repeat 	=

-					local command =3D macro[i] =

-					local top =3D stack[#stack]
-					print("macroline",i,iSkipUntilEndIfOrElseDepth,command[1])
-					if (command[1] =3D=3D "IfAction") then --~ IfAction|4|0|you prepare t=
o perform a shadowjump.
-						if (iSkipUntilEndIfOrElseDepth > 0) then
-							iSkipUntilEndIfOrElseDepth =3D iSkipUntilEndIfOrElseDepth + 1
-						elseif (not RazorEvaluateIf(command)) then =

-							iSkipUntilEndIfOrElseDepth =3D 1
-						end
-					elseif (command[1] =3D=3D "ElseAction") then
-						if (iSkipUntilEndIfOrElseDepth =3D=3D 1) then =

-							iSkipUntilEndIfOrElseDepth =3D 0 -- if (false) then .. else =

-						elseif (iSkipUntilEndIfOrElseDepth =3D=3D 0) then
-							iSkipUntilEndIfOrElseDepth =3D 1 -- if (true) then .. else =

-						end
-					elseif (command[1] =3D=3D "EndIfAction") then
-						if (iSkipUntilEndIfOrElseDepth > 0) then  =

-							iSkipUntilEndIfOrElseDepth =3D iSkipUntilEndIfOrElseDepth - 1
-						end -- otherwise it was a non-nested and non-skipped -- if (true) th=
en ... endif
-					elseif (iSkipUntilEndIfOrElseDepth =3D=3D 0) then
-						job.wait(1)
-						if (command[1] =3D=3D "ForAction") then --~ ForAction|10
-							local times =3D tonumber(command[2]) or 1
-							table.insert(stack,{times,i})
-							print("for loop start",times,i)
-						elseif (command[1] =3D=3D "EndForAction") then
-							assert(type(top) =3D=3D "table","razor macro : malformed for : endf=
or")
-							local times,forstart =3D unpack(top)
-							table.remove(stack)
-							if (times >=3D 2) then
-								print("razor macro : for loop start,left",forstart,times-1)
-								i =3D forstart =

-								table.insert(stack,{times-1,i})
-							end
-						else
-							ExecRazorMacroCommand(command)
-						end
-					end
-					i =3D i + 1
-				until i > #macro
-				job.wait(1)
-			until (not bLoop)
-		end)
-end
-
-
-
-local filepath =3D "/home/ghoul/Desktop/cavern/razorprofile/default.xml" -=
- FileOpenDialog_RazorProfile()
+--~ os.exit(0)
+
+--~ local filepath =3D "/home/ghoul/Desktop/cavern/razorprofile/default.xm=
l" -- FileOpenDialog_RazorProfile()
 --~ local xml =3D LuaXML_ParseFile(filepath)[1]
 --~ print(SmartDump(xml[1]))
 --~ LuaXML_SaveFile("../bla.xml",xml)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Nov 17 20:48:43 2008
@@ -94,6 +94,7 @@
 dofile(libpath .. "lib.blendout.lua")
 dofile(libpath .. "lib.packetvideo.lua")
 dofile(libpath .. "lib.objectpicker.lua")
+dofile(libpath .. "lib.razormacro.lua")
 dofile(libpath .. "lib.razorconfig.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")



From no-reply at zwischenwelt.org  Tue Nov 18 23:50:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 18 Nov 2008 22:50:06 -0000
Subject: [Iris-commit] [IRIS] r2737 - in /trunk: lua/lib.macrolist.lua
 lua/net/net.dynamic.lua lua/net/net.trade.lua plugins/moblist.lua videos/
Message-ID: <20081118225006.7DDE41C187E5@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 18 23:50:05 2008
New Revision: 2737

Log:
fixed npc shop bug

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.dynamic.lua
    trunk/lua/net/net.trade.lua
    trunk/plugins/moblist.lua
    trunk/videos/   (props changed)

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Tue Nov 18 23:50:05 2008
@@ -29,6 +29,15 @@
 gMacroReadMobileStats.curWeight		=3D true
 gMacroReadMobileStats.maxWeight		=3D true
 =

+function GetMobileStat(mobile,statname) return mobile and mobile.stats and=
 mobile.stats[statname] or 0 end =

+function GetPlayerManaCur() return GetMobileStat(GetPlayerMobile(),"curMan=
a") end =

+function GetPlayerManaMax() return GetMobileStat(GetPlayerMobile(),"maxMan=
a") end =

+function GetPlayerStamCur() return GetMobileStat(GetPlayerMobile(),"curSta=
mina") end =

+function GetPlayerStamMax() return GetMobileStat(GetPlayerMobile(),"maxSta=
mina") end =

+function GetPlayerHitsCur() return GetMobileStat(GetPlayerMobile(),"curHit=
s") end =

+function GetPlayerHitsMax() return GetMobileStat(GetPlayerMobile(),"maxHit=
s") end =

+
+	=

 -- GetPlayerMobile
 function MacroRead_PlayerStat			(statname) return MacroReadAux_MobileStat(=
GetPlayerMobile(),statname,"MacroRead_PlayerStat") end
 function MacroRead_TargetStat			(statname) return MacroReadAux_MobileStat(=
GetMobile(giSelectedMobile),statname,"MacroRead_TargetStat") end

Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Tue Nov 18 23:50:05 2008
@@ -101,6 +101,7 @@
 	local itemcount	=3D input:PopNetUint16()
 	local iLastSerial
 =

+	local oldcount =

 	for i=3D1,itemcount do
 		local dynamicdata =3D {}
 		dynamicdata.container_content_order =3D i
@@ -113,11 +114,19 @@
 		dynamicdata.zloc				=3D 0						--Grid Index (only since 6.0.1.7 2D and 2=
.45.5.6 KR)
 		dynamicdata.iContainerSerial 	=3D input:PopNetUint32()
 		dynamicdata.hue 				=3D input:PopNetUint16()
+		=

+		if (not iLastSerial) then =

+			local cont =3D GetContainer(dynamicdata.iContainerSerial) -- reset cont=
ainer at start of packet (needed for shop)
+			if (cont) then oldcount =3D #cont:GetContent() cont:DestroyContent() end
+		end			=

 		iLastSerial =3D dynamicdata.iContainerSerial
 		=

 		--~ printf("kPacket_Container_Contents %d/%d %s\n",i,itemcount,SmartDump=
(dynamicdata))
 		CreateOrUpdateDynamic(dynamicdata)
 	end
+	print("######### kPacket_Container_Contents",iLastSerial,oldcount,itemcou=
nt)
+	=

+	=

 	if (iLastSerial) then Update_Spellbook(iLastSerial) end
 	NotifyListener("Hook_Container_Contents",iLastSerial)
 end
@@ -138,4 +147,6 @@
 	dynamicdata.hue					=3D input:PopNetUint16()
 	--~ print("kPacket_Object_to_Object",SmartDump(dynamicdata))
 	CreateOrUpdateDynamic(dynamicdata)
+	=

+	if (dynamicdata.iContainerSerial ~=3D GetPlayerBackPackSerial()) then pri=
nt("######### kPacket_Object_to_Object containerid:",dynamicdata.iContainer=
Serial) end
 end

Modified: trunk/lua/net/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.trade.lua (original)
+++ trunk/lua/net/net.trade.lua Tue Nov 18 23:50:05 2008
@@ -105,6 +105,8 @@
 	local size 		=3D input:PopNetUint16()
 	local shop =3D {}
 	shop.shopContainerID 	=3D input:PopNetUint32() -- containerid ! (or vendo=
rserial-1)
+	=

+	print("######### kPacket_Shop_Data containerid:",shop.shopContainerID)
 	=

 	local shopContainerItem =3D GetObjectBySerial(shop.shopContainerID)
 	if (shopContainerItem and shopContainerItem.mobile) then shop.shopMobileI=
D =3D shopContainerItem.mobile.serial end

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Tue Nov 18 23:50:05 2008
@@ -374,7 +374,7 @@
 =

 -- ***** ***** ***** ***** ***** rest
 =

-function MobListGetMainTargetSerial() return gMobList.maintarget_serial end
+function MobListGetMainTargetSerial() return gMobList and gMobList.maintar=
get_serial end
 function MobListSetMainTargetSerial(serial) gMobList:SetMainTarget(serial)=
 end
 		=

 RegisterListener("Hook_PostLoad",function () gMobList =3D GetDesktopWidget=
():CreateChild("UOMobList") end)



From no-reply at zwischenwelt.org  Wed Nov 19 10:36:09 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 19 Nov 2008 09:36:09 -0000
Subject: [Iris-commit] [IRIS] r2738 - in /trunk/data: ./ base/ui/
	models/atlas/ particles/particles/
Message-ID: <20081119093609.88B241C187E5@zwischenwelt.org>

Author: hagish
Date: Wed Nov 19 10:36:08 2008
New Revision: 2738

Log:
shoggoth data changes

Removed:
    trunk/data/shoggoth_patch
Modified:
    trunk/data/base/ui/ui.material
    trunk/data/models/atlas/tex_atlas_alpha_low.material
    trunk/data/models/atlas/tex_atlas_alpha_med.material
    trunk/data/models/atlas/tex_atlas_alpha_ultralow.material
    trunk/data/models/atlas/tex_atlas_low.material
    trunk/data/models/atlas/tex_atlas_med.material
    trunk/data/models/atlas/tex_atlas_ultralow.material
    trunk/data/particles/particles/ConsecrateWeapon.particle
    trunk/data/particles/particles/Fields.particle
    trunk/data/particles/particles/MindRot.particle
    trunk/data/particles/particles/PainSpike.particle
    trunk/data/particles/particles/PoisonStrike.particle
    trunk/data/particles/particles/Strangle.particle
    trunk/data/particles/particles/Wither.particle
    trunk/data/particles/particles/explosions.particle
    trunk/data/particles/particles/fireballs.particle
    trunk/data/particles/particles/healing.particle
    trunk/data/particles/particles/rings.particle

Modified: trunk/data/base/ui/ui.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/ui/ui.material (original)
+++ trunk/data/base/ui/ui.material Wed Nov 19 10:36:08 2008
@@ -1,3 +1,5 @@
+import guibase from main.material
+
 material ui_ray_border : guibase
 {
 	set_texture_alias guitex ui/ray_border.png

Modified: trunk/data/models/atlas/tex_atlas_alpha_low.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_alpha_low.material (original)
+++ trunk/data/models/atlas/tex_atlas_alpha_low.material Wed Nov 19 10:36:0=
8 2008
@@ -1,3 +1,5 @@
+import atlas_base_alpha from textures.material
+
 material tex_atlas_alpha_low0 : atlas_base_alpha =

 { =

 	set_texture_alias MainTexture tex_atlas_alpha_low0.dds  =


Modified: trunk/data/models/atlas/tex_atlas_alpha_med.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_alpha_med.material (original)
+++ trunk/data/models/atlas/tex_atlas_alpha_med.material Wed Nov 19 10:36:0=
8 2008
@@ -1,3 +1,5 @@
+import atlas_base_alpha from textures.material
+
 material tex_atlas_alpha_med0 : atlas_base_alpha =

 { =

 	set_texture_alias MainTexture tex_atlas_alpha_med0.dds  =


Modified: trunk/data/models/atlas/tex_atlas_alpha_ultralow.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_alpha_ultralow.material (original)
+++ trunk/data/models/atlas/tex_atlas_alpha_ultralow.material Wed Nov 19 10=
:36:08 2008
@@ -1,3 +1,5 @@
+import atlas_base_alpha from textures.material
+
 material tex_atlas_alpha_ultralow0 : atlas_base_alpha =

 { =

 	set_texture_alias MainTexture tex_atlas_alpha_ultralow0.dds  =


Modified: trunk/data/models/atlas/tex_atlas_low.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_low.material (original)
+++ trunk/data/models/atlas/tex_atlas_low.material Wed Nov 19 10:36:08 2008
@@ -1,3 +1,5 @@
+import atlas_base from textures.material
+
 material tex_atlas_low0 : atlas_base =

 { =

 	set_texture_alias MainTexture tex_atlas_low0.dds  =


Modified: trunk/data/models/atlas/tex_atlas_med.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_med.material (original)
+++ trunk/data/models/atlas/tex_atlas_med.material Wed Nov 19 10:36:08 2008
@@ -1,3 +1,5 @@
+import atlas_base from textures.material
+
 material tex_atlas_med0 : atlas_base =

 { =

 	set_texture_alias MainTexture tex_atlas_med0.dds  =


Modified: trunk/data/models/atlas/tex_atlas_ultralow.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/atlas/tex_atlas_ultralow.material (original)
+++ trunk/data/models/atlas/tex_atlas_ultralow.material Wed Nov 19 10:36:08=
 2008
@@ -1,3 +1,5 @@
+import atlas_base from textures.material
+
 material tex_atlas_ultralow0 : atlas_base =

 { =

 	set_texture_alias MainTexture tex_atlas_ultralow0.dds  =


Modified: trunk/data/particles/particles/ConsecrateWeapon.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/ConsecrateWeapon.particle (original)
+++ trunk/data/particles/particles/ConsecrateWeapon.particle Wed Nov 19 10:=
36:08 2008
@@ -1,4 +1,4 @@
-ConsecrateWeapon1
+particle_system ConsecrateWeapon1
 {
 	quota	10
 	material	Particles/Swords
@@ -42,7 +42,7 @@
 }
 =

 =

-ConsecrateWeapon2
+particle_system ConsecrateWeapon2
 {
 	quota	10
 	material	Particles/explosion

Modified: trunk/data/particles/particles/Fields.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/Fields.particle (original)
+++ trunk/data/particles/particles/Fields.particle Wed Nov 19 10:36:08 2008
@@ -1,5 +1,5 @@
 =

-ParalyzeField
+particle_system ParalyzeField
 {
 	quota	50
 	material	Particles/FlarePointSprite
@@ -46,7 +46,7 @@
 }
 =

 =

-PoisonField
+particle_system PoisonField
 {
 	quota	50
 	material	Particles/Flare
@@ -94,7 +94,7 @@
 }
 =

 =

-FireField
+particle_system FireField
 {
 	quota	50
 	material	Particles/explosion
@@ -141,7 +141,7 @@
 }
 =

 =

-Moongate
+particle_system Moongate
 {
 	quota	100
 	material	Particles/FlarePointSprite

Modified: trunk/data/particles/particles/MindRot.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/MindRot.particle (original)
+++ trunk/data/particles/particles/MindRot.particle Wed Nov 19 10:36:08 2008
@@ -1,5 +1,5 @@
 =

-MindRot
+particle_system MindRot
 {
 	quota	10
 	material	Particles/Twirl

Modified: trunk/data/particles/particles/PainSpike.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/PainSpike.particle (original)
+++ trunk/data/particles/particles/PainSpike.particle Wed Nov 19 10:36:08 2=
008
@@ -1,5 +1,5 @@
 =

-PainSpike
+particle_system PainSpike
 {
 	quota	10
 	material	Particles/bigFlame

Modified: trunk/data/particles/particles/PoisonStrike.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/PoisonStrike.particle (original)
+++ trunk/data/particles/particles/PoisonStrike.particle Wed Nov 19 10:36:0=
8 2008
@@ -1,5 +1,5 @@
 =

-PoisonStrike
+particle_system PoisonStrike
 {
 	quota	10
 	material	Particles/explosion

Modified: trunk/data/particles/particles/Strangle.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/Strangle.particle (original)
+++ trunk/data/particles/particles/Strangle.particle Wed Nov 19 10:36:08 20=
08
@@ -1,5 +1,5 @@
 =

-StranglePart1
+particle_system StranglePart1
 {
 	quota	10
 	material	Particles/Skull
@@ -43,7 +43,7 @@
 }
 =

 =

-StranglePart2
+particle_system StranglePart2
 {
 	quota	10
 	material	Particles/explosion

Modified: trunk/data/particles/particles/Wither.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/Wither.particle (original)
+++ trunk/data/particles/particles/Wither.particle Wed Nov 19 10:36:08 2008
@@ -1,5 +1,5 @@
 =

-Wither
+particle_system Wither
 {
 	quota	25
 	material	Particles/Flare

Modified: trunk/data/particles/particles/explosions.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/explosions.particle (original)
+++ trunk/data/particles/particles/explosions.particle Wed Nov 19 10:36:08 =
2008
@@ -1,5 +1,5 @@
 =

-Explosion
+particle_system Explosion
 {
 	quota	10
 	material	Generic/Fire

Modified: trunk/data/particles/particles/fireballs.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/fireballs.particle (original)
+++ trunk/data/particles/particles/fireballs.particle Wed Nov 19 10:36:08 2=
008
@@ -1,4 +1,4 @@
-Large Fireball
+particle_system "Large Fireball"
 {
 	quota	50
 	material	Particles/Fireball
@@ -41,7 +41,7 @@
 	}
 }
 =

-Magic Arrow
+particle_system "Magic Arrow"
 {
 	quota	50
 	material	Particles/Fireball

Modified: trunk/data/particles/particles/healing.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/healing.particle (original)
+++ trunk/data/particles/particles/healing.particle Wed Nov 19 10:36:08 2008
@@ -1,5 +1,5 @@
 =

-Teleport
+particle_system Teleport
 {
 	quota	100
 	material	Particles/Fibres
@@ -57,7 +57,7 @@
 }
 =

 =

-Healing
+particle_system Healing
 {
 	quota	200
 	material	Particles/FlarePointSprite

Modified: trunk/data/particles/particles/rings.particle
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/particles/particles/rings.particle (original)
+++ trunk/data/particles/particles/rings.particle Wed Nov 19 10:36:08 2008
@@ -1,5 +1,5 @@
 =

-bluering
+particle_system bluering
 {
 	quota	100
 	material	Particles/FlarePointSprite



From no-reply at zwischenwelt.org  Wed Nov 19 10:44:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 19 Nov 2008 09:44:36 -0000
Subject: [Iris-commit] [IRIS] r2739 - in /trunk: premake premake.lua
Message-ID: <20081119094437.1E9B81C187E5@zwischenwelt.org>

Author: hagish
Date: Wed Nov 19 10:44:36 2008
New Revision: 2739

Log:
premake update

Modified:
    trunk/premake
    trunk/premake.lua

Modified: trunk/premake
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Wed Nov 19 10:44:36 2008
@@ -16,6 +16,12 @@
 gbDisableProfiling =3D true
 gbDisableAssert =3D false
 =

+gbUseSoundOpenAl =3D true
+gbUseSoundFmod =3D true
+		=

+-- ------------------------------------------------------------------
+-- ------------------------------------------------------------------
+
 -- build options
 addoption("wall","very verbose report, most warnings enabled")
 addoption("nooptimize","don't use optmize compile flags")
@@ -36,7 +42,6 @@
 =

 gLugreLuaSrcDir =3D "./"..gLugreDir.."/lib/lua-5.1.4/"
 gLugreOisDir =3D "./"..gLugreDir.."/baselib/ois/"
-gLugreOisIncludeDir =3D "./"..gLugreDir.."/baselib/ois/includes/"  -- for =
linux specific mouse functions
 =

 -- list of easy libs inclusion (located in lugre/lib/NAME). this will add =
lugre/lib/NAME/src and lugre/lib/NAME/include.
 gLugreLibList =3D {
@@ -46,24 +51,47 @@
 	"caelum",
 }
 =

+-- returns true if the needle(value) is in the haystack-array
+function in_array (needle,haystack) =

+	assert(type(haystack) =3D=3D "table")
+	for k,v in pairs(haystack) do if (v =3D=3D needle) then return true end e=
nd
+	return false
+end
+
+-- display used sound system
+nosound =3D true
+if gbUseSoundOpenAl then print("sound: openal") nosound =3D false end
+if gbUseSoundFmod then print("sound: fmod") nosound =3D false end
+if nosound then print("sound: NO sound system defined") end
+
 -- lugre dependencies, ie. ogre
 function AddLugreDeps(package)
 	package.defines =3D { =

-		"USE_OPENAL",
+		gbUseSoundOpenAl and "USE_OPENAL" or nil,
+		gbUseSoundFmod and "USE_FMOD" or nil,
 		"MAIN_WORKING_DIR=3D\\\"..\\\"",
 		"LUA_DIR=3D\\\"lua\\\"",
 		"LUGRE_DIR=3D\\\""..gLugreDir.."\\\"",
 		"DATA_DIR=3D\\\"data\\\"",
-		"ENABLE_THREADS",
+ 		"ENABLE_THREADS",
 		gbDisableProfiling and "DISABLE_PROFILING" or nil,
 		gbDisableAssert and "NDEBUG" or nil,
+		"LUA_USE_POSIX", -- execute shellcommands
 	}	=

 =

 	addpkgconfiglib(package, "OGRE")
 	if gbUseSystemOis then addpkgconfiglib(package, "OIS") end
-	addpkgconfiglib(package, "openal")
-	addpkgconfiglib(package, "vorbisfile")
-
+	=

+	if in_array("USE_OPENAL", package.defines) then
+		-- openal	=

+		addpkgconfiglib(package, "openal")
+		addpkgconfiglib(package, "vorbisfile")
+	end
+	if in_array("USE_FMOD", package.defines) then
+		-- fmod	=

+		addcustomlib(package, "fmodex")
+	end
+		=

 	addcustomconfiglib(package, "wx-config")
 =

 	addcustomlib(package,"boost_thread")
@@ -109,12 +137,43 @@
 =

 function addcustomlib (package, libname)
 	local path =3D os.findlib(libname)
+	local lbase =3D {
+		"/usr/local/lib/",
+		"/usr/lib/",
+	}
+	local ibase =3D {
+		"/usr/local/include/%s",
+		"/usr/include/%s",
+	}
+	=

+	-- brute force try
+	if not path then
+		for k,v in pairs(lbase) do
+			local p =3D string.format(v, libname)
+			local b =3D p.."/lib"..libname
+			if os.fileexists(b..".so") or os.fileexists(b..".a") then
+				tinsert (package.libpaths, p)
+				tinsert (package.links, libname)		=

+				path =3D p
+				print("custom lib "..libname.." found at "..p)
+				break
+			end
+		end
+	end
 	=

     if path then
-      tinsert (package.libpaths,path)
-      tinsert (package.links, libname)
+		tinsert (package.libpaths,path)
+		tinsert (package.links, libname)
+		-- search for include path
+		for k,v in pairs(ibase) do
+			local x =3D string.format(v, libname)
+			if os.direxists(x) then
+				tinsert (package.includepaths, x)
+				print("using "..x.." as "..libname.." include path")
+			end
+		end
     end
-  end
+ end
 =

 -- ---------------------------------------------
 -- LUA
@@ -128,7 +187,7 @@
 package.buildoptions =3D {}
 package.includepaths =3D { gLugreLuaSrcDir.."/src" }
 package.defines =3D { =

-	"LUA_USE_POPEN", -- execute shellcommands
+	"LUA_USE_POSIX", -- execute shellcommands
 	gbDisableAssert and "NDEBUG" or nil,
 }	=

 package.files =3D {
@@ -139,24 +198,26 @@
 -- OIS
 -- ---------------------------------------------
 if not gbUseSystemOis then
-	print("OIS platform: "..gOisPlatform)
+	print("OIS platform: "..gOisPlatform.." (lugre)")
 	gOisPlatform =3D "linux"
-	oisinclude =3D {gLugreOisDir.."/includes", gLugreOisDir.."/includes/"..gO=
isPlatform}
+	glOisIncludeList =3D {gLugreOisDir.."/includes", gLugreOisDir.."/includes=
/"..gOisPlatform}
 	package =3D newpackage()
 	package.name =3D "lugreois"
 	package.kind =3D "lib"
 	package.language =3D "c++"
 	package.buildflags =3D { gbExtraWarnings and "extra-warnings" or nil, gbO=
ptimize and "optimize" or nil, gbNo64BitChecks and "no-64bit-checks" or nil=
 }
 	package.buildoptions =3D {}
-	package.includepaths =3D { unpack(oisinclude) }
+	package.includepaths =3D { unpack(glOisIncludeList) }
 	package.defines =3D { =

-		--"LUA_USE_POPEN", -- execute shellcommands
+		"LUA_USE_POSIX", -- execute shellcommands
 		gbDisableAssert and "NDEBUG" or nil,
 	}	=

 	package.files =3D {
 	  matchfiles(gLugreOisDir.."/src/*.h", gLugreOisDir.."/src/*.cpp"),
 	  matchfiles(gLugreOisDir.."/src/"..gOisPlatform.."/*.h", gLugreOisDir.."=
/src/"..gOisPlatform.."/*.cpp"),
 	}
+else
+	print("OIS platform: system wide installed")
 end
 -- ---------------------------------------------
 -- LUGRE LIBS
@@ -170,7 +231,7 @@
 	package.language =3D "c++"
 	package.buildflags =3D { gbExtraWarnings and "extra-warnings" or nil, gbO=
ptimize and "optimize" or nil, gbNo64BitChecks and "no-64bit-checks" or nil=
 }
 	package.buildoptions =3D {}
-	package.includepaths =3D { gLugreDir.."/include", gLugreLuaSrcDir.."/src/=
", "include", oisinclude and unpack(oisinclude) or nil }
+	package.includepaths =3D { gLugreDir.."/include", gLugreLuaSrcDir.."/src/=
", "include", glOisIncludeList and unpack(glOisIncludeList) or nil }
 	package.files =3D {
 		matchfiles(gLugreLuaSrcDir.."/src/*.h", gLugreLuaSrcDir.."/src/*.c"),
 	}
@@ -192,7 +253,7 @@
 package.links =3D {  }
 package.buildflags =3D { bExtraWarnings and "extra-warnings" or nil, gbOpt=
imize and "optimize" or nil, gbNo64BitChecks and "no-64bit-checks" or nil }
 package.buildoptions =3D {}
-package.includepaths =3D { gLugreLuaSrcDir.."/src", gLugreDir.."/include",=
 gLugreOisIncludeDir }
+package.includepaths =3D { gLugreLuaSrcDir.."/src", gLugreDir.."/include",=
 glOisIncludeList and unpack(glOisIncludeList) or nil }
 package.files =3D {
   matchrecursive(gLugreDir.."/include/*.h", gLugreDir.."/src/*.cpp"),
 }



From no-reply at zwischenwelt.org  Wed Nov 19 11:15:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 19 Nov 2008 10:15:19 -0000
Subject: [Iris-commit] [IRIS] r2740 - in /trunk: data/base/
 data/models/materials/ data/models/models/to_001000/ lua/
Message-ID: <20081119101520.0D0111C187E5@zwischenwelt.org>

Author: hagish
Date: Wed Nov 19 11:15:19 2008
New Revision: 2740

Log:
reworked lights in 3d renderer

Added:
    trunk/lua/lib.3d.light.lua
Modified:
    trunk/data/base/main.material
    trunk/data/models/materials/textures.material
    trunk/data/models/models/to_001000/mdl_000002.mesh
    trunk/lua/config_declarations.lua
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.3d.tilebatch.lua
    trunk/lua/lib.light.lua
    trunk/lua/lib.mapblock.3d.statics.lua
    trunk/lua/lib.mapblock.3d.terrain.lua
    trunk/lua/lib.mapblock.scheduler.lua
    trunk/lua/lib.static.lua

Modified: trunk/data/base/main.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/base/main.material (original)
+++ trunk/data/base/main.material Wed Nov 19 11:15:19 2008
@@ -456,27 +456,30 @@
 			// alpha_rejection less 128
 			alpha_rejection greater 128
 			lighting off
-			ambient 1.0 1.0 1.0
-			diffuse 1.0 1.0 1.0
+			ambient 1.0 1.0 1.0 1.0
+			diffuse 1.0 1.0 1.0 1.0
 		}
 	}
 }
 =

 material staticfallbackatlas
 {
-	technique
-	{
-		pass
-		{
+	receive_shadows off
+	=

+	technique
+	{
+		pass
+		{
+			lighting on
+			ambient 1.0 1.0 1.0
+			diffuse 1.0 1.0 1.0
+
 			cull_hardware none
 			cull_software none
 =

 			scene_blend alpha_blend
 			// alpha_rejection less 128
 			alpha_rejection greater 128
-			lighting off
-			ambient 1.0 1.0 1.0
-			diffuse 1.0 1.0 1.0
 		}
 	}
 }

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Wed Nov 19 11:15:19 2008
@@ -12,16 +12,15 @@
 		pass Decal
 		{
 			lighting on
-			ambient 1.0 1.0 1.0 1.0
-			diffuse 1.0 1.0 1.0 1.0
+			//ambient 1.0 1.0 1.0 1.0
+			//diffuse 1.0 1.0 1.0 1.0
+			ambient vertexcolour
+			diffuse vertexcolour
 =

 			// needed for xmirror fix
 			//cull_hardware anticlockwise
 			//cull_software front
 			=

-			ambient vertexcolour
-			diffuse vertexcolour
-
 			texture_unit
 			{
 				filtering anisotropic

Modified: trunk/data/models/models/to_001000/mdl_000002.mesh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Wed Nov 19 11:15:19 2008
@@ -19,7 +19,7 @@
 gConfig:DeclareString("gClientVersion", "protocol", "client version", 'Cli=
ent Identification String (try other version for example "4.0.11c5")', "6.0=
.1.6")
 =

 -- Camera Rotation - Input stuff use: "mouse1", "mouse2" or "mouse3"
-gInput_CamMouseButton =3D GetNamedKey("mouse1")
+gInput_CamMouseButton =3D GetNamedKey("mouse3")
 =

 gConfig:DeclareBoolean("gUseConstantCameraRotation", "input", "mouse camer=
a rotation", 'mouse camera rotation', true)
 =

@@ -113,14 +113,14 @@
 =

 -- Fog of War
 gConfig:DeclareBoolean("gUseDistanceFog", "client", "distance fog", 'enabl=
e/disable fog', true)
-gConfig:DeclareFloat("gFogValue", "client", "fog value", 'distance from ca=
m', 16)
+gConfig:DeclareFloat("gFogValue", "client", "fog value", 'distance from ca=
m', 24)
 gConfig:DeclareFloat("gFogcolorred", "client", "fog color r", 'TODO', 0)
 gConfig:DeclareFloat("gFogcolorgreen", "client", "fog color g", 'TODO', 0)
 gConfig:DeclareFloat("gFogcolorblue", "client", "fog color b", 'TODO', 0)
 =

 -- Sun Light
-gSunLightDirection =3D {x=3D1,y=3D1,z=3D-1}
-gSunLightDiffuse =3D {r=3D1.0,g=3D1.0,b=3D1.0}
+gSunLightDirection =3D {x=3D1.1,y=3D1.1,z=3D-1}
+gSunLightDiffuse =3D {r=3D1.0,g=3D1.0,b=3D0.9}
 gSunLightSpecular =3D {r=3D1.0,g=3D1.0,b=3D1.0}
 =

 -- Ambient Light
@@ -128,7 +128,7 @@
 =

 -- Soundeffects & Music
 -- gUseSoundSystem =3D "openal"
-gConfig:DeclareEnum("gUseSoundSystem", "sound", "sound system", 'TODO', "f=
mod",{"fmod","openal"})
+gConfig:DeclareEnum("gUseSoundSystem", "sound", "sound system", 'TODO', "a=
ny",{"any","fmod","openal"})
 gConfig:DeclareBoolean("gUseEffect", "sound", "effects", 'enable/disable s=
ound effects', true)
 gConfig:DeclareBoolean("gUseMusic", "sound", "music", 'enable/disable musi=
c', true)
 =

@@ -485,6 +485,8 @@
 =

 gConfig:DeclareBoolean("gLogStatsToFile", "debug", "log stats to file", 'd=
umps statistical informations into stats.dat', false)
 =

+gConfig:DeclareFloat("gMaxFPS", "gfx", "max fps", 'upper fps limit', 50)
+
 =

 =

 -- port me to new config system ! (or extend system for complex stuff)

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Wed Nov 19 11:15:19 2008
@@ -400,7 +400,7 @@
 		if (gLightsources) then
 			if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Ligh=
tSource) ) then
 				local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc=
+arrtiletype.miHeight) * 0.1)
-				item.lightname =3D Renderer3D:AddPointLight(x-0.5,y+0.5,z+1, 0.3,0.3,0=
.2, 0.3,0.3,0.2, 5.0,0.1,0.1,0.0)
+				item.lightname =3D Renderer3D:AddStandartUOPointLight(x,y,z)
 			end
 		end
 		=


Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Nov 19 11:15:19 2008
@@ -15,6 +15,7 @@
 dofile(libpath .. "lib.3d.dynamicspawner.lua")
 dofile(libpath .. "lib.3d.multispawner.lua")
 dofile(libpath .. "lib.3d.waterspawner.lua")
+dofile(libpath .. "lib.3d.light.lua")
 =

 gRendererList[ "Renderer3D" ] =3D Renderer3D
 =

@@ -57,6 +58,8 @@
 	gTileFreeWalk:Init()
 		=

 	self.gbActive =3D true
+	self.mfPersonalLight =3D 0
+	self.mfSunLight =3D 1
 end
 =

 function Renderer3D:DeInit ()
@@ -71,6 +74,12 @@
 	self:DeInitMap()
 		=

 	self.gbActive =3D false
+	=

+	-- remove players personal light
+	if self.mPersonalLightName then
+		Client_RemoveLight(self.mPersonalLightName)
+		self.mPersonalLightName =3D nil
+	end
 end
 =

 -- called by main.lua
@@ -137,6 +146,7 @@
 	end
 =

 	self:MapStep()
+	self:UpdateLight()
 end
 =

 function Renderer3D:SetLastConfirmedUOPos(xloc,yloc,zloc) gTileFreeWalk:Im=
pl_SetLastConfirmedUOPos(xloc,yloc,zloc) end -- walk
@@ -296,6 +306,15 @@
 	end
 end
 =

+function Renderer3D.CalculatePointLightAttenuation (radius)
+	local r =3D radius
+	local c =3D 1
+	local l =3D 2/radius
+	local q =3D 0.0025
+	return r*4, c, l, q
+end
+
+
 function Renderer3D:UpdateMapEnvironment (hour,minute,second)
 	if (gCaelumSystem) then
 	    -- Sunrise with visible moon.
@@ -350,19 +369,37 @@
 	GetMainCam():SetAspectRatio(vp:GetActualWidth() / vp:GetActualHeight())
 end
 =

+
+function Renderer3D:AddStandartUOPointLight	(x,y,z,r)
+	r =3D r or 5
+
+	return self:AddPointLight(
+		x-0.5,y+0.5,z+1-16, 	-- pos
+		1,1,1, 			-- diffuse
+		1,1,1, 			-- specular
+		Renderer3D.CalculatePointLightAttenuation(r))		-- attenuation
+end
+
+
 -- adds a point light source
 -- Diffuse dr,dg,db
 -- Specular sr,sg,sb
 -- Attenuation ar,ag,ab,aa
 function Renderer3D:AddPointLight	(x,y,z, dr,dg,db, sr,sg,sb, ar,ag,ab,aa)
-	local name =3D Client_AddPointLight(x,y,z, dr,dg,db, sr,sg,sb, ar,ag,ab,a=
a)
-	Light_SetCastShadows(name, gLightsCastShadows)
+	local name
+	if gMergePointLights then
+		name =3D x.."_"..y.."_"..z
+		GetMergePointLightBlock(x,y,z):AddLight(x,y,z)
+	else
+		name =3D Client_AddPointLight(x,y,z, dr,dg,db, sr,sg,sb, ar,ag,ab,aa)
+		Light_SetCastShadows(name, gLightsCastShadows)
+	end
 	=

 	if gShowLightDebug then
 		-- create mesh and debug marker list
 		if not gLightDebugMesh then
-			local r =3D 0.5
-			gLightDebugMesh =3D MakeSphereMesh(11,11,r,r,r)
+			local r =3D 0.25
+			gLightDebugMesh =3D MakeSphereMesh(7,7,r,r,r)
 			gLightDebugMeshList =3D {}
 		end
 		=

@@ -377,11 +414,14 @@
 end
 =

 function Renderer3D:RemovePointLight	(name)
-	Client_RemoveLight(name)
-	=

-	if gLightDebugMeshList and gLightDebugMeshList[name] then
-		gLightDebugMeshList[name]:Destroy()
-	end
+	if gMergePointLights then
+		local x,y,z =3D unpack(strsplit("_",name))
+		GetMergePointLightBlock(x,y,z):RemoveLight(x,y,z)
+	else
+		Client_RemoveLight(name)
+	end
+	=

+	DestroyIfAlive(gLightDebugMeshList and gLightDebugMeshList[name])
 end
 =

 -- hook to add artid based particle effects
@@ -680,6 +720,7 @@
 	self:UpdateLight()
 end
 =

+
 -- sets the personal light level, intensity=3D0 -> dark, intensity=3D1 -> =
bright
 function Renderer3D:SetPersonalLight		(mobile, intensity) =

 	self.mfPersonalLight =3D intensity
@@ -687,7 +728,44 @@
 end
 =

 function Renderer3D:UpdateLight	()
-	local f =3D math.max(self.mfSunLight or 0, self.mfPersonalLight or 0)
-	f =3D f / 2
-	Client_SetAmbientLight(f, f, f, 1)
-end
+	local a =3D self.mfSunLight or 0
+	local p =3D self.mfPersonalLight or 0
+	=

+	local x,y,z =3D gTileFreeWalk:GetExactLocalPos()
+	=

+	-- create personal light on demand
+	if not self.mPersonalLightName then
+		self.mPersonalLightName =3D Client_AddPointLight(
+			x-0.5,y+0.5,z+1, 	-- pos
+			1,1,1, 				-- diffuse
+			1,1,1, 				-- specular
+			5.0,0.5,0.5,0.0)		-- attenuation
+	end
+
+	-- update personal light
+	p =3D Clamp(p / 0.5,0,1)
+	Client_SetLightPosition(self.mPersonalLightName, x,y,z+2)
+	Client_SetLightDiffuseColor(self.mPersonalLightName, p,p,p)
+	Client_SetLightSpecularColor(self.mPersonalLightName, p,p,p)
+	Client_SetLightAttenuation(self.mPersonalLightName, Renderer3D.CalculateP=
ointLightAttenuation(5))
+	Light_SetCastShadows(self.mPersonalLightName, false)
+	=

+	if (not(gCaelumSystem)) then
+		-- update ambient light
+		a =3D Clamp(a / 2,0,1)
+		if gAmbientLight then
+			Client_SetAmbientLight(gAmbientLight.r*a, gAmbientLight.g*a, gAmbientLi=
ght.b*a,1)
+		end
+		=

+		-- update directional Sun Light
+		if gDirectionalLightSun and gDirectionalLightSun then
+			local xyz =3D gSunLightDirection		=

+			=

+			local rgb =3D gSunLightDiffuse		=

+			Client_SetLightDiffuseColor(gDirectionalLightSun,rgb.r*a,rgb.g*a,rgb.b*=
a)
+			=

+			local rgb =3D gSunLightSpecular		=

+			Client_SetLightSpecularColor(gDirectionalLightSun,rgb.r*a,rgb.g*a,rgb.b=
*a)
+		end
+	end
+end

Modified: trunk/lua/lib.3d.tilebatch.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.tilebatch.lua (original)
+++ trunk/lua/lib.3d.tilebatch.lua Wed Nov 19 11:15:19 2008
@@ -230,7 +230,7 @@
 	if (gLightsources) then
 		local arrtiletype =3D GetStaticTileType(iTileTypeID)
 		if( arrtiletype and TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Light=
Source) ) then
-			entity.lightname =3D Renderer3D:AddPointLight(entity.x-0.5,entity.y+0.5=
,entity.z+1+arrtiletype.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
+			entity.lightname =3D Renderer3D:AddStandartUOPointLight(entity.x,entity=
.y,entity.z+arrtiletype.miHeight)
 		end
 	end
 =


Modified: trunk/lua/lib.light.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.light.lua (original)
+++ trunk/lua/lib.light.lua Wed Nov 19 11:15:19 2008
@@ -6,12 +6,18 @@
 		not(gShadowTechnique =3D=3D "texture_additive_integrated")) then
 		=

 		-- Sun Light
-		local xyz =3D gSunLightDirection		gDirectionalLightSun =3D Client_AddDir=
ectionalLight(xyz.x,xyz.y,xyz.z)
-		local rgb =3D gSunLightDiffuse		Client_SetLightDiffuseColor(gDirectional=
LightSun,rgb.r,rgb.g,rgb.b)
-		local rgb =3D gSunLightSpecular		Client_SetLightSpecularColor(gDirection=
alLightSun,rgb.r,rgb.g,rgb.b)
+		local xyz =3D gSunLightDirection		=

+		gDirectionalLightSun =3D Client_AddDirectionalLight(xyz.x,xyz.y,xyz.z)
+		=

+		local rgb =3D gSunLightDiffuse		=

+		Client_SetLightDiffuseColor(gDirectionalLightSun,rgb.r,rgb.g,rgb.b)
+		=

+		local rgb =3D gSunLightSpecular		=

+		Client_SetLightSpecularColor(gDirectionalLightSun,rgb.r,rgb.g,rgb.b)
 	end
 =

 	-- Ambient Light
-	local rgb =3D gAmbientLight			Client_SetAmbientLight(rgb.r,rgb.g,rgb.b, 1=
.0)
+	local rgb =3D gAmbientLight			=

+	Client_SetAmbientLight(rgb.r,rgb.g,rgb.b, 1)
 end
 =


Modified: trunk/lua/lib.mapblock.3d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.statics.lua (original)
+++ trunk/lua/lib.mapblock.3d.statics.lua Wed Nov 19 11:15:19 2008
@@ -16,8 +16,8 @@
 cMapBlock_3D_Statics	=3D CreateClass(cMapBlockGrid)
 cMapBlock_3D_Statics.iBlockSize		=3D 8*2 -- in tiles
 cMapBlock_3D_Statics.iLoadRadius	=3D 8 -- in iBlockSize-blocks
-cMapBlock_3D_Statics.kMaxDist_Visible		=3D cMapBlock_3D_Statics.iBlockSize=
 * 4 -- camdist in tiles  see mapblock.base for default
-cMapBlock_3D_Statics.kMaxDist_Detail		=3D cMapBlock_3D_Statics.iBlockSize =
* 2 -- camdist in tiles
+cMapBlock_3D_Statics.kMaxDist_Visible		=3D cMapBlock_3D_Statics.iBlockSize=
 * 8 -- camdist in tiles  see mapblock.base for default
+cMapBlock_3D_Statics.kMaxDist_Detail		=3D cMapBlock_3D_Statics.iBlockSize =
* 4 -- camdist in tiles
 =

 -- forall entities fun(entity)
 function cMapBlock_3D_Statics:ForAllEntities (fun)

Modified: trunk/lua/lib.mapblock.3d.terrain.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.terrain.lua (original)
+++ trunk/lua/lib.mapblock.3d.terrain.lua Wed Nov 19 11:15:19 2008
@@ -1,8 +1,8 @@
 cMapBlock_3D_Terrain	=3D CreateClass(cMapBlockGrid)
 cMapBlock_3D_Terrain.iBlockSize		=3D 8*2 -- in tiles
 cMapBlock_3D_Terrain.iLoadRadius	=3D 8 -- in iBlockSize-blocks
-cMapBlock_3D_Terrain.kMaxDist_Visible		=3D cMapBlock_3D_Terrain.iBlockSize=
*4 -- camdist in tiles  see mapblock.base for default
-cMapBlock_3D_Terrain.kMaxDist_Detail		=3D cMapBlock_3D_Terrain.iBlockSize*=
2 -- camdist in tiles
+cMapBlock_3D_Terrain.kMaxDist_Visible		=3D cMapBlock_3D_Terrain.iBlockSize=
 * 8 -- camdist in tiles  see mapblock.base for default
+cMapBlock_3D_Terrain.kMaxDist_Detail		=3D cMapBlock_3D_Terrain.iBlockSize =
* 4 -- camdist in tiles
 =

 function cMapBlock_3D_Terrain:ClearDetail ()
 	--~ print("cMapBlock_3D_Terrain:ClearDetail")

Modified: trunk/lua/lib.mapblock.scheduler.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.scheduler.lua (original)
+++ trunk/lua/lib.mapblock.scheduler.lua Wed Nov 19 11:15:19 2008
@@ -8,7 +8,7 @@
 =

 function cScheduler:Init	()
 	self.pProcessList =3D {}
-	self.kGoodFPS =3D 25
+	self.kGoodFPS =3D 50
 	self.kGoodTicksBetweenFrames =3D 1000 / self.kGoodFPS -- 1000=3D1sec
 	self.kAllowedTicksPerFrame =3D self.kGoodTicksBetweenFrames
 end
@@ -50,13 +50,16 @@
 	table.sort(active_blocks,self.CmpProcess)
 	=

 	-- work until no time left
+	local avgdt =3D nil
 	for k,process in ipairs(active_blocks) do =

 		local t1 =3D Client_GetTicks()
 		process:Work(t_end)
 		local t2 =3D Client_GetTicks()
+
+		avgdt =3D avgdt and (avgdt*0.5+(t2-t1)*0.5) or (t2-t1)
 		=

 		--~ if (Client_GetTicks() >=3D t_end) then break end
-		if (t2 + t2 - t1 >=3D t_end) then break end
+		if (t2 + avgdt >=3D t_end) then break end
 	end
 end
 =


Modified: trunk/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.static.lua (original)
+++ trunk/lua/lib.static.lua Wed Nov 19 11:15:19 2008
@@ -164,12 +164,16 @@
 		local dx =3D 0 -- -0.5
 		local dy =3D 0 -- -0.5
 		=

+		local nx =3D 0
+		local ny =3D 0
+		local nz =3D 1
+		=

 		gFallbackModelCacheGfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
 		=

-		gFallbackModelCacheGfx:RenderableVertex( 0+dx,0+dy,dz, tw,v0)
-		gFallbackModelCacheGfx:RenderableVertex( 0+dx,1+dy,dz, u0,th)
-		gFallbackModelCacheGfx:RenderableVertex( 1+dx,0+dy,dz, u1,th)
-		gFallbackModelCacheGfx:RenderableVertex( 1+dx,1+dy,dz, tw,v1)
+		gFallbackModelCacheGfx:RenderableVertex( 0+dx,0+dy,dz, nx,ny,nz, tw,v0)
+		gFallbackModelCacheGfx:RenderableVertex( 0+dx,1+dy,dz, nx,ny,nz, u0,th)
+		gFallbackModelCacheGfx:RenderableVertex( 1+dx,0+dy,dz, nx,ny,nz, u1,th)
+		gFallbackModelCacheGfx:RenderableVertex( 1+dx,1+dy,dz, nx,ny,nz, tw,v1)
 		gFallbackModelCacheGfx:RenderableIndex3(0,1,2)
 		gFallbackModelCacheGfx:RenderableIndex3(1,3,2)
 		=

@@ -182,17 +186,21 @@
 	=

 		gFallbackModelCacheGfx:RenderableBegin(4*2,6*2,false,false,OT_TRIANGLE_L=
IST)
 		=

-		gFallbackModelCacheGfx:RenderableVertex( 0+dx,0.5+dy,0+dz, u1,v1)
-		gFallbackModelCacheGfx:RenderableVertex( 1+dx,0.5+dy,0+dz, u0,v1)
-		gFallbackModelCacheGfx:RenderableVertex( 1+dx,0.5+dy,h+dz, u0,v0)
-		gFallbackModelCacheGfx:RenderableVertex( 0+dx,0.5+dy,h+dz, u1,v0)
+		local nx,ny,nz =3D calculate_triangle_normal(0+dx,0.5+dy,0+dz, 1+dx,0.5+=
dy,0+dz, 1+dx,0.5+dy,h+dz)
+		=

+		gFallbackModelCacheGfx:RenderableVertex( 0+dx,0.5+dy,0+dz, nx,ny,nz, u1,=
v1)
+		gFallbackModelCacheGfx:RenderableVertex( 1+dx,0.5+dy,0+dz, nx,ny,nz, u0,=
v1)
+		gFallbackModelCacheGfx:RenderableVertex( 1+dx,0.5+dy,h+dz, nx,ny,nz, u0,=
v0)
+		gFallbackModelCacheGfx:RenderableVertex( 0+dx,0.5+dy,h+dz, nx,ny,nz, u1,=
v0)
 		gFallbackModelCacheGfx:RenderableIndex3(2,1,0)
 		gFallbackModelCacheGfx:RenderableIndex3(0,3,2)
 =

-		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,0+dy,0+dz, u1,v1)
-		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,1+dy,0+dz, u0,v1)
-		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,1+dy,h+dz, u0,v0)
-		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,0+dy,h+dz, u1,v0)
+		local nx,ny,nz =3D calculate_triangle_normal(0.5+dx,0+dy,0+dz, 0.5+dx,1+=
dy,0+dz, 0.5+dx,1+dy,h+dz)
+		=

+		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,0+dy,0+dz, nx,ny,nz, u1,=
v1)
+		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,1+dy,0+dz, nx,ny,nz, u0,=
v1)
+		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,1+dy,h+dz, nx,ny,nz, u0,=
v0)
+		gFallbackModelCacheGfx:RenderableVertex( 0.5+dx,0+dy,h+dz, nx,ny,nz, u1,=
v0)
 		gFallbackModelCacheGfx:RenderableIndex3(4+2,4+1,4+0)
 		gFallbackModelCacheGfx:RenderableIndex3(4+0,4+3,4+2)
 =




From no-reply at zwischenwelt.org  Wed Nov 19 23:07:31 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 19 Nov 2008 22:07:31 -0000
Subject: [Iris-commit] [IRIS] r2741 - in /trunk: bin/OgreMain.dll
 bin/Plugin_CgProgramManager.dll bin/Plugin_ParticleFX.dll
 bin/RenderSystem_Direct3D9.dll bin/RenderSystem_GL.dll bin/cg.dll
 bin/iris2.exe data/models/materials/textures.material vc8/iris.vcproj
Message-ID: <20081119220734.21D891C187E5@zwischenwelt.org>

Author: sience
Date: Wed Nov 19 23:07:28 2008
New Revision: 2741

Log:
-Ogre updated from 1.49 -> 1.6
-win32 binary updated
-textures.material updated for more fine foliage
-vc8 project updated

Modified:
    trunk/bin/OgreMain.dll
    trunk/bin/Plugin_CgProgramManager.dll
    trunk/bin/Plugin_ParticleFX.dll
    trunk/bin/RenderSystem_Direct3D9.dll
    trunk/bin/RenderSystem_GL.dll
    trunk/bin/cg.dll
    trunk/bin/iris2.exe
    trunk/data/models/materials/textures.material
    trunk/vc8/iris.vcproj

Modified: trunk/bin/OgreMain.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_CgProgramManager.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_ParticleFX.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_Direct3D9.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_GL.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/cg.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Wed Nov 19 23:07:28 2008
@@ -45,6 +45,29 @@
 	}
 }
 =

+material tex_base_foliage : tex_base
+{
+	technique default
+	{
+		pass Decal
+		{
+			cull_hardware none
+			cull_software none
+			=

+			alpha_rejection greater_equal 128
+
+			texture_unit
+			{
+				filtering anisotropic
+				max_anisotropy 8
+				texture checker.png
+				texture_alias MainTexture
+				tex_address_mode wrap
+			}
+		}
+	}
+}
+
 material tex_base_sceneblend : tex_base
 {
 	technique default
@@ -52,12 +75,14 @@
 		pass Decal
 		{
 			scene_blend alpha_blend
-//			alpha_rejection greater_equal 128
 			depth_write off
 			depth_check on
 			=

 			ambient vertexcolour
 			diffuse vertexcolour
+			=

+			cull_hardware none
+			cull_software none
 		}
 	}
 }
@@ -5519,13 +5544,10 @@
 =

 material tex_grass : tex_base_sceneblend
 { =

-	technique =

-	{ =

-		pass =

+	technique default
+	{
+		pass Decal
 		{
-			ambient vertexcolour
-			diffuse vertexcolour
-
 			texture_unit =

 			{ =

 				texture tex_grass.png
@@ -5922,39 +5944,14 @@
 	}
 }
 =

-material palm01_crown : tex_base_alpha
+material palm01_crown : tex_base_foliage
 {
-	technique
-	{
-		pass
-		{
-			alpha_rejection greater_equal 128
-
-			texture_unit
-			{
-				tex_address_mode wrap
-				texture tex_palmcrown.png
-			}
-		}
-
-	}
-}
-
-material palm01_leaf : tex_base_alpha
+	set_texture_alias MainTexture tex_palmcrown.png
+}
+
+material palm01_leaf : tex_base_foliage
 {
-	technique
-	{
-		pass
-		{
-			alpha_rejection greater_equal 128
-
-			texture_unit
-			{
-				tex_address_mode wrap
-				texture tex_palmleaf.png
-			}
-		}
-	}
+	set_texture_alias MainTexture tex_palmleaf.png
 }
 =

 material Atlas_Will : tex_base =


Modified: trunk/vc8/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc8/iris.vcproj (original)
+++ trunk/vc8/iris.vcproj Wed Nov 19 23:07:28 2008
@@ -126,7 +126,7 @@
 				OmitFramePointers=3D"false"
 				EnableFiberSafeOptimizations=3D"true"
 				WholeProgramOptimization=3D"true"
-				AdditionalIncludeDirectories=3D"&quot;$(INCLUDE)&quot;;&quot;C:\Progra=
mme\Microsoft SDKs\Windows\v6.1\Include\&quot;;&quot;$(OGRE_HOME)\include\&=
quot;;&quot;$(OGRE_HOME)\include\OIS\&quot;;..\include\;..\include\zlib;..\=
lugre\include;..\include\fmodx;&quot;..\lugre\lib\lua-5.1.3\src\&quot;;..\l=
ugre\lib\md5\include;..\lugre\lib\cadune_tree\include;..\lugre\lib\paged_ge=
ometry\include;..\lugre\lib\caelum\include;c:\Programme\boost\boost_1_34_1\"
+				AdditionalIncludeDirectories=3D"&quot;$(INCLUDE)&quot;;&quot;C:\Progra=
mme\Microsoft SDKs\Windows\v6.1\Include\&quot;;&quot;$(OGRE_HOME)\include\&=
quot;;&quot;$(OGRE_HOME)\include\OIS\&quot;;..\include\;..\include\zlib;..\=
lugre\include;..\include\fmodx;&quot;..\lugre\lib\lua-5.1.4\src\&quot;;..\l=
ugre\lib\md5\include;..\lugre\lib\cadune_tree\include;..\lugre\lib\paged_ge=
ometry\include;..\lugre\lib\caelum\include;c:\Programme\boost\boost_1_34_1\"
 				PreprocessorDefinitions=3D"WIN32;NDEBUG;_WINDOWS;MAIN_WORKING_DIR=3D\&=
quot;../\&quot;;USE_FMOD;USE_LUGRE_LIB_MD5;USE_LUGRE_LIB_CADUNE_TREE;USE_LU=
GRE_LIB_CAELUM"
 				GeneratePreprocessedFile=3D"0"
 				StringPooling=3D"true"



From no-reply at zwischenwelt.org  Thu Nov 20 16:32:39 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 20 Nov 2008 15:32:39 -0000
Subject: [Iris-commit] [IRIS] r2742 - in /trunk: lua/config_declarations.lua
 lua/gui/gui.skill.lua lua/lib.debugmenu.lua lua/net/net.skill.lua
 plugins/itemcounter.lua
Message-ID: <20081120153240.AC57D1C187E5@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Nov 20 16:32:35 2008
New Revision: 2742

Log:
itemcounter : reagent order changed to correspond to mage-shops, skilllock/=
up/down bug fixed, removed demise from default shardlist

Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/gui/gui.skill.lua
    trunk/lua/lib.debugmenu.lua
    trunk/lua/net/net.skill.lua
    trunk/plugins/itemcounter.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Thu Nov 20 16:32:35 2008
@@ -166,14 +166,14 @@
 		gPolServer =3D false =

 	}
 =

-gShardList["uodemise.com"] =3D {
-		gLoginname =3D "",	-- Loginname
-		gPassword =3D "",		-- Password
-		gLoginServerIP =3D "login.uodemise.com",
-		gLoginServerPort =3D 2593,
-		gServerSeed =3D hex2num("0xFFFFFFFF"),
-		gPolServer =3D false
-	}
+--~ gShardList["uodemise.com"] =3D {
+		--~ gLoginname =3D "",	-- Loginname
+		--~ gPassword =3D "",		-- Password
+		--~ gLoginServerIP =3D "login.uodemise.com",
+		--~ gLoginServerPort =3D 2593,
+		--~ gServerSeed =3D hex2num("0xFFFFFFFF"),
+		--~ gPolServer =3D false
+	--~ }
 =

 gShardList["uogamers.com"] =3D {
 		gLoginname =3D "",	-- Loginname

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Thu Nov 20 16:32:35 2008
@@ -101,6 +101,7 @@
 -- sets a skill value and lock state
 -- lockstate: (0=3Dup, 1=3Ddown, 2=3Dlocked)
 function SkillUpdate(skillid, value, base_value, lockstate, name)
+	--~ print("#######SkillUpdate",skillid, value, base_value, lockstate, nam=
e)
 	if not gPlayerSkills then
 		gPlayerSkills =3D {}
 	end
@@ -273,7 +274,7 @@
 					v.button_lock.gfx:SetVisible(lockstate =3D=3D 2)
 					v.button_up.gfx:SetVisible(lockstate =3D=3D 0)
 					v.button_down.gfx:SetVisible(lockstate =3D=3D 1)
-					Send_SkillLockState(skillid,lockstate)
+					Send_SkillLockState(skillid-1,lockstate)
 					gPlayerSkills[skillid].lockstate =3D lockstate
 				end
 			end

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Thu Nov 20 16:32:35 2008
@@ -41,6 +41,7 @@
 =

 =

 gDebugMenuModelTable =3D {
+	{artid=3D9 , content=3D{}}, -- demon
 	{artid=3D0x023e , content=3D{}}, -- bladespirit , effect/animation not us=
ed (granny format)
 	{artid=3D0x25d , content=3D{}}, -- another human male			-- maybe samurai/=
elven scale ??
 	{artid=3D0x25e , content=3D{}}, -- another human female			-- maybe samura=
i/elven scale ??

Modified: trunk/lua/net/net.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.skill.lua (original)
+++ trunk/lua/net/net.skill.lua Thu Nov 20 16:32:35 2008
@@ -18,10 +18,11 @@
 -- sends the server the lock state of one skill (more skills are possible =
but not used in this function)
 -- lockstate (0=3Dup, 1=3Ddown, 2=3Dlocked)
 function Send_SkillLockState(skillid, lockstate)
+	print("Send_SkillLockState",skillid,lockstate)
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Skills)
 	out:PushNetUint16(6)
-	out:PushNetUint16(skillid)
+	out:PushNetUint16(skillid) -- 00 0A =3D camping
 	out:PushNetUint8(lockstate)
 	out:SendPacket()
 --	print("-Send_SkillLockState skillid",skillid,"state",lockstate)

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Thu Nov 20 16:32:35 2008
@@ -10,13 +10,13 @@
 kItemCounterBagType =3D 0xe76
 gItemCounterTypes 				=3D {
 	{name=3Dblackperl		,artid=3D0xf7a},
+	{name=3Dbloodmoss		,artid=3D0xf7b}, =

 	{name=3Dmandrake		,artid=3D0xf86},
-	{name=3Dbloodmoss		,artid=3D0xf7b}, =

+	{name=3Dgarlic		,artid=3D0xf84},
+	{name=3Dginseng		,artid=3D0xf85},
+	{name=3Dnightshade	,artid=3D0xf88},
+	{name=3Dspidersilk	,artid=3D0xf8d},    =

 	{name=3Dsulfurusash	,artid=3D0xf8c},  =

-	{name=3Dspidersilk	,artid=3D0xf8d},    =

-	{name=3Dginseng		,artid=3D0xf85},
-	{name=3Dgarlic		,artid=3D0xf84},
-	{name=3Dnightshade	,artid=3D0xf88},
 									 =

 	{name=3Dgheal			,artid=3D3852},
 	{name=3Dgcure			,artid=3D3847},



From no-reply at zwischenwelt.org  Fri Nov 21 00:10:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 20 Nov 2008 23:10:42 -0000
Subject: [Iris-commit] [IRIS] r2743 - in /trunk/lua: gui/gui.helper.lua
 lib.2d.spriteblock.lua lib.mapblock.2d.statics.lua lib.spellinfo.lua
 lib.uoids.lua
Message-ID: <20081120231042.DA4D41C187E5@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Nov 21 00:10:41 2008
New Revision: 2743

Log:
2d : water from terrain (no more black holes in the ocean), fixed double wa=
ter tiles that looked bad with tansparency, added a few spellweaving powerw=
ords

Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.mapblock.2d.statics.lua
    trunk/lua/lib.spellinfo.lua
    trunk/lua/lib.uoids.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Fri Nov 21 00:10:41 2008
@@ -88,11 +88,11 @@
 			end
 		end
 					=

-		local text =3D sprintf("%5.1ffps %dt %db gfx | %s OGRE %s LUA mem | %i j=
 %i/%i l",
+		local text =3D sprintf("%5.1ffps %dt %db gfx | OGRE:%s | LUA:%s | %i j %=
i/%i l",
 			fps, t, b, =

 			DisplayMemoryUsageFormatHelper(memoryusage),
 			DisplayMemoryUsageFormatHelper(mem_dyn), =

-			j, l, lu
+			j, l, lu   -- #"job.create()-jobs"    blockloader: working/killme
 		)
 		if (not gMemoryUsageField) then
 			local vw,vh =3D GetViewportSize()

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Fri Nov 21 00:10:41 2008
@@ -281,15 +281,19 @@
 	if (atlas.atlasgroup) then return atlas.atlasgroup:LoadAtlasMat(atlas,bas=
emat) end
 end
 =

--- bUseRootGfxForFirst : default false, can be set to true if there is onl=
y one sprite
 function cUOSpriteBlock:AddStaticWaterTile 	(static)
+	if (not self.pWaterAntiDouble) then self.pWaterAntiDouble =3D {} end
+	local n =3D static.tx..","..static.ty..","..static.zloc
+	if (self.pWaterAntiDouble[n]) then return end
+	self.pWaterAntiDouble[n] =3D true
+	return self:AddWaterTile(static.tx,static.ty,static.zloc,static.artid,sta=
tic,static.fBlockIndexRel)
+end
+
+function cUOSpriteBlock:AddWaterTile(tx,ty,zloc,artid,data,sortrelidx) =

 	local multitile =3D 8 -- gWater2DMatName
 	local e =3D 1/multitile
-	local tx =3D static.tx
-	local ty =3D static.ty
 	local u0,v0 =3D (tx%multitile)*e,(ty%multitile)*e
-	local zloc =3D static.zloc
-	local sortbonus =3D CalcSortBonus(static.artid,tx,ty,zloc,static.fBlockIn=
dexRel)
+	local sortbonus =3D CalcSortBonus(artid,tx,ty,zloc,sortrelidx or 0)
 	=

 	local pw =3D 44
 	local ph =3D 44
@@ -313,12 +317,13 @@
 		v0 =3D v0,
 		u1 =3D u0+e,
 		v1 =3D v0+e,
-		data =3D static
+		data =3D data
 	}
 	table.insert(self.pWaterTiles,watertile)
 end
 =

 gWater2DMatName =3D "Water2D"
+-- bUseRootGfxForFirst : default false, can be set to true if there is onl=
y one sprite
 function cUOSpriteBlock:Build 	(basemat,bUseRootGfxForFirst)
 	self:ClearGfx()
 	self.rootgfx =3D CreateRootGfx3D()

Modified: trunk/lua/lib.mapblock.2d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.2d.statics.lua (original)
+++ trunk/lua/lib.mapblock.2d.statics.lua Fri Nov 21 00:10:41 2008
@@ -50,6 +50,16 @@
 	local spriteblock =3D cUOSpriteBlock:New()
 	self.spriteblock =3D spriteblock
 	=

+	local xloc =3D self.bx*8
+	local yloc =3D self.by*8
+	for tx =3D 0,7 do =

+	for ty =3D 0,7 do =

+		local tiletype,zloc =3D GetGroundAtAbsPos(xloc+tx,yloc+ty)
+		if (gWaterGroundByTileTypes[tiletype]) then spriteblock:AddWaterTile(tx,=
ty,zloc,tiletype) end
+	end
+	end
+	self:YieldIfOverTime()
+	=

 	-- preload statics
 	for i,static in pairs(self.statics) do =

 		if (static.zloc >=3D iBlendOutMinZ and static.zloc <=3D iBlendOutMaxZ) t=
hen spriteblock:AddStatic(static) end

Modified: trunk/lua/lib.spellinfo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellinfo.lua (original)
+++ trunk/lua/lib.spellinfo.lua Fri Nov 21 00:10:41 2008
@@ -148,14 +148,19 @@
 RegisterSpell_Chivalry( "Sacred Journey", "Sanctum Viatas", -1, 9002)
 -- ***** ***** ***** ***** ***** spellweaving
 RegisterSpell_Spellweaving( "Arcane Circle", "Myrshalee", -1)
-RegisterSpell_Spellweaving( "Attune Weapon", "Haeldril", -1)
-RegisterSpell_Spellweaving( "Essence of Wind", "Anathrae", -1)
-RegisterSpell_Spellweaving( "Ethereal Voyage", "Orlavdra", -1)
-RegisterSpell_Spellweaving( "Gift of Life", "Illorae", -1)
 RegisterSpell_Spellweaving( "Gift of Renewal", "Olorisstra", -1)
+RegisterSpell_Spellweaving( "Immolating Weapon", "Thalshara", -1) -- vm, n=
ot in runuo?
+RegisterSpell_Spellweaving( "Attune Weapon", "Haeldril", -1)  -- attunemen=
t ?
+RegisterSpell_Spellweaving( "Thunderstorm", "Erelonia", -1)
 RegisterSpell_Spellweaving( "Nature's Fury", "Rauvvrae", -1, false) -- not=
 in town
-RegisterSpell_Spellweaving( "Reaper Form", "Tarisstree", -1)
 RegisterSpell_Spellweaving( "Summon Fey", "Alalithra", -1)
 RegisterSpell_Spellweaving( "Summon Fiend", "Nylisstra", -1)
-RegisterSpell_Spellweaving( "Thunderstorm", "Erelonia", -1)
+RegisterSpell_Spellweaving( "Reaper Form", "Tarisstree", -1)
+RegisterSpell_Spellweaving( "Wildfire", "Haelyn", -1) -- vm, not in runuo?
+RegisterSpell_Spellweaving( "Essence of Wind", "Anathrae", -1)
+RegisterSpell_Spellweaving( "Dryad Allure", "Rathril", -1) -- vm, not in r=
unuo?
+RegisterSpell_Spellweaving( "Ethereal Voyage", "Orlavdra", -1)
 RegisterSpell_Spellweaving( "Word of Death", "Nyraxle", -1)
+RegisterSpell_Spellweaving( "Gift of Life", "Illorae", -1)
+RegisterSpell_Spellweaving( "Arcane Empowerment", "Aslavdra", -1) -- vm, n=
ot in runuo?
+

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Fri Nov 21 00:10:41 2008
@@ -649,3 +649,7 @@
 gStaticWaterArtIDs =3D {0x1559,0x1796,0x1797,0x1798,0x1799,0x179a,0x179b,0=
x179c,0x179d,0x179e,0x179f,0x17a0,0x17a1,0x17a2,0x17a3,0x17a4,0x17a5,0x17a6=
,0x17a7,0x17a8,0x17a9,0x17aa,0x17ab,0x17ac,0x17ad,0x17ae,0x17af,0x17b0,0x17=
b1,0x17b2,0x346e,0x346f,0x3470,0x3471,0x3472,0x3473,0x3474,0x3475,0x3476,0x=
3477,0x3478,0x3479,0x347a,0x347b,0x347c,0x347d,0x347e,0x347f,0x3480,0x3481,=
0x3482,0x3483,0x3484,0x3485,0x3494,0x3495,0x3496,0x3497,0x3498,0x349a,0x349=
b,0x349c,0x349d,0x349e,0x34a0,0x34a1,0x34a2,0x34a3,0x34a4,0x34a6,0x34a7,0x3=
4a8,0x34a9,0x34aa,0x34ab,0x34b8,0x34b9,0x34ba,0x34bb,0x34bd,0x34be,0x34bf,0=
x34c0,0x34c2,0x34c3,0x34c4,0x34c5,0x34c7,0x34c8,0x34c9,0x34ca}
 gStaticWaterByArtIDs =3D {}
 for k,artid in ipairs(gStaticWaterArtIDs) do gStaticWaterByArtIDs[artid] =
=3D true end
+
+gWaterGroundTileTypes =3D {0x00a8,0x00a9,0x00aa,0x00ab,0x0136,0x0137}
+gWaterGroundByTileTypes =3D {}
+for k,tiletype in ipairs(gWaterGroundTileTypes) do gWaterGroundByTileTypes=
[tiletype] =3D true end



From no-reply at zwischenwelt.org  Sat Nov 22 16:10:01 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 22 Nov 2008 15:10:01 -0000
Subject: [Iris-commit] [IRIS] r2744 - in /trunk/lua: lib.huepicker.lua
 lib.macrolist.lua main.lua net/net.dynamic.lua
Message-ID: <20081122151001.685951C187E5@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov 22 16:10:00 2008
New Revision: 2744

Log:
hue/color picker dialog, bugfix:refresh container widgets on object-to-obje=
ct message, updates color etc, new macro commands : MacroCmd_ListMobilesInR=
ange,MacroCmd_ListMobiles(filterfun)

Added:
    trunk/lua/lib.huepicker.lua
Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/main.lua
    trunk/lua/net/net.dynamic.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Nov 22 16:10:00 2008
@@ -425,6 +425,20 @@
 		end
 	end
 	return foundmob
+end
+
+function MacroCmd_ListMobilesInRange (filterfun,maxdist)
+	local res =3D {}
+	for k,mobile in pairs(GetMobileList()) do =

+		if (GetUODistToPlayer(mobile.xloc,mobile.yloc) <=3D maxdist and filterfu=
n(mobile)) then table.insert(res,mobile) end =

+	end =

+	return res
+end
+
+function MacroCmd_ListMobiles (filterfun)
+	local res =3D {}
+	for k,mobile in pairs(GetMobileList()) do if (filterfun(mobile)) then tab=
le.insert(res,mobile) end end =

+	return res
 end
 =

 function MacroCmd_FindNearestMob () return MacroCmd_FindNearestMobByName()=
 end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Nov 22 16:10:00 2008
@@ -94,6 +94,7 @@
 dofile(libpath .. "lib.blendout.lua")
 dofile(libpath .. "lib.packetvideo.lua")
 dofile(libpath .. "lib.objectpicker.lua")
+dofile(libpath .. "lib.huepicker.lua") =

 dofile(libpath .. "lib.razormacro.lua")
 dofile(libpath .. "lib.razorconfig.lua")
 =


Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Sat Nov 22 16:10:00 2008
@@ -148,5 +148,10 @@
 	--~ print("kPacket_Object_to_Object",SmartDump(dynamicdata))
 	CreateOrUpdateDynamic(dynamicdata)
 	=

-	if (dynamicdata.iContainerSerial ~=3D GetPlayerBackPackSerial()) then pri=
nt("######### kPacket_Object_to_Object containerid:",dynamicdata.iContainer=
Serial) end
+	if (dynamicdata.iContainerSerial > 0) then
+		local container =3D GetOrCreateContainer(dynamicdata.iContainerSerial)
+		RefreshContainerItemWidgets(container)
+	end
+	=

+	--~ if (dynamicdata.iContainerSerial ~=3D GetPlayerBackPackSerial()) then=
 print("######### kPacket_Object_to_Object containerid:",dynamicdata.iConta=
inerSerial) end
 end



From no-reply at zwischenwelt.org  Sat Nov 22 20:13:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 22 Nov 2008 19:13:32 -0000
Subject: [Iris-commit] [IRIS] r2745 - in /trunk/lua: lib.uodragdrop.lua
	net/net.dynamic.lua
Message-ID: <20081122191332.6A6B31C187E5@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov 22 20:13:31 2008
New Revision: 2745

Log:
fixed dragdrop on multi floor

Modified:
    trunk/lua/lib.uodragdrop.lua
    trunk/lua/net/net.dynamic.lua

Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Sat Nov 22 20:13:31 2008
@@ -446,6 +446,9 @@
 		x,y,z =3D GetMouseHitTileCoords()
 		local iSerial =3D GetMouseHitSerial()
 		=

+		print("#####dragdrop,gMousePickFoundHit=3D",iSerial,SmartDump(gMousePick=
FoundHit))
+		--~ #####dragdrop,gMousePickFoundHit=3D       {hit_zloc=3D35=3D0x23,dyna=
mic=3Dtable: 0x9d50c38,hittype=3D2,hit_xloc=3D3443=3D0x0d73,hit_yloc=3D2659=
=3D0x0a63,}
+
 		-- uo-hack : don't send drop-container on dynamic floor tiles (yard wand=
 tool on vm), to allow puttin items on the floor (flags=3D0x201)
 		if (iSerial and iSerial ~=3D 0) then =

 			local dynamic =3D GetDynamic(iSerial)
@@ -454,6 +457,7 @@
 				if (flags and TestBit(flags,kTileDataFlag_Surface)) then   --  or kTil=
eDataFlag_Background ?
 					iSerial =3D nil
 				end
+				if (dynamic.artid >=3D gMulti_ID) then iSerial =3D nil end
 			end
 		end
 		=


Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Sat Nov 22 20:13:31 2008
@@ -124,7 +124,7 @@
 		--~ printf("kPacket_Container_Contents %d/%d %s\n",i,itemcount,SmartDump=
(dynamicdata))
 		CreateOrUpdateDynamic(dynamicdata)
 	end
-	print("######### kPacket_Container_Contents",iLastSerial,oldcount,itemcou=
nt)
+	--~ print("######### kPacket_Container_Contents",iLastSerial,oldcount,ite=
mcount)
 	=

 	=

 	if (iLastSerial) then Update_Spellbook(iLastSerial) end



From no-reply at zwischenwelt.org  Sun Nov 23 00:06:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 22 Nov 2008 23:06:11 -0000
Subject: [Iris-commit] [IRIS] r2746 - in /trunk: lua/gui/gui.trade.lua
 lua/lib.macrolist.lua lua/net/net.trade.lua plugins/itemcounter.lua
Message-ID: <20081122230612.15F391C187E5@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov 23 00:06:09 2008
New Revision: 2746

Log:
new macro : MacroCmd_MiniHealCureSelf, option to skip mage-scrolls in shop =
buy dialog, small bugfixes, added explopot to itemcounter

Modified:
    trunk/lua/gui/gui.trade.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.trade.lua
    trunk/plugins/itemcounter.lua

Modified: trunk/lua/gui/gui.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.trade.lua (original)
+++ trunk/lua/gui/gui.trade.lua Sun Nov 23 00:06:09 2008
@@ -34,7 +34,7 @@
 	amount =3D amount or 1
 	if (gKeyPressed[key_lcontrol]) then amount =3D (amount > 0) and 10 or -10=
 end
 	local newamount =3D math.max(0,math.min(good.itemamount,good.tradeamount =
+ amount))
-	if (gKeyPressed[key_lshift]) then newamount =3D good.itemamount end
+	if (gKeyPressed[key_lshift]) then newamount =3D (amount > 0) and good.ite=
mamount or 0 end
 	if (good.tradeamount ~=3D newamount) then
 		good.tradeamount =3D newamount
 		shop.dialog_bill:RebuildCurrentPage() =


Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Nov 23 00:06:09 2008
@@ -36,6 +36,16 @@
 function GetPlayerStamMax() return GetMobileStat(GetPlayerMobile(),"maxSta=
mina") end =

 function GetPlayerHitsCur() return GetMobileStat(GetPlayerMobile(),"curHit=
s") end =

 function GetPlayerHitsMax() return GetMobileStat(GetPlayerMobile(),"maxHit=
s") end =

+
+function MacroCmd_MiniHealCureSelf () =

+	local mobile =3D GetPlayerMobile()
+	if (not mobile) then return end
+	if (TestBit(mobile.flag,kMobileFlag_Poisoned)) then
+		MacroCmd_Spell("Cure"	,GetPlayerSerial())
+	else
+		MacroCmd_Spell("Heal"	,GetPlayerSerial())
+	end
+end
 =

 	=

 -- GetPlayerMobile
@@ -109,7 +119,7 @@
 function MacroCmd_SendTargetSerial	(serial) =

 	local mobile =3D GetMobile(serial)
 	if mobile then return CompleteTargetMode({ hittype =3D kMousePickHitType_=
Mobile,  mobile =3D mobile }) end
-	local dynamic =3D GetMobile(serial)
+	local dynamic =3D GetDynamic(serial)
 	if dynamic then return CompleteTargetMode({ hittype =3D kMousePickHitType=
_Dynamic,  dynamic =3D dynamic }) end
 end
 =


Modified: trunk/lua/net/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.trade.lua (original)
+++ trunk/lua/net/net.trade.lua Sun Nov 23 00:06:09 2008
@@ -1,3 +1,74 @@
+gShopBlendoutGroups =3D {}
+gShopBlendoutGroupArtIds =3D {}
+gShopBlendoutGroupArtIds.magescrolls =3D {
+7982, --  Clumsy
+7983, --  Create Food
+7984, --  Feeblemind
+7985, --  Heal
+7986, --  Magic Arrow
+7987, --  Night Sight
+7981, --  Reactive Armor
+7988, --  Weaken
+7989, --  Agility
+7990, --  Cunning
+7991, --  Cure
+7992, --  Harm
+7993, --   Magic Trap
+7994, --   Magic Untrap
+7995, --   Protection
+7996, --   Strength
+7997, --   Bless
+7998, --   Fireball
+7999, --   Magic Lock
+8000, --   Poison
+8001, --   Telekinesis
+8002, --   Teleport
+8003, --   Unlock
+8004, --   Wall of Stone
+8005, --   Arch Cure
+8006, --   Arch Protection
+8007, --   Curse
+8008, --   Fire Field
+8009, --   Greater Heal
+8010, --   Lightning
+8011, --   Mana Drain
+8012, --   Recall
+8013, --   Blade Spirits
+8014, --   Dispel Field
+8015, --   Incognito
+8016, --   Magic Reflection
+8017, --   Mind Blast
+8018, --   Paralyze
+8019, --   Poison Field
+8020, --   Summon Creature
+8021, --   Dispel
+8022, --   Energy Bolt
+8023, --   Explosion
+8024, --   Invisibility
+8025, --   Mark
+8026, --   Mass Curse
+8027, --   Paralyze Field
+8028, --   Reveal
+8029, --   Chain Lightning
+8030, --   Energy Field
+8031, --   Flamestrike
+8032, --   Gate Travel
+8033, --   Mana Vampire
+8034, --   Mass Dispel
+8035, --   Meteor Swarm
+8036, --   Polymorph
+8037, --   Earthquake
+8038, --   Energy Vortex
+8039, --   Resurrection
+8040, --   Summon Air Elemental
+8041, -- Summon Daemon
+8042, -- Summon Earth Elemental
+8043, -- Summon Fire Elemental
+8044, -- Summon Water Elemental
+}
+
+
+
 -- helper function
 function GetShopMobileID (shop)
 	if (shop.shopMobileID) then return shop.shopMobileID end -- only set for =
sell-shop
@@ -7,6 +78,7 @@
 	if (not shopmobile) then printf("FATAL : GetShopMobileID : shopmobile not=
 found for container %08x\n",shop.shopContainerID) return end
 	return shopmobile.serial
 end
+
 =

 -- lists all items that the player can sell to a specific vendor
 -- similar to kPacket_Shop_Data =3D 0x74 , but there are some differences
@@ -149,6 +221,7 @@
 		-- check if the shop matches the container
 		if (table.getn(sorteditems) ~=3D shop.goodcount) then print("WARNING : k=
Packet_Shop_Data : itemcount mismatch",table.getn(sorteditems),shop.goodcou=
nt) end
 	=

+		local knownartids =3D {}
 		-- receive shop items
 		for i =3D 1,shop.goodcount do =

 			local good =3D {}
@@ -159,6 +232,7 @@
 			good.index 		=3D i
 			good.item 		=3D sorteditems[i] -- the uo protocol is just freaked
 			=

+			=

 			good.itemserial	=3D good.item.serial
 			good.itemartid	=3D good.item.artid
 			good.itemhue	=3D good.item.hue
@@ -166,7 +240,14 @@
 			=

 			local nameint =3D tonumber(good.name)
 			if (nameint and good.name =3D=3D ""..nameint) then good.name =3D gClilo=
cLoader:Get(nameint) or ("unknown_cliloc_"..nameint) end
-			shop.goods[i] =3D good
+			=

+			--~ if (not knownartids[good.item.artid]) then print("shopitem",good.it=
em.artid,good.name) knownartids[good.item.artid] =3D true end
+			local bBlendout =3D false =

+			for k,v in pairs(gShopBlendoutGroups) do =

+				if (good.item and in_array(good.item.artid,gShopBlendoutGroupArtIds[k]=
)) then bBlendout =3D true end =

+			end			=

+			=

+			if (not bBlendout) then shop.goods[i] =3D good end
 		end
 		=

 		OpenShopDialog(shop)

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Sun Nov 23 00:06:09 2008
@@ -21,6 +21,7 @@
 	{name=3Dgheal			,artid=3D3852},
 	{name=3Dgcure			,artid=3D3847},
 	{name=3Drefresh		,artid=3D3851},
+	{name=3Dexplo			,artid=3D3853},
 	=

 	{name=3Dgold			,artid=3D0xeef},
 	{name=3Dbandas		,artid=3D0xe21},



From no-reply at zwischenwelt.org  Sun Nov 23 03:00:50 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 23 Nov 2008 02:00:50 -0000
Subject: [Iris-commit] [IRIS] r2747 - in /trunk/lua: lib.2d.dynamic.lua
	lib.book.lua main.lua
Message-ID: <20081123020050.9553A1C187E5@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov 23 03:00:49 2008
New Revision: 2747

Log:
started uobook handling, but no dialog yet

Added:
    trunk/lua/lib.book.lua
Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Sun Nov 23 03:00:49 2008
@@ -185,7 +185,7 @@
 		local sortty =3D yloc-floor(yloc/8)*8
 		local sorttz =3D zloc
 		local fIndexRel =3D k / totalpartnum
-		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ) then
+		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ and ((not gMulti=
_OnlyShowFloor) or tz <=3D 0)) then
 			local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Cal=
cSortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
 			if (sprite) then
 				sprite.xloc =3D xloc -- mousepicking

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Nov 23 03:00:49 2008
@@ -94,6 +94,7 @@
 dofile(libpath .. "lib.blendout.lua")
 dofile(libpath .. "lib.packetvideo.lua")
 dofile(libpath .. "lib.objectpicker.lua")
+dofile(libpath .. "lib.book.lua")
 dofile(libpath .. "lib.huepicker.lua") =

 dofile(libpath .. "lib.razormacro.lua")
 dofile(libpath .. "lib.razorconfig.lua")



From no-reply at zwischenwelt.org  Sun Nov 23 15:38:47 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 23 Nov 2008 14:38:47 -0000
Subject: [Iris-commit] [IRIS] r2748 - /trunk/lua/lib.book.lua
Message-ID: <20081123143847.809CC1C187E4@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov 23 15:38:47 2008
New Revision: 2748

Log:
simple book dialog

Modified:
    trunk/lua/lib.book.lua

Modified: trunk/lua/lib.book.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.book.lua (original)
+++ trunk/lua/lib.book.lua Sun Nov 23 15:38:47 2008
@@ -17,9 +17,6 @@
 	=

 	=

 =

-### kPacket_Book_Info header:   {author=3D"Staff of Vetus-Mundus",authorle=
n=3D22=3D0x16,title=3D"a small introduction",unknown=3D1,numpages=3D15=3D0x=
0f,writable=3D0,serial=3D0x4040c1ce,titlelen=3D21=3D0x15,}
-### kPacket_Book_Contents pages:        0       {numpages=3D15=3D0x0f,seri=
al=3D0x4040c1ce,pages=3D{1=3D{numlines=3D8,pagenum=3D1,lines=3D{1=3D"We wel=
come thee",2=3D"traveler",3=3D"",4=3D"we're glad to see",5=3D"thy journey l=
ed",6=3D"thee to Vetus Mundus",7=3D"The gods of this",8=3D"",},},2=3D{numli=
nes=3D8,pagenum=3D2,lines=3D{1=3D"world will not bother",2=3D"with much rul=
es,",3=3D"nonetheless",4=3D"there's something to",5=3D"follow here.",6=3D"R=
ules are as listened:",7=3D"'One can do whatever",8=3D"",},},3=3D{numlines=
=3D8,pagenum=3D3,lines=3D{1=3D"provides fun. Note,",2=3D"that PvP is only",=
3=3D"possible on the facette",4=3D"called felucca.",5=3D"The second rule is=
:",6=3D"'We all treat each other",7=3D"with respect', the gods",8=3D"",},},=
4=3D{numlines=3D8,pagenum=3D4,lines=3D{1=3D"don't wish to hear",2=3D"excess=
ive slang, nor",3=3D"any indignities",4=3D"from the mortal",5=3D"or speakin=
g to",6=3D"oneself. Dost you wish",7=3D"to live peacefully",8=3D"",},},5=3D=
{numlines=3D8,pagenum=3D5,lines=3D{1=3D"here on Vetus Mundus, ",2=3D"it's i=
ndispensable",3=3D"to follow this rule.",4=3D"",5=3D"To make thy beginning"=
,6=3D"as comfortable as possible,",7=3D"we will grant thee some",8=3D"",},}=
,6=3D{numlines=3D8,pagenum=3D6,lines=3D{1=3D"commands. Listen carefully.",2=
=3D"To communicate with other",3=3D"mortal in the public",4=3D"Channel, one=
 has to use",5=3D"the following",6=3D"Combination:",7=3D".c (thy message)",=
8=3D"",},},7=3D{numlines=3D8,pagenum=3D7,lines=3D{1=3D"This will refer thy"=
,2=3D"message to the",3=3D"public channel.",4=3D"One can use:",5=3D".pm (na=
me)(message)",6=3D"to send a",7=3D"private message to",8=3D"",},},8=3D{numl=
ines=3D8,pagenum=3D8,lines=3D{1=3D"another mortal,",2=3D"which only can be =
read",3=3D"by him or her. It",4=3D"will arrive him or her",5=3D"even if he =
or she is",6=3D"not in our world",7=3D"at the moment. It will",8=3D"",},},9=
=3D{numlines=3D8,pagenum=3D9=3D0x09,lines=3D{1=3D"be sent to him or her",2=
=3D"as soon as he visits",3=3D"our world the next time.",4=3D"If thee can g=
ather the",5=3D"pleasure to join a guild",6=3D"someday, thee can send ",7=
=3D"them a message with the",8=3D"",},},10=3D{numlines=3D8,pagenum=3D10=3D0=
x0a,lines=3D{1=3D"following command:",2=3D".g (message).",3=3D"This message=
 can only",4=3D"be read by thy",5=3D"guildmates.",6=3D"There are several ot=
her",7=3D"commands availabe,",8=3D"",},},11=3D{numlines=3D8,pagenum=3D11=3D=
0x0b,lines=3D{1=3D"which can be shown by",2=3D"typing .help.",3=3D"If thee =
has any further.",4=3D"questions, don't hesitate",5=3D"to ask our gods,",6=
=3D"as they surely will",7=3D"grant you as much help",8=3D"",},},12=3D{numl=
ines=3D8,pagenum=3D12=3D0x0c,lines=3D{1=3D"they can give.",2=3D"",3=3D"Last=
 we want to add",4=3D"the following rules:",5=3D"Bugusing is not allowed",6=
=3D"and won't be tolerated.",7=3D"If thy find a bug,",8=3D"",},},13=3D{numl=
ines=3D8,pagenum=3D13=3D0x0d,lines=3D{1=3D"make sure to report",2=3D"it as =
soon as possible",3=3D"to us. Bugusing will be",4=3D"punished with a ban.",=
5=3D"We'd like to add something",6=3D"to the choice of your name:",7=3D"dis=
criminatory or",8=3D"",},},14=3D{numlines=3D8,pagenum=3D14=3D0x0e,lines=3D{=
1=3D"racialist names,",2=3D"as well as names ",3=3D"from the third reich ",=
4=3D"will be deleted immediately",5=3D"and be banned.",6=3D"",7=3D"",8=3D""=
,},},15=3D{numlines=3D8,pagenum=3D15=3D0x0f,lines=3D{1=3D"",2=3D"",3=3D"",4=
=3D"",5=3D"Signed:",6=3D"The staff of",7=3D"Vetus Mundus",8=3D"",},},},}
-	=

 	=

 	=

 	=

@@ -93,9 +90,63 @@
 	end
 	=

 	if (book.dialog and book.dialog:IsAlive()) then book.dialog:Destroy() end
-	print("#### book : ",text)
-	--~ book.dialog =3D  TODOOOOO
+	--~ print("#### book : ",text)
+	book.plaintext =3D text
+	book.dialog =3D GetDesktopWidget():CreateChild("UOBookDialog",book)
 end
 =

--- UOBookDialog
+-- ***** ***** ***** ***** ***** UOBookDialog widget
 =

+function UOBookTest ()
+	Load_Font() -- iris specific
+	local book =3D {}
+	book.header =3D {author=3D"Staff of Vetus-Mundus",authorlen=3D22,title=3D=
"a small introduction",unknown=3D1,numpages=3D15,writable=3D0,serial=3D0x40=
40c1ce,titlelen=3D21,}
+	book.pagedata =3D {numpages=3D15,serial=3D0x4040c1ce,pages=3D{
+		{numlines=3D8,pagenum=3D1,lines=3D{"We welcome thee","traveler","","we'r=
e glad to see","thy journey led","thee to Vetus Mundus","The gods of this",=
"",},},
+		{numlines=3D8,pagenum=3D2,lines=3D{"world will not bother","with much ru=
les,","nonetheless","there's something to","follow here.","Rules are as lis=
tened:","'One can do whatever","",},},
+		{numlines=3D8,pagenum=3D3,lines=3D{"provides fun. Note,","that PvP is on=
ly","possible on the facette","called felucca.","The second rule is:","'We =
all treat each other","with respect', the gods","",},},
+		{numlines=3D8,pagenum=3D4,lines=3D{"don't wish to hear","excessive slang=
, nor","any indignities","from the mortal","or speaking to","oneself. Dost =
you wish","to live peacefully","",},},
+		{numlines=3D8,pagenum=3D5,lines=3D{"here on Vetus Mundus, ","it's indisp=
ensable","to follow this rule.","","To make thy beginning","as comfortable =
as possible,","we will grant thee some","",},},
+		{numlines=3D8,pagenum=3D6,lines=3D{"commands. Listen carefully.","To com=
municate with other","mortal in the public","Channel, one has to use","the =
following","Combination:",".c (thy message)","",},},
+		{numlines=3D8,pagenum=3D7,lines=3D{"This will refer thy","message to the=
","public channel.","One can use:",".pm (name)(message)","to send a","priva=
te message to","",},},
+		{numlines=3D8,pagenum=3D8,lines=3D{"another mortal,","which only can be =
read","by him or her. It","will arrive him or her","even if he or she is","=
not in our world","at the moment. It will","",},},
+		{numlines=3D8,pagenum=3D9,lines=3D{"be sent to him or her","as soon as h=
e visits","our world the next time.","If thee can gather the","pleasure to =
join a guild","someday, thee can send ","them a message with the","",},},
+		{numlines=3D8,pagenum=3D10,lines=3D{"following command:",".g (message)."=
,"This message can only","be read by thy","guildmates.","There are several =
other","commands availabe,","",},},
+		{numlines=3D8,pagenum=3D11,lines=3D{"which can be shown by","typing .hel=
p.","If thee has any further.","questions, don't hesitate","to ask our gods=
,","as they surely will","grant you as much help","",},},
+		{numlines=3D8,pagenum=3D12,lines=3D{"they can give.","","Last we want to=
 add","the following rules:","Bugusing is not allowed","and won't be tolera=
ted.","If thy find a bug,","",},},
+		{numlines=3D8,pagenum=3D13,lines=3D{"make sure to report","it as soon as=
 possible","to us. Bugusing will be","punished with a ban.","We'd like to a=
dd something","to the choice of your name:","discriminatory or","",},},
+		{numlines=3D8,pagenum=3D14,lines=3D{"racialist names,","as well as names=
 ","from the third reich ","will be deleted immediately","and be banned.","=
","","",},},
+		{numlines=3D8,pagenum=3D15,lines=3D{"","","","","Signed:","The staff of"=
,"Vetus Mundus","",},},
+		},}                                   =

+	--~ print("######",SmartDump(book,4))
+	UpdateBookDialog(book) =

+end
+										=

+function gWidgetPrototype.UOBookDialog:Init (parentwidget,params)
+	local bVertexBufferDynamic,bVertexCol =3D false,true
+	=

+	local bw,bh =3D 200,100
+	local texname,w,h,xoff,yoff =3D "simplebutton.png",bw,bh,0,0
+	local u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy =3D 0,0, 4,8,4, 4,8,4, 32,32
+	params.gfxparam_init =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTe=
xtureGUIMat(texname),w,h,xoff,yoff, u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy, 1,1, =
false, false)
+
+	self:InitAsSpritePanel(parentwidget,params,bVertexBufferDynamic,bVertexCo=
l)
+	=

+	--~ local txt =3D self:CreateChild("UOHuePickerButton",{x=3Dx*10,y=3Dy*10=
,hue=3Dhue,gfxparam_init=3Dgfxparam_init})
+	=

+	self.maintext =3D self:CreateChild("UOText",{x=3D0,y=3D0,text=3Dparams.pl=
aintext,col=3D{r=3D0,g=3D0,b=3D0},bold=3Dfalse})
+	--~ self.gfx_maintarget_line =3D gRootWidget.tooltip:CreateChild("LineLis=
t",{matname=3D"BaseWhiteNoLighting",bDynamic=3Dtrue,r=3D1,g=3D0,b=3D0})
+	=

+	local e =3D 4
+	local l,t,r,b =3D self.maintext:GetRelBounds()
+	params.gfxparam_init.w =3D e+e+r-l
+	params.gfxparam_init.h =3D e+e+b-t
+	params.gfxparam_init.xoff =3D l-e
+	params.gfxparam_init.yoff =3D t-e
+	self.spritepanel:Update(params.gfxparam_init) -- adjust base geometry
+	=

+	self:SetPos(200,100)
+end
+
+function gWidgetPrototype.UOBookDialog:on_mouse_left_down	() self:BringToF=
ront() self:StartMouseMove() end
+function gWidgetPrototype.UOBookDialog:on_mouse_right_down	() self:Destroy=
() end



From no-reply at zwischenwelt.org  Mon Nov 24 14:34:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 24 Nov 2008 13:34:38 -0000
Subject: [Iris-commit] [IRIS] r2749 - in /trunk: lua/gui/gui.healthbar.lua
 lua/lib.macrolist.lua lua/lib.mousepick.lua lua/lib.namegumps.lua
 lua/lib.uotooltip.lua lua/main.lua lua/widgets/widget.uotooltip.lua
 plugins/itemcounter.lua plugins/moblist.lua
Message-ID: <20081124133438.A5C7D1C187E4@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 24 14:34:37 2008
New Revision: 2749

Log:
ctrl+shift : namegumps, +alt:only corpses,  drag=3Dhealthbar, moblist : alt=
-drag=3Dhealthbar,  tooltip item amount fix, new macro : MacroCmd_DragDrop

Added:
    trunk/lua/lib.namegumps.lua
Modified:
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/lib.uotooltip.lua
    trunk/lua/main.lua
    trunk/lua/widgets/widget.uotooltip.lua
    trunk/plugins/itemcounter.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/gui/gui.healthbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.healthbar.lua (original)
+++ trunk/lua/gui/gui.healthbar.lua Mon Nov 24 14:34:37 2008
@@ -101,7 +101,7 @@
 function OpenHealthbarAtMouse (mobile)
 	local iMouseX,iMouseY =3D GetMousePos()
 	-- -50,-30 to place the dialog beneath the mouse
-	OpenHealthbar(mobile,iMouseX - 50,iMouseY - 30)
+	return OpenHealthbar(mobile,iMouseX - 50,iMouseY - 30)
 end
 =

 =

@@ -140,7 +140,7 @@
 	end
 	=

 	local d =3D gHealthbarDialogs[mobile.serial]
-	if (d) then d:SetPos(x, y) return end -- already open, only update positi=
on
+	if (d) then d:SetPos(x, y) return d end -- already open, only update posi=
tion
 	=

 	local dialog =3D GumpParser( IsPlayerMobile(mobile) and healthbarGump or =
npchealthGump, true )
 	gHealthbarDialogs[mobile.serial] =3D dialog
@@ -181,6 +181,7 @@
 	if IsPlayerMobile(mobile) then HealthBarSetWarMode() end	=

 	=

 	NotifyListener("Hook_OpenHealthbar",dialog, mobile.serial)
+	return dialog
 end
 =

 -- create player Healthbar dialog and stuff like this

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Nov 24 14:34:37 2008
@@ -373,6 +373,11 @@
 function MacroCmd_Item_FindFirstByArtID	(artid,hue,container) local list =
=3D MacroCmd_Item_FindByArtID(artid,hue,container) return list[1] end
 function MacroCmd_Item_FindFirstNearByArtID	(artid,hue,dist) local list =
=3D MacroCmd_Item_FindNearByArtID(artid,hue,dist) return list[1] end
 =

+function MacroCmd_DragDrop (takeserial,amount,dropcontainerserial) =

+	Send_Take_Object(takeserial,amount)
+	Send_Drop_Object_AutoStack(takeserial,dropcontainerserial or GetPlayerBac=
kPackSerial())
+end
+
 -- doesn't sum stack-amount
 function MacroCmd_Item_CountByArtID	(artid,hue,container) local list =3D M=
acroCmd_Item_FindByArtID(artid,hue,container) return list and #list or 0 end
 function MacroCmd_Item_SumByArtID	(artid,hue,container) -- does sum stack
@@ -411,6 +416,7 @@
 -- container defaults to player-backpack
 -- hue can be nil for any
 function MacroCmd_Item_FindByArtID	(artid,hue,container) -- equals easyuo =
type
+	if (type(container) =3D=3D "number") then container =3D GetContainer(cont=
ainer) end -- resolve serial
 	container =3D container or GetPlayerBackPackContainer()
 	if (not container) then return end
 	local res =3D {}

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Mon Nov 24 14:34:37 2008
@@ -46,16 +46,26 @@
 	local widget =3D GetWidgetUnderMouse()
 	if (widget) then =

 		--~ print("MousePick_GUI",widget,widget.uoContainer,widget.item,widget.G=
etClassName and widget:GetClassName())
-		if (widget.uoContainer and widget.item) then
-			gMousePickFoundHit =3D {}
-			gMousePickFoundHit.hittype =3D kMousePickHitType_ContainerItem
-			gMousePickFoundHit.item =3D widget.item
-			gMousePickFoundHit.is2DHit =3D true
-		elseif (widget.uoPaperdoll and widget.item) then
-			gMousePickFoundHit =3D {}
-			gMousePickFoundHit.hittype =3D kMousePickHitType_PaperdollItem
-			gMousePickFoundHit.item =3D widget.item
-			gMousePickFoundHit.is2DHit =3D true
+		if (widget.item) then
+			if (widget.uoPaperdoll) then
+				gMousePickFoundHit =3D {}
+				gMousePickFoundHit.hittype =3D kMousePickHitType_PaperdollItem
+				gMousePickFoundHit.item =3D widget.item
+				gMousePickFoundHit.is2DHit =3D true
+			elseif (widget.uoContainer) then
+				gMousePickFoundHit =3D {}
+				gMousePickFoundHit.hittype =3D kMousePickHitType_ContainerItem
+				gMousePickFoundHit.item =3D widget.item
+				gMousePickFoundHit.is2DHit =3D true
+			else -- for namegumps(ctrl+shift)
+				gMousePickFoundHit =3D {}
+				gMousePickFoundHit.hittype =3D kMousePickHitType_Dynamic
+				gMousePickFoundHit.dynamic =3D widget.item
+				gMousePickFoundHit.hit_xloc =3D widget.item.xloc
+				gMousePickFoundHit.hit_yloc =3D widget.item.yloc
+				gMousePickFoundHit.hit_zloc =3D widget.item.zloc
+				gMousePickFoundHit.is2DHit =3D true
+			end
 		elseif widget.dialog and widget.dialog.uoContainer then
 			gMousePickFoundHit =3D {}
 			gMousePickFoundHit.hittype =3D kMousePickHitType_Container

Modified: trunk/lua/lib.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uotooltip.lua (original)
+++ trunk/lua/lib.uotooltip.lua Mon Nov 24 14:34:37 2008
@@ -54,6 +54,20 @@
 end
 =

 =

+function GetToolTipTextForSerial (serial) =

+	if (not serial) then return end
+	local item =3D GetDynamic(serial)
+	local res =3D GetItemTooltipOrLabel(serial)
+	if (not res) then =

+		local mobile =3D GetMobile(serial)
+		if (mobile) then return mobile.name end
+		if (item) then =

+			res =3D string.gsub(GetStaticTileTypeName(item.artid) or "","%%s%%",(it=
em.amount > 1) and "s" or "")
+		end
+	end
+	if (item and item.amount > 1 and (not IsCorpseArtID(item.artid))) then re=
s =3D item.amount .. " " .. res end
+	return res
+end
 =

 =

 =


Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Nov 24 14:34:37 2008
@@ -94,8 +94,9 @@
 dofile(libpath .. "lib.blendout.lua")
 dofile(libpath .. "lib.packetvideo.lua")
 dofile(libpath .. "lib.objectpicker.lua")
+dofile(libpath .. "lib.huepicker.lua") =

 dofile(libpath .. "lib.book.lua")
-dofile(libpath .. "lib.huepicker.lua") =

+dofile(libpath .. "lib.namegumps.lua") =

 dofile(libpath .. "lib.razormacro.lua")
 dofile(libpath .. "lib.razorconfig.lua")
 =

@@ -354,6 +355,7 @@
 		CollectOgreResLocs()
 	end
 	SetCursorBaseOffset(0,0)
+	if (MyArtDebug) then MyArtDebug() end
 	=

 	------------------------------------------ obsolete, just for testing ---=
--------------------------------
 	-- Lua test because Lua50 should not be compiled full-optimized with VS20=
05 Express (maybe also other compilers)

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Mon Nov 24 14:34:37 2008
@@ -65,27 +65,14 @@
 end
 =

 function gWidgetPrototype.UOToolTip:RefreshText ()
-	local tooltiptext =3D self.params.text
 	local serial =3D self.params.serial
-	if (serial) then =

-		tooltiptext =3D GetItemTooltipOrLabel(serial)
-		if (not tooltiptext) then
-			local mobile =3D GetMobile(serial)
-			if (mobile) then =

-				tooltiptext =3D mobile.name =

-			else
-				local item =3D GetDynamic(serial)
-				local artid =3D item and item.artid
-				if (artid) then =

-					tooltiptext =3D string.gsub(GetStaticTileTypeName(artid) or "","%%s%%=
",(item.amount > 1) and "s" or "") =

-					if (item.amount > 1 and (not IsCorpseArtID(item.artid))) then tooltip=
text =3D item.amount .. " " .. tooltiptext end
-				end
-			end
-		end
-	end
-	if (not tooltiptext) then tooltiptext =3D "???" end
+	local tooltiptext =3D self.params.text or GetToolTipTextForSerial(serial)=
 or "???"
 	=

-	tooltiptext =3D "<BASEFONT COLOR=3D#FFFF00>"..string.gsub(tooltiptext,"\n=
","</BASEFONT>\n",1)
+	local mobile =3D serial and GetMobile(serial)
+	local r,g,b =3D 1,1,0
+	if (mobile) then r,g,b =3D GetNotorietyColor(mobile.notoriety) end
+	=

+	tooltiptext =3D sprintf("<BASEFONT COLOR=3D#%02X%02X%02X>",floor(r*255),f=
loor(g*255),floor(b*255))..string.gsub(tooltiptext,"\n","</BASEFONT>\n",1)
 	tooltiptext =3D string.gsub(tooltiptext,"<b>Insured</b>","<b><BASEFONT CO=
LOR=3D#00FF00>Insured</BASEFONT></b>")
 	tooltiptext =3D string.gsub(tooltiptext,"durability (%d+) / (%d+)",ToolTi=
pColDura)
 	=


Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Mon Nov 24 14:34:37 2008
@@ -9,24 +9,24 @@
 kItemCounterLowAmount =3D 10
 kItemCounterBagType =3D 0xe76
 gItemCounterTypes 				=3D {
-	{name=3Dblackperl		,artid=3D0xf7a},
-	{name=3Dbloodmoss		,artid=3D0xf7b}, =

-	{name=3Dmandrake		,artid=3D0xf86},
-	{name=3Dgarlic		,artid=3D0xf84},
-	{name=3Dginseng		,artid=3D0xf85},
-	{name=3Dnightshade	,artid=3D0xf88},
-	{name=3Dspidersilk	,artid=3D0xf8d},    =

-	{name=3Dsulfurusash	,artid=3D0xf8c},  =

+	{name=3D"blackperl"	,artid=3D0xf7a},
+	{name=3D"bloodmoss"	,artid=3D0xf7b}, =

+	{name=3D"mandrake"	,artid=3D0xf86},
+	{name=3D"garlic"		,artid=3D0xf84},
+	{name=3D"ginseng"		,artid=3D0xf85},
+	{name=3D"nightshade"	,artid=3D0xf88},
+	{name=3D"spidersilk"	,artid=3D0xf8d},    =

+	{name=3D"sulfurusash"	,artid=3D0xf8c},  =

 									 =

-	{name=3Dgheal			,artid=3D3852},
-	{name=3Dgcure			,artid=3D3847},
-	{name=3Drefresh		,artid=3D3851},
-	{name=3Dexplo			,artid=3D3853},
+	{name=3D"gheal"		,artid=3D3852},
+	{name=3D"gcure"		,artid=3D3847},
+	{name=3D"refresh"		,artid=3D3851},
+	{name=3D"explo"		,artid=3D3853},
 	=

-	{name=3Dgold			,artid=3D0xeef},
-	{name=3Dbandas		,artid=3D0xe21},
-	{name=3Darrows		,artid=3D3903},
-	}
+	{name=3D"gold"		,artid=3D0xeef},
+	{name=3D"bandas"		,artid=3D0xe21},
+	{name=3D"arrows"		,artid=3D3903},
+	}     =

                                                   =

 gItemCounterTypesByArtID 	=3D {}
 for k,v in pairs(gItemCounterTypes) do gItemCounterTypesByArtID[v.artid] =
=3D true end

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Mon Nov 24 14:34:37 2008
@@ -265,6 +265,13 @@
 =

 function MobListShortenName (text) return UOShortenName(text) end
 =

+function gWidgetPrototype.UOMobListItem:on_mouse_left_drag_start	() =

+	if (self.mobile and gKeyPressed[key_lalt]) then =

+		local widget =3D OpenHealthbarAtMouse(self.mobile) =

+		if (widget) then widget:BringToFront() widget:StartMouseMove() end
+	end
+end
+
 function gWidgetPrototype.UOMobListItem:UpdateName(name,clilocid)
 	if (name and (not self.lowname)) then self.lowname =3D name self.nameclil=
oc =3D clilocid end
 	local tooltip =3D GetItemTooltipOrLabel(self.serial)



From no-reply at zwischenwelt.org  Mon Nov 24 21:02:17 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 24 Nov 2008 20:02:17 -0000
Subject: [Iris-commit] [IRIS] r2750 - in /trunk: lua/lib.namegumps.lua
 lua/lib.spellbooks.lua lua/lib.uoids.lua
 lua/widgets/widget.uopaperdollitem.lua plugins/itemcounter.lua
 plugins/lib.spellbar.lua
Message-ID: <20081124200217.A95431C187E4@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 24 21:02:16 2008
New Revision: 2750

Log:
spellbar interrupt detection improved, namegump:uohtml parsing activated (c=
olored:game master in tooltip), paperdoll gump fallback to cloak (arcane cl=
oak gfx was broken and unclickable)

Modified:
    trunk/lua/lib.namegumps.lua
    trunk/lua/lib.spellbooks.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/widgets/widget.uopaperdollitem.lua
    trunk/plugins/itemcounter.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.namegumps.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.namegumps.lua (original)
+++ trunk/lua/lib.namegumps.lua Mon Nov 24 21:02:16 2008
@@ -71,7 +71,7 @@
 	=

 	--~ local txt =3D self:CreateChild("UOHuePickerButton",{x=3Dx*10,y=3Dy*10=
,hue=3Dhue,gfxparam_init=3Dgfxparam_init})
 	=

-	self.maintext =3D self:CreateChild("UOText",{x=3D0,y=3D0,text=3Dplaintext=
,col=3D{r=3D0,g=3D0,b=3D0},bold=3Dfalse})
+	self.maintext =3D self:CreateChild("UOText",{x=3D0,y=3D0,text=3Dplaintext=
,col=3D{r=3D0,g=3D0,b=3D0},html=3Dtrue,bold=3Dfalse})
 	--~ self.gfx_maintarget_line =3D gRootWidget.tooltip:CreateChild("LineLis=
t",{matname=3D"BaseWhiteNoLighting",bDynamic=3Dtrue,r=3D1,g=3D0,b=3D0})
 	=

 	local e =3D 2

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Mon Nov 24 21:02:16 2008
@@ -419,7 +419,17 @@
 	return GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Protection(),Is=
BuffActive_EssenceOfWind())
 end
 =

-gSpellInterruptMessages =3D { [500946 ]=3Dtrue,[502632 ]=3Dtrue,[500641 ]=
=3Dtrue,[502625 ]=3Dtrue,[1049645]=3Dtrue, } -- notintown,fizz,disturbed,no=
mana,toomanyfollowers
+gSpellInterruptMessages =3D {}
+gSpellInterruptMessages[500946 ] =3D true -- You cannot cast this in town!=
							=

+gSpellInterruptMessages[502632 ] =3D true -- The spell fizzles.										=

+gSpellInterruptMessages[500641 ] =3D true -- Your concentration is disturb=
ed, thus ruining thy spell.	=

+gSpellInterruptMessages[502625 ] =3D true -- Insufficient mana for this sp=
ell.						=

+gSpellInterruptMessages[1049645] =3D true -- You have too many followers t=
o summon that creature.  	   =

+gSpellInterruptMessages[500015 ] =3D true -- You do not have that spell!
+gSpellInterruptMessages[502630 ] =3D true -- More reagents are needed for =
this spell.
+gSpellInterruptMessages[502644 ] =3D true -- You have not yet recovered fr=
om casting a spell.
+gSpellInterruptMessages[1061091] =3D true -- You cannot cast that spell in=
 this form.    =

+
 RegisterListener("Hook_Packet_Localized_Text",function (serial,plaintext,t=
ext_messagenum) =

 	if (gSpellInterruptMessages[text_messagenum]) then NotifyListener("Hook_S=
pell_Interrupt",serial,plaintext,text_messagenum) end
 end)

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Mon Nov 24 21:02:16 2008
@@ -128,69 +128,74 @@
 =

 -- Paperdoll Layer
 gLayerType =3D {}
-gLayerType.kLayer_OneHanded 		=3D hex2num("0x01") -- weapon
-gLayerType.kLayer_TwoHanded 		=3D hex2num("0x02") -- weapon , shield, or m=
isc.	=

-gLayerType.kLayer_Shoes				=3D hex2num("0x03")
-gLayerType.kLayer_Pants				=3D hex2num("0x04")
-gLayerType.kLayer_Shirt				=3D hex2num("0x05")
-gLayerType.kLayer_Helm				=3D hex2num("0x06") -- or Hat
-gLayerType.kLayer_Gloves			=3D hex2num("0x07")
-gLayerType.kLayer_Ring				=3D hex2num("0x08")
-gLayerType.kLayer_Unused			=3D hex2num("0x09")
-gLayerType.kLayer_Neck				=3D hex2num("0x0A")
-gLayerType.kLayer_Hair				=3D hex2num("0x0B")
-gLayerType.kLayer_Waist 			=3D hex2num("0x0C") -- (half apron)
-gLayerType.kLayer_TorsoInner 		=3D hex2num("0x0D") -- (inner) (chest armor=
)		=

-gLayerType.kLayer_Bracelet			=3D hex2num("0x0E")
-gLayerType.kLayer_Unused			=3D hex2num("0x0F") --  (backpack, but backpack=
s go to 0x15)		=

-gLayerType.kLayer_FacialHair		=3D hex2num("0x10")
-gLayerType.kLayer_TorsoMiddle		=3D hex2num("0x11") --  (middle) (sircoat, =
tunic, full apron, sash)			=

-gLayerType.kLayer_Earrings			=3D hex2num("0x12")
-gLayerType.kLayer_Arms				=3D hex2num("0x13")
-gLayerType.kLayer_Back 				=3D hex2num("0x14") -- (cloak)
-gLayerType.kLayer_Backpack			=3D hex2num("0x15")
-gLayerType.kLayer_TorsoOuter		=3D hex2num("0x16") -- (outer) (robe)
-gLayerType.kLayer_LegsOuter			=3D hex2num("0x17") -- (outer) (skirt/kilt)
-gLayerType.kLayer_LegsInner			=3D hex2num("0x18") -- (inner) (leg armor)
-gLayerType.kLayer_Mount 			=3D hex2num("0x19") -- (horse, ostard, etc)	=

-gLayerType.kLayer_NPCBuyRestock 	=3D hex2num("0x1A") -- container	=

-gLayerType.kLayer_NPCBuyNoRestock 	=3D hex2num("0x1B") -- container	=

-gLayerType.kLayer_NPCSellContainer	=3D hex2num("0x1C")
-gLayerType.kLayer_PCBankBox 		=3D hex2num("0x1D")
+gLayerType.kLayer_OneHanded 		=3D 0x01 -- weapon
+gLayerType.kLayer_TwoHanded 		=3D 0x02 -- weapon , shield, or misc.	=

+gLayerType.kLayer_Shoes				=3D 0x03
+gLayerType.kLayer_Pants				=3D 0x04
+gLayerType.kLayer_Shirt				=3D 0x05
+gLayerType.kLayer_Helm				=3D 0x06 -- or Hat
+gLayerType.kLayer_Gloves			=3D 0x07
+gLayerType.kLayer_Ring				=3D 0x08
+gLayerType.kLayer_Unused			=3D 0x09
+gLayerType.kLayer_Neck				=3D 0x0A
+gLayerType.kLayer_Hair				=3D 0x0B
+gLayerType.kLayer_Waist 			=3D 0x0C -- (half apron)
+gLayerType.kLayer_TorsoInner 		=3D 0x0D -- (inner) (chest armor)		=

+gLayerType.kLayer_Bracelet			=3D 0x0E
+gLayerType.kLayer_Unused			=3D 0x0F --  (backpack, but backpacks go to 0x1=
5)		=

+gLayerType.kLayer_FacialHair		=3D 0x10
+gLayerType.kLayer_TorsoMiddle		=3D 0x11 --  (middle) (sircoat, tunic, full=
 apron, sash)			=

+gLayerType.kLayer_Earrings			=3D 0x12
+gLayerType.kLayer_Arms				=3D 0x13
+gLayerType.kLayer_Back 				=3D 0x14 -- (cloak)
+gLayerType.kLayer_Backpack			=3D 0x15
+gLayerType.kLayer_TorsoOuter		=3D 0x16 -- (outer) (robe)
+gLayerType.kLayer_LegsOuter			=3D 0x17 -- (outer) (skirt/kilt)
+gLayerType.kLayer_LegsInner			=3D 0x18 -- (inner) (leg armor)
+gLayerType.kLayer_Mount 			=3D 0x19 -- (horse, ostard, etc)	=

+gLayerType.kLayer_NPCBuyRestock 	=3D 0x1A -- container	=

+gLayerType.kLayer_NPCBuyNoRestock 	=3D 0x1B -- container	=

+gLayerType.kLayer_NPCSellContainer	=3D 0x1C
+gLayerType.kLayer_PCBankBox 		=3D 0x1D
 for k,v in pairs(gLayerType) do _G[k] =3D v end -- make names available as=
 global constants
 gLayerTypeName =3D {}
 for k,v in pairs(gLayerType) do gLayerTypeName[v] =3D k end -- make names =
available as global constants
 =

+gPaperdollFallbackGfx =3D {}
+gPaperdollFallbackGfx[kLayer_Back] =3D 0x1515 -- fallback : normal cloak f=
or broken arcane cloak
+kPaperdollFallbackLast =3D 0x1515 -- robe
+
+
 gPaperdollBlockingLayers =3D {
 	[kLayer_TorsoOuter] =3D {kLayer_Arms,kLayer_TorsoInner} -- kLayer_Helm, =

 }
 =

 -- WARNING ! this is not a complete list (see gLayerType for that) , e.g. =
kLayer_Mound =3D 0x19 is not in here
 gLayerOrder =3D {
-	hex2num("0x09"),					   -- - N/A (not used)
-    hex2num("0x14"),                       -- - Back (Cloak)
-    hex2num("0x10"),                       -- - Facial Hair
-    hex2num("0x12"),                       -- - Earrings
-    hex2num("0x04"),                       -- - Leg Covering (including Pa=
nts"), Shorts"), Bone/Chain/Ring legs)
-    hex2num("0x0E"),                       -- - Bracelet
-    hex2num("0x03"),                       -- - Foot Covering/Armor
-    hex2num("0x08"),                       -- - Ring
-    hex2num("0x18"),                       -- - Legs (inner)(Leg Armor)
-    hex2num("0x05"),                       -- - Chest Clothing/Female Ches=
t Armor
-    hex2num("0x0D"),                       -- - Torso (inner)(Chest Armor)
-    hex2num("0x11"),                       -- - Torso (Middle)(Surcoat"), =
Tunic"), Full Apron"), Sash)
-    hex2num("0x0A"),                       -- - Neck Covering/Armor
-    hex2num("0x13"),                       -- - Arm Covering/Armor
-    hex2num("0x07"),                       -- - Hand Covering/Armor
-    hex2num("0x17"),                       -- - Legs (outer)(Skirt/Kilt)
-    hex2num("0x0B"),                       -- - Hair
-    hex2num("0x06"),                       -- - Head Covering/Armor
-    hex2num("0x16"),                       -- - Torso (outer)(Robe) =

-    hex2num("0x0C"),                       -- - Waist (Half-Apron)
-    hex2num("0x01"),                       -- - Single-Hand item/weapon
-    hex2num("0x02"),                       -- - Two-Hand item/weapon (incl=
uding Shield)
-    hex2num("0x15"),                       -- - BackPack
-    hex2num("0x0F")
+	0x09,					   -- - N/A (not used)
+    0x14,                       -- - Back (Cloak)
+    0x10,                       -- - Facial Hair
+    0x12,                       -- - Earrings
+    0x04,                       -- - Leg Covering (including Pants"), Shor=
ts"), Bone/Chain/Ring legs)
+    0x0E,                       -- - Bracelet
+    0x03,                       -- - Foot Covering/Armor
+    0x08,                       -- - Ring
+    0x18,                       -- - Legs (inner)(Leg Armor)
+    0x05,                       -- - Chest Clothing/Female Chest Armor
+    0x0D,                       -- - Torso (inner)(Chest Armor)
+    0x11,                       -- - Torso (Middle)(Surcoat"), Tunic"), Fu=
ll Apron"), Sash)
+    0x0A,                       -- - Neck Covering/Armor
+    0x13,                       -- - Arm Covering/Armor
+    0x07,                       -- - Hand Covering/Armor
+    0x17,                       -- - Legs (outer)(Skirt/Kilt)
+    0x0B,                       -- - Hair
+    0x06,                       -- - Head Covering/Armor
+    0x16,                       -- - Torso (outer)(Robe) =

+    0x0C,                       -- - Waist (Half-Apron)
+    0x01,                       -- - Single-Hand item/weapon
+    0x02,                       -- - Two-Hand item/weapon (including Shiel=
d)
+    0x15,                       -- - BackPack
+    0x0F
 }
 =

 -- you can add a paperdoll layer here with a position to overwrite the pos=
ition in paperdoll (centered)

Modified: trunk/lua/widgets/widget.uopaperdollitem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uopaperdollitem.lua (original)
+++ trunk/lua/widgets/widget.uopaperdollitem.lua Mon Nov 24 21:02:16 2008
@@ -20,7 +20,16 @@
 	local imageparams =3D {x=3D0,y=3D0,hue=3Ditem.hue}
 	self.uoPaperdoll	=3D params.paperdoll
 	=

-	imageparams.gump_id =3D (not params.useart) and GetPaperdollItemGumpID(it=
em.artid,base_id)
+	local artid =3D item.artid
+	imageparams.gump_id =3D (not params.useart) and GetPaperdollItemGumpID(ar=
tid,base_id)
+	if (imageparams.gump_id and (not PreLoadGump(imageparams.gump_id,item.hue=
))) then =

+		local layer =3D GetPaperdollLayerFromTileType(artid) or 0
+		local fallbackartid =3D gPaperdollFallbackGfx[layer] or kPaperdollFallba=
ckLast
+		print("warning:paperdoll gump load failed layer,orig,fallback=3D",layer,=
artid,fallbackartid)
+		if (fallbackartid) then imageparams.gump_id =3D GetPaperdollItemGumpID(f=
allbackartid,base_id) end
+	end
+	=

+	=

 	if (not imageparams.gump_id) then =

 		imageparams.art_id =3D item.artid -- fallback and sidebar (jewelry,helme=
t,gorget)
 		--~ local art_atlas_piece =3D PreLoadArt(item.artid + 0x4000)

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Mon Nov 24 21:02:16 2008
@@ -8,28 +8,36 @@
 =

 kItemCounterLowAmount =3D 10
 kItemCounterBagType =3D 0xe76
-gItemCounterTypes 				=3D {
-	{name=3D"blackperl"	,artid=3D0xf7a},
-	{name=3D"bloodmoss"	,artid=3D0xf7b}, =

-	{name=3D"mandrake"	,artid=3D0xf86},
-	{name=3D"garlic"		,artid=3D0xf84},
-	{name=3D"ginseng"		,artid=3D0xf85},
-	{name=3D"nightshade"	,artid=3D0xf88},
-	{name=3D"spidersilk"	,artid=3D0xf8d},    =

-	{name=3D"sulfurusash"	,artid=3D0xf8c},  =

-									 =

-	{name=3D"gheal"		,artid=3D3852},
-	{name=3D"gcure"		,artid=3D3847},
-	{name=3D"refresh"		,artid=3D3851},
-	{name=3D"explo"		,artid=3D3853},
-	=

-	{name=3D"gold"		,artid=3D0xeef},
-	{name=3D"bandas"		,artid=3D0xe21},
-	{name=3D"arrows"		,artid=3D3903},
-	}     =

-                                                  =

-gItemCounterTypesByArtID 	=3D {}
-for k,v in pairs(gItemCounterTypes) do gItemCounterTypesByArtID[v.artid] =
=3D true end
+
+function InitItemCounterTypes () =

+	gItemCounterTypes =3D {}
+	table.insert(gItemCounterTypes,{name=3D"blackperl"	,artid=3D0xf7a})
+	table.insert(gItemCounterTypes,{name=3D"bloodmoss"	,artid=3D0xf7b}) =

+	table.insert(gItemCounterTypes,{name=3D"mandrake"		,artid=3D0xf86})
+	table.insert(gItemCounterTypes,{name=3D"garlic"		,artid=3D0xf84})
+	table.insert(gItemCounterTypes,{name=3D"ginseng"		,artid=3D0xf85})
+	table.insert(gItemCounterTypes,{name=3D"nightshade"	,artid=3D0xf88})
+	table.insert(gItemCounterTypes,{name=3D"spidersilk"	,artid=3D0xf8d})    =

+	table.insert(gItemCounterTypes,{name=3D"sulfurusash"	,artid=3D0xf8c})  =

+
+	table.insert(gItemCounterTypes,{name=3D"pigiron"		,artid=3D0xf8a})
+	table.insert(gItemCounterTypes,{name=3D"noxcrystal"	,artid=3D0xf8e})
+	table.insert(gItemCounterTypes,{name=3D"demonblood"	,artid=3D0xf7d})
+	table.insert(gItemCounterTypes,{name=3D"gravedust"	,artid=3D0xf8f})
+	table.insert(gItemCounterTypes,{name=3D"batwing"		,artid=3D0xf78})
+								 =

+	table.insert(gItemCounterTypes,{name=3D"gheal"		,artid=3D3852})
+	table.insert(gItemCounterTypes,{name=3D"gcure"		,artid=3D3847})
+	table.insert(gItemCounterTypes,{name=3D"refresh"		,artid=3D3851})
+	table.insert(gItemCounterTypes,{name=3D"explo"		,artid=3D3853})
+
+	table.insert(gItemCounterTypes,{name=3D"gold"			,artid=3D0xeef})
+	table.insert(gItemCounterTypes,{name=3D"bandas"		,artid=3D0xe21})
+	table.insert(gItemCounterTypes,{name=3D"arrows"		,artid=3D3903})
+	gItemCounterTypesByArtID 	=3D {}
+	for k,v in pairs(gItemCounterTypes) do gItemCounterTypesByArtID[v.artid] =
=3D true end
+end
+InitItemCounterTypes()
 =

 function ItemCounterOne (artid,baglist) =

 	local c =3D MacroCmd_Item_SumByArtID(artid) =

@@ -38,9 +46,9 @@
 end
 =

 -- dynamicdata.iContainerSerial
-RegisterListener("Mobile_UpdateStats", function (mobile) if (IsPlayerMobil=
e(mobile)) then gItemCounterNeedsUpdate =3D true end end)
-RegisterListener("Dynamic_Update", function (item) if (gItemCounterTypesBy=
ArtID[item.artid]) then gItemCounterNeedsUpdate =3D true end end)
-RegisterListener("Dynamic_Destroy", function (item) if (gItemCounterTypesB=
yArtID[item.artid]) then gItemCounterNeedsUpdate =3D true end end)
+RegisterListener("Mobile_UpdateStats",	function (mobile) if (IsPlayerMobil=
e(mobile)) then gItemCounterNeedsUpdate =3D true end end)
+RegisterListener("Dynamic_Update",		function (item) if (gItemCounterTypesB=
yArtID[item.artid]) then gItemCounterNeedsUpdate =3D true end end)
+RegisterListener("Dynamic_Destroy",		function (item) if (gItemCounterTypes=
ByArtID[item.artid]) then gItemCounterNeedsUpdate =3D true end end)
 RegisterStepper(function () if (gItemCounterNeedsUpdate) then ItemCounterU=
pdate() end end)
 -- item:IsInContainer(GetPlayerBackPackSerial())
 =


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Mon Nov 24 21:02:16 2008
@@ -146,7 +146,11 @@
 gSpellbarShortMessages[1049645] =3D {r=3D1,g=3D0,b=3D0,txt=3D"too many fol=
lowers"	,bInterrupt=3Dtrue} -- You have too many followers to summon that c=
reature.  	   =

 gSpellbarShortMessages[500015 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"don't have s=
pell"	,bInterrupt=3Dtrue} -- You do not have that spell!
 gSpellbarShortMessages[502630 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"regs"				,bI=
nterrupt=3Dtrue} -- More reagents are needed for this spell.
-
+gSpellbarShortMessages[502644 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"recover"			,=
bInterrupt=3Dtrue} -- You have not yet recovered from casting a spell.
+gSpellbarShortMessages[1061091 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"form"				,b=
Interrupt=3Dtrue} -- You cannot cast that spell in this form.
+gSpellbarShortMessages[1061605 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already"			=
,bInterrupt=3Dtrue} -- You already have a familiar.
+
+for k,v in pairs(gSpellbarShortMessages) do if (v.bInterrupt) then gSpellI=
nterruptMessages[k] =3D true end end
 =

 -- weapon specials
 gSpellbarShortMessages[1060163] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"PARABL=
OW"			}--~ You deliver a paralyzing blow!  =

@@ -174,6 +178,8 @@
 gSpellbarShortMessages[1060757] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"bleeds=
tart" 		} -- You are bleeding profusely  (serial=3Dself=3D899675)
 gSpellbarShortMessages[1060167] =3D {r=3D0.0,g=3D0.5,b=3D0.0,txt=3D"bleeds=
top" 		} -- The bleeding wounds have healed, you are no longer bleeding!
 gSpellbarShortMessages[1042809] =3D {r=3D1,g=3D0.5,b=3D0.0,txt=3D"EscortDo=
ne"			} -- We have arrived! I thank thee, CHARNAME! I have no further need =
of thy services. Here is thy pay.
+
+
 =

 --[[
 =




From no-reply at zwischenwelt.org  Mon Nov 24 21:14:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 24 Nov 2008 20:14:53 -0000
Subject: [Iris-commit] [IRIS] r2751 - in /trunk: lua/lib.uodragdrop.lua
	plugins/itemcounter.lua
Message-ID: <20081124201454.020921C187E4@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Nov 24 21:14:53 2008
New Revision: 2751

Log:
itemcounter improved, necroregs, grouped, whole group blended out when no p=
art found

Modified:
    trunk/lua/lib.uodragdrop.lua
    trunk/plugins/itemcounter.lua

Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Mon Nov 24 21:14:53 2008
@@ -446,7 +446,7 @@
 		x,y,z =3D GetMouseHitTileCoords()
 		local iSerial =3D GetMouseHitSerial()
 		=

-		print("#####dragdrop,gMousePickFoundHit=3D",iSerial,SmartDump(gMousePick=
FoundHit))
+		--~ print("#####dragdrop,gMousePickFoundHit=3D",iSerial,SmartDump(gMouse=
PickFoundHit))
 		--~ #####dragdrop,gMousePickFoundHit=3D       {hit_zloc=3D35=3D0x23,dyna=
mic=3Dtable: 0x9d50c38,hittype=3D2,hit_xloc=3D3443=3D0x0d73,hit_yloc=3D2659=
=3D0x0a63,}
 =

 		-- uo-hack : don't send drop-container on dynamic floor tiles (yard wand=
 tool on vm), to allow puttin items on the floor (flags=3D0x201)

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Mon Nov 24 21:14:53 2008
@@ -9,35 +9,44 @@
 kItemCounterLowAmount =3D 10
 kItemCounterBagType =3D 0xe76
 =

-function InitItemCounterTypes () =

-	gItemCounterTypes =3D {}
-	table.insert(gItemCounterTypes,{name=3D"blackperl"	,artid=3D0xf7a})
-	table.insert(gItemCounterTypes,{name=3D"bloodmoss"	,artid=3D0xf7b}) =

-	table.insert(gItemCounterTypes,{name=3D"mandrake"		,artid=3D0xf86})
-	table.insert(gItemCounterTypes,{name=3D"garlic"		,artid=3D0xf84})
-	table.insert(gItemCounterTypes,{name=3D"ginseng"		,artid=3D0xf85})
-	table.insert(gItemCounterTypes,{name=3D"nightshade"	,artid=3D0xf88})
-	table.insert(gItemCounterTypes,{name=3D"spidersilk"	,artid=3D0xf8d})    =

-	table.insert(gItemCounterTypes,{name=3D"sulfurusash"	,artid=3D0xf8c})  =

+gItemCounterTypeGroups =3D {
+	{ -- mageregs
+		{name=3D"blackperl"	,artid=3D0xf7a},
+		{name=3D"bloodmoss"	,artid=3D0xf7b}, =

+		{name=3D"mandrake"	,artid=3D0xf86},
+		{name=3D"garlic"		,artid=3D0xf84},
+		{name=3D"ginseng"		,artid=3D0xf85},
+		{name=3D"nightshade"	,artid=3D0xf88},
+		{name=3D"spidersilk"	,artid=3D0xf8d},    =

+		{name=3D"sulfurusash"	,artid=3D0xf8c},  =

+	},
+	{ -- necroregs
+		{name=3D"pigiron"		,artid=3D0xf8a},
+		{name=3D"noxcrystal"	,artid=3D0xf8e},
+		{name=3D"demonblood"	,artid=3D0xf7d},
+		{name=3D"gravedust"	,artid=3D0xf8f},
+		{name=3D"batwing"		,artid=3D0xf78},
+	},
+	{ -- pots
+		{name=3D"gheal"		,artid=3D3852},
+		{name=3D"gcure"		,artid=3D3847},
+		{name=3D"refresh"		,artid=3D3851},
+		{name=3D"explo"		,artid=3D3853},
+	},
+	{ -- rest
+		{name=3D"gold"		,artid=3D0xeef},
+		{name=3D"bandas"		,artid=3D0xe21},
+		{name=3D"arrows"		,artid=3D3903},
+	},
+}
 =

-	table.insert(gItemCounterTypes,{name=3D"pigiron"		,artid=3D0xf8a})
-	table.insert(gItemCounterTypes,{name=3D"noxcrystal"	,artid=3D0xf8e})
-	table.insert(gItemCounterTypes,{name=3D"demonblood"	,artid=3D0xf7d})
-	table.insert(gItemCounterTypes,{name=3D"gravedust"	,artid=3D0xf8f})
-	table.insert(gItemCounterTypes,{name=3D"batwing"		,artid=3D0xf78})
-								 =

-	table.insert(gItemCounterTypes,{name=3D"gheal"		,artid=3D3852})
-	table.insert(gItemCounterTypes,{name=3D"gcure"		,artid=3D3847})
-	table.insert(gItemCounterTypes,{name=3D"refresh"		,artid=3D3851})
-	table.insert(gItemCounterTypes,{name=3D"explo"		,artid=3D3853})
+gItemCounterTypesByArtID 	=3D {}
+for k,group in pairs(gItemCounterTypeGroups) do =

+	for k2,v in pairs(group) do =

+		gItemCounterTypesByArtID[v.artid] =3D true =

+	end
+end
 =

-	table.insert(gItemCounterTypes,{name=3D"gold"			,artid=3D0xeef})
-	table.insert(gItemCounterTypes,{name=3D"bandas"		,artid=3D0xe21})
-	table.insert(gItemCounterTypes,{name=3D"arrows"		,artid=3D3903})
-	gItemCounterTypesByArtID 	=3D {}
-	for k,v in pairs(gItemCounterTypes) do gItemCounterTypesByArtID[v.artid] =
=3D true end
-end
-InitItemCounterTypes()
 =

 function ItemCounterOne (artid,baglist) =

 	local c =3D MacroCmd_Item_SumByArtID(artid) =

@@ -63,9 +72,18 @@
 	=

 	-- items
 	local baglist =3D MacroCmd_Item_FindByArtID(kItemCounterBagType)
-	for k,v in pairs(gItemCounterTypes) do
-		local amount =3D ItemCounterOne(v.artid,baglist)
-		gItemCounterDialog:AddItem(v,amount)
+	=

+	for k,group in pairs(gItemCounterTypeGroups) do =

+		local bGroupVisible =3D false
+		for k2,v in pairs(group) do =

+			v.curamount =3D ItemCounterOne(v.artid,baglist)
+			if (v.curamount > 0) then bGroupVisible =3D true end
+		end
+		if (bGroupVisible) then =

+			for k2,v in pairs(group) do =

+				gItemCounterDialog:AddItem(v,v.curamount)
+			end
+		end
 	end
 	=

 	-- weight



From no-reply at zwischenwelt.org  Tue Nov 25 02:52:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Nov 2008 01:52:25 -0000
Subject: [Iris-commit] [IRIS] r2752 - in /trunk: lua/lib.2d.dynamic.lua
 lua/lib.compass.lua lua/lib.macrolist.lua lua/net/net.multi.lua
 plugins/lib.spellbar.lua
Message-ID: <20081125015228.8F8051C1866B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 25 02:52:20 2008
New Revision: 2752

Log:
gMulti_OnlyShowFloor improved : blending out dynamics in upper floors, gDis=
ableCompassDynamics option for speed improvement, new macro MacroCmd_FindNe=
arestNonFriendlyPlayer, added two spell interrupt messages

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.compass.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.multi.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Tue Nov 25 02:52:20 2008
@@ -66,6 +66,13 @@
 		local sortty =3D yloc-byloc
 		local sorttz =3D zloc
 		local bVisible =3D (not (zloc and iBlendOutMinZ and iBlendOutMaxZ)) or (=
zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ)
+
+		if (gMulti_OnlyShowFloor) then
+			local n =3D xloc..","..yloc
+			local multibelow
+			for multi,v in pairs(gMultis) do if (multi.cache and multi.cache[n]) th=
en multibelow =3D multi break end end
+			if (multibelow and zloc >=3D multibelow.item.zloc + 10) then bVisible =
=3D false end
+		end
 	=

 		if (bVisible) then
 			-- corpse
@@ -185,7 +192,7 @@
 		local sortty =3D yloc-floor(yloc/8)*8
 		local sorttz =3D zloc
 		local fIndexRel =3D k / totalpartnum
-		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ and ((not gMulti=
_OnlyShowFloor) or tz <=3D 0)) then
+		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ and ((not gMulti=
_OnlyShowFloor) or tz <=3D 0)) then -- <=3D 7 for floor
 			local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Cal=
cSortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
 			if (sprite) then
 				sprite.xloc =3D xloc -- mousepicking

Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Tue Nov 25 02:52:20 2008
@@ -152,24 +152,26 @@
 		local bx0,dbx =3D math.floor((xloc-kDetailMapCacheSize/2)/8),kDetailMapC=
acheSize/8
 		local by0,dby =3D math.floor((yloc-kDetailMapCacheSize/2)/8),kDetailMapC=
acheSize/8
 		=

-		-- multi image
-		local minx,miny =3D bx0*8,by0*8
-		local maxx,maxy =3D minx + dbx*8, miny + dby*8
-		local i =3D GenerateDetailMultiImage(minx,miny, maxx,maxy)
-		=

 		gDetailMapMultiCacheBX =3D bx0
 		gDetailMapMultiCacheBY =3D by0
 	=

-		-- create or update texture
-		if (gDetailMapCacheMultiTexture) then =

-			i:LoadToTexture(gDetailMapCacheMultiTexture) -- update existing texture
-		else
-			gDetailMapCacheMultiTexture =3D i:MakeTexture() -- generate new texture
-		end
-		=

-		-- create material on first time init
-		if (not gDetailMapCacheMultiMaterial) then
-			gDetailMapCacheMultiMaterial =3D GetPlainTextureMat(gDetailMapCacheMult=
iTexture, true)
+		if (not gDisableCompassDynamics) then =

+			-- multi image
+			local minx,miny =3D bx0*8,by0*8
+			local maxx,maxy =3D minx + dbx*8, miny + dby*8
+			local i =3D GenerateDetailMultiImage(minx,miny, maxx,maxy)
+			=

+			-- create or update texture
+			if (gDetailMapCacheMultiTexture) then =

+				i:LoadToTexture(gDetailMapCacheMultiTexture) -- update existing texture
+			else
+				gDetailMapCacheMultiTexture =3D i:MakeTexture() -- generate new texture
+			end
+			=

+			-- create material on first time init
+			if (not gDetailMapCacheMultiMaterial) then
+				gDetailMapCacheMultiMaterial =3D GetPlainTextureMat(gDetailMapCacheMul=
tiTexture, true)
+			end
 		end
 	end
 =

@@ -244,7 +246,7 @@
 		gIrisCompassDialog =3D guimaker.MakeSortedDialog()
 		gIrisCompassDialog.rootwidget.gfx:SetPos(vw-gCompassSize - gCompassOff,1=
5 + gCompassOff)
 		gIrisCompassDialog.detailcompass 		=3D gIrisCompassDialog.rootwidget:Cre=
ateChild()
-		gIrisCompassDialog.detailcompassmulti	=3D gIrisCompassDialog.rootwidget:=
CreateChild()
+		gIrisCompassDialog.detailcompassmulti	=3D (not gDisableCompassDynamics) =
and gIrisCompassDialog.rootwidget:CreateChild()
 		gIrisCompassDialog.compass 				=3D gIrisCompassDialog.rootwidget:CreateC=
hild()
 		gIrisCompassDialog.mapdot 				=3D gIrisCompassDialog.rootwidget:CreateCh=
ild()
 		gIrisCompassDialog.compassframe_static	=3D gIrisCompassDialog.rootwidget=
:CreateChild()
@@ -415,7 +417,7 @@
 	gCompassVisibleRad =3D max(gCompassVisibleRad,giCompassDetailLimit)
 	local bRough =3D IsRoughCompassActive()
 	gIrisCompassDialog.detailcompass.gfx:SetVisible( not bRough )
-	gIrisCompassDialog.detailcompassmulti.gfx:SetVisible( not bRough )
+	if (gIrisCompassDialog.detailcompassmulti) then gIrisCompassDialog.detail=
compassmulti.gfx:SetVisible( not bRough ) end
 	gIrisCompassDialog.compass.gfx:SetVisible( bRough )
 	gIrisCompassDialog.compass.gfx:SetUVRad(gCompassVisibleRad/gCompassMapW,
 											gCompassVisibleRad/gCompassMapH)
@@ -539,33 +541,34 @@
 			=

 			=

 			=

-			-- detail multi layer -------------------------------------------
-			local mygfx =3D gIrisCompassDialog.detailcompassmulti.gfx
-			=

-			-- set material, only needed once
-			if (not mygfx.bDetailCompassMatHasBeenSet) then =

-				mygfx.bDetailCompassMatHasBeenSet =3D true
-				if (gDetailMapCacheMultiMaterial) then mygfx:SetMaterial(gDetailMapCac=
heMultiMaterial) end
-			end
-			=

-			-- prepare vars
-			local e =3D 1/kDetailMapCacheSize
-			local dx =3D xloc - gDetailMapMultiCacheBX * 8
-			local dy =3D yloc - gDetailMapMultiCacheBY * 8
-			local k =3D 11
-			=

-			mygfx:RenderableBegin(k+2,0,true,false,OT_TRIANGLE_FAN)
-			mygfx:RenderableVertex((mx)/vw * 2.0 - 1.0,(my)/vh * (-2.0) + 1.0,z, dx=
*e,dy*e)
-			for i =3D 0,k do
-				local a =3D 360*gfDeg2Rad*i/k
-				local x =3D   kDetailMapCacheViewRad * math.sin(a)
-				local y =3D   kDetailMapCacheViewRad * math.cos(a)
-				local u =3D ( kDetailMapCacheViewRad * math.sin(a + ax + gfDeg2Rad*180=
) + dx)*e
-				local v =3D ( kDetailMapCacheViewRad * math.cos(a + ax + gfDeg2Rad*180=
) + dy)*e
-				mygfx:RenderableVertex((mx + x)/vw * 2.0 - 1.0,(my + y)/vh * (-2.0) + =
1.0,z, u,v)
-			end
-			mygfx:RenderableEnd()
-			=

+			if (gIrisCompassDialog.detailcompassmulti) then =

+				-- detail multi layer -------------------------------------------
+				local mygfx =3D gIrisCompassDialog.detailcompassmulti.gfx
+				=

+				-- set material, only needed once
+				if (not mygfx.bDetailCompassMatHasBeenSet) then =

+					mygfx.bDetailCompassMatHasBeenSet =3D true
+					if (gDetailMapCacheMultiMaterial) then mygfx:SetMaterial(gDetailMapCa=
cheMultiMaterial) end
+				end
+				=

+				-- prepare vars
+				local e =3D 1/kDetailMapCacheSize
+				local dx =3D xloc - gDetailMapMultiCacheBX * 8
+				local dy =3D yloc - gDetailMapMultiCacheBY * 8
+				local k =3D 11
+				=

+				mygfx:RenderableBegin(k+2,0,true,false,OT_TRIANGLE_FAN)
+				mygfx:RenderableVertex((mx)/vw * 2.0 - 1.0,(my)/vh * (-2.0) + 1.0,z, d=
x*e,dy*e)
+				for i =3D 0,k do
+					local a =3D 360*gfDeg2Rad*i/k
+					local x =3D   kDetailMapCacheViewRad * math.sin(a)
+					local y =3D   kDetailMapCacheViewRad * math.cos(a)
+					local u =3D ( kDetailMapCacheViewRad * math.sin(a + ax + gfDeg2Rad*18=
0) + dx)*e
+					local v =3D ( kDetailMapCacheViewRad * math.cos(a + ax + gfDeg2Rad*18=
0) + dy)*e
+					mygfx:RenderableVertex((mx + x)/vw * 2.0 - 1.0,(my + y)/vh * (-2.0) +=
 1.0,z, u,v)
+				end
+				mygfx:RenderableEnd()
+			end
 		end
 		=

 		if gbCompassShowMobiles then

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Tue Nov 25 02:52:20 2008
@@ -435,6 +435,21 @@
 		local dist =3D dist2(xloc,yloc,mobile.xloc,mobile.yloc)
 		if (((not founddist) or dist < founddist) and (not IsPlayerMobile(mobile=
))) then =

 			if ((not namepart) or StringContains(AosToolTip_GetText(mobile.serial) =
or mobile.name or "",namepart)) then
+				founddist =3D dist
+				foundmob =3D mobile
+			end
+		end
+	end
+	return foundmob
+end
+
+function MacroCmd_FindNearestNonFriendlyPlayer ()
+	local founddist,foundmob
+	local xloc,yloc =3D GetPlayerPos()
+	for k,mobile in pairs(GetMobileList()) do =

+		if ((mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) and (not IsMobi=
leInParty(mobile.serial))) then =

+			local dist =3D dist2(xloc,yloc,mobile.xloc,mobile.yloc)
+			if (((not founddist) or dist < founddist) and (not IsPlayerMobile(mobil=
e))) then =

 				founddist =3D dist
 				foundmob =3D mobile
 			end

Modified: trunk/lua/net/net.multi.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.multi.lua (original)
+++ trunk/lua/net/net.multi.lua Tue Nov 25 02:52:20 2008
@@ -315,6 +315,7 @@
 	end
 		=

 	item.multi =3D multi
+	multi.item =3D item
 	gMultis[multi] =3D true
 end
 =


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Tue Nov 25 02:52:20 2008
@@ -149,6 +149,9 @@
 gSpellbarShortMessages[502644 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"recover"			,=
bInterrupt=3Dtrue} -- You have not yet recovered from casting a spell.
 gSpellbarShortMessages[1061091 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"form"				,b=
Interrupt=3Dtrue} -- You cannot cast that spell in this form.
 gSpellbarShortMessages[1061605 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already"			=
,bInterrupt=3Dtrue} -- You already have a familiar.
+gSpellbarShortMessages[1005385 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"will not ad=
here"	,bInterrupt=3Dtrue} -- The spell will not adhere to you at this time.=
 (preaos,reactive armor or spellresist still active)
+gSpellbarShortMessages[1005559 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already"			=
,bInterrupt=3Dtrue} -- This spell is already in effect.
+
 =

 for k,v in pairs(gSpellbarShortMessages) do if (v.bInterrupt) then gSpellI=
nterruptMessages[k] =3D true end end
 =




From no-reply at zwischenwelt.org  Tue Nov 25 15:31:09 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Nov 2008 14:31:09 -0000
Subject: [Iris-commit] [IRIS] r2753 - in /trunk: lua/lib.2d.dynamic.lua
 lua/lib.2d.mousepick.lua lua/lib.uoids.lua lua/net/net.effect.lua
 plugins/lib.spellbar.lua src/main.cpp
Message-ID: <20081125143109.AD3C41C1877C@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 25 15:31:03 2008
New Revision: 2753

Log:
huedfx notifier, and magic-reflect detection. warning in main.cpp for fedor=
a with bad compiler option

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/net/net.effect.lua
    trunk/plugins/lib.spellbar.lua
    trunk/src/main.cpp

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Tue Nov 25 15:31:03 2008
@@ -71,7 +71,8 @@
 			local n =3D xloc..","..yloc
 			local multibelow
 			for multi,v in pairs(gMultis) do if (multi.cache and multi.cache[n]) th=
en multibelow =3D multi break end end
-			if (multibelow and zloc >=3D multibelow.item.zloc + 10) then bVisible =
=3D false end
+			--~ if (multibelow and zloc >=3D multibelow.item.zloc + 10) then bVisib=
le =3D false end
+			if (multibelow and (not TestMask(GetStaticTileTypeFlags(item.artid),kTi=
leDataFlag_Container+kTileDataFlag_Door))) then bVisible =3D false end
 		end
 	=

 		if (bVisible) then

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Tue Nov 25 15:31:03 2008
@@ -107,6 +107,7 @@
 		if (o.hittype =3D=3D kMousePickHitType_Mobile 			) then =

 			local mount =3D o.mobile and o.mobile:GetEquipmentAtLayer(kLayer_Mount)
 			if (mount) then hitinfo =3D hitinfo..sprintf("mount-artid(id=3D0x%04x),=
",mount.artid) end =

+			hitinfo =3D hitinfo..sprintf("notoriety=3D%d,",o.mobile and o.mobile.no=
toriety or -1)
 		end
 		if (o.hittype =3D=3D kMousePickHitType_Static			) then hitinfo =3D hitin=
fo.."static" end
 		if (o.hittype =3D=3D kMousePickHitType_Terrain 			) then hitinfo =3D hit=
info.."terrain" end

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Tue Nov 25 15:31:03 2008
@@ -211,7 +211,7 @@
 =

 -- Tiledata Flags
 kTileDataFlag_Background		=3D hex2num("0x00000001")
-kTileDataFlag_Weapon			=3D hex2num("0x00000002") -- set for weapons AND sh=
ields (7035)
+kTileDataFlag_Weapon			=3D hex2num("0x00000002") -- set for weapons AND sh=
ields (7035)  (rather:can be equipped,also set for backpack etc)
 kTileDataFlag_Transparent		=3D hex2num("0x00000004")
 kTileDataFlag_Translucent		=3D hex2num("0x00000008")
 kTileDataFlag_Wall				=3D hex2num("0x00000010")

Modified: trunk/lua/net/net.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.effect.lua (original)
+++ trunk/lua/net/net.effect.lua Tue Nov 25 15:31:03 2008
@@ -37,6 +37,7 @@
 	=

 	--~ print("kPacket_Hued_FX",SmartDump(effect))
 	if (gParticleEffectSystem) then gCurrentRenderer:AddEffect( effect ) end
+	NotifyListener("Hook_Packet_Hued_FX",effect)
 	=

 	gEffectCounter =3D gEffectCounter or {}
 	gEffectCounter[effect.sourceserial] =3D gEffectCounter[effect.sourceseria=
l] or {}

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Tue Nov 25 15:31:03 2008
@@ -135,6 +135,10 @@
 	end
 end)
 	=

+gSpellbarEffectShortMessages =3D {}
+gSpellbarEffectShortMessages[0x37B9 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"reflec=
t" } -- Magic Reflection (preaos)
+	=

+	=

 =

 gSpellbarShortMessages =3D {}
 gSpellbarShortMessages[502642 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already cast=
ing"	}-- You are already casting a spell.	=

@@ -227,6 +231,10 @@
 	end
 end)
 =

+RegisterListener("Hook_Packet_Hued_FX",	function (effect)
+	local short =3D gSpellbarEffectShortMessages[effect.itemid] =

+	if (short) then SpellBarRiseTextOnMob(effect.sourceserial,short.r,short.g=
,short.b,short.txt) end
+end)
 =

 =

 	=


Modified: trunk/src/main.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/main.cpp (original)
+++ trunk/src/main.cpp Tue Nov 25 15:31:03 2008
@@ -1,3 +1,7 @@
+#ifndef MAIN_WORKING_DIR
+#define MAIN_WORKING_DIR_NOT_SET_VIA_COMPILE
+#endif
+
 #include "lugre_prefix.h"
 #include "lugre_robstring.h"
 #include "lugre_main.h"
@@ -20,6 +24,10 @@
 #else
 int			main		(int argc, char* argv[]) {
 #endif
+	#ifdef MAIN_WORKING_DIR_NOT_SET_VIA_COMPILE
+	printf("MAIN_WORKING_DIR_NOT_SET_VIA_COMPILE, should be set as compiler c=
onstant via -DMAIN_WORKING_DIR=3D\\\"../\\\" or similar\n");
+	#endif
+	printf("MAIN_WORKING_DIR=3D%s\n",(const char*)MAIN_WORKING_DIR);
 	=

 	std::string s;
 	s +=3D "If this error remains after running the updater and you think thi=
s is a bug\n";



From no-reply at zwischenwelt.org  Tue Nov 25 18:22:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 25 Nov 2008 17:22:42 -0000
Subject: [Iris-commit] [IRIS] r2754 - in /trunk/lua: lib.2d.mobile.lua
 lib.2d.mousepick.lua lib.uoids.lua obj/obj.mobile.lua
Message-ID: <20081125172243.0610E1C187E4@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Nov 25 18:22:42 2008
New Revision: 2754

Log:
skillname fixed Enticement -> Discordance, 2d:hidden mobiles now hued grey

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/obj/obj.mobile.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Tue Nov 25 18:22:42 2008
@@ -159,6 +159,9 @@
 			local iLoaderIndex =3D 1
 			local iOldModelID =3D iModelID
 			iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
+			=

+			if (mobile.flag_hidden) then iHue =3D kHiddenMobileHue end
+			=

 			--~ if (iOldModelID =3D=3D 309) then print("UOAnimTranslateBodyID trans=
lated to ",iOldModelID,iModelID,iHue,iLoaderIndex) end
 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Tue Nov 25 18:22:42 2008
@@ -108,6 +108,7 @@
 			local mount =3D o.mobile and o.mobile:GetEquipmentAtLayer(kLayer_Mount)
 			if (mount) then hitinfo =3D hitinfo..sprintf("mount-artid(id=3D0x%04x),=
",mount.artid) end =

 			hitinfo =3D hitinfo..sprintf("notoriety=3D%d,",o.mobile and o.mobile.no=
toriety or -1)
+			hitinfo =3D hitinfo..sprintf("flags=3D0x%04x,",o.mobile and o.mobile.fl=
ag or 0)
 		end
 		if (o.hittype =3D=3D kMousePickHitType_Static			) then hitinfo =3D hitin=
fo.."static" end
 		if (o.hittype =3D=3D kMousePickHitType_Terrain 			) then hitinfo =3D hit=
info.."terrain" end

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Tue Nov 25 18:22:42 2008
@@ -41,6 +41,8 @@
 kMobileFlag_Movable			=3D hex2num("0x20") -- Movable if normally not
 kMobileFlag_WarMode			=3D hex2num("0x40")
 kMobileFlag_Hidden			=3D hex2num("0x80") -- probably self while hiding/ste=
alth-walking, displayed as gray in original client
+
+kHiddenMobileHue =3D 1104
 =

 gSkillNumber =3D 55		--RunUO-ML
 =

@@ -342,7 +344,7 @@
 	[13]	=3D "Cartography",
 	[14]	=3D "Cooking",
 	[15]	=3D "Detect Hidden",
-	[16]	=3D "Enticement",
+	[16]	=3D "Discordance",
 	[17]	=3D "Evaluate Intelligence",
 	[18]	=3D "Healing",
 	[19]	=3D "Fishing",

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Tue Nov 25 18:22:42 2008
@@ -221,13 +221,13 @@
 =

 -- sets self.flag_* from self.flag
 function gMobilePrototype:UpdateFlags	()
-	self.flag_female			=3D TestBit( self.flag, hex2num("0x02") )
-	self.flag_poisoned			=3D TestBit( self.flag, hex2num("0x04") )
-	self.flag_yellowhits		=3D TestBit( self.flag, hex2num("0x08") )
-	self.flag_factionship		=3D TestBit( self.flag, hex2num("0x10") )
-	self.flag_explicitmovable	=3D TestBit( self.flag, hex2num("0x20") )
-	self.flag_warmode	 		=3D TestBit( self.flag, hex2num("0x40") )
-	self.flag_hidden			=3D TestBit( self.flag, hex2num("0x80") )
+	self.flag_female			=3D TestBit( self.flag, 0x02 )
+	self.flag_poisoned			=3D TestBit( self.flag, 0x04 )
+	self.flag_yellowhits		=3D TestBit( self.flag, 0x08 )
+	self.flag_factionship		=3D TestBit( self.flag, 0x10 )
+	self.flag_explicitmovable	=3D TestBit( self.flag, 0x20 )
+	self.flag_warmode	 		=3D TestBit( self.flag, 0x40 )
+	self.flag_hidden			=3D TestBit( self.flag, 0x80 )
 	=

 	if (self.old_flag ~=3D self.flag) then -- only if a change has occurred
 		self.old_flag  =3D self.flag



From no-reply at zwischenwelt.org  Wed Nov 26 01:08:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 26 Nov 2008 00:08:11 -0000
Subject: [Iris-commit] [IRIS] r2755 - /trunk/bin/iris2.exe
Message-ID: <20081126000811.EB5051C1866B@zwischenwelt.org>

Author: sience
Date: Wed Nov 26 01:08:11 2008
New Revision: 2755

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Wed Nov 26 14:53:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 26 Nov 2008 13:53:06 -0000
Subject: [Iris-commit] [IRIS] r2756 - in /trunk/lua: lib.2d.dynamic.lua
 lib.loading.lua lib.namegumps.lua lib.uodragdrop.lua
Message-ID: <20081126135306.B2CB21524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 26 14:53:05 2008
New Revision: 2756

Log:
namegumps : skipped self and blood, dragdrop on container bugfix, gMulti_On=
lyShowFloor option improved (doors,teleporter,containers shown)

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.namegumps.lua
    trunk/lua/lib.uodragdrop.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Wed Nov 26 14:53:05 2008
@@ -33,6 +33,9 @@
 	if (bHadDirty) then self.gDynamicBlockDirtyList =3D {} end
 end
 =

+
+	=

+	=

 function Renderer2D:DynamicBlockRebuild (block)
 	local bxloc =3D block.bx * 8
 	local byloc =3D block.by * 8
@@ -41,7 +44,7 @@
 	local myindex =3D 0
 	local spriteblock =3D block.gfx2d
 	local iBlendOutMinZ,iBlendOutMaxZ =3D self:BlendoutGetVisibleRange()
-	=

+
 	-- erase block if empty
 	if (itemcount =3D=3D 0) then
 		if (spriteblock) then spriteblock:Destroy() end
@@ -72,7 +75,11 @@
 			local multibelow
 			for multi,v in pairs(gMultis) do if (multi.cache and multi.cache[n]) th=
en multibelow =3D multi break end end
 			--~ if (multibelow and zloc >=3D multibelow.item.zloc + 10) then bVisib=
le =3D false end
-			if (multibelow and (not TestMask(GetStaticTileTypeFlags(item.artid),kTi=
leDataFlag_Container+kTileDataFlag_Door))) then bVisible =3D false end
+			if (multibelow and =

+				(not gOnlyShowFloorItemTypeList[item.artid]) and =

+				(not TestMask(GetStaticTileTypeFlags(item.artid),kTileDataFlag_Contain=
er+kTileDataFlag_Door))) then =

+					bVisible =3D false =

+			end
 		end
 	=

 		if (bVisible) then
@@ -193,7 +200,8 @@
 		local sortty =3D yloc-floor(yloc/8)*8
 		local sorttz =3D zloc
 		local fIndexRel =3D k / totalpartnum
-		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ and ((not gMulti=
_OnlyShowFloor) or tz <=3D 0)) then -- <=3D 7 for floor
+		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ and =

+			((not gMulti_OnlyShowFloor) or tz <=3D 0 or (gOnlyShowFloorItemTypeList=
[iTileTypeID]))) then -- <=3D 7 for floor
 			local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Cal=
cSortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
 			if (sprite) then
 				sprite.xloc =3D xloc -- mousepicking

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Wed Nov 26 14:53:05 2008
@@ -157,6 +157,15 @@
 					print("GetStaticTileType failed", arg[2],_TRACEBACK())
 				end
 				return unpack(arr)
+			end
+		end
+		=

+		-- gMulti_OnlyShowFloor
+		if (gMulti_OnlyShowFloor) then
+			gOnlyShowFloorItemTypeList =3D {}
+			for artid =3D 0,0x4000 do =

+				local name =3D string.lower(GetStaticTileTypeName(artid) or "")
+				if (StringContains(name,"gate") or StringContains(name,"teleport")) th=
en gOnlyShowFloorItemTypeList[artid] =3D true end
 			end
 		end
 	end

Modified: trunk/lua/lib.namegumps.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.namegumps.lua (original)
+++ trunk/lua/lib.namegumps.lua Wed Nov 26 14:53:05 2008
@@ -5,8 +5,20 @@
 gNameGumpsNextPosUpdate =3D 0
 =

 kNameGumpYOff =3D -10
-kNameGumpPosUpdateInterval =3D 100
+kNameGumpPosUpdateInterval =3D 1000/25
 RegisterWidgetClass("UONameGump")
+
+gNameGumpSkippedTypes =3D {
+	-- blood
+	0x122a,0x122b,0x122c,0x122d,0x122e,0x1645,0x1cc7,0x1cc8,0x1cc9,0x1cca,0x1=
ccb,0x1ccc,0x1ccd,0x1cce,
+	0x1ccf,0x1cd0,0x1cd1,0x1cd2,0x1cd3,0x1cd4,0x1cd5,0x1cd6,0x1cd7,0x1cd8,0x1=
cd9,0x1cda,0x1cdb,0x1cdc,
+	0x1cf1,0x1cf2,0x1cf3,0x1cf4,0x1cf5,0x1cf6,0x1cf7,0x1cf8,0x1cf9,0x1cfa,0x1=
cfb,0x1cfc,0x1cfd,0x1cfe,
+	0x1cff,0x1d00,0x1d01,0x1d02,0x1d03,0x1d04,0x1d05,0x1d06,0x1d07,0x1d08,0x1=
d09,0x1d0a,0x1d0b,0x1d0c,
+	0x1d0d,0x1d0e,0x1d0f,0x1d10,0x1d11,0x1d12,0x1d92,0x1d93,0x1d94,0x1d95,0x1=
d96,
+}
+
+gNameGumpSkippedTypesByID =3D {}
+for k,artid in ipairs(gNameGumpSkippedTypes) do gNameGumpSkippedTypesByID[=
artid] =3D true end
 =

 RegisterStepper(function () =

 	local bActive =3D gKeyPressed[key_lshift] and gKeyPressed[key_lcontrol]
@@ -31,8 +43,8 @@
 	if (bOnlyCorpses) then =

 		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
) and IsCorpseArtID(dynamic.artid)) then NameGumps_ShowDynamic(dynamic) end=
 end
 	else
-		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
)) then NameGumps_ShowDynamic(dynamic) end end
-		for k,mobile in pairs(GetMobileList()) do NameGumps_ShowMobile(mobile) e=
nd
+		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
) and (not gNameGumpSkippedTypesByID[dynamic.artid])) then NameGumps_ShowDy=
namic(dynamic) end end
+		for k,mobile in pairs(GetMobileList()) do if (not IsPlayerMobile(mobile)=
) then NameGumps_ShowMobile(mobile) end end
 	end
 	gNameGumpsActive =3D true
 end

Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Wed Nov 26 14:53:05 2008
@@ -450,13 +450,14 @@
 		--~ #####dragdrop,gMousePickFoundHit=3D       {hit_zloc=3D35=3D0x23,dyna=
mic=3Dtable: 0x9d50c38,hittype=3D2,hit_xloc=3D3443=3D0x0d73,hit_yloc=3D2659=
=3D0x0a63,}
 =

 		-- uo-hack : don't send drop-container on dynamic floor tiles (yard wand=
 tool on vm), to allow puttin items on the floor (flags=3D0x201)
+		local bOnContainer =3D false
 		if (iSerial and iSerial ~=3D 0) then =

 			local dynamic =3D GetDynamic(iSerial)
 			if (dynamic) then
-				local flags =3D GetStaticTileTypeFlags(dynamic.artid)
-				if (flags and TestBit(flags,kTileDataFlag_Surface)) then   --  or kTil=
eDataFlag_Background ?
-					iSerial =3D nil
-				end
+				local flags =3D GetStaticTileTypeFlags(dynamic.artid) or 0
+				if (TestBit(flags,kTileDataFlag_Container)) then bOnContainer =3D true=
 end
+				--~ if (not bOnContainer) then iSerial =3D nil end  -- might be bad fo=
r potionkegs and similar non-container droptargets
+				if (TestBit(flags,kTileDataFlag_Surface)) then iSerial =3D nil end   -=
-  or kTileDataFlag_Background ?
 				if (dynamic.artid >=3D gMulti_ID) then iSerial =3D nil end
 			end
 		end
@@ -464,8 +465,13 @@
 		if (iSerial and iSerial ~=3D 0) then =

 			-- drop on mobile,dynamic etc =

 			print("drop on mobile,dynamic etc ")
-			printdebug("dragdrop","MouseUpUODragDrop: drop on worlobject : ",item.s=
erial,item.amount,x,y,z,iSerial)
-			Send_Drop_Object(item.serial,x,y,z,iSerial)
+			if (bOnContainer) then
+				printdebug("dragdrop","MouseUpUODragDrop: drop on worldcontainer : ",i=
tem.serial,item.amount,iSerial)
+				Send_Drop_Object_AutoStack(item.serial,iSerial)
+			else
+				printdebug("dragdrop","MouseUpUODragDrop: drop on worlobject : ",item.=
serial,item.amount,x,y,z,iSerial)
+				Send_Drop_Object(item.serial,x,y,z,iSerial)
+			end
 		else
 			-- drop on world
 			printdebug("dragdrop","MouseUpUODragDrop: drop on world : ",item.serial=
,item.amount,x,y,z,hex2num("0xFFFFFFFF"))



From no-reply at zwischenwelt.org  Wed Nov 26 15:41:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 26 Nov 2008 14:41:32 -0000
Subject: [Iris-commit] [IRIS] r2757 - in /trunk/lua: lib.2d.dynamic.lua
	lib.huepicker.lua
Message-ID: <20081126144132.8C8C81524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Nov 26 15:41:32 2008
New Revision: 2757

Log:
ToggleMultiOnlyShowFloor, huepicker:brightness

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.huepicker.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Wed Nov 26 15:41:32 2008
@@ -34,6 +34,13 @@
 end
 =

 =

+	=

+function ToggleMultiOnlyShowFloor () Renderer2D:SetMultiOnlyShowFloor(not =
gMulti_OnlyShowFloor) end
+function Renderer2D:SetMultiOnlyShowFloor (bValue)
+	if (gMulti_OnlyShowFloor =3D=3D bValue) then return end
+	gMulti_OnlyShowFloor =3D bValue
+	for k,block in pairs(self.gDynamicBlocks) do self:DynamicBlockRebuild(blo=
ck) end
+end
 	=

 	=

 function Renderer2D:DynamicBlockRebuild (block)

Modified: trunk/lua/lib.huepicker.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.huepicker.lua (original)
+++ trunk/lua/lib.huepicker.lua Wed Nov 26 15:41:32 2008
@@ -18,7 +18,7 @@
 =

 kHuePickerFirst =3D 2
 kHuePickerLast  =3D 1001
-kHuePickerDefaultBrightness =3D 1 -- 0-4 =3D dark->light
+kHuePickerBrightnessList =3D {0,1,3} -- 0-4 =3D dark->light
 =

 RegisterWidgetClass("UOHuePicker")
 RegisterWidgetClass("UOHuePickerButton")
@@ -68,14 +68,17 @@
 	local u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy =3D 0,0, 4,8,4, 4,8,4, 32,32
 	local gfxparam_init =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTex=
tureGUIMat(texname),w,h,xoff,yoff, u0,v0,w0,w1,w2,h0,h1,h2, tcx,tcy, 1,1, f=
alse, false)
 =

+	local tw,th =3D 8,8
+	for bk,brightness in ipairs(kHuePickerBrightnessList) do
 	for y=3D0,10-1 do =

 	for x=3D0,20-1 do =

-		local hue =3D kHuePickerFirst + (y*20 + x)*5 + kHuePickerDefaultBrightne=
ss -- *5:brightness +2:middle brighness by default
+		local hue =3D kHuePickerFirst + (y*20 + x)*5 + brightness -- *5:brightne=
ss +2:middle brighness by default
 		local r,g,b =3D GetHueColor(hue-1)
 		gfxparam_init.r =3D r
 		gfxparam_init.g =3D g
 		gfxparam_init.b =3D b
-		local btn =3D self:CreateChild("UOHuePickerButton",{x=3Dx*10,y=3Dy*10,hu=
e=3Dhue,gfxparam_init=3Dgfxparam_init})
+		local btn =3D self:CreateChild("UOHuePickerButton",{x=3Dx*tw,y=3D(bk*10+=
y)*th,hue=3Dhue,gfxparam_init=3Dgfxparam_init})
+	end
 	end
 	end
 	=




From no-reply at zwischenwelt.org  Sat Nov 29 04:54:31 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 29 Nov 2008 03:54:31 -0000
Subject: [Iris-commit] [IRIS] r2758 - in /trunk: include/ lua/ lua/net/
	lua/obj/ plugins/ src/
Message-ID: <20081129035432.972741C1877C@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Nov 29 04:54:29 2008
New Revision: 2758

Log:
multitex terrain : added zmod option, for water-ground. SpellBarRiseTextOnP=
os, for soundeffectsanims.  Hook_Packet_Animation and Hook_Packet_Sound lis=
teners, CompleteTargetMode:maxrange param (12 is good),  MacroCmd_GetPlayer=
Equipment , MacroCmd_DragAndEquip , MacroCmd_ListNonFriendlyPlayers , Macro=
Cmd_GetNearestMobFromList , Renderer2D:HUDFX_Step : added position option, =
gNodrawByArtID list to hide nodraw tiles,  constants for kNotoriety_Blue et=
c,  ToggleMultiOnlyShowFloor : rebuilds multis now, so toggle at runtime po=
ssible

Modified:
    trunk/include/terrain.h
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.hudfx.lua
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.cursor.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.terrain.multitex.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/net/net.sound.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/plugins/lib.spellbar.lua
    trunk/src/scripting.iris.cpp
    trunk/src/terrain_multitex.cpp

Modified: trunk/include/terrain.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/terrain.h (original)
+++ trunk/include/terrain.h Sat Nov 29 04:54:29 2008
@@ -3,6 +3,7 @@
 =

 #include <OgreVector3.h>
 #include <string>
+#include <map>
 =

 class cGroundBlockLoader;
 namespace Lugre {
@@ -15,6 +16,7 @@
 =

 void	 		TerrainMultiTexWrite		(cGroundBlockLoader* pGroundBlockLoader,cons=
t int iBlockX,const int iBlockY,const int iDX,const int iDY,const float fZU=
nit,Lugre::cRobRenderOp& pRobRenderOp);
 void	 		TerrainMultiTex_SetGroundMaterialTypeLookUp	(const int* piValues,c=
onst int iCount);
+void	 		TerrainMultiTex_SetZModTable(const std::map<int,int>& myZModTable);
 void			TerrainMultiTex_AddTexCoordSet				(int iMode,float tx,float ty,floa=
t tw,float th,int iTileSpan); ///< 0:ground,1:mainmask,2:mask
 void			TerrainMultiTex_AddMaskTexCoordSet			(float u1,float v1, float u2,f=
loat v2, float u3,float v3, float u4,float v4);
 =


Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Sat Nov 29 04:54:29 2008
@@ -40,6 +40,7 @@
 	if (gMulti_OnlyShowFloor =3D=3D bValue) then return end
 	gMulti_OnlyShowFloor =3D bValue
 	for k,block in pairs(self.gDynamicBlocks) do self:DynamicBlockRebuild(blo=
ck) end
+	for multi,v in pairs(gMultis) do self:UpdateMultiItemGfx(multi.item) end
 end
 	=

 	=


Modified: trunk/lua/lib.2d.hudfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.hudfx.lua (original)
+++ trunk/lua/lib.2d.hudfx.lua Sat Nov 29 04:54:29 2008
@@ -27,14 +27,21 @@
 =

 function Renderer2D:HUDFX_Step (hudfx,t)
 	if (t > hudfx.endt) then self:HUDFX_Destroy(hudfx) return end
-	if (hudfx.mob and hudfx.gfx) then
-		local mobile =3D hudfx.mob
-		local xloc,yloc,zloc =3D self:GetExactMobilePos(mobile)
-		local px,py =3D self:UOPosToPixelPos(xloc,yloc,zloc+hudfx.zadd)
-		if (px) then =

-			local dur =3D hudfx.dur
-			local ft =3D min(dur,t - hudfx.startt) / dur
-			hudfx.gfx:SetPos(px + hudfx.offsetx,py - sqrt(ft)*hudfx.riseh)
+	if (hudfx.gfx) then =

+		local xloc,yloc,zloc
+		if (hudfx.mob) then
+			local mobile =3D hudfx.mob
+			xloc,yloc,zloc =3D self:GetExactMobilePos(mobile)
+		else
+			xloc,yloc,zloc =3D hudfx.xloc,hudfx.yloc,hudfx.zloc
+		end
+		if (xloc) then =

+			local px,py =3D self:UOPosToPixelPos(xloc,yloc,zloc+hudfx.zadd)
+			if (px) then =

+				local dur =3D hudfx.dur
+				local ft =3D min(dur,t - hudfx.startt) / dur
+				hudfx.gfx:SetPos(px + hudfx.offsetx,py - sqrt(ft)*hudfx.riseh)
+			end
 		end
 	end
 end
@@ -45,8 +52,30 @@
 	local offsetx =3D isOnSelf and -32 or 0
 	local r,g,b =3D unpack(col)
 	self:HUDFX_AddRisingTextOnMob(GetMobile(mobile_serial),sprintf("%d",damag=
e),r,g,b,offsetx)
+	--~ print("2D:NotifyDamage ##################",Client_GetTicks(),damage,m=
obile_serial)
 end
 =

+
+function Renderer2D:HUDFX_AddRisingTextOnPos (xloc,yloc,zloc,text,r,g,b,of=
fsetx,risetime,riseh)
+	local hudfx =3D {}
+	hudfx.dur =3D risetime or 1000
+	hudfx.riseh =3D riseh or 64 -- in pixels
+
+	local t =3D Client_GetTicks()
+	hudfx.startt =3D t
+	hudfx.endt =3D t + hudfx.dur
+	hudfx.text =3D text
+	hudfx.xloc =3D xloc
+	hudfx.yloc =3D yloc
+	hudfx.zloc =3D zloc
+	hudfx.zadd =3D 10
+	hudfx.offsetx =3D offsetx or 0
+	=

+	local gfx =3D gRootWidget.hudfx:CreateChild("UOText",{x=3D0,y=3D0,text=3D=
text,col=3D{r=3Dr,g=3Dg,b=3Db},bold=3Dtrue})
+	=

+	hudfx.gfx =3D gfx
+	Renderer2D.gHUDFXList[hudfx] =3D true
+end
 =

 function Renderer2D:HUDFX_AddRisingTextOnMob (mob,text,r,g,b,offsetx,riset=
ime,riseh)
 	if (not mob) then return end

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Sat Nov 29 04:54:29 2008
@@ -110,6 +110,10 @@
 			hitinfo =3D hitinfo..sprintf("notoriety=3D%d,",o.mobile and o.mobile.no=
toriety or -1)
 			hitinfo =3D hitinfo..sprintf("flags=3D0x%04x,",o.mobile and o.mobile.fl=
ag or 0)
 		end
+		if (o.hittype =3D=3D kMousePickHitType_Terrain 			) then =

+			local tiletype,z =3D GetGroundAtAbsPos(o.hit_xloc,o.hit_yloc) =

+			hitinfo =3D hitinfo..sprintf("tiletype=3D0x%04x,",tiletype or 0) =

+		end
 		if (o.hittype =3D=3D kMousePickHitType_Static			) then hitinfo =3D hitin=
fo.."static" end
 		if (o.hittype =3D=3D kMousePickHitType_Terrain 			) then hitinfo =3D hit=
info.."terrain" end
 		if (o.hittype =3D=3D kMousePickHitType_Dynamic 			) then hitinfo =3D hit=
info.."dynamic" end

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sat Nov 29 04:54:29 2008
@@ -188,6 +188,7 @@
 =

 -- load textures to atlas, artid-hue
 function cUOSpriteBlock:AddArtSprite (tx,ty,zloc,artid,hue,sortbonus,data)
+	if (gNodrawByArtID[artid]) then return end
 	sortbonus =3D sortbonus or 0
 	hue =3D hue or 0
 	local arr =3D self.pTileTypeAtlasMats[artid]
@@ -290,6 +291,7 @@
 end
 =

 function cUOSpriteBlock:AddWaterTile(tx,ty,zloc,artid,data,sortrelidx) =

+	--~ if (true) then return end -- debug : nowater
 	local multitile =3D 8 -- gWater2DMatName
 	local e =3D 1/multitile
 	local u0,v0 =3D (tx%multitile)*e,(ty%multitile)*e

Modified: trunk/lua/lib.cursor.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.cursor.lua (original)
+++ trunk/lua/lib.cursor.lua Sat Nov 29 04:54:29 2008
@@ -124,7 +124,7 @@
 	CompleteTargetMode(hit)
 end
 =

-function CompleteTargetMode (hitobject)
+function CompleteTargetMode (hitobject,maxrange) -- maxrange=3Dnil
 	if (not hitobject) then
 		MainMousePick()
 		if (not gMousePickFoundHit) then =

@@ -132,6 +132,11 @@
 			return =

 		end
 		hitobject =3D gMousePickFoundHit
+	end
+	=

+	if (maxrange and hitobject.hittype =3D=3D kMousePickHitType_Mobile) then
+		local mobile =3D hitobject.mobile
+		if (IsOutsideRange(mobile.xloc,mobile.yloc,gPlayerXLoc,gPlayerYLoc,maxra=
nge)) then return end
 	end
 	=

 	MacroRememberTarget(hitobject)

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Nov 29 04:54:29 2008
@@ -116,11 +116,11 @@
 end
 =

 =

-function MacroCmd_SendTargetSerial	(serial) =

+function MacroCmd_SendTargetSerial	(serial,maxrange) =

 	local mobile =3D GetMobile(serial)
-	if mobile then return CompleteTargetMode({ hittype =3D kMousePickHitType_=
Mobile,  mobile =3D mobile }) end
+	if mobile then return CompleteTargetMode({ hittype =3D kMousePickHitType_=
Mobile,  mobile =3D mobile },maxrange) end
 	local dynamic =3D GetDynamic(serial)
-	if dynamic then return CompleteTargetMode({ hittype =3D kMousePickHitType=
_Dynamic,  dynamic =3D dynamic }) end
+	if dynamic then return CompleteTargetMode({ hittype =3D kMousePickHitType=
_Dynamic,  dynamic =3D dynamic },maxrange) end
 end
 =

 -- timeout : in ms
@@ -351,13 +351,7 @@
 	return true
 end
 =

-function MacroCmd_IsMounted ()
-	local playermobile =3D GetPlayerMobile()
-	return playermobile and GetMobileEquipmentItem(playermobile,kLayer_Mount)
-end
-function MacroCmd_Dismount ()
-	if (MacroCmd_IsMounted()) then Send_DoubleClick(GetPlayerSerial()) return=
 true end -- todo : check if mounted
-end
+	=

 =

 function MacroCmd_RiseText (r,g,b,text,serial)
 	serial =3D serial or GetPlayerSerial()
@@ -373,6 +367,22 @@
 function MacroCmd_Item_FindFirstByArtID	(artid,hue,container) local list =
=3D MacroCmd_Item_FindByArtID(artid,hue,container) return list[1] end
 function MacroCmd_Item_FindFirstNearByArtID	(artid,hue,dist) local list =
=3D MacroCmd_Item_FindNearByArtID(artid,hue,dist) return list[1] end
 =

+function MacroCmd_GetPlayerEquipment (layer) =

+	local playermobile =3D GetPlayerMobile()
+	return playermobile and GetMobileEquipmentItem(playermobile,layer)
+end
+function MacroCmd_IsMounted () return MacroCmd_GetPlayerEquipment(kLayer_M=
ount) ~=3D nil end
+function MacroCmd_Dismount ()
+	if (MacroCmd_IsMounted()) then Send_DoubleClick(GetPlayerSerial()) return=
 true end -- todo : check if mounted
+end
+
+function MacroCmd_DragAndEquip (takeserial,mobileserial)
+	local item =3D GetDynamic(takeserial)
+	local layer =3D item and GetPaperdollLayerFromTileType(item.artid)
+	if (not layer) then print("MacroCmd_DragEquip not wearable or item not fo=
und, artid=3D",item.artid) return end
+	Send_Take_Object(takeserial,1)
+	Send_Equip_Item_Request(takeserial,layer,mobileserial or GetPlayerSerial(=
))
+end =

 function MacroCmd_DragDrop (takeserial,amount,dropcontainerserial) =

 	Send_Take_Object(takeserial,amount)
 	Send_Drop_Object_AutoStack(takeserial,dropcontainerserial or GetPlayerBac=
kPackSerial())
@@ -443,20 +453,30 @@
 	return foundmob
 end
 =

-function MacroCmd_FindNearestNonFriendlyPlayer ()
+function MacroCmd_GetNearestMobFromList (list)
 	local founddist,foundmob
 	local xloc,yloc =3D GetPlayerPos()
+	for k,mobile in pairs(list) do =

+		local dist =3D dist2(xloc,yloc,mobile.xloc,mobile.yloc)
+		if ((not founddist) or dist < founddist) then =

+			founddist =3D dist
+			foundmob =3D mobile
+		end
+	end
+	return foundmob
+end
+
+function MacroCmd_ListNonFriendlyPlayers ()
+	local res =3D {}
 	for k,mobile in pairs(GetMobileList()) do =

-		if ((mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) and (not IsMobi=
leInParty(mobile.serial))) then =

-			local dist =3D dist2(xloc,yloc,mobile.xloc,mobile.yloc)
-			if (((not founddist) or dist < founddist) and (not IsPlayerMobile(mobil=
e))) then =

-				founddist =3D dist
-				foundmob =3D mobile
-			end
-		end
-	end
-	return foundmob
-end
+		if ((mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) and =

+			(not IsMobileInParty(mobile.serial)) and
+			(not IsPlayerMobile(mobile))) then res[mobile.serial] =3D mobile end
+	end
+	return res
+end
+
+function MacroCmd_FindNearestNonFriendlyPlayer () return MacroCmd_GetNeare=
stMobFromList(MacroCmd_ListNonFriendlyPlayers()) end
 =

 function MacroCmd_ListMobilesInRange (filterfun,maxdist)
 	local res =3D {}

Modified: trunk/lua/lib.terrain.multitex.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.terrain.multitex.lua (original)
+++ trunk/lua/lib.terrain.multitex.lua Sat Nov 29 04:54:29 2008
@@ -84,11 +84,23 @@
 ,{tilespan=3D1,src=3D"terrain1_darktile4.png"		,uoids=3D{1089}}
 }
 =

+--~ gWaterGroundTileTypes =3D {0x00a8=3D168,0x00a9=3D169,0x00aa=3D170,0x00=
ab=3D171,0x0136=3D310,0x0137=3D311}
+
 -- skipped tiles
 gMultiTextureSkipList =3D {
-	168,169,170,171,310,311,  -- water --,100,94,91,99,87,82,79,149,131}
+	--~ 168,169,170,171,310,311,  -- water --,100,94,91,99,87,82,79,149,131}
 } =

 =

+kMultiTexTerrainWaterZMod =3D -20
+--~ kMultiTexTerrainWaterZMod =3D 0
+gMultiTexTerrainZModTable =3D {
+	[168]=3DkMultiTexTerrainWaterZMod,
+	[169]=3DkMultiTexTerrainWaterZMod,
+	[170]=3DkMultiTexTerrainWaterZMod,
+	[171]=3DkMultiTexTerrainWaterZMod,
+	[310]=3DkMultiTexTerrainWaterZMod,
+	[311]=3DkMultiTexTerrainWaterZMod,
+}
 =

 -- old : gMultiTextureAtlasList_Span
 =

@@ -224,6 +236,7 @@
 	=

 	for k2,uoid in pairs(gMultiTextureSkipList) do gMultiTexTerrainTypeLookup=
[uoid] =3D -1 end -- skip tiles, e.g. water =

 	TerrainMultiTex_SetGroundMaterialTypeLookUp(gMultiTexTerrainTypeLookup) =

+	if (TerrainMultiTex_SetZModTable) then TerrainMultiTex_SetZModTable(gMult=
iTexTerrainZModTable) end
 	=

 	-- TexCoordSet 1 : main mask
 	if (true) then

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sat Nov 29 04:54:29 2008
@@ -311,6 +311,16 @@
 gCharCreateSkillIDs["Bushido"]					=3D 52
 gCharCreateSkillIDs["Ninjitsu"]					=3D 53
 gCharCreateSkillIDs["Spellweaving"]				=3D 54 -- not possible to set > 0 a=
t charcreate !!!!
+
+
+kNotoriety_Invalid		=3D 0 -- invalid/across server line
+kNotoriety_Blue			=3D 1 -- innocent (blue)
+kNotoriety_Friend		=3D 2 -- guilded/ally (green)
+kNotoriety_Neutral		=3D 3 -- attackable but not criminal (original : gray,=
 animals etc)
+kNotoriety_Crime		=3D 4 -- criminal (gray)
+kNotoriety_Orange		=3D 5 -- enemy (orange)
+kNotoriety_Red			=3D 6 -- murderer (red)
+kNotoriety_Invul		=3D 7 -- unknown use (translucent (like 0x4000 hue)) =

 =

 =

 kTextType_Normal			=3D 0x00
@@ -649,6 +659,10 @@
 	[11573] =3D {first=3D17,second=3D24},
 }
 =

+gNodrawArtIDs =3D {0x21a4,0x2199}
+gNodrawByArtID =3D {}
+for k,artid in ipairs(gNodrawArtIDs) do gNodrawByArtID[artid] =3D true end
+
 gBroken2DArtAnims =3D {0x154d}
 gBroken2DArtAnimsByID =3D {}
 for k,artid in ipairs(gBroken2DArtAnims) do gBroken2DArtAnimsByID[artid] =
=3D true end

Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Sat Nov 29 04:54:29 2008
@@ -105,6 +105,7 @@
 	NotifyTeleport(mobiledata) -- calls CreateOrUpdateMobile and assigns play=
erid
 end
 =

+
 -- Character Animation (0x6e)
 function gPacketHandler.kPacket_Animation ()	-- [0x6e] 14 Bytes
 	local input =3D GetRecvFIFO()
@@ -119,13 +120,14 @@
 	animdata.m_repeatFlag	=3D input:PopNetUint8()	--(0 - Don't repeat / 1 rep=
eat)
 	animdata.m_frameDelay	=3D input:PopNetUint8()	--(0x00 - fastest / 0xFF - =
Too slow to watch)
 	printdebug("animation","Animation "..vardump2(animdata))
-	=

+
 	gCurrentRenderer:MobileStartServerSideAnim(animdata)
-	=

 	=

 	gAnimCounter =3D gAnimCounter or {}
 	gAnimCounter[animdata.mobileserial] =3D gAnimCounter[animdata.mobileseria=
l] or {}
 	gAnimCounter[animdata.mobileserial][animdata.m_animation] =3D (gAnimCount=
er[animdata.mobileserial][animdata.m_animation] or 0) + 1
+	=

+	NotifyListener("Hook_Packet_Animation",animdata)
 end
 =

 -- Note: For characters other than the player, curHits and maxHits are not=
 the actual values.

Modified: trunk/lua/net/net.sound.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.sound.lua (original)
+++ trunk/lua/net/net.sound.lua Sat Nov 29 04:54:29 2008
@@ -1,20 +1,24 @@
 -- TODO: allow more Soundeffect than one, sound.def parsing
 -- effect sound
-function gPacketHandler.kPacket_Sound ()	-- [0x45]
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local singular =3D input:PopNetUint8()
-	local effect =3D input:PopNetUint16()
-	local unknown =3D input:PopNetUint16()
-	local x =3D input:PopNetUint16()
-	local y =3D input:PopNetUint16()
-	local z =3D input:PopNetUint16()
-	printdebug("sound",sprintf("NET: kPacket_Sound: effect: %i singular: %i x=
: %i y: %i z: %i\n",effect,singular,x,y,z))
+function gPacketHandler.kPacket_Sound ()	-- [0x54]
+	local input		=3D GetRecvFIFO()
+	local id		=3D input:PopNetUint8()
+	local sounddata =3D {}
+	sounddata.flags			=3D input:PopNetInt8() -- runuo:always 1
+	sounddata.effectid		=3D input:PopNetInt16()
+	sounddata.volume		=3D input:PopNetInt16() -- runuo:always 0
+	sounddata.xloc			=3D input:PopNetInt16()
+	sounddata.yloc			=3D input:PopNetInt16()
+	sounddata.zloc			=3D input:PopNetInt16()
 	=

-	if (not gDisableUOSounds) then SoundPlayEffect_UO(x,y,z * 0.1,effect) end
+	printdebug("sound","NET: kPacket_Sound:"..SmartDump(sounddata))
+	=

+	if (not gDisableUOSounds) then SoundPlayEffect_UO(sounddata.xloc,sounddat=
a.yloc,sounddata.zloc * 0.1,sounddata.effectid) end
 	=

 	gSoundCounter =3D gSoundCounter or {}
-	gSoundCounter[effect] =3D (gSoundCounter[effect] or 0) + 1
+	gSoundCounter[sounddata.effectid] =3D (gSoundCounter[sounddata.effectid] =
or 0) + 1
+	=

+	NotifyListener("Hook_Packet_Sound",sounddata)
 end
 =

 -- ProtocolRecv_Play_Midi

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Sat Nov 29 04:54:29 2008
@@ -415,13 +415,13 @@
 =

 -- return r,g,b
 function GetNotorietyColor (n)
-	if (n =3D=3D  0) then return 0.0 , 0.0 , 0.0 end -- 0.0 =3D invalid/acros=
s server line
-	if (n =3D=3D  1) then return 0.1 , 0.1 , 1.0 end -- 1 =3D innocent (blue)
-	if (n =3D=3D  2) then return 0.0 , 1.0 , 0.0 end -- 2 =3D guilded/ally (g=
reen)
-	if (n =3D=3D  3) then return 1.0 , 1.0 , 0.3 end -- 3 =3D attackable but =
not criminal (original : gray, here : yellow)
-	if (n =3D=3D  4) then return 0.5 , 0.5 , 0.5 end -- 4 =3D criminal (gray)
-	if (n =3D=3D  5) then return 1.0 , 0.5 , 0.0 end -- 5 =3D enemy (orange)
-	if (n =3D=3D  6) then return 1.0 , 0.0 , 0.0 end -- 6 =3D murderer (red)
-	if (n =3D=3D  7) then return 1.0 , 0.0 , 1.0 end -- 7 =3D unknown use (tr=
anslucent (like 0x4000 hue)) =

+	if (n =3D=3D  kNotoriety_Invalid	) then return 0.0 , 0.0 , 0.0 end -- inv=
alid/across server line
+	if (n =3D=3D  kNotoriety_Blue		) then return 0.1 , 0.1 , 1.0 end -- innoc=
ent (blue)
+	if (n =3D=3D  kNotoriety_Friend		) then return 0.0 , 1.0 , 0.0 end -- gui=
lded/ally (green)
+	if (n =3D=3D  kNotoriety_Neutral	) then return 1.0 , 1.0 , 0.3 end -- att=
ackable but not criminal (original : gray, here : yellow)
+	if (n =3D=3D  kNotoriety_Crime		) then return 0.5 , 0.5 , 0.5 end -- crim=
inal (gray)
+	if (n =3D=3D  kNotoriety_Orange		) then return 1.0 , 0.5 , 0.0 end -- ene=
my (orange)
+	if (n =3D=3D  kNotoriety_Red		) then return 1.0 , 0.0 , 0.0 end -- murder=
er (red)
+	if (n =3D=3D  kNotoriety_Invul		) then return 1.0 , 0.0 , 1.0 end -- unkn=
own use (translucent (like 0x4000 hue)) =

 	return 0.5,0.5,0.5
 end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Nov 29 04:54:29 2008
@@ -88,6 +88,11 @@
 	if (gCurrentRenderer ~=3D Renderer2D) then return end
 	Renderer2D:HUDFX_AddRisingTextOnMob(GetMobile(serial),text,r,g,b) -- see =
2d.hudfx.lua
 end
+
+function SpellBarRiseTextOnPos (xloc,yloc,zloc,r,g,b,text) =

+	Renderer2D:HUDFX_AddRisingTextOnPos(xloc,yloc,zloc,text,r,g,b) -- see 2d.=
hudfx.lua
+end
+
      =

 =

 RegisterListener("Hook_Text",function (name,plaintext,serial,data)
@@ -136,9 +141,17 @@
 end)
 	=

 gSpellbarEffectShortMessages =3D {}
-gSpellbarEffectShortMessages[0x37B9 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"reflec=
t" } -- Magic Reflection (preaos)
-	=

-	=

+gSpellbarEffectShortMessages[0x37B9 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"reflec=
t" } -- Magic Reflection (preaos) or parrying
+	=

+gSpellbarAnimationShortMessages =3D {}
+gSpellbarAnimationShortMessages[11 ] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"s=
wing" } -- melee combat : swing weapon
+gSpellbarAnimationShortMessages[20 ] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"g=
ethit" } -- melee combat : take damage
+gSpellbarAnimationShortMessages[34 ] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"d=
rinkpot" }
+gSpellbarAnimationShortMessages[92 ] =3D {r=3D0.8,g=3D0.5,b=3D0.5,txt=3D"f=
izzle" } -- spellfail
+gSpellbarAnimationShortMessages[526] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"g=
ate" }
+gSpellbarAnimationShortMessages[508] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"r=
ecall" }
+	=

+gSpellbarSoundShortMessages =3D {}
 =

 gSpellbarShortMessages =3D {}
 gSpellbarShortMessages[502642 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already cast=
ing"	}-- You are already casting a spell.	=

@@ -155,6 +168,9 @@
 gSpellbarShortMessages[1061605 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already"			=
,bInterrupt=3Dtrue} -- You already have a familiar.
 gSpellbarShortMessages[1005385 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"will not ad=
here"	,bInterrupt=3Dtrue} -- The spell will not adhere to you at this time.=
 (preaos,reactive armor or spellresist still active)
 gSpellbarShortMessages[1005559 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already"			=
,bInterrupt=3Dtrue} -- This spell is already in effect.
+gSpellbarShortMessages[1005561 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"crime"				,=
bInterrupt=3Dtrue} -- Thou'rt a criminal and cannot escape so easily...
+gSpellbarShortMessages[1005564 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"crime"				,=
bInterrupt=3Dtrue} -- Wouldst thou flee during the heat of battle??
+
 =

 =

 for k,v in pairs(gSpellbarShortMessages) do if (v.bInterrupt) then gSpellI=
nterruptMessages[k] =3D true end end
@@ -236,7 +252,17 @@
 	if (short) then SpellBarRiseTextOnMob(effect.sourceserial,short.r,short.g=
,short.b,short.txt) end
 end)
 =

-
+RegisterListener("Hook_Packet_Animation",	function (animdata)
+	local short =3D gSpellbarAnimationShortMessages[animdata.m_animation] =

+	if (short) then SpellBarRiseTextOnMob(animdata.mobileserial,short.r,short=
.g,short.b,short.txt) end
+	if ((not short) and gDebugSpellbarAnim) then SpellBarRiseTextOnMob(animda=
ta.mobileserial,0.5,0.5,0.5,"Anim:"..animdata.m_animation) print("spellbar:=
anim:",animdata.m_animation) end
+end)
+
+RegisterListener("Hook_Packet_Sound",	function (sounddata)
+	local short =3D gSpellbarSoundShortMessages[sounddata.effectid] =

+	if (short) then SpellBarRiseTextOnPos(sounddata.xloc,sounddata.yloc,sound=
data.zloc,short.r,short.g,short.b,short.txt) end
+	if ((not short) and gDebugSpellbarSound) then SpellBarRiseTextOnPos(sound=
data.xloc,sounddata.yloc,sounddata.zloc,0.5,0.5,0.5,"Sound:"..sounddata.eff=
ectid) print("spellbar:sound:",sounddata.effectid) end
+end)
 	=

 --[[
 Hook_Packet_Localized_Text      382928   a Crane        1050045

Modified: trunk/src/scripting.iris.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/scripting.iris.cpp (original)
+++ trunk/src/scripting.iris.cpp Sat Nov 29 04:54:29 2008
@@ -330,6 +330,26 @@
 	return 4;
 }
 =

+
+
+
+/// for lua : void	TerrainMultiTex_SetZModTable (table{[tileid]=3Dzadd}) =

+static int l_TerrainMultiTex_SetZModTable (lua_State *L) { PROFILE
+	int t =3D 1; // index where table is
+	std::map<int,int> myZModTable;
+	if (lua_istable(L,t)) { // iterate over attributes
+		lua_pushnil(L);  // first key
+		while (lua_next(L,t) !=3D 0) {
+			int iTileType	=3D luaL_checkint(L,-2);
+			int iZMod		=3D luaL_checkint(L,-1);
+			myZModTable[iTileType] =3D iZMod;
+			lua_pop(L, 1); // removes 'value'; keeps 'key' for next iteration
+		}
+	}
+	TerrainMultiTex_SetZModTable(myZModTable);
+	return 0;
+}
+
 /// for lua : void	TerrainMultiTex_SetGroundMaterialTypeLookUp (table) =

 /// key=3Duo-ground-tiletype-id  value=3Dindex_for_AddTexCoordSet_mode_0
 /// use value=3D-1 to skip tiles
@@ -479,6 +499,7 @@
 			lua_register(L,"BuildTerrainEntity_Shaded",		l_BuildTerrainEntity_Shade=
d);
 			lua_register(L,"Gfx3D_SetMultiTexTerrain",		l_Gfx3D_SetMultiTexTerrain);
 			lua_register(L,"TerrainMultiTex_RayPick",		l_TerrainMultiTex_RayPick);
+			lua_register(L,"TerrainMultiTex_SetZModTable",					l_TerrainMultiTex_Se=
tZModTable);
 			lua_register(L,"TerrainMultiTex_SetGroundMaterialTypeLookUp",	l_Terrain=
MultiTex_SetGroundMaterialTypeLookUp);
 			lua_register(L,"TerrainMultiTex_AddTexCoordSet",				l_TerrainMultiTex_A=
ddTexCoordSet);
 			lua_register(L,"TerrainMultiTex_AddMaskTexCoordSet",			l_TerrainMultiTe=
x_AddMaskTexCoordSet);

Modified: trunk/src/terrain_multitex.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/terrain_multitex.cpp (original)
+++ trunk/src/terrain_multitex.cpp Sat Nov 29 04:54:29 2008
@@ -47,6 +47,7 @@
 	std::vector<float> mTexCoords_Ground;
 	std::vector<float> mTexCoords_MainMask;
 	std::vector<float> mTexCoords_Mask;
+	std::map<int,int>	mZModTable;
 	int		mGroundMaterialTypeLookUp[kGroundMatLookUpSize]; ///< key=3Duo-groun=
dtype, value=3D in [0,16] or so (depends on tex-atlas)
 	float	mNormalLookup[kMaxZDiff*2+1][kMaxZDiff*2+1][3]; ///< y,x : 192kb wi=
th 64 maxdiff
 	float*	mNormals[(T+1)*(T+1)]; ///< internal cache
@@ -59,7 +60,7 @@
 	/// x,y must be in [-7,8+7]
 	/// returns original uo z integer (16bit)
 	/// this is a bit more expensive than the cached GetZ below
-	inline int		GetZRaw	(const int x,const int y) { return GetTile(x,y).miZ; }
+	inline int		GetZRaw	(const int x,const int y) { RawGroundTile& t =3D GetT=
ile(x,y); return t.miZ + mZModTable[t.miTileType]; }
 	=

 	/// x,y must be in [-1,9]
 	/// returns original uo z integer (16bit)
@@ -431,6 +432,10 @@
 	gTiledMultiTexTerrain.WriteToRobRenderOp(pGroundBlockLoader,iBlockX,iBloc=
kY,iDX,iDY,fZUnit,pRobRenderOp);
 }
 =

+void	 TerrainMultiTex_SetZModTable	(const std::map<int,int>& myZModTable) {
+	gTiledMultiTexTerrain.mZModTable =3D myZModTable;
+}
+
 void	 TerrainMultiTex_SetGroundMaterialTypeLookUp	(const int* piValues,con=
st int iCount) {
 	for (int i=3D0;i<cTiledMultiTexTerrain<8>::kGroundMatLookUpSize;++i) {
 		gTiledMultiTexTerrain.mGroundMaterialTypeLookUp[i] =3D (i<iCount) ? piVa=
lues[i] : 0;



From no-reply at zwischenwelt.org  Sun Nov 30 18:20:15 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 30 Nov 2008 17:20:15 -0000
Subject: [Iris-commit] [IRIS] r2759 - /trunk/bin/iris2.exe
Message-ID: <20081130172015.7DB711C187E2@zwischenwelt.org>

Author: sience
Date: Sun Nov 30 18:20:14 2008
New Revision: 2759

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sun Nov 30 21:35:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 30 Nov 2008 20:35:53 -0000
Subject: [Iris-commit] [IRIS] r2760 - in /trunk/lua: config_declarations.lua
 lib.razorpacketvideo.lua main.lua
Message-ID: <20081130203554.2B5D51C187E2@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov 30 21:35:53 2008
New Revision: 2760

Log:
razor packetvideo reader started, added config-decl comments about demise r=
emoval

Added:
    trunk/lua/lib.razorpacketvideo.lua
Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/main.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sun Nov 30 21:35:53 2008
@@ -166,6 +166,7 @@
 		gPolServer =3D false =

 	}
 =

+-- demise admins banned iris =3D(  http://www.uodemise.com/forum/showthrea=
d.php?p=3D477997
 --~ gShardList["uodemise.com"] =3D {
 		--~ gLoginname =3D "",	-- Loginname
 		--~ gPassword =3D "",		-- Password
@@ -205,8 +206,8 @@
 -- gShardList["myshard"] =3D { ..... } =

 =

 -- in config.lua you can set login infos like this: (not recommended for s=
ecurity reasons)  =

--- gShardList["uodemise.com"].gLoginname =3D "YOUR_USERNAME" =

--- gShardList["uodemise.com"].gPassword =3D "YOUR_PASSWORD" =

+-- gShardList["uogamers.com"].gLoginname =3D "YOUR_USERNAME" =

+-- gShardList["uogamers.com"].gPassword =3D "YOUR_PASSWORD" =

 =

 -- for pol servers use this:
 -- gShardList["localhost"].gPolServer=3Dtrue

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Nov 30 21:35:53 2008
@@ -99,6 +99,7 @@
 dofile(libpath .. "lib.namegumps.lua") =

 dofile(libpath .. "lib.razormacro.lua")
 dofile(libpath .. "lib.razorconfig.lua")
+dofile(libpath .. "lib.razorpacketvideo.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")



From no-reply at zwischenwelt.org  Sun Nov 30 21:57:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 30 Nov 2008 20:57:19 -0000
Subject: [Iris-commit] [IRIS] r2761 - /trunk/lua/lib.razorpacketvideo.lua
Message-ID: <20081130205721.674BC1C187E2@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Nov 30 21:57:16 2008
New Revision: 2761

Log:
rpv experiments

Modified:
    trunk/lua/lib.razorpacketvideo.lua

Modified: trunk/lua/lib.razorpacketvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.razorpacketvideo.lua (original)
+++ trunk/lua/lib.razorpacketvideo.lua Sun Nov 30 21:57:16 2008
@@ -144,14 +144,24 @@
 		packet.iPacketID		=3D fifo:PeekNetUint8(0)
 		if (packet.iPacketID =3D=3D 0xff) then fifo:PopRaw(1) break end
 		packet.iPacketSize		=3D gPacketSizeById[packet.iPacketID]
+		=

+		if (not packet.iPacketSize) then 	=

+			print("rpv : warning, unknown packettype-size",sprintf("0x%02x",packet.=
iPacketID))
+			packet.iPacketSize =3D 0 -- assume dynamic
+		end
+		=

 		if (packet.iPacketSize =3D=3D 0 and fifo:Size() >=3D 3) then packet.iPac=
ketSize =3D fifo:PeekNetUint16(1) end
 		print("rpv:packet id,size,name fifoleft",packet.iPacketID,packet.iPacket=
Size,gPacketTypeId2Name[packet.iPacketID],fifo:Size())
 		=

-		assert(fifo:Size() >=3D packet.iPacketSize,"rpv : packet incomplete")
+		if (fifo:Size() < packet.iPacketSize) then
+			print("rpv : packet incomplete",packet.iPacketID,fifo:Size(),packet.iPa=
cketSize)
+			break
+		end
 		packet.fifo =3D  CreateFIFO() -- TODO : destroy when not needed anymore =
! otherwise memleak
 		=

 		packet.fifo:PushFIFOPartRaw(fifo,0,packet.iPacketSize)
 		fifo:PopRaw(packet.iPacketSize)
+		table.insert(rpv.packets,packet)
 	end
 =

 	print("rpv:end. sizeleft",fifo:Size(),FIFOHexDump(fifo))



