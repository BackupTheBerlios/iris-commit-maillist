<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1948 - in /trunk: bin/ lua/ lua/gui/ lua/obj/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2008-March/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1948%20-%20in%20/trunk%3A%20bin/%20lua/%20lua/gui/%20lua/obj/&In-Reply-To=%3C20080310004445.4056C152400E%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000759.html">
   <LINK REL="Next"  HREF="000761.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1948 - in /trunk: bin/ lua/ lua/gui/ lua/obj/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1948%20-%20in%20/trunk%3A%20bin/%20lua/%20lua/gui/%20lua/obj/&In-Reply-To=%3C20080310004445.4056C152400E%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1948 - in /trunk: bin/ lua/ lua/gui/ lua/obj/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Mon Mar 10 01:44:44 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000759.html">[Iris-commit] [IRIS] r1947 - in /trunk: data/models/materials/textures.material data/skippedfallbacks.lua lua/filter/filter.art.lua lua/main.lua
</A></li>
        <LI>Next message: <A HREF="000761.html">[Iris-commit] [IRIS] r1949 - in /trunk: data/config.lua.dist include/builder.h include/data.h lua/lib.loading.lua lua/lib.unifont.lua lua/main.lua src/builder.cpp src/data.cpp src/data_L.cpp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#760">[ date ]</a>
              <a href="thread.html#760">[ thread ]</a>
              <a href="subject.html#760">[ subject ]</a>
              <a href="author.html#760">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: sience
Date: Mon Mar 10 01:44:39 2008
New Revision: 1948

Log:
-Ogre updated to 1.4.7
-new win32 binary
-journal, paperdoll, status and healthbar uses gumpparser now
-obj.container.lua reorganized and cleaned
-offline mode for lib.gumpparser.lua added

Modified:
    trunk/bin/OgreMain.dll
    trunk/bin/Plugin_CgProgramManager.dll
    trunk/bin/Plugin_ParticleFX.dll
    trunk/bin/RenderSystem_Direct3D9.dll
    trunk/bin/RenderSystem_GL.dll
    trunk/bin/iris2.exe
    trunk/lua/gui/gui.journal.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/gui/gui.status.lua
    trunk/lua/lib.gui.iris.lua
    trunk/lua/lib.gumpparser.lua
    trunk/lua/lib.keybinds.lua
    trunk/lua/obj/obj.container.lua

Modified: trunk/bin/OgreMain.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_CgProgramManager.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_ParticleFX.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_Direct3D9.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_GL.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/gui/gui.journal.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.journal.lua (original)
+++ trunk/lua/gui/gui.journal.lua Mon Mar 10 01:44:39 2008
@@ -1,4 +1,3 @@
-
 --[[
 function RegisterJournalEntryType (name) _G[&quot;kEntryType_&quot;..name] =3D name =
end
 =

@@ -30,37 +29,33 @@
 gJournalMaxVisIdx =3D nil
 gJournalMinimized =3D false
 =

-function JournalAddText (name,message)
-	local sys =3D &quot;System:&quot;
-	local nicklen =3D string.len(name)
-	nicklen =3D math.floor(nicklen*0.9)
-	local initprefix =3D &quot;&quot;	=

-	local mytext =3D message	=

-	-- strip &quot;System:&quot;	=

-	local a,b =3D string.find(name, &quot;System&quot;, 1, false)
-	if not string.find(name, &quot;System&quot;, 1, true) then =

-		mytext =3D name..&quot;&gt; &quot;..mytext
-	end   	=

-	table.insert(gJournalEntries,mytext)
-	JournalUpdateText()
-end
-
---[[
-function JournalUpdateFontSize (size)
-	if size &lt; 8 then size =3D 8 end
-	gFontGumpSize =3D size
-end
-
-function splitlines(str)
-	local t =3D {}
-	for line in string.gfind(str, &quot;[^\n]+&quot;) do
-    	table.insert(t, line)
-  	end
-	return t
-end
-]]--
-
-function JournalUpdateText ()
+-- Created 09.03.2008 12:25:56, with GumpStudio &amp; Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local journalGump =3D {}
+journalGump.dialogId =3D 1234567
+journalGump.x =3D 10
+journalGump.y =3D 50
+journalGump.Data =3D
+	 &quot;{ page 0 }&quot; ..
+	 &quot;{ gumppic 4 27 2080 }&quot; ..
+	 &quot;{ gumppic 21 64 2081 }&quot; ..
+	 &quot;{ gumppic 21 134 2082 }&quot; ..
+	 &quot;{ gumppic 23 204 2083 }&quot; ..
+	 &quot;{ gumppic 118 36 2090 }&quot; ..
+	 &quot;{ gumppic 38 65 2091 }&quot; ..
+	 &quot;{ gumppic 38 183 2091 }&quot; ..
+	 &quot;{ button 139 4 2093 2093 1 0 journalminimize }&quot; ..
+	 &quot;{ button 139 235 2094 2095 1 0 journalresize }&quot; ..
+	 &quot;{ button 260 77 2088 2088 1 0 0 }&quot; ..
+	 &quot;{ button 254 61 2084 2084 1 0 0 }&quot; ..
+	 &quot;{ button 254 181 2085 2085 1 0 0 }&quot; ..
+	 &quot;{ button 241 181 2092 2092 1 0 0 }&quot;
+journalGump.textline =3D {
+}
+
+local function JournalGetTextBorder () return 40,80,40,50 end
+
+local function JournalUpdateText ()
 	if (not gJournalDialog or not gJournalEntries) then return end
 	local widget =3D gJournalDialog.maintext
 =

@@ -123,7 +118,75 @@
 	end
 end
 =

-function JournalGetTextBorder () return 40,80,40,50 end
+local function RestoreLastState()
+    -- restore last position if available
+    local pref =3D gJournalDialog_Pref
+    local dialog =3D gJournalDialog
+    if (dialog and gJournalMinimized =3D=3D false) then =

+        dialog.rootwidget.gfx:SetPos((pref.x or 0),(pref.y or 0)) =

+        =

+        --dialog:SetDimensions((pref.dx or dialog.resize_max_total_x),(pre=
f.dy or dialog.resize_max_total_y))
+        pref.dx =3D (pref.dx or dialog.resize_max_total_x) - dialog.rootwi=
dget.gfx:GetWidth()
+        pref.dy =3D (pref.dy or dialog.resize_max_total_y) - dialog.rootwi=
dget.gfx:GetHeight()
+        dialog:ResizeDelta(pref.dx,pref.dy)  -- =

+        --dialog:ResizeMaximize()
+        =

+        JournalUpdateText()
+    end
+end
+
+local function CreateJournal_Small ()
+	gJournalDialog =3D guimaker.MakeSortedDialog()
+	local pref =3D gJournalDialog_Pref
+
+	local dialog =3D gJournalDialog
+	dialog.Close 		=3D function(dialog)
+        	gJournalDialog:SetVisible(false)
+        	gJournalDialog:Destroy()
+        	gJournalDialog =3D nil
+	end
+
+	dialog.onMouseDown =3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 2) then gJournalDialog:Close() end
+			if (mousebutton =3D=3D 1) then
+				widget.dialog:BringToFront()
+				gui.StartMoveDialog(widget.dialog.rootwidget)
+            end
+	end
+
+	local root =3D dialog.rootwidget
+	MakeBorderGumpPart( root, 2096, (pref.x or 0), (pref.y or 0))
+
+	for k,widget in pairs(dialog.childs) do
+            widget.mbIgnoreMouseOver =3D false
+    end
+end
+
+local function ToggleJournal_Small () -- produces a small journal scroll i=
con
+	local pref =3D gJournalDialog_Pref
+	if (gJournalDialog) then  =

+        pref.x, pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
+		gJournalDialog:Close()
+		=

+		-- create minimized journal button
+		gJournalMinimized =3D true
+		CreateJournal_Small()
+	end
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
+
+function JournalAddText (name,message)
+	local sys =3D &quot;System&quot;
+	local mytext =3D message	=

+	-- strip &quot;System:&quot;	=

+	local a,b =3D string.find(name, sys, 1, false)
+	if not string.find(name, sys, 1, true) then =

+		mytext =3D name..&quot;&gt; &quot;..mytext
+	end   	=

+	table.insert(gJournalEntries,mytext)
+	JournalUpdateText()
+end
 =

 function ToggleJournal ()
 	local pref =3D gJournalDialog_Pref
@@ -138,7 +201,9 @@
         end
         gJournalMinimized =3D false
         =

-        gJournalDialog =3D CreateGumpDlgFromGfm(datapath..&quot;gfm/journal.gfm=
&quot;)
+        -- gJournalDialog =3D CreateGumpDlgFromGfm(datapath..&quot;gfm/journal.=
gfm&quot;)
+        gJournalDialog =3D GumpParser( journalGump, true )
+
         -- create text
         local parent =3D gJournalDialog.rootwidget
         local col =3D {1,1,1,1}
@@ -152,8 +217,7 @@
             widget.gfx:SetClip(widget.gfx:GetDerivedLeft(),widget.gfx:GetD=
erivedTop(),iw,ih) =

         end
         -- see also MakeClippedText,SetAutoWrap
-    =

-    =

+
         printdebug(&quot;gump&quot;,(pref.dx or &quot;dx=3Dnil &quot;)..&quot; -dxy- &quot;..(pref.dy or=
 &quot;dy=3Dnil&quot;))
         printdebug(&quot;gump&quot;,(pref.x or &quot;x=3Dnil &quot;)..&quot; -xy- &quot;..(pref.y or &quot;y=
=3Dnil&quot;))
         =

@@ -175,11 +239,9 @@
         end
             =

         -- resize limits
-        dialog.resize_min_total_x,dialog.resize_min_total_y =3D -20,-66	--=
 -100,-66
-        dialog.resize_max_total_x,dialog.resize_max_total_y =3D 60,175	-- =
334,212
-        =

-        =

-    =

+        dialog.resize_min_total_x,dialog.resize_min_total_y =3D 0,-66	 -- =
-20,-66
+        dialog.resize_max_total_x,dialog.resize_max_total_y =3D 0, 120 -- =
 60,175
+
         -- xml attributes to resize params
         for k,widget in pairs(dialog.childs) do
             widget.mbIgnoreMouseOver =3D false
@@ -188,7 +250,7 @@
         end
 			=

         -- minimize btn
-		local widget =3D dialog.controls[&quot;journal_minimize&quot;]
+		local widget =3D dialog.controls[&quot;journalminimize&quot;]
 		widget.onMouseDown 		=3D function (widget,mousebutton)
 			pref.x,pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
 			local left,top,w,h =3D gJournalDialog:GetLTWH()
@@ -198,7 +260,7 @@
 		end
         =

         -- resize btn
-		local widget =3D dialog.controls[&quot;journal_resize&quot;]
+		local widget =3D dialog.controls[&quot;journalresize&quot;]
 		widget.onMouseDown              =3D function (widget,mousebutton) =

             if (mousebutton =3D=3D 1) then
                 widget.gfx:SetMaterial(widget.mat_pressed)
@@ -278,61 +340,3 @@
     -- widget.onMouseUp 		=3D function (widget,mousebutton) if (mousebutto=
n =3D=3D 1) then widget.gfx:SetMaterial(widget.mat_normal) end end
 	=

 end	-- function
-
-
-function RestoreLastState()
-    -- restore last position if available
-    local pref =3D gJournalDialog_Pref
-    local dialog =3D gJournalDialog
-    if (dialog and gJournalMinimized =3D=3D false) then =

-        dialog.rootwidget.gfx:SetPos((pref.x or 0),(pref.y or 0)) =

-        =

-        --dialog:SetDimensions((pref.dx or dialog.resize_max_total_x),(pre=
f.dy or dialog.resize_max_total_y))
-        pref.dx =3D (pref.dx or dialog.resize_max_total_x) - dialog.rootwi=
dget.gfx:GetWidth()
-        pref.dy =3D (pref.dy or dialog.resize_max_total_y) - dialog.rootwi=
dget.gfx:GetHeight()
-        dialog:ResizeDelta(pref.dx,pref.dy)  -- =

-        --dialog:ResizeMaximize()
-        =

-        JournalUpdateText()
-    end
-end
-
-function ToggleJournal_Small () -- produces a small journal scroll icon
-	local pref =3D gJournalDialog_Pref
-	if (gJournalDialog) then  =

-        pref.x, pref.y =3D gJournalDialog.rootwidget.gfx:GetPos()
-		gJournalDialog:Close()
-		=

-		-- create minimized journal button
-		gJournalMinimized =3D true
-		CreateJournal_Small()
-	end
-end
-
-function CreateJournal_Small ()
-	gJournalDialog =3D guimaker.MakeSortedDialog()
-	local pref =3D gJournalDialog_Pref
-
-	local dialog =3D gJournalDialog
-	dialog.Close 		=3D function(dialog)
-        	gJournalDialog:SetVisible(false)
-        	gJournalDialog:Destroy()
-        	gJournalDialog =3D nil
-	end
-
-	dialog.onMouseDown =3D function (widget,mousebutton)
-			if (mousebutton =3D=3D 2) then gJournalDialog:Close() end
-			if (mousebutton =3D=3D 1) then
-				widget.dialog:BringToFront()
-				gui.StartMoveDialog(widget.dialog.rootwidget)
-            end
-	end
-
-	local root =3D dialog.rootwidget
-	MakeBorderGumpPart( root, 2096, (pref.x or 0), (pref.y or 0))
-
-	for k,widget in pairs(dialog.childs) do
-            widget.mbIgnoreMouseOver =3D false
-    end
-    =

-end

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Mon Mar 10 01:44:39 2008
@@ -2,6 +2,48 @@
 -- see also lib.packet.lua and lib.protocol.lua
 -- see also net.mobile.lua, especially kPacket_Equipped_MOB
 -- mobileserial : also known as character/player id
+
+-- Created 08.03.2008 12:25:56, with GumpStudio &amp; Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local playerPaperdoll =3D {}
+playerPaperdoll.dialogId =3D 1234
+playerPaperdoll.x =3D 10
+playerPaperdoll.x =3D 10
+playerPaperdoll.Data =3D
+ &quot;{ page 0 }&quot; ..
+ &quot;{ gumppic 4 4 2000 }&quot; ..
+ &quot;{ button 187 50 2031 2032 1 0 btnhelp }&quot; ..
+ &quot;{ button 187 76 2006 2007 1 0 btnoptions }&quot; ..
+-- &quot;{ croppedtext 36 263 200 40 0 0 paperdollname }&quot; ..
+ &quot;{ text 36 263 0 0 paperdollname }&quot; ..
+ &quot;{ button 84 6 113 113 1 0 btnvirtues }&quot; ..
+ &quot;{ button 187 102 2009 2010 1 0 btnquit }&quot; ..
+ &quot;{ button 187 130 22453 22455 1 0 btnquests }&quot; ..
+ &quot;{ button 187 156 2015 2016 1 0 btnskills }&quot; ..
+ &quot;{ button 187 181 22450 22452 1 0 btnguild }&quot; ..
+ &quot;{ button 187 205 2021 2022 1 0 btnpeace }&quot; ..
+ &quot;{ button 187 233 2027 2028 1 0 btnstatus }&quot;
+playerPaperdoll.textline =3D {
+ [0] =3D &quot;paperdoll_name&quot;,
+}
+-- Created 08.03.2008 12:25:56, with GumpStudio &amp; Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local npcPaperdoll =3D {}
+npcPaperdoll.dialogId =3D 1235
+npcPaperdoll.x =3D 10
+npcPaperdoll.x =3D 10
+npcPaperdoll.Data =3D
+ &quot;{ page 0 }&quot; ..
+ &quot;{ gumppic 4 4 2001 }&quot; ..
+-- &quot;{ croppedtext 36 263 200 40 0 0 paperdollname }&quot; ..
+ &quot;{ text 36 263 0 0 paperdollname }&quot; ..
+ &quot;{ button 187 233 2027 2028 1 0 btnstatus }&quot;
+npcPaperdoll.textline =3D {
+ [0] =3D &quot;paperdoll_name&quot;,
+}
+
+local kGumpBaseId_Male	=3D 50000
+local kGumpBaseId_Female	=3D 60000
 =

 -- WARNING ! this is not a complete list (see gLayerType for that) , e.g. =
kLayer_Mound =3D 0x19 is not in here
 gLayerOrder =3D {
@@ -31,33 +73,167 @@
     hex2num(&quot;0x0F&quot;)
 }
 =

-kGumpBaseId_Male	=3D 50000
-kGumpBaseId_Female	=3D 60000
-
 -- TODO : admin char paperdoll body broken : bodyid,bodygumpid =3D     987=
     0x03db  : body gump id unknown unknown  ( GM admin robe)
 -- TODO : gump.def must be parsed, simple format
 =

 gPaperdolls =3D {}
 =

-
--- called from kPacket_Open_Paperdoll
-function HandleOpenPaperdoll	(paperdoll)
-	paperdoll.mobileserial	=3D paperdoll.serial
-	paperdoll.Close =3D ClosePaperdoll
-	=

-	-- close old paperdoll
-	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
-	if (oldpaperdoll) then oldpaperdoll:Close() end =

-	=

-	-- register paperdoll
-	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
-	=

-	--AddFadeLines(&quot;Open Paperdoll for [&quot;..(paperdoll.mobileserial)..&quot;] &quot;..(p=
aperdoll.name or &quot;&quot;))
-	=

-	RebuildPaperdoll(paperdoll)
-end
-
-
+-- from old iris code, src/gui/Paperdoll.cpp, returns bodygumpid,base_id
+-- base_id is usually 50000 for male and 60000 for female models
+-- TODO : we should put this in a seperate file for easy editing
+-- TODO : maybe this comes from Models.txt
+local function GetPaperdollBodyAndBaseID (bodyid)
+	local bodygumpid =3D nil
+	local base_id =3D kGumpBaseId_Male
+
+	--Human-Male Paperdoll
+	if (bodyid =3D=3D 400 or
+		bodyid =3D=3D 744 or  --Necromancy Transfromed Model
+		bodyid =3D=3D 987)	  --GameMaster v2 + GM Robe should be displayed
+	then
+		bodygumpid =3D hex2num(&quot;0x0C&quot;)
+		base_id =3D kGumpBaseId_Male
+	--Human-Savage_Male
+	elseif (bodyid =3D=3D 183 or
+			bodyid =3D=3D 185 or
+			bodyid =3D=3D 750)
+	then
+		bodygumpid =3D hex2num(&quot;0x79&quot;)
+		base_id =3D kGumpBaseId_Male
+	--Human-Female Paperdoll
+	elseif (bodyid =3D=3D 401 or
+			bodyid =3D=3D 745)  --Necromancy Transfromed Model
+	then
+		bodygumpid =3D hex2num(&quot;0x0D&quot;)
+		base_id =3D kGumpBaseId_Female
+	--Human-Savage_Female
+	elseif (bodyid =3D=3D 184 or
+			bodyid =3D=3D 186 or
+			bodyid =3D=3D 751)
+	then
+		bodygumpid =3D hex2num(&quot;0x78&quot;)
+		base_id =3D kGumpBaseId_Female
+	--Male-Elf Paperdoll
+	elseif (bodyid =3D=3D 605)
+	then
+		bodygumpid =3D hex2num(&quot;0x0E&quot;)
+		base_id =3D kGumpBaseId_Male
+	--Female-Elf Paperdoll
+	elseif (bodyid =3D=3D 606)
+	then
+		bodygumpid =3D hex2num(&quot;0x0F&quot;)
+		base_id =3D kGumpBaseId_Female
+	--Lord British
+	elseif (bodyid =3D=3D 990)
+	then
+		bodygumpid =3D hex2num(&quot;0x3DE&quot;)
+		base_id =3D kGumpBaseId_Male
+	--Blackthorn
+	elseif (bodyid =3D=3D 991)
+	then
+		bodygumpid =3D hex2num(&quot;0x3DF&quot;)
+		base_id =3D kGumpBaseId_Male
+	--Dupre (wrong paperdoll ?!)
+	elseif (bodyid =3D=3D 994)
+	then
+		bodygumpid =3D hex2num(&quot;0x3E2&quot;)
+	--Player Ghosts
+	elseif (bodyid =3D=3D 402 or
+			bodyid =3D=3D 403 or
+			bodyid =3D=3D 607 or
+			bodyid =3D=3D 608 or
+			bodyid =3D=3D 970)
+	then
+		bodygumpid =3D hex2num(&quot;0x3DB&quot;)
+	else
+		-- unknown
+		--bodygumpid =3D hex2num(&quot;0x3DF&quot;)
+	end
+	return bodygumpid,base_id
+end
+
+-- don't call this directly, use RebuildPaperdoll() instead (need to rebui=
ld completely on change because of layerorder)
+local function CreatePaperdollItemWidget(paperdoll,item,base_id)
+	-- item fields : serial artid layer hue (=3D-1 if not set)
+	local dialog =3D paperdoll.dialog
+	local animid =3D nil
+	local typename =3D &quot;&quot;
+	if (gTileTypeLoader) then
+		local t =3D GetStaticTileType(item.artid)
+		if (t and t.miAnimID) then animid =3D t.miAnimID end
+		if (t) then typename =3D t.msName end
+	end
+
+	if (not animid) then
+		print(&quot;WARNING : CreatePaperdollItemWidget : unknown itemtype -&gt; forced =
Crash&quot;)
+		Crash()
+		-- TODO : dummy gfx ?
+	end
+	=

+	-- fallback to female
+	-- TODO : SiENcE : local gumpid =3D animid+50000
+	local gumpid =3D animid+base_id
+	if (GetGumpMat(gumpid) =3D=3D &quot;&quot; and base_id =3D=3D kGumpBaseId_Female) t=
hen gumpid =3D animid+kGumpBaseId_Male end -- fallback to male
+	if (item.layer =3D=3D kLayer_Backpack) then gumpid =3D animid+kGumpBaseId=
_Male end -- no female backpack ;)
+	=

+	--print(&quot;CreatePaperdollItemWidget&quot;,gumpid,item.layer,animid,base_id)
+	local xoff,yoff =3D 9,19
+	local widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, xoff, yoff=
 , 0, 0, 0, item.hue)
+	local bitmask =3D GetGumpBitMask(gumpid)
+	widget:SetBitMask(bitmask)
+	widget.uoPaperdoll =3D paperdoll
+	widget.item =3D item
+	item.widget =3D widget
+	widget.mbIgnoreMouseOver =3D false
+
+	widget.onMouseEnter =3D function () -- item tooltip (clientside,debuginfo=
s)
+							-- TODO : find a cleaner solution to override the mousepick tipp
+							local name =3D GetStaticTileTypeName(item.artid) or &quot;&quot;
+							info =3D sprintf(&quot;equipment %s (artid=3D%04x=3D%d)&quot;,name,item.artid=
,item.artid)
+							--print(&quot;CreatePaperdollItemWidget onMouseEnter &quot;,name,vardump(item=
))
+							-- interesting ? local t =3D GetStaticTileType(item.artid) -- t.miA=
nimID
+							gCurrentRenderer.gMousePickTippOverride =3D info
+							Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
+						end
+
+	widget.onMouseLeave =3D function () =

+		gCurrentRenderer.gMousePickTippOverride =3D false
+		Client_SetBottomLine(&quot;&quot;)
+	end
+	widget.onMouseDown =3D function (widget,mousebutton) end
+	=

+	if (gTooltipSupport) then
+		widget.tooltip_offx =3D kUOToolTippOffX
+		widget.tooltip_offy =3D kUOToolTippOffY
+		widget.stylesetname =3D gGuiDefaultStyleSet
+		widget.on_simple_tooltip =3D function (widget)
+				local  tooltiptext =3D AosToolTip_GetText(widget.item.serial) or &quot;&quot;
+				return (tooltiptext .. &quot; \n &quot;) or &quot;?&quot;
+			end -- add newline, workaround for tooltip sizecalc bug
+	end
+end
+
+-- destroys old widgets if neccessary
+local function DestroyPaperdollItemWidgets (paperdoll) =

+	if (paperdoll.mobile) then
+		for k,item in pairs(GetMobileEquipmentList(paperdoll.mobile)) do
+			if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
+		end
+	end
+end
+
+-- close dialog and destroys all widgets
+local function ClosePaperdoll (paperdoll)
+	if (paperdoll and paperdoll.dialog) then =

+		DestroyPaperdollItemWidgets(paperdoll)
+		paperdoll.dialog:Destroy()
+		paperdoll.dialog =3D nil
+		gPaperdolls[paperdoll.mobileserial] =3D nil
+		-- TODO : send network message ?
+	end
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
 =

 -- rebuild needed on update to have correct layerorder
 -- paperdoll.bIsPlayer (check if is player or npc)
@@ -71,7 +247,18 @@
 	-- create paperdoll dialog if neccessary
 	local dialog =3D paperdoll.dialog
 	if (not dialog) then
-		dialog =3D CreateGumpDlgFromGfm(paperdoll.bIsPlayer and datapath..&quot;gfm/p=
layer_paperdoll.gfm&quot; or datapath..&quot;gfm/npc_paperdoll.gfm&quot;)
+		-- old gfm
+		-- ---------------------------------------------------------------------=
-----
+--		dialog =3D CreateGumpDlgFromGfm(paperdoll.bIsPlayer and datapath..&quot;gfm=
/player_paperdoll.gfm&quot; or datapath..&quot;gfm/npc_paperdoll.gfm&quot;)
+		-- new gumpparser
+		-- ---------------------------------------------------------------------=
-----
+		if (paperdoll.bIsPlayer) then
+			dialog =3D GumpParser( playerPaperdoll, true )
+		else
+			dialog =3D GumpParser( npcPaperdoll, true )
+		end
+		-- ---------------------------------------------------------------------=
-----
+
 		paperdoll.dialog =3D dialog
 		dialog.uoPaperdoll =3D paperdoll
 		dialog.rootwidget.gfx:SetPos(120,100)
@@ -83,7 +270,7 @@
 =

 		if (paperdoll.bIsPlayer) then
 			-- requests VirtuesGump
-			dialog.controls[&quot;btn_virtues&quot;].onMouseDown =3D function (widget,mousebu=
tton)
+			dialog.controls[&quot;btnvirtues&quot;].onMouseDown =3D function (widget,mousebut=
ton)
 														if (mousebutton =3D=3D 1) then
 															widget.gfx:SetMaterial(widget.mat_pressed)
 															print(&quot;btn_virtues,GumpReturnMsg : warning ! playerserial m=
ight be wrong here, usually this param is the gump-serial&quot;)
@@ -92,8 +279,9 @@
 																		  hex2num(&quot;0x00000001&quot;), gPlayerBodySerial)
 														end
 													end
+
 			-- requests AosStats		=

-			dialog.controls[&quot;btn_status&quot;].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls[&quot;btnstatus&quot;].onMouseDown =3D function (widget,mousebutt=
on)
 														if (mousebutton =3D=3D 1) then
 															widget.gfx:SetMaterial(widget.mat_pressed)
 															ToggleStatusAos()
@@ -101,7 +289,7 @@
 													end
 =

 			-- request QuestGump (must be supported by Serversidegumps)
-			dialog.controls[&quot;btn_quests&quot;].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls[&quot;btnquests&quot;].onMouseDown =3D function (widget,mousebutt=
on)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																Send_AOSCommand(kPacket_AOS_Command_QuestGumpRequest,gPlay=
erBodySerial)
@@ -109,7 +297,7 @@
 														end
 =

 			-- request GuildGump (must be supported by Serversidegumps)
-			dialog.controls[&quot;btn_guild&quot;].onMouseDown =3D function (widget,mousebutt=
on)
+			dialog.controls[&quot;btnguild&quot;].onMouseDown =3D function (widget,mousebutto=
n)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																Send_AOSCommand(kPacket_AOS_Command_GuildGumpRequest,gPlay=
erBodySerial)
@@ -117,7 +305,7 @@
 														end
 =

 			-- request Warmode and change the Peace/Warmode Button visual
-			dialog.controls[&quot;btn_peace&quot;].onMouseDown =3D function (widget,mousebutt=
on)
+			dialog.controls[&quot;btnpeace&quot;].onMouseDown =3D function (widget,mousebutto=
n)
 															if (gActWarmode=3D=3DgWarmode_Normal) then
 																widget.mat_normal 	=3D GetGumpMat(hex2num(&quot;0x7E8&quot;))
 																widget.mat_pressed 	=3D GetGumpMat(hex2num(&quot;0x7E9&quot;))
@@ -133,42 +321,42 @@
 															end
 														end
 			-- request HelpGump (must be supported by Serversidegumps)
-			dialog.controls[&quot;btn_help&quot;].onMouseDown =3D function (widget,mousebutto=
n)
+			dialog.controls[&quot;btnhelp&quot;].onMouseDown =3D function (widget,mousebutton)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																Send_RequestHelp()
 															end
 														end
 			-- request skill gump
-			dialog.controls[&quot;btn_skills&quot;].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls[&quot;btnskills&quot;].onMouseDown =3D function (widget,mousebutt=
on)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																ToggleSkill()
 															end
 														end
-			dialog.controls[&quot;btn_quit&quot;].onMouseDown =3D function (widget,mousebutto=
n)
+			dialog.controls[&quot;btnquit&quot;].onMouseDown =3D function (widget,mousebutton)
 															if (mousebutton =3D=3D 1) then
 																OpenQuit()
 															end
 														end
-			dialog.controls[&quot;btn_scroll&quot;].onMouseDown =3D function (widget,mousebut=
ton)
-															if (mousebutton =3D=3D 1) then
-																AddFadeLines(&quot;btn_scroll&quot;)
-															end
-														end
-			dialog.controls[&quot;btn_party&quot;].onMouseDown =3D function (widget,mousebutt=
on)
-															if (mousebutton =3D=3D 1) then
-																AddFadeLines(&quot;btn_party&quot;)
-															end
-														end
-			dialog.controls[&quot;btn_specialAbilities&quot;].onMouseDown =3D function (widge=
t,mousebutton)
-															if (mousebutton =3D=3D 1) then
-																AddFadeLines(&quot;btn_specialAbilities&quot;)
-															end
-														end
-			--  TODO : btn_quit
+--			dialog.controls[&quot;btnscroll&quot;].onMouseDown =3D function (widget,mousebu=
tton)
+--															if (mousebutton =3D=3D 1) then
+--																AddFadeLines(&quot;btn_scroll&quot;)
+--															end
+--														end
+--			dialog.controls[&quot;btnparty&quot;].onMouseDown =3D function (widget,mousebut=
ton)
+--															if (mousebutton =3D=3D 1) then
+--																AddFadeLines(&quot;btn_party&quot;)
+--															end
+--														end
+--			dialog.controls[&quot;btnspecialAbilities&quot;].onMouseDown =3D function (widg=
et,mousebutton)
+--															if (mousebutton =3D=3D 1) then
+--																AddFadeLines(&quot;btn_specialAbilities&quot;)
+--															end
+--														end
+
 		else
-			dialog.controls[&quot;btn_status&quot;].onMouseDown =3D function (widget,mousebut=
ton)
+			dialog.controls[&quot;btnstatus&quot;].onMouseDown =3D function (widget,mousebutt=
on)
 															if (mousebutton =3D=3D 1) then
 																widget.gfx:SetMaterial(widget.mat_pressed)
 																OpenStatus(widget.dialog.uoPaperdoll.mobile)
@@ -177,10 +365,10 @@
 		end
 		for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
 	end
-	=

+
 	-- visually change the Peace/Warmode Button when opening the Paperdoll
 	if (gActWarmode=3D=3DgWarmode_Combat) then
-		local widget =3D dialog.controls[&quot;btn_peace&quot;]
+		local widget =3D dialog.controls[&quot;btnpeace&quot;]
 		if (widget) then
 			widget.mat_normal 	=3D GetGumpMat(hex2num(&quot;0x7E8&quot;))
 			widget.mat_pressed 	=3D GetGumpMat(hex2num(&quot;0x7E9&quot;))
@@ -192,10 +380,10 @@
 	local r,g,b =3D GetNotorietyColor(paperdoll.mobile.notoriety)
 =

 	-- update paperdoll name
-	dialog.controls[&quot;status_name&quot;].gfx:SetCharHeight(gFontGumpSize + 2)
-	dialog.controls[&quot;status_name&quot;].gfx:SetColour( {r,g,b,1.0} )
-	dialog.controls[&quot;status_name&quot;].gfx:SetFont(gFontNameDefault)
-	dialog.controls[&quot;status_name&quot;].gfx:SetText(paperdoll.name)
+	dialog.controls[&quot;paperdollname&quot;].gfx:SetCharHeight(gFontGumpSize + 2)
+	dialog.controls[&quot;paperdollname&quot;].gfx:SetColour( {r,g,b,1.0} )
+	dialog.controls[&quot;paperdollname&quot;].gfx:SetFont(gFontNameDefault)
+	dialog.controls[&quot;paperdollname&quot;].gfx:SetText(paperdoll.name)
 =

 	-- remove old item widgets
 	DestroyPaperdollItemWidgets(paperdoll)
@@ -233,93 +421,11 @@
 	end
 end
 =

--- don't call this directly, use RebuildPaperdoll() instead (need to rebui=
ld completely on change because of layerorder)
-function CreatePaperdollItemWidget(paperdoll,item,base_id)
-	-- item fields : serial artid layer hue (=3D-1 if not set)
-	local dialog =3D paperdoll.dialog
-	local animid =3D nil
-	local typename =3D &quot;&quot;
-	if (gTileTypeLoader) then
-		local t =3D GetStaticTileType(item.artid)
-		if (t and t.miAnimID) then animid =3D t.miAnimID end
-		if (t) then typename =3D t.msName end
-	end
-
-	if (not animid) then
-		print(&quot;WARNING : CreatePaperdollItemWidget : unknown itemtype -&gt; forced =
Crash&quot;)
-		Crash()
-		-- TODO : dummy gfx ?
-	end
-	=

-	-- fallback to female
-	-- TODO : SiENcE : local gumpid =3D animid+50000
-	local gumpid =3D animid+base_id
-	if (GetGumpMat(gumpid) =3D=3D &quot;&quot; and base_id =3D=3D kGumpBaseId_Female) t=
hen gumpid =3D animid+kGumpBaseId_Male end -- fallback to male
-	if (item.layer =3D=3D kLayer_Backpack) then gumpid =3D animid+kGumpBaseId=
_Male end -- no female backpack ;)
-	=

-	--print(&quot;CreatePaperdollItemWidget&quot;,gumpid,item.layer,animid,base_id)
-	local xoff,yoff =3D 9,19
-	local widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, xoff, yoff=
 , 0, 0, 0, item.hue)
-	local bitmask =3D GetGumpBitMask(gumpid)
-	widget:SetBitMask(bitmask)
-	widget.uoPaperdoll =3D paperdoll
-	widget.item =3D item
-	item.widget =3D widget
-	widget.mbIgnoreMouseOver =3D false
-
-	widget.onMouseEnter =3D function () -- item tooltip (clientside,debuginfo=
s)
-							-- TODO : find a cleaner solution to override the mousepick tipp
-							local name =3D GetStaticTileTypeName(item.artid) or &quot;&quot;
-							info =3D sprintf(&quot;equipment %s (artid=3D%04x=3D%d)&quot;,name,item.artid=
,item.artid)
-							--print(&quot;CreatePaperdollItemWidget onMouseEnter &quot;,name,vardump(item=
))
-							-- interesting ? local t =3D GetStaticTileType(item.artid) -- t.miA=
nimID
-							gCurrentRenderer.gMousePickTippOverride =3D info
-							Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
-						end
-
-	widget.onMouseLeave =3D function () =

-		gCurrentRenderer.gMousePickTippOverride =3D false
-		Client_SetBottomLine(&quot;&quot;)
-	end
-	widget.onMouseDown =3D function (widget,mousebutton) end
-	=

-	if (gTooltipSupport) then
-		widget.tooltip_offx =3D kUOToolTippOffX
-		widget.tooltip_offy =3D kUOToolTippOffY
-		widget.stylesetname =3D gGuiDefaultStyleSet
-		widget.on_simple_tooltip =3D function (widget)
-				local  tooltiptext =3D AosToolTip_GetText(widget.item.serial) or &quot;&quot;
-				return (tooltiptext .. &quot; \n &quot;) or &quot;?&quot;
-			end -- add newline, workaround for tooltip sizecalc bug
-	end
-end
-
-
--- destroys old widgets if neccessary
-function DestroyPaperdollItemWidgets (paperdoll) =

-	if (paperdoll.mobile) then
-		for k,item in pairs(GetMobileEquipmentList(paperdoll.mobile)) do
-			if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
-		end
-	end
-end
-
 -- triggered by mobile destruction
 function DestroyPaperdollByMobileSerial (serial)
 	local paperdoll =3D gPaperdolls[serial]
 	if (not paperdoll) then return end
 	ClosePaperdoll(paperdoll)
-end
-
--- close dialog and destroys all widgets
-function ClosePaperdoll (paperdoll)
-	if (paperdoll and paperdoll.dialog) then =

-		DestroyPaperdollItemWidgets(paperdoll)
-		paperdoll.dialog:Destroy()
-		paperdoll.dialog =3D nil
-		gPaperdolls[paperdoll.mobileserial] =3D nil
-		-- TODO : send network message ?
-	end
 end
 =

 -- TODO : Clean
@@ -347,80 +453,20 @@
 	end
 end
 =

--- from old iris code, src/gui/Paperdoll.cpp, returns bodygumpid,base_id
--- base_id is usually 50000 for male and 60000 for female models
--- TODO : we should put this in a seperate file for easy editing
--- TODO : maybe this comes from Models.txt
-function GetPaperdollBodyAndBaseID (bodyid)
-	local bodygumpid =3D nil
-	local base_id =3D kGumpBaseId_Male
-
-	--Human-Male Paperdoll
-	if (bodyid =3D=3D 400 or
-		bodyid =3D=3D 744 or  --Necromancy Transfromed Model
-		bodyid =3D=3D 987)	  --GameMaster v2 + GM Robe should be displayed
-	then
-		bodygumpid =3D hex2num(&quot;0x0C&quot;)
-		base_id =3D kGumpBaseId_Male
-	--Human-Savage_Male
-	elseif (bodyid =3D=3D 183 or
-			bodyid =3D=3D 185 or
-			bodyid =3D=3D 750)
-	then
-		bodygumpid =3D hex2num(&quot;0x79&quot;)
-		base_id =3D kGumpBaseId_Male
-	--Human-Female Paperdoll
-	elseif (bodyid =3D=3D 401 or
-			bodyid =3D=3D 745)  --Necromancy Transfromed Model
-	then
-		bodygumpid =3D hex2num(&quot;0x0D&quot;)
-		base_id =3D kGumpBaseId_Female
-	--Human-Savage_Female
-	elseif (bodyid =3D=3D 184 or
-			bodyid =3D=3D 186 or
-			bodyid =3D=3D 751)
-	then
-		bodygumpid =3D hex2num(&quot;0x78&quot;)
-		base_id =3D kGumpBaseId_Female
-	--Male-Elf Paperdoll
-	elseif (bodyid =3D=3D 605)
-	then
-		bodygumpid =3D hex2num(&quot;0x0E&quot;)
-		base_id =3D kGumpBaseId_Male
-	--Female-Elf Paperdoll
-	elseif (bodyid =3D=3D 606)
-	then
-		bodygumpid =3D hex2num(&quot;0x0F&quot;)
-		base_id =3D kGumpBaseId_Female
-	--Lord British
-	elseif (bodyid =3D=3D 990)
-	then
-		bodygumpid =3D hex2num(&quot;0x3DE&quot;)
-		base_id =3D kGumpBaseId_Male
-	--Blackthorn
-	elseif (bodyid =3D=3D 991)
-	then
-		bodygumpid =3D hex2num(&quot;0x3DF&quot;)
-		base_id =3D kGumpBaseId_Male
-	--Dupre (wrong paperdoll ?!)
-	elseif (bodyid =3D=3D 994)
-	then
-		bodygumpid =3D hex2num(&quot;0x3E2&quot;)
-	--Player Ghosts
-	elseif (bodyid =3D=3D 402 or
-			bodyid =3D=3D 403 or
-			bodyid =3D=3D 607 or
-			bodyid =3D=3D 608 or
-			bodyid =3D=3D 970)
-	then
-		bodygumpid =3D hex2num(&quot;0x3DB&quot;)
-	else
-		-- unknown
-		--bodygumpid =3D hex2num(&quot;0x3DF&quot;)
-	end
-	return bodygumpid,base_id
-end
-
+-- called from kPacket_Open_Paperdoll
+function HandleOpenPaperdoll	(paperdoll)
+	paperdoll.mobileserial	=3D paperdoll.serial
+	paperdoll.Close =3D ClosePaperdoll
+	=

+	-- close old paperdoll
+	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
+	if (oldpaperdoll) then oldpaperdoll:Close() end =

+	=

+	-- register paperdoll
+	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
+	=

+	RebuildPaperdoll(paperdoll)
+end
 =

 --[[
 =


Modified: trunk/lua/gui/gui.status.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.status.lua (original)
+++ trunk/lua/gui/gui.status.lua Mon Mar 10 01:44:39 2008
@@ -1,3 +1,60 @@
+-- Created 09.03.2008 15:05:13, with GumpStudio &amp; Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local statusGump =3D {}
+statusGump.dialogId =3D 1234
+statusGump.x =3D 0
+statusGump.y =3D 0
+statusGump.Data =3D
+	 &quot;{ page 0 }&quot; ..
+	 &quot;{ gumppic 0 0 10860 }&quot; ..
+	 &quot;{ text 54 44 0 0 statusname }&quot; ..
+	 &quot;{ text 88 71 0 1 statusstr }&quot; ..
+	 &quot;{ text 88 99 0 2 statusdex }&quot; ..
+	 &quot;{ text 87 127 0 3 statusint }&quot; ..
+	 &quot;{ text 147 67 0 4 statushits }&quot; ..
+	 &quot;{ text 147 77 0 5 statusmaxhits }&quot; ..
+	 &quot;{ text 219 71 0 6 statusstatcap }&quot; ..
+	 &quot;{ text 277 70 0 7 statusminmaxdamage }&quot; ..
+	 &quot;{ text 147 94 0 8 statusstamina }&quot; ..
+	 &quot;{ text 147 105 0 9 statusmaxstamina }&quot; ..
+	 &quot;{ text 148 122 0 10 statusmana }&quot; ..
+	 &quot;{ text 148 133 0 11 statusmaxmana }&quot; ..
+	 &quot;{ text 218 99 0 12 statusluck }&quot; ..
+	 &quot;{ text 212 121 0 13 statusweight }&quot; ..
+	 &quot;{ text 212 132 0 14 statusmaxweight }&quot; ..
+	 &quot;{ text 282 99 0 15 statusgold }&quot; ..
+	 &quot;{ text 289 127 0 16 statuspets }&quot; ..
+	 &quot;{ text 352 70 0 17 statusarmor }&quot; ..
+	 &quot;{ text 351 85 0 18 statusfireres }&quot; ..
+	 &quot;{ text 353 100 0 19 statuscoldres }&quot; ..
+	 &quot;{ text 353 114 0 20 statuspoisres }&quot; ..
+	 &quot;{ text 352 129 0 21 statusenergres }&quot;
+	 =

+statusGump.textline =3D {
+	[0] =3D &quot;status_name&quot;,
+	[1] =3D &quot;status_str&quot;,
+	[2] =3D &quot;status_dex&quot;,
+	[3] =3D &quot;status_int&quot;,
+	[4] =3D &quot;status_hits&quot;,
+	[5] =3D &quot;status_maxhits&quot;,
+	[6] =3D &quot;status_statcap&quot;,
+	[7] =3D &quot;status_minmaxdamage&quot;,
+	[8] =3D &quot;status_stamina&quot;,
+	[9] =3D &quot;status_maxstamina&quot;,
+	[10] =3D &quot;status_mana&quot;,
+	[11] =3D &quot;status_maxmana&quot;,
+	[12] =3D &quot;status_luck&quot;,
+	[13] =3D &quot;status_weight&quot;,
+	[14] =3D &quot;status_maxweight&quot;,
+	[15] =3D &quot;status_gold&quot;,
+	[16] =3D &quot;status_pets&quot;,
+	[17] =3D &quot;status_armor&quot;,
+	[18] =3D &quot;status_fireres&quot;,
+	[19] =3D &quot;status_coldres&quot;,
+	[20] =3D &quot;status_poisres&quot;,
+	[21] =3D &quot;status_energres&quot;,
+}
+
 -- toggles the display of the extended aos stats
 gStatusAosDialog_LastPositionX =3D nil
 gStatusAosDialog_LastPositionY =3D nil
@@ -18,8 +75,10 @@
 	else
 		-- request stats update of player body
 		if gPlayerBodySerial then Send_ClientQuery(gRequest_States,gPlayerBodySe=
rial) end
-	=

-		gStatusAosDialog =3D CreateGumpDlgFromGfm(datapath..&quot;gfm/status_aos.gfm&quot;)
+
+		-- old gfm file
+		-- gStatusAosDialog =3D CreateGumpDlgFromGfm(datapath..&quot;gfm/status_aos.g=
fm&quot;)
+		gStatusAosDialog =3D GumpParser( statusGump, true )
 =

 		-- restore last positoin if available
 		if gStatusAosDialog_LastPositionX and gStatusAosDialog_LastPositionY the=
n gStatusAosDialog.rootwidget.gfx:SetPos(gStatusAosDialog_LastPositionX, gS=
tatusAosDialog_LastPositionY) end
@@ -42,14 +101,14 @@
 				if m and m.stats then
 					local s =3D m.stats
 					=

-					local l =3D {	str =3D &quot;status_str&quot;, dex =3D &quot;status_dex&quot;, int =3D &quot;st=
atus_int&quot;,
-								curHits =3D &quot;status_hits&quot;, 		maxHits =3D &quot;status_maxhits&quot;,
-								curMana =3D &quot;status_mana&quot;, 		maxMana =3D &quot;status_maxmana&quot;,
-								curStamina =3D &quot;status_stamina&quot;, 	maxStamina =3D &quot;status_maxstamin=
a&quot;,
-								luck =3D &quot;status_luck&quot;, 			gold =3D &quot;status_gold&quot;,
-								armor =3D &quot;status_armor&quot;, 		statcap =3D &quot;status_statcap&quot;, fireresi=
st =3D &quot;status_fireres&quot;,
-								coldresist =3D &quot;status_coldres&quot;, 	poisonresist =3D &quot;status_poisres=
&quot;,
-								energyresist =3D &quot;status_energres&quot; }
+					local l =3D {	str =3D &quot;statusstr&quot;, dex =3D &quot;statusdex&quot;, int =3D &quot;stat=
usint&quot;,
+								curHits =3D &quot;statushits&quot;, 		maxHits =3D &quot;statusmaxhits&quot;,
+								curMana =3D &quot;statusmana&quot;, 		maxMana =3D &quot;statusmaxmana&quot;,
+								curStamina =3D &quot;statusstamina&quot;, 	maxStamina =3D &quot;statusmaxstamina&quot;,
+								luck =3D &quot;statusluck&quot;, 			gold =3D &quot;statusgold&quot;,
+								armor =3D &quot;statusarmor&quot;, 		statcap =3D &quot;statusstatcap&quot;, fireresist=
 =3D &quot;statusfireres&quot;,
+								coldresist =3D &quot;statuscoldres&quot;, 	poisonresist =3D &quot;statuspoisres&quot;,
+								energyresist =3D &quot;statusenergres&quot; }
 =

 					-- set all textfields (single)
 					for k,v in pairs(l) do
@@ -61,40 +120,40 @@
 =

 					-- set name
 					if m.name then
-						dialog.controls[&quot;status_name&quot;].gfx:SetCharHeight(gFontGumpSize)
-						dialog.controls[&quot;status_name&quot;].gfx:SetColour({r,g,b,1.0})
-						dialog.controls[&quot;status_name&quot;].gfx:SetFont(gFontNameDefault)
-						dialog.controls[&quot;status_name&quot;].gfx:SetText(m.name)
+						dialog.controls[&quot;statusname&quot;].gfx:SetCharHeight(gFontGumpSize)
+						dialog.controls[&quot;statusname&quot;].gfx:SetColour({r,g,b,1.0})
+						dialog.controls[&quot;statusname&quot;].gfx:SetFont(gFontNameDefault)
+						dialog.controls[&quot;statusname&quot;].gfx:SetText(m.name)
 					else
-						dialog.controls[&quot;status_name&quot;].gfx:SetCharHeight(gFontGumpSize)
-						dialog.controls[&quot;status_name&quot;].gfx:SetColour({r,g,b,1.0})
-						dialog.controls[&quot;status_name&quot;].gfx:SetFont(gFontNameDefault)
-						dialog.controls[&quot;status_name&quot;].gfx:SetText(&quot;?&quot;)
+						dialog.controls[&quot;statusname&quot;].gfx:SetCharHeight(gFontGumpSize)
+						dialog.controls[&quot;statusname&quot;].gfx:SetColour({r,g,b,1.0})
+						dialog.controls[&quot;statusname&quot;].gfx:SetFont(gFontNameDefault)
+						dialog.controls[&quot;statusname&quot;].gfx:SetText(&quot;?&quot;)
 					end
 =

 					-- multi part textfields, like &quot;10 / 20&quot;
 					-- pets
 					if s[&quot;curPet&quot;] and s[&quot;maxPet&quot;] then =

-						dialog.controls[&quot;status_pets&quot;].gfx:SetText(s[&quot;curPet&quot;]..&quot;/&quot;..s[&quot;maxP=
et&quot;]) =

-					else dialog.controls[&quot;status_pets&quot;].gfx:SetText(&quot;?&quot;) end =

+						dialog.controls[&quot;statuspets&quot;].gfx:SetText(s[&quot;curPet&quot;]..&quot;/&quot;..s[&quot;maxPe=
t&quot;]) =

+					else dialog.controls[&quot;statuspets&quot;].gfx:SetText(&quot;?&quot;) end =

 					-- damage
 					if s[&quot;minDamage&quot;] and s[&quot;maxDamage&quot;] then =

-						dialog.controls[&quot;status_minmaxdamage&quot;].gfx:SetText(s[&quot;minDamage&quot;]..&quot;=
-&quot;..s[&quot;maxDamage&quot;]) =

-					else dialog.controls[&quot;status_minmaxdamage&quot;].gfx:SetText(&quot;?&quot;) end =

+						dialog.controls[&quot;statusminmaxdamage&quot;].gfx:SetText(s[&quot;minDamage&quot;]..&quot;-=
&quot;..s[&quot;maxDamage&quot;]) =

+					else dialog.controls[&quot;statusminmaxdamage&quot;].gfx:SetText(&quot;?&quot;) end =

 					-- weight
 					if s[&quot;curWeight&quot;] then =

 						if s[&quot;maxWeight&quot;] then =

 							-- max weight given
-							dialog.controls[&quot;status_weight&quot;].gfx:SetText(s[&quot;curWeight&quot;])
-							dialog.controls[&quot;status_maxweight&quot;].gfx:SetText(s[&quot;maxWeight&quot;])
+							dialog.controls[&quot;statusweight&quot;].gfx:SetText(s[&quot;curWeight&quot;])
+							dialog.controls[&quot;statusmaxweight&quot;].gfx:SetText(s[&quot;maxWeight&quot;])
 						else =

 							-- no maxweight present
-							dialog.controls[&quot;status_weight&quot;].gfx:SetText(s[&quot;curWeight&quot;]) =

+							dialog.controls[&quot;statusweight&quot;].gfx:SetText(s[&quot;curWeight&quot;]) =

 							-- hardcoded fallback: 40 + floor(str*35/10)
-							dialog.controls[&quot;status_maxweight&quot;].gfx:SetText(&quot;&quot;..
+							dialog.controls[&quot;statusmaxweight&quot;].gfx:SetText(&quot;&quot;..
 								(40 + math.floor(s[&quot;str&quot;]*35/10)))
 						end
-					else dialog.controls[&quot;status_weight&quot;].gfx:SetText(&quot;?&quot;) end =

+					else dialog.controls[&quot;statusweight&quot;].gfx:SetText(&quot;?&quot;) end =

 				end
 			end
 		end

Modified: trunk/lua/lib.gui.iris.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gui.iris.lua (original)
+++ trunk/lua/lib.gui.iris.lua Mon Mar 10 01:44:39 2008
@@ -1,3 +1,37 @@
+-- Created 09.03.2008 16:33:50, with GumpStudio &amp; Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local healthbarGump =3D {}
+healthbarGump.dialogId =3D 1234
+healthbarGump.x =3D 0
+healthbarGump.y =3D 0
+healthbarGump.Data =3D
+	 &quot;{ page 0 }&quot; ..
+	 &quot;{ gumppic 0 0 2051 statusbar }&quot; ..
+	 &quot;{ gumppic 35 11 2053 }&quot; ..
+	 &quot;{ gumppic 35 25 2053 }&quot; ..
+	 &quot;{ gumppic 35 39 2053 }&quot; ..
+	 &quot;{ gumppic 35 11 2054 hitsbar }&quot; ..
+	 &quot;{ gumppic 35 25 2054 manabar }&quot; ..
+	 &quot;{ gumppic 35 39 2054 stambar }&quot;
+healthbarGump.textline =3D {
+}
+
+-- Created 09.03.2008 16:52:23, with GumpStudio &amp; Iris2 Lua Export Plugin
+-- Exported Iris2 GumpExporter ver 1.0.
+local npchealthGump =3D {}
+npchealthGump.dialogId =3D 1234
+npchealthGump.x =3D 0
+npchealthGump.y =3D 0
+npchealthGump.Data =3D
+	 &quot;{ page 0 }&quot; ..
+	 &quot;{ gumppic 0 0 2052 statusbar }&quot; ..
+	 &quot;{ gumppic 35 38 2053 }&quot; ..
+	 &quot;{ gumppic 35 38 2054 hitsbar }&quot; ..
+	 &quot;{ text 20 10 0 0 npcname }&quot;
+npchealthGump.textline =3D {
+	[0] =3D &quot;npc_name&quot;,
+}
+
 gui =3D gui or {}
 gui.bMouseBlocked =3D false
 =

@@ -97,7 +131,7 @@
 		-- find player status dialog
 		local dialog =3D gStatusDialogs[gPlayerBodySerial]
 =

-		local widget =3D dialog.controls and dialog.controls[&quot;status_bar&quot;]
+		local widget =3D dialog.controls and dialog.controls[&quot;statusbar&quot;]
 		if (widget) then
 			local mat =3D GetGumpMat(warmode =3D=3D gWarmode_Normal and gWargump_No=
rmal or gWargump_Combat)
 			widget.mat_over =3D mat
@@ -145,15 +179,16 @@
 =

 -- Open Status Gump
 function OpenStatus (mobile,x,y)
-	-- set default parameter
-	x =3D x or 10
-	y =3D y or 60
-	=

 	if mobile =3D=3D nil then return end
 	if (gStatusDialogs[mobile.serial]) then return end -- already open =

 	=

-	local dialog =3D CreateGumpDlgFromGfm(IsPlayerMobile(mobile) and datapath=
..&quot;gfm/healthbar.gfm&quot; or datapath..&quot;gfm/healthbar_npc.gfm&quot;)
-	=

+	--local dialog =3D CreateGumpDlgFromGfm(IsPlayerMobile(mobile) and datapa=
th..&quot;gfm/healthbar.gfm&quot; or datapath..&quot;gfm/healthbar_npc.gfm&quot;)
+	local dialog =3D GumpParser( IsPlayerMobile(mobile) and healthbarGump or =
npchealthGump, true )
+
+	-- set default parameter
+	x =3D x or healthbarGump.x
+	y =3D y or healthbarGump.y
+
 	-- widgets in this dialog handle mouse
 	for k,v in pairs(dialog.childs) do v.mbIgnoreMouseOver =3D false end
 	=

@@ -169,10 +204,10 @@
 	local r,g,b =3D GetNotorietyColor(mobile.notoriety)
 =

 	if not(IsPlayerMobile(mobile)) then
-		dialog.controls[&quot;npc_name&quot;].gfx:SetCharHeight(gFontGumpSize)
-		dialog.controls[&quot;npc_name&quot;].gfx:SetColour({r,g,b,1.0})
-		dialog.controls[&quot;npc_name&quot;].gfx:SetFont(gFontNameDefault)
-		dialog.controls[&quot;npc_name&quot;].gfx:SetText(mobile.name)
+		dialog.controls[&quot;npcname&quot;].gfx:SetCharHeight(gFontGumpSize)
+		dialog.controls[&quot;npcname&quot;].gfx:SetColour({r,g,b,1.0})
+		dialog.controls[&quot;npcname&quot;].gfx:SetFont(gFontNameDefault)
+		dialog.controls[&quot;npcname&quot;].gfx:SetText(mobile.name)
 	end
 =

 	gStatusDialogs[mobile.serial] =3D dialog

Modified: trunk/lua/lib.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gumpparser.lua (original)
+++ trunk/lua/lib.gumpparser.lua Mon Mar 10 01:44:39 2008
@@ -145,13 +145,13 @@
 	dialog:Close()
 end
 =

-function GumpParser(Gumpdata)
+function GumpParser(Gumpdata, Clientsidemode)
 	local htext_correction=3D5
 =

 	if (not gGumpLoader) then return end
 =

 	-- close already existing dialog with the same id
-	if gServerSideGump[Gumpdata.dialogId] then
+	if not(Clientsidemode) and gServerSideGump[Gumpdata.dialogId] then
 		CloseServerSideGump(Gumpdata.playerid, Gumpdata.dialogId, 0)
 	end
 =

@@ -296,12 +296,12 @@
 			--				Optionaly there is a color parameter. =

 			-- TODO : HUE
 			elseif ((command =3D=3D &quot;gumppic&quot;) and (table.getn(bToken)&gt;=3D 4)) then
-				local huenumber=3DbToken[6] or 0
+				local huenumber =3D 0
+				if (bToken[5] =3D=3D hue) then huenumber=3DbToken[6] end
 				local widget =3D MakeBorderGumpPart( curparent, bToken[4], bToken[2], =
bToken[3], 0, 0, 0, tonumber(huenumber) )
 				widget.mbIgnoreMouseOver =3D false
-				if (bToken[8]) then
-					printdebug(&quot;gump&quot;,&quot;gumppic class=3D&quot;..bToken[8])
-				end
+				if (Clientsidemode) then if (bToken[5]) then dialog.controls[bToken[5]=
] =3D widget end end
+				--if (bToken[8]) then printdebug(&quot;gump&quot;,&quot;gumppic class=3D&quot;..bToken[8])=
 end
 			--gumppictiled &lt;x&gt; &lt;y&gt; &lt;width&gt; &lt;height&gt; &lt;gumpid&gt;
 			--Description:  Similar to GumpPic, but the gumppic is tiled to the giv=
en &lt;height&gt; and &lt;width&gt;.
 			elseif ((command =3D=3D &quot;gumppictiled&quot;) and (table.getn(bToken)&gt;=3D 6))=
 then
@@ -311,31 +311,42 @@
 			--Description:  Creates a transparent rectangle on position &lt;x,y&gt; using=
 &lt;width&gt; and &lt;height&gt;.
 			elseif ((command =3D=3D &quot;checkertrans&quot;) and (table.getn(bToken)&gt;=3D 5))=
 then
 				printdebug(&quot;gump&quot;,&quot;todo - checkertrans&quot;)
+				-- TODO : set correct Alpha Value
+				--SetDialogAlpha(dialog, 1.0)
 			--text &lt;x&gt; &lt;y&gt; &lt;hue&gt; &lt;textline-id&gt;
 			--Description:  Defines the position and color of a text (data) entry.
 			-- TODO : HUE-color
 			elseif ((command =3D=3D &quot;text&quot;) and (table.getn(bToken)&gt;=3D 5)) then
 				local text =3D Gumpdata.textline[tonumber(bToken[5])] or &quot;No text&quot;
+
 				local widget =3D guimaker.MakeText (curparent, bToken[2], bToken[3]+ht=
ext_correction, UnicodeFix(text),
 													gFontGumpSize, {190/255,237/255,231/255,1.0}, gFontNameDefaul=
t)
+
+				if (Clientsidemode) then if (bToken[6]) then dialog.controls[bToken[6]=
] =3D widget end end
 			--Button &lt;x&gt; &lt;y&gt; &lt;released-id&gt; &lt;pressed-id&gt; &lt;quit&gt; &lt;page-id&gt; &lt;return-va=
lue&gt;
 			--Description:  Adds a button to the gump with the specified coordinate=
s and button graphics.
 			--				&lt;released-id&gt; and &lt;pressed-id&gt; specify the buttongraphic. If pres=
sed check for &lt;return-value&gt;.
 			--				Use &lt;page-id&gt; to switch between pages and &lt;quit&gt;=3D1/0 to close t=
he gump.
 			elseif ((command =3D=3D &quot;button&quot;) and (table.getn(bToken)&gt;=3D 7)) then	=
-- &gt;=3D7 because pol buttons returns 7 or 8 arguments
 				local widget =3D MakeGumpButton (curparent,bToken[4],bToken[4],bToken[=
5],bToken[2],bToken[3],nil,nil,false)
-				if (bToken[8]) then widget.returnmsg =3D tonumber(bToken[8]) end
+				if (bToken[8]) then widget.returnmsg =3D bToken[8] end
 				widget.page			=3D tonumber(bToken[7])
-				widget.onLeftClick =3D function (widget)
-										if (widget.page &gt; 0 and not(widget.page &gt; table.getn(pages)) ) t=
hen
-											printdebug(&quot;gump&quot;,&quot;Parsegump Button: Switch to Page &quot;..widget.p=
age..&quot;/&quot;..table.getn(pages))
-											widget.dialog:ShowPage(widget.page)
-										elseif (widget.returnmsg) then
-											printdebug(&quot;gump&quot;,&quot;Button pressed -&gt; Send button return_message=
:<i> &quot;..widget.returnmsg)
</I>-											GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.retu=
rnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
-											widget.dialog:Close()
+
+				if (Clientsidemode) then
+					dialog.controls[widget.returnmsg] =3D widget
+				else
+					widget.onLeftClick =3D function (widget)
+											if (widget.page &gt; 0 and not(widget.page &gt; table.getn(pages)) ) =
then
+												printdebug(&quot;gump&quot;,&quot;Parsegump Button: Switch to Page &quot;..widget.=
page..&quot;/&quot;..table.getn(pages))
+												widget.dialog:ShowPage(widget.page)
+											elseif (widget.returnmsg) then
+												printdebug(&quot;gump&quot;,&quot;Button pressed -&gt; Send button return_messag=
e: &quot;..widget.returnmsg)
+												GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
+												widget.dialog:Close()
+											end
 										end
-									end
+				end
+
 			--buttontileart &lt;x&gt; &lt;y&gt; &lt;released-id&gt; &lt;pressed-id&gt; &lt;quit&gt; &lt;page-id&gt; &lt;re=
turn-value&gt; &lt;tilepic-id&gt; &lt;hue&gt; &lt;tile-x&gt; &lt;tile-y&gt;
 			--Client introduced: between 4.0.4d and 5.0.2b
 			--Description:  Adds a button to the gump with the specified coordinate=
s and tilepic as graphic.
@@ -346,18 +357,21 @@
 				local widgetart =3D MakeArtGumpPart (curparent,bToken[9],bToken[2]+bTo=
ken[11],bToken[3]+bToken[12],0,0,0,bToken[10])
 				if (bToken[8]) then widget.returnmsg =3D tonumber(bToken[8]) end
 				widget.page			=3D tonumber(bToken[7])
-				widget.onLeftClick =3D function (widget)
-										if (widget.returnmsg) then
-											printdebug(&quot;gump&quot;,&quot;Button pressed -&gt; Send buttontileart return_=
message: &quot;..widget.returnmsg)
-											GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.retu=
rnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
+
+				if not(Clientsidemode) then
+					widget.onLeftClick =3D function (widget)
+											if (widget.returnmsg) then
+												printdebug(&quot;gump&quot;,&quot;Button pressed -&gt; Send buttontileart return=
_message: &quot;..widget.returnmsg)
+												GumpReturnMsg(Gumpdata.playerid, Gumpdata.dialogId, widget.ret=
urnmsg, ServerSideGump_GetParams(Gumpdata.dialogId))
+											end
+											if (widget.page &gt; 0 and not(widget.page &gt; table.getn(pages)) ) =
then
+												printdebug(&quot;gump&quot;,&quot;Parsegump Button: Switch to Page &quot;..widget.=
page..&quot;/&quot;..table.getn(pages))
+												widget.dialog:ShowPage(widget.page)
+											else
+												widget.dialog:Close()
+											end
 										end
-										if (widget.page &gt; 0 and not(widget.page &gt; table.getn(pages)) ) t=
hen
-											printdebug(&quot;gump&quot;,&quot;Parsegump Button: Switch to Page &quot;..widget.p=
age..&quot;/&quot;..table.getn(pages))
-											widget.dialog:ShowPage(widget.page)
-										else
-											widget.dialog:Close()
-										end
-									end
+				end
 			--textentry &lt;x&gt; &lt;y&gt; &lt;width&gt; &lt;height&gt; &lt;hue&gt; &lt;return-value&gt; &lt;default-text=
-id&gt;
 			--Description:  Defines an area where the &lt;default-text-id&gt; is displaye=
d.
 			--				The player can modify this data. To get this data check the &lt;retu=
rn-value&gt;.
@@ -370,16 +384,18 @@
 				widget.mbIgnoreMouseOver =3D false
 				widget.returnmsg =3D tonumber(bToken[7])
 				widget.returndefid =3D tonumber(bToken[8])
-				widget.onMouseDown =3D function (widget,mousebutton)
-											if (mousebutton =3D=3D 1) then
-												widget:Activate()
+
+				if not(Clientsidemode) then
+					widget.onMouseDown =3D function (widget,mousebutton)
+												if (mousebutton =3D=3D 1) then
+													widget:Activate()
+												end
+										   end
+					widget.onMouseLeave =3D function (widget)
+												widget:Deactivate()
 											end
-									   end
-				widget.onMouseLeave =3D function (widget)
-											widget:Deactivate()
-										end
+				end
 				table.insert(dialog.uo_text,widget)
-					=

 			--tilepic &lt;x&gt; &lt;y&gt; &lt;id&gt;
 			--Description:  Adds a Tilepicture to the gump. &lt;id&gt; defines the tile g=
raphic-id.
 			elseif ((command =3D=3D &quot;tilepic&quot;) and (table.getn(bToken)&gt;=3D4)) then
@@ -398,6 +414,7 @@
 				local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2]=
, bToken[3]+htext_correction,
 																bToken[4], bToken[5], UnicodeFix(msg.text), msg.charh, {92=
/255,92/255,178/255,1.0},
 																msg.center, msg.div, gFontNameDefault)
+				if (Clientsidemode) then if (bToken[8]) then dialog.controls[bToken[8]=
] =3D widget end end
 			--radio &lt;x&gt; &lt;y&gt; &lt;released gumpid&gt; &lt;pressed gumpid&gt; &lt;status&gt; &lt;return-val=
ue&gt;
 			--Description:  Same as Checkbox, but only one Radiobutton can be press=
ed at the same time, except they are per linked via the 'Group' command.
 			-- TODO : make radio buttons work
@@ -421,18 +438,21 @@
 				widget.mat_pressed 	=3D GetGumpMat(radio_down)
 =

 				table.insert(dialog.uo_radio,widget)
-				widget.onMouseDown	=3D function (widget,mousebutton)
-										if (mousebutton =3D=3D 1) then
-											if (widget.state=3D=3D0) then
-												widget.gfx:SetMaterial(widget.mat_pressed)
-												widget.state=3D1
-											else
-												widget.gfx:SetMaterial(widget.mat_normal)
-												widget.state=3D0
+
+				if not(Clientsidemode) then
+					widget.onMouseDown	=3D function (widget,mousebutton)
+											if (mousebutton =3D=3D 1) then
+												if (widget.state=3D=3D0) then
+													widget.gfx:SetMaterial(widget.mat_pressed)
+													widget.state=3D1
+												else
+													widget.gfx:SetMaterial(widget.mat_normal)
+													widget.state=3D0
+												end
+												printdebug(&quot;gump&quot;,&quot;RadioButton changed : id=3D&quot;..widget.return=
msg..&quot; state=3D&quot;..widget.state)
 											end
-											printdebug(&quot;gump&quot;,&quot;RadioButton changed : id=3D&quot;..widget.returnm=
sg..&quot; state=3D&quot;..widget.state)
-										end
-									  end
+										  end
+				end
 			--checkbox &lt;x&gt; &lt;y&gt; &lt;released-id&gt; &lt;pressed-id&gt; &lt;status&gt; &lt;return-value&gt;
 			--Description:  Adds a CheckBox to the gump. Multiple CheckBoxes can be=
 pressed at the same time.
 			--				Check the &lt;return-value&gt; if you want to know which CheckBoxes wer=
e selected.
@@ -456,18 +476,20 @@
 				widget.mat_pressed 	=3D GetGumpMat(check_down)
 				table.insert(dialog.uo_check,widget)
 =

-				widget.onMouseDown	=3D function (widget,mousebutton)
-										if (mousebutton =3D=3D 1) then
-											if (widget.state=3D=3D0) then
-												widget.gfx:SetMaterial(widget.mat_pressed)
-												widget.state=3D1
-											else
-												widget.gfx:SetMaterial(widget.mat_normal)
-												widget.state=3D0
+				if not(Clientsidemode) then
+					widget.onMouseDown	=3D function (widget,mousebutton)
+											if (mousebutton =3D=3D 1) then
+												if (widget.state=3D=3D0) then
+													widget.gfx:SetMaterial(widget.mat_pressed)
+													widget.state=3D1
+												else
+													widget.gfx:SetMaterial(widget.mat_normal)
+													widget.state=3D0
+												end
+												printdebug(&quot;gump&quot;,&quot;Checkbox changed : id=3D&quot;..widget.returnmsg=
..&quot; state=3D&quot;..widget.state)
 											end
-											printdebug(&quot;gump&quot;,&quot;Checkbox changed : id=3D&quot;..widget.returnmsg.=
.&quot; state=3D&quot;..widget.state)
-										end
-									  end
+										  end
+				end
 			--HtmlGump &lt;x&gt; &lt;y&gt; &lt;width&gt; &lt;height&gt; &lt;text-id&gt; &lt;background&gt; &lt;scrollbar&gt;
 			--Description:  Defines a text-area where Html-commands are allowed.
 			--				&lt;background&gt; and &lt;scrollbar&gt; can be 0 or 1 and define whether the=
 background is transparent and a scrollbar is displayed.
@@ -500,11 +522,12 @@
 		printdebug(&quot;gump&quot;,&quot;ServerSideGump page &quot;,page.pagenum,&quot; childs: &quot;,myc)
 	end
 =

-	gServerSideGump[Gumpdata.dialogId] =3D dialog
-
-	-- hide all except page 0 and 1
-	dialog:ShowPage(1)
-	=

-	-- TODO : set correct Alpha Value
-	--SetDialogAlpha(dialog, 1.0)
+	if not(Clientsidemode) then
+		gServerSideGump[Gumpdata.dialogId] =3D dialog
+	=

+		-- hide all except page 0 and 1
+		dialog:ShowPage(1)
+	else
+		return dialog
+	end
 end

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Mon Mar 10 01:44:39 2008
@@ -71,35 +71,6 @@
 		 end end end)
 	=

 		Bind(&quot;f2&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then
--- Created 05.03.2008 15:55:43, with GumpStudio &amp; Iris2 Lua Export Plugin
--- Exported Iris2 GumpExporter ver 1.0.
-local manualGump =3D {}
-manualGump.dialogId =3D 1234
-manualGump.x =3D 10
-manualGump.x =3D 10
-manualGump.Data =3D
-	 &quot;{ page 0 }&quot; ..
-	 &quot;{ gumppic 4 4 2000  }&quot; ..
-	 &quot;{ gumppic 10 17 12  }&quot; ..
-	 &quot;{ button 187 50 2031 2032 1 0 0 }&quot; ..
-	 &quot;{ button 187 76 2006 2007 1 0 0 }&quot; ..
-	 &quot;{ text 36 271 0 0 }&quot; ..
-	 &quot;{ button 84 6 113 113 1 0 0 }&quot; ..
-	 &quot;{ button 187 102 2009 2010 1 0 0 }&quot; ..
-	 &quot;{ button 187 130 22453 22455 1 0 0 }&quot; ..
-	 &quot;{ button 187 156 2015 2016 1 0 0 }&quot; ..
-	 &quot;{ button 187 181 22450 22452 1 0 0 }&quot; ..
-	 &quot;{ button 187 205 2021 2022 1 0 0 }&quot; ..
-	 &quot;{ button 187 233 2027 2028 1 0 0 }&quot; ..
-	 &quot;&quot; =

-manualGump.textline =3D {
-	[0] =3D &quot;status_name&quot;,
-}
-
-GumpParser( manualGump )
-
-
---[[
 			local mobile =3D GetPlayerMobile()
 			if mobile then
 				local effect =3D {}
@@ -117,7 +88,6 @@
 				effect.itemid =3D 119--hex2num(&quot;0x376A&quot;)
 				gCurrentRenderer:AddEffect(effect)
 			end
-]]--
 		end end end)
 	end
 end

Modified: trunk/lua/obj/obj.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.container.lua (original)
+++ trunk/lua/obj/obj.container.lua Mon Mar 10 01:44:39 2008
@@ -18,7 +18,6 @@
 function gContainerPrototype:GetContent () return self.content end
 =

 function gContainerPrototype:DestroyContent ()
-	--print(&quot;gContainerPrototype:DestroyContent&quot;,self,self.serial,_TRACEBACK(=
))
 	for serial,object in pairs(self.content) do object:Destroy() end
 	self.content =3D {}
 	self:UpdateContent()
@@ -36,8 +35,72 @@
 	self:UpdateContent()
 end
 =

+-- ----------------------------------------------- container prototype ---=
--------------------------
+
+local function DestroyContainerItemWidgets (container) =

+	for k,item in pairs(container:GetContent()) do
+		if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
+	end
+end
+
+-- create graphical representation (use only if container dialog is alread=
y visible)
+local function MakeContainerItemWidget (item)
+	local parent =3D item.container.dialog.rootwidget
+	local widget =3D nil
+
+	-- If it's not an ART-gfx to display -&gt; Display GUMP-gfx
+	if (item.usegump=3D=3Dtrue) then
+		widget =3D MakeBorderGumpPart (parent,item.artid,item.xloc,item.yloc + i=
tem.gumpyoffset)
+
+		widget.mbIgnoreMouseOver =3D false
+		widget.uoContainer =3D item.container
+		widget.item =3D item
+		item.widget =3D widget
+
+		widget.onMouseLeave =3D function () gCurrentRenderer.gMousePickTippOverr=
ide =3D false end
+		widget.onMouseDown	=3D function (widget,mousebutton) end
+	else
+		widget =3D MakeArtGumpPart (parent,item.artid,item.xloc,item.yloc,0,0,0,=
item.hue)
+		=

+		-- for exact mousepicking
+		widget:SetBitMask( GetArtBitMask(item.artid + hex2num(&quot;0x4000&quot;)) )
+
+		widget.mbIgnoreMouseOver =3D false
+		widget.uoContainer =3D item.container
+		widget.item =3D item
+		item.widget =3D widget
+
+		-- item debuginfo on mouseover (clientside,debuginfos)
+		widget.onMouseLeave =3D function () =

+			gCurrentRenderer.gMousePickTippOverride =3D false =

+			Client_SetBottomLine(&quot;&quot;)
+		end
+		widget.onMouseDown	=3D function (widget,mousebutton) end
+		widget.onMouseEnter =3D function ()
+			-- TODO : find a cleaner solution to override the mousepick tipp
+			local item =3D widget.item
+			local name =3D GetStaticTileTypeName(item.artid) or &quot;&quot;
+			info =3D sprintf(&quot;item %s amount=3D%d (artid=3D%04x=3D%d)&quot;,name,item.am=
ount,item.artid,item.artid)
+			gCurrentRenderer.gMousePickTippOverride =3D info
+			Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
+		end
+	end
+
+	if (gTooltipSupport and widget) then
+		widget.tooltip_offx =3D kUOToolTippOffX
+		widget.tooltip_offy =3D kUOToolTippOffY
+		widget.stylesetname =3D gGuiDefaultStyleSet
+		widget.on_simple_tooltip =3D function (widget) =

+				local tooltiptext =3D AosToolTip_GetText(widget.item.serial) or &quot;&quot;
+				return (tooltiptext .. &quot; \n &quot;) or &quot;?&quot; =

+			end -- add newline, workaround for tooltip sizecalc bug
+	end
+end
+
+-- ----------------------------------------------- End of local functions =
-----------------------------
+
 -- called from kPacket_Equip_Item
-function HandleEquipItem	(dynamicdata)
+function HandleEquipItem (dynamicdata)
 	local mobile =3D GetMobile(dynamicdata.iContainerSerial)
 	if (not mobile) then =

 		print(&quot;WARNING ! mobile update for unknown mobile received, update lost =
!&quot;)
@@ -63,13 +126,17 @@
 	return container and (container.dialog)
 end
 =

+-- destroys old widgets and creates new ones from contents
+function RefreshContainerItemWidgets (container) =

+	if (container.dialog) then
+		DestroyContainerItemWidgets(container)
+		for k,item in pairs(container:GetContent()) do MakeContainerItemWidget(i=
tem) end
+	end
+end
 =

 -- called from kPacket_Open_Container
 function HandleOpenContainer	(containerdata)
 	if (not gGumpLoader) then return end
-	--containerdata.serial
-	--containerdata.gumpid
-	--print(&quot;# HandleOpenContainer&quot;,containerdata.serial,containerdata.gumpid)
 	=

 	--Ignore Shop container - created somewhere else
 	if (containerdata.gumpid =3D=3D kGumpIDShopContainer) then
@@ -99,7 +166,6 @@
 	=

 	-- 0x003c =3D backpack
 	-- 0x0030 =3D shopcontainer
-	--AddFadeLines(sprintf(&quot;Open_Container gumpid=3D%d&quot;,container.gumpid))
 	if (not container.dialog) then
 		-- create dialog from scratch
 		local dialog =3D guimaker.MakeSortedDialog()
@@ -125,7 +191,7 @@
 -- dialog is only created when it is displayed, on kPacket_Open_Container
 -- TODO : check if iContainerSerial is secure trade serial
 -- TODO : check if spellbook
-
+-- destroys old widgets if neccessary
 =

 function CloseContainer (serial) =

 	local container =3D GetContainer(serial)
@@ -149,247 +215,141 @@
 	return container
 end
 =

--- destroys old widgets if neccessary
-function DestroyContainerItemWidgets (container) =

-	for k,item in pairs(container:GetContent()) do
-		if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
-	end
-end
-
--- destroys old widgets and creates new ones from contents
-function RefreshContainerItemWidgets (container) =

-	if (container.dialog) then
-		DestroyContainerItemWidgets(container)
-		for k,item in pairs(container:GetContent()) do MakeContainerItemWidget(i=
tem) end
-	end
-end
-
-
-function ScanItemPropBoolean	(props,line,pattern,field) end
-function ScanItemPropNumber		(props,line,pattern,field) end
-
-gItemPropAOS =3D {
-	{&quot;^luck (%d+)&quot;								,{0}		,&quot;luck&quot;				},	=

-	{&quot;^lower reagent cost (%d+)%%&quot;				,{0}		,&quot;lrc&quot;				},	=

-	{&quot;^lower mana cost (%d+)%%&quot;					,{0}		,&quot;lmc&quot;				},	=

-	{&quot;^defense chance increase (%d+)%%&quot;			,{0}		,&quot;dci&quot;				},	=

-	{&quot;^hit chance increase (%d+)%%&quot;				,{0}		,&quot;hci&quot;				},	=

-	{&quot;^skillbonus_sum&quot;							,0			,&quot;skillbonus_sum&quot;	},-- dummy entry, pattern=
 will never match
-	{&quot;^faster cast recovery (%d+)&quot;				,{0}		,&quot;fastcastrecov&quot;	},	=

-	{&quot;^faster casting (%d+)&quot;					,{0}		,&quot;fastcast&quot;			},	=

-	{&quot;^mage armor&quot;								,false		,&quot;magearmor&quot;		},	=

-	{&quot;^\&quot;Maximum sockets allowed is (%d+).\&quot;&quot;	,{0}		,&quot;maxsocket&quot;		},	=

-	{&quot;^mana regeneration (%d+)&quot;					,{0}		,&quot;manareg&quot;			},	=

-	{&quot;^mana increase (%d+)&quot;						,{0}		,&quot;manainc&quot;			},	=

-	{&quot;^damage increase (%d+)%%&quot;					,{0}		,&quot;dmginc&quot;			},	=

-	{&quot;^spell damage increase (%d+)%%&quot;			,{0}		,&quot;sdi&quot;				},	=

-	{&quot;^strength bonus (%d+)&quot;					,{0}		,&quot;bonusstr&quot;			},	=

-	{&quot;^dexterity bonus (%d+)&quot;					,{0}		,&quot;bonusdex&quot;			},	=

-	{&quot;^intelligence bonus (%d+)&quot;				,{0}		,&quot;bonusint&quot;			},	=

-	{&quot;^&lt;b&gt;Insured&lt;/b&gt;&quot;							,false		,&quot;insured&quot;			},	=

-	{&quot;^self repair (%d+)%%&quot;						,{0}		,&quot;selfrepair&quot;		},	=

-	{&quot;^enhance potions (%d+)%%&quot;					,{0}		,&quot;enhancepotion&quot;	},	=

-	{&quot;^hit point regeneration (%d+)&quot;			,{0}		,&quot;hpreg&quot;			},	=

-	{&quot;^hit point increase (%d+)&quot;				,{0}		,&quot;hpinc&quot;			},	=

-	{&quot;^physical resist (%d+)%%&quot;					,{0}		,&quot;resistphysical&quot;	},	=

-	{&quot;^poison resist (%d+)%%&quot;					,{0}		,&quot;resistpoison&quot;		},	=

-	{&quot;^cold resist (%d+)%%&quot;						,{0}		,&quot;resistcold&quot;		},	=

-	{&quot;^fire resist (%d+)%%&quot;						,{0}		,&quot;resistfire&quot;		},	=

-	{&quot;^energy resist (%d+)%%&quot;					,{0}		,&quot;resistenergy&quot;		},	=

-	{&quot;^strength requirement (%d+)&quot;				,{0}		,&quot;strengthreq&quot;		},
-	{&quot;^durability (%d+) / (%d+)&quot;				,{0,0}		,&quot;durability&quot;		},
-	{&quot;^Weight: (%d+) stones&quot;					,{0}		,&quot;weight&quot;			},	=

-	{&quot;^night sight&quot;								,false		,&quot;nightsight&quot;		},
-}
-	=

---[[
-crafted by Lady Smya,lower requirements 90%,stamina regeneration 2,durabil=
ity 20%,
-reflect physical damage 3%,
-crafted by Lady Smya,reflect physical damage 15%,self repair 3,durability =
20%,
-lower requirements 50%,reflect physical damage 6%,self repair 3,spell chan=
neling,durability 20%,
-physical damage 100%,weapon damage 16 - 17,weapon speed 29,two-handed weap=
on,skill required: swordsmanship,
-hit life leech 6%,physical damage 100%,weapon damage 16 - 18,weapon speed =
25,range 10,two-handed weapon,skill required: archery,&quot;1 Sockets. 1 availab=
le.,Maximum sockets allowed is 2.&quot;,Quiver using: Normal,
-hit cold area 10%,hit dispel 10%,hit lower attack 10%,hit mana leech 10%,p=
hysical damage 100%,weapon damage 11 - 13,weapon speed 47,two-handed weapon=
,skill required: mace fighting,
-lower requirements 40%,physical damage 100%,weapon damage 14 - 16,weapon s=
peed 37,two-handed weapon,skill required: fencing,
-lower requirements 20%,physical damage 100%,weapon damage 19 - 20,weapon s=
peed 22,range 8,two-handed weapon,skill required: archery,Quiver using: Nor=
mal,
-faster casting -1,reflect physical damage 3%,spell channeling,
-hit life leech 24%,hit lightning 6%,hit lower attack 6%,swing speed increa=
se 15%,physical damage 100%,weapon damage 14 - 15,weapon speed 33,one-hande=
d weapon,skill required: swordsmanship,
-hit lower attack 14%,hit mana leech 10%,lower requirements 30%,physical da=
mage 100%,weapon damage 11 - 13,weapon speed 46,one-handed weapon,skill req=
uired: swordsmanship,
-
-physical damage 100%,weapon damage 15 - 17,weapon speed 33,two-handed weap=
on,skill required: mace fighting,
-Weapon: +2 Leech Mana, +2 Leech Life,Armor: +1 Mana Regen, +1 Hits Regen,C=
reature: +20 Hits,
-repond slayer,swing speed increase 10%,physical damage 100%,weapon damage =
15 - 17,weapon speed 28,one-handed weapon,skill required: swordsmanship,
-mage weapon -28 skill,physical damage 100%,weapon damage 15 - 17,weapon sp=
eed 33,two-handed weapon,skill required: swordsmanship,
-
-]]--
-
-
-function countmatches (text,searchpattern)
-	local counter =3D 0
-	for w in string.gmatch(text,searchpattern) do counter =3D counter + 1 end
-	return counter
-end
-			=

-function DebugDumpContainerContentInfo ()
+--[[
+function ScanItemPropBoolean	(props,line,pattern,field) end
+function ScanItemPropNumber		(props,line,pattern,field) end
+
+gItemPropAOS =3D {
+	{&quot;^luck (%d+)&quot;								,{0}		,&quot;luck&quot;				},	=

+	{&quot;^lower reagent cost (%d+)%%&quot;				,{0}		,&quot;lrc&quot;				},	=

+	{&quot;^lower mana cost (%d+)%%&quot;					,{0}		,&quot;lmc&quot;				},	=

+	{&quot;^defense chance increase (%d+)%%&quot;			,{0}		,&quot;dci&quot;				},	=

+	{&quot;^hit chance increase (%d+)%%&quot;				,{0}		,&quot;hci&quot;				},	=

+	{&quot;^skillbonus_sum&quot;							,0			,&quot;skillbonus_sum&quot;	},-- dummy entry, pattern=
 will never match
+	{&quot;^faster cast recovery (%d+)&quot;				,{0}		,&quot;fastcastrecov&quot;	},	=

+	{&quot;^faster casting (%d+)&quot;					,{0}		,&quot;fastcast&quot;			},	=

+	{&quot;^mage armor&quot;								,false		,&quot;magearmor&quot;		},	=

+	{&quot;^\&quot;Maximum sockets allowed is (%d+).\&quot;&quot;	,{0}		,&quot;maxsocket&quot;		},	=

+	{&quot;^mana regeneration (%d+)&quot;					,{0}		,&quot;manareg&quot;			},	=

+	{&quot;^mana increase (%d+)&quot;						,{0}		,&quot;manainc&quot;			},	=

+	{&quot;^damage increase (%d+)%%&quot;					,{0}		,&quot;dmginc&quot;			},	=

+	{&quot;^spell damage increase (%d+)%%&quot;			,{0}		,&quot;sdi&quot;				},	=

+	{&quot;^strength bonus (%d+)&quot;					,{0}		,&quot;bonusstr&quot;			},	=

+	{&quot;^dexterity bonus (%d+)&quot;					,{0}		,&quot;bonusdex&quot;			},	=

+	{&quot;^intelligence bonus (%d+)&quot;				,{0}		,&quot;bonusint&quot;			},	=

+	{&quot;^&lt;b&gt;Insured&lt;/b&gt;&quot;							,false		,&quot;insured&quot;			},	=

+	{&quot;^self repair (%d+)%%&quot;						,{0}		,&quot;selfrepair&quot;		},	=

+	{&quot;^enhance potions (%d+)%%&quot;					,{0}		,&quot;enhancepotion&quot;	},	=

+	{&quot;^hit point regeneration (%d+)&quot;			,{0}		,&quot;hpreg&quot;			},	=

+	{&quot;^hit point increase (%d+)&quot;				,{0}		,&quot;hpinc&quot;			},	=

+	{&quot;^physical resist (%d+)%%&quot;					,{0}		,&quot;resistphysical&quot;	},	=

+	{&quot;^poison resist (%d+)%%&quot;					,{0}		,&quot;resistpoison&quot;		},	=

+	{&quot;^cold resist (%d+)%%&quot;						,{0}		,&quot;resistcold&quot;		},	=

+	{&quot;^fire resist (%d+)%%&quot;						,{0}		,&quot;resistfire&quot;		},	=

+	{&quot;^energy resist (%d+)%%&quot;					,{0}		,&quot;resistenergy&quot;		},	=

+	{&quot;^strength requirement (%d+)&quot;				,{0}		,&quot;strengthreq&quot;		},
+	{&quot;^durability (%d+) / (%d+)&quot;				,{0,0}		,&quot;durability&quot;		},
+	{&quot;^Weight: (%d+) stones&quot;					,{0}		,&quot;weight&quot;			},	=

+	{&quot;^night sight&quot;								,false		,&quot;nightsight&quot;		},
+}
+
+local function countmatches (text,searchpattern)
+	local counter =3D 0
+	for w in string.gmatch(text,searchpattern) do counter =3D counter + 1 end
+	return counter
+end
+		=

+local function DebugDumpContainerContentInfo ()
 	print(&quot;DebugDumpContainerContentInfo&quot;)
 	local container =3D gLastDebugContainer  =

 	if (not container) then return end
-	local fp =3D io.open(&quot;myitems.csv&quot;,&quot;a&quot;)
-	=

-	local csvout =3D &quot;name;type&quot;
-	for k1,arr in pairs(gItemPropAOS) do =

-		local infopattern,defaultval,propfield =3D unpack(arr)
-		csvout =3D csvout..&quot;;&quot;..propfield
-	end
-	csvout =3D csvout..&quot;;&quot;..&quot;rest&quot;
-	fp:write(csvout..&quot;\n&quot;)
+	local fp =3D io.open(&quot;myitems.csv&quot;,&quot;a&quot;)
+	=

+	local csvout =3D &quot;name;type&quot;
+	for k1,arr in pairs(gItemPropAOS) do =

+		local infopattern,defaultval,propfield =3D unpack(arr)
+		csvout =3D csvout..&quot;;&quot;..propfield
+	end
+	csvout =3D csvout..&quot;;&quot;..&quot;rest&quot;
+	fp:write(csvout..&quot;\n&quot;)
 	=

 	for k,item in pairs(container:GetContent()) do =

 		local name =3D GetStaticTileTypeName(item.artid) or &quot;&quot;
-		local tooltiptext =3D AosToolTip_GetText(item.serial) or &quot;&quot;
-		local props =3D {rest=3D&quot;&quot;,skillbonus_sum=3D0,skillbonus=3D{}}
-		=

-		for k,line in pairs(strsplit(&quot;\n&quot;,tooltiptext)) do
-			if (k =3D=3D 1) then =

-				props.name =3D line
-			else
-				-- try to match all known property format strings
-				local found =3D false
-				for k1,arr in pairs(gItemPropAOS) do =

-					local infopattern,defaultval,propfield =3D unpack(arr)
-					local p0,p1,a,b =3D string.find(line,infopattern)
-					if (p0) then -- only happens for one of the patterns
-						found =3D true
-						props[propfield] =3D {a,b}
-					end
-				end
-				=

-				-- check for skillbonus like &quot;Peacemaking +7&quot;
-				local p0,p1,skillname,bonus =3D string.find(line,&quot;^([%w ]+) %+(%d+)&quot;)
-				if (skillname) then
-					--found =3D true   -- just count, but also mention in &quot;rest&quot;
-					props.skillbonus_sum =3D props.skillbonus_sum + tonumber(bonus)
-					props.skillbonus[skillname] =3D bonus
-					=

-				end
-				=

-				-- if unknown prop, append to props.rest
-				if (not found) then props.rest =3D props.rest .. line .. &quot;,&quot; end
-			end
-		end
-		=

-		local bInteresting =3D false
-		if (tonumber(props.skillbonus[&quot;Animal Taming&quot;] or 0) &gt;=3D 10) then bInte=
resting =3D true end
-		if (props.lrc and tonumber(props.lrc[1]) &gt;=3D 14) then bInteresting =3D =
true end
-		if (props.luck and tonumber(props.luck[1]) &gt;=3D 85) then bInteresting =
=3D true end
-		if (bInteresting) then =

-			print(&quot;interesting item found, moving to backpack&quot;)
-			local amount =3D 1
-			local itemserial =3D item.serial
-			local x,y,z =3D 0,0,0
-			local containerserial =3D gPlayerBackPack and gPlayerBackPack.serial
-			if (containerserial) then
-				print(&quot;grab&quot;,itemserial,containerserial)
-				Send_Take_Object(itemserial,amount)
-				Client_USleep(500)
-				Send_Drop_Object(itemserial,x,y,z,containerserial)
-				Client_USleep(1000)
-			else 	=

-				print(&quot;error, backpack not found&quot;)
-			end
-		end
-		=

---~ 		print(props.rest)
-		=

-		local layer =3D GetPaperdollLayerFromTileType(item.artid) or 0
-		=

-		local csvout =3D props.name..&quot;;&quot;..layer
-		for k1,arr in pairs(gItemPropAOS) do =

-			local infopattern,defaultval,propfield =3D unpack(arr)
-			local val =3D props[propfield] or defaultval
-			if (val and type(val) =3D=3D &quot;number&quot;) then  -- 0 : skillbonus sum
-				val =3D val
-			elseif (val and val[2]) then =

-				val =3D val[1]..&quot;/&quot;..val[2] =

-			elseif (val and val[1]) then =

-				val =3D val[1]
-			elseif (val and type(val) =3D=3D &quot;table&quot;) then  -- {} : &quot;yes&quot;, etc for =
nightsight,magearmor : match without params
-				val =3D &quot;ja&quot;
-			else
-				val =3D &quot;nein&quot;
-			end
-			csvout =3D csvout..&quot;;&quot;..val
-		end
+		local tooltiptext =3D AosToolTip_GetText(item.serial) or &quot;&quot;
+		local props =3D {rest=3D&quot;&quot;,skillbonus_sum=3D0,skillbonus=3D{}}
+		=

+		for k,line in pairs(strsplit(&quot;\n&quot;,tooltiptext)) do
+			if (k =3D=3D 1) then =

+				props.name =3D line
+			else
+				-- try to match all known property format strings
+				local found =3D false
+				for k1,arr in pairs(gItemPropAOS) do =

+					local infopattern,defaultval,propfield =3D unpack(arr)
+					local p0,p1,a,b =3D string.find(line,infopattern)
+					if (p0) then -- only happens for one of the patterns
+						found =3D true
+						props[propfield] =3D {a,b}
+					end
+				end
+				=

+				-- check for skillbonus like &quot;Peacemaking +7&quot;
+				local p0,p1,skillname,bonus =3D string.find(line,&quot;^([%w ]+) %+(%d+)&quot;)
+				if (skillname) then
+					--found =3D true   -- just count, but also mention in &quot;rest&quot;
+					props.skillbonus_sum =3D props.skillbonus_sum + tonumber(bonus)
+					props.skillbonus[skillname] =3D bonus
+					=

+				end
+				=

+				-- if unknown prop, append to props.rest
+				if (not found) then props.rest =3D props.rest .. line .. &quot;,&quot; end
+			end
+		end
+		=

+		local bInteresting =3D false
+		if (tonumber(props.skillbonus[&quot;Animal Taming&quot;] or 0) &gt;=3D 10) then bInte=
resting =3D true end
+		if (props.lrc and tonumber(props.lrc[1]) &gt;=3D 14) then bInteresting =3D =
true end
+		if (props.luck and tonumber(props.luck[1]) &gt;=3D 85) then bInteresting =
=3D true end
+		if (bInteresting) then =

+			print(&quot;interesting item found, moving to backpack&quot;)
+			local amount =3D 1
+			local itemserial =3D item.serial
+			local x,y,z =3D 0,0,0
+			local containerserial =3D gPlayerBackPack and gPlayerBackPack.serial
+			if (containerserial) then
+				print(&quot;grab&quot;,itemserial,containerserial)
+				Send_Take_Object(itemserial,amount)
+				Client_USleep(500)
+				Send_Drop_Object(itemserial,x,y,z,containerserial)
+				Client_USleep(1000)
+			else 	=

+				print(&quot;error, backpack not found&quot;)
+			end
+		end
+		=

+		local layer =3D GetPaperdollLayerFromTileType(item.artid) or 0
+		=

+		local csvout =3D props.name..&quot;;&quot;..layer
+		for k1,arr in pairs(gItemPropAOS) do =

+			local infopattern,defaultval,propfield =3D unpack(arr)
+			local val =3D props[propfield] or defaultval
+			if (val and type(val) =3D=3D &quot;number&quot;) then  -- 0 : skillbonus sum
+				val =3D val
+			elseif (val and val[2]) then =

+				val =3D val[1]..&quot;/&quot;..val[2] =

+			elseif (val and val[1]) then =

+				val =3D val[1]
+			elseif (val and type(val) =3D=3D &quot;table&quot;) then  -- {} : &quot;yes&quot;, etc for =
nightsight,magearmor : match without params
+				val =3D &quot;ja&quot;
+			else
+				val =3D &quot;nein&quot;
+			end
+			csvout =3D csvout..&quot;;&quot;..val
+		end
 		csvout =3D csvout..&quot;;&quot;..props.rest
 		fp:write(csvout..&quot;\n&quot;)
 	end
 	fp:close()
 end
-
--- TODO use lib.gfm.lua : MakeArtGumpPart ?
--- create graphical representation (use only if container dialog is alread=
y visible)
-function MakeContainerItemWidget (item)
-	local parent =3D item.container.dialog.rootwidget
-	local iArtID =3D item.artid + hex2num(&quot;0x4000&quot;)
-	local x,y =3D item.xloc,item.yloc
-	local widget =3D nil
-
-	-- If it's not an ART-gfx to display -&gt; Display GUMP-gfx
-	if (item.usegump=3D=3Dtrue) then
-		widget =3D MakeBorderGumpPart (parent,item.artid,x,y + item.gumpyoffset)
-
-		widget.mbIgnoreMouseOver =3D false
-		widget.uoContainer =3D item.container
-		widget.item =3D item
-		item.widget =3D widget
-
-		widget.onMouseLeave =3D function () gCurrentRenderer.gMousePickTippOverr=
ide =3D false end
-		widget.onMouseDown	=3D function (widget,mousebutton) end
-	else
-		local mat =3D GetArtMat(iArtID,item.hue)
-		if ((not mat) or mat =3D=3D &quot;&quot;) then
-			print(&quot;WARNING ! MakeContainerItemWidget : material load failed for art=
id=3D&quot;, iArtID)
-		else
-			local bitmask =3D GetArtBitMask(iArtID)
-			local w,h =3D GetArtSize(iArtID,item.hue)
-			widget =3D guimaker.MakePlane(parent,mat,x,y,w,h)
-			local tw,th =3D texsize(w),texsize(h)
-			widget.gfx:SetUV(0,(0)/th,w/tw,(h+0)/th)
-			widget:SetBitMask(bitmask)
-			widget.mbIgnoreMouseOver =3D false
-			widget.uoContainer =3D item.container
-			widget.item =3D item
-			item.widget =3D widget
-		=

-			-- item debuginfo on mouseover (clientside,debuginfos)
-			widget.onMouseLeave =3D function () =

-				gCurrentRenderer.gMousePickTippOverride =3D false =

-				Client_SetBottomLine(&quot;&quot;)
-			end
-			widget.onMouseDown	=3D function (widget,mousebutton) end
-			widget.onMouseEnter =3D function ()
-				-- TODO : find a cleaner solution to override the mousepick tipp
-				local item =3D widget.item
-				local name =3D GetStaticTileTypeName(item.artid) or &quot;&quot;
-				info =3D sprintf(&quot;item %s amount=3D%d (artid=3D%04x=3D%d)&quot;,name,item.a=
mount,item.artid,item.artid)
-				gCurrentRenderer.gMousePickTippOverride =3D info
-				Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
-			end
-		end
-	end
-
-	if (gTooltipSupport) then
-		widget.tooltip_offx =3D kUOToolTippOffX
-		widget.tooltip_offy =3D kUOToolTippOffY
-		widget.stylesetname =3D gGuiDefaultStyleSet
-		widget.on_simple_tooltip =3D function (widget) =

-				local tooltiptext =3D AosToolTip_GetText(widget.item.serial) or &quot;&quot;
-				return (tooltiptext .. &quot; \n &quot;) or &quot;?&quot; =

-			end -- add newline, workaround for tooltip sizecalc bug
-	end
-end
-
-
-
-
-
+]]--


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000759.html">[Iris-commit] [IRIS] r1947 - in /trunk: data/models/materials/textures.material data/skippedfallbacks.lua lua/filter/filter.art.lua lua/main.lua
</A></li>
	<LI>Next message: <A HREF="000761.html">[Iris-commit] [IRIS] r1949 - in /trunk: data/config.lua.dist include/builder.h include/data.h lua/lib.loading.lua lua/lib.unifont.lua lua/main.lua src/builder.cpp src/data.cpp src/data_L.cpp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#760">[ date ]</a>
              <a href="thread.html#760">[ thread ]</a>
              <a href="subject.html#760">[ subject ]</a>
              <a href="author.html#760">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
