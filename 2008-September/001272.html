<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r2467 - in /trunk: include/terrain.h lua/lib.2d.spriteblock.lua lua/lib.3d.mousepick.lua lua/lib.mapblock.2d.terrain.lua lua/lib.terrain.multitex.lua src/scripting.iris.cpp src/terrain_multitex.cpp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2008-September/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2467%20-%20in%20/trunk%3A%20include/terrain.h%0A%20lua/lib.2d.spriteblock.lua%20lua/lib.3d.mousepick.lua%0A%20lua/lib.mapblock.2d.terrain.lua%20lua/lib.terrain.multitex.lua%0A%20src/scripting.iris.cpp%20src/terrain_multitex.cpp&In-Reply-To=%3C20080921211658.277EC1524030%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001271.html">
   <LINK REL="Next"  HREF="001273.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r2467 - in /trunk: include/terrain.h lua/lib.2d.spriteblock.lua lua/lib.3d.mousepick.lua lua/lib.mapblock.2d.terrain.lua lua/lib.terrain.multitex.lua src/scripting.iris.cpp src/terrain_multitex.cpp</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2467%20-%20in%20/trunk%3A%20include/terrain.h%0A%20lua/lib.2d.spriteblock.lua%20lua/lib.3d.mousepick.lua%0A%20lua/lib.mapblock.2d.terrain.lua%20lua/lib.terrain.multitex.lua%0A%20src/scripting.iris.cpp%20src/terrain_multitex.cpp&In-Reply-To=%3C20080921211658.277EC1524030%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r2467 - in /trunk: include/terrain.h lua/lib.2d.spriteblock.lua lua/lib.3d.mousepick.lua lua/lib.mapblock.2d.terrain.lua lua/lib.terrain.multitex.lua src/scripting.iris.cpp src/terrain_multitex.cpp">no-reply at zwischenwelt.org
       </A><BR>
    <I>Sun Sep 21 23:16:55 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001271.html">[Iris-commit] [IRIS] r2466 - in /trunk/lua: lib.2d.dynamic.lua	lib.2d.spriteblock.lua
</A></li>
        <LI>Next message: <A HREF="001273.html">[Iris-commit] [IRIS] r2468 - in /trunk: README bin/iris2.exe
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1272">[ date ]</a>
              <a href="thread.html#1272">[ thread ]</a>
              <a href="subject.html#1272">[ subject ]</a>
              <a href="author.html#1272">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Sun Sep 21 23:16:54 2008
New Revision: 2467

Log:
terrain generation : added parameter for z-unit size, used by 2d.  2d terra=
in scaling fixed

Modified:
    trunk/include/terrain.h
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.mapblock.2d.terrain.lua
    trunk/lua/lib.terrain.multitex.lua
    trunk/src/scripting.iris.cpp
    trunk/src/terrain_multitex.cpp

Modified: trunk/include/terrain.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/terrain.h (original)
+++ trunk/include/terrain.h Sun Sep 21 23:16:54 2008
@@ -13,7 +13,7 @@
 std::string		BuildTerrainEntity_Simple	(cGroundBlockLoader* pGroundBlockLo=
ader,const int iMinX,const int iMinY,const int iW,const int iH,const bool b=
GenerateNormals);
 std::string		BuildTerrainEntity_Shaded	(cGroundBlockLoader* pGroundBlockLo=
ader,const int iMinX,const int iMinY,const int iW,const int iH);
 =

-void	 		TerrainMultiTexWrite		(cGroundBlockLoader* pGroundBlockLoader,cons=
t int iBlockX,const int iBlockY,const int iDX,const int iDY,Lugre::cRobRend=
erOp&amp; pRobRenderOp);
+void	 		TerrainMultiTexWrite		(cGroundBlockLoader* pGroundBlockLoader,cons=
t int iBlockX,const int iBlockY,const int iDX,const int iDY,const float fZU=
nit,Lugre::cRobRenderOp&amp; pRobRenderOp);
 void	 		TerrainMultiTex_SetGroundMaterialTypeLookUp	(const int* piValues,c=
onst int iCount);
 void			TerrainMultiTex_AddTexCoordSet				(int iMode,float tx,float ty,floa=
t tw,float th,int iTileSpan); ///&lt; 0:ground,1:mainmask,2:mask
 void			TerrainMultiTex_AddMaskTexCoordSet			(float u1,float v1, float u2,f=
loat v2, float u3,float v3, float u4,float v4);
@@ -23,6 +23,6 @@
 /// output : float&amp; pfHitDist,int&amp; pTX,int&amp; pTY
 /// the terrain is assumed to start at 0,0,0,  if this is not the case, ju=
st adjust the ray origin : rx,ry,rz
 /// tx,ty are the relative tile coordinates, in the range [0,8*dx[ , [0,8*=
dy[ =

-bool			TerrainMultiTex_RayPick		(cGroundBlockLoader* pGroundBlockLoader,co=
nst int iBlockX,const int iBlockY,const int iDX,const int iDY,const Ogre::V=
ector3&amp; vRayPos,const Ogre::Vector3&amp; vRayDir,float&amp; pfHitDist,int&amp; pTX,int&amp;=
 pTY);
+bool			TerrainMultiTex_RayPick		(cGroundBlockLoader* pGroundBlockLoader,co=
nst int iBlockX,const int iBlockY,const int iDX,const int iDY,const float f=
ZUnit,const Ogre::Vector3&amp; vRayPos,const Ogre::Vector3&amp; vRayDir,float&amp; pfHi=
tDist,int&amp; pTX,int&amp; pTY);
 =

 #endif

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sun Sep 21 23:16:54 2008
@@ -11,18 +11,17 @@
 	self.pTileTypeAtlasMats =3D {} -- self.pTileTypeAtlasMats[iTileTypeID][iH=
ue] =3D pAtlasPiece (see ArtAtlasLoadAndLock)
 	self.pGroupGfx =3D {}
 	self.pSpritesByAtlas =3D {}
-	self.rootgfx =3D CreateRootGfx3D()
 end
 =

 function cUOSpriteBlock:SetPosition (x,y,z) =

 	self.x =3D x
 	self.y =3D y
 	self.z =3D z
-	self.rootgfx:SetPosition(x,y,z) =

+	if (self.rootgfx) then self.rootgfx:SetPosition(x,y,z) end
 end
 =

 function cUOSpriteBlock:Destroy ()
-	if (self.pGroupGfx) then for k,v in pairs(self.pGroupGfx) do v:Destroy() =
end self.pGroupGfx =3D nil end
+	if (self.pGroupGfx) then for k,v in pairs(self.pGroupGfx) do v:Destroy() =
end self.pGroupGfx =3D {} end
 	if (self.rootgfx) then self.rootgfx:Destroy() self.rootgfx =3D nil end
 end
 =

@@ -133,7 +132,7 @@
 	=

 	local x,y,z =3D -tx,ty,zloc * kRenderer2D_ZScale
 	local sortadd =3D sortbonus * kRenderer2D_ZScale
-	local movedown =3D kSq2 -- ox-1,oy+1 : sprites are too high normally, thi=
s moves them down =

+	local movedown =3D 1 -- ox-1,oy+1 : sprites are too high normally, this m=
oves them down =

 	x =3D x +   -1 * sortadd - movedown  =

 	y =3D y +    1 * sortadd + movedown
 	z =3D z + kSq2 * sortadd
@@ -165,6 +164,7 @@
 =

 -- bUseRootGfx : default false, can be set to true if there is only one sp=
rite
 function cUOSpriteBlock:Build 	(basemat,bUseRootGfx)
+	if (not self.rootgfx) then self.rootgfx =3D CreateRootGfx3D() end
 	-- for 3d statics
 	-- statics : create gfx
 	-- -so 1420,1550

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sun Sep 21 23:16:54 2008
@@ -117,7 +117,7 @@
 				local bx,by =3D iBlockUO_X,iBlockUO_Y
 				local tx,ty
 =

-				bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,bx,=
by,w,h, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
+				bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,bx,=
by,w,h,0.1, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
 				if (bHit) then
 					if (tx &gt;=3D 8) then bx =3D bx + 1   tx =3D tx - 8 end
 					if (ty &gt;=3D 8) then by =3D by + 1   ty =3D ty - 8 end
@@ -228,7 +228,7 @@
 						local bx,by =3D gfx.bx,gfx.by
 						local tx,ty
 =

-						bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,g=
fx.bx,gfx.by,d,d, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
+						bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,g=
fx.bx,gfx.by,d,d,0.1, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
 						if (bHit) then
 							if (tx &gt;=3D 8) then bx =3D bx + 1   tx =3D tx - 8 end
 							if (ty &gt;=3D 8) then by =3D by + 1   ty =3D ty - 8 end

Modified: trunk/lua/lib.mapblock.2d.terrain.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.2d.terrain.lua (original)
+++ trunk/lua/lib.mapblock.2d.terrain.lua Sun Sep 21 23:16:54 2008
@@ -13,12 +13,12 @@
 	local gfx =3D self.gfx_terrain =

 	if (not gfx) then return end
 	local bx,by,bs =3D self.bx * 2, self.by * 2, self.iBlockSize
-	local bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,=
bx,by,bs,bs, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
+	local bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,=
bx,by,bs,bs,kRenderer2D_ZScale, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
 	if (not bHit) then return end
 	return fHitDist,bx * 8 + tx,by*8 + ty
 end
 =

 function cMapBlock_2D_Terrain:WorkStep_LoadDetail ()
 	local bs =3D kMultiTexTerrainChunkSize
-	self.gfx_terrain =3D MakeMultiTexTerrainGfx(self.bx * bs,self.by * bs)
+	self.gfx_terrain =3D MakeMultiTexTerrainGfx(self.bx * bs,self.by * bs,kRe=
nderer2D_ZScale)
 end

Modified: trunk/lua/lib.terrain.multitex.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.terrain.multitex.lua (original)
+++ trunk/lua/lib.terrain.multitex.lua Sun Sep 21 23:16:54 2008
@@ -358,7 +358,8 @@
 =

 =

 =

-function MakeMultiTexTerrainGfx(bx,by) =

+function MakeMultiTexTerrainGfx(bx,by,zunit) =

+	zunit =3D zunit or 0.1
 	local gfx =3D CreateRootGfx3D()
 	gfx.bx =3D bx
 	gfx.by =3D by
@@ -367,7 +368,7 @@
 	gfx.y =3D y
 	gfx.z =3D z
 	gfx:SetPosition(x,y,z) -- print(&quot;MakeMultiTexTerrainGfx&quot;,x,y,z,gGroundBlo=
ckLoader,bx,by,kMultiTexTerrainChunkSize)
-	Gfx3D_SetMultiTexTerrain(gfx,gGroundBlockLoader,bx,by,kMultiTexTerrainChu=
nkSize,kMultiTexTerrainChunkSize)
+	Gfx3D_SetMultiTexTerrain(gfx,gGroundBlockLoader,bx,by,kMultiTexTerrainChu=
nkSize,kMultiTexTerrainChunkSize,zunit)
 	gfx:SetMaterial(MultiTexTerrainGetMat())
 	gfx:SetCastShadows(gTerrainCastShadows)
 	return gfx

Modified: trunk/src/scripting.iris.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/scripting.iris.cpp (original)
+++ trunk/src/scripting.iris.cpp Sun Sep 21 23:16:54 2008
@@ -294,18 +294,19 @@
 static int l_Gfx3D_SetMultiTexTerrain (lua_State *L) { PROFILE
 	cGfx3D* pGfx3D =3D cLuaBind&lt;cGfx3D&gt;::checkudata_alive(L);
 	cGroundBlockLoader* pGroundBlockLoader =3D cLuaBind&lt;cGroundBlockLoader&gt;::=
checkudata_alive(L,2);
-	int bx =3D luaL_checkint(L,3);
-	int by =3D luaL_checkint(L,4);
-	int dx =3D (lua_gettop(L) &gt;=3D 5 &amp;&amp; !lua_isnil(L,5)) ? luaL_checkint(L,5)=
 : 1;
-	int dy =3D (lua_gettop(L) &gt;=3D 6 &amp;&amp; !lua_isnil(L,6)) ? luaL_checkint(L,6)=
 : 1;
+	int bx		=3D luaL_checkint(L,3);
+	int by		=3D luaL_checkint(L,4);
+	int dx		=3D (lua_gettop(L) &gt;=3D 5 &amp;&amp; !lua_isnil(L,5)) ? luaL_checkint(L,5=
) : 1;
+	int dy		=3D (lua_gettop(L) &gt;=3D 6 &amp;&amp; !lua_isnil(L,6)) ? luaL_checkint(L,6=
) : 1;
+	float zunit =3D (lua_gettop(L) &gt;=3D 7 &amp;&amp; !lua_isnil(L,7)) ? luaL_checknum=
ber(L,7) : 0.1;
 	=

 	pGfx3D-&gt;SetSimpleRenderable();
 	cRobRenderOp* pRobRenderOp =3D pGfx3D-&gt;mpSimpleRenderable;
-	TerrainMultiTexWrite(pGroundBlockLoader,bx,by,dx,dy,*pRobRenderOp);
-	return 0;
-}
-
-/// bhit,bhitdist,tx,ty =3D TerrainMultiTex_RayPick(pGroundBlockLoader,bx,=
by,dx,dy, rx,ry,rz, rvx,rvy,rvz) -- mainly for mousepicking
+	TerrainMultiTexWrite(pGroundBlockLoader,bx,by,dx,dy,zunit,*pRobRenderOp);
+	return 0;
+}
+
+/// bhit,bhitdist,tx,ty =3D TerrainMultiTex_RayPick(pGroundBlockLoader,bx,=
by,dx,dy,zunit, rx,ry,rz, rvx,rvy,rvz) -- mainly for mousepicking
 /// see also  TerrainMultiTex_RayPick (terrain.h,terrain_multitex.cpp)
 static int	l_TerrainMultiTex_RayPick			(lua_State *L) { PROFILE =

 	cGroundBlockLoader* pGroundBlockLoader =3D cLuaBind&lt;cGroundBlockLoader&gt;::=
checkudata_alive(L,1);
@@ -313,14 +314,15 @@
 	int by =3D luaL_checkint(L,3);
 	int dx =3D luaL_checkint(L,4);
 	int dy =3D luaL_checkint(L,5);
+	float zunit =3D (lua_gettop(L) &gt;=3D 6 &amp;&amp; !lua_isnil(L,6)) ? luaL_checknum=
ber(L,6) : 0.1;
 =

 	// don't use ++i or something here, the compiler might mix the order
-	Ogre::Vector3	vRayPos(luaL_checknumber(L, 6),luaL_checknumber(L, 7),luaL_=
checknumber(L, 8));
-	Ogre::Vector3	vRayDir(luaL_checknumber(L, 9),luaL_checknumber(L,10),luaL_=
checknumber(L,11));
+	Ogre::Vector3	vRayPos(luaL_checknumber(L, 7),luaL_checknumber(L, 8),luaL_=
checknumber(L, 9));
+	Ogre::Vector3	vRayDir(luaL_checknumber(L,10),luaL_checknumber(L,11),luaL_=
checknumber(L,12));
 	=

 	float fHitDist =3D 0;
 	int tx =3D 0,ty =3D 0;
-	bool bHit =3D TerrainMultiTex_RayPick(pGroundBlockLoader,bx,by,dx,dy,vRay=
Pos,vRayDir,fHitDist,tx,ty);
+	bool bHit =3D TerrainMultiTex_RayPick(pGroundBlockLoader,bx,by,dx,dy,zuni=
t,vRayPos,vRayDir,fHitDist,tx,ty);
 	lua_pushboolean(L,bHit);
 	lua_pushnumber(L,fHitDist);
 	lua_pushnumber(L,tx);

Modified: trunk/src/terrain_multitex.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/terrain_multitex.cpp (original)
+++ trunk/src/terrain_multitex.cpp Sun Sep 21 23:16:54 2008
@@ -33,8 +33,10 @@
 	RawGroundBlock* mpBlocks[3*3];
 	float			mfAddX;
 	float			mfAddY;
-	=

-	cTiledMultiTexTerrain() : mfAddX(0), mfAddY(0) {}
+	float			mfZUnit;
+	float			mfLookUpZUnit;
+	=

+	cTiledMultiTexTerrain() : mfAddX(0), mfAddY(0), mfZUnit(0.1), mfLookUpZUn=
it(0) {}
 	=

 	enum { kMaxZDiff =3D 64 }; ///&lt; mNormalLookup
 	enum { kGroundMatLookUpSize =3D 0x4000 };
@@ -63,7 +65,7 @@
 	/// returns original uo z integer (16bit)
 	/// only use this after initializing the cache !
 	inline int		GetZ	(const int x,const int y) { return mZ[(y+1)*(T+3)+(x+1)]=
; }
-	inline float	GetZF	(const int x,const int y) { return float(GetZ(x,y))*0.=
1; }
+	inline float	GetZF	(const int x,const int y) { return float(GetZ(x,y))*mf=
ZUnit; }
 	=

 	/// calc/limit diff... see also cached GetNormal below
 	/// dz_x is the z-difference between x-1,y and x+1,y
@@ -157,7 +159,8 @@
 	inline float*	GetTexCoordInfo_Mask				(const int iID) { return &amp;mTexCoord=
s_Mask[		iID*8]; }
 	=

 	=

-	void	WriteToRobRenderOp (cGroundBlockLoader* pGroundBlockLoader,int bx,in=
t by,const int iDX,const int iDY,cRobRenderOp&amp; pRobRenderOp) {
+	void	WriteToRobRenderOp (cGroundBlockLoader* pGroundBlockLoader,int bx,in=
t by,const int iDX,const int iDY,const float fZUnit,cRobRenderOp&amp; pRobRende=
rOp) {
+		mfZUnit =3D fZUnit;
 		int iVertexCountPerBlock	=3D T*T*4;
 		int iVertexCount			=3D iDX*iDY*iVertexCountPerBlock;
 		int iIndexCount				=3D iDX*iDY*T*T*6;
@@ -207,7 +210,9 @@
 	}
 	=

 	/// don't call before WriteToVertexBuffer has been called at least once t=
o set up lookup tables
-	bool	RayPick		(cGroundBlockLoader* pGroundBlockLoader,const int iBlockX,c=
onst int iBlockY,const int iDX,const int iDY,const Ogre::Vector3&amp; vRayPos,c=
onst Ogre::Vector3&amp; vRayDir,float&amp; pfHitDist,int&amp; pTX,int&amp; pTY) {
+	bool	RayPick		(cGroundBlockLoader* pGroundBlockLoader,const int iBlockX,c=
onst int iBlockY,const int iDX,const int iDY,const float fZUnit,const Ogre:=
:<i>Vector3&amp; vRayPos,const Ogre::Vector3&amp; vRayDir,float&amp; pfHitDist,int&amp; pTX,in=
</I>t&amp; pTY) {
+		mfZUnit =3D fZUnit;
+	=

 		//~ printf(&quot;mulittex_terrain_raypick %p %d,%d,%d,%d\n&quot;,pGroundBlockLoade=
r,iBlockX,iBlockY,iDX,iDY);
 		=

 		//~ if (!Ogre::Ray(vRayPos,vRayDir).intersects(Ogre::Sphere(Ogre::Vector=
3::ZERO,mfBoundRad + 0.1)).first) return -1;
@@ -259,12 +264,11 @@
 		}
 		=

 		// called once at startup
-		static bool		bNormalLookupInit =3D true;
-		if (bNormalLookupInit) { =

-			bNormalLookupInit =3D false; // only once
+		if (mfLookUpZUnit !=3D mfZUnit) { =

+			mfLookUpZUnit =3D mfZUnit; // only once per zunit
 			for (int dz_y=3D-kMaxZDiff;dz_y&lt;=3DkMaxZDiff;++dz_y)
 			for (int dz_x=3D-kMaxZDiff;dz_x&lt;=3DkMaxZDiff;++dz_x) {
-				Ogre::Vector3 n =3D Ogre::Vector3(2,0,dz_x*0.1).crossProduct(Ogre::Vec=
tor3(0,2,dz_y*0.1)).normalisedCopy();
+				Ogre::Vector3 n =3D Ogre::Vector3(2,0,dz_x*mfZUnit).crossProduct(Ogre:=
:<i>Vector3(0,2,dz_y*mfZUnit)).normalisedCopy();
</I> 				float* p =3D LookUpNormal(dz_x,dz_y);
 				p[0] =3D n.x;
 				p[1] =3D n.y;
@@ -423,8 +427,8 @@
 =

 cTiledMultiTexTerrain&lt;8&gt;	gTiledMultiTexTerrain;
 =

-void	 TerrainMultiTexWrite	(cGroundBlockLoader* pGroundBlockLoader,const i=
nt iBlockX,const int iBlockY,const int iDX,const int iDY,cRobRenderOp&amp; pRob=
RenderOp) {
-	gTiledMultiTexTerrain.WriteToRobRenderOp(pGroundBlockLoader,iBlockX,iBloc=
kY,iDX,iDY,pRobRenderOp);
+void	 TerrainMultiTexWrite	(cGroundBlockLoader* pGroundBlockLoader,const i=
nt iBlockX,const int iBlockY,const int iDX,const int iDY,const float fZUnit=
,cRobRenderOp&amp; pRobRenderOp) {
+	gTiledMultiTexTerrain.WriteToRobRenderOp(pGroundBlockLoader,iBlockX,iBloc=
kY,iDX,iDY,fZUnit,pRobRenderOp);
 }
 =

 void	 TerrainMultiTex_SetGroundMaterialTypeLookUp	(const int* piValues,con=
st int iCount) {
@@ -459,7 +463,7 @@
 	gTiledMultiTexTerrain.mTexCoords_Mask.push_back(v4);
 }
 =

-bool	TerrainMultiTex_RayPick		(cGroundBlockLoader* pGroundBlockLoader,cons=
t int iBlockX,const int iBlockY,const int iDX,const int iDY,const Ogre::Vec=
tor3&amp; vRayPos,const Ogre::Vector3&amp; vRayDir,float&amp; pfHitDist,int&amp; pTX,int&amp; p=
TY) {
-	return gTiledMultiTexTerrain.RayPick(pGroundBlockLoader,iBlockX,iBlockY,i=
DX,iDY,vRayPos,vRayDir,pfHitDist,pTX,pTY);
+bool	TerrainMultiTex_RayPick		(cGroundBlockLoader* pGroundBlockLoader,cons=
t int iBlockX,const int iBlockY,const int iDX,const int iDY,const float fZU=
nit,const Ogre::Vector3&amp; vRayPos,const Ogre::Vector3&amp; vRayDir,float&amp; pfHitD=
ist,int&amp; pTX,int&amp; pTY) {
+	return gTiledMultiTexTerrain.RayPick(pGroundBlockLoader,iBlockX,iBlockY,i=
DX,iDY,fZUnit,vRayPos,vRayDir,pfHitDist,pTX,pTY);
 }
 =



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001271.html">[Iris-commit] [IRIS] r2466 - in /trunk/lua: lib.2d.dynamic.lua	lib.2d.spriteblock.lua
</A></li>
	<LI>Next message: <A HREF="001273.html">[Iris-commit] [IRIS] r2468 - in /trunk: README bin/iris2.exe
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1272">[ date ]</a>
              <a href="thread.html#1272">[ thread ]</a>
              <a href="subject.html#1272">[ subject ]</a>
              <a href="author.html#1272">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
