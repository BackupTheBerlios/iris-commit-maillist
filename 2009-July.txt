From no-reply at zwischenwelt.org  Thu Jul  2 04:11:34 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Jul 2009 02:11:34 -0000
Subject: [Iris-commit] [IRIS] r3064 - in /trunk/lua: gui/gui.gumpparser.lua
 lib.gump.samples.lua lib.macrolist.lua widgets/widget.uotext.lua
Message-ID: <20090702021135.06A287A980E2@simon>

Author: ghoulsblade
Date: Thu Jul  2 04:11:34 2009
New Revision: 3064

Log:
gump fixes : textcoloring uohmtl case insensitive now, hue above 0x7fff map=
ped to white, fixed autowrapping problems for small text elements (vetusmun=
dus gump code)

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.gump.samples.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Thu Jul  2 04:11:34 2009
@@ -46,7 +46,8 @@
 	]]--
 	--~ local testgump,x,y,kDebugName =3D kGumpSample_ChangeLog,400,00."kGump=
Sample_ChangeLog"
 	--~ local testgump,x,y,kDebugName =3D kGumpSample_ChangeLog_Text,400,0,"k=
GumpSample_ChangeLog_Text"
-	local testgump,x,y,kDebugName =3D kGumpSample_RuneBook,0,240,"kGumpSample=
_RuneBook"
+	local testgump,x,y,kDebugName =3D kGumpSample_VM_BodCode,0,240,"kGumpSamp=
le_VM_BodCode"
+	--~ local testgump,x,y,kDebugName =3D kGumpSample_RuneBook,0,240,"kGumpSa=
mple_RuneBook"
 	--~ local testgump,x,y,kDebugName =3D kGumpSample_RuneBook3,0,240,"kGumpS=
ample_RuneBook"
 	--~ local testgump,x,y,kDebugName =3D kGumpSample_Reward,0,140,"kGumpSamp=
le_Reward"
 	--~ local testgump,x,y,kDebugName =3D kGumpSample_MoongateMenu,0,140,"kGu=
mpSample_MoongateMenu"

Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Thu Jul  2 04:11:34 2009
@@ -275,3 +275,45 @@
     [0]=3D{80,},
     },
 }
+
+
+
+kGumpSample_VM_BodCode =3D { =

+	Data=3D"{ page 0 }{ resizepic 25 10 5054 430 392 }{ gumppictiled 33 20 41=
3 373 2624 }{ checkertrans 33 20 413 373 }{ gumppic 20 5 10460 }{ gumppic 4=
30 5 10460 }{ gumppic 20 377 10460 }{ gumppic 430 377 10460 }{ xmfhtmlgumpc=
olor 190 25 120 20 1045133 0 0 32767 }{ xmfhtmlgumpcolor 40 48 350 20 10451=
35 0 0 32767 }{ xmfhtmlgumpcolor 40 72 210 20 1045138 0 0 32767 }{ text 250=
 72 1152 0 }{ xmfhtmlgumpcolor 40 96 120 20 1045136 0 0 32767 }{ tilepic 38=
5 96 3907 }{ xmfhtmlgumpcolor 40 120 210 20 1023907 0 0 16777215 }{ xmfhtml=
gumpcolor 40 144 210 20 1045140 0 0 32767 }{ xmfhtmlgumpcolor 40 168 350 20=
 1045141 0 0 32767 }{ htmlgump 40 192 350 25 1 0 0 }{ htmlgump 40 216 10 16=
 2 0 0 }{ htmlgump 50 216 10 16 3 0 0 }{ htmlgump 60 216 10 16 3 0 0 }{ htm=
lgump 70 216 10 16 3 0 0 }{ htmlgump 80 216 10 16 3 0 0 }{ htmlgump 90 216 =
10 16 3 0 0 }{ htmlgump 100 216 10 16 4 0 0 }{ htmlgump 110 216 10 16 5 0 0=
 }{ htmlgump 120 216 10 16 5 0 0 }{ htmlgump 130 216 10 16 5 0 0 }{ htmlgum=
p 140 216 10 16 5 0 0 }{ htmlgump 150 216 10 16 2 0 0 }{ htmlgump 160 216 1=
0 16 6 0 0 }{ htmlgump 170 216 10 16 5 0 0 }{ htmlgump 180 216 10 16 5 0 0 =
}{ htmlgump 190 216 10 16 5 0 0 }{ htmlgump 200 216 10 16 5 0 0 }{ htmlgump=
 210 216 10 16 2 0 0 }{ htmlgump 220 216 10 16 3 0 0 }{ htmlgump 230 216 10=
 16 3 0 0 }{ htmlgump 240 216 10 16 3 0 0 }{ htmlgump 250 216 10 16 4 0 0 }=
{ htmlgump 260 216 10 16 5 0 0 }{ htmlgump 270 216 10 16 5 0 0 }{ htmlgump =
40 232 10 16 3 0 0 }{ htmlgump 50 232 10 16 3 0 0 }{ htmlgump 60 232 10 16 =
7 0 0 }{ htmlgump 70 232 10 16 5 0 0 }{ htmlgump 80 232 10 16 5 0 0 }{ html=
gump 90 232 10 16 5 0 0 }{ htmlgump 100 232 10 16 5 0 0 }{ htmlgump 110 232=
 10 16 5 0 0 }{ htmlgump 120 232 10 16 5 0 0 }{ htmlgump 130 232 10 16 5 0 =
0 }{ htmlgump 140 232 10 16 2 0 0 }{ htmlgump 150 232 10 16 3 0 0 }{ htmlgu=
mp 160 232 10 16 7 0 0 }{ htmlgump 170 232 10 16 5 0 0 }{ htmlgump 180 232 =
10 16 5 0 0 }{ htmlgump 190 232 10 16 5 0 0 }{ htmlgump 200 232 10 16 3 0 0=
 }{ htmlgump 210 232 10 16 3 0 0 }{ htmlgump 220 232 10 16 7 0 0 }{ htmlgum=
p 230 232 10 16 5 0 0 }{ htmlgump 240 232 10 16 8 0 0 }{ htmlgump 250 232 1=
0 16 3 0 0 }{ htmlgump 260 232 10 16 4 0 0 }{ htmlgump 270 232 10 16 5 0 0 =
}{ htmlgump 40 248 10 16 3 0 0 }{ htmlgump 50 248 10 16 3 0 0 }{ htmlgump 6=
0 248 10 16 9 0 0 }{ htmlgump 70 248 10 16 9 0 0 }{ htmlgump 80 248 10 16 9=
 0 0 }{ htmlgump 90 248 10 16 5 0 0 }{ htmlgump 100 248 10 16 5 0 0 }{ html=
gump 110 248 10 16 5 0 0 }{ htmlgump 120 248 10 16 5 0 0 }{ htmlgump 130 24=
8 10 16 2 0 0 }{ htmlgump 140 248 10 16 3 0 0 }{ htmlgump 150 248 10 16 7 0=
 0 }{ htmlgump 160 248 10 16 5 0 0 }{ htmlgump 170 248 10 16 5 0 0 }{ htmlg=
ump 180 248 10 16 5 0 0 }{ htmlgump 190 248 10 16 5 0 0 }{ htmlgump 200 248=
 10 16 3 0 0 }{ htmlgump 210 248 10 16 3 0 0 }{ htmlgump 220 248 10 16 5 0 =
0 }{ htmlgump 230 248 10 16 5 0 0 }{ htmlgump 240 248 10 16 5 0 0 }{ htmlgu=
mp 250 248 10 16 5 0 0 }{ htmlgump 260 248 10 16 5 0 0 }{ htmlgump 270 248 =
10 16 5 0 0 }{ htmlgump 40 264 10 16 3 0 0 }{ htmlgump 50 264 10 16 3 0 0 }=
{ htmlgump 60 264 10 16 10 0 0 }{ htmlgump 70 264 10 16 10 0 0 }{ htmlgump =
80 264 10 16 10 0 0 }{ htmlgump 90 264 10 16 5 0 0 }{ htmlgump 100 264 10 1=
6 5 0 0 }{ htmlgump 110 264 10 16 5 0 0 }{ htmlgump 120 264 10 16 2 0 0 }{ =
htmlgump 130 264 10 16 3 0 0 }{ htmlgump 140 264 10 16 3 0 0 }{ htmlgump 15=
0 264 10 16 3 0 0 }{ htmlgump 160 264 10 16 3 0 0 }{ htmlgump 170 264 10 16=
 4 0 0 }{ htmlgump 180 264 10 16 11 0 0 }{ htmlgump 190 264 10 16 5 0 0 }{ =
htmlgump 200 264 10 16 3 0 0 }{ htmlgump 210 264 10 16 3 0 0 }{ htmlgump 22=
0 264 10 16 5 0 0 }{ htmlgump 230 264 10 16 5 0 0 }{ htmlgump 240 264 10 16=
 9 0 0 }{ htmlgump 250 264 10 16 9 0 0 }{ htmlgump 260 264 10 16 9 0 0 }{ h=
tmlgump 270 264 10 16 5 0 0 }{ htmlgump 40 280 10 16 3 0 0 }{ htmlgump 50 2=
80 10 16 3 0 0 }{ htmlgump 60 280 10 16 5 0 0 }{ htmlgump 70 280 10 16 5 0 =
0 }{ htmlgump 80 280 10 16 5 0 0 }{ htmlgump 90 280 10 16 5 0 0 }{ htmlgump=
 100 280 10 16 5 0 0 }{ htmlgump 110 280 10 16 5 0 0 }{ htmlgump 120 280 10=
 16 3 0 0 }{ htmlgump 130 280 10 16 3 0 0 }{ htmlgump 140 280 10 16 7 0 0 }=
{ htmlgump 150 280 10 16 5 0 0 }{ htmlgump 160 280 10 16 12 0 0 }{ htmlgump=
 170 280 10 16 3 0 0 }{ htmlgump 180 280 10 16 6 0 0 }{ htmlgump 190 280 10=
 16 5 0 0 }{ htmlgump 200 280 10 16 3 0 0 }{ htmlgump 210 280 10 16 3 0 0 }=
{ htmlgump 220 280 10 16 11 0 0 }{ htmlgump 230 280 10 16 5 0 0 }{ htmlgump=
 240 280 10 16 10 0 0 }{ htmlgump 250 280 10 16 3 0 0 }{ htmlgump 260 280 1=
0 16 10 0 0 }{ htmlgump 270 280 10 16 5 0 0 }{ htmlgump 40 296 10 16 8 0 0 =
}{ htmlgump 50 296 10 16 13 0 0 }{ htmlgump 60 296 10 16 5 0 0 }{ htmlgump =
70 296 10 16 5 0 0 }{ htmlgump 80 296 10 16 5 0 0 }{ htmlgump 90 296 10 16 =
5 0 0 }{ htmlgump 100 296 10 16 5 0 0 }{ htmlgump 110 296 10 16 5 0 0 }{ ht=
mlgump 120 296 10 16 12 0 0 }{ htmlgump 130 296 10 16 3 0 0 }{ htmlgump 140=
 296 10 16 3 0 0 }{ htmlgump 150 296 10 16 3 0 0 }{ htmlgump 160 296 10 16 =
3 0 0 }{ htmlgump 170 296 10 16 13 0 0 }{ htmlgump 180 296 10 16 5 0 0 }{ h=
tmlgump 190 296 10 16 5 0 0 }{ htmlgump 200 296 10 16 5 0 0 }{ htmlgump 210=
 296 10 16 8 0 0 }{ htmlgump 220 296 10 16 3 0 0 }{ htmlgump 230 296 10 16 =
3 0 0 }{ htmlgump 240 296 10 16 3 0 0 }{ htmlgump 250 296 10 16 13 0 0 }{ h=
tmlgump 260 296 10 16 5 0 0 }{ htmlgump 270 296 10 16 5 0 0 }{ htmlgump 40 =
312 10 16 5 0 0 }{ htmlgump 50 312 10 16 5 0 0 }{ htmlgump 60 312 10 16 5 0=
 0 }{ htmlgump 70 312 10 16 5 0 0 }{ htmlgump 80 312 10 16 5 0 0 }{ htmlgum=
p 90 312 10 16 5 0 0 }{ htmlgump 100 312 10 16 5 0 0 }{ htmlgump 110 312 10=
 16 5 0 0 }{ htmlgump 120 312 10 16 5 0 0 }{ htmlgump 130 312 10 16 5 0 0 }=
{ htmlgump 140 312 10 16 5 0 0 }{ htmlgump 150 312 10 16 5 0 0 }{ htmlgump =
160 312 10 16 5 0 0 }{ htmlgump 170 312 10 16 5 0 0 }{ htmlgump 180 312 10 =
16 5 0 0 }{ htmlgump 190 312 10 16 5 0 0 }{ htmlgump 200 312 10 16 5 0 0 }{=
 htmlgump 210 312 10 16 5 0 0 }{ htmlgump 220 312 10 16 5 0 0 }{ htmlgump 2=
30 312 10 16 5 0 0 }{ htmlgump 240 312 10 16 5 0 0 }{ htmlgump 250 312 10 1=
6 5 0 0 }{ htmlgump 260 312 10 16 5 0 0 }{ htmlgump 270 312 10 16 5 0 0 }{ =
htmlgump 40 328 10 16 5 0 0 }{ htmlgump 50 328 10 16 5 0 0 }{ htmlgump 60 3=
28 10 16 5 0 0 }{ htmlgump 70 328 10 16 5 0 0 }{ htmlgump 80 328 10 16 5 0 =
0 }{ htmlgump 90 328 10 16 5 0 0 }{ htmlgump 100 328 10 16 5 0 0 }{ htmlgum=
p 110 328 10 16 5 0 0 }{ htmlgump 120 328 10 16 5 0 0 }{ htmlgump 130 328 1=
0 16 5 0 0 }{ htmlgump 140 328 10 16 5 0 0 }{ htmlgump 150 328 10 16 5 0 0 =
}{ htmlgump 160 328 10 16 5 0 0 }{ htmlgump 170 328 10 16 5 0 0 }{ htmlgump=
 180 328 10 16 5 0 0 }{ htmlgump 190 328 10 16 5 0 0 }{ htmlgump 200 328 10=
 16 5 0 0 }{ htmlgump 210 328 10 16 5 0 0 }{ htmlgump 220 328 10 16 5 0 0 }=
{ htmlgump 230 328 10 16 5 0 0 }{ htmlgump 240 328 10 16 5 0 0 }{ htmlgump =
250 328 10 16 5 0 0 }{ htmlgump 260 328 10 16 5 0 0 }{ htmlgump 270 328 10 =
16 5 0 0 }{ xmfhtmlgumpcolor 40 344 250 20 1045139 0 0 32767 }{ text 268 34=
3 137 14 }{ gumppictiled 360 343 40 19 3004 }{ textentry 360 343 40 19 137 =
600 15 }{ button 70 368 4005 4007 1 0 0 }{ xmfhtmlgumpcolor 105 368 120 20 =
1011012 0 0 32767 }{ button 200 368 4005 4007 1 0 600 }{ xmfhtmlgumpcolor 2=
35 368 120 20 1006044 0 0 32767 }",                                        =
                  =

+	textline=3D{
+	[1]=3D"<basefont color=3D#FF0000>All items must be crafted with bronze in=
gots",
+	[2]=3D"<basefont color=3D#FFFFFF><center>d</center>",                    =
      =

+	[3]=3D"<basefont color=3D#FFFFFF><center>8</center>",                    =
      =

+	[4]=3D"<basefont color=3D#FFFFFF><center>b</center>",                    =
      =

+	[5]=3D"<basefont color=3D#FFFFFF><center> </center>",                    =
      =

+	[6]=3D"<basefont color=3D#FFFFFF><center>D</center>",                    =
      =

+	[7]=3D"<basefont color=3D#FFFFFF><center>'</center>",                    =
      =

+	[8]=3D"<basefont color=3D#FFFFFF><center>Y</center>",                    =
      =

+	[9]=3D"<basefont color=3D#FFFFFF><center>o</center>",                    =
      =

+	[10]=3D"<basefont color=3D#FFFFFF><center>~</center>",                   =
      =

+	[11]=3D"<basefont color=3D#FFFFFF><center>.</center>",                   =
      =

+	[12]=3D"<basefont color=3D#FFFFFF><center>`</center>",                   =
      =

+	[13]=3D"<basefont color=3D#FFFFFF><center>P</center>",                   =
      =

+	[14]=3D"Countersign it:",                                                =
    =

+	[15]=3D"",                                                               =
    =

+	[0]=3D"15",                                                              =
    =

+	},                                                                       =
  =

+	textline_unicode=3D{                                                     =
    =

+	[1]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,48,48,48,48,62,65,108,108,32,105,116,101,109,115,32,109,117,115,116,32,98,=
101,32,99,114,97,102,116,101,100,32,119,105,116,104,32,98,114,111,110,122,1=
01,32,105,110,103,111,116,115,},                                           =
                                                                         =

+	[2]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,100,60,47,99,101,110,116,101,1=
14,62,},                                                                   =
                         =

+	[3]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,56,60,47,99,101,110,116,101,11=
4,62,},                                                                    =
                         =

+	[4]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,98,60,47,99,101,110,116,101,11=
4,62,},                                                                    =
                         =

+	[5]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,32,60,47,99,101,110,116,101,11=
4,62,},                                                                    =
                         =

+	[6]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,68,60,47,99,101,110,116,101,11=
4,62,},                                                                    =
                         =

+	[7]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,39,60,47,99,101,110,116,101,11=
4,62,},                                                                    =
                         =

+	[8]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,89,60,47,99,101,110,116,101,11=
4,62,},                                                                    =
                         =

+	[9]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,70=
,70,70,70,70,62,60,99,101,110,116,101,114,62,111,60,47,99,101,110,116,101,1=
14,62,},                                                                   =
                         =

+	[10]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,7=
0,70,70,70,70,62,60,99,101,110,116,101,114,62,126,60,47,99,101,110,116,101,=
114,62,},                                                                  =
                         =

+	[11]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,7=
0,70,70,70,70,62,60,99,101,110,116,101,114,62,46,60,47,99,101,110,116,101,1=
14,62,},                                                                   =
                         =

+	[12]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,7=
0,70,70,70,70,62,60,99,101,110,116,101,114,62,96,60,47,99,101,110,116,101,1=
14,62,},                                                                   =
                         =

+	[13]=3D{60,98,97,115,101,102,111,110,116,32,99,111,108,111,114,61,35,70,7=
0,70,70,70,70,62,60,99,101,110,116,101,114,62,80,60,47,99,101,110,116,101,1=
14,62,},                                                                   =
                         =

+	[14]=3D{67,111,117,110,116,101,114,115,105,103,110,32,105,116,58,},      =
                                                    =

+	[15]=3D{},                                                               =
                                                    =

+	[0]=3D{49,53,},                                                          =
                                                    =

+	},  =

+}

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Jul  2 04:11:34 2009
@@ -613,8 +613,9 @@
 =

 function MacroCmd_Item_FindNearByArtID  (artid,hue,dist) -- equals easyuo =
type
     local res =3D {}
+    local artidlist =3D (type(artid) =3D=3D "number") and {artid} or artid
     for k,item in pairs(GetDynamicList()) do =

-        if (item.artid =3D=3D artid and (hue =3D=3D nil or hue =3D=3D item=
.hue) and DynamicIsInWorld(item) and =

+        if (in_array(item.artid,artidlist) and (hue =3D=3D nil or hue =3D=
=3D item.hue) and DynamicIsInWorld(item) and =

             (dist =3D=3D nil or item:GetUODistToPlayer() <=3D dist) ) then
             table.insert(res,item)
         end

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Thu Jul  2 04:11:34 2009
@@ -20,14 +20,15 @@
 	--~ print("TODO:widget.UOText  : height,w/h-clip,background,scrollbar",pa=
rentwidget:GetClassName(),parentwidget.pagenum)
 	if (params.scrollbar =3D=3D 0) then params.scrollbar =3D false end
 	if (params.scrollbar) then params.default_black =3D false end -- when scr=
ollbar is on, default to white (probably on dark background?)
-	if (not params.crop) then params.autowrap_w =3D params.width end
+	if ((not params.crop) and params.width) then params.autowrap_w =3D params=
.width + 10 end
 	local bParseHTML =3D params.html
 	local text =3D params.text
 	params.text =3D nil
 	=

 	self:SetIgnoreBBoxHit(true) -- default is true for every derivate class o=
f group,
 	-- but text in gumps is not allowed to be mousepickable (e.g. label is di=
splayed above button but not child of button)
-	=

+	--~ create uotext  {gumpcommand=3D"htmlgump",textline_id=3D5,width=3D10=
=3D0x0a,y=3D328=3D0x0148,x=3D210=3D0xd2,default_black=3Dtrue,height=3D16=3D=
0x10,background=3D0,scrollbar=3D0,html=3Dtrue,}
+
 	if (not text) then
 		if (params.textline_id) then text =3D textlines[params.textline_id] =

 		elseif (params.cliloc_id and gClilocLoader) then =

@@ -78,7 +79,15 @@
 	local col_white =3D {r=3D1,g=3D1,b=3D1}
 	local col_black =3D {r=3D0,g=3D0,b=3D0}
 	local col =3D self.params.default_black and col_black or col_white
-	if (self.params.hue) then local r,g,b =3D gHueLoader:GetColor(self.params=
.hue,31) col =3D {r=3Dr,g=3Dg,b=3Db} end
+	if (self.params.hue) then =

+		local r,g,b
+		if (self.params.hue >=3D 0x7fff) then =

+			r,g,b =3D 1,1,1
+		else =

+			r,g,b =3D gHueLoader:GetColor(self.params.hue,31) =

+		end
+		col =3D {r=3Dr,g=3Dg,b=3Db} =

+	end
 	if (self.params.col) then col =3D self.params.col end
 	if (self.params.fontid) then fontid =3D self.params.fontid end
 	=

@@ -110,21 +119,23 @@
 				end
 			end
 			if (tag ~=3D "" and font) then
+				local taglow =3D string.lower(tag)
 				readerpos =3D readerpos + #tag
+					=

 				-- html-tag
-				if (string.find(tag,"</BASEFONT")) then table.remove(statestack) end
-				if (string.find(tag,"<BASEFONT")) then
-					local a,b,colhex =3D string.find(tag,"<BASEFONT.*COLOR=3D#([0-9a-fA-F=
]+)")
+				if (string.find(taglow,"</basefont")) then table.remove(statestack) end
+				if (string.find(taglow,"<basefont")) then
+					local a,b,colhex =3D string.find(taglow,"<basefont.*color=3D#([0-9a-f=
A-F]+)")
 					if (colhex) then local r,g,b =3D ColFromHex(colhex) col =3D {r=3Dr,g=
=3Dg,b=3Db} end
 					table.insert(statestack,{fontid,bold,col})
 				end
-				if (tag =3D=3D  "<CENTER>") then glyphlist:AddHAlign(kGlyphList_HAlign=
_Center) glyphlist:AddNewLine() end -- todo =

-				if (tag =3D=3D "</CENTER>") then glyphlist:AddHAlign(kGlyphList_HAlign=
_Left  ) glyphlist:AddNewLine() end -- todo =

+				if (taglow =3D=3D  "<center>") then glyphlist:AddHAlign(kGlyphList_HAl=
ign_Center) glyphlist:AddNewLine() end -- todo =

+				if (taglow =3D=3D "</center>") then glyphlist:AddHAlign(kGlyphList_HAl=
ign_Left  ) glyphlist:AddNewLine() end -- todo =

 				-- TODO : html-center : glyphlist : glyphs to change h-alignment durin=
g parsing ? needs line width.. and full text width (unless wrap specified !)
 =

-				if (tag =3D=3D "<BIG>") then table.insert(statestack,{0,bold,col}) end=
 -- fontchange
-				if (tag =3D=3D "</BIG>") then table.remove(statestack) end
-				if (tag =3D=3D "<BR>") then glyphlist:AddNewLine(font,fontsize) end
+				if (taglow =3D=3D "<big>") then table.insert(statestack,{0,bold,col}) =
end -- fontchange
+				if (taglow =3D=3D "</big>") then table.remove(statestack) end
+				if (taglow =3D=3D "<br>") then glyphlist:AddNewLine(font,fontsize) end
 				=

 				--~ part =3D string.sub(part,2,-2) -- cut away one char from each side
 				--~ for token in string.gfind(textstring, "%w+") do table.insert(bToke=
n,token) end



From no-reply at zwischenwelt.org  Sat Jul  4 21:15:06 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 04 Jul 2009 19:15:06 -0000
Subject: [Iris-commit] [IRIS] r3065 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/lib.macrolist.lua lua/lib.uotooltip.lua lua/obj/obj.container.lua
 plugins/loot.lua
Message-ID: <20090704191506.3184C7A980E4@simon>

Author: ghoulsblade
Date: Sat Jul  4 21:15:05 2009
New Revision: 3065

Log:
backpack toggle fix, lootscript : added peerless stuff

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.uotooltip.lua
    trunk/lua/obj/obj.container.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sat Jul  4 21:15:05 2009
@@ -60,6 +60,11 @@
 		--~ GumpParser_Old(testgump,false)
 		profiler:StartSection("new")
 		local dialog =3D GumpParser_New(testgump,false) dialog:SetPos(x,y) dialo=
g.sDebugName =3D kDebugName
+		=

+		=

+		NotifyListener("Hook_OpenServersideGump",dialog,testgump.playerid,testgu=
mp.dialogId,testgump.Length_Data,false,testgump)
+	=

+	=

 		profiler:Finish()
 		profiler:PrintTotalTime()
 	end

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Jul  4 21:15:05 2009
@@ -120,9 +120,9 @@
         if skillname =3D=3D name then return gPlayerSkills and gPlayerSkil=
ls[skillid] and gPlayerSkills[skillid][partname] end
     end
 end
-function MacroRead_SkillBase			(skillname) return (MacroRead_SkillDataPart=
(skillname,"base_value") or 0)  * 0.1 end =

-function MacroRead_SkillCap				(skillname) return (MacroRead_SkillDataPart=
(skillname,"skill_cap") or 0)  * 0.1 end =

-function MacroRead_SkillValue			(skillname) return (MacroRead_SkillDataPar=
t(skillname,"value") or 0)  * 0.1 end
+function MacroRead_SkillBase			(skillname) return (MacroRead_SkillDataPart=
(skillname,"base_value") or -1)  * 0.1 end =

+function MacroRead_SkillCap				(skillname) return (MacroRead_SkillDataPart=
(skillname,"skill_cap") or -1)  * 0.1 end =

+function MacroRead_SkillValue			(skillname) return (MacroRead_SkillDataPar=
t(skillname,"value") or -1)  * 0.1 end
 function MacroRead_SkillLockState		(skillname) return MacroRead_SkillDataP=
art(skillname,"lockstate") end -- 0=3Dup, 1=3Ddown, 2=3Dlock
 function MacroCmd_SetSkillLockState		(skillname,lockstate)
     for skillid,name in pairs(glSkillNames) do

Modified: trunk/lua/lib.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uotooltip.lua (original)
+++ trunk/lua/lib.uotooltip.lua Sat Jul  4 21:15:05 2009
@@ -75,9 +75,28 @@
 =

 -- if clilochash is wrong, request new megacliloc tooltip from server
 -- used in function gPacketHandler.kPacket_AOSObjProp()  &  gPacketHandler=
.kPacket_Generic_Command()
+gMyNextToolTipCycleCount =3D 0
 function Send_ToolTipRequest(objserial)
 	if (gDisableAosToolTipRequests) then return end
+	=

+	--[[
+	-- check runuo code
+	-- TODO : if more than a certain number of tooltip requests have been sen=
t in a certain time, queue new ones...
+	if (gMyTicks > (gMyNextToolTipCycle or 0)) then =

+		print("gMyNextToolTipCycleCount:",gMyNextToolTipCycleCount)
+		gMyNextToolTipCycle =3D gMyTicks + 500
+		gMyNextToolTipCycleCount =3D 0
+	end
+	=

+	gMyNextToolTipCycleCount =3D gMyNextToolTipCycleCount + 1
+	if (gMyNextToolTipCycleCount > 20) then return end
+	]]--
+	=

 	gAosToolTipRequested[objserial] =3D true =

+	Send_ToolTipRequest_Aux(objserial)
+end
+
+function Send_ToolTipRequest_Aux(objserial)
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Generic_Command)
 	out:PushNetUint16(hex2num("0x0009"))

Modified: trunk/lua/obj/obj.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.container.lua (original)
+++ trunk/lua/obj/obj.container.lua Sat Jul  4 21:15:05 2009
@@ -132,6 +132,7 @@
 function CloseContainer (serial) =

 	local container =3D GetContainer(serial)
 	if (container and container.dialog) then
+		container.bIsOpen =3D false
 		NotifyListener("Hook_CloseContainer",container.dialog,serial)
 		container.dialog:Destroy()
 		container.dialog =3D nil

Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Sat Jul  4 21:15:05 2009
@@ -3,7 +3,7 @@
 if (not gDisabledPlugins.loot) then =

 gLootPluginCutCorspes =3D false =

 --~ gLootPluginCutCorspes =3D true =

-gLootPluginMinGoldAmount =3D 150
+gLootPluginMinGoldAmount =3D 15011111111
 =

 kLootPlugin_RecentlyClickedInterval =3D 4*1000
 kLootPluginHideCorpseWithoutContentChangeTimeout =3D false -- if corpse do=
es not contain interesting item and hasn't changed contents, hide it
@@ -41,8 +41,24 @@
 	"cauldron", -- witchcraft stuff
 	"watering", -- witchcraft stuff
 	=

+	"Corruption",
+	"Putrefaction",
+	"Taint",
+	"Muculent",
+	"Blight",
+	"Scourge",
+	=

 	"talisman",
 	"totem",
+	"cincture",
+	"Dread", -- Dread Horn stuff
+	"Corroded",  -- melisande =

+	"imprisoned",  --  =

+	"Grizzle",  -- Grizzle =

+	"statue",  --  =

+	"Scepter of the Chief",  --  =

+	"Crystalline Ring",  --  shimmering
+	"Mark of the Travesty",  --  =

 	=

 	"ancient",
 	"legendary",



From no-reply at zwischenwelt.org  Sun Jul  5 22:24:02 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 05 Jul 2009 20:24:02 -0000
Subject: [Iris-commit] [IRIS] r3066 - in /trunk: lua/lib.spellbooks.lua
 plugins/lib.spellbar.lua plugins/loot.lua
Message-ID: <20090705202402.E3DB17A980E3@simon>

Author: ghoulsblade
Date: Sun Jul  5 22:24:02 2009
New Revision: 3066

Log:
small fixes, and added peerless stuff to lootscript

Modified:
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Jul  5 22:24:02 2009
@@ -261,7 +261,7 @@
 		},
 =

 	reagenz =3D { [1]=3D"Mana Cost : 24", [2]=3D"Mana Cost: 32", [3]=3D"Mana =
Cost: 40", [4]=3D"Mana Cost: 10", [5]=3D"Mana Cost: 34", [6]=3D"Mana Cost: =
50",
-				[7]=3D"Min. Skill: 0", [8]=3D"Skill Needed: 10", [9]=3D"Skill Needed: =
38", [10]=3D"Skill Needed: 66", [11]=3D"Skill Needed: 52", [12]=3D"Skill Ne=
eded: 80",
+				[7]=3D"Min. Skill: 0", [8]=3D"Skill Needed: 10", [9]=3D"Skill Needed: =
24", [10]=3D"Skill Needed: 66", [11]=3D"Skill Needed: 52", [12]=3D"Skill Ne=
eded: 80",
 				[13]=3D"Min. Skill: 55", [14]=3D"Min. Skill: 65",[14]=3D"Mana Cost: 70=
", [15]=3D"Skill Needed: 24" },
 =

 	spell_reags =3D {

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Jul  5 22:24:02 2009
@@ -25,6 +25,7 @@
 end)
 =

 RegisterListener("Hook_SendSpell",function (spellid)
+	if (gNoRender) then return end
 	local t =3D Client_GetTicks()
 	gSpellBarLastSpellSendTime =3D t
 	gSpellBarLastSpellSendID =3D spellid

Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Sun Jul  5 22:24:02 2009
@@ -37,17 +37,66 @@
 	--~ "slayer",
 	"Origami", -- paper
 	=

-	"boline", -- witchcraft stuff
-	"cauldron", -- witchcraft stuff
-	"watering", -- witchcraft stuff
-	=

+	-- witchcraft stuff
+	"boline", =

+	"cauldron",
+	"watering",
+	=

+	--~ dreadhorn keys, no timer : Blighted Cotton, Thorny Briar, Gnaw's Fang=
, Irk's Brain, Lissith's Silk, and Sabrix's Eye
+	"Brain",
+	"Blighted",
+	"Thorny",
+	"Gnaw",
+	"Lissith",
+	"Sabrix",
+	=

+	-- travesty keys : Red Key, Blue Key and Gold Key. From the High Executio=
ner, Grand Mage, and Master Thief. =

+	"Key",
+	=

+	-- peerless reags
 	"Corruption",
 	"Putrefaction",
 	"Taint",
 	"Muculent",
 	"Blight",
 	"Scourge",
-	=

+	"Captured Essence", -- shimmering effusion
+	"Diseased Bark", -- melisande
+	=

+	-- namd deko stuff
+	"Travesty",  --  =

+	"Paroxysmus",  --  =

+	"Dread",  --  =

+	"Grizzle",  --  =

+	"Damned",  --  Tombstone Of The Damned  grizzle deko loot
+	"Shimmering",  --  effusion deko
+	"Melisande",
+	"Hair Dye", -- Melisande
+	=

+	-- Artifacts (Mondain's Legacy)
+	"Aegis of Grace",
+	"Blade Dance",
+	"Bloodwood Spirit",
+	"Bonesmasher",
+	"Boomstick",
+	"Brightsight Lenses",
+	"Fey Leggings",
+	"Flesh Ripper",
+	"Helm of Swiftness",
+	"Pads of the Cu Sidhe",
+	"Quiver of Rage",
+	"Quiver of the Elements",
+	"Raed's Glory",
+	"Righteous Anger",
+	"Robe of the Eclipse",
+	"Robe of the Equinox",
+	"Soul Seeker",
+	"Talon Bite",
+	"Totem of the Void",
+	"Wildfire Bow",
+	"Windsong",
+
+	-- other valuable stuff and peerless artis
 	"talisman",
 	"totem",
 	"cincture",



From no-reply at zwischenwelt.org  Thu Jul  9 20:23:54 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 09 Jul 2009 18:23:54 -0000
Subject: [Iris-commit] [IRIS] r3067 - in /trunk: lua/lib.macrolist.lua
 lua/lib.pathfind.lua lua/net/net.mobile.lua
 lua/widgets/widget.uotooltip.lua plugins/lib.spellbar.lua plugins/loot.lua
Message-ID: <20090709182356.B431C7A980F2@simon>

Author: ghoulsblade
Date: Thu Jul  9 20:23:53 2009
New Revision: 3067

Log:
macros : improved pathfinding and smartlasttarget a bit

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.pathfind.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/widgets/widget.uotooltip.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Jul  9 20:23:53 2009
@@ -49,6 +49,8 @@
 =

 =

 function MacroCmd_MobilePoisoned (mobile) return mobile and TestBit(mobile=
.flag,kMobileFlag_Poisoned) end
+function MacroCmd_MobileMortaled (mobile) return mobile and TestBit(mobile=
.flag,kMobileFlag_GoldenHealth) end
+
 function MacroCmd_MiniHealCureSelf () =

     if (not GetPlayerMobile()) then return end
     if (MacroCmd_MobilePoisoned(GetPlayerMobile())) then
@@ -66,12 +68,12 @@
 function MacroCmd_GetSmartTargetForLastSpell () -- smart targets for frien=
dly spells (heal,cure)
     if (gSmartLastSpellID) then =

         if (gSmartLastSpellID =3D=3D kSmartSpellHealSmall or gSmartLastSpe=
llID =3D=3D kSmartSpellHealBig) then
-            local target =3D MobileList_GetWeakestFromList(MobileList_Heal=
ablePartyMembers())
+            local target =3D MobileList_GetWeakestFromList(MobileList_Heal=
ablePartyMembers(true))
             --~ print("healtarget",target)
             return target and target.serial or GetPlayerSerial(),true
         end
         if (gSmartLastSpellID =3D=3D kSmartSpellCureSmall or gSmartLastSpe=
llID =3D=3D kSmartSpellCureBig) then
-            local target =3D MobileList_GetWeakestFromList(MobileList_Cura=
blePartyMembers())
+            local target =3D MobileList_GetWeakestFromList(MobileList_Cura=
blePartyMembers(true))
             --~ print("curetarget",target)
             return target and target.serial or GetPlayerSerial(),true
         end
@@ -90,27 +92,40 @@
     end
     return found =

 end
-function MobileList_HealablePartyMembers    () =

-    local list =3D {} -- =

-    for serial,v in pairs(GetPartyMemberList()) do =

-        local mobile =3D GetMobile(serial)
-        --~ print("MobileList_HealablePartyMembers:",mobile and (not TestB=
it(mobile.flag,kMobileFlag_Poisoned)))
-        if (mobile and (not TestBit(mobile.flag,kMobileFlag_Poisoned) and =
(mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401)) and =

-            (not IsOutsideRange(mobile.xloc,mobile.yloc,gPlayerXLoc,gPlaye=
rYLoc,gSpellCastRange))) then table.insert(list,mobile) end
-    end
-    return list =

-end
-function MobileList_CurablePartyMembers     () =

-    local list =3D {}
-    for serial,v in pairs(GetPartyMemberList()) do =

-        local mobile =3D GetMobile(serial)
-        if (mobile and (TestBit(mobile.flag,kMobileFlag_Poisoned)) and =

-            (not IsOutsideRange(mobile.xloc,mobile.yloc,gPlayerXLoc,gPlaye=
rYLoc,gSpellCastRange))) then table.insert(list,mobile) end
-    end
-    return list =

-end
-
-    =

+
+-- checking if a mob has equip helps detecting humans/players
+function MobileHasEquip   (mobile) =

+	for index,layer in pairs(gLayerOrder) do
+		-- slime has kLayer_Backpack , dog not
+		if (layer ~=3D kLayer_Backpack and mobile:GetEquipmentAtLayer(layer)) th=
en return false end
+	end
+	return true
+end
+function MobileIsHuman   (mobile) =

+	return	mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401 or
+			mobile.artid =3D=3D 744 or mobile.artid =3D=3D 745 or MobileHasEquip(mo=
bile)
+end
+
+function MobileList_GetByFilter (fun)
+	local res =3D {}
+	for k,mobile in pairs(GetMobileList()) do if (fun(mobile)) then table.ins=
ert(res,mobile) end end
+	return res
+end
+
+
+function MobileList_HealablePartyMembers    (bFriendsAlso) =

+	return MobileList_GetByFilter(function (mobile) return	GetUODistToPlayer(=
mobile.xloc,mobile.yloc) <=3D gSpellCastRange and =

+															(not MacroCmd_MobilePoisoned(mobile)) and (not MacroCmd_Mob=
ileMortaled(mobile)) and =

+															(IsMobileInParty(mobile.serial) or (bFriendsAlso and mobile=
.notoriety =3D=3D kNotoriety_Friend and MobileIsHuman(mobile))) and
+															(mobile:GetRelHP() or 0) < 1 end)
+end
+function MobileList_CurablePartyMembers    (bFriendsAlso) =

+	return MobileList_GetByFilter(function (mobile) return	GetUODistToPlayer(=
mobile.xloc,mobile.yloc) <=3D gSpellCastRange and =

+															(MacroCmd_MobilePoisoned(mobile)) and =

+															(IsMobileInParty(mobile.serial) or (bFriendsAlso and mobile=
.notoriety =3D=3D kNotoriety_Friend and MobileIsHuman(mobile))) and
+															(mobile:GetRelHP() or 0) < 1 end)
+end
+
 -- GetPlayerMobile
 function MacroRead_PlayerStat           (statname) return MacroReadAux_Mob=
ileStat(GetPlayerMobile(),statname,"MacroRead_PlayerStat") end
 function MacroRead_TargetStat           (statname) return MacroReadAux_Mob=
ileStat(GetMobile(giSelectedMobile),statname,"MacroRead_TargetStat") end
@@ -964,19 +979,21 @@
 -- run from a job (uses wait) !!!! =

 -- timeout : stop walking if the target wasn't reached after this time.  0=
 to walk until target is reached
 =

-function MacroCmd_PathFindTo	(xloc,yloc,tolerance,timeout)
+function MacroCmd_PathFindTo	(xloc,yloc,tolerance,timeout,bNoLog)
 	tolerance =3D tolerance or 0
+	local bLog =3D not bNoLog
 	if (GetUODistToPlayer(xloc,yloc) <=3D tolerance) then return true end -- =
already there
 	timeout =3D timeout or 0
 	local endt =3D (timeout > 0) and (Client_GetTicks() + timeout)
 	repeat -- repeat the pathfinding calc every few seconds in case dynamics =
show up
 		local t =3D Client_GetTicks()
-		local res =3D cPathFind2:CalcRouteFromPlayerToPos(xloc,yloc,tolerance) =

+		local iJobWaitInterval =3D 50
+		local res =3D cPathFind2:CalcRouteFromPlayerToPos(xloc,yloc,tolerance,iJ=
obWaitInterval) =

 		local t2 =3D Client_GetTicks()
 		local nextstept =3D t2 + 1000
 		local dt =3D t2-t
-		print("MacroCmd_PathFindTo: calc took ",dt,"ms",res and ("numsteps:"..#r=
es) or "failed","curpos:"..table.concat({GetPlayerPos()},","))
-		if (not res) then print("MacroCmd_PathFindTo : failed, no path") return =
end
+		if (bLog) then print("MacroCmd_PathFindTo: calc took ",dt,"ms",res and (=
"numsteps:"..#res) or "failed","curpos:"..table.concat({GetPlayerPos()},","=
)) end
+		if (not res) then if (bLog) then print("MacroCmd_PathFindTo : failed, no=
 path") end return end
 		local bRunFlag =3D true
 		local bTrySides =3D true
 		for k,pos in ipairs(res) do =

@@ -984,13 +1001,17 @@
 			repeat
 				job.wait(max(10,Walk_GetTimeUntilNextStep()))
 				WalkStep_WalkToPosSimple(xloc,yloc,bRunFlag,bTrySides) =

-				if (endt and gMyTicks > endt) then print("MacroCmd_PathFindTo : failed=
, timeout") return end
+				if (endt and gMyTicks > endt) then =

+					if (bLog) then print("MacroCmd_PathFindTo : failed, timeout") end
+					return
+				end
 				if (gMyTicks > nextstept) then break end
 			until GetUODistToPlayer(xloc,yloc) <=3D 0 -- repeat (turn,walk) until t=
his next tile reached
 			if (gMyTicks > nextstept) then break end
 		end
 		if (gMyTicks <=3D nextstept) then  =

-			print("MacroCmd_PathFindTo : success, finished") return true -- final d=
estination reached
+			if (bLog) then print("MacroCmd_PathFindTo : success, finished") end
+			return true -- final destination reached
 		end
 	until false
 end

Modified: trunk/lua/lib.pathfind.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.pathfind.lua (original)
+++ trunk/lua/lib.pathfind.lua Thu Jul  9 20:23:53 2009
@@ -3,9 +3,9 @@
 cPathFind2 =3D {}
 kPathFind2_MaxSteps =3D 4000
 =

-function cPathFind2:CalcRouteFromPlayerToPos (xloc,yloc,tolerance) =

+function cPathFind2:CalcRouteFromPlayerToPos (xloc,yloc,tolerance,iJobWait=
Interval) =

 	local xloc0,yloc0,zloc0 =3D GetPlayerPos()
-	return self:CalcRouteFromPosToPos(xloc0,yloc0,zloc0,GetPlayerDir(),xloc,y=
loc,tolerance,WalkGetInterval(true),gWalkTimeout_DirectionChange)
+	return self:CalcRouteFromPosToPos(xloc0,yloc0,zloc0,GetPlayerDir(),xloc,y=
loc,tolerance,WalkGetInterval(true),gWalkTimeout_DirectionChange,iJobWaitIn=
terval)
 end
 =

 -- returns an array with {pos1,pos2,pos3,...} where each pos =3D {xloc,ylo=
c,zloc,and,some,data,vars...}
@@ -23,7 +23,7 @@
 	return res
 end
 =

-function cPathFind2:CalcRouteFromPosToPos (xloc0,yloc0,zloc0,dir0,xloc1,yl=
oc1,tolerance,walktime,turntime)
+function cPathFind2:CalcRouteFromPosToPos (xloc0,yloc0,zloc0,dir0,xloc1,yl=
oc1,tolerance,walktime,turntime,iJobWaitInterval)
 	tolerance =3D tolerance or 0
 	walktime =3D walktime or WalkGetInterval(true) -- defaults to current pla=
yer run speed
 	turntime =3D turntime or gWalkTimeout_DirectionChange
@@ -31,7 +31,12 @@
 	self.reached_byheuristic =3D {}
 	self:PushPos(xloc0,yloc0,zloc0,DirWrap(dir0),0,GetUODistToPos(xloc0,yloc0=
,xloc1,yloc1))
 	local isteps =3D 0
+	local next_wait_t =3D iJobWaitInterval and (Client_GetTicks() + iJobWaitI=
nterval)
 	while true do
+		if (next_wait_t) then
+			local t =3D Client_GetTicks()
+			if (t > next_wait_t) then next_wait_t =3D t + iJobWaitInterval job.wait=
(1) end
+		end
 		local pos =3D self:PopNextPos()
 		if (not pos) then return end -- target not reachable
 		local xloc,yloc,zloc,dir,t,heuristic,oldpos =3D unpack(pos)
@@ -48,7 +53,7 @@
 				local dist =3D GetUODistToPos(newxloc,newyloc,xloc1,yloc1)
 				if (dist <=3D tolerance) then return self:CreateResult(pos,newxloc,new=
yloc,newzloc,newdir) end -- target reached !
 				local t2 =3D t + walktime + ((newdir ~=3D dir) and turntime or 0)
-				local heuristic =3D dist -- + t2/1000
+				local heuristic =3D dist + ((newdir ~=3D dir) and 0.1 or 0) -- + t2/10=
00    -- small malus for changing dir
 				self:PushPos(newxloc,newyloc,newzloc,newdir,t2,heuristic,pos)
 			end
 		end

Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Thu Jul  9 20:23:53 2009
@@ -33,6 +33,7 @@
 	--~ end
 	=

 	local mobile =3D CreateOrUpdateMobile(mobiledata)
+	NotifyListener("Hook_MobileMove",mobile)
 end
 =

 -- Equipped_MOB packet (0x78)

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Thu Jul  9 20:23:53 2009
@@ -8,6 +8,11 @@
 	["Insured"]					=3D"#00FF00",
 	["blessed"]					=3D"#00FF00",
 	["slayer"]					=3D"#00FF00",
+	["hit harm"]				=3D"#00FF00",
+	["hit magic arrow"]			=3D"#00FF00",
+	["hit fireball"]			=3D"#00FF00",
+	["hit lightning"]			=3D"#00FF00",
+	["hit dispell"]				=3D"#88FF88",
 	["reflect physical damage"]	=3D"#88FF88",
 	["lower[^\n]+cost"]			=3D"#88FF88",
 	["hit[^\n]+leech"]			=3D"#88FF88",

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Thu Jul  9 20:23:53 2009
@@ -236,10 +236,11 @@
 gSpellbarShortMessages[1049540]	=3D {r=3D1,g=3D1,b=3D0.0,txt=3D"disco:fail=
"		} -- You attempt to disrupt your target, but fail.
 gSpellbarShortMessages[1049539]	=3D {r=3D0,g=3D1,b=3D0.0,txt=3D"disco:succ=
ess"	} -- You play jarring music, suppressing your target's strength.
 gSpellbarShortMessages[1049532]	=3D {r=3D0,g=3D1,b=3D0.0,txt=3D"peace:succ=
ess"	} -- You play hypnotic music, calming your target.
--- todo : peace fail
-
-
-
+gSpellbarShortMessages[501602]	=3D {r=3D0,g=3D1,b=3D0.0,txt=3D"provo:succe=
ss"	} -- Your music succeeds, as you start a fight.  =

+gSpellbarShortMessages[501589]	=3D {r=3D1,g=3D0,b=3D0.0,txt=3D"provo:inval=
id"	} -- You can't incite that!  501589  0
+gSpellbarShortMessages[501593]	=3D {r=3D1,g=3D0,b=3D0.0,txt=3D"provo:nosel=
f"		} -- You can't tell someone to attack themselves!    501593  0
+gSpellbarShortMessages[1049450]	=3D {r=3D1,g=3D0,b=3D0.0,txt=3D"provo:toof=
ar"		} -- The creatures you are trying to provoke are too far away from eac=
h other for your music to have an effect. 1049450  0
+gSpellbarShortMessages[501599]	=3D {r=3D1,g=3D1,b=3D0.0,txt=3D"provo:fail"=
		} -- Your music fails to incite enough anger.        501599  0
 =

 =

 =


Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Thu Jul  9 20:23:53 2009
@@ -36,6 +36,10 @@
 	--~ "mage weapon", -- mage armor , mage weap
 	--~ "slayer",
 	"Origami", -- paper
+	=

+	"skull",
+	"bank",
+	"atlas", -- travel atlas
 	=

 	-- witchcraft stuff
 	"boline", =

@@ -173,8 +177,8 @@
 	if (artid =3D=3D 0xeb1) then return false end -- music instruments
 	if (artid =3D=3D 0xe9d) then return false end -- music instruments
 	if (artid =3D=3D 0xe9c) then return false end -- music instruments
-	if (artid =3D=3D 0x1bfb and item.amount >=3D 30) then return true end -- =
bolts
-	if (artid =3D=3D 0x0f3f and item.amount >=3D 30) then return true end -- =
arrows
+	--~ if (artid =3D=3D 0x1bfb and item.amount >=3D 30) then return true end=
 -- bolts
+	--~ if (artid =3D=3D 0x0f3f and item.amount >=3D 30) then return true end=
 -- arrows
 	if (1 =3D=3D 2) then -- jewels
 		if (artid =3D=3D 0xf21) then return true end -- star saphire
 		if (artid =3D=3D 0xf26) then return true end -- star diamond



From no-reply at zwischenwelt.org  Fri Jul 10 14:05:06 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 10 Jul 2009 12:05:06 -0000
Subject: [Iris-commit] [IRIS] r3068 - in /trunk: cb/ vc7/
Message-ID: <20090710120506.8B6D17A980EB@simon>

Author: sience
Date: Fri Jul 10 14:05:06 2009
New Revision: 3068

Log:
-codeblocks and visual studio 7 (2003) obsolete buildfiles removed (use vs2=
005 or vs2008)

Removed:
    trunk/cb/
    trunk/vc7/



From no-reply at zwischenwelt.org  Sat Jul 11 19:08:01 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Jul 2009 17:08:01 -0000
Subject: [Iris-commit] [IRIS] r3069 - /trunk/lua/gui/gui.quit.lua
Message-ID: <20090711170801.71D327A980F1@simon>

Author: sience
Date: Sat Jul 11 19:08:00 2009
New Revision: 3069

Log:
-changed gui.quit.lua Dialog to new GuiSystem

Modified:
    trunk/lua/gui/gui.quit.lua

Modified: trunk/lua/gui/gui.quit.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.quit.lua (original)
+++ trunk/lua/gui/gui.quit.lua Sat Jul 11 19:08:00 2009
@@ -4,6 +4,8 @@
 quitGump.dialogId =3D 9000001
 quitGump.x =3D 300
 quitGump.y =3D 200
+
+quitGump.bSupportsGuiSys2 =3D true
 quitGump.Data =3D
 	 "{ page 0 }" ..
 	 "{ gumppic 0 0 2070 quitpic }" ..
@@ -17,7 +19,7 @@
 }
 quitGump.functions =3D {
  -- quitcanel
- [0]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then widg=
et.dialog:Close() gQuitDialog =3D nil  end end,
+ [0]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then Clos=
eQuit() end end,
  -- quitok
  [1]	=3D function (widget,mousebutton) if (mousebutton =3D=3D 1) then Term=
inate() end end,
 }
@@ -25,16 +27,22 @@
 kClientSideGump_Quit =3D quitGump -- do you really want to quit ?
 =

 gQuitDialog =3D nil
+
+-- Close amount Gump
+function CloseQuit() =

+	if (not gQuitDialog) then return end
+	gQuitDialog:Destroy()
+	gQuitDialog =3D nil
+end
+
 function OpenQuit()
 	if not(gQuitDialog) then
 		local dialog =3D GumpParser( quitGump, true )
 =

-		-- overwrite the onMouseDown function from gumpparser
-		dialog.onMouseDown =3D function (widget,mousebutton)
-			if (mousebutton =3D=3D 2) then widget.dialog:Close() gQuitDialog =3D ni=
l end
-			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget.dialog.rootwidget) end
-		end
+		gQuitDialog =3D dialog
 		=

-		gQuitDialog =3D dialog
+		-- overwrite the dialog close function from gumpparser
+		dialog.SendClose =3D function (self) CloseQuit() end
+
 	end
 end



From no-reply at zwischenwelt.org  Sat Jul 11 19:29:05 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Jul 2009 17:29:05 -0000
Subject: [Iris-commit] [IRIS] r3070 - in /trunk/lua/gui: gui.amount.lua
	gui.quit.lua gui.status.lua
Message-ID: <20090711172905.C92AF7A980F1@simon>

Author: sience
Date: Sat Jul 11 19:29:05 2009
New Revision: 3070

Log:
-small changes that the open gump functions, all follow the same style

Modified:
    trunk/lua/gui/gui.amount.lua
    trunk/lua/gui/gui.quit.lua
    trunk/lua/gui/gui.status.lua

Modified: trunk/lua/gui/gui.amount.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.amount.lua (original)
+++ trunk/lua/gui/gui.amount.lua Sat Jul 11 19:29:05 2009
@@ -36,78 +36,79 @@
 -- Open amount Gump
 -- callback_done(amount) =

 function OpenAmount (x,y,minValue,currentValue,maxValue,callback_done)
-	if currentValue =3D=3D nil then currentValue =3D maxValue end
-	if minValue =3D=3D nil or maxValue =3D=3D nil then return end
+	if not(gAmountDialog) then
+		if currentValue =3D=3D nil then currentValue =3D maxValue end
+		if minValue =3D=3D nil or maxValue =3D=3D nil then return end
+		=

+	--	CloseAmount()
+		=

+		local dialog =3D GumpParser( amountGump, true )
+		gAmountDialog =3D dialog
 	=

-	CloseAmount()
+		-- save mobile info to dialog
+		dialog.callback_done =3D callback_done
+		dialog.minValue =3D minValue
+		dialog.currentValue =3D currentValue
+		dialog.maxValue =3D maxValue
+		=

+		-- update dialog on pressing enter
+		dialog:GetCtrlByName("amount").params.bClearOnFirstKeyDown =3D true
+		dialog:GetCtrlByName("amount").params.bNumbersOnly =3D true
+		dialog:GetCtrlByName("amount"):SetFocus()
+		dialog:GetCtrlByName("amount").on_change_text =3D function(self) =

+			local text =3D self:GetText()
+			local v =3D math.floor(tonumber(text) or 0)
+			if (v > dialog.maxValue) then
+				dialog:SetAbsoluteValue(dialog.maxValue)
+			else
+				dialog.bKeepAmountText =3D true
+				dialog:SetAbsoluteValue(text)
+				dialog.bKeepAmountText =3D false
+			end
+		end
+		dialog:GetCtrlByName("amount").on_return =3D function(self)
+			dialog:SetAbsoluteValue(self:GetText())
+			dialog:SendClose()
+		end
 	=

-	local dialog =3D GumpParser( amountGump, true )
+		-- set a value (adjusts dot and amount text entry field)
+		dialog.SetAbsoluteValue =3D function(self,v)
+			v =3D math.floor(tonumber(v) or 0)
+			self.currentValue =3D Clamp(v, self.minValue, self.maxValue)
+			if (not dialog.bKeepAmountText) then dialog:GetCtrlByName("amount"):Set=
Text(self.currentValue or "?",false) end
+			=

+			local r =3D (self.currentValue - self.minValue) / (self.maxValue - self=
.minValue)
+			=

+			local x1,y1 =3D dialog:GetCtrlByName("start"):GetPos()
+			local x2,y2 =3D dialog:GetCtrlByName("end"):GetPos()
+			local x =3D x1 + r * (x2 - x1)
+			local y =3D y1 + r * (y2 - y1)
+			dialog:GetCtrlByName("dot"):SetPos(math.floor(x), math.floor(y))
+		end
 	=

-	gAmountDialog =3D dialog
-
-	-- save mobile info to dialog
-	dialog.callback_done =3D callback_done
-	dialog.minValue =3D minValue
-	dialog.currentValue =3D currentValue
-	dialog.maxValue =3D maxValue
+		-- overwrite the dialog close function from gumpparser
+		dialog.SendClose =3D function (self) local amount =3D self.currentValue =
CloseAmount() self.callback_done(amount) end
+		dialog.gumpdata.functions =3D { [0] =3D function (widget) local amount =
=3D dialog.currentValue CloseAmount() dialog.callback_done(amount) end }
+		=

 	=

-	-- update dialog on pressing enter
-	dialog:GetCtrlByName("amount").params.bClearOnFirstKeyDown =3D true
-	dialog:GetCtrlByName("amount").params.bNumbersOnly =3D true
-	dialog:GetCtrlByName("amount"):SetFocus()
-	dialog:GetCtrlByName("amount").on_change_text =3D function(self) =

-		local text =3D self:GetText()
-		local v =3D math.floor(tonumber(text) or 0)
-		if (v > dialog.maxValue) then
-			dialog:SetAbsoluteValue(dialog.maxValue)
-		else
-			dialog.bKeepAmountText =3D true
-			dialog:SetAbsoluteValue(text)
-			dialog.bKeepAmountText =3D false
+		-- drag the dot around
+		local dot =3D dialog:GetCtrlByName("dot")
+	=

+		dialog.moveDot =3D function (self, x,y)
+			local x1,y1 =3D dialog:GetCtrlByName("start"):GetPos()
+			local x2,y2 =3D dialog:GetCtrlByName("end"):GetPos()
+			local r =3D (x - x1) / (x2 - x1)
+			local v =3D minValue + (maxValue + minValue) * r
+			dialog:SetAbsoluteValue(v)
 		end
+	=

+		dot.on_mouse_left_down =3D function () dot:StartMouseMove(key_mouse_left=
,dialog.moveDot,dialog) end
+	=

+		-- initial setup
+		if x and y then dialog:SetPos(x,y) end
+		dialog:SetAbsoluteValue(currentValue)
+		=

+		dialog:GetCtrlByName("start"):SetVisible(false)
+		dialog:GetCtrlByName("end"):SetVisible(false)
 	end
-	dialog:GetCtrlByName("amount").on_return =3D function(self)
-		dialog:SetAbsoluteValue(self:GetText())
-		dialog:SendClose()
-	end
-
-	-- set a value (adjusts dot and amount text entry field)
-	dialog.SetAbsoluteValue =3D function(self,v)
-		v =3D math.floor(tonumber(v) or 0)
-		self.currentValue =3D Clamp(v, self.minValue, self.maxValue)
-		if (not dialog.bKeepAmountText) then dialog:GetCtrlByName("amount"):SetT=
ext(self.currentValue or "?",false) end
-		=

-		local r =3D (self.currentValue - self.minValue) / (self.maxValue - self.=
minValue)
-		=

-		local x1,y1 =3D dialog:GetCtrlByName("start"):GetPos()
-		local x2,y2 =3D dialog:GetCtrlByName("end"):GetPos()
-		local x =3D x1 + r * (x2 - x1)
-		local y =3D y1 + r * (y2 - y1)
-		dialog:GetCtrlByName("dot"):SetPos(math.floor(x), math.floor(y))
-	end
-
-	-- overwrite the dialog close function from gumpparser
-	dialog.SendClose =3D function (self) local amount =3D self.currentValue C=
loseAmount() self.callback_done(amount) end
-	dialog.gumpdata.functions =3D { [0] =3D function (widget) local amount =
=3D dialog.currentValue CloseAmount() dialog.callback_done(amount) end }
-	=

-
-	-- drag the dot around
-	local dot =3D dialog:GetCtrlByName("dot")
-
-	dialog.moveDot =3D function (self, x,y)
-		local x1,y1 =3D dialog:GetCtrlByName("start"):GetPos()
-		local x2,y2 =3D dialog:GetCtrlByName("end"):GetPos()
-		local r =3D (x - x1) / (x2 - x1)
-		local v =3D minValue + (maxValue + minValue) * r
-		dialog:SetAbsoluteValue(v)
-	end
-
-	dot.on_mouse_left_down =3D function () dot:StartMouseMove(key_mouse_left,=
dialog.moveDot,dialog) end
-
-	-- initial setup
-	if x and y then dialog:SetPos(x,y) end
-	dialog:SetAbsoluteValue(currentValue)
-	=

-	dialog:GetCtrlByName("start"):SetVisible(false)
-	dialog:GetCtrlByName("end"):SetVisible(false)
 end

Modified: trunk/lua/gui/gui.quit.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.quit.lua (original)
+++ trunk/lua/gui/gui.quit.lua Sat Jul 11 19:29:05 2009
@@ -29,20 +29,18 @@
 gQuitDialog =3D nil
 =

 -- Close amount Gump
-function CloseQuit() =

+function CloseQuit () =

 	if (not gQuitDialog) then return end
 	gQuitDialog:Destroy()
 	gQuitDialog =3D nil
 end
 =

-function OpenQuit()
+function OpenQuit ()
 	if not(gQuitDialog) then
 		local dialog =3D GumpParser( quitGump, true )
-
 		gQuitDialog =3D dialog
 		=

 		-- overwrite the dialog close function from gumpparser
 		dialog.SendClose =3D function (self) CloseQuit() end
-
 	end
 end

Modified: trunk/lua/gui/gui.status.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.status.lua (original)
+++ trunk/lua/gui/gui.status.lua Sat Jul 11 19:29:05 2009
@@ -70,12 +70,7 @@
 end
 		=

 function ToggleStatusAos ()
-	if (gStatusAosDialog) then
-		-- store current positoin
-		gStatusAosDialog_LastPositionX, gStatusAosDialog_LastPositionY =3D gStat=
usAosDialog.rootwidget.gfx:GetPos()
-		-- and close
-		gStatusAosDialog:Close()
-	else
+	if not(gStatusAosDialog) then
 		-- request stats update of player body
 		if gPlayerBodySerial then Send_ClientQuery(gRequest_States,gPlayerBodySe=
rial) end
 =

@@ -199,6 +194,11 @@
 				if dialog.lockbutton_int then dialog.lockbutton_int:SetLockState(int) =
end
 			end
 		end
+	else
+		-- store current positoin
+		gStatusAosDialog_LastPositionX, gStatusAosDialog_LastPositionY =3D gStat=
usAosDialog.rootwidget.gfx:GetPos()
+		-- and close
+		gStatusAosDialog:Close()
 	end
 end
 =




From no-reply at zwischenwelt.org  Sun Jul 12 00:57:24 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Jul 2009 22:57:24 -0000
Subject: [Iris-commit] [IRIS] r3071 - in /trunk: lua/gui/gui.chat.lua
 lua/lib.2d.spriteblock.lua lua/lib.data.lua lua/lib.hue.lua
 lua/lib.macrolist.lua lua/lib.uoutils.lua lua/main.lua
 lua/net/net.partysystem.lua src/data_hue_L.cpp
Message-ID: <20090711225724.797E07A980F1@simon>

Author: ghoulsblade
Date: Sun Jul 12 00:57:24 2009
New Revision: 3071

Log:
2d: derived hue detection, saves a bunch of vram, improved human detection =
macro for smarttarget, added partychat to chat-tab-bars

Added:
    trunk/lua/lib.hue.lua
Modified:
    trunk/lua/gui/gui.chat.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.data.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.uoutils.lua
    trunk/lua/main.lua
    trunk/lua/net/net.partysystem.lua
    trunk/src/data_hue_L.cpp

Modified: trunk/lua/gui/gui.chat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.chat.lua (original)
+++ trunk/lua/gui/gui.chat.lua Sun Jul 12 00:57:24 2009
@@ -8,6 +8,7 @@
 cChatTabs.channels =3D {
 	{name=3D"General",	filter=3Dfalse,						},
 	{name=3D"Chat",		filter=3D{"<.+>"},					},
+	{name=3D"Party",		filter=3D{"<Party>"},					},
 	{name=3D"Ally",		filter=3D{"<Alliance>","<Guild>"},	},
 	{name=3D"Trades",		filter=3D{"<Trades>"},				},
 }

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sun Jul 12 00:57:24 2009
@@ -144,9 +144,23 @@
 	return 0,false
 end
 =

+-- returns iTextureHue,r,g,b,a
+function cUOSpriteBlock:GetBaseHueData (iHue) =

+	local iBaseHue =3D gBaseHues[iHue-1]
+	if (not iBaseHue) then return iHue,1,1,1,1 end
+	local grey =3D GetHueColor(iBaseHue) =

+	local yr,yg,yb =3D GetHueColor(iHue-1) =

+	local ymax =3D max(yr,yg,yb)
+	local basef =3D ymax / grey
+	local r =3D max(0,min(1,basef*yr))
+	local g =3D max(0,min(1,basef*yg))
+	local b =3D max(0,min(1,basef*yb))
+	return (iBaseHue+1),r,g,b,1
+end
 function cUOSpriteBlock:AddAnim (tx,ty,tz,iRealID,iHue,iLoaderIndex,iFrame=
,bMirrorX,sortbonus,data)
 	iHue =3D BitwiseAND(iHue or 0,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
-	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPieceEx(iRealID,iFrame,iHue,iL=
oaderIndex)
+	local iTextureHue,r,g,b,a =3D self:GetBaseHueData(iHue)
+	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPieceEx(iRealID,iFrame,iTextur=
eHue,iLoaderIndex)
 	print("cUOSpriteBlock:AddAnim",iRealID,iFrame,iHue,iLoaderIndex,pAtlasPie=
ce)
 --~ cUOSpriteBlock:AddAnim  14089   999     0       1       nil
 =

@@ -154,13 +168,18 @@
 		local sprite =3D self:AddSpriteEx(tx,ty,tz,sortbonus,data,pAtlasPiece,bM=
irrorX)
 		sprite.bMirrorX =3D bMirrorX
 		sprite.hue =3D iHue
+		sprite.r =3D r
+		sprite.g =3D g
+		sprite.b =3D b
+		sprite.a =3D a
 		return sprite
 	end
 end
 =

 function cUOSpriteBlock:AddAnimModel (tx,ty,tz,iTranslatedModelID,iHue,iLo=
aderIndex,iFallBackModel,iFallBackAnim,iAnimID,iFrame,bMirrorX,sortbonus,da=
ta,	spritearr)
 	iHue =3D BitwiseAND(iHue or 0,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
-	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnim=
ID,iFrame,iHue,iLoaderIndex)
+	local iTextureHue,r,g,b,a =3D self:GetBaseHueData(iHue)
+	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnim=
ID,iFrame,iTextureHue,iLoaderIndex)
 	if (not pAtlasPiece) then
 		if (iFallBackModel) then
 			gMobile2DWarned =3D gMobile2DWarned or {}
@@ -171,7 +190,7 @@
 			iTranslatedModelID	=3D iFallBackModel -- replace unknown by standard mo=
del (13=3Devortex)
 			iAnimID				=3D iFallBackAnim =

 			iLoaderIndex 		=3D 1
-			pAtlasPiece			=3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnimID=
,iFrame,iHue,iLoaderIndex)
+			pAtlasPiece			=3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnimID=
,iFrame,iTextureHue,iLoaderIndex)
 		end
 	end
 	gProfiler_R2D_MobileStep:SectionIfActive("UpdateMobileGfx:AddAnimModel:Ad=
dSpriteEx")
@@ -183,6 +202,10 @@
 		sprite.uoanim_Frame			=3D iFrame
 		sprite.uoanim_LoaderIndex	=3D iLoaderIndex
 		sprite.hue =3D iHue
+		sprite.r =3D r
+		sprite.g =3D g
+		sprite.b =3D b
+		sprite.a =3D a
 		return sprite
 	end
 end
@@ -192,14 +215,16 @@
 	if (gNodrawByArtID[artid]) then return end
 	sortbonus =3D sortbonus or 0
 	hue =3D hue or 0
+	local iTextureHue,r,g,b,a =3D self:GetBaseHueData(hue)
+	=

 	local arr =3D self.pTileTypeAtlasMats[artid]
 	if (not arr) then arr =3D {} self.pTileTypeAtlasMats[artid] =3D arr end
 	=

 	-- get/load atlas mat
-	local pAtlasPiece =3D arr[hue]
+	local pAtlasPiece =3D arr[iTextureHue]
 	if (not pAtlasPiece) then
-		pAtlasPiece =3D ArtAtlasLoadAndLock(artid+0x4000,hue,self) -- .atlas,u0,=
v0,u1,v1,w,h
-		arr[hue] =3D pAtlasPiece
+		pAtlasPiece =3D ArtAtlasLoadAndLock(artid+0x4000,iTextureHue,self) -- .a=
tlas,u0,v0,u1,v1,w,h
+		arr[iTextureHue] =3D pAtlasPiece
 	end
 	=

 	-- add to matname group
@@ -207,7 +232,12 @@
 		print("warning, cUOSpriteBlock:AddArtSprite failed",artid,hue)
 		return
 	end
+	=

 	local sprite =3D self:AddSpriteEx(tx,ty,zloc,sortbonus,data,pAtlasPiece)
+	sprite.r =3D r
+	sprite.g =3D g
+	sprite.b =3D b
+	sprite.a =3D a
 	sprite.artid =3D artid
 	sprite.hue =3D hue
 	return sprite
@@ -429,11 +459,15 @@
 				local v0 		=3D sprite.v0
 				local u1 		=3D sprite.u1
 				local v1 		=3D sprite.v1
+				local r 		=3D sprite.r or 1
+				local g 		=3D sprite.g or 1
+				local b 		=3D sprite.b or 1
+				local a 		=3D sprite.a or 1
 				if (sprite.bMirrorX) then u0,u1 =3D u1,u0 end
-				gfx:RenderableVertex(x-xa,y-xa,z  	, u1,v1)
-				gfx:RenderableVertex(x+xa,y+xa,z  	, u0,v1)
-				gfx:RenderableVertex(x-xa,y-xa,z+za	, u1,v0)
-				gfx:RenderableVertex(x+xa,y+xa,z+za	, u0,v0)
+				gfx:RenderableVertex(x-xa,y-xa,z  	, u1,v1, r,g,b,a)
+				gfx:RenderableVertex(x+xa,y+xa,z  	, u0,v1, r,g,b,a)
+				gfx:RenderableVertex(x-xa,y-xa,z+za	, u1,v0, r,g,b,a)
+				gfx:RenderableVertex(x+xa,y+xa,z+za	, u0,v0, r,g,b,a)
 				gfx:RenderableIndex3(vc+0,vc+2,vc+1)
 				gfx:RenderableIndex3(vc+1,vc+2,vc+3)
 				vc =3D vc + 4

Modified: trunk/lua/lib.data.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.data.lua (original)
+++ trunk/lua/lib.data.lua Sun Jul 12 00:57:24 2009
@@ -284,3 +284,6 @@
     gTexMapLoader:Load(iTexMapID)
     return gTexMapLoader:GetSize()
 end
+
+
+

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Jul 12 00:57:24 2009
@@ -97,12 +97,13 @@
 function MobileHasEquip   (mobile) =

 	for index,layer in pairs(gLayerOrder) do
 		-- slime has kLayer_Backpack , dog not
-		if (layer ~=3D kLayer_Backpack and mobile:GetEquipmentAtLayer(layer)) th=
en return false end
+		if (layer ~=3D kLayer_Backpack and mobile:GetEquipmentAtLayer(layer)) th=
en return true end
 	end
-	return true
+	return false
 end
 function MobileIsHuman   (mobile) =

-	return	mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401 or
+	return	mobile and
+			mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401 or
 			mobile.artid =3D=3D 744 or mobile.artid =3D=3D 745 or MobileHasEquip(mo=
bile)
 end
 =

@@ -117,7 +118,8 @@
 	return MobileList_GetByFilter(function (mobile) return	GetUODistToPlayer(=
mobile.xloc,mobile.yloc) <=3D gSpellCastRange and =

 															(not MacroCmd_MobilePoisoned(mobile)) and (not MacroCmd_Mob=
ileMortaled(mobile)) and =

 															(IsMobileInParty(mobile.serial) or (bFriendsAlso and mobile=
.notoriety =3D=3D kNotoriety_Friend and MobileIsHuman(mobile))) and
-															(mobile:GetRelHP() or 0) < 1 end)
+															(mobile:GetRelHP() or 0) < 1 and =

+															(mobile:GetRelHP() or 0) > 0 end) -- not dead
 end
 function MobileList_CurablePartyMembers    (bFriendsAlso) =

 	return MobileList_GetByFilter(function (mobile) return	GetUODistToPlayer(=
mobile.xloc,mobile.yloc) <=3D gSpellCastRange and =


Modified: trunk/lua/lib.uoutils.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoutils.lua (original)
+++ trunk/lua/lib.uoutils.lua Sun Jul 12 00:57:24 2009
@@ -57,10 +57,10 @@
 end
 =

 -- use this instead of Uo16Color2Rgb
--- returns r,g,b =

+-- returns r,g,b,a =

 function GetHueColor (hue)
-	if (gHueLoader) then return gHueLoader:GetColor(hue,31) end
-	return 1,1,1
+	if (gHueLoader and hue) then return gHueLoader:GetColor(hue,31) end
+	return 1,1,1,1
 end
 =

 function GetDirY (dir) =


Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Jul 12 00:57:24 2009
@@ -45,6 +45,7 @@
 dofile(libpath .. "lib.null.renderer.lua")
 =

 dofile(libpath .. "lib.renderer.lua")
+dofile(libpath .. "lib.hue.lua")
 dofile(libpath .. "lib.uoids.lua")
 dofile(libpath .. "lib.boat.lua")
 dofile(libpath .. "lib.terrain.lua")

Modified: trunk/lua/net/net.partysystem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.partysystem.lua (original)
+++ trunk/lua/net/net.partysystem.lua Sun Jul 12 00:57:24 2009
@@ -194,7 +194,8 @@
 	name =3D UOShortenName(name)
 	print("partysystem:test message",speakerID,name, input, size)
 	local plaintext,unicodebytearr,size =3D FIFO_PopZeroTerminatedUnicode(inp=
ut,size)
-	GuiAddChatLine("["..name.."]: "..plaintext,gPartyChatColor)
+	GuiAddChatLine("<Party> "..name..": "..plaintext,gPartyChatColor)
+	NotifyListener("Hook_Party_Chat",name,plaintext)
 end =

 =

 -- thanks to surcouf =3D)

Modified: trunk/src/data_hue_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data_hue_L.cpp (original)
+++ trunk/src/data_hue_L.cpp Sun Jul 12 00:57:24 2009
@@ -10,6 +10,7 @@
 			#define REGISTER_METHOD(methodname) mlMethod.push_back(make_luaL_reg(#m=
ethodname,&cHueLoader_L::methodname));
 			REGISTER_METHOD(Destroy);
 			REGISTER_METHOD(GetColor);
+			REGISTER_METHOD(GetMaxHueID);
 			#undef REGISTER_METHOD
 		}
 =

@@ -27,6 +28,11 @@
 =

 		static int	Destroy			(lua_State *L) { PROFILE delete checkudata_alive(L)=
; return 0; }
 		=

+		static int	GetMaxHueID		(lua_State *L) { PROFILE =

+			lua_pushnumber(L,checkudata_alive(L)->GetMaxHueID());
+			return 1;
+		}
+				=

 		static int	GetColor		(lua_State *L) { PROFILE =

 			cHue* pHue =3D checkudata_alive(L)->GetHue(luaL_checkint(L,2));
 			if (!pHue) return 0;



From no-reply at zwischenwelt.org  Sun Jul 12 04:10:13 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Jul 2009 02:10:13 -0000
Subject: [Iris-commit] [IRIS] r3072 - in /trunk: data/ogreSampleMedia/
 data/ogreSampleMedia/materials/ data/ogreSampleMedia/materials/programs/
 data/ogreSampleMedia/materials/scripts/
 data/ogreSampleMedia/materials/textures/ data/ogreSampleMedia/models/
 data/ogreSampleMedia/packs/ lua/
Message-ID: <20090712021013.C84237A980F1@simon>

Author: ghoulsblade
Date: Sun Jul 12 04:10:13 2009
New Revision: 3072

Log:
added option gDebugModeTestSkeletalAnimShader

Added:
    trunk/data/ogreSampleMedia/
    trunk/data/ogreSampleMedia/materials/
    trunk/data/ogreSampleMedia/materials/programs/
    trunk/data/ogreSampleMedia/materials/programs/ASCIIFP.cg
    trunk/data/ogreSampleMedia/materials/programs/AmbientOneTexture.glsl
    trunk/data/ogreSampleMedia/materials/programs/Bloom2_ps20.glsl
    trunk/data/ogreSampleMedia/materials/programs/Bloom2_ps20.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Bloom_ps20.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Bloom_vs11.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Blur0_ps20.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Blur0_vs.glsl
    trunk/data/ogreSampleMedia/materials/programs/Blur0_vs11.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Blur1_ps20.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Blur1_vs.glsl
    trunk/data/ogreSampleMedia/materials/programs/Blur1_vs11.hlsl
    trunk/data/ogreSampleMedia/materials/programs/BlurH_ps20.glsl
    trunk/data/ogreSampleMedia/materials/programs/BlurH_ps20.hlsl
    trunk/data/ogreSampleMedia/materials/programs/BlurV_ps20.glsl
    trunk/data/ogreSampleMedia/materials/programs/BlurV_ps20.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Blur_ps.glsl
    trunk/data/ogreSampleMedia/materials/programs/Blur_vs.glsl
    trunk/data/ogreSampleMedia/materials/programs/Blur_vs11.hlsl
    trunk/data/ogreSampleMedia/materials/programs/BrightBloom2_ps20.glsl
    trunk/data/ogreSampleMedia/materials/programs/BrightBloom2_ps20.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Combine_fp.cg
    trunk/data/ogreSampleMedia/materials/programs/Common.cg
    trunk/data/ogreSampleMedia/materials/programs/DOF_ps.cg
    trunk/data/ogreSampleMedia/materials/programs/DepthShadowmap.hlsl
    trunk/data/ogreSampleMedia/materials/programs/DepthShadowmapCasterFp.gl=
sl
    trunk/data/ogreSampleMedia/materials/programs/DepthShadowmapCasterVp.gl=
sl
    trunk/data/ogreSampleMedia/materials/programs/DepthShadowmapNormalMapRe=
ceiverFp.glsl
    trunk/data/ogreSampleMedia/materials/programs/DepthShadowmapNormalMapRe=
ceiverVp.glsl
    trunk/data/ogreSampleMedia/materials/programs/DepthShadowmapReceiverFp.=
glsl
    trunk/data/ogreSampleMedia/materials/programs/DepthShadowmapReceiverVp.=
glsl
    trunk/data/ogreSampleMedia/materials/programs/DitherFP.cg
    trunk/data/ogreSampleMedia/materials/programs/Example_Basic.cg
    trunk/data/ogreSampleMedia/materials/programs/Example_Basic.hlsl
    trunk/data/ogreSampleMedia/materials/programs/Example_BumpMapping.cg
    trunk/data/ogreSampleMedia/materials/programs/Example_CelShading.cg
    trunk/data/ogreSampleMedia/materials/programs/Example_Fresnel.cg
    trunk/data/ogreSampleMedia/materials/programs/Example_FresnelPS.asm
    trunk/data/ogreSampleMedia/materials/programs/Example_Projection.cg
    trunk/data/ogreSampleMedia/materials/programs/GlassFP.cg
    trunk/data/ogreSampleMedia/materials/programs/Grass.cg
    trunk/data/ogreSampleMedia/materials/programs/GrayScale.cg
    trunk/data/ogreSampleMedia/materials/programs/HalftoneFP.cg
    trunk/data/ogreSampleMedia/materials/programs/HeatVision.cg
    trunk/data/ogreSampleMedia/materials/programs/InvertFP.cg
    trunk/data/ogreSampleMedia/materials/programs/LaplaceFP.cg
    trunk/data/ogreSampleMedia/materials/programs/NightVisionFP.cg
    trunk/data/ogreSampleMedia/materials/programs/Ocean2GLSL.frag
    trunk/data/ogreSampleMedia/materials/programs/Ocean2GLSL.vert
    trunk/data/ogreSampleMedia/materials/programs/Ocean2HLSL_Cg.frag
    trunk/data/ogreSampleMedia/materials/programs/Ocean2HLSL_Cg.vert
    trunk/data/ogreSampleMedia/materials/programs/OffsetMapping.cg
    trunk/data/ogreSampleMedia/materials/programs/OffsetMapping.hlsl
    trunk/data/ogreSampleMedia/materials/programs/OffsetMappingFp.glsl
    trunk/data/ogreSampleMedia/materials/programs/OffsetMappingVp.glsl
    trunk/data/ogreSampleMedia/materials/programs/OffsetMapping_specular.asm
    trunk/data/ogreSampleMedia/materials/programs/OldMovieFP.cg
    trunk/data/ogreSampleMedia/materials/programs/OldTV.cg
    trunk/data/ogreSampleMedia/materials/programs/ParticleGS.cg
    trunk/data/ogreSampleMedia/materials/programs/PassthroughVP.glsl
    trunk/data/ogreSampleMedia/materials/programs/PosterizeFP.cg
    trunk/data/ogreSampleMedia/materials/programs/Radial_Blur_FP.cg
    trunk/data/ogreSampleMedia/materials/programs/SharpenEdgesFP.cg
    trunk/data/ogreSampleMedia/materials/programs/StdQuad_vp.cg
    trunk/data/ogreSampleMedia/materials/programs/StdQuad_vp.glsl
    trunk/data/ogreSampleMedia/materials/programs/Swizzle.gp
    trunk/data/ogreSampleMedia/materials/programs/SwizzleGP.cg
    trunk/data/ogreSampleMedia/materials/programs/SwizzleGP.glsl
    trunk/data/ogreSampleMedia/materials/programs/TilingFP.cg
    trunk/data/ogreSampleMedia/materials/programs/crowdVp.glsl
    trunk/data/ogreSampleMedia/materials/programs/hdr.cg
    trunk/data/ogreSampleMedia/materials/programs/hdr.hlsl
    trunk/data/ogreSampleMedia/materials/programs/hdr_bloom.glsl
    trunk/data/ogreSampleMedia/materials/programs/hdr_downscale2x2luminence=
.glsl
    trunk/data/ogreSampleMedia/materials/programs/hdr_downscale3x3.glsl
    trunk/data/ogreSampleMedia/materials/programs/hdr_downscale3x3brightpas=
s.glsl
    trunk/data/ogreSampleMedia/materials/programs/hdr_finalToneMapping.glsl
    trunk/data/ogreSampleMedia/materials/programs/hdr_tonemap_util.glsl
    trunk/data/ogreSampleMedia/materials/programs/hdrutils.hlsl
    trunk/data/ogreSampleMedia/materials/programs/instancing.cg
    trunk/data/ogreSampleMedia/materials/programs/instancingVp.glsl
    trunk/data/ogreSampleMedia/materials/programs/isosurf.cg
    trunk/data/ogreSampleMedia/materials/programs/mrttestfp.hlsl
    trunk/data/ogreSampleMedia/materials/programs/mrttestfp_quad.glsl
    trunk/data/ogreSampleMedia/materials/programs/mrttestfp_scene.glsl
    trunk/data/ogreSampleMedia/materials/programs/oceanGLSL.frag
    trunk/data/ogreSampleMedia/materials/programs/oceanGLSL.vert
    trunk/data/ogreSampleMedia/materials/programs/oceanHLSL_Cg.frag
    trunk/data/ogreSampleMedia/materials/programs/oceanHLSL_Cg.vert
    trunk/data/ogreSampleMedia/materials/programs/pssm.cg
    trunk/data/ogreSampleMedia/materials/programs/skinningTwoWeightsShadowC=
asterVp.glsl
    trunk/data/ogreSampleMedia/materials/programs/skinningTwoWeightsVp.glsl
    trunk/data/ogreSampleMedia/materials/programs/varianceshadowcasterfp.cg
    trunk/data/ogreSampleMedia/materials/programs/varianceshadowcastervp.cg
    trunk/data/ogreSampleMedia/materials/programs/varianceshadowreceiverfp.=
cg
    trunk/data/ogreSampleMedia/materials/programs/varianceshadowreceivervp.=
cg
    trunk/data/ogreSampleMedia/materials/scripts/
    trunk/data/ogreSampleMedia/materials/scripts/ASCII.material
    trunk/data/ogreSampleMedia/materials/scripts/ASMSwizzle.material
    trunk/data/ogreSampleMedia/materials/scripts/BlackAndWhite.material
    trunk/data/ogreSampleMedia/materials/scripts/Bloom.material
    trunk/data/ogreSampleMedia/materials/scripts/Bloom2.material
    trunk/data/ogreSampleMedia/materials/scripts/CGSwizzle.material
    trunk/data/ogreSampleMedia/materials/scripts/DOF.material
    trunk/data/ogreSampleMedia/materials/scripts/DepthShadowmap.material
    trunk/data/ogreSampleMedia/materials/scripts/Dither.material
    trunk/data/ogreSampleMedia/materials/scripts/Embossed.material
    trunk/data/ogreSampleMedia/materials/scripts/Example-DynTex.material   =
(with props)
    trunk/data/ogreSampleMedia/materials/scripts/Example-Water.material
    trunk/data/ogreSampleMedia/materials/scripts/Example.material
    trunk/data/ogreSampleMedia/materials/scripts/Examples-Advanced.material
    trunk/data/ogreSampleMedia/materials/scripts/Examples.compositor
    trunk/data/ogreSampleMedia/materials/scripts/Examples.program
    trunk/data/ogreSampleMedia/materials/scripts/GLSLSwizzle.material
    trunk/data/ogreSampleMedia/materials/scripts/Glass.material
    trunk/data/ogreSampleMedia/materials/scripts/Halftone.material
    trunk/data/ogreSampleMedia/materials/scripts/HeatVision.material
    trunk/data/ogreSampleMedia/materials/scripts/Hurt.material
    trunk/data/ogreSampleMedia/materials/scripts/Invert.material
    trunk/data/ogreSampleMedia/materials/scripts/IsoSurf.material
    trunk/data/ogreSampleMedia/materials/scripts/Laplace.material
    trunk/data/ogreSampleMedia/materials/scripts/MRTtest.material
    trunk/data/ogreSampleMedia/materials/scripts/MotionBlur.material
    trunk/data/ogreSampleMedia/materials/scripts/NightVision.material
    trunk/data/ogreSampleMedia/materials/scripts/Ocean.controls
    trunk/data/ogreSampleMedia/materials/scripts/Ocean.material
    trunk/data/ogreSampleMedia/materials/scripts/OffsetMapping.material
    trunk/data/ogreSampleMedia/materials/scripts/Ogre.material
    trunk/data/ogreSampleMedia/materials/scripts/OldMovie.material
    trunk/data/ogreSampleMedia/materials/scripts/OldTV.material
    trunk/data/ogreSampleMedia/materials/scripts/ParticleGS.material
    trunk/data/ogreSampleMedia/materials/scripts/Posterize.material
    trunk/data/ogreSampleMedia/materials/scripts/RZR-002.material
    trunk/data/ogreSampleMedia/materials/scripts/RadialBlur.material
    trunk/data/ogreSampleMedia/materials/scripts/SharpenEdges.material
    trunk/data/ogreSampleMedia/materials/scripts/StdQuad_vp.program
    trunk/data/ogreSampleMedia/materials/scripts/Tiling.material
    trunk/data/ogreSampleMedia/materials/scripts/VarianceShadowmap.material
    trunk/data/ogreSampleMedia/materials/scripts/facial.material
    trunk/data/ogreSampleMedia/materials/scripts/hdr.material
    trunk/data/ogreSampleMedia/materials/scripts/instancing.material
    trunk/data/ogreSampleMedia/materials/scripts/pssm.material
    trunk/data/ogreSampleMedia/materials/scripts/smoke.material
    trunk/data/ogreSampleMedia/materials/textures/
    trunk/data/ogreSampleMedia/materials/textures/blue_jaiqua.jpg   (with p=
rops)
    trunk/data/ogreSampleMedia/models/
    trunk/data/ogreSampleMedia/models/jaiqua.mesh   (with props)
    trunk/data/ogreSampleMedia/models/jaiqua.skeleton   (with props)
    trunk/data/ogreSampleMedia/packs/
    trunk/data/ogreSampleMedia/packs/OgreCore.zip   (with props)
Modified:
    trunk/lua/lib.debugmenu.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Sun Jul 12 04:10:13 2009
@@ -9,6 +9,8 @@
 kDebugMode_Static =3D 1
 kDebugMode_Online =3D 2
 kDebugMode_Particle =3D 2
+
+gDebugModeTestSkeletalAnimShader =3D false
 =

 gCurDebugMode =3D kDebugMode_Granny
 gDebugMenuRunning =3D false
@@ -631,6 +633,7 @@
         local iHue =3D gDebugMenuAnimIndex
         local info =3D GetStaticTileType(iTileType)
         local meshname =3D GetMeshName(iTileType)
+		if (gDebugModeTestSkeletalAnimShader) then meshname =3D "jaiqua.mesh" end
         --~ if (iTileType =3D=3D 578) then meshname =3D "knot.mesh" end
         local submeshcount =3D GetMeshSubMeshCount(meshname)
         print("mesh for tiletype=3D",iTileType,sprintf("0x%04x",iTileType)=
," submeshcount=3D",submeshcount)
@@ -647,6 +650,31 @@
         GuiAddChatLine(sprintf("static %04x(=3D%d) hue=3D%d tricount=3D%d =
%s",iTileType,iTileType,iHue,tricount,GetStaticTileTypeName(iTileType) or "=
"))
         if (meshname and meshname ~=3D false) then
             gDebugRootGfx:SetMesh(meshname)
+			=

+			if (gDebugModeTestSkeletalAnimShader) then =

+				local f =3D 1/34
+				gDebugRootGfx:SetScale(f,f,f)
+				gDebugRootGfx:SetAnim("Sneak",true)
+				gDebugRootGfx.animtime =3D 0
+				if (not  gDebugRootGfx.animfun_set) then
+					 gDebugRootGfx.animfun_set =3D true =

+					 RegisterStepper(function () =

+						gDebugRootGfx:SetAnimTimePos(gDebugRootGfx.animtime)
+						gDebugRootGfx.animtime =3D gDebugRootGfx.animtime + 1/30
+						if (gDebugRootGfx.animtime > 3) then gDebugRootGfx.animtime =3D 0 end
+					 end)
+				end
+				=

+					=

+				local x1,y1,z1, x2,y2,z2 =3D gDebugRootGfx:GetEntityBounds()
+				print("##########################################")
+				print("#######  mesh bounds :",x1,y1,z1, x2,y2,z2)
+				print("##########################################")
+				--~ #######  mesh bounds :  -24.264656066895        -1.6195520162582  =
      -61.062599182129        14.574376106262 17.728036880493 34.6057014465=
33
+				--~ #######  mesh bounds :  -1.0015000104904        -0.004499999806284=
9     -0.012000000104308      -0.84850001335144       0.454499989748  1.212=
0000123978
+			end
+			=

+			=

             --~ gDebugRootGfx:SetOrientation(GetStaticMeshOrientation(iTil=
eType))
             --~ mirroring now baked into meshes for shader compatibility -=
- gDebugRootGfx:SetScale(-1,1,1)          -- (-1) thats because xmirror bug=
 and wrong mirrored meshes
             --~ gDebugRootGfx:SetNormaliseNormals(true)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Jul 12 04:10:13 2009
@@ -270,6 +270,17 @@
     OgreAddResLoc(gUOPath..CorrectPath("Models/Maps")               ,"File=
System","General")
 =

     OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/caelum/resources=
"),"FileSystem","Caelum")
+	=

+	if (gDebugModeTestSkeletalAnimShader) then =

+		local myOgreSampleMedia =3D mydatapath.."ogreSampleMedia/"
+		=

+		OgreAddResLoc(myOgreSampleMedia.."/packs/OgreCore.zip"			,"Zip","Bootstr=
ap")
+		=

+		OgreAddResLoc(myOgreSampleMedia.."/materials/programs"          ,"FileSy=
stem","General")
+		OgreAddResLoc(myOgreSampleMedia.."/materials/scripts"           ,"FileSy=
stem","General")
+		OgreAddResLoc(myOgreSampleMedia.."/materials/textures"          ,"FileSy=
stem","General")
+		OgreAddResLoc(myOgreSampleMedia.."/models"                      ,"FileSy=
stem","General")
+	end
 =

     if gUseCaduneTree then =

         OgreAddResLoc(gMainWorkingDir..CorrectPath("lugre/lib/cadune_tree/=
resources"),"FileSystem","CaduneTree")



From no-reply at zwischenwelt.org  Mon Jul 13 22:55:12 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 13 Jul 2009 20:55:12 -0000
Subject: [Iris-commit] [IRIS] r3073 - in /trunk: data/profiles/ lua/main.lua
 lua/profiles/ lua/profiles/gfx_high.lua lua/profiles/gfx_low.lua
 lua/profiles/gfx_med.lua lua/profiles/gfx_ultrahigh.lua
 lua/profiles/gfx_ultralow.lua
Message-ID: <20090713205512.D3F787A980EA@simon>

Author: sience
Date: Mon Jul 13 22:55:12 2009
New Revision: 3073

Log:
-data/profiles moved to lua/profiles

Added:
    trunk/lua/profiles/
    trunk/lua/profiles/gfx_high.lua
    trunk/lua/profiles/gfx_low.lua
    trunk/lua/profiles/gfx_med.lua
    trunk/lua/profiles/gfx_ultrahigh.lua
    trunk/lua/profiles/gfx_ultralow.lua
Removed:
    trunk/data/profiles/
Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Jul 13 22:55:12 2009
@@ -192,7 +192,7 @@
 --###############################
 if (gGraphicProfile) then
     print("gGraphicProfile shadow",gGraphicProfile)
-    local graphicprofile=3Ddatapath.."profiles/gfx_"..gGraphicProfile..".l=
ua"
+    local graphicprofile=3Dlibpath.."profiles/gfx_"..gGraphicProfile..".lu=
a"
     if (file_exists(graphicprofile)) then
         -- execute local graphicprofile
         dofile(graphicprofile)



From no-reply at zwischenwelt.org  Mon Jul 13 23:50:08 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 13 Jul 2009 21:50:08 -0000
Subject: [Iris-commit] [IRIS] r3074 - /trunk/config/shards/zwischenwelt.xml
Message-ID: <20090713215008.2E0007A980EA@simon>

Author: sience
Date: Mon Jul 13 23:50:08 2009
New Revision: 3074

Log:
-Iris Testsahrd configuration added

Added:
    trunk/config/shards/zwischenwelt.xml



From no-reply at zwischenwelt.org  Mon Jul 13 23:52:15 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 13 Jul 2009 21:52:15 -0000
Subject: [Iris-commit] [IRIS] r3075 - /trunk/lua/lib.loading.lua
Message-ID: <20090713215221.7D9C57A980EA@simon>

Author: sience
Date: Mon Jul 13 23:52:04 2009
New Revision: 3075

Log:
-check and infos added, if map file is not found

Modified:
    trunk/lua/lib.loading.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Mon Jul 13 23:52:04 2009
@@ -456,9 +456,15 @@
             print("Applying Map diff files")
             gGroundBlockLoader =3D	CreateGroundBlockLoaderWithDiff(gGround=
BlockLoaderType	,mapheight,finalmappath,diffpath1,diffpath2) or =

 									CreateGroundBlockLoaderWithDiff("FullFile"				,mapheight,finalmap=
path,diffpath1,diffpath2)
-        else
+        elseif file_exists(finalmappath) then
             gGroundBlockLoader =3D	CreateGroundBlockLoader(gGroundBlockLoa=
derType	,mapheight,finalmappath) or
 									CreateGroundBlockLoader("FullFile"				,mapheight,finalmappath)
+        else
+	        local text =3D "Map Files not found! Please download and add the =
Server specific UO-Mapfiles! See FAQ!"
+            print(text)
+	        GuiAddChatLine(text)
+            PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
+        	return
         end
     end
         =




From no-reply at zwischenwelt.org  Tue Jul 14 22:28:48 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Jul 2009 20:28:48 -0000
Subject: [Iris-commit] [IRIS] r3076 - /tools/installer/Iris_Setup.iss
Message-ID: <20090714202848.770047A9809D@simon>

Author: sience
Date: Tue Jul 14 22:28:48 2009
New Revision: 3076

Log:
-update

Modified:
    tools/installer/Iris_Setup.iss

Modified: tools/installer/Iris_Setup.iss
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- tools/installer/Iris_Setup.iss (original)
+++ tools/installer/Iris_Setup.iss Tue Jul 14 22:28:48 2009
@@ -9,7 +9,7 @@
 #define UpdaterExeName "updater.exe"
 #define UpdaterExeName2 "emergency_update.bat"
 #define AppUrlName "iris2.url"
-#define BuildNumber "build 2952"
+#define BuildNumber "build 3021"
 #define DataDir "svnclient\Data\"
 =

 [Setup]
@@ -22,7 +22,7 @@
 DefaultDirName=3D{pf}\{#AppName2}
 DefaultGroupName=3D{#AppName2}
 LicenseFile=3D{#DataDir}\COPYING
-InfoBeforeFile=3D{#DataDir}\README.txt
+InfoBeforeFile=3D{#DataDir}\README
 OutputDir=3DOutput
 OutputBaseFilename=3D{#AppName}_Setup
 Compression=3Dlzma/normal
@@ -63,7 +63,7 @@
 =

 [Run]
 Filename: {app}\bin\{#UpdaterExeName}; WorkingDir: {app}\bin\; Flags: post=
install; Description: {cm:ConfigureIris}
-;Installing "Microsoft Visual C++ 2005 Redistributable Package" for skincr=
after
+;Installing "Microsoft Visual C++ 2008 Redistributable Package" for skincr=
after
 Filename: {app}\vcredist_x86.exe; Parameters: "/q:a /c:""install /l /q""";=
 WorkingDir: {tmp}; Flags: skipifdoesntexist; StatusMsg: "Checking for and =
installing ""Microsoft Visual C++ 2008 Redistributable Package"" if needed,=
 This can take several minutes..."
 ;Filename: {app}\vcredist_x86.exe; WorkingDir: {app}; StatusMsg: Installin=
g Visual C++ 8 SP1 Runtime
 ; maybe with Option vcredist_x86.exe /Q



From no-reply at zwischenwelt.org  Tue Jul 14 22:29:10 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Jul 2009 20:29:10 -0000
Subject: [Iris-commit] [IRIS] r3077 - /tools/updater/updater_vs9.vcproj
Message-ID: <20090714202910.C36B27A9809D@simon>

Author: sience
Date: Tue Jul 14 22:29:09 2009
New Revision: 3077

Log:
-update

Modified:
    tools/updater/updater_vs9.vcproj

Modified: tools/updater/updater_vs9.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- tools/updater/updater_vs9.vcproj (original)
+++ tools/updater/updater_vs9.vcproj Tue Jul 14 22:29:09 2009
@@ -41,7 +41,7 @@
 			<Tool
 				Name=3D"VCCLCompilerTool"
 				Optimization=3D"0"
-				PreprocessorDefinitions=3D"_DEBUG;WIN32;_WINDOWS;__WINDOWS__;__WXMSW__"
+				PreprocessorDefinitions=3D"_DEBUG;WIN32;_WINDOWS;__WINDOWS__;__WXMSW__=
;_BIND_TO_CURRENT_VCLIBS_VERSION=3D1"
 				MinimalRebuild=3D"true"
 				BasicRuntimeChecks=3D"3"
 				RuntimeLibrary=3D"3"



From no-reply at zwischenwelt.org  Tue Jul 14 22:31:01 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Jul 2009 20:31:01 -0000
Subject: [Iris-commit] [IRIS] r3078 - in /tools/gumpstudio_iris2plugin: ./
	bin/ bin/Release/
Message-ID: <20090714203101.0DCC17A9809D@simon>

Author: sience
Date: Tue Jul 14 22:31:00 2009
New Revision: 3078

Log:
-gumpstudio plugin added to create gumps in lua style

Added:
    tools/gumpstudio_iris2plugin/
    tools/gumpstudio_iris2plugin/AssemblyInfo.cs
    tools/gumpstudio_iris2plugin/Class1.cs
    tools/gumpstudio_iris2plugin/ExportForm.cs
    tools/gumpstudio_iris2plugin/ExportForm.resx
    tools/gumpstudio_iris2plugin/Iris2GumpExport.csproj
    tools/gumpstudio_iris2plugin/Iris2GumpExport.csproj.user
    tools/gumpstudio_iris2plugin/Iris2GumpExport.sln
    tools/gumpstudio_iris2plugin/app.config
    tools/gumpstudio_iris2plugin/bin/
    tools/gumpstudio_iris2plugin/bin/Release/
    tools/gumpstudio_iris2plugin/bin/Release/GumpStudioCore.dll   (with pro=
ps)
    tools/gumpstudio_iris2plugin/bin/Release/Iris2GumpExporter.dll   (with =
props)
    tools/gumpstudio_iris2plugin/bin/Release/Iris2GumpExporter.dll.config
    tools/gumpstudio_iris2plugin/bin/Release/UOFont.dll   (with props)
    tools/gumpstudio_iris2plugin/bin/Release/Ultima.dll   (with props)
    tools/gumpstudio_iris2plugin/lst.ico   (with props)



From no-reply at zwischenwelt.org  Tue Jul 14 22:34:16 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Jul 2009 20:34:16 -0000
Subject: [Iris-commit] [IRIS] r3079 - in /trunk: lua/gui/gui.helper.lua
 lua/lib.granny.loader.lua lua/lib.granny.types.lua lua/lib.macrolist.lua
 lua/lib.mainmenu.lua lua/lib.test.lua lua/main.lua plugins/loot.lua
Message-ID: <20090714203416.174587A9809D@simon>

Author: ghoulsblade
Date: Tue Jul 14 22:34:15 2009
New Revision: 3079

Log:
started work on lua granny loader, small lootscript imrpovements, small mac=
ro improvments: dress,partychaat

Added:
    trunk/lua/lib.granny.loader.lua
    trunk/lua/lib.granny.types.lua
Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.test.lua
    trunk/lua/main.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Tue Jul 14 22:34:15 2009
@@ -167,7 +167,7 @@
 		end
 	elseif bParseSpecials and string.sub(text_plain, 1, 1) =3D=3D "/" then
 		print("partychat detected",string.sub(text_plain, 2),unicode_rest)
-		local unicode_rest =3D {}
+		local unicode_rest
 		if (text_unicode) then =

 			unicode_rest =3D {}
 			for k,v in ipairs(text_unicode) do if (k > 1) then table.insert(unicode=
_rest,v) end end

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Tue Jul 14 22:34:15 2009
@@ -495,6 +495,7 @@
     if (not item) then item =3D MacroCmd_Item_FindFirstByArtID(serial) end
     if (not item) then return end
     if (item.iContainerSerial =3D=3D GetPlayerSerial()) then return end --=
 already equipped
+    if (item.iContainerSerial ~=3D GetPlayerBackPackSerial()) then return =
end -- not in backpack, other char?
     local layer =3D GetPaperdollLayerFromTileType(item.artid)
 	if (MacroCmd_GetPlayerEquipment(layer)) then return end -- something else=
 already equipped there
     print("MacroCmd_EquipItem",serial,item.amount,layer)

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Tue Jul 14 22:34:15 2009
@@ -46,6 +46,7 @@
     if (gCommandLineSwitches["-mt"]) then ToggleMacroList() return true en=
d -- macrolist-test
     if (gCommandLineSwitches["-so"]) then StartOfflineMode(gCommandLineArg=
uments[gCommandLineSwitches["-so"]+1]) return true end -- start in offline =
mode
     if (gCommandLineSwitches["-sd"]) then StartDebugMenu() return true end=
 -- start in debug mode
+    if (gCommandLineSwitches["-grannytest"]) then StartGrannyTest() return=
 true end
     if (gCommandLineSwitches["-co"]) then =

         local name =3D gCommandLineArguments[gCommandLineSwitches["-co"]+1]
         local shard =3D gShardList[name]

Modified: trunk/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.test.lua (original)
+++ trunk/lua/lib.test.lua Tue Jul 14 22:34:15 2009
@@ -103,16 +103,15 @@
 	for i=3D0,1000 do
 		f:Clear()
 		=

-		FIFO_Open(f)
+		local quickfifo =3D f:GetQuickHandle()
+		local myfun =3D FIFO_PushNetUint32
 		for k,v in pairs(t) do
-			FIFO_PushNetUint32(v.id)
-			FIFO_PushNetUint32(v.x)
-			FIFO_PushNetUint32(v.y)
-			FIFO_PushNetUint32(v.z)
-		end
-		FIFO_Close()
+			myfun(quickfifo,v.id)
+			myfun(quickfifo,v.x)
+			myfun(quickfifo,v.y)
+			myfun(quickfifo,v.z)
+		end
 		f:WriteToFile("test.bin")
-		=

 	end
 	f:Destroy()
 	local endt =3D Client_GetTicks()

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Jul 14 22:34:15 2009
@@ -66,6 +66,7 @@
 dofile(libpath .. "lib.spellinfo.lua")
 dofile(libpath .. "lib.speech.lua")
 dofile(libpath .. "lib.granny.lua")
+dofile(libpath .. "lib.granny.loader.lua")
 dofile(libpath .. "lib.bodygfx.lua")
 dofile(libpath .. "lib.stitchin.lua")
 dofile(libpath .. "lib.test.lua")

Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Tue Jul 14 22:34:15 2009
@@ -39,6 +39,8 @@
 	=

 	"skull",
 	"bank",
+	"prism", -- crimson
+	"enchanted", -- talisman-recharge?
 	"atlas", -- travel atlas
 	=

 	-- witchcraft stuff



From no-reply at zwischenwelt.org  Tue Jul 14 22:36:51 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Jul 2009 20:36:51 -0000
Subject: [Iris-commit] [IRIS] r3080 - in
 /tools/gumpstudio_iris2plugin/samples: ./ aos_status_gump.gump
 healthbar.gump healthbar_npc.gump journal.gump player_paperdoll.gump
 quickskill.gump quit.gump securetrading.gump skills.gump
Message-ID: <20090714203652.2C05E7A9809D@simon>

Author: sience
Date: Tue Jul 14 22:36:51 2009
New Revision: 3080

Log:
-gump samples added

Added:
    tools/gumpstudio_iris2plugin/samples/
    tools/gumpstudio_iris2plugin/samples/aos_status_gump.gump   (with props)
    tools/gumpstudio_iris2plugin/samples/healthbar.gump   (with props)
    tools/gumpstudio_iris2plugin/samples/healthbar_npc.gump   (with props)
    tools/gumpstudio_iris2plugin/samples/journal.gump   (with props)
    tools/gumpstudio_iris2plugin/samples/player_paperdoll.gump   (with prop=
s)
    tools/gumpstudio_iris2plugin/samples/quickskill.gump   (with props)
    tools/gumpstudio_iris2plugin/samples/quit.gump   (with props)
    tools/gumpstudio_iris2plugin/samples/securetrading.gump   (with props)
    tools/gumpstudio_iris2plugin/samples/skills.gump   (with props)



From no-reply at zwischenwelt.org  Tue Jul 14 23:44:09 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Jul 2009 21:44:09 -0000
Subject: [Iris-commit] [IRIS] r3081 - /trunk/bin/iris2.exe
Message-ID: <20090714214409.4E5D17A9809D@simon>

Author: sience
Date: Tue Jul 14 23:44:09 2009
New Revision: 3081

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Wed Jul 15 16:09:18 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Jul 2009 14:09:18 -0000
Subject: [Iris-commit] [IRIS] r3082 - in /trunk/lua: lib.granny.loader.lua
 lib.granny.types.lua main.lua
Message-ID: <20090715140918.713027A980A5@simon>

Author: ghoulsblade
Date: Wed Jul 15 16:09:18 2009
New Revision: 3082

Log:
worked on granny loader in lua

Modified:
    trunk/lua/lib.granny.loader.lua
    trunk/lua/lib.granny.types.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.granny.loader.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.loader.lua (original)
+++ trunk/lua/lib.granny.loader.lua Wed Jul 15 16:09:18 2009
@@ -24,7 +24,8 @@
 =

 dofile(libpath .. "lib.granny.types.lua")
 =

-function StartGrannyTest () =

+function GrannyTest_PreOgreInit () =

+	gDebugCategories["granny"] =3D true
 	local folderpath =3D "/cavern/uoml/Models/Monsters/"
 	local arr_dirs	=3D dirlist(folderpath,true,false)
 	local arr_files	=3D dirlist(folderpath,false,true)
@@ -35,9 +36,13 @@
 	end
 	os.exit(0)
 end
+function StartGrannyTest () =

+	=

+end
 =

 =

 function cGrannyFile:LoadFile (filepath) =

+	print("cGrannyFile:LoadFile",filepath)
 	self.filepath =3D filepath
 	local fifo =3D CreateFIFO()
 	fifo:Clear()
@@ -49,11 +54,11 @@
 =

 function cGrannyFile:Read (offset,structname) =

 	local quickfifo =3D self.quickfifo
-	local structsize =3D self.size[structname]
+	local structsize =3D self.size[structname] assert(structsize)
 	assert(offset >=3D 0,"AssertSize : negative offset : "..offset)
 	local missing =3D offset+structsize - self.miBufSize assert(missing <=3D =
0,"AssertSize : buffer too small, expected "..missing.." more bytes")
 	local res =3D {}
-	local struct =3D self.structs[structname] assert(struct)
+	local struct =3D self.structs[structname]
 	for k,memberdef in ipairs(struct) do =

 		local basetype,name,arraysize =3D unpack(memberdef)
 		local basetypesize =3D basetype.size
@@ -107,11 +112,15 @@
 	self:Visit("EOF")
 end
 =

-
+function cGrannyFile:ReadInt (iOffset) =

+	assert(iOffset+4 <=3D self.miBufSize)
+	return FIFO_PeekUint32(self.quickfifo,iOffset)
+end
 =

 function cGrannyFile:ParseItemListData (pItemList,p,iSize)
 	local quickfifo =3D self.quickfifo
 	=

+	self.mlParents =3D {}
 	self:Visit("ItemList",pItemList,p,iSize)
 	=

 	-- read header
@@ -122,7 +131,7 @@
 	-- read all nodes in list
 	local miBufSize =3D self.miBufSize
 	local GRANNY_CHUNKTYPE_MAGIC =3D 0xCA5E0000
-	local iEntryHeaderSize =3D self.size.ItemList_EntryHeader =

+	local iEntryHeaderSize =3D 3*4
 	for i=3D0,pItemListHeader.miChildCount-1 do
 		local iChunkType	=3D FIFO_PeekUint32(quickfifo,p+0)
 		local iOffset		=3D FIFO_PeekUint32(quickfifo,p+4)
@@ -144,20 +153,198 @@
 		end
 		=

 		assert(BitwiseAND(iChunkType,GRANNY_CHUNKTYPE_MAGIC) =3D=3D GRANNY_CHUNK=
TYPE_MAGIC,"ParseGranny : magic failed in subchunktype "..hex(iChunkType))
+		assert(iOffset <=3D iSize,"chunk-offset out of bounds: offset:"..hex(iOf=
fset).."size:"..iSize)
 		=

 		local myoffset =3D pItemList.miListOffset+iOffset
-		local pData =3D (myoffset < miBufSize) and (myoffset)
-		if (not pData) then iChildSize =3D 0 end
-		self:Visit("Chunk",iChunkType,myoffset,iChildren,pData,iChildSize)
-		--~ self:Visit("DecrementParents")
-		--~ self:Visit("PushParent",iChunkType,iChildren)
-	end
-end
+		assert(myoffset <=3D miBufSize)
+			=

+		self:HandleChunk(iChunkType,myoffset,iChildren,iChildSize)
+		local handler =3D self.chunkHandlers[iChunkType]
+		if (handler) then handler(self,myoffset,iChildSize) end
+		=

+		self:DecrementParents()
+		self:PushParent(iChunkType,iChildren)
+	end
+end
+
+function cGrannyFile:GetRootParentType () local p =3D self.mlParents[1] re=
turn p and p.miChunkType end
+function cGrannyFile:DecrementParents () =

+	local res =3D {}
+	for k,v in ipairs(self.mlParents) do v.miChildCount =3D v.miChildCount - =
1 if (v.miChildCount > 0) then table.insert(res,v) end end
+	self.mlParents =3D res
+end
+function cGrannyFile:GetParentDepth() return #self.mlParents end
+function cGrannyFile:PushParent(iChunkType,iChildCount)
+	if (iChildCount > 0) then table.insert(self.mlParents,{miChunkType=3DiChu=
nkType,miChildCount=3DiChildCount}) end
+end
+
+
+function cGrannyFile:HandleChunk (iChunkType,iOffset,iChildren,iSize) =

+	--~ self:Visit("Chunk",myoffset,iChildren,iChildSize,tostring(self.kTypeN=
ames[iChunkType]))
+	self:Visit("Chunk:"..hex(iChunkType),iOffset,iChildren,iSize,string.rep("=
 ",self:GetParentDepth())..tostring(self.kTypeNames[iChunkType]))
+	=

+	=

+	-- if (1) { VisitUnknown(iChunkType,iOffset,iChildren,iSize); return; } =

+	-- VisitUnknown(iChunkType,iOffset,iChildren,iSize); =

+	=

+	=

+	--  FIFO_PeekUint32(self.quickfifo,iOffset)
+	--~ const uint32* pInts =3D (const uint32*)(pbufffff+iOffset);
+end
+
+
+function cGrannyFile:HexDump(iOffset,iSize)
+	print("hexdump",iOffset,iSize)
+	for i=3D0,iSize-1 do =

+		local b =3D FIFO_PeekUint8(self.quickfifo,iOffset+i)
+		local txt =3D sprintf(" 0x%04x:  b:0x%02x=3D%3d",i,b,b)
+		if (i+4 <=3D iSize) then =

+			local x =3D FIFO_PeekUint32(		self.quickfifo,iOffset+i)
+			local y =3D FIFO_PeekNetUint32(	self.quickfifo,iOffset+i)
+			local f =3D FIFO_PeekFloat(		self.quickfifo,iOffset+i)
+			txt =3D txt .. sprintf(" i:0x%08x=3D%10d i2:0x%08x=3D%10d f:%f",x,x,y,y=
,f)
+		end
+		print(txt)
+	end
+end =

+
+function cGrannyFile:VisitTextChunk () end
+function cGrannyFile:VisitMeshID () end
+function cGrannyFile:VisitBoneTieID () end
+function cGrannyFile:VisitTexInfoID () end
+function cGrannyFile:VisitObj () end
+function cGrannyFile:VisitObjKey () end
+function cGrannyFile:VisitObjValue () end
+function cGrannyFile:VisitPoints () end
+function cGrannyFile:VisitNormals () end
+function cGrannyFile:VisitPolygons () end
+function cGrannyFile:VisitTexCoords () end
+function cGrannyFile:VisitWeights () end
+function cGrannyFile:VisitTexPolygonsSmall () end
+function cGrannyFile:VisitTexPolygons () end
+function cGrannyFile:VisitTexPolygonsBig () end
+function cGrannyFile:VisitBone () end
+function cGrannyFile:VisitTexInfo () end
+
+
+cGrannyFile.chunkHandlers =3D {}
+
+cGrannyFile.chunkHandlers[0xCA5E0200] =3D function (self,iOffset,iSize) as=
sert(iSize >=3D 8) self:VisitTextChunk(self:ReadInt(iOffset),self:ReadInt(i=
Offset+1),iOffset + 8,iSize-8) end
+cGrannyFile.chunkHandlers[0xCA5E0f04] =3D function (self,iOffset,iSize)
+	if (self:GetRootParentType() =3D=3D 0XCA5E0602) then assert(iSize =3D=3D =
4) self:VisitMeshID(self:ReadInt(iOffset)) end
+	if (self:GetRootParentType() =3D=3D 0XCA5E0B01) then assert(iSize =3D=3D =
4) self:VisitBoneTieID(self:ReadInt(iOffset)) end
+	if (self:GetRootParentType() =3D=3D 0XCA5E0304) then assert(iSize =3D=3D =
4) self:VisitTexInfoID(self:ReadInt(iOffset)) end
+end
+	=

+cGrannyFile.chunkHandlers[0XCA5E0F00] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0F03) then assert(iSize =3D=3D 8,"s=
ize-mismatch:"..iSize) self:VisitObj(self:ReadInt(iOffset),self:ReadInt(iOf=
fset+1)) end end
+cGrannyFile.chunkHandlers[0XCA5E0F01] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0F03) then assert(iSize =3D=3D 4) s=
elf:VisitObjKey(self:ReadInt(iOffset)) end end
+cGrannyFile.chunkHandlers[0XCA5E0F02] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0F03) then assert(iSize =3D=3D 8) s=
elf:VisitObjValue(self:ReadInt(iOffset),self:ReadInt(iOffset+1)) end end
+
+cGrannyFile.chunkHandlers[0XCA5E0801] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then self:VisitPoints(iOffset=
,iSize/self.size.Vector) end end
+cGrannyFile.chunkHandlers[0XCA5E0802] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then self:VisitNormals(iOffse=
t,iSize/self.size.Vector) end end
+cGrannyFile.chunkHandlers[0XCA5E0901] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then self:VisitPolygons(iOffs=
et,iSize/self.size.Polygon) end end
+cGrannyFile.chunkHandlers[0XCA5E0803] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then assert(iSize >=3D 4) sel=
f:VisitTexCoords(self:ReadInt(iOffset),(iOffset+4),(iSize-4)/self.size.Vect=
or) end end
+cGrannyFile.chunkHandlers[0XCA5E0702] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then assert(iSize >=3D 3*4) s=
elf:VisitWeights(self:ReadInt(iOffset),self:ReadInt(iOffset+1),self:ReadInt=
(iOffset+2),iOffset+3*4,iSize-3*4) end end
+		=

+cGrannyFile.chunkHandlers[0xCA5E0e06] =3D function (self,iOffset,iSize) =

+	if (self:GetRootParentType() =3D=3D 0XCA5E0E01) then
+		assert(iSize >=3D 4) =

+		local iNum =3D self:ReadInt(iOffset)
+		local iElementSize =3D floor((iSize-4)/iNum)
+		if (iSize-4 ~=3D iNum*iElementSize) then
+			printdebug("granny","cGrannyVisitor::VisitChunk 0xCA5E0e06 unexpected s=
ize (num=3D%d,elsize=3D%d): %d/%d",iNum,iElementSize,iSize-4,iNum*iElementS=
ize)
+		end
+		=

+			if (iElementSize =3D=3D self.size.TexturePolySmall)	then self:VisitTexP=
olygonsSmall((iOffset+4),iNum) =

+		elseif (iElementSize =3D=3D self.size.TexturePoly)		then self:VisitTexPo=
lygons(		(iOffset+4),iNum) =

+		elseif (iElementSize =3D=3D self.size.TexturePolyBig)	then self:VisitTex=
PolygonsBig(	(iOffset+4),iNum) =

+		else =

+			printdebug("granny","cGrannyVisitor::VisitChunk 0xCA5E0e06 unexpected e=
lement-size : %d",iElementSize) =

+			self:HexDump(iOffset,iSize) =

+		end
+	end
+end
+cGrannyFile.chunkHandlers[0XCA5E0506] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0507) then assert(iSize =3D=3D self=
.size.Bone) self:VisitBone(iOffset) end end
+cGrannyFile.chunkHandlers[0xCA5E0303] =3D function (self,iOffset,iSize) =

+	if (self:GetRootParentType() =3D=3D 0XCA5E0304) then =

+		if (iSize ~=3D self.size.TexInfo) then =

+			printdebug("granny","WARNING ! granny 0xCA5E0303 : size1=3D%d size2=3D%=
d",iSize,self.size.TexInfo)
+		end
+		assert(iSize >=3D self.size.TexInfo); =

+		self:VisitTexInfo(iOffset) =

+	end =

+end
+
+function cGrannyFile:VisitBoneTie2ID () end
+function cGrannyFile:VisitBoneTie2GroupID () end
+function cGrannyFile:VisitBoneTies2 () end
+function cGrannyFile:VisitBoneTie () end
+function cGrannyFile:VisitTextureID () end
+function cGrannyFile:VisitTexturePoly () end
+function cGrannyFile:VisitTexturePolyData () end
+
+
+cGrannyFile.chunkHandlers[0XCA5E0C08] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then assert(iSize =3D=3D 4) s=
elf:VisitBoneTie2ID(self:ReadInt(iOffset)) end end
+cGrannyFile.chunkHandlers[0XCA5E0C03] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then assert(iSize =3D=3D 4) s=
elf:VisitBoneTie2GroupID(self:ReadInt(iOffset)) end end
+cGrannyFile.chunkHandlers[0XCA5E0C02] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then self:VisitBoneTies2(iOff=
set,iSize/4) end end
+cGrannyFile.chunkHandlers[0xCA5E0c0a] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then assert(iSize =3D=3D self=
.size.BoneTie) self:VisitBoneTie(iOffset) end end
+
+cGrannyFile.chunkHandlers[0XCA5E0E00] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0E01) then  assert(iSize =3D=3D 4) =
self:VisitTextureID(self:ReadInt(iOffset)) end end
+cGrannyFile.chunkHandlers[0XCA5E0E02] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0E01) then  assert(iSize =3D=3D 8) =
self:VisitTexturePoly(self:ReadInt(iOffset),self:ReadInt(iOffset+1)) end end
+cGrannyFile.chunkHandlers[0XCA5E0E04] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0E01) then  assert(iSize =3D=3D 4) =
self:VisitTexturePolyData(self:ReadInt(iOffset)) end end
+
+cGrannyFile.chunkHandlers[0XCA5E1204] =3D function (self,iOffset,iSize) =

+	if (self:GetRootParentType() =3D=3D 0XCA5E1205) then
+		assert(iSize >=3D self.size.Anim)
+		--[[
+		const char* p =3D iOffset;
+		GrannyAnim*	pAnim 				=3D (GrannyAnim*)p; 		p +=3D self.size.Anim;
+		float*	pTranslateTime 			=3D (float*)p; 			p +=3D self.size.float		*pAni=
m->iNumTranslate;
+		float*	pQuaternionTime 		=3D (float*)p; 			p +=3D self.size.float		*pAni=
m->iNumQuaternion;
+		float*	pScaleTime 				=3D (float*)p; 			p +=3D self.size.float		*pAnim->=
iNumScale;
+		GrannyVector*		pTranslate	=3D (GrannyVector*)p; 	p +=3D self.size.Vector=
		*pAnim->iNumTranslate;
+		GrannyQuaternion*	pQuaternion	=3D (GrannyQuaternion*)p; p +=3D self.size=
.Quaternion	*pAnim->iNumQuaternion;
+		GrannyVector*		pScale		=3D (GrannyVector*)p;		p +=3D self.size.Vector		*=
pAnim->iNumScale;
+		GrannyVector*		pRest		=3D (GrannyVector*)p;
+		int 	iUsedSize =3D p - iOffset;
+		local MAX_PARTNUM_0XCA5E1204 =3D 0x0000ffff
+		bool	bBroken =3D	iUsedSize 				< 0 or iSize < iUsedSize or =

+							pAnim->iNumTranslate 	< 0 or pAnim->iNumTranslate		>=3D MAX_PARTNUM=
_0XCA5E1204 or =

+							pAnim->iNumQuaternion 	< 0 or pAnim->iNumQuaternion	>=3D MAX_PARTNU=
M_0XCA5E1204 or =

+							pAnim->iNumScale 		< 0 or pAnim->iNumScale			>=3D MAX_PARTNUM_0XCA5=
E1204;
+		if (bBroken) then
+			--~ printf("0XCA5E1204 broken : %08x %08x\n",(int)iOffset,(int)p);
+			--~ printf("0XCA5E1204 broken : iNumTranslate=3D%d\n",pAnim->iNumTransl=
ate);
+			--~ printf("0XCA5E1204 broken : iNumQuaternion=3D%d\n",pAnim->iNumQuate=
rnion);
+			--~ printf("0XCA5E1204 broken : iNumScale=3D%d\n",pAnim->iNumScale);
+			--~ printf("0XCA5E1204 broken : iSize=3D%d iUsedSize=3D%d\n",iSize,iUse=
dSize);
+		end
+		float	fTotalTime =3D 0;
+		if (not bBroken) then
+			float	fTotalTimeT =3D (pAnim->iNumTranslate > 0) ? pTranslateTime[pAnim=
->iNumTranslate-1] : 0;
+			float	fTotalTimeQ =3D (pAnim->iNumQuaternion > 0) ? pQuaternionTime[pAn=
im->iNumQuaternion-1] : 0;
+			float	fTotalTimeS =3D (pAnim->iNumScale > 0) ? pScaleTime[pAnim->iNumSc=
ale-1] : 0;
+			fTotalTime =3D mymax(mymax(fTotalTimeT,fTotalTimeQ),fTotalTimeS);
+		end
+		VisitGrannyAnim(pAnim,
+			bBroken?0:pTranslateTime,
+			bBroken?0:pQuaternionTime,
+			bBroken?0:pScaleTime,
+			bBroken?0:pTranslate,
+			bBroken?0:pQuaternion,
+			bBroken?0:pScale,
+			bBroken?0:pRest,
+			bBroken?0:fTotalTime,
+			bBroken?0:iUsedSize,iSize);
+		]]--
+	end =

+end
+
 =

 function cGrannyFile:Visit (name,...) =

 	if (self.visit_last_name =3D=3D name) then
 		if (self.visit_last_count =3D=3D 11) then print("...") end
-		if (self.visit_last_count > 11) then return end
+		if (self.visit_last_count  > 11) then return end
 			self.visit_last_count =3D self.visit_last_count + 1
 	else
 		self.visit_last_name =3D name

Modified: trunk/lua/lib.granny.types.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.types.lua (original)
+++ trunk/lua/lib.granny.types.lua Wed Jul 15 16:09:18 2009
@@ -1,76 +1,13 @@
-
-cGrannyFile.kTypeNames =3D {}
-cGrannyFile.kTypeNames[0xCA5E0100] =3D "ML_SE_Texture" -- SiENcE:  Chunk i=
s new to ML/SE Models maybe Texture: case 0xca5e0100
-cGrannyFile.kTypeNames[0xCA5E0101] =3D "final" -- Final Chunk (End-of-File=
?)	=

-cGrannyFile.kTypeNames[0xCA5E0102] =3D "Copyright"
-cGrannyFile.kTypeNames[0xCA5E0103] =3D "Object"
-cGrannyFile.kTypeNames[0xCA5E0200] =3D "textChunk"
-cGrannyFile.kTypeNames[0xCA5E0304] =3D "texture_info_list"
-cGrannyFile.kTypeNames[0xCA5E0303] =3D "texinfo"
-cGrannyFile.kTypeNames[0xCA5E0301] =3D "texture_info"
-cGrannyFile.kTypeNames[0xCA5E0507] =3D "bones"
-cGrannyFile.kTypeNames[0xCA5E0601] =3D "mesh"
-cGrannyFile.kTypeNames[0xCA5E0602] =3D "mesh_list"
-cGrannyFile.kTypeNames[0xCA5E0603] =3D "point_container"
-cGrannyFile.kTypeNames[0xCA5E0604] =3D "point_block"
-cGrannyFile.kTypeNames[0xCA5E0702] =3D "weights"
-
-cGrannyFile.kTypeNames[0xCA5E0801] =3D "points"
-cGrannyFile.kTypeNames[0xCA5E0802] =3D "normals"
-cGrannyFile.kTypeNames[0xCA5E0803] =3D "texcoords"
-cGrannyFile.kTypeNames[0xCA5E0804] =3D "texture_container"
-cGrannyFile.kTypeNames[0xCA5E0901] =3D "polygons"
-cGrannyFile.kTypeNames[0xCA5E0f04] =3D "id" -- depends on parent structure
-
-cGrannyFile.kTypeNames[0xCA5E0b00] =3D "boneobject" -- bone-name ??
-cGrannyFile.kTypeNames[0xCA5E0c00] =3D "boneties container"
-cGrannyFile.kTypeNames[0xCA5E0c02] =3D "bone objptrs"
-cGrannyFile.kTypeNames[0xCA5E0c03] =3D "bonetie group"
-cGrannyFile.kTypeNames[0xCA5E0c04] =3D "bonetie data"
-cGrannyFile.kTypeNames[0xCA5E0c05] =3D "end bone objptrs"
-cGrannyFile.kTypeNames[0xCA5E0c06] =3D "bonetie container"
-cGrannyFile.kTypeNames[0xCA5E0c07] =3D "bone objptrs container"
-cGrannyFile.kTypeNames[0xCA5E0c08] =3D "bone objptr"
-cGrannyFile.kTypeNames[0xCA5E0c09] =3D "bonetie list"
-cGrannyFile.kTypeNames[0xCA5E0c0a] =3D "bonetie"
-cGrannyFile.kTypeNames[0xCA5E0505] =3D "skeleton"
-cGrannyFile.kTypeNames[0xCA5E0506] =3D "bone"
-cGrannyFile.kTypeNames[0xCA5E0508] =3D "bonelist"
-
-cGrannyFile.kTypeNames[0xCA5E0a01] =3D "unhandled"
-cGrannyFile.kTypeNames[0xCA5E0b01] =3D "boneTies1" -- bone_name_list ?
-cGrannyFile.kTypeNames[0xCA5E0c01] =3D "boneTies2"
-cGrannyFile.kTypeNames[0xCA5E0d01] =3D "unhandled"
-cGrannyFile.kTypeNames[0xCA5E0e00] =3D "texture"
-cGrannyFile.kTypeNames[0xCA5E0e01] =3D "texture_list"
-
-cGrannyFile.kTypeNames[0xCA5E0e02] =3D "texture_poly"
-cGrannyFile.kTypeNames[0xCA5E0e03] =3D "texture_poly_datalist"
-cGrannyFile.kTypeNames[0xCA5E0e04] =3D "texture_poly_data1"
-cGrannyFile.kTypeNames[0xCA5E0e05] =3D "texture_poly_data2"
-cGrannyFile.kTypeNames[0xCA5E0e06] =3D "texture_poly_list"
-cGrannyFile.kTypeNames[0xCA5E0e07] =3D "texture_sublist"
-
-cGrannyFile.kTypeNames[0xCA5E0f00] =3D "object"
-cGrannyFile.kTypeNames[0xCA5E0f01] =3D "object_key"
-cGrannyFile.kTypeNames[0xCA5E0f02] =3D "object_value"
-cGrannyFile.kTypeNames[0xCA5E0f03] =3D "object_list"
-cGrannyFile.kTypeNames[0xCA5E0f05] =3D "object_key_list"
-cGrannyFile.kTypeNames[0xCA5E0f06] =3D "object_value_list"
-cGrannyFile.kTypeNames[0xCA5E1003] =3D "unhandled"
-
-cGrannyFile.kTypeNames[0xCA5E1200] =3D "animation_sublist"
-cGrannyFile.kTypeNames[0xCA5E1201] =3D "animation_data"
-cGrannyFile.kTypeNames[0xCA5E1203] =3D "animation"
-cGrannyFile.kTypeNames[0xCA5E1204] =3D "animdata"
-cGrannyFile.kTypeNames[0xCA5E1205] =3D "animation_list"
-
-cGrannyFile.kTypeNames[0xCA5Effff] =3D "end"
 =

 =

 function cGrannyFile:DefineTypes () =

 	if (self.structs) then return end
 	self.kChunkType_Main =3D 0xCA5E0000
+	self:DefineStructs()
+	self:DefineTypeNames()
+end
+
+function cGrannyFile:DefineStructs ()
 	self.structs =3D {}
 	self.basetypes =3D {}
 	local uint8		=3D {name=3D"uint8"	,size=3D1,peekfun=3DFIFO_PeekUint8}
@@ -79,6 +16,7 @@
 	self.basetypes.uint8	=3D uint8
 	self.basetypes.uint32	=3D uint32
 	self.basetypes.float	=3D float
+	=

 	self.structs.MainChunk =3D {
 		{uint8	,"mHeader",0x40};	--/< unknown, Could be FileType magic
 		{uint32	,"miChunkType"},	--/< kChunkType
@@ -97,12 +35,6 @@
 		{uint32	,"miChildCount"},
 		{uint32	,"miUnknown",3},
 	}
-	=

-	self.structs.ItemList_EntryHeader =3D {
-		{uint32	,"miChunkType"},
-		{uint32	,"miOffset"},
-		{uint32	,"miChildren"},
-	}
 =

 	self.structs.Vector =3D {
 		{float	,"x,y,z"},
@@ -118,6 +50,10 @@
 		{uint32	,"iNormal",3},
 	}
 =

+	self.structs.TexturePolySmall =3D {
+		{uint32	,"iUnknown"}, -- rising int, like 0 1 2 ... 13
+	}
+	=

 	self.structs.TexturePoly =3D {
 		{uint32	,"iUnknown"},
 		{uint32	,"iTexCoord",3},
@@ -159,6 +95,7 @@
 		{uint32	,"iUnknownB",4}, --/< global rot ?
 	}
 	self.size =3D {}
+	for name,data in pairs(self.basetypes) do self.size[name] =3D data.size e=
nd
 	for structname,struct in pairs(self.structs) do =

 		local size =3D 0
 		for k,member in pairs(struct) do =

@@ -168,3 +105,73 @@
 		self.size[structname] =3D size
 	end
 end
+
+function cGrannyFile:DefineTypeNames ()
+	self.kTypeNames =3D {}
+	self.kTypeNames[0xCA5E0100] =3D "ML_SE_Texture" -- SiENcE:  Chunk is new =
to ML/SE Models maybe Texture: case 0xca5e0100
+	self.kTypeNames[0xCA5E0101] =3D "final" -- Final Chunk (End-of-File?)	=

+	self.kTypeNames[0xCA5E0102] =3D "Copyright"
+	self.kTypeNames[0xCA5E0103] =3D "Object"
+	self.kTypeNames[0xCA5E0200] =3D "textChunk"
+	self.kTypeNames[0xCA5E0304] =3D "texture_info_list"
+	self.kTypeNames[0xCA5E0303] =3D "texinfo"
+	self.kTypeNames[0xCA5E0301] =3D "texture_info"
+	self.kTypeNames[0xCA5E0507] =3D "bones" -- SkeletonList?
+	self.kTypeNames[0xCA5E0601] =3D "mesh"
+	self.kTypeNames[0xCA5E0602] =3D "mesh_list"
+	self.kTypeNames[0xCA5E0603] =3D "point_container"
+	self.kTypeNames[0xCA5E0604] =3D "point_block"
+	self.kTypeNames[0xCA5E0702] =3D "weights"
+
+	self.kTypeNames[0xCA5E0801] =3D "points"
+	self.kTypeNames[0xCA5E0802] =3D "normals"
+	self.kTypeNames[0xCA5E0803] =3D "texcoords"
+	self.kTypeNames[0xCA5E0804] =3D "texture_container"
+	self.kTypeNames[0xCA5E0901] =3D "polygons"
+	self.kTypeNames[0xCA5E0f04] =3D "id" -- depends on parent structure
+
+	self.kTypeNames[0xCA5E0b00] =3D "boneobject" -- bone-name ??
+	self.kTypeNames[0xCA5E0c00] =3D "boneties container"
+	self.kTypeNames[0xCA5E0c02] =3D "bone objptrs"
+	self.kTypeNames[0xCA5E0c03] =3D "bonetie group"
+	self.kTypeNames[0xCA5E0c04] =3D "bonetie data"
+	self.kTypeNames[0xCA5E0c05] =3D "end bone objptrs"
+	self.kTypeNames[0xCA5E0c06] =3D "bonetie container"
+	self.kTypeNames[0xCA5E0c07] =3D "bone objptrs container"
+	self.kTypeNames[0xCA5E0c08] =3D "bone objptr"
+	self.kTypeNames[0xCA5E0c09] =3D "bonetie list"
+	self.kTypeNames[0xCA5E0c0a] =3D "bonetie"
+	self.kTypeNames[0xCA5E0505] =3D "skeleton"
+	self.kTypeNames[0xCA5E0506] =3D "bone"
+	self.kTypeNames[0xCA5E0508] =3D "bonelist"
+
+	self.kTypeNames[0xCA5E0a01] =3D "unhandled"
+	self.kTypeNames[0xCA5E0b01] =3D "boneTies1" -- bone_name_list ?
+	self.kTypeNames[0xCA5E0c01] =3D "boneTies2"
+	self.kTypeNames[0xCA5E0d01] =3D "unhandled"
+	self.kTypeNames[0xCA5E0e00] =3D "texture"
+	self.kTypeNames[0xCA5E0e01] =3D "texture_list"
+
+	self.kTypeNames[0xCA5E0e02] =3D "texture_poly"
+	self.kTypeNames[0xCA5E0e03] =3D "texture_poly_datalist"
+	self.kTypeNames[0xCA5E0e04] =3D "texture_poly_data1"
+	self.kTypeNames[0xCA5E0e05] =3D "texture_poly_data2"
+	self.kTypeNames[0xCA5E0e06] =3D "texture_poly_list"
+	self.kTypeNames[0xCA5E0e07] =3D "texture_sublist"
+
+	self.kTypeNames[0xCA5E0f00] =3D "object"
+	self.kTypeNames[0xCA5E0f01] =3D "object_key"
+	self.kTypeNames[0xCA5E0f02] =3D "object_value"
+	self.kTypeNames[0xCA5E0f03] =3D "object_list"
+	self.kTypeNames[0xCA5E0f05] =3D "object_key_list"
+	self.kTypeNames[0xCA5E0f06] =3D "object_value_list"
+	self.kTypeNames[0xCA5E1003] =3D "unhandled"
+
+	self.kTypeNames[0xCA5E1200] =3D "animation_sublist"
+	self.kTypeNames[0xCA5E1201] =3D "animation_data"
+	self.kTypeNames[0xCA5E1203] =3D "animation"
+	self.kTypeNames[0xCA5E1204] =3D "animdata"
+	self.kTypeNames[0xCA5E1205] =3D "animation_list"
+
+	self.kTypeNames[0xCA5Effff] =3D "end" =

+end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Wed Jul 15 16:09:18 2009
@@ -388,6 +388,7 @@
 		UOProxyMode(host,port)
 		return  =

 	end
+    if (gCommandLineSwitches["-grannytest"]) then GrannyTest_PreOgreInit()=
 end
 	if (OgreWrapperSetEnableUnicode) then OgreWrapperSetEnableUnicode(true) e=
nd -- ois init param
 	=

     gRegistry =3D cRegistry:New(gTempPath.."global.reg")



From no-reply at zwischenwelt.org  Wed Jul 15 21:09:06 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Jul 2009 19:09:06 -0000
Subject: [Iris-commit] [IRIS] r3083 - /trunk/lua/lib.light.lua
Message-ID: <20090715190906.6DBE57A980A5@simon>

Author: sience
Date: Wed Jul 15 21:09:06 2009
New Revision: 3083

Log:
-bugfix

Modified:
    trunk/lua/lib.light.lua

Modified: trunk/lua/lib.light.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.light.lua (original)
+++ trunk/lua/lib.light.lua Wed Jul 15 21:09:06 2009
@@ -6,9 +6,9 @@
 =

 function SetupWorldLight_Default ()
     -- disable directional light for depthshadowmapping (integrated_shadow=
mapping)
-    if (not(gShadowTechnique =3D=3D "texture_modulative_integrated") or
-        not(gShadowTechnique =3D=3D "texture_additive_integrated")) then
-        =

+    if not((gShadowTechnique =3D=3D "texture_modulative_integrated") or
+           (gShadowTechnique =3D=3D "texture_additive_integrated")) then
+
         -- Sun Light
         local xyz =3D gSunLightDirection      =

         gDirectionalLightSun =3D Client_AddDirectionalLight(xyz.x,xyz.y,xy=
z.z)



From no-reply at zwischenwelt.org  Wed Jul 15 22:04:39 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Jul 2009 20:04:39 -0000
Subject: [Iris-commit] [IRIS] r3084 - in /trunk/lua: lib.3d.light.lua
 lib.3d.renderer.lua lib.light.lua
Message-ID: <20090715200439.7ED1B7A980A6@simon>

Author: sience
Date: Wed Jul 15 22:04:39 2009
New Revision: 3084

Log:
-some cleanups & fixes to lightsystem

Modified:
    trunk/lua/lib.3d.light.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.light.lua

Modified: trunk/lua/lib.3d.light.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.light.lua (original)
+++ trunk/lua/lib.3d.light.lua Wed Jul 15 22:04:39 2009
@@ -155,14 +155,10 @@
 	Client_SetLightAttenuation(self.mPersonalLightName, Renderer3D.CalculateP=
ointLightAttenuation(5))
 	Light_SetCastShadows(self.mPersonalLightName, false)
 	=

-	if (not(gCaelumSystem)) then
-		-- update ambient light
-		if gAmbientLight then
-			Client_SetAmbientLight(gAmbientLight.r*a, gAmbientLight.g*a, gAmbientLi=
ght.b*a,1)
-		end
-		=

+	-- look at lib.light.lua for SetupWorldLight_Default ()
+	if not(gUseCaelumSkysystem) then
 		-- update directional Sun Light
-		if gDirectionalLightSun and gDirectionalLightSun then
+		if gDirectionalLightSun and gSunLightDirection then
 			local xyz =3D gSunLightDirection		=

 			=

 			local rgb =3D gSunLightDiffuse		=

@@ -170,6 +166,11 @@
 			=

 			local rgb =3D gSunLightSpecular		=

 			Client_SetLightSpecularColor(gDirectionalLightSun,rgb.r*a,rgb.g*a,rgb.b=
*a)
+		end
+
+		-- update ambient light
+		if gAmbientLight then
+			Client_SetAmbientLight(gAmbientLight.r*a, gAmbientLight.g*a, gAmbientLi=
ght.b*a,1)
 		end
 	end
 end

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Jul 15 22:04:39 2009
@@ -71,13 +71,11 @@
 function Renderer3D:StartWorld ()
     -- for 2D/3D renderer switching
     self:CamInit()
-    =

-    -- only Worldlight when Caelum is disabled
-    if (not(gCaelumSystem)) then
-        Client_ClearLights()
-        -- initialize Worldlight for normal SkyBox=C2=B4
-        SetupWorldLight_Default()
-    end
+
+    -- clear all Lights =

+    Client_ClearLights()
+    -- initialize Worldlight for normal SkyBox=C2=B4
+    SetupWorldLight_Default()
 =

     -- initialize Mapenvironment
     self:SetMapEnvironment()
@@ -334,17 +332,31 @@
 --mLiSPSMSetup =3D new LiSPSMShadowCameraSetup()
 --m_pSceneMgr->setShadowCameraSetup(ShadowCameraSetupPtr(mLiSPSMSetup))
     elseif ((strShadowTechnique =3D=3D "texture_additive_integrated") or (=
strShadowTechnique =3D=3D "texture_modulative_integrated")) then
+        OgreSetShadowTextureSelfShadow(true)
+		OgreSetShadowTextureCasterMaterial("shadow_caster")
         OgreSetShadowTextureCount(4)                -- first mention the c=
ount (one texture for one lightsource)
-        OgreSetShadowTextureSize(512)               -- then the texsize
-        OgreSetShadowFarDistance(shadowfardist)
-        OgreSetShadowTextureFadeStart(0.6)
-        OgreSetShadowTextureFadeEnd(0.9)
-        OgreSetShadowTexturePixelFormat(PF_FLOAT32_R)
+        OgreSetShadowTextureSize(256)               -- then the texsize
+        OgreSetShadowTexturePixelFormat(PF_FLOAT16_RGB)
         OgreSetShadowCasterRenderBackFaces(false)
-        OgreSetShadowTextureSelfShadow(true)
-        OgreSetShadowTextureCasterMaterial("DepthShadowmap/Caster/Float")
-        OgreSetShadowTextureReceiverMaterial("tex_base")
+--[[
+    const unsigned numShadowRTTs =3D mgr.sceneMgr->getShadowTextureCount();
+    for (unsigned i =3D 0; i < numShadowRTTs; ++i)
+    {
+        Ogre::TexturePtr tex =3D mgr.sceneMgr->getShadowTexture(i);
+        Ogre::Viewport *vp =3D tex->getBuffer()->getRenderTarget()->getVie=
wport(0);
+        vp->setBackgroundColour(Ogre::ColourValue(1, 1, 1, 1));
+        vp->setClearEveryFrame(true);
+    }
+]]--
+--        OgreSetShadowFarDistance(shadowfardist)
+--        OgreSetShadowTextureFadeStart(0.6)
+--        OgreSetShadowTextureFadeEnd(0.9)
+--        OgreSetShadowTextureReceiverMaterial("tex_base")
         OgreShadowTechnique(strShadowTechnique)     -- last, the technique
+--[[        =

+        // and add the shader listener
+	    mgr.sceneMgr->addListener(&shadowCameraUpdater);
+]]--
     else
         -- any other is like setting No shadows
         OgreShadowTechnique(strShadowTechnique)

Modified: trunk/lua/lib.light.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.light.lua (original)
+++ trunk/lua/lib.light.lua Wed Jul 15 22:04:39 2009
@@ -5,22 +5,30 @@
 ]]--
 =

 function SetupWorldLight_Default ()
-    -- disable directional light for depthshadowmapping (integrated_shadow=
mapping)
-    if not((gShadowTechnique =3D=3D "texture_modulative_integrated") or
-           (gShadowTechnique =3D=3D "texture_additive_integrated")) then
+	if not(gUseCaelumSkysystem) then
 =

-        -- Sun Light
-        local xyz =3D gSunLightDirection      =

-        gDirectionalLightSun =3D Client_AddDirectionalLight(xyz.x,xyz.y,xy=
z.z)
-        =

-        local rgb =3D gSunLightDiffuse        =

-        Client_SetLightDiffuseColor(gDirectionalLightSun,rgb.r,rgb.g,rgb.b)
-        =

-        local rgb =3D gSunLightSpecular       =

-        Client_SetLightSpecularColor(gDirectionalLightSun,rgb.r,rgb.g,rgb.=
b)
-    end
+		-- setup directional Sun Light
+	    -- disable directional light for depthshadowmapping (integrated_shado=
wmapping)
+	    if not((gShadowTechnique =3D=3D "texture_modulative_integrated") or
+	           (gShadowTechnique =3D=3D "texture_additive_integrated")) then
 =

-    -- Ambient Light
-    local rgb =3D gAmbientLight           =

-    Client_SetAmbientLight(rgb.r,rgb.g,rgb.b, 1)
+			if gSunLightDirection then
+		        local xyz =3D gSunLightDirection      =

+		        gDirectionalLightSun =3D Client_AddDirectionalLight(xyz.x,xyz.y,=
xyz.z)
+		        =

+		        local rgb =3D gSunLightDiffuse        =

+		        Client_SetLightDiffuseColor(gDirectionalLightSun,rgb.r,rgb.g,rgb=
.b)
+		        =

+		        local rgb =3D gSunLightSpecular       =

+		        Client_SetLightSpecularColor(gDirectionalLightSun,rgb.r,rgb.g,rg=
b.b)
+		    end
+
+		end
+
+		-- setup ambient light
+	    if gAmbientLight then
+		    Client_SetAmbientLight(gAmbientLight.r, gAmbientLight.g, gAmbientLig=
ht.b, 1)
+		end
+
+	end
 end



From no-reply at zwischenwelt.org  Wed Jul 15 22:58:12 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Jul 2009 20:58:12 -0000
Subject: [Iris-commit] [IRIS] r3085 - /trunk/lua/lib.3d.renderer.lua
Message-ID: <20090715205812.669D37A980A5@simon>

Author: sience
Date: Wed Jul 15 22:58:12 2009
New Revision: 3085

Log:
-bugfix

Modified:
    trunk/lua/lib.3d.renderer.lua

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Jul 15 22:58:12 2009
@@ -23,6 +23,8 @@
 dofile(libpath .. "lib.3d.hudfx.lua")
 =

 gRendererList[ "Renderer3D" ] =3D Renderer3D
+
+local gCaelumSystem =3D nil
 =

 -- static Factor to rise the Z-Level for statics+dynamics
 Renderer3D.gZ_Factor =3D 0.01 --0.0090
@@ -231,7 +233,7 @@
         Client_SetSkybox()
     elseif (gUseCaelumSkysystem) then
         -- check if already a caelum skysystem is there
-        if (gCaelumSystem) then return end
+        if (gCaelumSystem) then print("caelum already initialized") return=
 end
         print("init caelum")
         -- create a new Skysystem
         -- create with CG shaders



From no-reply at zwischenwelt.org  Sun Jul 19 03:10:01 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Jul 2009 01:10:01 -0000
Subject: [Iris-commit] [IRIS] r3086 - in /trunk: lua/lib.granny.loader.lua
 lua/lib.granny.types.lua lua/lib.packetvideo.lua lua/lib.uoids.lua
 plugins/loot.lua
Message-ID: <20090719011001.968A77A980AA@simon>

Author: ghoulsblade
Date: Sun Jul 19 03:10:01 2009
New Revision: 3086

Log:
packetvideo:tweaked loader a bit, granny parser: xml output complete,  uoid=
s:added a few nodraw artids

Modified:
    trunk/lua/lib.granny.loader.lua
    trunk/lua/lib.granny.types.lua
    trunk/lua/lib.packetvideo.lua
    trunk/lua/lib.uoids.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.granny.loader.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.loader.lua (original)
+++ trunk/lua/lib.granny.loader.lua Sun Jul 19 03:10:01 2009
@@ -48,8 +48,102 @@
 	fifo:Clear()
 	fifo:ReadFromFile(filepath)
 	self:Parse(fifo)
+	self:XMLDump("../mygranny.xml") =

 	fifo:Destroy()
 	os.exit(0)
+end
+
+
+function cGrannyFile:XMLDump (filepath) =

+	local ignoredkeys =3D { childs=3Dtrue,hexdump=3Dtrue,iChunkType=3Dtrue,mi=
ChunkType=3Dtrue,childsleft=3Dtrue,iChildren=3Dtrue,iOffset=3Dtrue }
+	--~ function MyDumpObjList (node,k,v) for k2,obj in pairs(v) do XMLNodeAd=
dChild(node,{name=3Dk,attr=3D{bla=3DSmartDump(obj)}}) end end
+	function MyToString (v)
+		if (type(v) =3D=3D "table") then
+			return SmartDump(v)
+		else
+			return tostring(v)
+		end =

+	end
+	function MyObj2XMLAttri (obj) =

+		local res =3D {}
+		for k,v in pairs(obj) do res[tostring(k)] =3D MyToString(v) end =

+		return res =

+	end
+	function MyDumpValueList (node,k,v) =

+		local subnode =3D {name=3Dk} XMLNodeAddChild(node,subnode)
+		for k2,text in ipairs(v) do XMLNodeAddChild(subnode,{name=3D"entry",n=3D=
1,[1]=3DMyToString(text)}) end =

+	end
+	function MyDumpObjList (node,k,v) =

+		local subnode =3D {name=3Dk} XMLNodeAddChild(node,subnode)
+		for k2,obj in ipairs(v) do XMLNodeAddChild(subnode,{name=3D"entry",attr=
=3DMyObj2XMLAttri(obj)}) end =

+	end
+	function MyDumpObj (node,k,obj) XMLNodeAddChild(node,{name=3Dk,attr=3DMyO=
bj2XMLAttri(obj)}) end
+	local customs =3D {
+		texts=3DMyDumpValueList,
+		list_points		=3DMyDumpObjList,
+		list_normals	=3DMyDumpObjList,
+		list_polygons	=3DMyDumpObjList, =

+		list_texcoords	=3DMyDumpObjList, =

+		list_weights	=3DMyDumpObjList, =

+		list_texpoly		=3DMyDumpObjList, =

+		list_texpoly_small	=3DMyDumpObjList, =

+		list_texpoly_normal	=3DMyDumpObjList, =

+		list_texpoly_big	=3DMyDumpObjList, =

+		pRest			=3DMyDumpValueList,
+		pTranslateTime	=3DMyDumpValueList,
+		pQuaternionTime	=3DMyDumpValueList,
+		pScaleTime		=3DMyDumpValueList, =

+		pTranslate		=3DMyDumpObjList, =

+		pQuaternion		=3DMyDumpObjList, =

+		pScale			=3DMyDumpObjList, =

+	}
+	local quickfifo =3D self.fifo:GetQuickHandle()
+	function MyHexDumpNode (offset,len) =

+		local node =3D {name=3D"hexdump",attr=3D{offset=3Doffset,len=3Dlen}}
+		local pos =3D 0
+		while (len > 0) do =

+			local partlen =3D min(len,16)
+			local hex	=3D ""
+			local asci	=3D ""
+			for i=3D1,16 do =

+				if (i <=3D partlen) then =

+					local c =3D FIFO_PeekUint8(quickfifo,offset+pos+i)
+					hex =3D hex .. sprintf("%02x ",c)
+					asci =3D asci .. ((c >=3D 32 and c < 128) and sprintf("%c",c) or "?")
+				else =

+					hex =3D hex .. "   "
+				end
+				if (i =3D=3D 8) then hex =3D hex .. " " end
+			end
+			XMLNodeAddChild(node,{name=3D"hexline",attr=3D{pos=3Dsprintf("0x%04x",p=
os)},n=3D1,[1]=3Dhex..asci})
+			len =3D len - partlen
+			pos =3D pos + partlen
+		end
+		return node
+	end
+	function MyNode (tagname,obj)
+		local attr =3D {}
+		local node =3D {name=3Dtagname,attr=3Dattr}
+		for k,v in pairs(obj) do =

+			local custom =3D customs[k]
+			if (custom) then =

+				custom(node,k,v)
+			elseif (not ignoredkeys[k]) then =

+				if (type(v) =3D=3D "table") then MyDumpObj(node,k,v) else attr[k] =3D =
tostring(v) end
+			end
+		end
+		if (obj.childs) then =

+			for k,v in ipairs(obj.childs) do =

+				local chunktype =3D v.iChunkType or v.miChunkType
+				local name =3D (chunktype and (self.kTypeNames[chunktype] or ("unknown=
_"..hex(chunktype)))) or "unknown"
+				XMLNodeAddChild(node,MyNode(name,v))
+			end
+		end
+		local hexdump =3D obj.hexdump
+		if (hexdump) then XMLNodeAddChild(node,MyHexDumpNode(hexdump.offset,hexd=
ump.len)) end
+		return node
+	end
+	LuaXML_SaveFile(filepath,MyNode("MainChunk",self.pMainChunk))
 end
 =

 function cGrannyFile:Read (offset,structname) =

@@ -81,13 +175,17 @@
 	self.quickfifo =3D fifo:GetQuickHandle()
 	self:DefineTypes()
 	local pMainChunk =3D self:Read(0,"MainChunk")
-	print("cGrannyFile:Parse:pMainChunk",SmartDump(pMainChunk))
+	self.pMainChunk =3D pMainChunk
+	pMainChunk.childs =3D {}
+	=

+	--~ print("cGrannyFile:Parse:pMainChunk",SmartDump(pMainChunk))
 	assert(pMainChunk.miChunkType =3D=3D self.kChunkType_Main,"unexpected chu=
nktype:"..hex(pMainChunk.miChunkType))
 	self:Visit("MainChunk",pMainChunk,0)
 	=

 	local p =3D self.size.MainChunk
 	for i=3D0,pMainChunk.miChildCount-1 do =

 		local pItemList =3D self:Read(p,"ItemList")
+		table.insert(pMainChunk.childs,pItemList)
 		p =3D p + self.size.ItemList
 		local pChunkDataStart =3D pItemList.miListOffset
 		=

@@ -113,19 +211,25 @@
 end
 =

 function cGrannyFile:ReadInt (iOffset) =

-	assert(iOffset+4 <=3D self.miBufSize)
+	assert(iOffset >=3D 0 and iOffset+4 <=3D self.miBufSize)
 	return FIFO_PeekUint32(self.quickfifo,iOffset)
 end
-
-function cGrannyFile:ParseItemListData (pItemList,p,iSize)
+function cGrannyFile:ReadFloat (iOffset) =

+	assert(iOffset >=3D 0 and iOffset+4 <=3D self.miBufSize)
+	return FIFO_PeekFloat(self.quickfifo,iOffset)
+end
+
+function cGrannyFile:ParseItemListData (pItemList,p,iItemListSize)
+	--~ print("cGrannyFile:ParseItemListData")
 	local quickfifo =3D self.quickfifo
+	self.lastitemlist =3D pItemList
+	pItemList.childs =3D {} =

 	=

 	self.mlParents =3D {}
-	self:Visit("ItemList",pItemList,p,iSize)
+	self:Visit("ItemList",p,iItemListSize)
 	=

 	-- read header
 	local pItemListHeader =3D self:Read(p,"ItemList_Header")
-	self:Visit("ItemListHeader",pItemListHeader,p,iSize)
 	p =3D p + self.size.ItemList_Header
 	=

 	-- read all nodes in list
@@ -133,6 +237,7 @@
 	local GRANNY_CHUNKTYPE_MAGIC =3D 0xCA5E0000
 	local iEntryHeaderSize =3D 3*4
 	for i=3D0,pItemListHeader.miChildCount-1 do
+		assert(p+iEntryHeaderSize <=3D self.miBufSize)
 		local iChunkType	=3D FIFO_PeekUint32(quickfifo,p+0)
 		local iOffset		=3D FIFO_PeekUint32(quickfifo,p+4)
 		local iChildren		=3D FIFO_PeekUint32(quickfifo,p+8)
@@ -140,8 +245,8 @@
 		=

 		-- determine data size of this child by checking the offset of the next =
child, if any, and listdata-size
 		local iChildSize =3D miBufSize - (pItemList.miListOffset + iOffset)
-		if (iOffset <=3D iSize) then
-			local iChildSize2 =3D iSize - iOffset
+		if (iOffset <=3D iItemListSize) then
+			local iChildSize2 =3D iItemListSize - iOffset
 			if (iChildSize2 < iChildSize) then iChildSize =3D iChildSize2 end
 		end
 		if (i < pItemListHeader.miChildCount - 1 and miBufSize - p >=3D iEntryHe=
aderSize) then
@@ -153,44 +258,44 @@
 		end
 		=

 		assert(BitwiseAND(iChunkType,GRANNY_CHUNKTYPE_MAGIC) =3D=3D GRANNY_CHUNK=
TYPE_MAGIC,"ParseGranny : magic failed in subchunktype "..hex(iChunkType))
-		assert(iOffset <=3D iSize,"chunk-offset out of bounds: offset:"..hex(iOf=
fset).."size:"..iSize)
+		assert(iOffset <=3D iItemListSize,"chunk-offset out of bounds: offset:".=
.hex(iOffset).."size:"..iItemListSize)
 		=

 		local myoffset =3D pItemList.miListOffset+iOffset
 		assert(myoffset <=3D miBufSize)
-			=

-		self:HandleChunk(iChunkType,myoffset,iChildren,iChildSize)
+		=

+		local chunk =3D {iChunkType=3DiChunkType,iOffset=3DiOffset,iChildren=3Di=
Children} -- ,iChildSize=3DiChildSize
 		local handler =3D self.chunkHandlers[iChunkType]
-		if (handler) then handler(self,myoffset,iChildSize) end
+		if (handler) then =

+			handler(self,myoffset,iChildSize,chunk) =

+		elseif (iChildSize > 0) then
+			chunk.hexdump =3D {offset=3Dmyoffset,len=3DiChildSize}
+			--~ chunk.hexdump =3D sprintf("hexdump("..myoffset..","..iChildSize..")=
")
+			--~ chunk.xmlcontent =3D FIFOHexDump(self.fifo,myoffset,iChildSize).."\=
n"
+		end
+		local p =3D self:GetCurrentParent() or self.lastitemlist
+		table.insert(p.childs,chunk)
 		=

 		self:DecrementParents()
-		self:PushParent(iChunkType,iChildren)
-	end
-end
-
-function cGrannyFile:GetRootParentType () local p =3D self.mlParents[1] re=
turn p and p.miChunkType end
+		if (chunk.iChildren > 0) then self:PushParent(chunk) end
+	end
+	self:DecrementParents()
+end
+
+
+function cGrannyFile:GetCurrentParent () return self.mlParents[#self.mlPar=
ents] end
+function cGrannyFile:GetRootParentType () local p =3D self.mlParents[1] re=
turn p and p.iChunkType end
 function cGrannyFile:DecrementParents () =

 	local res =3D {}
-	for k,v in ipairs(self.mlParents) do v.miChildCount =3D v.miChildCount - =
1 if (v.miChildCount > 0) then table.insert(res,v) end end
+	for k,chunk in ipairs(self.mlParents) do
+		chunk.childsleft =3D chunk.childsleft - 1 =

+		if (chunk.childsleft > 0) then table.insert(res,chunk) end =

+	end
 	self.mlParents =3D res
 end
 function cGrannyFile:GetParentDepth() return #self.mlParents end
-function cGrannyFile:PushParent(iChunkType,iChildCount)
-	if (iChildCount > 0) then table.insert(self.mlParents,{miChunkType=3DiChu=
nkType,miChildCount=3DiChildCount}) end
-end
-
-
-function cGrannyFile:HandleChunk (iChunkType,iOffset,iChildren,iSize) =

-	--~ self:Visit("Chunk",myoffset,iChildren,iChildSize,tostring(self.kTypeN=
ames[iChunkType]))
-	self:Visit("Chunk:"..hex(iChunkType),iOffset,iChildren,iSize,string.rep("=
 ",self:GetParentDepth())..tostring(self.kTypeNames[iChunkType]))
-	=

-	=

-	-- if (1) { VisitUnknown(iChunkType,iOffset,iChildren,iSize); return; } =

-	-- VisitUnknown(iChunkType,iOffset,iChildren,iSize); =

-	=

-	=

-	--  FIFO_PeekUint32(self.quickfifo,iOffset)
-	--~ const uint32* pInts =3D (const uint32*)(pbufffff+iOffset);
-end
+function cGrannyFile:PushParent(chunk) chunk.childs =3D {} chunk.childslef=
t =3D chunk.iChildren table.insert(self.mlParents,chunk) end
+
+
 =

 =

 function cGrannyFile:HexDump(iOffset,iSize)
@@ -208,147 +313,233 @@
 	end
 end =

 =

-function cGrannyFile:VisitTextChunk () end
-function cGrannyFile:VisitMeshID () end
-function cGrannyFile:VisitBoneTieID () end
-function cGrannyFile:VisitTexInfoID () end
-function cGrannyFile:VisitObj () end
-function cGrannyFile:VisitObjKey () end
-function cGrannyFile:VisitObjValue () end
-function cGrannyFile:VisitPoints () end
-function cGrannyFile:VisitNormals () end
-function cGrannyFile:VisitPolygons () end
-function cGrannyFile:VisitTexCoords () end
-function cGrannyFile:VisitWeights () end
-function cGrannyFile:VisitTexPolygonsSmall () end
-function cGrannyFile:VisitTexPolygons () end
-function cGrannyFile:VisitTexPolygonsBig () end
-function cGrannyFile:VisitBone () end
-function cGrannyFile:VisitTexInfo () end
+
 =

 =

 cGrannyFile.chunkHandlers =3D {}
 =

-cGrannyFile.chunkHandlers[0xCA5E0200] =3D function (self,iOffset,iSize) as=
sert(iSize >=3D 8) self:VisitTextChunk(self:ReadInt(iOffset),self:ReadInt(i=
Offset+1),iOffset + 8,iSize-8) end
-cGrannyFile.chunkHandlers[0xCA5E0f04] =3D function (self,iOffset,iSize)
-	if (self:GetRootParentType() =3D=3D 0XCA5E0602) then assert(iSize =3D=3D =
4) self:VisitMeshID(self:ReadInt(iOffset)) end
-	if (self:GetRootParentType() =3D=3D 0XCA5E0B01) then assert(iSize =3D=3D =
4) self:VisitBoneTieID(self:ReadInt(iOffset)) end
-	if (self:GetRootParentType() =3D=3D 0XCA5E0304) then assert(iSize =3D=3D =
4) self:VisitTexInfoID(self:ReadInt(iOffset)) end
-end
-	=

-cGrannyFile.chunkHandlers[0XCA5E0F00] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0F03) then assert(iSize =3D=3D 8,"s=
ize-mismatch:"..iSize) self:VisitObj(self:ReadInt(iOffset),self:ReadInt(iOf=
fset+1)) end end
-cGrannyFile.chunkHandlers[0XCA5E0F01] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0F03) then assert(iSize =3D=3D 4) s=
elf:VisitObjKey(self:ReadInt(iOffset)) end end
-cGrannyFile.chunkHandlers[0XCA5E0F02] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0F03) then assert(iSize =3D=3D 8) s=
elf:VisitObjValue(self:ReadInt(iOffset),self:ReadInt(iOffset+1)) end end
-
-cGrannyFile.chunkHandlers[0XCA5E0801] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then self:VisitPoints(iOffset=
,iSize/self.size.Vector) end end
-cGrannyFile.chunkHandlers[0XCA5E0802] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then self:VisitNormals(iOffse=
t,iSize/self.size.Vector) end end
-cGrannyFile.chunkHandlers[0XCA5E0901] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then self:VisitPolygons(iOffs=
et,iSize/self.size.Polygon) end end
-cGrannyFile.chunkHandlers[0XCA5E0803] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then assert(iSize >=3D 4) sel=
f:VisitTexCoords(self:ReadInt(iOffset),(iOffset+4),(iSize-4)/self.size.Vect=
or) end end
-cGrannyFile.chunkHandlers[0XCA5E0702] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0602) then assert(iSize >=3D 3*4) s=
elf:VisitWeights(self:ReadInt(iOffset),self:ReadInt(iOffset+1),self:ReadInt=
(iOffset+2),iOffset+3*4,iSize-3*4) end end
-		=

-cGrannyFile.chunkHandlers[0xCA5E0e06] =3D function (self,iOffset,iSize) =

-	if (self:GetRootParentType() =3D=3D 0XCA5E0E01) then
-		assert(iSize >=3D 4) =

-		local iNum =3D self:ReadInt(iOffset)
-		local iElementSize =3D floor((iSize-4)/iNum)
-		if (iSize-4 ~=3D iNum*iElementSize) then
-			printdebug("granny","cGrannyVisitor::VisitChunk 0xCA5E0e06 unexpected s=
ize (num=3D%d,elsize=3D%d): %d/%d",iNum,iElementSize,iSize-4,iNum*iElementS=
ize)
-		end
-		=

-			if (iElementSize =3D=3D self.size.TexturePolySmall)	then self:VisitTexP=
olygonsSmall((iOffset+4),iNum) =

-		elseif (iElementSize =3D=3D self.size.TexturePoly)		then self:VisitTexPo=
lygons(		(iOffset+4),iNum) =

-		elseif (iElementSize =3D=3D self.size.TexturePolyBig)	then self:VisitTex=
PolygonsBig(	(iOffset+4),iNum) =

-		else =

-			printdebug("granny","cGrannyVisitor::VisitChunk 0xCA5E0e06 unexpected e=
lement-size : %d",iElementSize) =

-			self:HexDump(iOffset,iSize) =

-		end
-	end
-end
-cGrannyFile.chunkHandlers[0XCA5E0506] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0507) then assert(iSize =3D=3D self=
.size.Bone) self:VisitBone(iOffset) end end
-cGrannyFile.chunkHandlers[0xCA5E0303] =3D function (self,iOffset,iSize) =

-	if (self:GetRootParentType() =3D=3D 0XCA5E0304) then =

-		if (iSize ~=3D self.size.TexInfo) then =

-			printdebug("granny","WARNING ! granny 0xCA5E0303 : size1=3D%d size2=3D%=
d",iSize,self.size.TexInfo)
-		end
-		assert(iSize >=3D self.size.TexInfo); =

-		self:VisitTexInfo(iOffset) =

-	end =

-end
-
-function cGrannyFile:VisitBoneTie2ID () end
-function cGrannyFile:VisitBoneTie2GroupID () end
-function cGrannyFile:VisitBoneTies2 () end
-function cGrannyFile:VisitBoneTie () end
-function cGrannyFile:VisitTextureID () end
-function cGrannyFile:VisitTexturePoly () end
-function cGrannyFile:VisitTexturePolyData () end
-
-
-cGrannyFile.chunkHandlers[0XCA5E0C08] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then assert(iSize =3D=3D 4) s=
elf:VisitBoneTie2ID(self:ReadInt(iOffset)) end end
-cGrannyFile.chunkHandlers[0XCA5E0C03] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then assert(iSize =3D=3D 4) s=
elf:VisitBoneTie2GroupID(self:ReadInt(iOffset)) end end
-cGrannyFile.chunkHandlers[0XCA5E0C02] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then self:VisitBoneTies2(iOff=
set,iSize/4) end end
-cGrannyFile.chunkHandlers[0xCA5E0c0a] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0C01) then assert(iSize =3D=3D self=
.size.BoneTie) self:VisitBoneTie(iOffset) end end
-
-cGrannyFile.chunkHandlers[0XCA5E0E00] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0E01) then  assert(iSize =3D=3D 4) =
self:VisitTextureID(self:ReadInt(iOffset)) end end
-cGrannyFile.chunkHandlers[0XCA5E0E02] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0E01) then  assert(iSize =3D=3D 8) =
self:VisitTexturePoly(self:ReadInt(iOffset),self:ReadInt(iOffset+1)) end end
-cGrannyFile.chunkHandlers[0XCA5E0E04] =3D function (self,iOffset,iSize) if=
 (self:GetRootParentType() =3D=3D 0XCA5E0E01) then  assert(iSize =3D=3D 4) =
self:VisitTexturePolyData(self:ReadInt(iOffset)) end end
-
-cGrannyFile.chunkHandlers[0XCA5E1204] =3D function (self,iOffset,iSize) =

-	if (self:GetRootParentType() =3D=3D 0XCA5E1205) then
-		assert(iSize >=3D self.size.Anim)
-		--[[
-		const char* p =3D iOffset;
-		GrannyAnim*	pAnim 				=3D (GrannyAnim*)p; 		p +=3D self.size.Anim;
-		float*	pTranslateTime 			=3D (float*)p; 			p +=3D self.size.float		*pAni=
m->iNumTranslate;
-		float*	pQuaternionTime 		=3D (float*)p; 			p +=3D self.size.float		*pAni=
m->iNumQuaternion;
-		float*	pScaleTime 				=3D (float*)p; 			p +=3D self.size.float		*pAnim->=
iNumScale;
-		GrannyVector*		pTranslate	=3D (GrannyVector*)p; 	p +=3D self.size.Vector=
		*pAnim->iNumTranslate;
-		GrannyQuaternion*	pQuaternion	=3D (GrannyQuaternion*)p; p +=3D self.size=
.Quaternion	*pAnim->iNumQuaternion;
-		GrannyVector*		pScale		=3D (GrannyVector*)p;		p +=3D self.size.Vector		*=
pAnim->iNumScale;
-		GrannyVector*		pRest		=3D (GrannyVector*)p;
-		int 	iUsedSize =3D p - iOffset;
-		local MAX_PARTNUM_0XCA5E1204 =3D 0x0000ffff
-		bool	bBroken =3D	iUsedSize 				< 0 or iSize < iUsedSize or =

-							pAnim->iNumTranslate 	< 0 or pAnim->iNumTranslate		>=3D MAX_PARTNUM=
_0XCA5E1204 or =

-							pAnim->iNumQuaternion 	< 0 or pAnim->iNumQuaternion	>=3D MAX_PARTNU=
M_0XCA5E1204 or =

-							pAnim->iNumScale 		< 0 or pAnim->iNumScale			>=3D MAX_PARTNUM_0XCA5=
E1204;
-		if (bBroken) then
-			--~ printf("0XCA5E1204 broken : %08x %08x\n",(int)iOffset,(int)p);
-			--~ printf("0XCA5E1204 broken : iNumTranslate=3D%d\n",pAnim->iNumTransl=
ate);
-			--~ printf("0XCA5E1204 broken : iNumQuaternion=3D%d\n",pAnim->iNumQuate=
rnion);
-			--~ printf("0XCA5E1204 broken : iNumScale=3D%d\n",pAnim->iNumScale);
-			--~ printf("0XCA5E1204 broken : iSize=3D%d iUsedSize=3D%d\n",iSize,iUse=
dSize);
-		end
-		float	fTotalTime =3D 0;
-		if (not bBroken) then
-			float	fTotalTimeT =3D (pAnim->iNumTranslate > 0) ? pTranslateTime[pAnim=
->iNumTranslate-1] : 0;
-			float	fTotalTimeQ =3D (pAnim->iNumQuaternion > 0) ? pQuaternionTime[pAn=
im->iNumQuaternion-1] : 0;
-			float	fTotalTimeS =3D (pAnim->iNumScale > 0) ? pScaleTime[pAnim->iNumSc=
ale-1] : 0;
-			fTotalTime =3D mymax(mymax(fTotalTimeT,fTotalTimeQ),fTotalTimeS);
-		end
-		VisitGrannyAnim(pAnim,
-			bBroken?0:pTranslateTime,
-			bBroken?0:pQuaternionTime,
-			bBroken?0:pScaleTime,
-			bBroken?0:pTranslate,
-			bBroken?0:pQuaternion,
-			bBroken?0:pScale,
-			bBroken?0:pRest,
-			bBroken?0:fTotalTime,
-			bBroken?0:iUsedSize,iSize);
-		]]--
-	end =

-end
+cGrannyFile.chunkHandlers[0xCA5E0200] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(iSize >=3D 8) =

+	local iNumEntries	=3D self:ReadInt(iOffset)
+	local iTextLen		=3D self:ReadInt(iOffset+4)
+	local p				=3D iOffset + 8
+	local iMaxLen		=3D iSize-8
+	assert(iTextLen <=3D iMaxLen)
+	chunk.iNumEntries =3D iNumEntries
+	chunk.iTextLen =3D iTextLen
+	chunk.texts =3D {}
+	local quickfifo =3D self.quickfifo
+	local txt =3D {}
+	for i=3D1,iTextLen do =

+		local c =3D FIFO_PeekUint8(quickfifo,p+i)
+		if (c =3D=3D 0 or i =3D=3D iTextLen) then =

+			table.insert(chunk.texts,string.char(unpack(txt))) txt =3D {}
+		else
+			table.insert(txt,c)
+		end
+	end                                     =

+	--~ cGrannyFile:VisitTextChunk      6       iTextLen=3D111     252     iS=
ize=3D112                                              =

+	--~ cGrannyFile:VisitTextChunk      66      iTextLen=3D596     28232   iS=
ize=3D596     =

+end
+
+
+cGrannyFile.chunkHandlers[0xCA5E0f04] =3D function (self,iOffset,iSize,chu=
nk)
+	assert(iSize =3D=3D 4)
+	chunk.iID =3D self:ReadInt(iOffset)
+	--~ if (self:GetRootParentType() =3D=3D 0XCA5E0602) then assert(iSize =3D=
=3D 4) return self:VisitMeshID(self:ReadInt(iOffset)) end
+	--~ if (self:GetRootParentType() =3D=3D 0XCA5E0B01) then assert(iSize =3D=
=3D 4) return self:VisitBoneTieID(self:ReadInt(iOffset)) end
+	--~ if (self:GetRootParentType() =3D=3D 0XCA5E0304) then assert(iSize =3D=
=3D 4) return self:VisitTexInfoID(self:ReadInt(iOffset)) end
+end
+
+cGrannyFile.chunkHandlers[0XCA5E0F00] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0F03)
+	assert(iSize =3D=3D 8,"size-mismatch:"..iSize)
+	chunk.unknown_a =3D self:ReadInt(iOffset)
+	chunk.unknown_b =3D self:ReadInt(iOffset+4)
+	assert(chunk.unknown_a =3D=3D 1 and chunk.unknown_b =3D=3D 1) -- true for=
 AbysmalHorror_Attack1.grn
+	-- self:VisitObj(a,b)
+end
+
+cGrannyFile.chunkHandlers[0XCA5E0F01] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0F03)
+	assert(iSize =3D=3D 4)
+	chunk.key =3D self:ReadInt(iOffset) -- VisitObjKey      miLastKey
+end
+
+cGrannyFile.chunkHandlers[0XCA5E0F02] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0F03)
+	assert(iSize =3D=3D 8,"size-mismatch:"..iSize)
+	chunk.unknown_a =3D self:ReadInt(iOffset)
+	chunk.unknown_b =3D self:ReadInt(iOffset+4) -- VisitObjValue   : push miL=
astKey,iUnknown2
+	assert(chunk.unknown_a =3D=3D 0) -- true for AbysmalHorror_Attack1.grn
+end
+
+function cGrannyFile:ReadArray (sStructName,iOffset,iArraySize) =

+	local res =3D {}
+	local iStructSize =3D self.size[sStructName]
+	local num =3D floor(iArraySize/iStructSize)
+	assert(iArraySize =3D=3D num*iStructSize) -- exact size check to detect p=
arsing errors
+	for i=3D0,num-1 do table.insert(res,self:Read(iOffset+i*iStructSize,sStru=
ctName)) end
+	return res
+end
+
+cGrannyFile.chunkHandlers[0XCA5E0801] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0602) chunk.list_points =
=3D self:ReadArray("Vector",iOffset,iSize) end -- VisitPoints
+cGrannyFile.chunkHandlers[0XCA5E0802] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0602) chunk.list_normals =
=3D self:ReadArray("Vector",iOffset,iSize) end -- VisitNormals
+cGrannyFile.chunkHandlers[0XCA5E0901] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0602) chunk.list_polygons =
=3D self:ReadArray("Polygon",iOffset,iSize) end -- VisitPolygons
+
+cGrannyFile.chunkHandlers[0XCA5E0803] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0602)
+	assert(iSize >=3D 4) =

+	chunk.unknown =3D self:ReadInt(iOffset)
+	chunk.list_texcoords =3D self:ReadArray("Vector",iOffset+4,iSize-4) -- Vi=
sitTexCoords
+end
+
+cGrannyFile.chunkHandlers[0XCA5E0702] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0602)
+	assert(iSize >=3D 3*4) =

+	chunk.wnum		=3D self:ReadInt(iOffset)
+	chunk.unknown_a	=3D self:ReadInt(iOffset+4)
+	chunk.unknown_b	=3D self:ReadInt(iOffset+8)
+	chunk.list_weights =3D self:ReadArray("Weight",iOffset+12,iSize-12) -- Vi=
sitWeights
+end
+
+cGrannyFile.chunkHandlers[0xCA5E0e06] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0E01)
+	assert(iSize >=3D 4) =

+	local iNum =3D self:ReadInt(iOffset)			chunk.iNum =3D iNum
+	local iElementSize =3D floor((iSize-4)/iNum)	chunk.iElementSize =3D iElem=
entSize
+	if (iSize-4 ~=3D iNum*iElementSize) then
+		printdebug("granny","cGrannyVisitor::VisitChunk 0xCA5E0e06 unexpected si=
ze (num=3D%d,elsize=3D%d): %d/%d",iNum,iElementSize,iSize-4,iNum*iElementSi=
ze)
+		assert(false,"should not happen")
+	end
+	=

+	=

+		if (iElementSize =3D=3D self.size.TexturePolySmall)	then chunk.list_texp=
oly_small	=3D self:ReadArray("TexturePolySmall",iOffset+4,iSize-4)  -- Visi=
tTexPolygonsSmall
+	elseif (iElementSize =3D=3D self.size.TexturePoly)		then chunk.list_texpo=
ly_normal	=3D self:ReadArray("TexturePoly",		iOffset+4,iSize-4)  -- VisitTe=
xPolygons
+	elseif (iElementSize =3D=3D self.size.TexturePolyBig)	then chunk.list_tex=
poly_big		=3D self:ReadArray("TexturePolyBig",	iOffset+4,iSize-4)  -- Visit=
TexPolygonsBig
+	else
+		printdebug("granny","cGrannyVisitor::VisitChunk 0xCA5E0e06 unexpected el=
ement-size : %d",iElementSize) =

+		assert(false,"should not happen")
+		self:HexDump(iOffset,iSize) =

+	end
+end
+
+cGrannyFile.chunkHandlers[0XCA5E0506] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0507) =

+	assert(iSize =3D=3D self.size.Bone) =

+	chunk.bone =3D self:Read(iOffset,"Bone") -- VisitBone
+end
+
+
+cGrannyFile.chunkHandlers[0xCA5E0303] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0304) =

+	if (iSize ~=3D self.size.TexInfo) then printdebug("granny","WARNING ! gra=
nny 0xCA5E0303 : size1=3D%d size2=3D%d",iSize,self.size.TexInfo) end
+	assert(iSize =3D=3D self.size.TexInfo) =

+	assert(iSize >=3D self.size.TexInfo)
+	chunk.texinfo =3D self:Read(iOffset,"TexInfo") -- VisitTexInfo
+end
+
+cGrannyFile.chunkHandlers[0XCA5E0C08] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0C01) assert(iSize =3D=3D =
4) chunk.iBoneTie2ID =3D self:ReadInt(iOffset) end -- VisitBoneTie2ID
+cGrannyFile.chunkHandlers[0XCA5E0C03] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0C01) assert(iSize =3D=3D =
4) chunk.iBoneTie2GroupID =3D self:ReadInt(iOffset) end -- VisitBoneTie2Gro=
upID
+
+cGrannyFile.chunkHandlers[0XCA5E0C02] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E0C01) =

+	chunk.iNum =3D floor(iSize/4)
+	assert(iSize =3D=3D chunk.iNum * 4) =

+	local list =3D {}
+	for i=3D0,chunk.iNum-1 do table.insert(list,self:ReadInt(iOffset+i*4)) en=
d =

+	chunk.BoneTies2 =3D list -- VisitBoneTies2
+end
+cGrannyFile.chunkHandlers[0xCA5E0c0a] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0C01) assert(iSize =3D=3D =
self.size.BoneTie) chunk.bonetie =3D self:Read(iOffset,"BoneTie") end -- Vi=
sitBoneTie
+
+cGrannyFile.chunkHandlers[0XCA5E0E00] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0E01) assert(iSize =3D=3D =
4) chunk.iTextureID =3D self:ReadInt(iOffset) end -- VisitTextureID
+cGrannyFile.chunkHandlers[0XCA5E0E02] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0E01) assert(iSize =3D=3D =
8) chunk.iTexturePoly =3D {a=3Dself:ReadInt(iOffset),b=3Dself:ReadInt(iOffs=
et+4)} end -- VisitTexturePoly
+cGrannyFile.chunkHandlers[0XCA5E0E04] =3D function (self,iOffset,iSize,chu=
nk) assert(self:GetRootParentType() =3D=3D 0XCA5E0E01) assert(iSize =3D=3D =
4) chunk.iTexturePolyData =3D self:ReadInt(iOffset) end -- VisitTexturePoly=
Data
+
+
+function cGrannyFile:ReadFloatArray(iOffset,num)
+	local res =3D {}
+	for i=3D0,num-1 do table.insert(res,self:ReadFloat(iOffset+i*4)) end -- R=
eadFloat has bounds-checking
+	return res =

+end
+
+
+cGrannyFile.chunkHandlers[0XCA5E1204] =3D function (self,iOffset,iSize,chu=
nk) =

+	assert(self:GetRootParentType() =3D=3D 0XCA5E1205)
+	assert(iSize >=3D self.size.Anim)
+	=

+	local p =3D iOffset
+	local pAnim =3D self:Read(iOffset,"Anim")		chunk.pAnim =3D pAnim			p =3D =
p + self.size.Anim
+	=

+	local s,n =3D self.size.float			,pAnim.iNumTranslate	chunk.pTranslateTime=
	=3D self:ReadFloatArray(p,n)					p =3D p + s * n
+	local s,n =3D self.size.float			,pAnim.iNumQuaternion	chunk.pQuaternionTi=
me	=3D self:ReadFloatArray(p,n)					p =3D p + s * n
+	local s,n =3D self.size.float			,pAnim.iNumScale		chunk.pScaleTime		=3D s=
elf:ReadFloatArray(p,n)					p =3D p + s * n
+	=

+	local s,n =3D self.size.Vector		,pAnim.iNumTranslate	chunk.pTranslate		=
=3D self:ReadArray("Vector"		,p,s * n)	p =3D p + s * n
+	local s,n =3D self.size.Quaternion	,pAnim.iNumQuaternion	chunk.pQuaternio=
n		=3D self:ReadArray("Quaternion"	,p,s * n)	p =3D p + s * n
+	local s,n =3D self.size.Vector		,pAnim.iNumScale		chunk.pScale			=3D self=
:ReadArray("Vector"		,p,s * n)	p =3D p + s * n
+	=

+	local iRestSize =3D iSize - (p-iOffset)	-- assert(pRestSize =3D=3D 0,"ani=
m:iRestSize=3D"..iRestSize..",iUnknownB=3D"..pAnim.iUnknownB[1])
+	local pRest		=3D p
+	local iUsedSize =3D p - iOffset
+	if (iRestSize > 0) then =

+		chunk.hexdump =3D {offset=3DpRest,len=3DiRestSize} =

+		local n =3D floor(iRestSize/self.size.float)
+		assert(iRestSize =3D=3D n*self.size.float)
+		chunk.pRest =3D self:ReadFloatArray(pRest,n)
+	end
+	=

+	local MAX_PARTNUM_0XCA5E1204 =3D 0x0000ffff
+	local bBroken =3D		iUsedSize 				< 0 or iSize < iUsedSize or =

+						pAnim.iNumTranslate 	< 0 or pAnim.iNumTranslate		>=3D MAX_PARTNUM_0X=
CA5E1204 or =

+						pAnim.iNumQuaternion 	< 0 or pAnim.iNumQuaternion		>=3D MAX_PARTNUM_=
0XCA5E1204 or =

+						pAnim.iNumScale 		< 0 or pAnim.iNumScale			>=3D MAX_PARTNUM_0XCA5E12=
04
+	if (bBroken) then
+		printdebug("granny","0XCA5E1204 broken : %08x %08x",iOffset,p);
+		printdebug("granny","0XCA5E1204 broken : iNumTranslate=3D%d",pAnim.iNumT=
ranslate);
+		printdebug("granny","0XCA5E1204 broken : iNumQuaternion=3D%d",pAnim.iNum=
Quaternion);
+		printdebug("granny","0XCA5E1204 broken : iNumScale=3D%d",pAnim.iNumScale=
);
+		printdebug("granny","0XCA5E1204 broken : iSize=3D%d iUsedSize=3D%d",iSiz=
e,iUsedSize);
+		assert(false,"shouldn't happen")
+	end
+	local fTotalTime =3D 0
+	if (not bBroken) then
+		local fTotalTimeT =3D (pAnim.iNumTranslate	> 0) and chunk.pTranslateTime=
[pAnim.iNumTranslate] or 0
+		local fTotalTimeQ =3D (pAnim.iNumQuaternion	> 0) and chunk.pQuaternionTi=
me[pAnim.iNumQuaternion] or 0
+		local fTotalTimeS =3D (pAnim.iNumScale		> 0) and chunk.pScaleTime[pAnim.=
iNumScale] or 0
+		fTotalTime =3D max(max(fTotalTimeT,fTotalTimeQ),fTotalTimeS)
+		chunk.fTotalTime =3D fTotalTime
+	end
+	=

+	--[[
+	VisitGrannyAnim(pAnim,
+		bBroken?0:pTranslateTime,
+		bBroken?0:pQuaternionTime,
+		bBroken?0:pScaleTime,
+		=

+		bBroken?0:pTranslate,
+		bBroken?0:pQuaternion,
+		bBroken?0:pScale,
+		=

+		bBroken?0:pRest,
+		bBroken?0:fTotalTime,
+		bBroken?0:iUsedSize,iSize); ]]--
+end
+
 =

 =

 function cGrannyFile:Visit (name,...) =

-	if (self.visit_last_name =3D=3D name) then
-		if (self.visit_last_count =3D=3D 11) then print("...") end
-		if (self.visit_last_count  > 11) then return end
-			self.visit_last_count =3D self.visit_last_count + 1
-	else
-		self.visit_last_name =3D name
-		self.visit_last_count =3D 1
-	end
-	print("cGrannyFile:Visit",name,...) =

+	--~ if (self.visit_last_name =3D=3D name) then
+		--~ if (self.visit_last_count =3D=3D 11) then print("...") end
+		--~ if (self.visit_last_count  > 11) then return end
+			--~ self.visit_last_count =3D self.visit_last_count + 1
+	--~ else
+		--~ self.visit_last_name =3D name
+		--~ self.visit_last_count =3D 1
+	--~ end
+	--~ print("cGrannyFile:Visit",name,...) =

 end =

+
+--~ cGrannyFile:LoadFile    /cavern/uoml/Models/Monsters/Changling_idle.gr=
n			DEBUG[granny]   WARNING ! granny 0xCA5E0303 : size1=3D%d size2=3D%d 224=
28   12 =

+--~ cGrannyFile:LoadFile    /cavern/uoml/Models/Monsters/Denkou_Yajuu_Pill=
age.grn	DEBUG[granny]   WARNING ! granny 0xCA5E0303 : size1=3D%d size2=3D%d=
 6244    12                       =

+--~ cGrannyFile:LoadFile    /cavern/uoml/Models/Monsters/Devourer_Attack2.=
grn		DEBUG[granny]   WARNING ! granny 0xCA5E0303 : size1=3D%d size2=3D%d 26=
4     12 =


Modified: trunk/lua/lib.granny.types.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.types.lua (original)
+++ trunk/lua/lib.granny.types.lua Sun Jul 19 03:10:01 2009
@@ -36,18 +36,33 @@
 		{uint32	,"miUnknown",3},
 	}
 =

+	self.structs.Weight =3D {
+		{float	,"w"},
+	}
 	self.structs.Vector =3D {
-		{float	,"x,y,z"},
+		{float	,"x"},
+		{float	,"y"},
+		{float	,"z"},
 	}
 =

 	self.structs.Quaternion =3D {
-		{float ,"data",4},
+		{float ,"x"},
+		{float ,"y"},
+		{float ,"z"},
+		{float ,"w"},
+		--~ {float ,"data",4},
 		--~ --float	x,y,z,w"}, --/< order unknown, might also be x,y,z,w  (0,0,0=
,1 occurred, w=3D1 rest=3D0 is identity)
 	}
 =

 	self.structs.Polygon =3D {
-		{uint32	,"iVertex",3},
-		{uint32	,"iNormal",3},
+		{uint32	,"iVertex1"},
+		{uint32	,"iVertex2"},
+		{uint32	,"iVertex3"},
+		{uint32	,"iNormal1"},
+		{uint32	,"iNormal2"},
+		{uint32	,"iNormal3"},
+		--~ {uint32	,"iVertex",3},
+		--~ {uint32	,"iNormal",3},
 	}
 =

 	self.structs.TexturePolySmall =3D {
@@ -83,7 +98,7 @@
 		{uint32	,"iBone"},
 		--~ --/ this might be initial position, translate:3f quaternion:4f =

 		--~ --/ but doesn't look like floats in uo/Models/Others/H_Female_LLegs_=
V2_LOD2.grn
-		{uint32	,"iUnknown",7}, =

+		{float	,"iUnknown",7}, =

 	}
 =

 	self.structs.Anim =3D {
@@ -131,24 +146,24 @@
 	self.kTypeNames[0xCA5E0f04] =3D "id" -- depends on parent structure
 =

 	self.kTypeNames[0xCA5E0b00] =3D "boneobject" -- bone-name ??
-	self.kTypeNames[0xCA5E0c00] =3D "boneties container"
-	self.kTypeNames[0xCA5E0c02] =3D "bone objptrs"
-	self.kTypeNames[0xCA5E0c03] =3D "bonetie group"
-	self.kTypeNames[0xCA5E0c04] =3D "bonetie data"
-	self.kTypeNames[0xCA5E0c05] =3D "end bone objptrs"
-	self.kTypeNames[0xCA5E0c06] =3D "bonetie container"
-	self.kTypeNames[0xCA5E0c07] =3D "bone objptrs container"
-	self.kTypeNames[0xCA5E0c08] =3D "bone objptr"
-	self.kTypeNames[0xCA5E0c09] =3D "bonetie list"
+	self.kTypeNames[0xCA5E0c00] =3D "boneties_container"
+	self.kTypeNames[0xCA5E0c02] =3D "bone_objptrs"
+	self.kTypeNames[0xCA5E0c03] =3D "bonetie_group"
+	self.kTypeNames[0xCA5E0c04] =3D "bonetie_data"
+	self.kTypeNames[0xCA5E0c05] =3D "end_bone_objptrs"
+	self.kTypeNames[0xCA5E0c06] =3D "bonetie_container"
+	self.kTypeNames[0xCA5E0c07] =3D "bone_objptrs_container"
+	self.kTypeNames[0xCA5E0c08] =3D "bone_objptr"
+	self.kTypeNames[0xCA5E0c09] =3D "bonetie_list"
 	self.kTypeNames[0xCA5E0c0a] =3D "bonetie"
 	self.kTypeNames[0xCA5E0505] =3D "skeleton"
 	self.kTypeNames[0xCA5E0506] =3D "bone"
 	self.kTypeNames[0xCA5E0508] =3D "bonelist"
 =

-	self.kTypeNames[0xCA5E0a01] =3D "unhandled"
+	self.kTypeNames[0xCA5E0a01] =3D "unhandled_0a01"
 	self.kTypeNames[0xCA5E0b01] =3D "boneTies1" -- bone_name_list ?
 	self.kTypeNames[0xCA5E0c01] =3D "boneTies2"
-	self.kTypeNames[0xCA5E0d01] =3D "unhandled"
+	self.kTypeNames[0xCA5E0d01] =3D "unhandled_0d01"
 	self.kTypeNames[0xCA5E0e00] =3D "texture"
 	self.kTypeNames[0xCA5E0e01] =3D "texture_list"
 =

@@ -165,7 +180,7 @@
 	self.kTypeNames[0xCA5E0f03] =3D "object_list"
 	self.kTypeNames[0xCA5E0f05] =3D "object_key_list"
 	self.kTypeNames[0xCA5E0f06] =3D "object_value_list"
-	self.kTypeNames[0xCA5E1003] =3D "unhandled"
+	self.kTypeNames[0xCA5E1003] =3D "unhandled_1003"
 =

 	self.kTypeNames[0xCA5E1200] =3D "animation_sublist"
 	self.kTypeNames[0xCA5E1201] =3D "animation_data"

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Sun Jul 19 03:10:01 2009
@@ -168,12 +168,17 @@
 	local fifo =3D CreateFIFO()
 	fifo:ReadFromFile(filename)
 	print("### packetvideo load",filename,fifo:Size())
+	local iProgressStep =3D 0
+	local quickfifo =3D fifo:GetQuickHandle()
 	while fifo:Size() > 0 do
-		local ctype	=3D fifo:PeekNetUint8(0)
+		local ctype	=3D FIFO_PeekNetUint8(quickfifo,0)
 		local t		=3D MyPeek32(fifo,1)
-		local hex =3D ""
-		print("PacketVideo_Load step",fifo:Size(),ctype)
-		for i=3D0,1+4+4 do hex =3D hex .. sprintf("%02x ",fifo:PeekNetUint8(i)) =
end
+		--~ local hex =3D ""
+		iProgressStep =3D iProgressStep + 1 =

+		if (math.mod(iProgressStep,5000) =3D=3D 0) then
+			print("PacketVideo_Load step",fifo:Size(),ctype)
+		end
+		--~ for i=3D0,1+4+4 do hex =3D hex .. sprintf("%02x ",fifo:PeekNetUint8(=
i)) end
 		--~ print("pv load step",ctype,t,fifo:PeekNetUint32(1+4),hex)
 		if (ctype =3D=3D kPacketVideoChunkType_Recv or =

 			ctype =3D=3D kPacketVideoChunkType_Send) then
@@ -184,19 +189,19 @@
 			fifo:PopRaw(1+4+4+len)
 		elseif (ctype =3D=3D kPacketVideoChunkType_Pos) then
 			fifo:PopRaw(1+4)
-			local xloc		=3D fifo:PopNetUint16()
-			local yloc		=3D fifo:PopNetUint16()
-			local zloc		=3D fifo:PopNetInt16()
-			local fulldir	=3D fifo:PopNetUint8()
+			local xloc		=3D FIFO_PopNetUint16(quickfifo)
+			local yloc		=3D FIFO_PopNetUint16(quickfifo)
+			local zloc		=3D FIFO_PopNetInt16(quickfifo)
+			local fulldir	=3D FIFO_PopNetUint8(quickfifo)
 			table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{xloc,ylo=
c,zloc,fulldir}})
 		elseif (ctype =3D=3D kPacketVideoChunkType_Map) then
 			fifo:PopRaw(1+4)
-			local mapindex	=3D fifo:PopNetUint8()
+			local mapindex	=3D FIFO_PopNetUint8(quickfifo)
 			table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{mapindex=
}})
 		elseif (ctype =3D=3D kPacketVideoChunkType_Player) then
 			fifo:PopRaw(1+4)
-			local version	=3D fifo:PopNetUint8()
-			local serial	=3D fifo:PopNetUint32()
+			local version	=3D FIFO_PopNetUint8(quickfifo)
+			local serial	=3D FIFO_PopNetUint32(quickfifo)
 			table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{version,=
serial}})
 		else
 			print("unknown ctype:",ctype)

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sun Jul 19 03:10:01 2009
@@ -742,7 +742,7 @@
 	[11573] =3D {first=3D17,second=3D24},
 }
 =

-gNodrawArtIDs =3D {0x21a4,0x2199}
+gNodrawArtIDs =3D {0x21a3,0x21a4,0x2199,0x21bc}
 gNodrawByArtID =3D {}
 for k,artid in ipairs(gNodrawArtIDs) do gNodrawByArtID[artid] =3D true end
 =


Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Sun Jul 19 03:10:01 2009
@@ -3,7 +3,7 @@
 if (not gDisabledPlugins.loot) then =

 gLootPluginCutCorspes =3D false =

 --~ gLootPluginCutCorspes =3D true =

-gLootPluginMinGoldAmount =3D 15011111111
+gLootPluginMinGoldAmount =3D 1500000
 =

 kLootPlugin_RecentlyClickedInterval =3D 4*1000
 kLootPluginHideCorpseWithoutContentChangeTimeout =3D false -- if corpse do=
es not contain interesting item and hasn't changed contents, hide it



From no-reply at zwischenwelt.org  Sun Jul 19 18:14:20 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Jul 2009 16:14:20 -0000
Subject: [Iris-commit] [IRIS] r3087 - /trunk/lua/gui/gui.helper.lua
Message-ID: <20090719161420.72A717A980A4@simon>

Author: hagish
Date: Sun Jul 19 18:14:20 2009
New Revision: 3087

Log:
c memory usage

Modified:
    trunk/lua/gui/gui.helper.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Sun Jul 19 18:14:20 2009
@@ -89,10 +89,11 @@
 			end
 		end
 					=

-		local text =3D sprintf("%5.1ffps %dt %db gfx | OGRE:%s | LUA:%s | cpu/(c=
pu+gpu):%d%% | job:%d | blockload:%d/%d",
+		local text =3D sprintf("%5.1ffps %dt %db gfx | OGRE:%s LUA:%s C:%s | cpu=
/(cpu+gpu):%d%% | job:%d | blockload:%d/%d",
 			fps, t, b, =

 			DisplayMemoryUsageFormatHelper(memoryusage),
 			DisplayMemoryUsageFormatHelper(mem_dyn), =

+			DisplayMemoryUsageFormatHelper(Client_GetMemoryUsage()), =

 			floor((gFrameTimeCPUFraction or 0)*100),
 			j, l, lu   -- #"job.create()-jobs"    blockloader: working/killme
 		)



From no-reply at zwischenwelt.org  Sat Jul 25 21:30:55 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 25 Jul 2009 19:30:55 -0000
Subject: [Iris-commit] [IRIS] r3088 - in /trunk: bin/iris2.exe
	vc9/iris.vcproj
Message-ID: <20090725193056.08A967A980A9@simon>

Author: sience
Date: Sat Jul 25 21:30:55 2009
New Revision: 3088

Log:
-updated project file
-new win32 binary

Modified:
    trunk/bin/iris2.exe
    trunk/vc9/iris.vcproj

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/vc9/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc9/iris.vcproj (original)
+++ trunk/vc9/iris.vcproj Sat Jul 25 21:30:55 2009
@@ -729,6 +729,10 @@
 					>
 				</File>
 				<File
+					RelativePath=3D"..\lugre\include\lugre_utils.h"
+					>
+				</File>
+				<File
 					RelativePath=3D"..\lugre\include\lugre_viewport.h"
 					>
 				</File>
@@ -994,6 +998,10 @@
 				</File>
 				<File
 					RelativePath=3D"..\lugre\src\lugre_transform_mesh.cpp"
+					>
+				</File>
+				<File
+					RelativePath=3D"..\lugre\src\lugre_utils.cpp"
 					>
 				</File>
 				<File



