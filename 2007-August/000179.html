<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1363 - in /trunk/data/lua: ./ net/ obj/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1363%20-%20in%20/trunk/data/lua%3A%20./%20net/%20obj/&In-Reply-To=%3C20070828230717.3F7911C186FB%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000177.html">
   <LINK REL="Next"  HREF="000178.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1363 - in /trunk/data/lua: ./ net/ obj/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1363%20-%20in%20/trunk/data/lua%3A%20./%20net/%20obj/&In-Reply-To=%3C20070828230717.3F7911C186FB%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1363 - in /trunk/data/lua: ./ net/ obj/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Wed Aug 29 01:07:16 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000177.html">[Iris-commit] [IRIS] r1362 - in /trunk/data/lua: lib.util.lua net.login.lua net/net.dynamic.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
</A></li>
        <LI>Next message: <A HREF="000178.html">[Iris-commit] [IRIS] r1364 - in /branches/knut/data/lua: ./ net/	obj/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#179">[ date ]</a>
              <a href="thread.html#179">[ thread ]</a>
              <a href="subject.html#179">[ subject ]</a>
              <a href="author.html#179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Wed Aug 29 01:07:16 2007
New Revision: 1363

Log:
syncing for merge

Modified:
    trunk/data/lua/lib.3d.map.lua
    trunk/data/lua/lib.3d.mobileanim.lua
    trunk/data/lua/lib.3d.renderer.lua
    trunk/data/lua/lib.data.lua
    trunk/data/lua/lib.models.lua
    trunk/data/lua/lib.spellbooks.lua
    trunk/data/lua/lib.static.lua
    trunk/data/lua/lib.test.lua
    trunk/data/lua/lib.uodragdrop.lua
    trunk/data/lua/lib.walking2.lua
    trunk/data/lua/net.cursor.lua
    trunk/data/lua/net.other.lua
    trunk/data/lua/net.uodragdrop.lua
    trunk/data/lua/net/net.dynamic.lua
    trunk/data/lua/obj/obj.mobile.lua
    trunk/data/lua/obj/obj.player.lua

Modified: trunk/data/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.map.lua (original)
+++ trunk/data/lua/lib.3d.map.lua Wed Aug 29 01:07:16 2007
@@ -193,7 +193,7 @@
 						if (gLightsources) then
 							local arrtiletype =3D {}
 							arrtiletype =3D GetStaticTileType(iTileTypeID)
-							if( BitwiseAND(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) =
~=3D 0 ) then
+							if( TestBit(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ) t=
hen
 								local x,y,z =3D Renderer3D:UOPosToLocal(entity.x,entity.y,entity.z=
 * 0.1)
 								Client_AddPointLight(entity.x-0.5,entity.y-0.5,entity.z+arrtiletyp=
e.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
 							end

Modified: trunk/data/lua/lib.3d.mobileanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.mobileanim.lua (original)
+++ trunk/data/lua/lib.3d.mobileanim.lua Wed Aug 29 01:07:16 2007
@@ -62,10 +62,10 @@
 	-- detect animation modifiers : staff, mount=3Dhorse, combat
 	local mount		=3D GetMobileEquipmentItem(mobile,kLayer_Mount)
 	local twohand	=3D GetMobileEquipmentItem(mobile,kLayer_TwoHanded) -- staff
-	local bHasStaff =3D twohand and BitwiseAND(GetStaticTileTypeFlags(twohand=
.artid) or 0,kTileDataFlag_Weapon) ~=3D 0
-	local bWarMode 	=3D BitwiseAND(mobile.flag,kMobileFlag_WarMode) ~=3D 0 --=
 combat
-	local bRunning 	=3D mobile.walksmooth_moving and (BitwiseAND(mobile.dir,k=
WalkFlag_Run) ~=3D 0)
-	--local bRunning 	=3D (mobile.walksmooth_moving or mobile.walksmooth_turn=
ing) and (BitwiseAND(mobile.dir,kWalkFlag_Run) ~=3D 0)
+	local bHasStaff =3D twohand and TestBit(GetStaticTileTypeFlags(twohand.ar=
tid) or 0,kTileDataFlag_Weapon)
+	local bWarMode 	=3D TestBit(mobile.flag,kMobileFlag_WarMode) -- combat
+	local bRunning 	=3D mobile.walksmooth_moving and TestBit(mobile.dir,kWalk=
Flag_Run)
+	--local bRunning 	=3D (mobile.walksmooth_moving or mobile.walksmooth_turn=
ing) and TestBit(mobile.dir,kWalkFlag_Run)
 	--local bPlayerIsInWarMode =3D gActWarmode =3D=3D gWarmode_Combat -- TODO=
 : only player, not any mobile
 	=

 	--(mobile.walksmooth_turning or mobile.walksmooth_moving or (not mobile.a=
nimstate))
@@ -193,7 +193,7 @@
 	local yloc2 =3D mobile.gfx3d_walksmooth_last_yloc
 	local zloc2 =3D mobile.gfx3d_walksmooth_last_zloc
 	local dir2  =3D mobile.gfx3d_walksmooth_last_dir
-	local bRunning =3D BitwiseAND(dir2,kWalkFlag_Run) ~=3D 0
+	local bRunning =3D TestBit(dir2,kWalkFlag_Run)
 	dir1 =3D BitwiseAND(dir1,hex2num(&quot;0x07&quot;))
 	dir2 =3D BitwiseAND(dir2,hex2num(&quot;0x07&quot;))
 	=


Modified: trunk/data/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.renderer.lua (original)
+++ trunk/data/lua/lib.3d.renderer.lua Wed Aug 29 01:07:16 2007
@@ -800,7 +800,7 @@
 			if (gLightsources) then
 			local arrtiletype =3D {}
 			arrtiletype =3D GetStaticTileType(item.artid)
-			if( BitwiseAND(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ~=3D=
 0 ) then
+			if( TestBit(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ) then
 				local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc=
+arrtiletype.miHeight) * 0.1)
 				Client_AddPointLight(x,y,z, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
 			end

Modified: trunk/data/lua/lib.data.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.data.lua (original)
+++ trunk/data/lua/lib.data.lua Wed Aug 29 01:07:16 2007
@@ -2,7 +2,7 @@
 -- nil if not wearable
 function GetPaperdollLayerFromTileType (iTileTypeID)
 	local t =3D GetStaticTileType(iTileTypeID)
-	if (t and BitwiseAND(t.miFlags,kTileDataFlag_Wearable) ~=3D 0) then =

+	if (t and TestBit(t.miFlags,kTileDataFlag_Wearable)) then =

 		return t.miQuality
 	end
 	return nil

Modified: trunk/data/lua/lib.models.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.models.lua (original)
+++ trunk/data/lua/lib.models.lua Wed Aug 29 01:07:16 2007
@@ -344,12 +344,12 @@
 					=

 					--local bShieldHand=3Dfalse
 					-- check for shields (if wearable -&gt; take quality as layer) (stupid)
-					--if (BitwiseAND(tiledata.miFlags,kTileDataFlag_Wearable)~=3D0) then
+					--if (TestBit(tiledata.miFlags,kTileDataFlag_Wearable)) then
 						--print(&quot;QualityLayer=3D&quot;..tiledata.miQuality..&quot; &quot;..tiledata.msName)
 					--	bShieldHand=3Dtrue
 					--end
 					=

-					local bDoubleHanded =3D (layer =3D=3D kLayer_TwoHanded) and (BitwiseA=
ND(tiledata.miFlags,kTileDataFlag_Weapon) ~=3D 0)
+					local bDoubleHanded =3D (layer =3D=3D kLayer_TwoHanded) and TestBit(t=
iledata.miFlags,kTileDataFlag_Weapon)
 					if (layer =3D=3D kLayer_OneHanded or bDoubleHanded) then =

 						iPrimaryHandItem =3D {hue=3Dhue,modelid=3Dmodelid}
 					elseif (layer =3D=3D kLayer_TwoHanded) then =


Modified: trunk/data/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.spellbooks.lua (original)
+++ trunk/data/lua/lib.spellbooks.lua Wed Aug 29 01:07:16 2007
@@ -193,7 +193,7 @@
 				local spellcounter=3D0
 =

 				for spell=3D1, spellnumber do
-					if (BitwiseAND(spellbook.matrix[circle], BitwiseSHL(1,spell-1)) ~=3D =
0) then
+					if (TestBit(spellbook.matrix[circle], BitwiseSHL(1,spell-1))) then
 						-- increase number of available spells
 						spellcounter=3Dspellcounter+1
 						local spellbutton =3D MakeBorderGumpPart(curparent, hex2num(&quot;0x837&quot;)=
, 60 + rightspacer, 20+((spellcounter+1)*15) - top_align)
@@ -233,7 +233,7 @@
 				local spellnumber=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[ci=
rcle])
 			=

 				for spell=3D1, spellnumber do
-					if (BitwiseAND(spellbook.matrix[circle], BitwiseSHL(1,spell-1)) ~=3D =
0) then
+					if (TestBit(spellbook.matrix[circle], BitwiseSHL(1,spell-1))) then
 						-- increase number of available spells
 						spellcounter=3Dspellcounter+1
 =


Modified: trunk/data/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.static.lua (original)
+++ trunk/data/lua/lib.static.lua Wed Aug 29 01:07:16 2007
@@ -108,7 +108,7 @@
 				end
 				-- Hue this Model | TODO : Partitial Hue
 				if (gHueLoader) then
-					if( BitwiseAND(GetStaticTileTypeFlags(iTranslatedTileTypeID) or 0,kTi=
leDataFlag_Partial_Hue) ~=3D 0 ) then
+					if( TestBit(GetStaticTileTypeFlags(iTranslatedTileTypeID) or 0,kTileD=
ataFlag_Partial_Hue) ) then
 						printdebug(&quot;static&quot;,&quot;parthuedmodel=3D&quot;,iTranslatedTileTypeID)
 					else
 						HueMesh(meshname,gHueLoader,iHue)

Modified: trunk/data/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.test.lua (original)
+++ trunk/data/lua/lib.test.lua Wed Aug 29 01:07:16 2007
@@ -202,9 +202,9 @@
 =

 -- test if lua can perform bitwise operations correctly
 function LuaBitwiseTest ()
-	if ( BitwiseAND(hex2num(&quot;0x4000250e&quot;),hex2num(&quot;0x80000000&quot;)) ~=3D 0) then=
 print(&quot;we got bug&quot;) Crash() end
+	if ( TestBit(hex2num(&quot;0x4000250e&quot;),hex2num(&quot;0x80000000&quot;))) then print(&quot;we=
 got bug&quot;) Crash() end
 	local test =3D hex2num(&quot;0x4000250e&quot;)
-	if ( BitwiseAND(test,hex2num(&quot;0x80000000&quot;)) ~=3D 0) then print(&quot;we got bu=
g&quot;) Crash() end
+	if ( TestBit(test,hex2num(&quot;0x80000000&quot;))) then print(&quot;we got bug&quot;) Crash(=
) end
 	print(Hex2Num(&quot;0x70000020&quot;),&quot;=3D&quot;,hex2num(&quot;0x70000020&quot;))
 	print(Hex2Num(&quot;0x941c48bf&quot;),&quot;=3D&quot;,hex2num(&quot;0x941c48bf&quot;))
 	LuaBitwiseTest_Pair(&quot;0x941c48bf&quot;,&quot;0x0000000f&quot;)

Modified: trunk/data/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.uodragdrop.lua (original)
+++ trunk/data/lua/lib.uodragdrop.lua Wed Aug 29 01:07:16 2007
@@ -90,7 +90,7 @@
 			gCurrentRenderer:MousePick()
 			=

 			if (gMousePickFoundHit) then
-				if (gMousePickFoundHit.hittype =3D=3D kMousePickHitType_Dynamic and Bi=
twiseAND(GetStaticTileTypeFlags( gDragDropItem.artid ) or 0,kTileDataFlag_C=
ontainer)) then
+				if (gMousePickFoundHit.hittype =3D=3D kMousePickHitType_Dynamic and Te=
stBit(GetStaticTileTypeFlags( gDragDropItem.artid ) or 0,kTileDataFlag_Cont=
ainer)) then
 					Send_Drop_Object( gDragDropItem.serial, hex2num(&quot;0xFFFF&quot;), hex2num(&quot;0=
xFFFF&quot;), 0, gMousePickFoundHit.dynamic.serial )
 				elseif (gMousePickFoundHit.hittype =3D=3D kMousePickHitType_Mobile) th=
en					=

 					--Send_Equip_Item_Request( gDragDropItem.serial, gDragDropItem.layer,=
 gMousePickFoundHit.mobile.serial )

Modified: trunk/data/lua/lib.walking2.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.walking2.lua (original)
+++ trunk/data/lua/lib.walking2.lua Wed Aug 29 01:07:16 2007
@@ -38,9 +38,9 @@
 =

 function isBridge(flag)
 	local bIsBridge=3Dfalse
-	if ((BitwiseAND(flag, kTileDataFlag_StairBack) ~=3D 0) or
-		(BitwiseAND(flag, kTileDataFlag_StairRight) ~=3D 0) or
-		(BitwiseAND(flag, kTileDataFlag_Bridge) ~=3D 0) ) then
+	if ((TestBit(flag, kTileDataFlag_StairBack	)) or
+		(TestBit(flag, kTileDataFlag_StairRight	)) or
+		(TestBit(flag, kTileDataFlag_Bridge		)) ) then
 		bIsBridge=3Dtrue
 	end
 	return bIsBridge	=

@@ -49,7 +49,7 @@
 function isSurface(flag)
 	local bIsSurface=3Dfalse
 =

-	if (BitwiseAND(flag, kTileDataFlag_Surface) ~=3D 0) then
+	if (TestBit(flag, kTileDataFlag_Surface)) then
 		bIsSurface=3Dtrue
 	end
 =

@@ -59,7 +59,7 @@
 function isImpassable(flag)
 	local bIsImpassable=3Dfalse
 =

-	if (BitwiseAND(flag, kTileDataFlag_Impassable) ~=3D 0) then
+	if (TestBit(flag, kTileDataFlag_Impassable)) then
 		bIsImpassable=3Dtrue
 	end
 =


Modified: trunk/data/lua/net.cursor.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.cursor.lua (original)
+++ trunk/data/lua/net.cursor.lua Wed Aug 29 01:07:16 2007
@@ -119,7 +119,7 @@
 		-- The target object's artwork number (or body number if the target is a=
 mobile).
 		-- 0x0000 is the ground if Type is 0x01.
 =

---	if (BitwiseAND(flag,hex2num(&quot;0x03&quot;)) ~=3D 0) then
+--	if (TestBit(flag,hex2num(&quot;0x03&quot;))) then
 	if (flag =3D=3D hex2num(&quot;0x03&quot;)) then
 		print(&quot;Cancel Target Mode&quot;)
 		CleanupTargetMode() -- server side cancel

Modified: trunk/data/lua/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.other.lua (original)
+++ trunk/data/lua/net.other.lua Wed Aug 29 01:07:16 2007
@@ -215,7 +215,7 @@
 			entry.textid	=3D input:PopNetUint16() -- ID is the file number for intl=
oc#.language e.g intloc6.enu and the index into that
 			entry.text 		=3D GetPopupEntryText(entry.textid) or &quot;unknown&quot;
 			entry.flags		=3D input:PopNetUint16() -- 0x01 =3D locked, 0x02 =3D arro=
w, 0x20 =3D color
-			if (BitwiseAND(entry.flags,kPopupEntryFlag_Color) ~=3D 0) then
+			if (TestBit(entry.flags,kPopupEntryFlag_Color)) then
 				entry.color	=3D input:PopNetUint16() =

 				-- rgb 1555 color (ex, 0 =3D transparent, 0x8000 =3D solid black, 0x1F=
 =3D blue, 0x3E0 =3D green, 0x7C00 =3D red)
 			else
@@ -903,7 +903,7 @@
 		out:PushNetUint16(hex2num(&quot;0xc0&quot;)) -- (( count &lt;&lt; 4 ) | ( (keywords.at( =
0 ) &amp; 0xF000) &gt;&gt; 8 ))
 =

 		for i=3D0, i &lt; speechcount do
-			if ( BitwiseAND(i,1) =3D=3D 0 ) then
+			if ( not TestBit(i,1) ) then
 				out:PushNetUint16(speechids[i])
 			else
 				local nextword

Modified: trunk/data/lua/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.uodragdrop.lua (original)
+++ trunk/data/lua/net.uodragdrop.lua Wed Aug 29 01:07:16 2007
@@ -238,7 +238,7 @@
 			local flags,weight,quality,unkn1,unkn2,quantity,animid,unkn3,hue,unkn4,=
height,name =3D gTileTypeLoader:GetStaticTileType(item.artid+32*512)
 =

 			-- if the item beneath has the same artid and stackable, try to stack t=
hem
-			if (BitwiseAND(flags, kTileDataFlag_Generic_Stackable) ~=3D 0) and gMou=
sePickFoundHit.item.artid =3D=3D item.artid then =

+			if (TestBit(flags, kTileDataFlag_Generic_Stackable)) and gMousePickFoun=
dHit.item.artid =3D=3D item.artid then =

 				target =3D gMousePickFoundHit.item.serial =

 			end
 		end

Modified: trunk/data/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.dynamic.lua (original)
+++ trunk/data/lua/net/net.dynamic.lua Wed Aug 29 01:07:16 2007
@@ -45,7 +45,7 @@
 	newitem.artid =3D input:PopNetUint16() -- model =3D artwork . Include the=
 flag 0x8000 if the item's stackid is greater than zero.	=

 	=

 	-- newitem.amount  (or model # for corpses)
-	if ( BitwiseAND(newitem.serial,hex2num(&quot;0x80000000&quot;)) ~=3D 0) then =

+	if (TestBit(newitem.serial,hex2num(&quot;0x80000000&quot;))) then =

 		newitem.amount =3D input:PopNetUint16() =

 	else 	=

 		newitem.amount =3D 1
@@ -54,14 +54,14 @@
 	--print(&quot;artid,artidhex,bitwiseand&quot;,newitem.artid,sprintf(&quot;0x%04x&quot;,newite=
m.artid),BitwiseAND(newitem.artid,hex2num(&quot;0x8000&quot;)))
 	=

 	-- newitem.artid_addstack : The number to add to the item's artwork when =
Amount &gt; 1.
-	if ( BitwiseAND(newitem.artid,hex2num(&quot;0x8000&quot;)) ~=3D 0) then =

+	if (TestBit(newitem.artid,hex2num(&quot;0x8000&quot;))) then =

 			newitem.artid_addstack =3D input:PopNetUint8() =

 	else	newitem.artid_addstack =3D 0 end
 =

 	newitem.xloc =3D input:PopNetUint16() --only use lowest significant 15 bi=
ts)
 	newitem.yloc =3D input:PopNetUint16()
 =

-	if ( BitwiseAND(newitem.xloc,hex2num(&quot;0x8000&quot;)) ~=3D 0) then
+	if (TestBit(newitem.xloc,hex2num(&quot;0x8000&quot;))) then
 		newitem.dir =3D input:PopNetUint8()
 	else	=

 		newitem.dir =3D 0
@@ -72,12 +72,12 @@
 	newitem.hue =3D 0
 	newitem.flag =3D 0
 	if (iPacketSize - (input:GetTotalPopped() - popped_start) &gt;=3D 2) then
-		if (BitwiseAND(newitem.yloc,hex2num(&quot;0x8000&quot;)) ~=3D 0) then
+		if (TestBit(newitem.yloc,hex2num(&quot;0x8000&quot;))) then
 			newitem.hue =3D input:PopNetUint16()
 		end
 	end
 	if (iPacketSize - (input:GetTotalPopped() - popped_start) &gt;=3D 1) then
-		if (BitwiseAND(newitem.yloc,hex2num(&quot;0x4000&quot;)) ~=3D 0) then
+		if (TestBit(newitem.yloc,hex2num(&quot;0x4000&quot;))) then
 			newitem.flag =3D input:PopNetUint8()
 		end
 	end

Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Wed Aug 29 01:07:16 2007
@@ -170,6 +170,91 @@
 	mobile.bTooltippRequested =3D true
 	Send_SingleClick(mobile.serial)
 end
+
+
+ =

+
+-- note : modifying existing elements and removing from a lua table while =
iterating is save, only inserting is dangerous
+function DestroyMobileItemBySerial (serial) =

+	local item =3D gMobileItemsBySerial[serial]
+	if (item) then DestroyMobileItem(item) end
+end
+
+function DestroyMobileItem (item) =

+	item.mobile.equipment[item.layer] =3D nil
+	gMobileItemsBySerial[item.serial] =3D nil
+	if (item.widget) then item.widget:Destroy()  item.widget =3D nil end -- p=
aperdoll widgets
+	UpdateMobileEquipment(item.mobile) =

+end
+
+-- update the position of the graphical representation
+-- TODO : center Mobilename overhead, dont use fixed height - check height=
 of mobiles (big dragons)
+function UpdateMobile (mobile)
+	-- create empty stats if there is not stats table
+	mobile.stats =3D mobile.stats or {}
+	=

+	if (not mobile.name) then =

+		RequestMobileTooltipp(mobile)
+	end
+	=

+	-- update life stats in gui elements
+	if (mobile.stats.curHits and mobile.stats.maxHits) then
+		if (mobile.serial =3D=3D gPlayerBodySerial) then
+			-- for player
+			gui.SetHitpoints(mobile.stats.curHits/mobile.stats.maxHits)
+			if (mobile.stats.curMana) then gui.SetMana(mobile.stats.curMana/mobile.=
stats.maxMana) end
+			if (mobile.stats.curStamina) then gui.SetStamina(mobile.stats.curStamin=
a/mobile.stats.maxStamina) end
+			-- update big_stats window
+			UpdateStatusAos()
+		else
+			-- for other mobiles
+			SetNpcStatusHitpoints(mobile, mobile.stats.curHits / mobile.stats.maxHi=
ts)
+		end
+	end
+	=

+	gCurrentRenderer:UpdateMobile( mobile )
+end
+
+function UpdateMobileEquipment (mobile) =

+	if (mobile.serial =3D=3D gPlayerBodySerial and mobile.equipment) then Pla=
yerEquipmentUpdated() end
+	local paperdoll =3D gPaperdolls[mobile.serial]
+	if (paperdoll) then RebuildPaperdoll(paperdoll) end
+	gCurrentRenderer:UpdateMobile( mobile )
+end
+
+
+--- displays the chat text over the head of the mobile, color is 16bit uo =
color
+function MobileDisplayTextOverHead(serial,message,r,g,b)
+	r =3D r or 0
+	g =3D g or 0
+	b =3D b or 0
+
+	local mobile =3D GetMobile(serial)
+	=

+	printdebug(&quot;mobile&quot;,&quot;TEXT MobileDisplayTextOverHead&quot;,serial,message,color)
+	=

+	if mobile then
+		mobile.mlastChatText =3D message
+		mobile.mlastChatTime =3D gMyTicks
+		mobile.mlastChatColor =3D {r =3D r,g =3D g,b =3D b}
+
+		printdebug(&quot;mobile&quot;,&quot;TEXT &quot;..vardump2(mobile))
+
+		gCurrentRenderer:UpdateMobile(mobile)
+	end
+end
+
+--[[
+Mobile Flag Byte: maybe those are similar to the kPacket_Show_Item flag/st=
atus byte ?
+0x00 - None
+0x02 - Female
+0x04 - Poisoned
+0x08 - YellowHits // healthbar gets yellow
+0x10 - FactionShip // unsure why client needs to know
+0x20 - Movable if normally not
+0x40 - War mode
+0x80 - Hidden =

+]]--
 =

 --[[
 mobile.notoriety: =

@@ -193,7 +278,6 @@
 	Hidden =3D 0x80
 ]]--
 =

-
 -- return r,g,b
 function GetNotorietyColor (n)
 	if (n =3D=3D  0) then return 0.0 , 0.0 , 0.0 end -- 0.0 =3D invalid/acros=
s server line
@@ -206,55 +290,6 @@
 	if (n =3D=3D  7) then return 1.0 , 0.0 , 1.0 end -- 7 =3D unknown use (tr=
anslucent (like 0x4000 hue)) =

 	return 0.5,0.5,0.5
 end
- =

-
--- note : modifying existing elements and removing from a lua table while =
iterating is save, only inserting is dangerous
-function DestroyMobileItemBySerial (serial) =

-	local item =3D gMobileItemsBySerial[serial]
-	if (item) then DestroyMobileItem(item) end
-end
-
-function DestroyMobileItem (item) =

-	item.mobile.equipment[item.layer] =3D nil
-	gMobileItemsBySerial[item.serial] =3D nil
-	if (item.widget) then item.widget:Destroy()  item.widget =3D nil end -- p=
aperdoll widgets
-	UpdateMobileEquipment(item.mobile) =

-end
-
--- update the position of the graphical representation
--- TODO : center Mobilename overhead, dont use fixed height - check height=
 of mobiles (big dragons)
-function UpdateMobile (mobile)
-	-- create empty stats if there is not stats table
-	mobile.stats =3D mobile.stats or {}
-	=

-	if (not mobile.name) then =

-		RequestMobileTooltipp(mobile)
-	end
-	=

-	-- update life stats in gui elements
-	if (mobile.stats.curHits and mobile.stats.maxHits) then
-		if (mobile.serial =3D=3D gPlayerBodySerial) then
-			-- for player
-			gui.SetHitpoints(mobile.stats.curHits/mobile.stats.maxHits)
-			if (mobile.stats.curMana) then gui.SetMana(mobile.stats.curMana/mobile.=
stats.maxMana) end
-			if (mobile.stats.curStamina) then gui.SetStamina(mobile.stats.curStamin=
a/mobile.stats.maxStamina) end
-			-- update big_stats window
-			UpdateStatusAos()
-		else
-			-- for other mobiles
-			SetNpcStatusHitpoints(mobile, mobile.stats.curHits / mobile.stats.maxHi=
ts)
-		end
-	end
-	=

-	gCurrentRenderer:UpdateMobile( mobile )
-end
-
-function UpdateMobileEquipment (mobile) =

-	if (mobile.serial =3D=3D gPlayerBodySerial and mobile.equipment) then Pla=
yerEquipmentUpdated() end
-	local paperdoll =3D gPaperdolls[mobile.serial]
-	if (paperdoll) then RebuildPaperdoll(paperdoll) end
-	gCurrentRenderer:UpdateMobile( mobile )
-end
 =

 =

 -- Fighting - Swing [0x2F] 10bytes
@@ -277,24 +312,3 @@
 	local action =3D input:PopNetUint8()
 	print(&quot;NET: Server sends, that player is now (2=3Dghost, 1=3Dresurrect, 0=
=3Dfrom server)=3D&quot;..action)
 end
-
---- displays the chat text over the head of the mobile, color is 16bit uo =
color
-function MobileDisplayTextOverHead(serial,message,r,g,b)
-	r =3D r or 0
-	g =3D g or 0
-	b =3D b or 0
-
-	local mobile =3D GetMobile(serial)
-	=

-	printdebug(&quot;mobile&quot;,&quot;TEXT MobileDisplayTextOverHead&quot;,serial,message,color)
-	=

-	if mobile then
-		mobile.mlastChatText =3D message
-		mobile.mlastChatTime =3D gMyTicks
-		mobile.mlastChatColor =3D {r =3D r,g =3D g,b =3D b}
-
-		printdebug(&quot;mobile&quot;,&quot;TEXT &quot;..vardump2(mobile))
-
-		gCurrentRenderer:UpdateMobile(mobile)
-	end
-end

Modified: trunk/data/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.player.lua (original)
+++ trunk/data/lua/obj/obj.player.lua Wed Aug 29 01:07:16 2007
@@ -102,7 +102,7 @@
 	--mobiledata.zloc
 	-- TODO : knutmerge ??  : local mobile =3D CreateOrUpdateMobile(mobiledat=
a)	=

 	=

-	local bPlayerRunning =3D BitwiseAND(mobiledata.dir,kWalkFlag_Run) ~=3D 0
+	local bPlayerRunning =3D TestBit(mobiledata.dir,kWalkFlag_Run)
 	local fullplayerdir =3D mobiledata.dir
 	mobiledata.dir =3D BitwiseAND(mobiledata.dir,hex2num(&quot;0x07&quot;))
 	=



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000177.html">[Iris-commit] [IRIS] r1362 - in /trunk/data/lua: lib.util.lua net.login.lua net/net.dynamic.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
</A></li>
	<LI>Next message: <A HREF="000178.html">[Iris-commit] [IRIS] r1364 - in /branches/knut/data/lua: ./ net/	obj/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#179">[ date ]</a>
              <a href="thread.html#179">[ thread ]</a>
              <a href="subject.html#179">[ subject ]</a>
              <a href="author.html#179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
