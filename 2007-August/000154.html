<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1338 - in /trunk/data/lua: gui/gui.paperdoll.lua gui/gui.status.lua lib.util.lua net.other.lua net/net.dynamic.lua net/net.mobile.lua net/net.multi.lua obj/obj.main.lua obj/obj.mobile.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1338%20-%20in%20/trunk/data/lua%3A%0A%20gui/gui.paperdoll.lua%20gui/gui.status.lua%20lib.util.lua%20net.other.lua%0A%20net/net.dynamic.lua%20net/net.mobile.lua%20net/net.multi.lua%20obj/obj.main.lua%0A%20obj/obj.mobile.lua&In-Reply-To=%3C20070812154707.746191524001%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000153.html">
   <LINK REL="Next"  HREF="000155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1338 - in /trunk/data/lua: gui/gui.paperdoll.lua gui/gui.status.lua lib.util.lua net.other.lua net/net.dynamic.lua net/net.mobile.lua net/net.multi.lua obj/obj.main.lua obj/obj.mobile.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1338%20-%20in%20/trunk/data/lua%3A%0A%20gui/gui.paperdoll.lua%20gui/gui.status.lua%20lib.util.lua%20net.other.lua%0A%20net/net.dynamic.lua%20net/net.mobile.lua%20net/net.multi.lua%20obj/obj.main.lua%0A%20obj/obj.mobile.lua&In-Reply-To=%3C20070812154707.746191524001%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1338 - in /trunk/data/lua: gui/gui.paperdoll.lua gui/gui.status.lua lib.util.lua net.other.lua net/net.dynamic.lua net/net.mobile.lua net/net.multi.lua obj/obj.main.lua obj/obj.mobile.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Sun Aug 12 17:47:07 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000153.html">[Iris-commit] [IRIS] r1337 - in /trunk/data/lua: gui/gui.container.lua gui/gui.status.lua net.walk.lua net/net.packethandlers.lua
</A></li>
        <LI>Next message: <A HREF="000155.html">[Iris-commit] [IRIS] r1339 - in /branches/knut/data/lua: gui/gui.paperdoll.lua gui/gui.status.lua net.other.lua net.walk.lua net/net.mobile.lua net/net.multi.lua obj/obj.main.lua obj/obj.mobile.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#154">[ date ]</a>
              <a href="thread.html#154">[ thread ]</a>
              <a href="subject.html#154">[ subject ]</a>
              <a href="author.html#154">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Sun Aug 12 17:47:06 2007
New Revision: 1338

Log:
syncing for merge

Modified:
    trunk/data/lua/gui/gui.paperdoll.lua
    trunk/data/lua/gui/gui.status.lua
    trunk/data/lua/lib.util.lua
    trunk/data/lua/net.other.lua
    trunk/data/lua/net/net.dynamic.lua
    trunk/data/lua/net/net.mobile.lua
    trunk/data/lua/net/net.multi.lua
    trunk/data/lua/obj/obj.main.lua
    trunk/data/lua/obj/obj.mobile.lua

Modified: trunk/data/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.paperdoll.lua (original)
+++ trunk/data/lua/gui/gui.paperdoll.lua Sun Aug 12 17:47:06 2007
@@ -45,7 +45,7 @@
 -- rebuild needed on update to have correct layerorder
 -- paperdoll.bIsPlayer (check if is player or npc)
 function RebuildPaperdoll (paperdoll)
-	local mobile =3D gMobiles[paperdoll.mobileserial]
+	local mobile =3D GetMobile(paperdoll.mobileserial)
 	paperdoll.mobile =3D mobile
 	paperdoll.bIsPlayer =3D IsPlayerMobile(mobile)
 	=


Modified: trunk/data/lua/gui/gui.status.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.status.lua (original)
+++ trunk/data/lua/gui/gui.status.lua Sun Aug 12 17:47:06 2007
@@ -56,8 +56,8 @@
 =

 				-- stats update function
 		dialog.UpdateStats =3D function (dialog)
-			if gPlayerBodySerial and gMobiles then
-				local m =3D gMobiles[gPlayerBodySerial]
+			if gPlayerBodySerial then
+				local m =3D GetMobile(gPlayerBodySerial)
 				if m and m.stats then
 					local s =3D m.stats
 					=


Modified: trunk/data/lua/lib.util.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.util.lua (original)
+++ trunk/data/lua/lib.util.lua Sun Aug 12 17:47:06 2007
@@ -1,6 +1,8 @@
 --function printf(...) io.write(string.format(&quot;%d:&quot;,Client_GetTicks())..st=
ring.format(unpack(arg))) end
 function printf(...) io.write(string.format(unpack(arg))) end
 function sprintf(...) return string.format(unpack(arg)) end
+
+function TestBit (mask1,mask2) return BitwiseAND(mask1,mask2) ~=3D 0 end
 =

 gDebugCategories =3D {} -- gDebugCategories.mycat =3D false to disable out=
put
 function printdebug(category,...) =


Modified: trunk/data/lua/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.other.lua (original)
+++ trunk/data/lua/net.other.lua Sun Aug 12 17:47:06 2007
@@ -286,7 +286,7 @@
 		local customhouseserial =3D input:PopNetUint32()
 		local customhouserevision =3D input:PopNetUint32()
 =

-		local dyn =3D gDynamics[customhouseserial]
+		local dyn =3D GetDynamic(customhouseserial)
 		-- check if houserevision exists
 		if (dyn) then
 			if (dyn.customhouserevision) then

Modified: trunk/data/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.dynamic.lua (original)
+++ trunk/data/lua/net/net.dynamic.lua Sun Aug 12 17:47:06 2007
@@ -19,7 +19,7 @@
 	=

 	--print(&quot;NET : Equip_Item&quot;,vardump(item))
 	=

-	local mobile =3D gMobiles[item.mobile_serial]
+	local mobile =3D GetMobile(item.mobile_serial)
 	if (mobile) then
 		item.mobile =3D mobile
 		if (mobile.equipment[item.layer]) then
@@ -135,7 +135,7 @@
 	=

 	local bCreateNew =3D true
 	=

-	local olditem =3D gDynamics[newitem.serial]
+	local olditem =3D GetDynamic(newitem.serial)
 	if (olditem) then
 		-- if only the position changed we can just update the old one
 		if (	newitem.artid =3D=3D olditem.artid and =


Modified: trunk/data/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.mobile.lua (original)
+++ trunk/data/lua/net/net.mobile.lua Sun Aug 12 17:47:06 2007
@@ -1,124 +1,80 @@
 -- simple mobile, no equipment, fixed size packet 0x77
 function gPacketHandler.kPacket_Naked_MOB ()
-	local mobile =3D {}
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	mobile.serial =3D input:PopNetUint32()
-	=

-	local oldmobile =3D gMobiles[mobile.serial]
-	if (oldmobile) then mobile =3D oldmobile end -- update	=

-	mobile.ismobile =3D true -- needed to identify the mobile in 2d renderer
-	=

-	mobile.artid =3D input:PopNetUint16()
-	mobile.xloc =3D input:PopNetUint16()
-	mobile.yloc =3D input:PopNetUint16()
-	mobile.zloc =3D input:PopInt8()
-	mobile.dir =3D input:PopNetUint8()
-	mobile.hue =3D input:PopNetUint16() -- hue/skin color
-	mobile.flag =3D input:PopNetUint8()
-	mobile.notoriety =3D input:PopNetUint8()
-	=

-	--AddFadeLines(&quot;nakedmob [&quot;..(mobile.serial)..&quot;]&quot;)
-	--print(&quot;\t\tNaked_MOB &quot;..vardump(mobile))
-	=

-	gMobiles[mobile.serial] =3D mobile
-	=

-	-- request basic stats info
-	Send_ClientQuery(gRequest_States,mobile.serial)
-	=

-	UpdateMobile(mobile)
+	local input =3D GetRecvFIFO()
+	local id =3D input:PopNetUint8()
+	=

+	local mobiledata =3D {}
+	mobiledata.serial =3D input:PopNetUint32()
+	mobiledata.artid =3D input:PopNetUint16()
+	mobiledata.xloc =3D input:PopNetUint16()
+	mobiledata.yloc =3D input:PopNetUint16()
+	mobiledata.zloc =3D input:PopInt8()
+	mobiledata.dir =3D input:PopNetUint8()
+	mobiledata.hue =3D input:PopNetUint16() -- hue/skin color
+	mobiledata.flag =3D input:PopNetUint8()
+	mobiledata.notoriety =3D input:PopNetUint8()
+	=

+	CreateOrUpdateMobile(mobiledata)
 end
 =

 -- Equipped_MOB packet (0x78)
--- TODO : rest of the packet
--- TODO : Tooltip request
 function gPacketHandler.kPacket_Equipped_MOB() -- ProtocolRecv_AddMobile
-	local mobile =3D {}
-	local input =3D GetRecvFIFO()
-
+	local input =3D GetRecvFIFO()
 	local fifolen_start =3D input:Size()
 	local id =3D input:PopNetUint8()
 	local iPacketSize =3D input:PopNetUint16()
-	mobile.serial =3D input:PopNetUint32()
-	=

-	local oldmobile =3D gMobiles[mobile.serial]
-	if (oldmobile) then mobile =3D oldmobile end -- update
-	mobile.ismobile =3D true -- needed to identify the mobile in 2d renderer
-	=

-	mobile.artid =3D input:PopNetUint16()
-
-	if (BitwiseAND(mobile.serial,hex2num(&quot;0x80000000&quot;)) ~=3D 0) then
-			mobile.amount =3D input:PopNetUint16()
-			print(&quot;tag corpse&quot;)
-	else 	mobile.amount =3D 1 end -- amount/Corpse Model Num
-	=

-	mobile.xloc =3D input:PopNetUint16()
-	mobile.yloc =3D input:PopNetUint16()
-	=

-	-- TOOD : check if this 2nd dir actually is used, or just a copy/paste er=
ror in the packet guide ?!?
-	if (BitwiseAND(mobile.xloc,hex2num(&quot;0x8000&quot;)) ~=3D 0) then
-			mobile.dir2 =3D input:PopNetUint16()
-			print(&quot;tag dir2&quot;)
-	else 	mobile.dir2 =3D -1 end -- why 2 directions ?!?
-
-	mobile.zloc =3D input:PopInt8()
-	mobile.dir =3D input:PopNetUint8()
-	mobile.hue =3D input:PopNetUint16()  -- dye/skin color
-	mobile.flag =3D input:PopNetUint8()
-	mobile.notoriety =3D input:PopNetUint8() -- TODO : (2's complement signed)
-	mobile.equipment =3D {}
-
-	local equipcount =3D 0
-	local loopalive =3D true
-
-	while loopalive do =

-		local item =3D {}
-		if ( iPacketSize &gt;=3D (fifolen_start - input:Size()+4) ) then
-			item.serial =3D input:PopNetUint32()
-			if (item.serial =3D=3D 0) then
-				loopalive =3D false
-			else
-				item.mobile =3D mobile
-				item.mobile_serial =3D mobile.serial
-				=

-				if ( iPacketSize &gt;=3D (fifolen_start - input:Size()+3) ) then
-					item.artid =3D input:PopNetUint16()
-					item.layer =3D input:PopNetUint8()
-					if ((BitwiseAND(item.artid,hex2num(&quot;0x8000&quot;)) ~=3D 0) and ( iPacketSi=
ze &gt;=3D (fifolen_start - input:Size()+2) )) then
-							item.hue =3D input:PopNetUint16()
-					else	item.hue =3D 0 -- TODO : default value ?
-					end
-					item.artid =3D BitwiseAND(item.artid,hex2num(&quot;0x7fff&quot;))
-					if (mobile.equipment[item.layer]) then print(&quot;Equipped_MOB : layer co=
ntains more than one item&quot;,item.layer) end
-					mobile.equipment[item.layer] =3D item
-					gMobileItemsBySerial[item.serial] =3D item
-					--print(&quot;Equipped_MOB add item&quot;,mobile.serial,sprintf(&quot;0x%02x&quot;,item.l=
ayer),item.artid)
-					equipcount =3D equipcount + 1
-				else
-					loopalive =3D false
-				end
-			end
-		else
-			loopalive =3D false
-		end
-	end
-	=

-	if (equipcount &gt; 2) then gMobileWithPaperdoll =3D mobile end
-	=

-	mobile.serial	=3D BitwiseAND(mobile.serial,hex2num(&quot;0x7fffffff&quot;))
-	mobile.xloc		=3D BitwiseAND(mobile.xloc,hex2num(&quot;0x7fff&quot;))
-
-	--AddFadeLines(&quot;equippedmob [&quot;..(mobile.serial)..&quot;]&quot;)
-	--print(&quot;\t\tEquipped_MOB &quot;..vardump(mobile))
-	gMobiles[mobile.serial] =3D mobile
-	=

-	-- request basic stats info
-	Send_ClientQuery(gRequest_States,mobile.serial)
-
-	UpdateMobile(mobile)	=

-	=

-	UpdateMobileEquipment(mobile)
-end
+	=

+	local mobiledata =3D {}
+	mobiledata.serial =3D input:PopNetUint32()
+	mobiledata.artid =3D input:PopNetUint16()
+
+	-- this is related to corpse stuff, some encoded modelid
+	if (TestBit(mobiledata.serial,hex2num(&quot;0x80000000&quot;))) then
+			mobiledata.amount =3D input:PopNetUint16()
+	else 	mobiledata.amount =3D 1 end -- amount/Corpse Model Num
+	=

+	mobiledata.xloc =3D input:PopNetUint16()
+	mobiledata.yloc =3D input:PopNetUint16()
+	=

+	-- the usage of this and on which servers it occurs on is unknown
+	if (TestBit(mobiledata.xloc,hex2num(&quot;0x8000&quot;))) then
+			mobiledata.dir2 =3D input:PopNetUint16()
+	else 	mobiledata.dir2 =3D -1 end
+
+	mobiledata.zloc =3D input:PopInt8()
+	mobiledata.dir =3D input:PopNetUint8()
+	mobiledata.hue =3D input:PopNetUint16()  -- dye/skin color
+	mobiledata.flag =3D input:PopNetUint8()
+	mobiledata.notoriety =3D input:PopNetUint8() -- TODO : (2's complement si=
gned)
+	=

+	mobiledata.serial	=3D BitwiseAND(mobiledata.serial,hex2num(&quot;0x7fffffff&quot;))
+	mobiledata.xloc		=3D BitwiseAND(mobiledata.xloc,hex2num(&quot;0x7fff&quot;))
+	=

+	local equipmentdata =3D {}
+
+	while true do =

+		if ( iPacketSize &lt; (fifolen_start - input:Size()+4) ) then break end
+		=

+		local itemdata =3D {}
+		itemdata.serial =3D input:PopNetUint32()
+		if (itemdata.serial =3D=3D 0) then break end
+		=

+		if ( iPacketSize &lt; (fifolen_start - input:Size()+3) ) then break end
+		itemdata.artid =3D input:PopNetUint16()
+		itemdata.layer =3D input:PopNetUint8()
+		if (TestBit(itemdata.artid,hex2num(&quot;0x8000&quot;)) and ( iPacketSize &gt;=3D (fi=
folen_start - input:Size()+2) )) then
+				itemdata.hue =3D input:PopNetUint16()
+		else	itemdata.hue =3D 0 -- TODO : default value ?
+		end
+		itemdata.artid =3D BitwiseAND(itemdata.artid,hex2num(&quot;0x7fff&quot;))
+		if (equipmentdata[itemdata.layer]) then print(&quot;warning ! Equipped_MOB : =
layer contains more than one item&quot;,itemdata.layer) end
+		equipmentdata[itemdata.layer] =3D item
+	end
+	=

+	CreateOrUpdateMobile(mobiledata,equipmentdata)
+	ResetWalkQueue()
+end
+
 =

 -- 0x20 Teleport packet (also known as ProtocolRecv_Draw_Player)
 -- Note: Only used with the character being played by the client. =

@@ -217,7 +173,7 @@
 	=

 	--printf(&quot;NET : kPacket_Mobile_Stats mobile=3D0x%08x name=3D%s\n&quot;,mobile_=
id,mobilename)
 	=

-	local mobile =3D gMobiles[mobile_id]
+	local mobile =3D GetMobile(mobile_id)
 	local oldhp =3D 0
 	if (mobile) then
 		if (mobile.stats) then =


Modified: trunk/data/lua/net/net.multi.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.multi.lua (original)
+++ trunk/data/lua/net/net.multi.lua Sun Aug 12 17:47:06 2007
@@ -260,7 +260,7 @@
 =

 	-- print(&quot;Custom House Tiles&quot;,vardump(lTile))
 =

-	local dyn =3D gDynamics[customhouseserial]
+	local dyn =3D GetDynamic(customhouseserial)
 	local update_or_create_house =3D false
 =

 	-- if dynamic-customhouse-multi alreay exists

Modified: trunk/data/lua/obj/obj.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.main.lua (original)
+++ trunk/data/lua/obj/obj.main.lua Sun Aug 12 17:47:06 2007
@@ -2,20 +2,39 @@
 dofile(libpath .. &quot;obj/obj.dynamic.lua&quot;)
 dofile(libpath .. &quot;obj/obj.player.lua&quot;)
 =

+gObjectList =3D {}
+gDynamics =3D {}
+gMobiles =3D {}
+gMobileItemsBySerial =3D {} -- items equipped on mobiles TODO : killme !
+
+function GetDynamic (serial) return gDynamics[serial] end
 function GetMobile (mobileserial) return gMobiles[mobileserial] end
 function GetMobileEquipmentItem (mobile,layer) return mobile.equipment[lay=
er] end
 function GetMobileEquipmentList (mobile) return mobile.equipment end
 function GetContainerContentList (container) return container.items end
-function GetObjectBySerial (serial) return gMobileItemsBySerial[serial] or=
 gMobiles[serial] or gDynamics[serial] end
+function GetObjectBySerial (serial) return gMobileItemsBySerial[serial] or=
 GetMobile(serial) or gDynamics[serial] end
 =

-function GetDynamicList () return gDynamics end
-function GetMobileList () return gMobiles end
+function DynamicIsInWorld (dynamic) return not dynamic.container end  -- T=
ODO : spelling of container correct ???
 =

-gDynamics =3D {}
+function GetDynamicList	() return gDynamics end
+function GetMobileList	() return gMobiles end
 =

+-- temporary knut merge wrappers for syncing, naming will be fixed as the =
merge progresses
+function KNUTMERGETEMP_CREATE_EMPTY_OBJECT	(serial) =

+	local newitem =3D {serial=3Dserial} =

+	gObjectList[serial] =3D newitem
+	return newitem
+end
+function KNUTMERGETEMP_CREATE_EMPTY_MOBILE	(serial)
+	local newmobile =3D KNUTMERGETEMP_CREATE_EMPTY_OBJECT(serial)
+	gMobiles[serial] =3D newmobile
+	return newmobile
+end
+function KNUTMERGETEMP_CREATE_EMPTY_ITEM	(serial) return KNUTMERGETEMP_CRE=
ATE_EMPTY_OBJECT(serial) end
+function KNUTMERGETEMP_DEL_MOBILE	(serial) gObjectList[serial] =3D nil gMo=
biles[serial] =3D nil end  -- todo : clean me..., remove from central objec=
t list
 =

 function DestroyDynamicItemBySerial (serial) =

-	local dynamic =3D gDynamics[serial]
+	local dynamic =3D GetDynamic(serial)
 	if (dynamic) then
 		gCurrentRenderer:RemoveDynamicItem( dynamic )
 		gDynamics[dynamic.serial] =3D nil
@@ -42,11 +61,78 @@
 	CancelUODragDrop()
 	for serial,v in pairs(gContainer) do 			CloseContainer(serial) end
 	for serial,v in pairs(gMobileItemsBySerial) do 	DestroyMobileItemBySerial=
(serial) end
-	for serial,v in pairs(gMobiles) do 				DestroyMobileBySerial(serial) end
-	for serial,v in pairs(gDynamics) do 			DestroyDynamicItemBySerial(serial)=
 end
+	for serial,v in pairs(GetMobileList()) do 		DestroyMobileBySerial(serial)=
 end
+	for serial,v in pairs(GetDynamicList()) do 		DestroyDynamicItemBySerial(s=
erial) end
 	for serial,v in pairs(gPaperdolls) do 			DestroyPaperdollByMobileSerial(s=
erial) end
 	-- TODO : gCurrentRenderer:DestroyMousePickItemBySerial(serial)
 	-- TODO : DestroyDragDropItemBySerial ?? done by CancelUODragDrop
 end
 =

 =

+-- called from kPacket_Naked_MOB and kPacket_Equipped_MOB
+function CreateOrUpdateMobile (mobiledata,equipmentdata)
+	local mobile =3D GetMobile(mobiledata.serial)
+	if (not mobile) then mobile =3D KNUTMERGETEMP_CREATE_EMPTY_MOBILE(mobiled=
ata.serial) end
+	=

+	for k,v in pairs(mobiledata) do mobile[k] =3D v end
+	-- mobile.serial		=

+	-- mobile.artid		=

+	-- mobile.xloc			=

+	-- mobile.yloc 		=

+	-- mobile.zloc			=

+	-- mobile.dir			=

+	-- mobile.hue			=

+	-- mobile.flag			=

+	-- mobile.notoriety	=

+	-- mobile.amount	-- only kPacket_Equipped_MOB, corpse related
+	-- mobile.dir2		-- only kPacket_Equipped_MOB, unknown
+	=

+	mobile.ismobile =3D true -- needed to identify the mobile in 2d renderer =
-- TODO : is this obsolete since knut ?
+	=

+	-- request basic stats info
+	Send_ClientQuery(gRequest_States,mobile.serial)
+	=

+	if (equipmentdata) then
+		mobile.equipment =3D {} -- todo : KILL old equipment items ???
+
+		=

+		for layer,itemdata in pairs(equipmentdata) do
+			local item =3D KNUTMERGETEMP_CREATE_EMPTY_ITEM(itemdata.serial) -- dyna=
mic ? =

+			for k,v in pairs(itemdata) do item[k] =3D v end
+			item.mobile =3D mobile
+			item.mobile_serial =3D mobile.serial
+			-- item.serial
+			-- item.artid
+			-- item.layer
+			-- item.hue
+			mobile.equipment[item.layer] =3D item
+			gMobileItemsBySerial[item.serial] =3D item -- TODO : obsolete ??
+		end
+		-- OBSOLETE : if (equipcount &gt; 2) then gMobileWithPaperdoll =3D mobile e=
nd
+	end
+	=

+	UpdateMobile(mobile)
+	if (equipmentdata) then UpdateMobileEquipment(mobile) end
+end
+
+function DestroyMobileBySerial (serial) =

+	local mobile =3D GetMobile(serial)
+	if (not mobile) then return end
+	=

+	CloseStatus(mobile)
+
+	-- clean up equipment
+	if (mobile.equipment) then for k,item in pairs(mobile.equipment) do
+		DestroyMobileItem(item)
+	end end
+	=

+	gCurrentRenderer:RemoveMobile( mobile )
+	=

+	KNUTMERGETEMP_DEL_MOBILE(serial)
+
+	-- destroy Status Gump from NPC
+	CloseStatus(mobile)
+	=

+	mobile.serial =3D nil
+	=

+end

Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Sun Aug 12 17:47:06 2007
@@ -2,8 +2,6 @@
 -- see also net.paperdoll.lua
 -- see also net.skill.lua
 =

-gMobiles =3D {}
-gMobileItemsBySerial =3D {} -- items equipped on mobiles
 gHudNamesFontSize =3D 12
 			=

 -- request the tooltipp for the mobile, e.g. the name
@@ -52,27 +50,6 @@
 	return 0.5,0.5,0.5
 end
  =

-function DestroyMobileBySerial (serial) =

-	local mobile =3D gMobiles[serial]
-	if (not mobile) then return end
-	=

-	CloseStatus(mobile)
-
-	-- clean up equipment
-	if (mobile.equipment) then for k,item in pairs(mobile.equipment) do
-		DestroyMobileItem(item)
-	end end
-	=

-	gCurrentRenderer:RemoveMobile( mobile )
-	=

-	gMobiles[serial] =3D nil
-
-	-- destroy Status Gump from NPC
-	CloseStatus(mobile)
-	=

-	mobile.serial =3D nil
-	=

-end
 =

 -- note : modifying existing elements and removing from a lua table while =
iterating is save, only inserting is dangerous
 function DestroyMobileItemBySerial (serial) =

@@ -150,7 +127,7 @@
 	g =3D g or 0
 	b =3D b or 0
 =

-	local mobile =3D gMobiles[serial]
+	local mobile =3D GetMobile(serial)
 	=

 	printdebug(&quot;mobile&quot;,&quot;TEXT MobileDisplayTextOverHead&quot;,serial,message,color)
 	=



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000153.html">[Iris-commit] [IRIS] r1337 - in /trunk/data/lua: gui/gui.container.lua gui/gui.status.lua net.walk.lua net/net.packethandlers.lua
</A></li>
	<LI>Next message: <A HREF="000155.html">[Iris-commit] [IRIS] r1339 - in /branches/knut/data/lua: gui/gui.paperdoll.lua gui/gui.status.lua net.other.lua net.walk.lua net/net.mobile.lua net/net.multi.lua obj/obj.main.lua obj/obj.mobile.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#154">[ date ]</a>
              <a href="thread.html#154">[ thread ]</a>
              <a href="subject.html#154">[ subject ]</a>
              <a href="author.html#154">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
