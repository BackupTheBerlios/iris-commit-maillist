<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1362 - in /trunk/data/lua: lib.util.lua net.login.lua net/net.dynamic.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1362%20-%20in%20/trunk/data/lua%3A%20lib.util.lua%0A%20net.login.lua%20net/net.dynamic.lua%20net/net.mobile.lua%20obj/obj.dynamic.lua%0A%20obj/obj.main.lua%20obj/obj.mobile.lua%20obj/obj.player.lua&In-Reply-To=%3C20070825193206.DA2371524002%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000176.html">
   <LINK REL="Next"  HREF="000179.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1362 - in /trunk/data/lua: lib.util.lua net.login.lua net/net.dynamic.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1362%20-%20in%20/trunk/data/lua%3A%20lib.util.lua%0A%20net.login.lua%20net/net.dynamic.lua%20net/net.mobile.lua%20obj/obj.dynamic.lua%0A%20obj/obj.main.lua%20obj/obj.mobile.lua%20obj/obj.player.lua&In-Reply-To=%3C20070825193206.DA2371524002%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1362 - in /trunk/data/lua: lib.util.lua net.login.lua net/net.dynamic.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Sat Aug 25 21:32:06 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000176.html">[Iris-commit] [IRIS] r1361 - in /branches/knut/data/lua: lib.util.lua net.login.lua net/net.dynamic.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
</A></li>
        <LI>Next message: <A HREF="000179.html">[Iris-commit] [IRIS] r1363 - in /trunk/data/lua: ./ net/ obj/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#177">[ date ]</a>
              <a href="thread.html#177">[ thread ]</a>
              <a href="subject.html#177">[ subject ]</a>
              <a href="author.html#177">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Sat Aug 25 21:32:06 2007
New Revision: 1362

Log:
syncing for merge

Modified:
    trunk/data/lua/lib.util.lua
    trunk/data/lua/net.login.lua
    trunk/data/lua/net/net.dynamic.lua
    trunk/data/lua/net/net.mobile.lua
    trunk/data/lua/obj/obj.dynamic.lua
    trunk/data/lua/obj/obj.main.lua
    trunk/data/lua/obj/obj.mobile.lua
    trunk/data/lua/obj/obj.player.lua

Modified: trunk/data/lua/lib.util.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.util.lua (original)
+++ trunk/data/lua/lib.util.lua Sat Aug 25 21:32:06 2007
@@ -327,7 +327,7 @@
 				aw * bz + az * bw + ax * by - ay * bx
 	end
 	=

-	-- returns qw,qx,qy,qz  , input comma seperated list &quot;x:90,y:90,z:30&quot; =

+	-- returns qw,qx,qy,qz  , input comma seperated list QuaternionFromString=
(&quot;x:90,y:90,z:30&quot;)
 	function QuaternionFromString (txt) =

 		local qw,qx,qy,qz =3D Quaternion.identity()
 		local arr =3D strsplit(&quot;,&quot;,txt)

Modified: trunk/data/lua/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.login.lua (original)
+++ trunk/data/lua/net.login.lua Sat Aug 25 21:32:06 2007
@@ -178,7 +178,7 @@
 	packet =3D {}
 	packet.serial	=3D input:PopNetUint32()
 	packet.unknown1 =3D input:PopNetUint32()
-	packet.body	=3D input:PopNetUint16()
+	packet.artid	=3D input:PopNetUint16()
 	packet.xloc	=3D input:PopNetUint16()
 	packet.yloc	=3D input:PopNetUint16()
 	packet.unknown0 =3D input:PopNetUint8()
@@ -210,7 +210,9 @@
 	Send_UnknownCommand()
 	Send_UnknownSE()
 	=

-	NotifyLoginConfirm(packet)
+	-- TODO : HintStartPosition(packet.xloc, packet.yloc, packet.zloc) hint f=
or campos ?
+	UpdatePlayerBodySerial(packet.serial)
+	CreateOrUpdateMobile(packet)
 end
 =

 -- if packet is received we can Start the Game now !

Modified: trunk/data/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.dynamic.lua (original)
+++ trunk/data/lua/net/net.dynamic.lua Sat Aug 25 21:32:06 2007
@@ -95,7 +95,7 @@
 =

 	ApplyArtidStackManipulation(newitem)
 	=

-	CreateOrUpdateItem(newitem)
+	CreateOrUpdateDynamic(newitem)
 end
 =

 -- AddItemToContainer (0x3C)

Modified: trunk/data/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.mobile.lua (original)
+++ trunk/data/lua/net/net.mobile.lua Sat Aug 25 21:32:06 2007
@@ -94,7 +94,7 @@
 	mobiledata.dir 					=3D input:PopNetUint8()
 	mobiledata.zloc 				=3D input:PopInt8()
 	=

-	MobileNotifyTeleport(mobiledata)
+	NotifyTeleport(mobiledata)
 end
 =

 -- Character Animation (0x6e)

Modified: trunk/data/lua/obj/obj.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.dynamic.lua (original)
+++ trunk/data/lua/obj/obj.dynamic.lua Sat Aug 25 21:32:06 2007
@@ -1,4 +1,128 @@
--- empty so far, will be filled on knut merge
+-- handles dynamic items (lamps,doors,inventory,...)
+
+-- called from kPacket_Show_Item
+function CreateOrUpdateDynamic	(newitem)
+	-- TODO : if (newitem.artid &gt;=3D gMulti_ID +100) .. model is multi
+	-- gMulti_ID =3D hex2num(&quot;0x4000&quot;)
+	-- TODO : check newitem.artid for boat
+	=

+	if (gTileTypeLoader) then
+		local miFlags,miWeight,miQuality,miUnknown,miUnknown1,miQuantity,miAnimI=
D,miUnknown2,miHue,miUnknown3,miHeight,msName =3D gTileTypeLoader:GetStatic=
TileType(newitem.artid+32*512) -- add 0x00004000
+		newitem.z_typename =3D msName
+	end
+	=

+	printdebug(&quot;mobile&quot;,&quot;ShowItem &quot;..vardump(newitem))
+	=

+	newitem.isdynamic =3D true -- needed to identify the dynamic in 2d render=
er
+	=

+	local bCreateNew =3D true
+	=

+	local olditem =3D GetDynamic(newitem.serial)
+	if (olditem) then
+		-- if only the position changed we can just update the old one
+		if (	newitem.artid =3D=3D olditem.artid and =

+				newitem.amount =3D=3D olditem.amount and =

+				newitem.flag =3D=3D olditem.flag and =

+				newitem.hue =3D=3D olditem.hue and =

+				newitem.dir =3D=3D olditem.dir and =

+				newitem.artid_addstack =3D=3D olditem.artid_addstack ) then
+			-- update old item
+			bCreateNew =3D false
+			olditem.xloc =3D newitem.xloc
+			olditem.yloc =3D newitem.yloc
+			olditem.zloc =3D newitem.zloc
+			newitem =3D olditem
+		else
+			gCurrentRenderer:RemoveDynamicItem( olditem )
+		end
+	end
+	=

+	if (bCreateNew) then gCurrentRenderer:AddDynamicItem( newitem ) end
+	=

+	gCurrentRenderer:UpdateDynamicItemPos(newitem)
+	gDynamics[newitem.serial] =3D newitem	=

+	gObjectList[newitem.serial] =3D newitem	 -- TODO : fix this like in mobile
+end
+
+
+-- called from kPacket_Object_to_Object
+function ContainerObjectToObject	(item)
+	ApplyArtidStackManipulation(item)
+	RefreshContainerItem(item)
+end
+
+-- called from kPacket_Container_Contents
+function ContainerSetContentItem	(item)
+	ApplyArtidStackManipulation(item)
+	RefreshContainerItem(item)
+	--printf(&quot;container=3D0x%08x item.serial=3D0x%08x artid=3D0x%04x artid_st=
ack=3D%i item.amount=3D%d\n&quot;,item.iContainerSerial,item.serial,item.artid,i=
tem.artid_addstack,item.amount)
+	--AddFadeLines(sprintf(&quot;kPacket_Container_Contents type=3D%s&quot;,GetStaticTi=
leTypeName(item.artid)))
+end
+
+-- called from kPacket_Equip_Item
+function ContainerEquipItem(item,container_serial)
+	--print(&quot;NET : Equip_Item&quot;,vardump(item))
+	=

+	item.mobile_serial =3D container_serial
+	local mobile =3D GetMobile(item.mobile_serial)
+	if (mobile) then
+		item.mobile =3D mobile
+		if (mobile.equipment[item.layer]) then
+			DestroyMobileItem(mobile.equipment[item.layer])
+		end
+		mobile.equipment[item.layer] =3D item
+		gMobileItemsBySerial[item.serial] =3D item
+		--printf(&quot;NET : kPacket_Equip_Item mobile=3D0x%08x item=3D0x%08x\n&quot;,item=
.mobile_serial,item.serial)
+		UpdateMobileEquipment(mobile)
+	else =

+		print(&quot;WARNING ! mobile update for unknown mobile received, update lost =
!&quot;)
+
+		-- don't crash on UOX3, Lonewolf (this servers sends unknown Equip messa=
ges)
+		if ((gServerType[gServerEmulator] ~=3D &quot;Lonewolf&quot;) and (gServerType[gSer=
verEmulator] ~=3D &quot;SpherePolUox3&quot;)) then
+			print(&quot;Crash Client here!&quot;..gServerType[gServerEmulator])
+			Crash()
+		end
+
+		-- the client state would loose sync with server, this is fatal, =

+		-- but should never happen for correct server implementation ? (there ar=
e strange servers however...)
+		-- an alternative would be to create the mobile if unknown , something l=
ike GetOrCreateMobile like in net.container.lua
+	end
+end
+
+-- called from kPacket_Open_Container
+function IsContainerAlreadyOpen (containerserial) =

+	local container =3D GetOrCreateContainer(containerdata.serial)
+	return container.dialog ~=3D nil
+end
+
+
+-- called from kPacket_Open_Container
+function HandleOpenContainer	(containerdata)
+
+	local container =3D GetOrCreateContainer(containerdata.serial)
+	container.gumpid =3D containerdata.gumpid
+	=

+	-- 0x003c =3D backpack
+	-- 0x0030 =3D shopcontainer
+	--AddFadeLines(sprintf(&quot;Open_Container gumpid=3D%d&quot;,container.gumpid))
+	if (not container.dialog) then
+		-- create dialog from scratch
+		local dialog =3D guimaker.MakeSortedDialog()
+		container.dialog =3D dialog
+		dialog.uoContainer =3D container
+		dialog.rootwidget.gfx:SetPos(200,100) -- TODO : choose position
+		dialog.backpane =3D MakeBorderGumpPart(dialog.rootwidget,container.gumpi=
d,0,0)
+		dialog.backpane.mbIgnoreMouseOver =3D false
+		dialog.backpane.onMouseDown =3D function (widget,mousebutton)
+										if (mousebutton =3D=3D 2) then CloseContainer(widget.dialog.uoCo=
ntainer.serial) end
+										if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.=
StartMoveDialog(widget.dialog.rootwidget) end
+									  end
+	end
+	RefreshContainerItemWidgets(container)
+
+	SecureTradeRebuildContainerHook(container)
+end
+
 =

 =

 -- TODO : Add sepearate FILTER : for several Clientside GFX manipulation (=
Game Pieces &amp; Gold,Silver,...)

Modified: trunk/data/lua/obj/obj.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.main.lua (original)
+++ trunk/data/lua/obj/obj.main.lua Sat Aug 25 21:32:06 2007
@@ -69,369 +69,3 @@
 end
 =

 =

-function DestroyMobileBySerial (serial) =

-	local mobile =3D GetMobile(serial)
-	if (not mobile) then return end
-	=

-	CloseStatus(mobile)
-
-	-- clean up equipment
-	if (mobile.equipment) then for k,item in pairs(mobile.equipment) do
-		DestroyMobileItem(item)
-	end end
-	=

-	gCurrentRenderer:RemoveMobile( mobile )
-	=

-	KNUTMERGETEMP_DEL_MOBILE(serial)
-
-	-- destroy Status Gump from NPC
-	CloseStatus(mobile)
-	=

-	mobile.serial =3D nil
-end
-
--- called from kPacket_Naked_MOB kPacket_Equipped_MOB kPacket_Teleport
-function CreateOrUpdateMobile (mobiledata,equipmentdata)
-	local mobile =3D GetMobile(mobiledata.serial)
-	if (not mobile) then mobile =3D KNUTMERGETEMP_CREATE_EMPTY_MOBILE(mobiled=
ata.serial) end
-	=

-	for k,v in pairs(mobiledata) do mobile[k] =3D v end
-	-- mobile.serial		=

-	-- mobile.artid		=

-	-- mobile.xloc			=

-	-- mobile.yloc 		=

-	-- mobile.zloc			=

-	-- mobile.dir			=

-	-- mobile.hue			=

-	-- mobile.flag			=

-	-- mobile.notoriety	=

-	-- mobile.amount	-- only kPacket_Equipped_MOB, corpse related ?
-	-- mobile.dir2		-- only kPacket_Equipped_MOB, unknown
-	=

-	mobile.ismobile =3D true -- needed to identify the mobile in 2d renderer =
-- TODO : is this obsolete since knut ?
-	=

-	-- request basic stats info
-	Send_ClientQuery(gRequest_States,mobile.serial)
-	=

-	if (equipmentdata) then
-		mobile.equipment =3D {} -- todo : KILL old equipment items ???
-
-		=

-		for layer,itemdata in pairs(equipmentdata) do
-			local item =3D KNUTMERGETEMP_CREATE_EMPTY_ITEM(itemdata.serial) -- dyna=
mic ? =

-			=

-			for k,v in pairs(itemdata) do item[k] =3D v end
-			-- item.serial
-			-- item.artid
-			-- item.layer
-			-- item.hue
-			=

-			item.mobile =3D mobile
-			item.mobile_serial =3D mobile.serial
-			mobile.equipment[item.layer] =3D item
-			gMobileItemsBySerial[item.serial] =3D item -- TODO : obsoleted by knut =
merge ??
-		end
-	end
-	=

-	UpdateMobile(mobile)
-	if (equipmentdata) then UpdateMobileEquipment(mobile) end
-	return mobile
-end
-
-
--- called from kPacket_Teleport
-function MobileNotifyTeleport	(mobiledata)
-	--mobiledata.serial				=

-	--mobiledata.artid				=

-	--mobiledata.teleport_unknown1 	=

-	--mobiledata.hue 					=

-	--mobiledata.flag 				=

-	--mobiledata.xloc 				=

-	--mobiledata.yloc 				=

-	--mobiledata.teleport_unknown2	=

-	--mobiledata.dir 					=

-	--mobiledata.zloc
-	-- TODO : knutmerge ??  : local mobile =3D CreateOrUpdateMobile(mobiledat=
a)	=

-	=

-	local bPlayerRunning =3D BitwiseAND(mobiledata.dir,kWalkFlag_Run) ~=3D 0
-	local fullplayerdir =3D mobiledata.dir
-	mobiledata.dir =3D BitwiseAND(mobiledata.dir,hex2num(&quot;0x07&quot;))
-	=

-	gLastResyncRequest =3D nil
-	--ResetWalkQueue()
-	=

-	gCurrentRenderer:ClientSideMobileAnimPlayerTeleported()
-
-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player (Pos before Teleport) XLoc: =
%i YLoc: %i ZLoc: %i Dir: [%s]\n&quot;,
-			gPlayerXLoc or 0, gPlayerYLoc or 0, gPlayerZLoc or 0, gDirection[gPlaye=
rDir or 0] or &quot;&quot;))
-	=

-	-- TODO : (Check if char is in Boat!)
-
-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player: mobiledata.serial: %i body:=
 %i XLoc: %i YLoc: %i ZLoc: %i Dir: 0x%02x [%s]\n&quot;,
-			mobiledata.serial, mobiledata.artid, mobiledata.xloc, mobiledata.yloc, =
mobiledata.zloc, fullplayerdir, gDirection[mobiledata.dir] or &quot;&quot;))
-
-	-- Check if Player is already on Teleported Pos
-	if (gPlayerXLoc ~=3D mobiledata.xloc or gPlayerYLoc ~=3D mobiledata.yloc =
or
-		gPlayerZLoc ~=3D mobiledata.zloc or gPlayerDir ~=3D mobiledata.dir) then
-		SetPlayerPos(mobiledata.xloc,mobiledata.yloc,mobiledata.zloc,fullplayerd=
ir)
-		print(&quot;Player is teleported.&quot;)
-	else
-		print(&quot;Player not teleported, because already on the same pos+dir!&quot;)
-	end
-
-	UpdatePlayerBodySerial(mobiledata.serial)
-	local playerMobile=3DGetPlayerMobile()
-	if (playerMobile) then
-		if (playerMobile.artid ~=3D mobiledata.artid) then
-			print(&quot;Change PC Bodytype=3D&quot;..mobiledata.artid)
-			playerMobile.artid=3Dmobiledata.artid
-
-			-- currently only for human (not elfs)
-			if ( (playerMobile.artid=3D=3D402) or (playerMobile.artid=3D=3D403) or
-				 (playerMobile.artid=3D=3D607) or (playerMobile.artid=3D=3D608) or
-				 (playerMobile.artid=3D=3D970)) then
-				print(&quot;TODO : pc character is now ghost. new bodymodel=3D&quot;..mobiledata=
.artid)
-			end
-
-			gCurrentRenderer:UpdateMobile( playerMobile )
-		end
-	end
-
-	ResetWalkQueue() -- todo : (here or only if setplayerpos is done?)
-end
-
-function MobileStartServerSideAnim (animdata)
-	gCurrentRenderer:MobileStartServerSideAnim(animdata)
-end
-
-function MobileUpdateStats (mobileserial,stats)
-	local mobile =3D GetMobile(mobileserial)
-	-- Update Mobile
-	if (mobile) then
-		-- local oldhp =3D mobile.stats.curHits or stats.curHits
-		mobile.name =3D stats.name
-		mobile.stats =3D stats
-		-- not needed due to normal damage packet
-		-- TODO is this ok for every server?
-		-- gCurrentRenderer:NotifyHPChange(mobileserial, oldhp, mobile.stats.cur=
Hits)
-		UpdateMobile(mobile)
-	end
-	=

-	TradeUpdatePlayerGold()
-end
-
-function MobileUpdateHealth (mobileserial,curvalue,maxvalue)
-	local mobile =3D GetMobile(mobileserial)
-	-- TODO pol sends normal hp update and x/1000 hp update ???? so i ignore =
the strange one
-	if (mobile and (maxvalue ~=3D 1000) and mobile.stats) then
-		if mobile.stats.curHits then
-			-- if there was a change, plop a text
-			local old =3D mobile.stats.curHits
-			gCurrentRenderer:NotifyHPChange(mobileserial, old, curvalue)
-		end
-		-- update values
-		mobile.stats.curHits =3D curvalue
-		mobile.stats.maxHits =3D maxvalue
-
-		UpdateMobile(mobile)
-	end
-end
-
-function MobileUpdateMana (mobileserial,curvalue,maxvalue)
-	local mobile =3D GetMobile(mobileserial)
-	if (mobile and mobile.stats) then
-		-- update values
-		mobile.stats.curMana =3D curvalue
-		mobile.stats.maxMana =3D maxvalue
-
-		if (mobileserial =3D=3D gPlayerBodySerial) then
-			gui.SetMana(curvalue/maxvalue)
-			-- update big_stats window
-			UpdateStatusAos()
-		end
-	end
-end
-
-function MobileUpdateStamina(mobileserial,curvalue,maxvalue)
-	local mobile =3D GetMobile(mobileserial)
-	if (mobile and mobile.stats) then
-		-- update values
-		mobile.stats.curStamina =3D curvalue
-		mobile.stats.maxStamina =3D maxvalue
-
-		if (mobileserial =3D=3D gPlayerBodySerial) then
-			gui.SetStamina(curvalue/maxvalue)
-			-- update big_stats window
-			UpdateStatusAos()
-		end
-	end
-end
-
--- called from kPacket_Object_to_Object
-function ContainerObjectToObject	(item)
-	ApplyArtidStackManipulation(item)
-	RefreshContainerItem(item)
-end
-
--- called from kPacket_Container_Contents
-function ContainerSetContentItem	(item)
-	ApplyArtidStackManipulation(item)
-	RefreshContainerItem(item)
-	--printf(&quot;container=3D0x%08x item.serial=3D0x%08x artid=3D0x%04x artid_st=
ack=3D%i item.amount=3D%d\n&quot;,item.iContainerSerial,item.serial,item.artid,i=
tem.artid_addstack,item.amount)
-	--AddFadeLines(sprintf(&quot;kPacket_Container_Contents type=3D%s&quot;,GetStaticTi=
leTypeName(item.artid)))
-end
-
--- called from kPacket_Equip_Item
-function ContainerEquipItem(item,container_serial)
-	--print(&quot;NET : Equip_Item&quot;,vardump(item))
-	=

-	item.mobile_serial =3D container_serial
-	local mobile =3D GetMobile(item.mobile_serial)
-	if (mobile) then
-		item.mobile =3D mobile
-		if (mobile.equipment[item.layer]) then
-			DestroyMobileItem(mobile.equipment[item.layer])
-		end
-		mobile.equipment[item.layer] =3D item
-		gMobileItemsBySerial[item.serial] =3D item
-		--printf(&quot;NET : kPacket_Equip_Item mobile=3D0x%08x item=3D0x%08x\n&quot;,item=
.mobile_serial,item.serial)
-		UpdateMobileEquipment(mobile)
-	else =

-		print(&quot;WARNING ! mobile update for unknown mobile received, update lost =
!&quot;)
-
-		-- don't crash on UOX3, Lonewolf (this servers sends unknown Equip messa=
ges)
-		if ((gServerType[gServerEmulator] ~=3D &quot;Lonewolf&quot;) and (gServerType[gSer=
verEmulator] ~=3D &quot;SpherePolUox3&quot;)) then
-			print(&quot;Crash Client here!&quot;..gServerType[gServerEmulator])
-			Crash()
-		end
-
-		-- the client state would loose sync with server, this is fatal, =

-		-- but should never happen for correct server implementation ? (there ar=
e strange servers however...)
-		-- an alternative would be to create the mobile if unknown , something l=
ike GetOrCreateMobile like in net.container.lua
-	end
-end
-
--- called from kPacket_Show_Item
-function CreateOrUpdateItem	(newitem)
-	-- TODO : if (newitem.artid &gt;=3D gMulti_ID +100) .. model is multi
-	-- gMulti_ID =3D hex2num(&quot;0x4000&quot;)
-	-- TODO : check newitem.artid for boat
-	=

-	if (gTileTypeLoader) then
-		local miFlags,miWeight,miQuality,miUnknown,miUnknown1,miQuantity,miAnimI=
D,miUnknown2,miHue,miUnknown3,miHeight,msName =3D gTileTypeLoader:GetStatic=
TileType(newitem.artid+32*512) -- add 0x00004000
-		newitem.z_typename =3D msName
-	end
-	=

-	printdebug(&quot;mobile&quot;,&quot;ShowItem &quot;..vardump(newitem))
-	=

-	newitem.isdynamic =3D true -- needed to identify the dynamic in 2d render=
er
-	=

-	local bCreateNew =3D true
-	=

-	local olditem =3D GetDynamic(newitem.serial)
-	if (olditem) then
-		-- if only the position changed we can just update the old one
-		if (	newitem.artid =3D=3D olditem.artid and =

-				newitem.amount =3D=3D olditem.amount and =

-				newitem.flag =3D=3D olditem.flag and =

-				newitem.hue =3D=3D olditem.hue and =

-				newitem.dir =3D=3D olditem.dir and =

-				newitem.artid_addstack =3D=3D olditem.artid_addstack ) then
-			-- update old item
-			bCreateNew =3D false
-			olditem.xloc =3D newitem.xloc
-			olditem.yloc =3D newitem.yloc
-			olditem.zloc =3D newitem.zloc
-			newitem =3D olditem
-		else
-			gCurrentRenderer:RemoveDynamicItem( olditem )
-		end
-	end
-	=

-	if (bCreateNew) then gCurrentRenderer:AddDynamicItem( newitem ) end
-	=

-	gCurrentRenderer:UpdateDynamicItemPos(newitem)
-	gDynamics[newitem.serial] =3D newitem	=

-	gObjectList[newitem.serial] =3D newitem	 -- TODO : fix this like in mobile
-end
-
--- TODO : move to obj.player.lua ?
--- called from kPacket_SetPlayerWarmode
-function NotifyWarmode	(flag)
-	if (flag =3D=3D gWarmode_Normal) then
-		gActWarmode=3DgWarmode_Normal
-		AddFadeLines(&quot;Be the peace with you!&quot;)
-		--printf(&quot;NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: normal\n&quot;,i=
d)
-	end
-	if (flag =3D=3D gWarmode_Combat) then
-		gActWarmode=3DgWarmode_Combat
-		AddFadeLines(&quot;You go into War!&quot;)
-		--printf(&quot;NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: combat\n&quot;,i=
d)
-	end
-	gui.SetWarmode(gActWarmode)
-end
-
--- called from kPacket_Open_Paperdoll
-function HandleOpenPaperdoll	(paperdoll)
-	paperdoll.mobileserial	=3D paperdoll.serial
-	paperdoll.Close =3D ClosePaperdoll
-	=

-	-- close old paperdoll
-	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
-	if (oldpaperdoll) then oldpaperdoll:Close() end =

-	=

-	-- register paperdoll
-	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
-	=

-	--AddFadeLines(&quot;Open Paperdoll for [&quot;..(paperdoll.mobileserial)..&quot;] &quot;..(p=
aperdoll.name or &quot;&quot;))
-	=

-	RebuildPaperdoll(paperdoll)
-end
-
--- called from kPacket_Open_Container
-function IsContainerAlreadyOpen (containerserial) =

-	local container =3D GetOrCreateContainer(containerdata.serial)
-	return container.dialog ~=3D nil
-end
-
-
--- called from kPacket_Open_Container
-function HandleOpenContainer	(containerdata)
-
-	local container =3D GetOrCreateContainer(containerdata.serial)
-	container.gumpid =3D containerdata.gumpid
-	=

-	-- 0x003c =3D backpack
-	-- 0x0030 =3D shopcontainer
-	--AddFadeLines(sprintf(&quot;Open_Container gumpid=3D%d&quot;,container.gumpid))
-	if (not container.dialog) then
-		-- create dialog from scratch
-		local dialog =3D guimaker.MakeSortedDialog()
-		container.dialog =3D dialog
-		dialog.uoContainer =3D container
-		dialog.rootwidget.gfx:SetPos(200,100) -- TODO : choose position
-		dialog.backpane =3D MakeBorderGumpPart(dialog.rootwidget,container.gumpi=
d,0,0)
-		dialog.backpane.mbIgnoreMouseOver =3D false
-		dialog.backpane.onMouseDown =3D function (widget,mousebutton)
-										if (mousebutton =3D=3D 2) then CloseContainer(widget.dialog.uoCo=
ntainer.serial) end
-										if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.=
StartMoveDialog(widget.dialog.rootwidget) end
-									  end
-	end
-	RefreshContainerItemWidgets(container)
-
-	SecureTradeRebuildContainerHook(container)
-end
-
--- kPacket_Login_Confirm
-function NotifyLoginConfirm	(packet)
-	local bodytype =3D packet.body
-	local playerid =3D packet.serial
-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Login_Confirm CharacterID: 0x%08x Bodyty=
pe: %i x: %i y: %i z: %i flag=3D0x%02x\n&quot;, playerid, bodytype, packet.xloc,=
 packet.yloc, packet.zloc, packet.flag))
-
-	-- TODO : HintStartPosition(x_location,y_location,z_location) ?
-	-- this is just a hint that might be used to position the cam	=

-	=

-	UpdatePlayerBodySerial(playerid)
-	local playerMobile =3D GetPlayerMobile()
-	if (playerMobile) then playerMobile.artid =3D packet.body end
-end

Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Sat Aug 25 21:32:06 2007
@@ -3,6 +3,163 @@
 -- see also net.skill.lua
 =

 gHudNamesFontSize =3D 12
+
+
+function DestroyMobileBySerial (serial) =

+	local mobile =3D GetMobile(serial)
+	if (not mobile) then return end
+	=

+	CloseStatus(mobile)
+
+	-- clean up equipment
+	if (mobile.equipment) then for k,item in pairs(mobile.equipment) do
+		DestroyMobileItem(item)
+	end end
+	=

+	gCurrentRenderer:RemoveMobile( mobile )
+	=

+	KNUTMERGETEMP_DEL_MOBILE(serial)
+
+	-- destroy Status Gump from NPC
+	CloseStatus(mobile)
+	=

+	mobile.serial =3D nil
+end
+
+-- called from kPacket_Naked_MOB kPacket_Equipped_MOB kPacket_Teleport
+function CreateOrUpdateMobile (mobiledata,equipmentdata)
+	local mobile =3D GetMobile(mobiledata.serial)
+	if (not mobile) then mobile =3D KNUTMERGETEMP_CREATE_EMPTY_MOBILE(mobiled=
ata.serial) end
+	=

+	for k,v in pairs(mobiledata) do mobile[k] =3D v end
+	-- mobile.serial		=

+	-- mobile.artid		=

+	-- mobile.xloc			=

+	-- mobile.yloc 		=

+	-- mobile.zloc			=

+	-- mobile.dir			=

+	-- mobile.hue			=

+	-- mobile.flag			=

+	-- mobile.notoriety	=

+	-- mobile.amount	-- only kPacket_Equipped_MOB, corpse related ?
+	-- mobile.dir2		-- only kPacket_Equipped_MOB, unknown
+	=

+	mobile.ismobile =3D true -- needed to identify the mobile in 2d renderer =
-- TODO : is this obsolete since knut ?
+	=

+	-- request basic stats info
+	Send_ClientQuery(gRequest_States,mobile.serial)
+	=

+	if (equipmentdata) then
+		mobile.equipment =3D {} -- todo : KILL old equipment items ???
+
+		=

+		for layer,itemdata in pairs(equipmentdata) do
+			local item =3D KNUTMERGETEMP_CREATE_EMPTY_ITEM(itemdata.serial) -- dyna=
mic ? =

+			=

+			for k,v in pairs(itemdata) do item[k] =3D v end
+			-- item.serial
+			-- item.artid
+			-- item.layer
+			-- item.hue
+			=

+			item.mobile =3D mobile
+			item.mobile_serial =3D mobile.serial
+			mobile.equipment[item.layer] =3D item
+			gMobileItemsBySerial[item.serial] =3D item -- TODO : obsoleted by knut =
merge ??
+		end
+	end
+	=

+	UpdateMobile(mobile)
+	if (equipmentdata) then UpdateMobileEquipment(mobile) end
+	return mobile
+end
+
+
+-- called from kPacket_Open_Paperdoll
+function HandleOpenPaperdoll	(paperdoll)
+	paperdoll.mobileserial	=3D paperdoll.serial
+	paperdoll.Close =3D ClosePaperdoll
+	=

+	-- close old paperdoll
+	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
+	if (oldpaperdoll) then oldpaperdoll:Close() end =

+	=

+	-- register paperdoll
+	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
+	=

+	--AddFadeLines(&quot;Open Paperdoll for [&quot;..(paperdoll.mobileserial)..&quot;] &quot;..(p=
aperdoll.name or &quot;&quot;))
+	=

+	RebuildPaperdoll(paperdoll)
+end
+
+
+function MobileStartServerSideAnim (animdata)
+	gCurrentRenderer:MobileStartServerSideAnim(animdata)
+end
+
+function MobileUpdateStats (mobileserial,stats)
+	local mobile =3D GetMobile(mobileserial)
+	-- Update Mobile
+	if (mobile) then
+		-- local oldhp =3D mobile.stats.curHits or stats.curHits
+		mobile.name =3D stats.name
+		mobile.stats =3D stats
+		-- not needed due to normal damage packet
+		-- TODO is this ok for every server?
+		-- gCurrentRenderer:NotifyHPChange(mobileserial, oldhp, mobile.stats.cur=
Hits)
+		UpdateMobile(mobile)
+	end
+	=

+	TradeUpdatePlayerGold()
+end
+
+function MobileUpdateHealth (mobileserial,curvalue,maxvalue)
+	local mobile =3D GetMobile(mobileserial)
+	-- TODO pol sends normal hp update and x/1000 hp update ???? so i ignore =
the strange one
+	if (mobile and (maxvalue ~=3D 1000) and mobile.stats) then
+		if mobile.stats.curHits then
+			-- if there was a change, plop a text
+			local old =3D mobile.stats.curHits
+			gCurrentRenderer:NotifyHPChange(mobileserial, old, curvalue)
+		end
+		-- update values
+		mobile.stats.curHits =3D curvalue
+		mobile.stats.maxHits =3D maxvalue
+
+		UpdateMobile(mobile)
+	end
+end
+
+function MobileUpdateMana (mobileserial,curvalue,maxvalue)
+	local mobile =3D GetMobile(mobileserial)
+	if (mobile and mobile.stats) then
+		-- update values
+		mobile.stats.curMana =3D curvalue
+		mobile.stats.maxMana =3D maxvalue
+
+		if (mobileserial =3D=3D gPlayerBodySerial) then
+			gui.SetMana(curvalue/maxvalue)
+			-- update big_stats window
+			UpdateStatusAos()
+		end
+	end
+end
+
+function MobileUpdateStamina(mobileserial,curvalue,maxvalue)
+	local mobile =3D GetMobile(mobileserial)
+	if (mobile and mobile.stats) then
+		-- update values
+		mobile.stats.curStamina =3D curvalue
+		mobile.stats.maxStamina =3D maxvalue
+
+		if (mobileserial =3D=3D gPlayerBodySerial) then
+			gui.SetStamina(curvalue/maxvalue)
+			-- update big_stats window
+			UpdateStatusAos()
+		end
+	end
+end
+
 			=

 -- request the tooltipp for the mobile, e.g. the name
 -- the uo protocol is a bit ugly here, we actually have to send a mousecli=
ck as request

Modified: trunk/data/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.player.lua (original)
+++ trunk/data/lua/obj/obj.player.lua Sat Aug 25 21:32:06 2007
@@ -12,19 +12,6 @@
 	return mobile and (mobile.serial =3D=3D gPlayerBodySerial)
 end
 =

-
--- called from handlers of kPacket_Login_Confirm and kPacket_Teleport
-function UpdatePlayerBodySerial (newserial)
-	if (gPlayerBodySerial ~=3D 0 and gPlayerBodySerial ~=3D newserial) then =

-		print(&quot;WARNING ! playerbody serial changed old,new=3D&quot;,gPlayerBodySerial=
,newserial)
-	end
-	gPlayerBodySerial =3D newserial
-	PlayerEquipmentUpdated()
-	=

-	-- TODO this seems a bit like the wrong place for this stuff
-	-- create player status dialog and stuff like this
-	GuiInit()
-end
 =

 -- adjust backpack art and maybe paperdoll ?
 -- called from kPacket_Equipped_MOB and UpdatePlayerBodySerial
@@ -65,7 +52,7 @@
 function GetPlayerBackPackItem ()
 	local res =3D nil
 	local playermobile =3D GetPlayerMobile()
-	if (playermobile) then res =3D playermobile.equipment[kLayer_Backpack] end
+	if (playermobile) then res =3D playermobile.equipment and playermobile.eq=
uipment[kLayer_Backpack] end
 	return res
 end
 =

@@ -84,3 +71,93 @@
 	end
 end
 =

+
+-- TODO : move to obj.player.lua ?
+-- called from kPacket_SetPlayerWarmode
+function NotifyWarmode	(flag)
+	if (flag =3D=3D gWarmode_Normal) then
+		gActWarmode=3DgWarmode_Normal
+		AddFadeLines(&quot;Be the peace with you!&quot;)
+		--printf(&quot;NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: normal\n&quot;,i=
d)
+	end
+	if (flag =3D=3D gWarmode_Combat) then
+		gActWarmode=3DgWarmode_Combat
+		AddFadeLines(&quot;You go into War!&quot;)
+		--printf(&quot;NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: combat\n&quot;,i=
d)
+	end
+	gui.SetWarmode(gActWarmode)
+end
+
+-- called from kPacket_Teleport
+function NotifyTeleport	(mobiledata)
+	--mobiledata.serial				=

+	--mobiledata.artid				=

+	--mobiledata.teleport_unknown1 	=

+	--mobiledata.hue 					=

+	--mobiledata.flag 				=

+	--mobiledata.xloc 				=

+	--mobiledata.yloc 				=

+	--mobiledata.teleport_unknown2	=

+	--mobiledata.dir 					=

+	--mobiledata.zloc
+	-- TODO : knutmerge ??  : local mobile =3D CreateOrUpdateMobile(mobiledat=
a)	=

+	=

+	local bPlayerRunning =3D BitwiseAND(mobiledata.dir,kWalkFlag_Run) ~=3D 0
+	local fullplayerdir =3D mobiledata.dir
+	mobiledata.dir =3D BitwiseAND(mobiledata.dir,hex2num(&quot;0x07&quot;))
+	=

+	gLastResyncRequest =3D nil
+	--ResetWalkQueue()
+	=

+	gCurrentRenderer:ClientSideMobileAnimPlayerTeleported()
+
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player (Pos before Teleport) XLoc: =
%i YLoc: %i ZLoc: %i Dir: [%s]\n&quot;,
+			gPlayerXLoc or 0, gPlayerYLoc or 0, gPlayerZLoc or 0, gDirection[gPlaye=
rDir or 0] or &quot;&quot;))
+	=

+	-- TODO : (Check if char is in Boat!)
+
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player: mobiledata.serial: %i body:=
 %i XLoc: %i YLoc: %i ZLoc: %i Dir: 0x%02x [%s]\n&quot;,
+			mobiledata.serial, mobiledata.artid, mobiledata.xloc, mobiledata.yloc, =
mobiledata.zloc, fullplayerdir, gDirection[mobiledata.dir] or &quot;&quot;))
+
+	-- Check if Player is already on Teleported Pos
+	if (gPlayerXLoc ~=3D mobiledata.xloc or gPlayerYLoc ~=3D mobiledata.yloc =
or
+		gPlayerZLoc ~=3D mobiledata.zloc or gPlayerDir ~=3D mobiledata.dir) then
+		SetPlayerPos(mobiledata.xloc,mobiledata.yloc,mobiledata.zloc,fullplayerd=
ir)
+		print(&quot;Player is teleported.&quot;)
+	else
+		print(&quot;Player not teleported, because already on the same pos+dir!&quot;)
+	end
+
+	UpdatePlayerBodySerial(mobiledata.serial)
+	local playerMobile=3DGetPlayerMobile()
+	if (playerMobile) then
+		if (playerMobile.artid ~=3D mobiledata.artid) then
+			print(&quot;Change PC Bodytype=3D&quot;..mobiledata.artid)
+			playerMobile.artid=3Dmobiledata.artid
+
+			-- currently only for human (not elfs)
+			if ( (playerMobile.artid=3D=3D402) or (playerMobile.artid=3D=3D403) or
+				 (playerMobile.artid=3D=3D607) or (playerMobile.artid=3D=3D608) or
+				 (playerMobile.artid=3D=3D970)) then
+				print(&quot;TODO : pc character is now ghost. new bodymodel=3D&quot;..mobiledata=
.artid)
+			end
+
+			gCurrentRenderer:UpdateMobile( playerMobile )
+		end
+	end
+
+	ResetWalkQueue() -- todo : (here or only if setplayerpos is done?)
+end
+
+-- called from handlers of kPacket_Login_Confirm and kPacket_Teleport
+function UpdatePlayerBodySerial (serial) =

+	if (gPlayerBodySerial ~=3D 0 and gPlayerBodySerial ~=3D serial) then =

+		print(&quot;WARNING ! playerbody serial changed old,new=3D&quot;,gPlayerBodySerial=
,serial)
+	end
+	gPlayerBodySerial =3D serial
+	PlayerEquipmentUpdated()
+	=

+	-- TODO this seems a bit like the wrong place for this stuff
+	-- create player status dialog and stuff like this
+	GuiInit()
+end


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000176.html">[Iris-commit] [IRIS] r1361 - in /branches/knut/data/lua: lib.util.lua net.login.lua net/net.dynamic.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
</A></li>
	<LI>Next message: <A HREF="000179.html">[Iris-commit] [IRIS] r1363 - in /trunk/data/lua: ./ net/ obj/
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#177">[ date ]</a>
              <a href="thread.html#177">[ thread ]</a>
              <a href="subject.html#177">[ subject ]</a>
              <a href="author.html#177">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
