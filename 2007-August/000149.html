<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1333 - in /trunk/data/lua: gui/gui.status.lua net.login.lua net.walk.lua net/net.dynamic.lua net/net.effect.lua net/net.mobile.lua net/net.packethandlers.lua obj/obj.mobile.lua obj/obj.player.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1333%20-%20in%20/trunk/data/lua%3A%20gui/gui.status.lua%0A%20net.login.lua%20net.walk.lua%20net/net.dynamic.lua%20net/net.effect.lua%0A%20net/net.mobile.lua%20net/net.packethandlers.lua%20obj/obj.mobile.lua%0A%20obj/obj.player.lua&In-Reply-To=%3C20070802174703.65E58B140B4%40localhost.localdomain%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000148.html">
   <LINK REL="Next"  HREF="000150.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1333 - in /trunk/data/lua: gui/gui.status.lua net.login.lua net.walk.lua net/net.dynamic.lua net/net.effect.lua net/net.mobile.lua net/net.packethandlers.lua obj/obj.mobile.lua obj/obj.player.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1333%20-%20in%20/trunk/data/lua%3A%20gui/gui.status.lua%0A%20net.login.lua%20net.walk.lua%20net/net.dynamic.lua%20net/net.effect.lua%0A%20net/net.mobile.lua%20net/net.packethandlers.lua%20obj/obj.mobile.lua%0A%20obj/obj.player.lua&In-Reply-To=%3C20070802174703.65E58B140B4%40localhost.localdomain%3E"
       TITLE="[Iris-commit] [IRIS] r1333 - in /trunk/data/lua: gui/gui.status.lua net.login.lua net.walk.lua net/net.dynamic.lua net/net.effect.lua net/net.mobile.lua net/net.packethandlers.lua obj/obj.mobile.lua obj/obj.player.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Thu Aug  2 19:47:03 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000148.html">[Iris-commit] [IRIS] r1332 - in /trunk/data/lua: main.lua	net/net.multi.lua
</A></li>
        <LI>Next message: <A HREF="000150.html">[Iris-commit] [IRIS] r1334 - in /branches/knut/data/lua: net.login.lua net.walk.lua net/net.dynamic.lua net/net.effect.lua net/net.mobile.lua net/net.object.lua net/net.packethandlers.lua obj/obj.mobile.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#149">[ date ]</a>
              <a href="thread.html#149">[ thread ]</a>
              <a href="subject.html#149">[ subject ]</a>
              <a href="author.html#149">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Thu Aug  2 19:47:02 2007
New Revision: 1333

Log:
syncing

Modified:
    trunk/data/lua/gui/gui.status.lua
    trunk/data/lua/net.login.lua
    trunk/data/lua/net.walk.lua
    trunk/data/lua/net/net.dynamic.lua
    trunk/data/lua/net/net.effect.lua
    trunk/data/lua/net/net.mobile.lua
    trunk/data/lua/net/net.packethandlers.lua
    trunk/data/lua/obj/obj.mobile.lua
    trunk/data/lua/obj/obj.player.lua

Modified: trunk/data/lua/gui/gui.status.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.status.lua (original)
+++ trunk/data/lua/gui/gui.status.lua Thu Aug  2 19:47:02 2007
@@ -38,22 +38,22 @@
 		end
 	=

 		--[[
-		stats.char_sex		=3D input:PopNetUint8() -- * 0x00 - Male     * 0x01 - Fe=
male
-		stats.char_gold		=3D input:PopNetUint32()
-		stats.char_armorC	=3D input:PopNetUint16() -- resistPhysical (old client=
s: AC).
-		stats.char_curWeight=3D input:PopNetUint16()
-		stats.char_maxWeight =3D input:PopNetUint16()
-		stats.char_race		 =3D input:PopNetUint8()
-		stats.char_statcap	=3D input:PopNetUint16()		-- The character's total al=
lowable sum of Strength, Intelligence, and Dexterity
-		stats.char_curPet	=3D input:PopNetUint8()			=

-		stats.char_maxPet	=3D input:PopNetUint8()
-		stats.char_fireresist	=3D input:PopNetUint16()			=

-		stats.char_coldresist	=3D input:PopNetUint16()			=

-		stats.char_poisonresist	=3D input:PopNetUint16()			=

-		stats.char_energyresist	=3D input:PopNetUint16()			=

-		stats.char_minDamage	=3D input:PopNetUint16()			=

-		stats.char_maxDamage	=3D input:PopNetUint16()			=

-		stats.char_tithing		=3D input:PopNetUint32()		=

+		stats.sex		=3D input:PopNetUint8() -- * 0x00 - Male     * 0x01 - Female
+		stats.gold		=3D input:PopNetUint32()
+		stats.armorC	=3D input:PopNetUint16() -- resistPhysical (old clients: AC=
).
+		stats.curWeight=3D input:PopNetUint16()
+		stats.maxWeight =3D input:PopNetUint16()
+		stats.race		 =3D input:PopNetUint8()
+		stats.statcap	=3D input:PopNetUint16()		-- The character's total allowab=
le sum of Strength, Intelligence, and Dexterity
+		stats.curPet	=3D input:PopNetUint8()			=

+		stats.maxPet	=3D input:PopNetUint8()
+		stats.fireresist	=3D input:PopNetUint16()			=

+		stats.coldresist	=3D input:PopNetUint16()			=

+		stats.poisonresist	=3D input:PopNetUint16()			=

+		stats.energyresist	=3D input:PopNetUint16()			=

+		stats.minDamage	=3D input:PopNetUint16()			=

+		stats.maxDamage	=3D input:PopNetUint16()			=

+		stats.tithing		=3D input:PopNetUint32()		=

 		]]--		=

 =

 				-- stats update function
@@ -63,14 +63,14 @@
 				if m and m.stats then
 					local s =3D m.stats
 					=

-					local l =3D {	char_str =3D &quot;status_str&quot;, char_dex =3D &quot;status_dex&quot;, c=
har_int =3D &quot;status_int&quot;,
-								curHits =3D &quot;status_hits&quot;, maxHits =3D &quot;status_maxhits&quot;,
-								char_curMana =3D &quot;status_mana&quot;, char_maxMana =3D &quot;status_maxmana&quot;,
-								char_curSta =3D &quot;status_stamina&quot;, char_maxSta =3D &quot;status_maxstami=
na&quot;,
-								char_luck =3D &quot;status_luck&quot;, char_gold =3D &quot;status_gold&quot;,
-								char_armorC =3D &quot;status_armor&quot;, char_statcap =3D &quot;status_statcap&quot;,=
 char_fireresist =3D &quot;status_fireres&quot;,
-								char_coldresist =3D &quot;status_coldres&quot;, char_poisonresist =3D &quot;statu=
s_poisres&quot;,
-								char_energyresist =3D &quot;status_energres&quot; }
+					local l =3D {	str =3D &quot;status_str&quot;, dex =3D &quot;status_dex&quot;, int =3D &quot;st=
atus_int&quot;,
+								curHits =3D &quot;status_hits&quot;, 		maxHits =3D &quot;status_maxhits&quot;,
+								curMana =3D &quot;status_mana&quot;, 		maxMana =3D &quot;status_maxmana&quot;,
+								curSta =3D &quot;status_stamina&quot;, 		maxSta =3D &quot;status_maxstamina&quot;,
+								luck =3D &quot;status_luck&quot;, 			gold =3D &quot;status_gold&quot;,
+								armorC =3D &quot;status_armor&quot;, 		statcap =3D &quot;status_statcap&quot;, fireres=
ist =3D &quot;status_fireres&quot;,
+								coldresist =3D &quot;status_coldres&quot;, 	poisonresist =3D &quot;status_poisres=
&quot;,
+								energyresist =3D &quot;status_energres&quot; }
 					=

 					-- set all textfields (single)
 					for k,v in pairs(l) do
@@ -86,25 +86,25 @@
 =

 					-- multi part textfields, like &quot;10 / 20&quot;
 					-- pets
-					if s[&quot;char_curPet&quot;] and s[&quot;char_maxPet&quot;] then =

-						dialog.controls[&quot;status_pets&quot;].gfx:SetText(s[&quot;char_curPet&quot;]..&quot;/&quot;..s[=
&quot;char_maxPet&quot;]) =

+					if s[&quot;curPet&quot;] and s[&quot;maxPet&quot;] then =

+						dialog.controls[&quot;status_pets&quot;].gfx:SetText(s[&quot;curPet&quot;]..&quot;/&quot;..s[&quot;maxP=
et&quot;]) =

 					else dialog.controls[&quot;status_pets&quot;].gfx:SetText(&quot;?&quot;) end =

 					-- damage
-					if s[&quot;char_minDamage&quot;] and s[&quot;char_maxDamage&quot;] then =

-						dialog.controls[&quot;status_minmaxdamage&quot;].gfx:SetText(s[&quot;char_minDamage=
&quot;]..&quot;-&quot;..s[&quot;char_maxDamage&quot;]) =

+					if s[&quot;minDamage&quot;] and s[&quot;maxDamage&quot;] then =

+						dialog.controls[&quot;status_minmaxdamage&quot;].gfx:SetText(s[&quot;minDamage&quot;]..&quot;=
-&quot;..s[&quot;maxDamage&quot;]) =

 					else dialog.controls[&quot;status_minmaxdamage&quot;].gfx:SetText(&quot;?&quot;) end =

 					-- weight
-					if s[&quot;char_curWeight&quot;] then =

-						if s[&quot;char_maxWeight&quot;] then =

+					if s[&quot;curWeight&quot;] then =

+						if s[&quot;maxWeight&quot;] then =

 							-- max weight given
-							dialog.controls[&quot;status_weight&quot;].gfx:SetText(s[&quot;char_curWeight&quot;])
-							dialog.controls[&quot;status_maxweight&quot;].gfx:SetText(s[&quot;char_maxWeight&quot;])
+							dialog.controls[&quot;status_weight&quot;].gfx:SetText(s[&quot;curWeight&quot;])
+							dialog.controls[&quot;status_maxweight&quot;].gfx:SetText(s[&quot;maxWeight&quot;])
 						else =

 							-- no maxweight present
-							dialog.controls[&quot;status_weight&quot;].gfx:SetText(s[&quot;char_curWeight&quot;]) =

+							dialog.controls[&quot;status_weight&quot;].gfx:SetText(s[&quot;curWeight&quot;]) =

 							-- hardcoded fallback: 40 + floor(str*35/10)
 							dialog.controls[&quot;status_maxweight&quot;].gfx:SetText(&quot;&quot;..
-								(40 + math.floor(s[&quot;char_str&quot;]*35/10)))
+								(40 + math.floor(s[&quot;str&quot;]*35/10)))
 						end
 					else dialog.controls[&quot;status_weight&quot;].gfx:SetText(&quot;?&quot;) end =

 				end

Modified: trunk/data/lua/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.login.lua (original)
+++ trunk/data/lua/net.login.lua Thu Aug  2 19:47:02 2007
@@ -174,27 +174,33 @@
 function gPacketHandler.kPacket_Login_Confirm()
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
-	local playerid =3D input:PopNetUint32()
-	local unknown1 =3D input:PopNetUint32()
-	local bodytype =3D input:PopNetUint16()
-	local x_location =3D input:PopNetUint16()
-	local y_location =3D input:PopNetUint16()
-	local unknown0 =3D input:PopNetUint8()
-	local z_location =3D input:PopInt8()
-	local direction =3D input:PopNetUint8()
-
-	local unknown2 =3D input:PopNetUint16()
-	local unknown3 =3D input:PopNetUint32()
-
-	local unknown4 =3D input:PopNetUint32()
-	local flag =3D input:PopNetUint8()
-	local highlight_color =3D input:PopNetUint8()
-
-	local unknown5 =3D input:PopNetUint32()
-	local unknown6 =3D input:PopNetUint16()
-	local unknown7 =3D input:PopNetUint8()
-
-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Login_Confirm CharacterID: 0x%08x Bodyty=
pe: %i x: %i y: %i z: %i flag=3D0x%02x\n&quot;, playerid, bodytype, x_location, =
y_location, z_location, flag))
+
+	packet =3D {}
+	packet.serial	=3D input:PopNetUint32()
+	packet.unknown1 =3D input:PopNetUint32()
+	packet.body	=3D input:PopNetUint16()
+	packet.xloc	=3D input:PopNetUint16()
+	packet.yloc	=3D input:PopNetUint16()
+	packet.unknown0 =3D input:PopNetUint8()
+	packet.zloc	=3D input:PopInt8()
+	packet.dir	=3D input:PopNetUint8()
+
+	packet.unknown2 =3D input:PopNetUint16()
+	packet.unknown3 =3D input:PopNetUint32()
+
+	packet.unknown4 =3D input:PopNetUint32()
+	packet.flag	=3D input:PopNetUint8()
+	packet.notoriety =3D input:PopNetUint8()
+
+	packet.unknown5 =3D input:PopNetUint32()
+	packet.unknown6 =3D input:PopNetUint16()
+	packet.unknown7 =3D input:PopNetUint8()
+	=

+	packet.hue	=3D 0
+	local playerid =3D packet.serial
+
+	local bodytype =3D packet.body
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: Login_Confirm CharacterID: 0x%08x Bodyty=
pe: %i x: %i y: %i z: %i flag=3D0x%02x\n&quot;, playerid, bodytype, packet.xloc,=
 packet.yloc, packet.zloc, packet.flag))
 =

 	-- TODO : HintStartPosition(x_location,y_location,z_location) ?
 	-- this is just a hint that might be used to position the cam
@@ -212,7 +218,7 @@
 =

 	UpdatePlayerBodySerial(playerid)
 	local playerMobile =3D GetPlayerMobile()
-	if (playerMobile) then playerMobile.artid =3D bodytype end
+	if (playerMobile) then playerMobile.artid =3D packet.body end
 end
 =

 -- if packet is received we can Start the Game now !

Modified: trunk/data/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.walk.lua (original)
+++ trunk/data/lua/net.walk.lua Thu Aug  2 19:47:02 2007
@@ -90,11 +90,11 @@
 	=

 	-- destroy objects outside view range
 	-- dynamics
-	for k,dynamic in pairs(gDynamics) do if (IsObjectFarEnoughToDestroy(dynam=
ic.xloc,dynamic.yloc)) then
+	for k,dynamic in pairs(GetDynamicList()) do if (IsObjectFarEnoughToDestro=
y(dynamic.xloc,dynamic.yloc)) then
 		DestroyObjectBySerial(dynamic.serial) =

 	end end
 	-- mobiles
-	for k,mobile in pairs(gMobiles) do if (IsObjectFarEnoughToDestroy(mobile.=
xloc,mobile.yloc)) then
+	for k,mobile in pairs(GetMobileList()) do if (IsObjectFarEnoughToDestroy(=
mobile.xloc,mobile.yloc)) then
 		DestroyObjectBySerial(mobile.serial) =

 	end end
 end

Modified: trunk/data/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.dynamic.lua (original)
+++ trunk/data/lua/net/net.dynamic.lua Thu Aug  2 19:47:02 2007
@@ -55,6 +55,8 @@
 1a 00 11 c0 02 9d aa 00 00 00 01 15 44 44 88 9c =

 80
 ]]--
+
+-- show item (0x1a)
 function gPacketHandler.kPacket_Show_Item()
 	local newitem =3D {}
 	local input =3D GetRecvFIFO()
@@ -150,12 +152,14 @@
 end
 =

 =

+-- AddItemToContainer (0x3C)
 -- pol sends this after kPacket_Open_Container, runuo before, see also kPa=
cket_Object_to_Object
 function gPacketHandler.kPacket_Container_Contents() -- 0x3c
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local itemcount =3D input:PopNetUint16()
+
 	for i=3D1,itemcount do
 		local item =3D {}
 		item.serial =3D input:PopNetUint32()
@@ -174,7 +178,6 @@
 		--AddFadeLines(sprintf(&quot;kPacket_Container_Contents type=3D%s&quot;,GetStaticT=
ileTypeName(item.artid)))
 	end
 end
-
 =

 -- This is sent by the server to add/update a single item to a container. =
(response to player dragdrop)
 function gPacketHandler.kPacket_Object_to_Object() -- 0x25

Modified: trunk/data/lua/net/net.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.effect.lua (original)
+++ trunk/data/lua/net/net.effect.lua Thu Aug  2 19:47:02 2007
@@ -1,6 +1,5 @@
 =

 -- Graphical Effect (Hued Art-Gfx / see Tiledata for Animation) - Billboar=
d or 3d Statics?
--- TODO : organize HUED_FX
 function gPacketHandler.kPacket_Hued_FX()	--0xC0
 	local effect =3D {}
 	local input =3D GetRecvFIFO()

Modified: trunk/data/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.mobile.lua (original)
+++ trunk/data/lua/net/net.mobile.lua Thu Aug  2 19:47:02 2007
@@ -35,6 +35,7 @@
 function gPacketHandler.kPacket_Equipped_MOB() -- ProtocolRecv_AddMobile
 	local mobile =3D {}
 	local input =3D GetRecvFIFO()
+
 	local fifolen_start =3D input:Size()
 	local id =3D input:PopNetUint8()
 	local iPacketSize =3D input:PopNetUint16()
@@ -125,6 +126,7 @@
 function gPacketHandler.kPacket_Teleport()
 	gLastResyncRequest =3D nil
 	--ResetWalkQueue()
+
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local player_id =3D input:PopNetUint32()
@@ -182,10 +184,11 @@
 	ResetWalkQueue() -- todo : (here or only if setplayerpos is done?)
 end
 =

--- Character Animation
+-- Character Animation (0x6e)
 function gPacketHandler.kPacket_Animation ()	-- [0x6e] 14 Bytes
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
+
 	local anim =3D {}
 	anim.mobileserial	=3D input:PopNetUint32()	=

 	anim.m_animation		=3D input:PopNetUint16()
@@ -195,6 +198,7 @@
 	anim.m_repeatFlag	=3D input:PopNetUint8()	--(0 - Don't repeat / 1 repeat)
 	anim.m_frameDelay	=3D input:PopNetUint8()	--(0x00 - fastest / 0xFF - Too =
slow to watch)
 	printdebug(&quot;animation&quot;,&quot;Animation &quot;..vardump2(anim))
+	=

 	gCurrentRenderer:MobileStartServerSideAnim(anim)
 end
 =

@@ -228,42 +232,41 @@
 	stats.maxHits 			=3D input:PopNetUint16()
 	stats.flagChangeNameFlag	=3D input:PopNetUint8()		--(0x1 =3D allowed, 0 =
=3D not allowed)
 	stats.bCanChangeName =3D stats.flagChangeNameFlag ~=3D 0
-	local flag =3D input:PopNetUint8()
-	stats.flag =3D flag
+	stats.flag =3D input:PopNetUint8()
 	=

 	-- more data following
-	if ((flag =3D=3D 1) or (flag =3D=3D 3) or (flag =3D=3D 4) or (flag =3D=3D=
 5)) then -- stats
-		stats.char_sex		=3D input:PopNetUint8() -- * 0x00 - Male     * 0x01 - Fe=
male
-		stats.char_str		=3D input:PopNetUint16()
-		stats.char_dex		=3D input:PopNetUint16()
-		stats.char_int		=3D input:PopNetUint16()
-		stats.char_curSta	=3D input:PopNetUint16()
-		stats.char_maxSta	=3D input:PopNetUint16()
-		stats.char_curMana	=3D input:PopNetUint16()
-		stats.char_maxMana	=3D input:PopNetUint16()
-		stats.char_gold		=3D input:PopNetUint32()
-		stats.char_armorC	=3D input:PopNetUint16() -- resistPhysical (old client=
s: AC).
-		stats.char_curWeight=3D input:PopNetUint16()
-
-		if (flag =3D=3D 5) then
-			stats.char_maxWeight =3D input:PopNetUint16()
-			stats.char_race		 =3D input:PopNetUint8()
-		end
-
-		if ((flag =3D=3D 3) or (flag =3D=3D 4) or (flag =3D=3D 5)) then -- Follo=
wers (pets)
-			stats.char_statcap	=3D input:PopNetUint16()		-- The character's total a=
llowable sum of Strength, Intelligence, and Dexterity
-			stats.char_curPet	=3D input:PopNetUint8()			=

-			stats.char_maxPet	=3D input:PopNetUint8()
+	if (in_array( stats.flag, {1,3,4,5})) then
+		stats.sex		=3D input:PopNetUint8() -- * 0x00 - Male     * 0x01 - Female
+		stats.str		=3D input:PopNetUint16()
+		stats.dex		=3D input:PopNetUint16()
+		stats.int		=3D input:PopNetUint16()
+		stats.curSta	=3D input:PopNetUint16()
+		stats.maxSta	=3D input:PopNetUint16()
+		stats.curMana	=3D input:PopNetUint16()
+		stats.maxMana	=3D input:PopNetUint16()
+		stats.gold		=3D input:PopNetUint32()
+		stats.armorC	=3D input:PopNetUint16() -- resistPhysical (old clients: AC=
).
+		stats.curWeight=3D input:PopNetUint16()
+
+		if (stats.flag =3D=3D 5) then
+			stats.maxWeight =3D input:PopNetUint16()
+			stats.race		 =3D input:PopNetUint8()
+		end
+
+		if (in_array( stats.flag, {3,4,5} )) then -- Followers (pets)
+			stats.statcap	=3D input:PopNetUint16()		-- The character's total allowa=
ble sum of Strength, Intelligence, and Dexterity
+			stats.curPet	=3D input:PopNetUint8()			=

+			stats.maxPet	=3D input:PopNetUint8()
 			=

-			if ((flag =3D=3D 4) or (flag =3D=3D 5)) then -- Resistances
-				stats.char_fireresist	=3D input:PopNetUint16()			=

-				stats.char_coldresist	=3D input:PopNetUint16()			=

-				stats.char_poisonresist	=3D input:PopNetUint16()			=

-				stats.char_energyresist	=3D input:PopNetUint16()			=

-				stats.char_luck			=3D input:PopNetUint16()			=

-				stats.char_minDamage	=3D input:PopNetUint16()			=

-				stats.char_maxDamage	=3D input:PopNetUint16()			=

-				stats.char_tithing		=3D input:PopNetUint32()			=

+			if (in_array( stats.flag, {4,5} )) then -- Resistances
+				stats.fireresist	=3D input:PopNetUint16()			=

+				stats.coldresist	=3D input:PopNetUint16()			=

+				stats.poisonresist	=3D input:PopNetUint16()			=

+				stats.energyresist	=3D input:PopNetUint16()			=

+				stats.luck			=3D input:PopNetUint16()			=

+				stats.minDamage	=3D input:PopNetUint16()			=

+				stats.maxDamage	=3D input:PopNetUint16()			=

+				stats.tithing		=3D input:PopNetUint32()			=

 			end
 		end
 	end
@@ -301,7 +304,6 @@
 We probably have to wait till OSI activates it/finishes implementation., t=
o see what it does.
 =

 ]]--
-
 =

 --[[
 Mobile Flag Byte: maybe those are similar to the kPacket_Show_Item flag/st=
atus byte ?
@@ -325,7 +327,7 @@
 	local curval =3D input:PopNetUint16()
 	printdebug(&quot;mobile&quot;,sprintf(&quot;NET: update HP: mobile_serial=3D0x%08x  %i /=
 %i\n&quot;,mobile_id,curval,maxval))
 	=

-	local mobile =3D gMobiles[mobile_id]
+	local mobile =3D GetMobile(mobile_id)
 	-- TODO pol sends normal hp update and x/1000 hp update ???? so i ignore =
the strange one
 	if (mobile and (maxval ~=3D 1000) and mobile.stats) then
 		if mobile.stats.curHits then
@@ -351,11 +353,11 @@
 	local curval =3D input:PopNetUint16()
 	printdebug(&quot;mobile&quot;,sprintf(&quot;NET: update MANA: mobile_serial=3D0x%08x  %i=
 / %i\n&quot;,mobile_id,curval,maxval))
 	=

-	local mobile =3D gMobiles[mobile_id]
-	if mobile and mobile.stats then
+	local mobile =3D GetMobile(mobile_id)
+	if (mobile and mobile.stats) then
 		-- update values
-		mobile.stats.char_curMana =3D curval
-		mobile.stats.char_maxMana =3D maxval
+		mobile.stats.curMana =3D curval
+		mobile.stats.maxMana =3D maxval
 =

 		if (mobile_id =3D=3D gPlayerBodySerial) then
 			gui.SetMana(curval/maxval)
@@ -365,7 +367,6 @@
 	end
 end
 =

-
 --# Update Current Stamina [0xA3]
 -- TODO : not only player gets update packets here
 function gPacketHandler.kPacket_Stamina()
@@ -376,11 +377,11 @@
 	local curval =3D input:PopNetUint16()
 	printdebug(&quot;mobile&quot;,sprintf(&quot;NET: update STAMINA: mobile_serial=3D0x%08x =
 %i / %i\n&quot;,mobile_id,curval,maxval))
 =

-	local mobile =3D gMobiles[mobile_id]
-	if mobile and mobile.stats then
+	local mobile =3D GetMobile(mobile_id)
+	if (mobile and mobile.stats) then
 		-- update values
-		mobile.stats.char_curSta =3D curval
-		mobile.stats.char_maxSta =3D maxval
+		mobile.stats.curSta =3D curval
+		mobile.stats.maxSta =3D maxval
 =

 		if (mobile_id =3D=3D gPlayerBodySerial) then
 			gui.SetStamina(curval/maxval)

Modified: trunk/data/lua/net/net.packethandlers.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.packethandlers.lua (original)
+++ trunk/data/lua/net/net.packethandlers.lua Thu Aug  2 19:47:02 2007
@@ -3,13 +3,15 @@
 function gPacketHandler.kPacket_Open_Container() -- 0x24
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
-	local container_serial =3D input:PopNetUint32()
-	local container_gumpid =3D input:PopNetUint16()
+
+	packet =3D {}
+	packet.serial =3D input:PopNetUint32()
+	packet.gumpid =3D input:PopNetUint16()
 	=

-	print(&quot;# kPacket_Open_Container&quot;,container_serial,container_gumpid)
+	print(&quot;# kPacket_Open_Container&quot;,packet.serial,packet.gumpid)
 	=

-	local container =3D GetOrCreateContainer(container_serial)
-	container.gumpid =3D container_gumpid
+	local container =3D GetOrCreateContainer(packet.serial)
+	container.gumpid =3D packet.gumpid
 =

 	--Ignore Shop container - created somewhere else
 	if (container.gumpid =3D=3D kGumpIDShopContainer) then
@@ -18,8 +20,8 @@
 	elseif ((container.gumpid =3D=3D kGumpIDSpellbookContainer) and not(conta=
iner.dialog)) then
 		local spellbook =3D {}
 		spellbook.old=3Dtrue
-		spellbook.serial =3D container_serial
-		spellbook.itemid =3D container_gumpid
+		spellbook.serial =3D packet.serial
+		spellbook.itemid =3D packet.gumpid
 		spellbook.scrolloffset =3D 0
 		spellbook.matrix =3D {}
 		for i=3D1, 8 do spellbook.matrix[i] =3D 0 end
@@ -45,6 +47,7 @@
 		end
 		RefreshContainerItemWidgets(container)
 	end
+
 	SecureTradeRebuildContainerHook(container)
 end
 =


Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Thu Aug  2 19:47:02 2007
@@ -102,8 +102,8 @@
 		if (mobile.serial =3D=3D gPlayerBodySerial) then
 			-- for player
 			gui.SetHitpoints(mobile.stats.curHits/mobile.stats.maxHits)
-			if (mobile.stats.char_curMana) then gui.SetMana(mobile.stats.char_curMa=
na/mobile.stats.char_maxMana) end
-			if (mobile.stats.char_curSta) then gui.SetStamina(mobile.stats.char_cur=
Sta/mobile.stats.char_maxSta) end
+			if (mobile.stats.curMana) then gui.SetMana(mobile.stats.curMana/mobile.=
stats.maxMana) end
+			if (mobile.stats.curSta) then gui.SetStamina(mobile.stats.curSta/mobile=
.stats.maxSta) end
 			-- update big_stats window
 			UpdateStatusAos()
 		else

Modified: trunk/data/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.player.lua (original)
+++ trunk/data/lua/obj/obj.player.lua Thu Aug  2 19:47:02 2007
@@ -44,7 +44,7 @@
 =

 function GetPlayerGold ()
 	local playermobile =3D GetPlayerMobile()
-	return playermobile and playermobile.stats and playermobile.stats.char_go=
ld or 0
+	return playermobile and playermobile.stats and playermobile.stats.gold or=
 0
 end
 =

 function GetPlayerMobile ()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000148.html">[Iris-commit] [IRIS] r1332 - in /trunk/data/lua: main.lua	net/net.multi.lua
</A></li>
	<LI>Next message: <A HREF="000150.html">[Iris-commit] [IRIS] r1334 - in /branches/knut/data/lua: net.login.lua net.walk.lua net/net.dynamic.lua net/net.effect.lua net/net.mobile.lua net/net.object.lua net/net.packethandlers.lua obj/obj.mobile.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#149">[ date ]</a>
              <a href="thread.html#149">[ thread ]</a>
              <a href="subject.html#149">[ subject ]</a>
              <a href="author.html#149">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
