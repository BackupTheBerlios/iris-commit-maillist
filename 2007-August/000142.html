<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1319 - /branches/knut/data/lua/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1319%20-%20/branches/knut/data/lua/&In-Reply-To=%3C20070801202619.EFCF6B140B4%40localhost.localdomain%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000133.html">
   <LINK REL="Next"  HREF="000134.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1319 - /branches/knut/data/lua/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1319%20-%20/branches/knut/data/lua/&In-Reply-To=%3C20070801202619.EFCF6B140B4%40localhost.localdomain%3E"
       TITLE="[Iris-commit] [IRIS] r1319 - /branches/knut/data/lua/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Wed Aug  1 22:26:18 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000133.html">[Iris-commit] [IRIS] r1318 - in /branches/knut/src: profile.cpp	sound_fmod.cpp
</A></li>
        <LI>Next message: <A HREF="000134.html">[Iris-commit] [IRIS] r1320 - in /trunk/data/lua: gui.container.lua gui/ gui/gui.paperdoll.lua net.container.lua net.mobile.lua net.objects.lua net.paperdoll.lua net.player.lua net/ net/net.object.lua obj.mobile.lua obj/ obj/obj.player.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#142">[ date ]</a>
              <a href="thread.html#142">[ thread ]</a>
              <a href="subject.html#142">[ subject ]</a>
              <a href="author.html#142">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Wed Aug  1 22:26:16 2007
New Revision: 1319

Log:
ported changes from trunk to knut/data/lua branch, r 1031:1313

Added:
    branches/knut/data/lua/filter.art.lua
      - copied unchanged from r1313, trunk/data/lua/filter.art.lua
    branches/knut/data/lua/filter.granny.lua
      - copied unchanged from r1313, trunk/data/lua/filter.granny.lua
    branches/knut/data/lua/filter.map.lua
      - copied unchanged from r1313, trunk/data/lua/filter.map.lua
    branches/knut/data/lua/net.corpse.lua
      - copied unchanged from r1313, trunk/data/lua/net.corpse.lua
    branches/knut/data/lua/net.customhouse.lua
      - copied unchanged from r1313, trunk/data/lua/net.customhouse.lua
Modified:
    branches/knut/data/lua/lib.3d.map.lua
    branches/knut/data/lua/lib.3d.mobileanim.lua
    branches/knut/data/lua/lib.3d.mousepick.lua
    branches/knut/data/lua/lib.3d.renderer.lua
    branches/knut/data/lua/lib.charcreate.lua
    branches/knut/data/lua/lib.compass.lua
    branches/knut/data/lua/lib.corpse.lua
    branches/knut/data/lua/lib.data.lua
    branches/knut/data/lua/lib.debugmenu.lua
    branches/knut/data/lua/lib.devtool.lua
    branches/knut/data/lua/lib.fallback.lua
    branches/knut/data/lua/lib.gui.lua
    branches/knut/data/lua/lib.guimaker.lua
    branches/knut/data/lua/lib.gumpparser.lua
    branches/knut/data/lua/lib.input.lua
    branches/knut/data/lua/lib.loading.lua
    branches/knut/data/lua/lib.mainmenu.lua
    branches/knut/data/lua/lib.meshexporter.lua
    branches/knut/data/lua/lib.modelanim.lua
    branches/knut/data/lua/lib.models.lua
    branches/knut/data/lua/lib.mount.lua
    branches/knut/data/lua/lib.net.lua
    branches/knut/data/lua/lib.packet.lua
    branches/knut/data/lua/lib.protocol.lua
    branches/knut/data/lua/lib.skill.lua
    branches/knut/data/lua/lib.sound.lua
    branches/knut/data/lua/lib.spellbooks.lua
    branches/knut/data/lua/lib.static.lua
    branches/knut/data/lua/lib.terrain.lua
    branches/knut/data/lua/lib.test.lua
    branches/knut/data/lua/lib.time.lua
    branches/knut/data/lua/lib.uoids.lua
    branches/knut/data/lua/lib.util.lua
    branches/knut/data/lua/lib.walking2.lua
    branches/knut/data/lua/main.lua
    branches/knut/data/lua/net.login.lua
    branches/knut/data/lua/net.other.lua
    branches/knut/data/lua/net.securetrade.lua
    branches/knut/data/lua/net.sound.lua
    branches/knut/data/lua/net.uodragdrop.lua

Modified: branches/knut/data/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.3d.map.lua (original)
+++ branches/knut/data/lua/lib.3d.map.lua Wed Aug  1 22:26:16 2007
@@ -139,6 +139,7 @@
 				chunk.terraingfx =3D CreateRootGfx3D()
 				chunk.terraingfx:SetMesh(meshname)
 				chunk.terraingfx:SetPosition(x,y,0)
+				chunk.terraingfx:SetCastShadows(gTerrainCastShadows)
 				chunk.terraingfx:SetVisible(self.gbBlendOutTerrainVisible)
 			end
 		end
@@ -158,16 +159,22 @@
 				for i =3D 0,iStaticCount-1 do
 					iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i) -- oper=
ates on the block that was last loaded using :Load()
 					local entity =3D {}
-					entity.xloc =3D (iBlockUO_X+x)*8 + iX
-					entity.yloc =3D (iBlockUO_Y+y)*8 + iY
-					entity.zloc =3D iZ -- in tilecoords from uo
+
+					-- FILTER: correction
+					entity.xadd =3D FilterPositionX(iTileTypeID) or 0
+					entity.yadd =3D FilterPositionY(iTileTypeID) or 0
+					entity.zadd =3D FilterPositionZ(iTileTypeID) or 0
+
+					entity.xloc =3D (iBlockUO_X+x)*8 + iX + entity.xadd
+					entity.yloc =3D (iBlockUO_Y+y)*8 + iY + entity.yadd
+					entity.zloc =3D iZ + entity.zadd -- in tilecoords from uo
+
 					entity.x,entity.y,entity.z =3D self:UOPosToLocal(entity.xloc,entity.y=
loc,entity.zloc*0.1)
 					entity.iBlockX =3D iBlockUO_X+x
 					entity.iBlockY =3D iBlockUO_Y+y
 					entity.id =3D i
 					entity.iTileTypeID =3D iTileTypeID
 					entity.iHue =3D iHue
-					=

 					=

 					meshname =3D (not gForceFallBackBillboards_Statics) and GetStaticMesh=
Name(iTileTypeID,iHue)
 					if (meshname and meshname ~=3D &quot;&quot; and (not MeshIsPseudoBillBoard(iTil=
eTypeID))) then
@@ -181,22 +188,32 @@
 						entity.sx =3D sx
 						entity.sy =3D sy
 						entity.sz =3D sz
-						=

-						-- ApplyStaticEntityHue(entity,iHue)		=

-						=

+
+						-- lights don't cast shadows
+						if (gLightsources) then
+							local arrtiletype =3D {}
+							arrtiletype =3D GetStaticTileType(iTileTypeID)
+							if( BitwiseAND(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) =
~=3D 0 ) then
+								local x,y,z =3D Renderer3D:UOPosToLocal(entity.x,entity.y,entity.z=
 * 0.1)
+								Client_AddPointLight(entity.x-0.5,entity.y-0.5,entity.z+arrtiletyp=
e.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
+							end
+						end
+
 						local myLayer =3D iZ
 						local myLayerStaticGeom =3D chunk.pStaticGeometryLayers[myLayer]
 						if (not myLayerStaticGeom) then
 							myLayerStaticGeom =3D CreateStaticGeometry()
 							chunk.pStaticGeometryLayers[myLayer] =3D myLayerStaticGeom
 						end
+
 						-- apply x mirror
 						myLayerStaticGeom:AddEntity(entity.staticentity,entity.x,entity.y,en=
tity.z,qw,qx,qy,qz,sx,sy,sz)
 						table.insert(chunk.lStaticEntities,entity)
+
 					elseif (gEnableFallBackBillboards_Statics) then
-						-- fallback to billboard with original art or =

-						=

+						-- fallback to billboard with original art or						=

 						local iTranslatedTileTypeID =3D TranslateTileTypeID(iTileTypeID + 16=
384, gSeasonSetting)
+
 						if (not IsArtBillboardFallBackSkipped(iTileTypeID)) then
 							entity.x,entity.y,entity.z =3D self:UOPosToLocal(entity.xloc+0.5,en=
tity.yloc+0.5,entity.zloc*0.1 + 0.5)
 							entity.gfx =3D CreateRootGfx3D()
@@ -215,8 +232,9 @@
 	-- TODO : fish in water ? other gimiks ?
 	=

 	for layerZ,layerStaticGeom in pairs(chunk.pStaticGeometryLayers) do =

-		layerStaticGeom:Build() =

+		--layerStaticGeom:SetCastShadows(true)
 		layerStaticGeom:SetVisible(self:IsZLayerVisible(layerZ))
+		layerStaticGeom:Build()
 	end
 	return chunk
 end
@@ -253,6 +271,7 @@
 	self:MobileSetVisible(mobile,self:IsZLayerVisible(mobile.z))
 end
 =

+-- TODO: blend out mounts
 function Renderer3D:BlendOutLayersAbovePlayer ()
 	local x,y,z =3D GetPlayerPos()
 	if (not z or not gStaticBlockLoader) then return end
@@ -275,6 +294,8 @@
 			local iStaticCount =3D gStaticBlockLoader:Count() -- operates on the bl=
ock that was last loaded using :Load()
 			local iPX =3D x - 8 * math.floor(x/8)
 			local iPY =3D y - 8 * math.floor(y/8)
+
+			local iTileTypeID,iX,iY,iZ,iHue
 			for i =3D 0,iStaticCount-1 do
 				iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i) -- opera=
tes on the block that was last loaded using :Load()
 				if (iX =3D=3D iPX and iY =3D=3D iPY and iZ &gt; playerheadpos) then playe=
rIsInside =3D true end
@@ -285,12 +306,11 @@
 			end
 		end
 		=

-		-- check dynamics for multis to detect house roofs and stuff like this
-		=

+		-- check dynamics for multis to detect house roofs and stuff like this		=

 		for k,object in pairs(gObjectList) do =

 			if (object.isdynamic) then
 				local dynamic =3D object
-				if dynamic.lMultiChildGfx then
+				if (dynamic.lMultiChildGfx) then
 					for k,child in pairs(dynamic.lMultiChildGfx) do
 						if (x =3D=3D dynamic.x+child.xloc and y =3D=3D dynamic.y+child.yloc =
and dynamic.z+child.zloc &gt; playerheadpos) then
 							playerIsInside =3D true =

@@ -299,7 +319,7 @@
 				end
 			end
 		end
-		=

+
 		-- blend out layers above player head if inside
 		if (playerIsInside) then myLayer =3D playerheadpos end
 	end

Modified: branches/knut/data/lua/lib.3d.mobileanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.3d.mobileanim.lua (original)
+++ branches/knut/data/lua/lib.3d.mobileanim.lua Wed Aug  1 22:26:16 2007
@@ -53,6 +53,7 @@
 =

 -- calling this interrupts any playing serverside anim
 function Renderer3D:MobileStartClientSideAnim (mobile)
+	if (not mobile.equipment) then return end
 	mobile.animinit =3D true
 	local bodyid =3D MobileArtId2BodyId(mobile.body)
 	=


Modified: branches/knut/data/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.3d.mousepick.lua (original)
+++ branches/knut/data/lua/lib.3d.mousepick.lua Wed Aug  1 22:26:16 2007
@@ -278,6 +278,7 @@
 				self.gMousePickBBox:SetPosition(entity.x,entity.y,entity.z)
 				self.gMousePickBBox:SetOrientation(entity.qw,entity.qx,entity.qy,entit=
y.qz)
 				self.gMousePickBBox:SetScale(entity.sx,entity.sy,entity.sz)
+				self.gMousePickBBox:SetNormaliseNormals(true)
 			end
 		end
 	elseif (o.hittype =3D=3D kMousePickHitType_Terrain) then -- terrain tile
@@ -310,7 +311,8 @@
 			--local qw,qx,qy,qz =3D Quaternion.identity()
 			local qw,qx,qy,qz =3D GetStaticMeshOrientation(dynamic.artid) -- TODO :=
 WRONG FOR ROTATED DYNAMICS (dir) !!!
 			self.gMousePickBBox:SetOrientation(qw,qx,qy,qz)
-			self.gMousePickBBox:SetScale(-1,1,1)
+			self.gMousePickBBox:SetScale(-1,1,1)		-- (-1) thats because xmirror bug=
 and wrong mirrored mashes
+			self.gMousePickBBox:SetNormaliseNormals(true)
 			self.gMousePickBBox:SetVisible(true)
 		end
 	elseif (o.hittype =3D=3D kMousePickHitType_Mobile) then

Modified: branches/knut/data/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.3d.renderer.lua (original)
+++ branches/knut/data/lua/lib.3d.renderer.lua Wed Aug  1 22:26:16 2007
@@ -79,7 +79,6 @@
 	Client_ClearLights()
 	Client_AddDirectionalLight(1,1,-1)
 	Client_SetAmbientLight(0.4, 0.4, 0.4, 1)
-	-- GetMainViewport():SetBackCol(ColourValue(0.5,0.5,1));
 	=

 	self.gbActive =3D true
 	self:SetMapEnvironment()
@@ -109,37 +108,58 @@
 --###############################
 =

 StandardEffect =3D 0
-Fireball	=3D hex2num(&quot;0x36d4&quot;)
-MagicArrow	=3D hex2num(&quot;0x36e4&quot;)
-PField		=3D hex2num(&quot;0x376a&quot;)
-PoisonWall	=3D hex2num(&quot;0x3914&quot;)
-Teleport	=3D hex2num(&quot;0x3728&quot;)
-Healing		=3D hex2num(&quot;0x376A&quot;)
-FlameStrike =3D hex2num(&quot;0x3709&quot;)
-Explosion	=3D hex2num(&quot;0x36bd&quot;)
+Fireball			=3D hex2num(&quot;0x36d4&quot;)
+MagicArrow			=3D hex2num(&quot;0x36e4&quot;)
+PoisonField			=3D hex2num(&quot;0x3914&quot;)
+Teleport			=3D hex2num(&quot;0x3728&quot;)
+Healing				=3D hex2num(&quot;0x376A&quot;)
+FlameStrike			=3D hex2num(&quot;0x3709&quot;)
+Explosion			=3D hex2num(&quot;0x36bd&quot;)
+ConsecrateWeapon1	=3D hex2num(&quot;0x3779&quot;)
+MindRot				=3D hex2num(&quot;0x373A&quot;)
+PainSpike			=3D hex2num(&quot;0x37C4&quot;)	-- needs rework
+PoisonStrike		=3D hex2num(&quot;0x36B0&quot;)
+StranglePart1		=3D hex2num(&quot;0x36CB&quot;)
+StranglePart2		=3D hex2num(&quot;0x374A&quot;)
+Wither				=3D hex2num(&quot;0x37CC&quot;)
+
+ParalyzeField		=3D hex2num(&quot;0x0001&quot;)	-- ??
+FireField			=3D hex2num(&quot;0x0002&quot;) -- ???
+ConsecrateWeapon2=3D 9501	--???
 --Fizzels		=3D hex2num(&quot;0x3735&quot;)
+
+-- effects can have a ttl (time-to-live, effect.ttl in milliseconds, defau=
lt is gParticleEffectDefaultTTL in ms)
+gParticleEffectDefaultTTL =3D 10 * 1000
+gParticleEffectDefaultSpeed =3D 0.1
 gParticleEffects =3D {}
 gParticleEffects[StandardEffect]=3D { etype=3D0, name=3D&quot;bluering&quot;, relx=
=3D0.5, rely=3D0.5, relz=3D0.1, scalex=3D1, scaley=3D1, scalez=3D1 }
 gParticleEffects[Fireball]		=3D { etype=3D0, name=3D&quot;Large Fireball&quot;, relx=
=3D0.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
 gParticleEffects[MagicArrow]	=3D { etype=3D2, name=3D&quot;Magic Arrow&quot;, relx=
=3D0.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
-gParticleEffects[PField]		=3D { etype=3D2, name=3D&quot;ParalizeWall&quot;, relx=3D0=
.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
-gParticleEffects[PoisonWall]	=3D { etype=3D2, name=3D&quot;PoisonWall&quot;, relx=3D=
0.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
+gParticleEffects[ParalyzeField]	=3D { etype=3D2, name=3D&quot;ParalyzeField&quot;, r=
elx=3D0.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
+gParticleEffects[PoisonField]	=3D { etype=3D2, name=3D&quot;PoisonField&quot;, relx=
=3D0.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
+gParticleEffects[FireField]		=3D { etype=3D2, name=3D&quot;FireField&quot;, relx=3D0=
.5, rely=3D0.5, relz=3D0.5, scalex=3D0.4, scaley=3D0.4, scalez=3D0.1}
 gParticleEffects[Teleport]		=3D { etype=3D2, name=3D&quot;Teleport&quot;, relx=3D0.5=
, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
 gParticleEffects[Healing]		=3D { etype=3D3, name=3D&quot;Healing&quot;, relx=3D0.5, =
rely=3D0.5, relz=3D0.1, scalex=3D1, scaley=3D1, scalez=3D1}
 gParticleEffects[FlameStrike]	=3D { etype=3D3, name=3D&quot;Magic Arrow&quot;, relx=
=3D0.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
-gParticleEffects[Explosion]		=3D { etype=3D0, name=3D&quot;Explosion (Iris)&quot;, r=
elx=3D0.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
+gParticleEffects[Explosion]		=3D { etype=3D0, name=3D&quot;Explosion&quot;, relx=3D0=
.5, rely=3D0.5, relz=3D1, scalex=3D0.2, scaley=3D0.2, scalez=3D0.2}
+gParticleEffects[ConsecrateWeapon1]=3D { etype=3D3, name=3D&quot;ConsecrateWeap=
on1&quot;, relx=3D0.5, rely=3D0.5, relz=3D3, scalex=3D0.2, scaley=3D0.2, scalez=
=3D0.1}
+gParticleEffects[ConsecrateWeapon2]=3D { etype=3D0, name=3D&quot;ConsecrateWeap=
on2&quot;, relx=3D0.5, rely=3D0.5, relz=3D3, scalex=3D0.2, scaley=3D0.2, scalez=
=3D0.1}
+gParticleEffects[MindRot]		=3D { etype=3D3, name=3D&quot;MindRot&quot;, relx=3D0.5, =
rely=3D0.5, relz=3D3, scalex=3D1, scaley=3D1, scalez=3D1}
+gParticleEffects[PainSpike]		=3D { etype=3D3, name=3D&quot;PainSpike&quot;, relx=3D0=
.5, rely=3D0.5, relz=3D3, scalex=3D1, scaley=3D1, scalez=3D1}
+gParticleEffects[PoisonStrike]	=3D { etype=3D3, name=3D&quot;PoisonStrike&quot;, rel=
x=3D0.5, rely=3D0.5, relz=3D3, scalex=3D1, scaley=3D1, scalez=3D1}
+gParticleEffects[StranglePart1]	=3D { etype=3D3, name=3D&quot;StranglePart1&quot;, r=
elx=3D0.5, rely=3D0.5, relz=3D3, scalex=3D1, scaley=3D1, scalez=3D1}
+gParticleEffects[StranglePart2]	=3D { etype=3D3, name=3D&quot;StranglePart2&quot;, r=
elx=3D0.5, rely=3D0.5, relz=3D3, scalex=3D1, scaley=3D1, scalez=3D1}
+gParticleEffects[Wither]		=3D { etype=3D3, name=3D&quot;Wither&quot;, relx=3D0.5, re=
ly=3D0.5, relz=3D3, scalex=3D1, scaley=3D1, scalez=3D1}
 =

 -- TODO: manage particle effects, esp. huedfx, decide between effecttypes
 function Renderer3D:AddEffect( effect )
-	if (gParticleEffects[effect.itemid]) then
-		Renderer3D:AddParticleEffect( effect, gParticleEffects[effect.itemid].na=
me,
-								gParticleEffects[effect.itemid].relx, gParticleEffects[effect.item=
id].rely, gParticleEffects[effect.itemid].relz,
-								gParticleEffects[effect.itemid].scalex, gParticleEffects[effect.it=
emid].scaley, gParticleEffects[effect.itemid].scalez)
-	else
-		Renderer3D:AddParticleEffect( effect, gParticleEffects[StandardEffect].n=
ame,
-								gParticleEffects[StandardEffect].relx, gParticleEffects[StandardEf=
fect].rely, gParticleEffects[StandardEffect].relz,
-								gParticleEffects[StandardEffect].scalex, gParticleEffects[Standard=
Effect].scaley, gParticleEffects[StandardEffect].scalez)
-	end
+	local id =3D StandardEffect
+	=

+	if (gParticleEffects[effect.itemid]) then id =3D effect.itemid end
+	=

+	Renderer3D:AddParticleEffect( effect, gParticleEffects[id].name,
+							gParticleEffects[id].relx, gParticleEffects[id].rely, gParticleEffe=
cts[id].relz,
+							gParticleEffects[id].scalex, gParticleEffects[id].scaley, gParticle=
Effects[id].scalez)
 end
 =

 --gHued_FX =3D {}
@@ -156,14 +176,14 @@
 	end
 ]]--
 function Renderer3D:AddHuedEffect( effect, relx, rely, relz )
-	local meshname =3D GetStaticMeshName(effect.itemid+32*512*0,effect.hue)
+	local meshname =3D GetStaticMeshName(effect.itemid,effect.hue)
 	if (meshname) then
 		effect.gfx =3D CreateRootGfx3D()
 		effect.gfx:SetMesh(meshname)
 		effect.gfx:SetRenderingDistance(self.gDynamicMaxRenderDist)
-		effect.gfx:SetPosition(self:UOPosToLocal(effect.source_locx + relx,effec=
t.source_locy + rely,effect.source_locz * 0.1 + relz))
+		effect.gfx:SetPosition(self:UOPosToLocal(effect.current_locx + relx,effe=
ct.current_locy + rely,effect.current_locz * 0.1 + relz))
 	else
-		printf(&quot;Hued Paricle effect failed Mesh=3D0x%04x not found.\n&quot;,effect.it=
emid+32*512*0)
+		printf(&quot;Hued Paricle effect failed Mesh=3D0x%04x not found.\n&quot;,effect.it=
emid)
 	end
 end
 =

@@ -176,10 +196,101 @@
 =

 -- TODO : check particle before
 function Renderer3D:AddParticleEffect( effect, particlename, relx, rely, r=
elz, scalex, scaley, scalez)
+	printdebug(&quot;effect&quot;,&quot;AddParticleEffect&quot;)
 	effect.gfx=3DCreateRootGfx3D()
 	effect.gfx:SetParticleSystem(particlename)
-	effect.gfx:SetPosition(self:UOPosToLocal(effect.source_locx + relx,effect=
.source_locy + rely,effect.source_locz * 0.1 + relz))
+	effect.gfx:SetPosition(self:UOPosToLocal(effect.current_locx + relx,effec=
t.current_locy + rely,effect.current_locz * 0.1 + relz))
 	effect.gfx:SetScale( scalex or 1, scaley or 1, scalez or 1)
+--	effect.gfx:SetNormaliseNormals(true)
+
+	--RegisterListener(&quot;Hook_MainStep&quot;,function(ticks) =

+	InvokeLater(effect.ttl or gParticleEffectDefaultTTL, function ()
+		-- destroy effect after timeout
+		printdebug(&quot;effect&quot;,&quot;destroy effect&quot;)
+		if effect and effect.gfx:IsAlive() then
+			effect.gfx:Destroy()
+			effect =3D nil
+		end
+	end)
+	=

+	-- effect.speed =3D input:PopNetUint8()
+	-- effect.duration =3D input:PopNetUint8()
+	=

+	--~ print(&quot;DEBUG&quot;,effect.speed,effect.duration)
+	--~ print(&quot;##################################&quot;)
+	printdebug(&quot;effect&quot;,vardump(effect))
+	--~ print(&quot;##################################&quot;)
+	--~ print(&quot;DEBUG current&quot;,effect.current_locx,effect.current_locy,effect.=
current_locz)
+	--~ print(&quot;DEBUG source&quot;,effect.source_locx,effect.source_locy,effect.sou=
rce_locz)
+	--~ print(&quot;DEBUG target&quot;,effect.target_locx,effect.target_locy,effect.tar=
get_locz)
+	--~ print(&quot;##################################&quot;)
+
+	if =

+		effect.current_locx ~=3D effect.target_locx or
+		effect.current_locy ~=3D effect.target_locy or
+		effect.current_locz ~=3D effect.target_locz
+	then
+		-- add stepper to handle effect movement
+		RegisterStepper(function()
+			if not effect or not effect.gfx:IsAlive() then
+				-- i am dead so stop this
+				return true
+			end
+			=

+			if =

+				-- distance from current position to target lower then 0.1
+				math.abs(effect.current_locx - effect.target_locx) &lt; 0.1 and
+				math.abs(effect.current_locy - effect.target_locy) &lt; 0.1 and
+				math.abs(effect.current_locz - effect.target_locz) &lt; 0.1
+			then
+				-- stop moving
+				printdebug(&quot;effect&quot;,&quot;DEBUG STOP&quot;)
+				effect.gfx:Destroy()
+				effect =3D nil
+				return true
+			else
+				-- move
+				=

+				-- current -&gt; target
+				local dx =3D effect.target_locx - effect.current_locx
+				local dy =3D effect.target_locy - effect.current_locy
+				local dz =3D effect.target_locz - effect.current_locz
+				-- to target
+				local len =3D math.sqrt(dx*dx + dy*dy + dz*dz)
+				=

+				local speed =3D effect.speed or gParticleEffectDefaultSpeed
+				=

+				local fps_factor =3D 1 / OgreAvgFPS()
+				local uo_speed_factor =3D 5
+				=

+				-- adjust movement vector
+				dx =3D dx / len * speed * fps_factor * uo_speed_factor
+				dy =3D dy / len * speed * fps_factor * uo_speed_factor
+				dz =3D dz / len * speed * fps_factor * uo_speed_factor
+				-- new motified len
+				local len2 =3D math.sqrt(dx*dx + dy*dy + dz*dz)
+			=

+				if ( len2 &gt; len ) then
+					-- reached the end or &quot;missed&quot;
+					effect.current_locx =3D effect.target_locx
+					effect.current_locy =3D effect.target_locy
+					effect.current_locz =3D effect.target_locz
+				else 			=

+					-- move
+					effect.current_locx =3D effect.current_locx + dx =

+					effect.current_locy =3D effect.current_locy + dy
+					effect.current_locz =3D effect.current_locz + dz
+				end
+				=

+				--~ print(&quot;=3D=3D=3D=3D=3D DEBUG =3D=3D=3D=3D=3D&quot;)
+				--~ print(&quot;DEBUG dx,dy,dz&quot;,dx,dy,dz)
+				--~ print(&quot;DEBUG len,speed,fps&quot;,len,speed,fps_factor)
+				--~ print(&quot;DEBUG current&quot;,effect.current_locx,effect.current_locy,effe=
ct.current_locz)
+				=

+				effect.gfx:SetPosition(self:UOPosToLocal(effect.current_locx + relx,ef=
fect.current_locy + rely,effect.current_locz * 0.1 + relz))
+			end
+		end)
+	end
 end
 =

 --###############################
@@ -310,7 +421,6 @@
 		local r,g,b =3D 0.0, 1.0, 0.0
 		local a =3D 0.3
 		local e =3D 1.0
-
 		mobile.selection =3D CreateRootGfx3D()
 		mobile.selection:SetSimpleRenderable()
 		mobile.selection:SetMaterial(&quot;aura_base&quot;)
@@ -463,8 +573,8 @@
 			-- display the text
 			mobile.chattext.mLastText =3D mobile.mlastChatText
 			mobile.chattext.gfx:SetColour(r,g,b,a)
-			mobile.chattext.gfx:SetFont(gUniFontLoaderType and &quot;font_unifont1&quot; or &quot;=
TrebuchetMSBold&quot;)
-			mobile.chattext.gfx:SetCharHeight(22)
+			mobile.chattext.gfx:SetFont(gUniFontLoaderType and gUniFontName[gChatTe=
xt_UniFontNumber] or &quot;TrebuchetMSBold&quot;)
+			mobile.chattext.gfx:SetCharHeight(gUniFontHeight[gChatText_UniFontNumbe=
r])
 			mobile.chattext.gfx:SetText(mobile.mlastChatText)
 			local w,h =3D mobile.chattext.gfx:GetTextBounds()
 			mobile.chattext.gfx:SetPos(0, 0 - h)
@@ -570,9 +680,11 @@
 --###      DYNAMIC ITEMS      ###
 --###############################
 =

+--[[
 function Renderer3D:DynamicSetVisible (dynamic,bVisible)
 	if (dynamic.gfx) then dynamic.gfx:SetVisible(bVisible) end
 end
+]]--
 =

 function Renderer3D:UpdateDynamicItemPos ( dynamic )
 	if (dynamic.gfx) then
@@ -585,12 +697,49 @@
 end
 =

 function Renderer3D:CreateDynamicGfx( item )
-	item.xadd =3D 0
-	item.yadd =3D 0
-	item.zadd =3D 0
+
+	assert(not item.gfx)
+
+	-- FILTER: get correction
+	item.xadd =3D FilterPositionX(item.artid) or 0
+	item.yadd =3D FilterPositionY(item.artid) or 0
+	item.zadd =3D FilterPositionZ(item.artid) or 0
+
+	-- Detect Multis
 	if item.artid &gt;=3D gMulti_ID then
-		-- multi detected
-		if gMultiLoader then
+		-- Check if Serverside Multi (Custom Multi)
+		print(&quot;-----------------------------&quot;)
+		print(&quot;ARTID&quot;,item.artid,vardump(item))
+		if (item.lTile) then
+			printdebug(&quot;multi&quot;,&quot;Serverside Multi detected&quot;)
+			local rootgfx =3D CreateRootGfx3D()
+			item.lMultiChildGfx =3D {}
+			for k,v in pairs(item.lTile) do
+				-- create model part
+				local child =3D rootgfx:CreateChild()
+				local meshname =3D GetStaticMeshName(v.artid)
+				if meshname then =

+					child:SetMesh(meshname)
+					child:SetRenderingDistance(gCurrentRenderer.gDynamicMaxRenderDist)
+					child:SetPosition(-v.x,v.y,v.z*0.1)
+					child:SetScale(-1,1,1)		-- (-1) thats because xmirror bug and wrong m=
irrored mashes
+					child:SetNormaliseNormals(true)
+					child.xloc =3D -v.x
+					child.yloc =3D v.y
+					child.zloc =3D v.z
+					child.artid =3D v.artid
+					table.insert(item.lMultiChildGfx, child)
+				end
+			end
+			item.gfx =3D rootgfx
+
+			-- FILTER: correction : TODO needed??
+			for k,v in pairs(item.lMultiChildGfx) do item.gfx:SetOrientation(GetSta=
ticMeshOrientation(v.artid)) end
+
+			self:UpdateDynamicItemPos(item)
+		-- otherwise ist a Clientside Multi
+		elseif gMultiLoader then
+			printdebug(&quot;multi&quot;,&quot;Clientside Multi detected&quot;)
 			local rootgfx =3D CreateRootGfx3D()
 			local id =3D item.artid - gMulti_ID
 			=

@@ -603,7 +752,7 @@
 				local blocknum,xloc,yloc,zloc,flags
 				blocknum,xloc,yloc,zloc,flags =3D gMultiLoader:GetMultiParts(id,p)
 				=

-				-- print(&quot;  part&quot;,p,&quot;:&quot;,blocknum,x,y,z,flags)
+				--printdebug(&quot;multi&quot;,&quot;part&quot;,p,&quot;:&quot;,blocknum,xloc,yloc,zloc,flags)
 				=

 				-- skip invisible parts
 				if flags =3D=3D 1 then
@@ -613,7 +762,10 @@
 					if meshname then =

 						child:SetMesh(meshname)
 						child:SetRenderingDistance(self.gDynamicMaxRenderDist)
-						child:SetPosition(-xloc,yloc,zloc*0.1)
+						local x,y,z =3D Renderer3D:UOPosToLocal(xloc,yloc,zloc * 0.1)
+						child:SetPosition(x,y,z)
+						child:SetScale(-1,1,1)			-- (-1) thats because xmirror bug and wrong=
 mirrored mashes
+						child:SetNormaliseNormals(true)
 						child.xloc =3D xloc
 						child.yloc =3D yloc
 						child.zloc =3D zloc
@@ -624,43 +776,75 @@
 					end
 				end
 			end
-			=

-			item.mbIsMulti =3D true
-			=

+			--item.mbIsMulti =3D true
 			item.gfx =3D rootgfx
+
+			-- FILTER: correction : TODO needed??
+			for k,v in pairs(item.lMultiChildGfx) do item.gfx:SetOrientation(GetSta=
ticMeshOrientation(v.artid)) end
+
 			self:UpdateDynamicItemPos(item)
-			-- item.gfx:SetRenderingDistance(self.gDynamicMaxRenderDist)
+
+			print(&quot;+++++++++++++++++++++++++&quot;)
+			print(&quot;ITEM&quot;,vardump(item))
 		else =

 			--printdebug(&quot;missing&quot;,sprintf(&quot;Renderer3D:CreateDynamicGfx: failed loa=
ding mesh for dynamic (multi): artid=3D%i z_typename=3D%s\n&quot;,item.artid or =
-1,item.z_typename or &quot;&quot;))
 		end
-	else =

+	else
 		-- normal 1 part object
 		item.gfx =3D CreateRootGfx3D()
 		meshname =3D (not gForceFallBackBillboards_Dynamics) and GetStaticMeshNa=
me(item.artid + 0*16384,item.hue)
 		if (meshname and meshname ~=3D &quot;&quot;) then
 			item.gfx:SetMesh(meshname)
-			item.gfx:SetScale(-1,1,1)
-			if (CountMeshTriangles(meshname) &lt;=3D 4) then item.zadd =3D self.gDynam=
icZAdd end
+			item.gfx:SetScale(-1,1,1)		-- (-1) thats because xmirror bug and wrong =
mirrored mashes
+			item.gfx:SetNormaliseNormals(true)
+
+			--kTileDataFlag_LightSource
+			if (gLightsources) then
+			local arrtiletype =3D {}
+			arrtiletype =3D GetStaticTileType(item.artid)
+			if( BitwiseAND(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ~=3D=
 0 ) then
+				local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc=
+arrtiletype.miHeight) * 0.1)
+				Client_AddPointLight(x,y,z, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
+			end
+			end
+
+			-- --------------------------------------------------------------------=
-----
+			-- todo: HACK here (zadd because dynamic street-tiles dont look good fl=
ying)
+			if (CountMeshTriangles(meshname) &lt;=3D 4) then =

+				item.gfx:SetCastShadows(false)	-- groundtiles and item billboards shou=
ldn't cast shadows
+				if (gTileTypeLoader) then
+					if not(isSurface( GetStaticTileTypeFlags(item.artid) or 0 )) then
+						item.zadd =3D self.gDynamicZAdd
+						--print(&quot;Surface unter 4 triangles nicht zadd=3D&quot;..item.artid)
+					end
+				end
+			end
+			-- --------------------------------------------------------------------=
-----
+
 		elseif (gEnableFallBackBillboards_Dynamics) then
 			local iTranslatedTileTypeID =3D TranslateTileTypeID(item.artid + 16384,=
 gSeasonSetting)
+
 			--print(&quot;######DYNAMIC MESH NOT FOUND : &quot;,item.artid,iTranslatedTileTyp=
eID)
 			--print(&quot;######&quot;,vardump(GetStaticTileType(item.artid)))
 			-- fallback to billboard with original art or =

 			if (not IsArtBillboardFallBackSkipped(item.artid)) then
 				item.gfx.billboard =3D item.gfx:CreateChild()
-				item.xadd =3D 0.5
-				item.yadd =3D 0.5
-				item.zadd =3D 0.5
+				item.xadd =3D item.xadd + 0.5
+				item.yadd =3D item.yadd + 0.5
+				item.zadd =3D item.zadd + 0.5
 				self:CreateArtBillBoard(item.gfx.billboard,iTranslatedTileTypeID,item.=
hue)
 				--printdebug(&quot;missing&quot;,sprintf(&quot;Renderer3D:CreateDynamicGfx: failed lo=
ading mesh for dynamic: artid=3D%i z_typename=3D%s\n&quot;,item.artid or -1,item=
.z_typename or &quot;&quot;))
 			end
 		end
 		item.gfx:SetRenderingDistance(self.gDynamicMaxRenderDist)
+
+		-- FILTER: correction
+		item.gfx:SetOrientation(GetStaticMeshOrientation(item.artid))
+
 		self:UpdateDynamicItemPos(item)
 	end
 	self:UpdateDynamicVisibility(item)
 end
-
 =

 function Renderer3D:CreateArtBillBoard( gfx,iTranslatedTileTypeID, iHue )
 	local matname =3D GetArtBillBoardMat(iTranslatedTileTypeID,iHue)
@@ -686,8 +870,14 @@
 	self:DestroyDynamicGfx(item)
 end
 =

+-- handle child destroy of Multis
 function Renderer3D:DestroyDynamicGfx (dynamic)
+	-- print(&quot;DEBUG&quot;,&quot;destroy&quot;,vardump(dynamic))
 	if (dynamic.gfx) then
+		if (dynamic.lMultiChildGfx) then
+			for k,child in pairs(dynamic.lMultiChildGfx) do child:Destroy() end
+			dynamic.lMultiChildGfx=3Dnil
+		end
 		dynamic.gfx:Destroy()
 		dynamic.gfx =3D nil
 	end

Modified: branches/knut/data/lua/lib.charcreate.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.charcreate.lua (original)
+++ branches/knut/data/lua/lib.charcreate.lua Wed Aug  1 22:26:16 2007
@@ -124,9 +124,9 @@
 	chardata.skill2value 	=3D hex2num(&quot;0x32&quot;)
 	chardata.skill3 		=3D hex2num(&quot;0x2B&quot;)
 	chardata.skill3value 	=3D hex2num(&quot;0x00&quot;)
-	chardata.skinColor		=3D hex2num(&quot;0x00BF&quot;)
-	chardata.hairStyle		=3D hex2num(&quot;0x2FC1&quot;)
-	chardata.hairColor		=3D hex2num(&quot;0x0034&quot;)
+	chardata.skinColor		=3D hex2num(&quot;0x03EA&quot;) -- 0x03EA(human) 0x00BF(elf)
+	chardata.hairStyle		=3D hex2num(&quot;0x203B&quot;) -- 0x2fcc 0x2044 0x2fbf 0x203B(=
human) 0x2FC1  =

+	chardata.hairColor		=3D hex2num(&quot;0x044E&quot;) -- 0x044E(human) 0x0034(elf)
 	chardata.facialHair		=3D hex2num(&quot;0x0000&quot;)
 	chardata.facialHairColor=3D hex2num(&quot;0x0000&quot;)
 	chardata.location		=3D hex2num(&quot;0x0003&quot;)
@@ -148,6 +148,60 @@
 	]]--
 	return chardata
 end
+
+--[[
+btbn tipps : wolfpack source
+haircolor human : return ( ( color &gt;=3D 0x44E ) &amp;&amp; ( color &lt;=3D 0x47D ) ) =
? true : false;
+haircolor elf : if ( ( color &gt;=3D 0x34 ) &amp;&amp; ( color &lt;=3D 0x39 ) )
+
+ skin color human : return ( ( color &gt;=3D 0x3EA ) &amp;&amp; ( color &lt;=3D 0x422 ) =
) ? true : false;
+
+inline bool isHairsByRace( quint16 model, bool race )
+{
+    if (!race)    // Human's Hairs
+    {
+        return    ( ( ( model &gt;=3D 0x203B ) &amp;&amp; ( model &lt;=3D 0x203D ) ) || =
( ( model &gt;=3D 0x2044 ) &amp;&amp; ( model &lt;=3D 0x204A ) ) ) ? true : false;
+    }
+    else        // Elf's Hairs
+    {
+        return  ( ( ( model &gt;=3D 0x2fbf ) &amp;&amp; ( model &lt;=3D 0x2fc2 ) ) || ( =
( model &gt;=3D 0x2fcc ) &amp;&amp; ( model &lt;=3D 0x2fd1 ) ) ) ? true : false;
+    }
+}
+
+inline bool isHairsByRaceColor( quint16 color, bool race )
+{
+    if (!race)    // Human's Hairs
+    {
+        return ( ( color &gt;=3D 0x44E ) &amp;&amp; ( color &lt;=3D 0x47D ) ) ? true : f=
alse;
+    }
+    else        // Elf's Hairs
+    {
+        // Line 1 of Colors
+        if ( ( color &gt;=3D 0x34 ) &amp;&amp; ( color &lt;=3D 0x39 ) )
+            return true;
+        // Line 2 of Colors
+        else if ( ( color =3D=3D 0x101 ) || ( color =3D=3D 0x6b8 ) || ( co=
lor =3D=3D 0x207 ) || ( color =3D=3D 0x211 ) || ( color =3D=3D 0x26c ) || (=
 color =3D=3D 0x2c3 ) )
+            return true;
+        // Line 3 of Colors
+        else if ( ( color =3D=3D 0x2c9 ) || ( color =3D=3D 0x1e4 ) || ( co=
lor =3D=3D 0x239 ) || ( color =3D=3D 0x369 ) || ( color =3D=3D 0x59d ) || (=
 color =3D=3D 0x853 ) )
+            return true;
+        // Line 4 of Colors
+        else if ( ( ( color &gt;=3D 0x8e ) &amp;&amp; ( color &lt;=3D 0x92 ) ) || ( colo=
r =3D=3D 0x159 ) )
+            return true;
+        // Line 5 of Colors
+        else if ( ( ( color &gt;=3D 0x15a ) &amp;&amp; ( color &lt;=3D 0x15e ) ) || ( co=
lor =3D=3D 0x1bd ) )
+            return true;
+        // Line 6 of Colors
+        else if ( ( color =3D=3D 0x725 ) || ( color =3D=3D 0x58 ) || ( col=
or =3D=3D 0x128 ) || ( color =3D=3D 0x12f ) || ( color =3D=3D 0x1f3 ) || ( =
color =3D=3D 0x251 ) )
+            return true;
+        // Last Lines
+        else if ( ( ( color &gt;=3D 0x31d ) &amp;&amp; ( color &lt;=3D 0x322 ) ) || ( ( =
color &gt;=3D 0x323 ) &amp;&amp; ( color &lt;=3D 0x326 ) ) || ( ( color &gt;=3D 0x386 ) &amp;&amp; (=
 color &lt;=3D 0x38a ) ) )
+            return true;
+        else
+            return false;
+    }
+}
+]]--
 	=

 --[[
 Note: Client Message

Modified: branches/knut/data/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.compass.lua (original)
+++ branches/knut/data/lua/lib.compass.lua Wed Aug  1 22:26:16 2007
@@ -16,7 +16,7 @@
 		gIrisCompassDialog.mapdot 				=3D gIrisCompassDialog.rootwidget:CreateCh=
ild()
 		gIrisCompassDialog.compassframe_static	=3D gIrisCompassDialog.rootwidget=
:<i>CreateChild()
</I> 		gIrisCompassDialog.compassframe_rot		=3D gIrisCompassDialog.rootwidget:C=
reateChild()
-		if (gGroundBlockLoader and gStaticBlockLoader) then
+		if (gGroundBlockLoader and gStaticBlockLoader and gRadarColorLoader) then
 			gIrisCompassDialog.radar			=3D CreateRadar( gGroundBlockLoader, gStatic=
BlockLoader, gRadarColorLoader )
 		end
 		=

@@ -100,7 +100,7 @@
 	gCompassMapH =3D gGroundBlockLoader and gGroundBlockLoader:GetMapH() or 1
 	ZoomCompass(1.0)
 	=

-	if (gGroundBlockLoader and gStaticBlockLoader) then
+	if (gGroundBlockLoader and gStaticBlockLoader and gRadarColorLoader) then
 		gIrisCompassDialog.radar:Destroy()
 		gIrisCompassDialog.radar =3D CreateRadar( gGroundBlockLoader, gStaticBlo=
ckLoader, gRadarColorLoader )
 	end

Modified: branches/knut/data/lua/lib.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.corpse.lua (original)
+++ branches/knut/data/lua/lib.corpse.lua Wed Aug  1 22:26:16 2007
@@ -24,4 +24,30 @@
 or change bodyid to ghost ?
 	   =

 unused ? kPacket_Corpse_Equipment	=3D { id=3Dhex2num(&quot;0x89&quot;) }
+
+this part of 0x89 can be sent more than once, i.e. it's a sequence of item=
 uids and layers...
+BYTE[1] itemLayer =

+BYTE[4] itemID
 ]]--
+
+--[[
+function Update_CorpseContainer(container_serial)
+	local container =3D GetOrCreateContainer(container_serial)
+	container.gumpid =3D hex2num(&quot;0x09&quot;) --hier muss ne gumpid rein
+	=

+	if (not container.dialog) then
+		-- create dialog from scratch
+		local dialog =3D guimaker.MakeSortedDialog()
+		container.dialog =3D dialog
+		dialog.uoContainer =3D container
+		dialog.rootwidget.gfx:SetPos(200,100) -- TODO : choose position
+		dialog.backpane =3D MakeBorderGumpPart(dialog.rootwidget,container.gumpi=
d,0,0)
+		dialog.backpane.mbIgnoreMouseOver =3D false
+		dialog.backpane.onMouseDown =3D function (widget,mousebutton)
+				if (mousebutton =3D=3D 2) then CloseContainer(widget.dialog.uoContaine=
r.serial) end
+				if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartM=
oveDialog(widget.dialog.rootwidget) end
+			end
+	end
+	RefreshContainerItemWidgets(container)
+end
+]]--

Modified: branches/knut/data/lua/lib.data.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.data.lua (original)
+++ branches/knut/data/lua/lib.data.lua Wed Aug  1 22:26:16 2007
@@ -45,7 +45,7 @@
 -- art material loader with caching
 gArtMatCache =3D {}
 function GetArtMat (iArtID,hueid)
-	if (not(hueid)) then hueid=3D0 end
+	if (not(hueid) or (tonumber(hueid) &gt; gMaxHueValue)) then hueid=3D0 end
 	local res =3D gArtMatCache[iArtID..&quot;_&quot;..hueid]
 	if (not res and gArtMapLoader) then
 		res =3D {}
@@ -75,7 +75,7 @@
 -- art material loader with caching
 gArtBillBoardMatCache =3D {}
 function GetArtBillBoardMat (iArtID,hueid)
-	if (not(hueid)) then hueid=3D0 end
+	if (not(hueid) or (hueid &gt; gMaxHueValue)) then hueid=3D0 end
 	local res =3D gArtBillBoardMatCache[iArtID..&quot;_&quot;..hueid]
 	if (res) then return res end
 	-- bPixelExact,bInvertY,bInvertX,bHasAlpha,bEnableLighting,bEnableDepthWr=
ite,HueLoader,iHue
@@ -114,7 +114,7 @@
 -- gump material loader with caching
 gGumpMatCache =3D {}
 function GetGumpMat (iGumpID,hueid)
-	if (not(hueid)) then hueid=3D0 end
+	if (not(hueid) or (hueid &gt; gMaxHueValue)) then hueid=3D0 end
 	local res =3D gGumpMatCache[iGumpID..&quot;_&quot;..hueid]
 	if (not res and gGumpLoader) then
 		res =3D gGumpLoader:CreateMaterial(iGumpID,true,gHueLoader,hueid)

Modified: branches/knut/data/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.debugmenu.lua (original)
+++ branches/knut/data/lua/lib.debugmenu.lua Wed Aug  1 22:26:16 2007
@@ -14,6 +14,7 @@
 gDebugMenuAnimIndex =3D -1 -- (-1) shows rest pos
 gDebugMenuAnimIndex =3D 0
 gDebugMenuModelIndex =3D 1
+gDebugMenuMainGfxPos =3D {-0.5,0.5,-0.15}
 =

 function RepairEquipIndex (arr) =

 	local res =3D {}
@@ -26,6 +27,14 @@
 end
 =

 gDebugTestMobiles =3D {
+	{artid=3D 292 , equipment=3D{}}, --broken llamas_llama_pack (crash) -&gt; ma=
pped to id: 220
+
+	{artid=3D hex2num(&quot;0xA9&quot;) , equipment=3D{}}, --169 broken horse
+	{artid=3D hex2num(&quot;0x317&quot;), equipment=3D{}}, --791 broken horse
+	{artid=3D	hex2num(&quot;0x76&quot;) , equipment=3D{}}, --horse ok
+	{artid=3D	hex2num(&quot;0x78&quot;) , equipment=3D{}}, --horse ok
+
+	{artid=3D hex2num(&quot;0x123&quot;) , equipment=3D{}}, =

 	{artid=3D hex2num(&quot;0xD5&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0xF1&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0xF3&quot;) , equipment=3D{}}, =

@@ -44,14 +53,12 @@
 	{artid=3D	hex2num(&quot;0x72&quot;) , equipment=3D{}}, -- 114 broken =

 	{artid=3D	hex2num(&quot;0x73&quot;) , equipment=3D{}},  -- 115 broken
 	{artid=3D	hex2num(&quot;0xC8&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x78&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0x79&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0x77&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0x90&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0x74&quot;) , equipment=3D{}},  -- 116 broken
 	{artid=3D	hex2num(&quot;0xB2&quot;) , equipment=3D{}},  -- 178 broken
 	{artid=3D	hex2num(&quot;0x84&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x76&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0xB3&quot;) , equipment=3D{}},  -- 179 broken
 	{artid=3D	hex2num(&quot;0xBB&quot;) , equipment=3D{}}, =

 	{artid=3D	hex2num(&quot;0xBC&quot;) , equipment=3D{}}, =

@@ -147,6 +154,7 @@
 	gDebugRootGfx2 =3D CreateRootGfx3D()
 	gDebugModelParts =3D {}
 	=

+	local xadd,yadd,zadd =3D 0,0,0
 	=

 	-- granny =

 	if (gCurDebugMode =3D=3D kDebugMode_Granny) then
@@ -161,6 +169,7 @@
 		CreateMobileModelPartsFromModelIDArray(mobile.body,gDebugRootGfx,gDebugM=
odelParts,modelidarr,iPrimaryHandItem,iSecondaryHandItem)
 		if (gDebugMenuAnimIndex &gt;=3D 0) then MobileStartAnim(mobile,gDebugModelP=
arts,animid,bDoLoop) end
 	end
+	=

 	=

 	-- static =

 	if (gCurDebugMode =3D=3D kDebugMode_Static) then
@@ -170,34 +179,50 @@
 		local meshname =3D GetStaticMeshName(iTileType,iHue)
 		local tricount =3D meshname and CountMeshTriangles(meshname) or 0
 		AddFadeLines(sprintf(&quot;static %04x(=3D%d) hue=3D%d tricount=3D%d %s&quot;,iTil=
eType,iTileType,iHue,tricount,GetStaticTileTypeName(iTileType) or &quot;&quot;))
-		if (meshname) then gDebugRootGfx:SetMesh(meshname) end
+		if (meshname) then
+			gDebugRootGfx:SetMesh(meshname)
+			gDebugRootGfx:SetOrientation(GetStaticMeshOrientation(iTileType))
+			gDebugRootGfx:SetScale(-1,1,1)			-- (-1) thats because xmirror bug and =
wrong mirrored mashes
+			gDebugRootGfx:SetNormaliseNormals(true)
+			-- position adjustment for statics and dynamics
+			xadd =3D FilterPositionX(iTileType) or 0
+			yadd =3D FilterPositionY(iTileType) or 0
+			zadd =3D FilterPositionZ(iTileType) or 0
+		end
 		Renderer3D:CreateArtBillBoard(gDebugRootGfx2,iTileType+16384,iHue)
 	end
 	=

 	--gDebugModelParts[1]:SetDisplaySkeleton(true)
 	gDebugRootGfx:SetVisible(true)
-	gDebugRootGfx:SetPosition(-0.5,0.5,-0.15)
+	local x,y,z =3D unpack(gDebugMenuMainGfxPos)
+	gDebugRootGfx:SetPosition(x + xadd,y + yadd,z + zadd)
 	gDebugRootGfx2:SetVisible(true)
 	gDebugRootGfx2:SetPosition(3,0.5,-0.15)
 end
 =

+function DebugMenuSetParam1	(value) =

+	gDebugMenuModelIndex =3D value
+	DebugMenuShowModel()
+end
+
 function DebugMenuChangeParam1	(delta) =

+	local newval =3D gDebugMenuModelIndex
 	if ((gbShiftDown) and gCurDebugMode =3D=3D kDebugMode_Static) then
 		for i=3D1,math.abs(delta) do
 			local tries =3D 400
 			local add =3D (delta &gt; 0) and 1 or -1
-			gDebugMenuModelIndex =3D gDebugMenuModelIndex + add
-			local meshname =3D GetStaticMeshName(gDebugMenuModelIndex,0)
+			newval =3D newval + add
+			local meshname =3D GetStaticMeshName(newval,0)
 			while (tries &gt; 0 and ((not meshname) or (CountMeshTriangles(meshname) &gt;=
 6))) do
-				gDebugMenuModelIndex =3D gDebugMenuModelIndex + add
-				meshname =3D GetStaticMeshName(gDebugMenuModelIndex,0)
+				newval =3D newval + add
+				meshname =3D GetStaticMeshName(newval,0)
 				tries =3D tries - 1
 			end =

 		end
 	else
-		gDebugMenuModelIndex =3D gDebugMenuModelIndex + delta
-	end
-	DebugMenuShowModel()
+		newval =3D newval + delta
+	end
+	DebugMenuSetParam1(newval)
 end
 =

 function StartDebugMenu ()
@@ -211,7 +236,7 @@
 	Client_SetSkybox(&quot;skybox&quot;) -- cube skybox sunset darksun =

 	Renderer3D:ChangeCamMode(Renderer3D.kCamMode_Third)
 	Renderer3D.gfCamAngV =3D 0.0
-	=

+
 	local cam =3D GetMainCam()
 	--cam:SetFOVy(gfDeg2Rad*45)
 	cam:SetNearClipDistance(0.01) -- old : 1
@@ -222,9 +247,44 @@
 	gPlayerZLoc =3D 0
 	Renderer3D.gThirdPersonDist =3D 4
 	=

+	-- grid
+	if (true) then
+		gDebugGridGfx =3D CreateRootGfx3D()
+		local x,y,z =3D unpack(gDebugMenuMainGfxPos)
+		gDebugGridGfx:SetPosition(x,y,z)
+		local mygfx =3D gDebugGridGfx
+		mygfx:SetSimpleRenderable()
+		mygfx:SetMaterial(&quot;debug_grid_3D&quot;)
+		mygfx:RenderableBegin(2 + 4*9,2 + 4*9,false,false,OT_LINE_LIST)
+		local x,y,z =3D -1,1,2
+		local g =3D 8
+		mygfx:RenderableVertex(0,0,0)
+		mygfx:RenderableVertex(0,0,z)
+		mygfx:RenderableIndex2(0,1)
+		for j=3D0,8 do =

+			local i =3D j-4
+			mygfx:RenderableVertex(i,-g,0)
+			mygfx:RenderableVertex(i, g,0)
+			mygfx:RenderableVertex(-g,i,0)
+			mygfx:RenderableVertex( g,i,0)
+			mygfx:RenderableIndex2(2 + 4*j + 0,2 + 4*j + 1)
+			mygfx:RenderableIndex2(2 + 4*j + 2,2 + 4*j + 3)
+		end
+		mygfx:RenderableEnd()
+	end
+	=

 	DebugMenuShowModel()
 	=

-	UnBindArr({&quot;f&quot;,&quot;g&quot;,&quot;j&quot;,&quot;k&quot;,&quot;h&quot;,&quot;f1&quot;,&quot;f2&quot;,&quot;f3&quot;,&quot;f4&quot;,&quot;f5&quot;,&quot;t&quot;,&quot;b&quot;})
+	UnbindAll()
+
+	Bind(&quot;wheelup&quot;,		function (state) if (not gActiveEditText) then if (state=
 &gt; 0) then gCurrentRenderer:CamChangeZoom( 0.3) end end end)
+	Bind(&quot;wheeldown&quot;,	function (state) if (not gActiveEditText) then if (stat=
e &gt; 0) then gCurrentRenderer:CamChangeZoom(-0.3) end end end)
+	Bind(&quot;c&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then gCurrentRenderer:ChangeCamMode() end end end)
+
+	Bind(&quot;a&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen =

+		gDebugMenuAnimIndex =3D 0 gDebugMenuModelIndex =3D 1 DebugMenuShowModel()
+		end end end)
+
 	Bind(&quot;f&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen =

 		DebugMenuChangeParam1(-1)
 		end end end)
@@ -238,10 +298,6 @@
 		end end end)
 	Bind(&quot;k&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen =

 		gDebugMenuAnimIndex =3D gDebugMenuAnimIndex + 1  DebugMenuShowModel()
-		end end end)
-		=

-	Bind(&quot;h&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen =

-		gDebugMenuAnimIndex =3D 0 gDebugMenuModelIndex =3D 1 DebugMenuShowModel()
 		end end end)
 		=

 	Bind(&quot;f1&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) =
then =

@@ -264,7 +320,10 @@
 	Bind(&quot;f5&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) =
then =

 		DebugMenuChangeParam1( 4096)
 		end end end)
-		=

+	Bind(&quot;f6&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) =
then =

+		ShowDebugMenuArtList(0)
+		end end end)
+--[[	=

 	Bind(&quot;t&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen =

 		if (gCurDebugMode =3D=3D kDebugMode_Static) then
 			if (gEnableSVNRemoveInStaticDebug) then -- BE CAREFUL WITH THAT !!!!  g=
EnableSVNRemoveInStaticDebug
@@ -274,7 +333,7 @@
 			end	=

 		end	=

 		end end end)
-		=

+]]--	=

 	Bind(&quot;b&quot;, function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen =

 		if (gCurDebugMode =3D=3D kDebugMode_Static) then
 			local i =3D gDebugMenuModelIndex
@@ -299,3 +358,55 @@
 	giDebugMenuLastAnimStepTime =3D gMyTicks
 	if (gDebugModelParts and gDebugMenuAnimIndex &gt;=3D 0) then for k,v in pair=
s(gDebugModelParts) do v:AnimAddTime(iTimeSinceLastStepInSeconds) end end
 end
+
+
+function DebugMenuJumpToArtID (iArtID) =

+	gCurDebugMode =3D kDebugMode_Static
+	DebugMenuSetParam1(iArtID)
+end
+
+function ShowDebugMenuArtList (iStart)
+	local rows =3D { =

+		{ {type=3D&quot;Label&quot;,		text=3D&quot;ArtList&quot;}, },
+	}
+	=

+	iStart =3D iStart or 0
+	local iMax =3D gArtMapLoader:GetCount()
+	local w,h =3D 12,6
+	=

+	local pagerow =3D {}
+	local iNext1 =3D math.max(0,math.min(iMax,iStart + w*h))
+	local iPrev1 =3D math.max(0,math.min(iMax,iStart - w*h))
+	local iNext2 =3D math.max(0,math.min(iMax,iStart + w*h*10))
+	local iPrev2 =3D math.max(0,math.min(iMax,iStart - w*h*10))
+	local myblank =3D {type=3D&quot;Label&quot;,		text=3D&quot;&quot;}
+	table.insert(pagerow,{type=3D&quot;Button&quot;,text=3D&quot; &lt;&lt;&lt; &quot;,iNewStart=3DiPrev2,o=
nMouseDown=3Dfunction(widget) widget.dialog:Destroy() ShowDebugMenuArtList(=
widget.iNewStart) end})
+	table.insert(pagerow,{type=3D&quot;Button&quot;,text=3D&quot;  &lt;&lt; &quot;,iNewStart=3DiPrev1,o=
nMouseDown=3Dfunction(widget) widget.dialog:Destroy() ShowDebugMenuArtList(=
widget.iNewStart) end})
+	table.insert(pagerow,{type=3D&quot;Button&quot;,text=3D&quot;  &gt;&gt; &quot;,iNewStart=3DiNext1,o=
nMouseDown=3Dfunction(widget) widget.dialog:Destroy() ShowDebugMenuArtList(=
widget.iNewStart) end})
+	table.insert(pagerow,{type=3D&quot;Button&quot;,text=3D&quot; &gt;&gt;&gt; &quot;,iNewStart=3DiNext2,o=
nMouseDown=3Dfunction(widget) widget.dialog:Destroy() ShowDebugMenuArtList(=
widget.iNewStart) end})
+	for x =3D 5,w-1 do table.insert(pagerow,myblank) end
+	table.insert(pagerow,{type=3D&quot;Button&quot;,text=3D&quot;close&quot;,onMouseDown=3Dfuncti=
on(widget) widget.dialog:Destroy() end})
+	table.insert(rows,pagerow)
+	=

+	=

+	for y =3D 0,h-1 do
+		local row1 =3D {}
+		local row2 =3D {}
+		for x =3D 0,w-1 do =

+			local i =3D iStart + y*w + x
+			if (i &lt; iMax) then
+				table.insert(row1	,MakeUOArtImageForDialog(i,0,48,32))
+				local name =3D GetStaticTileTypeName(i) or &quot;unknown&quot;
+				local label =3D sprintf(&quot;%s\n0x%04x&quot;,string.sub(name,1,6),i)
+				table.insert(row2	,{type=3D&quot;Button&quot;,iArtID=3Di,text=3Dlabel,onMouseDow=
n=3Dfunction(widget) =

+					DebugMenuJumpToArtID(widget.iArtID) end})
+			end
+		end
+		table.insert(rows,row1)
+		table.insert(rows,row2)
+	end
+	=

+	=

+	=

+	guimaker.MakeTableDlg(rows,10,10,true)
+end

Modified: branches/knut/data/lua/lib.devtool.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.devtool.lua (original)
+++ branches/knut/data/lua/lib.devtool.lua Wed Aug  1 22:26:16 2007
@@ -161,7 +161,7 @@
 		local meshpath =3D GetModelPath(i)
 		local texlist =3D meshpath and OgreMeshTextures(meshpath)
 		local texlist =3D texlist and strjoin(&quot;\n&quot;,texlist) or &quot;&quot;
-		table.insert(rows[2]	,MakeUOArtImageForDialog(i))
+		table.insert(rows[2]	,MakeUOArtImageForDialog(i,0,48,48))
 		table.insert(rows[3]	,{type=3D&quot;Label&quot;,	text=3Dsprintf(&quot;%s\n0x%04x(=3D%d)=
\n%s&quot;,GetStaticTileTypeName(i) or &quot;unknown&quot;,i,i,texlist)})
 	end
 	=

@@ -172,7 +172,7 @@
 		local meshpath =3D GetModelPath(i)
 		local texlist =3D meshpath and OgreMeshTextures(meshpath)
 		local texlist =3D texlist and strjoin(&quot;\n&quot;,texlist) or &quot;&quot;
-		table.insert(rows[4]	,MakeUOArtImageForDialog(i))
+		table.insert(rows[4]	,MakeUOArtImageForDialog(i,0,48,48))
 		table.insert(rows[5]	,{type=3D&quot;Label&quot;,	text=3Dsprintf(&quot;%s\n0x%04x(=3D%d)=
\n%s&quot;,GetStaticTileTypeName(i) or &quot;unknown&quot;,i,i,texlist)})
 	end
 	=

@@ -188,12 +188,14 @@
 	local rx =3D math.floor(math.random()*w)
 	local ry =3D math.floor(math.random()*h)
 	=

+	local iTileTypeID,iX,iY,iZ,iHue
 	for x =3D 0,w do
 		for y =3D 0,h do
 			local bx =3D math.mod(x+rx,w)
 			local by =3D math.mod(y+ry,h)
 			gStaticBlockLoader:Load(bx,by) -- params =3D mapblock-pos
 			local iStaticCount =3D gStaticBlockLoader:Count() -- operates on the bl=
ock that was last loaded using :Load()
+
 			for i =3D 0,iStaticCount-1 do
 				iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i) -- opera=
tes on the block that was last loaded using :Load()
 				if (iTileTypeID =3D=3D iSearchTileTypeID) then
@@ -227,13 +229,14 @@
 		local yminblock =3D math.floor( ( y - radius ) / 8 )
 		local ymaxblock =3D math.ceil( ( y + radius ) / 8 )
 		=

+		local iTileTypeID,iX,iY,iZ,iHue
 		for by=3Dyminblock, ymaxblock do
 			for bx=3Dxminblock, xmaxblock do
 				gStaticBlockLoader:Load( bx, by )
 				local iStaticCount =3D gStaticBlockLoader:Count()
-				=

+
 				for i =3D 0,iStaticCount-1 do
-					iTileTypeID, iX, iY, iZ, iHue =3D gStaticBlockLoader:GetStatic( i )
+					iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic( i )
 					local d =3D dist2(x,y,bx*8+iX,by*8+iY)
 					if (d &lt;=3D radius) then
 						local entity =3D {}
@@ -245,7 +248,6 @@
 						entity.id =3D i
 						entity.iTileTypeID =3D iTileTypeID
 						entity.iHue =3D iHue
-					=

 						table.insert( res, entity )
 					end =

 				end

Modified: branches/knut/data/lua/lib.fallback.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.fallback.lua (original)
+++ branches/knut/data/lua/lib.fallback.lua Wed Aug  1 22:26:16 2007
@@ -79,7 +79,7 @@
 			}, imgrow, labelrow, buttonrow
 	}
 	for k,v in pairs(statictypes) do =

-		table.insert(imgrow		,MakeUOArtImageForDialog(k))
+		table.insert(imgrow		,MakeUOArtImageForDialog(k,0,48,48))
 		table.insert(labelrow	,{type=3D&quot;Label&quot;,	text=3Dsprintf(&quot;%s\n0x%04x(=3D%d=
)&quot;,GetStaticTileTypeName(k) or &quot;unknown&quot;,k,k)})
 		table.insert(buttonrow	,{type=3D&quot;Button&quot;,onMouseDown=3Dfunction(widget) =
AddSkippedArtBillboardFallBack(widget.iTileTypeID) end,iTileTypeID=3Dk,text=
=3D&quot;hide&quot;})
 	end
@@ -88,7 +88,8 @@
 	gLastFallBackToolDialog =3D guimaker.MakeTableDlg(rows,100,10,true)
 end
 =

-function MakeUOArtImageForDialog (iTileTypeID,iHue) =

+-- iMaxW,iMaxH : can be nil for unlimited size
+function MakeUOArtImageForDialog (iTileTypeID,iHue,iMaxW,iMaxH) =

 	iHue =3D iHue or 0
 	local iTranslatedTileTypeID =3D TranslateTileTypeID(iTileTypeID + 16384, =
gSeasonSetting)
 	local matname =3D GetArtMat(iTranslatedTileTypeID,iHue)
@@ -96,7 +97,14 @@
 	local w,h =3D GetArtSize(iTranslatedTileTypeID)
 	if (not w or w =3D=3D 0) then w =3D isotilew end
 	if (not h or h =3D=3D 0) then h =3D isotilew end
-	return {type=3D&quot;Img2&quot;,	w=3Dw,h=3Dh,matname=3Dmatname}
+	local tw,th =3D texsize(w),texsize(h)
+	local fw,fh =3D w,h
+	if (iMaxW) then w =3D math.min(iMaxW,w) end
+	if (iMaxH) then h =3D math.min(iMaxH,h) end
+	local offx,offy =3D (fw-w)*0.5,(fh-h)*0.5  -- this is 0,0 if the art is f=
ully visible, centers art if not
+	local u1,v1,u2,v2 =3D offx/tw,offy/th,(offx+w)/tw,(offy+h)/th
+	matname =3D (string.len(matname) &gt; 0) and matname or &quot;BaseWhiteNoLighting&quot;
+	return {type=3D&quot;Img2&quot;,	w=3Dw,h=3Dh,matname=3Dmatname, u1=3Du1,v1=3Dv1,u2=
=3Du2,v2=3Dv2}
 end
 =

 =


Modified: branches/knut/data/lua/lib.gui.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.gui.lua (original)
+++ branches/knut/data/lua/lib.gui.lua Wed Aug  1 22:26:16 2007
@@ -43,25 +43,6 @@
 	else =

 		gBottomLine.text.gfx:SetText(text)
 	end
-end
-
-function DisplayFPS (fps)
-	if (gHideFPS) then return end
-	local text =3D sprintf(&quot;%0.0f&quot;,fps)
-	if (not gFPSField) then
-		local vw,vh =3D GetViewportSize()
-		local w,h =3D 0,12
-		local x,y =3D vw-w,0
-		local col_back =3D {0,0,0,0}
-		local col_text =3D {1,0,0,1}
-		gFPSField =3D guimaker.MyCreateDialog()
-		gFPSField.panel	=3D guimaker.MakeBorderPanel(gFPSField,x,y,w,h,col_back)
-		gFPSField.text	=3D guimaker.MakeText(gFPSField.panel,0,0,text,16,col_tex=
t)
-	else
-		gFPSField.text.gfx:SetText(text)
-	end
-	local tw,th =3D gFPSField.text.gfx:GetTextBounds()
-	gFPSField.text.gfx:SetPos(-tw,0)
 end
 =

 function DisplayMemoryUsage (memoryusage)

Modified: branches/knut/data/lua/lib.guimaker.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.guimaker.lua (original)
+++ branches/knut/data/lua/lib.guimaker.lua Wed Aug  1 22:26:16 2007
@@ -290,8 +290,7 @@
 		widget =3D guimaker.MakeText(parent,0,0,arr.text,12,{0,0,0,1.0})
 	elseif (arr.type =3D=3D &quot;Img2&quot;) then -- texcoords corrected for 2^n
 		widget =3D guimaker.MakePlane(parent,arr.matname,0,0,arr.w,arr.h)
-		local tw,th =3D texsize(arr.w),texsize(arr.h)
-		widget.gfx:SetUV(0,0,arr.w/tw,arr.h/th)
+		widget.gfx:SetUV(arr.u1,arr.v1,arr.u2,arr.v2)
 		widget.mbIgnoreMouseOver =3D true
 	else
 		print(&quot;guimaker.MakeWidgetFromArr : unknown type : &quot;,arr.type)

Modified: branches/knut/data/lua/lib.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.gumpparser.lua (original)
+++ branches/knut/data/lua/lib.gumpparser.lua Wed Aug  1 22:26:16 2007
@@ -21,12 +21,14 @@
 	params.texts =3D {}
 	local dialog =3D gServerSideGump[dialogId]
 	=

-	for k,widget in pairs(dialog.uo_radio) do if (widget.state =3D=3D 1) then=
 table.insert(params.switches,widget.returnmsg) end end
-	for k,widget in pairs(dialog.uo_check) do if (widget.state =3D=3D 1) then=
 table.insert(params.switches,widget.returnmsg) end end
-	for k,widget in pairs(dialog.uo_text) do =

-		table.insert(params.texts,{id=3Dwidget.returnmsg,text=3Dwidget.plaintext=
 or  &quot;&quot;})
+	if (dialog) then
+		for k,widget in pairs(dialog.uo_radio) do if (widget.state =3D=3D 1) the=
n table.insert(params.switches,widget.returnmsg) end end
+		for k,widget in pairs(dialog.uo_check) do if (widget.state =3D=3D 1) the=
n table.insert(params.switches,widget.returnmsg) end end
+		for k,widget in pairs(dialog.uo_text) do =

+			table.insert(params.texts,{id=3Dwidget.returnmsg,text=3Dwidget.plaintex=
t or  &quot;&quot;})
+		end
 	end
-	=

+
 	return params
 end
 =

@@ -169,7 +171,7 @@
 				-- TODO : width, height, background, scrollbar
 				elseif ((command =3D=3D &quot;xmfhtmlgump&quot;) and (table.getn(bToken)&gt;=3D 8))=
 then
 					local msg =3D HtmlParser( gClilocLoader:Get(bToken[6]) )
-					print(&quot;Cliloc Msg (&quot;..bToken[6]..&quot;): &quot;..msg.text)
+--					print(&quot;Cliloc Msg (&quot;..bToken[6]..&quot;): &quot;..msg.text)
 					local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2=
], bToken[3]+gHorizontal_Textcorrection, bToken[4], bToken[5], msg.text, ms=
g.charh, {1.0,1.0,1.0,1.0}, msg.center, msg.div)
 				--xmfhtmlgumpcolor &lt;x&gt; &lt;y&gt; &lt;width&gt; &lt;height&gt; &lt;cliloc-nr&gt; &lt;background&gt; &lt;=
scrollbar&gt; &lt;color&gt;
 				--Description:	&lt;background&gt; and &lt;scrollbar&gt; can be 0 or 1 and define w=
hether the background is transparent and
@@ -177,18 +179,17 @@
 				-- TODO : background, scrollbar, HUE-color
 				elseif ((command =3D=3D &quot;xmfhtmlgumpcolor&quot;) and (table.getn(bToken)&gt;=
=3D 9)) then
 					local msg =3D HtmlParser( gClilocLoader:Get(bToken[6]) )
-					print(&quot;Cliloc Msg (&quot;..bToken[6]..&quot;): &quot;..msg.text)
+--					print(&quot;Cliloc Msg (&quot;..bToken[6]..&quot;): &quot;..msg.text)
 					local widget =3D guimaker.MakeWrappedClippedText (curparent, bToken[2=
], bToken[3]+gHorizontal_Textcorrection, bToken[4], bToken[5], msg.text, ms=
g.charh, {1.0,1.0,1.0,1.0}, msg.center, msg.div)
 				--gumppic &lt;x&gt; &lt;y&gt; &lt;gumpid&gt; [hue=3D353]
 				--Description:  Adds a graphic to the gump, where &lt;id&gt; ist the graphic=
 id of an item.
 				--				Optionaly there is a color parameter. =

 				-- TODO : HUE
 				elseif ((command =3D=3D &quot;gumppic&quot;) and (table.getn(bToken)&gt;=3D 4)) then
-					local widget =3D MakeBorderGumpPart(curparent,bToken[4],bToken[2],bTo=
ken[3])
+					local huenumber=3DbToken[6] or 0
+					local widget =3D MakeBorderGumpPart( curparent, bToken[4], bToken[2],=
 bToken[3], 0, 0, 0, tonumber(huenumber) )
 					widget.mbIgnoreMouseOver =3D false
-					if (bToken[5]=3D=3D&quot;hue&quot; and bToken[6]) then
-						print(&quot;gumppic hue: &quot;..tonumber(bToken[6]))
-					end
+					if (bToken[8]) then print(&quot;gumppic class=3D&quot;..bToken[8]) end
 				--gumppictiled &lt;x&gt; &lt;y&gt; &lt;width&gt; &lt;height&gt; &lt;gumpid&gt;
 				--Description:  Similar to GumpPic, but the gumppic is tiled to the gi=
ven &lt;height&gt; and &lt;width&gt;.
 				elseif ((command =3D=3D &quot;gumppictiled&quot;) and (table.getn(bToken)&gt;=3D 6)=
) then

Modified: branches/knut/data/lua/lib.input.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.input.lua (original)
+++ branches/knut/data/lua/lib.input.lua Wed Aug  1 22:26:16 2007
@@ -175,82 +175,145 @@
 	if bind then bind[1](bind[2]) end
 end
 =

-UnbindAll()
-gLastCursor =3D 0
-
--- soemthing
-Bind(&quot;return&quot;,	function (state) if (state &gt; 0) then gui.ToggleChatLineActi=
ve() end end)
-Bind(&quot;n&quot;,		function (state) if (not gActiveEditText) then ToggleCompass(st=
ate &gt; 0) end end)
-Bind(&quot;komma&quot;,	function (state) if (not gActiveEditText) then if (state &gt; 0=
) then ZoomCompass(gCompassZoomFactor) end end end)
-Bind(&quot;point&quot;,	function (state) if (not gActiveEditText) then if (state &gt; 0=
) then ZoomCompass(1.0/gCompassZoomFactor) end end end)
-Bind(&quot;z&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen ActivateNextRenderer() end end end)
-Bind(&quot;l&quot;,		function (state) if (not gActiveEditText) then gDialog_IrisLogo=
:<i>SetVisible(state &gt; 0) end end)
</I>-Bind(&quot;escape&quot;,	function (state) =

-	if (state &gt; 0) then =

-	if (not gActiveEditText) then =

-		if gTargetModeActive then CancelTargetMode() else Terminate() end =

-	else
-		DeactivateCurEditText()
-	end =

-	end =

-end)
-Bind(&quot;v&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen Client_TakeScreenshot() end end end)
-Bind(&quot;f12&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Client_TakeGridScreenshot() end end end)
-
--- additional movement key handling in WalkStep() (for pressed keys)
-Bind(&quot;right&quot;,   function (state) if (not gActiveEditText) then if (state &gt;=
 0) then CancelAutoWalk() end end end) =

-Bind(&quot;left&quot;,    function (state) if (not gActiveEditText) then if (state &gt;=
 0) then CancelAutoWalk() end end end) =

-Bind(&quot;down&quot;,    function (state) if (not gActiveEditText) then if (state &gt;=
 0) then CancelAutoWalk() end else if (state &gt; 0) then gui.HistoryUpDown(-1=
) end end end) =

-Bind(&quot;up&quot;,              function (state) if (not gActiveEditText) then if =
(state &gt; 0) then CancelAutoWalk() end else if (state &gt; 0) then gui.HistoryU=
pDown(1) end end end) =

-Bind(&quot;u&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen SetAutoWalkTarget() end end end)
-
--- toggel gumps
-Bind(&quot;t&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen ToggleStatusAos() end end end)
-Bind(&quot;k&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen ToggleSkill() end end end)
-Bind(&quot;j&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen ToggleJournal() end end end)
-Bind(&quot;b&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen TogglePlayerBackpack() end end end)
-Bind(&quot;p&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen TogglePlayerPaperdoll() end end end)
-
--- camera controlling
-Bind(&quot;c&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen gCurrentRenderer:ChangeCamMode() end end end)
-Bind(&quot;x&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen gCurrentRenderer:CamChangeZoom( 1) end end end)
-Bind(&quot;y&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen gCurrentRenderer:CamChangeZoom(-1) end end end)
-Bind(&quot;wheelup&quot;,		function (state) if (not gActiveEditText) then if (state =
&gt;<i> 0) then gCurrentRenderer:CamChangeZoom( 0.3) end end end)
</I>-Bind(&quot;wheeldown&quot;,	function (state) if (not gActiveEditText) then if (state=
 &gt; 0) then gCurrentRenderer:CamChangeZoom(-0.3) end end end)
-
--- repeat last command
-Bind(&quot;g&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen gui.RepeatLastChatLine() end end end)
-Bind(&quot;h&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen RepeatLastDoubleClick() end end end)
-
--- select commands
-Bind(&quot;q&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen SelectNearestMobile() end end end)
-Bind(&quot;e&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen SelectNextMobile() end end end)
-Bind(&quot;space&quot;,	function (state) if (not gActiveEditText) then if (state &gt; 0=
) then AttackSelectedMobile() end end end)
-
---
-Bind(&quot;f9&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then DebugPrintCallCount() end end end)
-Bind(&quot;f10&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then ShowDevTool() end end end)
-Bind(&quot;f11&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then ShowFallBackTool() end end end)
-Bind(&quot;tab&quot;,		function (state) if (state &gt; 0) then if (gActWarmode=3D=3DgWa=
rmode_Normal) then Send_CombatMode(gWarmode_Combat) else Send_CombatMode(gW=
armode_Normal) end end end)
-Bind(&quot;m&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) t=
hen MobileDisplayTextOverHead(gPlayerBodySerial,&quot;bla bla bla&quot;) end end end)
-
-if (false) then
-	local commandchar =3D &quot;[&quot;
-	-- runuo macros useful for testing
-	Bind(&quot;f1&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then =

-		--Send_Speech(&quot;[set Hits 12000 self&quot;) =

-		Send_Speech(commandchar..&quot;self set Hits 12000&quot;) =

-		--local playermobile =3D GetPlayerMobile()
-		--if (playermobile) then  gAutoTargetMobile =3D playermobile  end =

+function BindInGameKeys()
+	UnbindAll()
+	gLastCursor =3D 0
+	=

+	-- soemthing
+	Bind(&quot;return&quot;,	function (state) if (state &gt; 0) then gui.ToggleChatLineAct=
ive() end end)
+	Bind(&quot;n&quot;,		function (state) if (not gActiveEditText) then ToggleCompass(s=
tate &gt; 0) end end)
+	Bind(&quot;komma&quot;,	function (state) if (not gActiveEditText) then if (state &gt; =
0) then ZoomCompass(gCompassZoomFactor) end end end)
+	Bind(&quot;point&quot;,	function (state) if (not gActiveEditText) then if (state &gt; =
0) then ZoomCompass(1.0/gCompassZoomFactor) end end end)
+	Bind(&quot;z&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then ActivateNextRenderer() end end end)
+	Bind(&quot;l&quot;,		function (state) if (not gActiveEditText) then gDialog_IrisLog=
o:SetVisible(state &gt; 0) end end)
+	Bind(&quot;escape&quot;,	function (state) =

+		if (state &gt; 0) then =

+		if (not gActiveEditText) then =

+			if gTargetModeActive then CancelTargetMode() else Terminate() end =

+		else
+			DeactivateCurEditText()
+		end =

+		end =

+	end)
+	Bind(&quot;v&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then Client_TakeScreenshot() end end end)
+	Bind(&quot;f12&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Client_TakeGridScreenshot() end end end)
+	=

+	Bind(&quot;f2&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then =

+		local mobile =3D GetPlayerMobile()
+		if mobile then
+			local effect =3D {}
+			effect.source_locx =3D mobile.xloc
+			effect.source_locy =3D mobile.yloc
+			effect.source_locz =3D mobile.zloc
+
+			effect.current_locx =3D mobile.xloc
+			effect.current_locy =3D mobile.yloc
+			effect.current_locz =3D mobile.zloc
+
+			effect.target_locx =3D mobile.xloc + 10
+			effect.target_locy =3D mobile.yloc + 1
+			effect.target_locz =3D mobile.zloc + 2
+			=

+			effect.speed =3D 5
+			effect.duration =3D 0
+			=

+			effect.itemid =3D hex2num(&quot;0x376A&quot;)
+			gCurrentRenderer:AddEffect(effect)
+		end
 	end end end)
-	Bind(&quot;f2&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;self resurrect&quot;) end end end)
-	Bind(&quot;f3&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;add wallofstoneeast&quot;) end end end)
-	Bind(&quot;f4&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;remove&quot;) end end end)
-	Bind(&quot;f5&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;tele&quot;) end end end)
-	Bind(&quot;f6&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;set Hits 12000&quot;) end end end)
-	Bind(&quot;f7&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;resurrect&quot;) end end end)
-	Bind(&quot;f8&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;kill&quot;) end end end)
-	Bind(&quot;f9&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then Send_Speech(commandchar..&quot;admin&quot;) end end end)
-	--Bind(&quot;f10&quot;,		function (state) if (not gActiveEditText) then if (state &gt;=
 0) then Send_Speech(commandchar..&quot;props&quot;) end end end)
-	--Bind(&quot;f11&quot;,		function (state) if (not gActiveEditText) then if (state &gt;=
 0) then Send_Speech(commandchar..&quot;add&quot;) end end end)
-end
+	=

+	-- additional movement key handling in WalkStep() (for pressed keys)
+	Bind(&quot;right&quot;,   function (state) if (not gActiveEditText) then if (state =
&gt;<i> 0) then CancelAutoWalk() end end end) =
</I>
+	Bind(&quot;left&quot;,    function (state) if (not gActiveEditText) then if (state =
&gt;<i> 0) then CancelAutoWalk() end end end) =
</I>
+	Bind(&quot;down&quot;,    function (state) if (not gActiveEditText) then if (state =
&gt;<i> 0) then CancelAutoWalk() end else if (state &gt; 0) then gui.HistoryUpDown(-=
</I>1) end end end) =

+	Bind(&quot;up&quot;,              function (state) if (not gActiveEditText) then if=
 (state &gt; 0) then CancelAutoWalk() end else if (state &gt; 0) then gui.History=
UpDown(1) end end end) =

+	Bind(&quot;u&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then SetAutoWalkTarget() end end end)
+	=

+	-- toggel gumps
+	Bind(&quot;t&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then ToggleStatusAos() end end end)
+	Bind(&quot;k&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then ToggleSkill() end end end)
+	Bind(&quot;j&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then ToggleJournal() end end end)
+	Bind(&quot;b&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then TogglePlayerBackpack() end end end)
+	Bind(&quot;p&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then TogglePlayerPaperdoll() end end end)
+	=

+	-- camera controlling
+	Bind(&quot;c&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then gCurrentRenderer:ChangeCamMode() end end end)
+	Bind(&quot;x&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then gCurrentRenderer:CamChangeZoom( 1) end end end)
+	Bind(&quot;y&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then gCurrentRenderer:CamChangeZoom(-1) end end end)
+	Bind(&quot;wheelup&quot;,		function (state) if (not gActiveEditText) then if (state=
 &gt; 0) then gCurrentRenderer:CamChangeZoom( 0.3) end end end)
+	Bind(&quot;wheeldown&quot;,	function (state) if (not gActiveEditText) then if (stat=
e &gt; 0) then gCurrentRenderer:CamChangeZoom(-0.3) end end end)
+	=

+	-- repeat last command
+	Bind(&quot;g&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then gui.RepeatLastChatLine() end end end)
+	Bind(&quot;h&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then RepeatLastDoubleClick() end end end)
+	=

+	-- select commands
+	Bind(&quot;q&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then SelectNearestMobile() end end end)
+	Bind(&quot;e&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then SelectNextMobile() end end end)
+	Bind(&quot;space&quot;,	function (state) if (not gActiveEditText) then if (state &gt; =
0) then AttackSelectedMobile() end end end)
+	=

+	--
+	Bind(&quot;f10&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then ShowDevTool() end end end)
+	Bind(&quot;f11&quot;,		function (state) if (not gActiveEditText) then if ((state &gt; =
0) and (gCurrentRenderer =3D=3D Renderer3D)) then ShowFallBackTool() end en=
d end)
+	Bind(&quot;tab&quot;,		function (state) if (state &gt; 0) then if (gActWarmode=3D=3DgW=
armode_Normal) then Send_CombatMode(gWarmode_Combat) else Send_CombatMode(g=
Warmode_Normal) end end end)
+	Bind(&quot;m&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then MobileDisplayTextOverHead(gPlayerBodySerial,&quot;bla bla bla&quot;) end end end)
+
+	Bind(&quot;f7&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then
+		if (gAmbientColor.r &lt; 1.0) then
+			gAmbientColor.r=3DgAmbientColor.r+0.1
+			gAmbientColor.g=3DgAmbientColor.g+0.1
+			gAmbientColor.b=3DgAmbientColor.b+0.1
+		else
+			gAmbientColor.r=3D1.0
+			gAmbientColor.g=3D1.0
+			gAmbientColor.b=3D1.0
+		end
+		print(&quot;gAmbientColor.r=3D&quot;..gAmbientColor.r)
+		Client_SetAmbientLight(gAmbientColor.r, gAmbientColor.g, gAmbientColor.b=
, 1)
+ 	end end end)
+		Bind(&quot;f8&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then
+		if (gAmbientColor.r &gt; 0.1) then
+			gAmbientColor.r=3DgAmbientColor.r-0.1
+			gAmbientColor.g=3DgAmbientColor.g-0.1
+			gAmbientColor.b=3DgAmbientColor.b-0.1
+		else
+			gAmbientColor.r=3D0.0
+			gAmbientColor.g=3D0.0
+			gAmbientColor.b=3D0.0
+		end
+		print(&quot;gAmbientColor.r=3D&quot;..gAmbientColor.r)
+		Client_SetAmbientLight(gAmbientColor.r, gAmbientColor.g, gAmbientColor.b=
, 1)
+ 	end end end)
+
+	--[[
+	Bind(&quot;f9&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then =

+		print(&quot;rebuild all securetrades&quot;)
+		for k,mysectrade in pairs(gSecureTrades) do =

+			print(&quot;rebuild sectrade&quot;,mysectrade.id)
+			SecureTradeRebuildContainers(mysectrade)
+		end
+	 end end end)
+	]]--
+
+	if (false) then
+		local commandchar =3D &quot;[&quot;
+		-- runuo macros useful for testing
+		Bind(&quot;f1&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then =

+			--Send_Speech(&quot;[set Hits 12000 self&quot;) =

+			Send_Speech(commandchar..&quot;self set Hits 12000&quot;) =

+			--local playermobile =3D GetPlayerMobile()
+			--if (playermobile) then  gAutoTargetMobile =3D playermobile  end =

+		end end end)
+		Bind(&quot;f2&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;self resurrect&quot;) end end end)
+		Bind(&quot;f3&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;add wallofstoneeast&quot;) end end end)
+		Bind(&quot;f4&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;remove&quot;) end end end)
+		Bind(&quot;f5&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;tele&quot;) end end end)
+		Bind(&quot;f6&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;set Hits 12000&quot;) end end end)
+		Bind(&quot;f7&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;resurrect&quot;) end end end)
+		Bind(&quot;f8&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;kill&quot;) end end end)
+		Bind(&quot;f9&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0=
) then Send_Speech(commandchar..&quot;admin&quot;) end end end)
+		--Bind(&quot;f10&quot;,		function (state) if (not gActiveEditText) then if (state =
&gt;<i> 0) then Send_Speech(commandchar..&quot;props&quot;) end end end)
</I>+		--Bind(&quot;f11&quot;,		function (state) if (not gActiveEditText) then if (state =
&gt;<i> 0) then Send_Speech(commandchar..&quot;add&quot;) end end end)
</I>+	end
+
+end

Modified: branches/knut/data/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.loading.lua (original)
+++ branches/knut/data/lua/lib.loading.lua Wed Aug  1 22:26:16 2007
@@ -8,6 +8,12 @@
 =

 -- loader for uo-art materials
 gManualArtMaterialLoader =3D nil
+
+-- store global uni font infos
+gUniFontHeight =3D {}
+gUniFontName =3D {}
+-- which uni font chat should be used in chat over the head
+gChatText_UniFontNumber =3D 1
 =

 -- profiles the time took by the different loading phases, and displays a =
text about what is currently being loaded
 function LoadingProfile	(sCurAction,bIsPreOgre)
@@ -86,8 +92,11 @@
 	if file_exists(filename) then
 		local l =3D CreateUniFontLoader(filename)
 		l:CreateOgreFont(name)
+		local h =3D l:GetDefaultHeight()
 		l:Destroy()
-	end
+		return h
+	end
+	return 0
 end
 =

 -- load bigger data chunks while menu is visible
@@ -97,7 +106,8 @@
 	if (gUniFontLoaderType) then
 		CreateUniFont(CorrectPath(gUOPath..&quot;unifont.mul&quot;),&quot;font_unifont0&quot;)
 		for i=3D1,2 do
-			CreateUniFont(CorrectPath(gUOPath..&quot;unifont&quot;..i..&quot;.mul&quot;),&quot;font_unifont&quot;=
..i)
+			gUniFontName[i] =3D &quot;font_unifont&quot;..i
+			gUniFontHeight[i] =3D CreateUniFont(CorrectPath(gUOPath..&quot;unifont&quot;..i..=
&quot;.mul&quot;),gUniFontName[i])
 		end
 	end
 	=

@@ -169,25 +179,7 @@
 		modelspath =3D datapath..&quot;models.uim&quot;
 		if (file_exists(modelspath)) then
 			gLegacyModelAndTextureLoader =3D CreateLegacyModelAndTextureLoader(gLeg=
acyModelAndTextureLoaderType,modelspath)
-			=

-			--[[
-			local i =3D 0
-			-- for exporting models from models.uim
-			for i=3D0,20000 do
-				local meshname =3D gLegacyModelAndTextureLoader:CreateMesh(i)
-				if meshname ~=3D nil then
-					local flags,weight,quality,unkn1,unkn2,quantity,animid,unkn3,hue,unkn=
4,height,name =3D gTileTypeLoader:GetStaticTileType(i+32*512)
-					if name =3D=3D nil then name =3D &quot;unknown&quot; end
-					print(&quot;name&quot;,name)
-					name =3D string.lower(name)
-					name =3D string.gsub(name,&quot;%%[^%%]+%%&quot;,&quot;&quot;)
-					name =3D string.gsub(name,&quot;[^a-z0-9]&quot;,&quot;_&quot;)
-					ExportMesh(meshname,GetModelPath(i))
-				end
-			end
-			Crash()
-			]]--
-			=

+			--MeshExporter()
 		else
 			--print(&quot;WARNING ! &quot;..modelspath..&quot; not found, please copy from old iri=
s1 binary distribution on berlios.de&quot;)
 			--print(&quot; statics, such as houses, trees, etc will not be displayed...&quot;)
@@ -255,6 +247,34 @@
 	if (gStaticBlockLoader) then gStaticBlockLoader:Destroy() gStaticBlockLoa=
der =3D nil end
 end
 =

+--todo: Maps_pre6.xml
+function Check_Map (index, mapsfile)
+	local xml_maps =3D xmlchild(LuaXML_ParseFile(datapath..mapsfile),&quot;MAPS&quot;)
+	local xml_map =3D nil
+	=

+	-- search for MAP node with matching ID
+	for k,child in ipairs(xml_maps) do
+		if tonumber(xmlvalue(child,&quot;ID&quot;)) =3D=3D tonumber(index) then
+			-- map found
+			xml_map =3D child
+		end
+	end
+	=

+	-- crash on &quot;map not found&quot;
+	if not xml_map then
+		print(&quot;FATAL map &quot; .. index .. &quot; not found in &quot;..mapsfile)
+		Crash()
+	end
+
+	local mapfilename =3D	xmlchild(xml_map,&quot;MAPFILENAME&quot;)[1]
+
+	if not(file_exists(CorrectPath(gUOPath..mapfilename))) then
+	end
+
+	-- map found, assign it to the global map info
+	return xml_map
+end
+
 function LoadMap (index)
 	gMapLoaded =3D true
 	gMapIndex =3D index
@@ -263,28 +283,17 @@
 	gMapImagePath_Small	=3D datapath..&quot;base/tempmap_&quot;..gMapIndex..&quot;_small_s.t=
ga&quot;
 =

 	if (not gInitialMapLoaded) then LoadingProfile(&quot;load MapInfo&quot;) end
-	=

-	local xml_maps =3D xmlchild(LuaXML_ParseFile(datapath..&quot;xml/Maps.xml&quot;),&quot;M=
APS&quot;)
-	local xml_map =3D nil
-	=

-	-- search for MAP node with matching ID
-	for k,child in ipairs(xml_maps) do
-		if tonumber(xmlvalue(child,&quot;ID&quot;)) =3D=3D tonumber(index) then
-			-- map found
-			xml_map =3D child
-		end
-	end
-	=

-	-- crash on &quot;map not found&quot;
-	if not xml_map then
-		print(&quot;FATAL map &quot; .. index .. &quot; not found in Maps.xml&quot;)
-		Crash()
-	end
-	=

-	-- map found, assign it to the global map info
-	gMapInfo =3D xml_map	-- xmlchild(xml_maps,&quot;MAP&quot;,gMapIndex)
-	=

+
+	-- map found, assign map-array to the global map info
+	gMapInfo =3D Check_Map(index,&quot;xml/Maps.xml&quot;)
 	local mapfilename =3D	xmlchild(gMapInfo,&quot;MAPFILENAME&quot;)[1]
+
+	-- if Mapfile (for example map1.mul) don't exists then load
+	if not( file_exists(CorrectPath(gUOPath..mapfilename)) ) then
+		gMapInfo =3D Check_Map(index,&quot;xml/Maps_pre6.xml&quot;)
+		mapfilename =3D xmlchild(gMapInfo,&quot;MAPFILENAME&quot;)[1]
+	end
+	=

 	local mapheight =3D		xmlchild(gMapInfo,&quot;HEIGHT&quot;)[1]
 	local staidxfilename =3D	xmlchild(gMapInfo,&quot;STAIDXFILENAME&quot;)[1]
 	local staticfilename =3D	xmlchild(gMapInfo,&quot;STATICFILENAME&quot;)[1]

Modified: branches/knut/data/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.mainmenu.lua (original)
+++ branches/knut/data/lua/lib.mainmenu.lua Wed Aug  1 22:26:16 2007
@@ -54,17 +54,17 @@
 		return
 	end
 	=

-	ProtocolSend_Account_Login_Request(gLoginname,gPassword,gServerSeed) -- 0=
x80 kPacket_Account_Login_Request
+	ProtocolSend_Account_Login_Request(gLoginname,gPassword) -- 0x80 kPacket_=
Account_Login_Request
 	-- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
 end
 =

 --gameserverlist selection
 function MainMenuShowServerList (serverlist)
-	if (gPolServer) then gGameServerSlot=3DgGameServerSlot+1 end -- TODO : ob=
solete ??? --pol uses gameserverslot+1
-	=

 	local MySelectServer =3D function(server) =

 		AddFadeLines(sprintf(&quot;connecting to server %s[%d]&quot;,server.name or &quot;???&quot;,=
server.index or 0))
-		printdebug(&quot;login&quot;,&quot;NET: select gameserver&quot;,server.name,server.index,gGa=
meServerSlot)
+		=

+--		ProtocolSend_SystemSpecs()
+		=

 		ProtocolSend_GameServer_Select(server.index or 0) -- 0xA0 kPacket_Server=
_Select =

 		-- answered by kPacket_Server_Redirect 0x8C, =

 		-- which calls ProtocolSend_GameServer_PostLogin kPacket_Post_Login 0x91 =

@@ -103,7 +103,7 @@
 	--check first, if the choose slot is available!
 	=

 	local MySelectChar =3D function(widget) =

-		ProtocolSend_Character_Select(widget.iCharNum + gCharacterSlotAdd,gGameS=
erverAccount)
+		ProtocolSend_Character_Select(widget.iCharNum,gGameServerAccount)
 		widget.dialog:Destroy()
 	end
 	local MyCreateCharTemplatePicker =3D function(widget) =

@@ -225,11 +225,20 @@
 function StartOfflineMode ()
 	gStartGameWithoutNetwork =3D true
 	InitPlainGUI()
+
+	-- Binds key and Inits all InGame-Data
 	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
+
+	-- Unbind some keys only for offline mode (rest is the same as InGame)
+	UnBindArr({&quot;u&quot;,&quot;q&quot;,&quot;e&quot;,&quot;tab&quot;,&quot;r&quot;,&quot;c&quot;,&quot;t&quot;,&quot;k&quot;,&quot;j&quot;,&quot;b&quot;,&quot;p&quot;,&quot;g&quot;,&quot;h&quot;,&quot;y&quot;})
+
 	gCurrentRenderer:InitLocalCam()
 end
 =

 function StartMainMenu ()
+	-- start menu sound
+	SoundPlayMusicById(8)
+
 	local rows =3D {
 		{ {type=3D&quot;Label&quot;,	text=3D&quot;Login:&quot;} }
 	}
@@ -252,6 +261,8 @@
 	table.insert(rows,{ {type=3D&quot;Button&quot;,text=3D&quot;#exit&quot;,onLeftClick=3Dfunctio=
n () Terminate() end } })
 	=

 --	gMainMenuDialog =3D guimaker.MakeTableDlg(rows,10,10)
+
+	MainMenuSetBackground_Sky()
 =

 	if (not(gMainMenuDialog)) then
 		gMainMenuDialog=3Dguimaker.MakeSortedDialog()				--CreateGumpDlgFromGfm(=
datapath..&quot;gfm/main_menu.gfm&quot;)
@@ -318,19 +329,14 @@
 	end
 end
 =

---[[
 function MainMenuSetBackground_Sky ()
 	local cam =3D GetMainCam()
 	cam:SetFOVy(gfDeg2Rad*45)
 	cam:SetNearClipDistance(0.5) -- old : 1
 	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
 	cam:SetProjectionType(0) -- perspective
-	Client_ClearLights()
-	Client_AddDirectionalLight(1,1,-1)
-	Client_SetAmbientLight(0.4, 0.4, 0.4, 1)
-	Client_SetSkybox(&quot;cube&quot;) -- cube skybox sunset darksun =

-	=

-	SetMainMenuCam(0,(90 + 10) * gfDeg2Rad)
+	Client_SetSkybox(&quot;sunset&quot;) -- cleansky skybox sunset darksun =

+	SetMainMenuCam(0,gfDeg2Rad)
 end
 =

 function SetMainMenuCam (roth,rotv)
@@ -342,4 +348,3 @@
 	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
 	GetMainCam():SetRot(w,x,y,z)	=

 end
-]]--

Modified: branches/knut/data/lua/lib.meshexporter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.meshexporter.lua (original)
+++ branches/knut/data/lua/lib.meshexporter.lua Wed Aug  1 22:26:16 2007
@@ -1,22 +1,22 @@
 --ModelExporter
 =

 --just a small function to export all static models from models.uim file
---Exportformat: stone_wall_0x0001.mesh (tiledataname+&quot;_&quot;tileid+&quot;.mesh&quot;)
---.....................................spaces exchanged to &quot;_&quot; and tileid =
into hex
 -- TODO : write material
 -- TODO : export textures too
 function MeshExporter()
-	for i =3D 0, 20000 do
-		--if (i=3D=3Dhex2num(&quot;0x0b59&quot;)) then
-		--	local testid =3D i
-			local meshname =3D GetStaticMeshName(i)
-			print(&quot;Export Model: &quot;,i,meshname)
-			if (meshname) then
-				--local t =3D GetStaticTileType(testid)
-				--local staticname =3D string.gsub(t.msName,&quot;%s&quot;,&quot;_&quot;)
-				--local filename =3D staticname..&quot;_&quot;..sprintf(&quot;0x%04x&quot;,(testid))..&quot;.me=
sh&quot;
-				ExportMesh(meshname,datapath..&quot;models_uim/models/mesh/iris_model_&quot;..i.=
.&quot;.mesh&quot;)
-			end
-		--end
+	local i =3D 0
+	-- for exporting models from models.uim
+	for i=3D0,20000 do
+		local meshname =3D gLegacyModelAndTextureLoader:CreateMesh(i)
+		if meshname ~=3D nil then
+			local flags,weight,quality,unkn1,unkn2,quantity,animid,unkn3,hue,unkn4,=
height,name =3D gTileTypeLoader:GetStaticTileType(i+32*512)
+			if name =3D=3D nil then name =3D &quot;unknown&quot; end
+			print(&quot;name&quot;,name)
+			name =3D string.lower(name)
+			name =3D string.gsub(name,&quot;%%[^%%]+%%&quot;,&quot;&quot;)
+			name =3D string.gsub(name,&quot;[^a-z0-9]&quot;,&quot;_&quot;)
+			ExportMesh(meshname,GetModelPath(i))
+		end
 	end
+	Crash()
 end

Modified: branches/knut/data/lua/lib.modelanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.modelanim.lua (original)
+++ branches/knut/data/lua/lib.modelanim.lua Wed Aug  1 22:26:16 2007
@@ -73,7 +73,9 @@
 	--if (bodyid =3D=3D 400) then bodyid =3D 401 end
 	--if (bodyid =3D=3D 401) then bodyid =3D 400 end
 	local modelinfo =3D GetGrannyModelInfo(bodyid)
+
 	assert(modelinfo,&quot;ERROR bodyinfo for skeleton not found &quot;..tostring(bodyi=
d))
+
 	while (modelinfo.animid ~=3D 0) do modelinfo =3D GetGrannyModelInfo(model=
info.animid) end
 	local skeletonname =3D modelinfo.modelname -- example: &quot;deer_stag&quot;
 	local skeleton =3D gSkeletons[skeletonname]
@@ -129,6 +131,7 @@
 function GetAnimPath (mobileartid,animid) =

 	local bodyid =3D MobileArtId2BodyId(mobileartid)
 	local modelinfo =3D GetGrannyModelInfo(bodyid)
+	if (not modelinfo) then return nil end
 	while (modelinfo.animid ~=3D 0) do modelinfo =3D GetGrannyModelInfo(model=
info.animid) end
 	local animname =3D GetAnimName(bodyid,animid)
 	if (not animname) then return nil end
@@ -144,7 +147,7 @@
 	local bodyid =3D MobileArtId2BodyId(mobileartid)
 	local modelinfo =3D GetGrannyModelInfo(bodyid)
 	while (modelinfo and modelinfo.animid ~=3D 0) do modelinfo =3D GetGrannyM=
odelInfo(modelinfo.animid) end
-	return modelinfo and gAnimInfoLists[modelinfo.typeid] and gAnimInfoLists[=
modelinfo.typeid][animid]
+	return modelinfo and gAnimInfoLists and gAnimInfoLists[modelinfo.typeid] =
and gAnimInfoLists[modelinfo.typeid][animid]
 end
 =

 -- loads an anim info file, like Monster.lst

Modified: branches/knut/data/lua/lib.models.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.models.lua (original)
+++ branches/knut/data/lua/lib.models.lua Wed Aug  1 22:26:16 2007
@@ -62,7 +62,7 @@
 -- and a mysterious ./Others/H_Female_Face_V2_lod2.grn
 -- todo : between female head and face
 =

-gGrannyScaleFactor =3D 0.5
+gGrannyScaleFactor =3D 0.65 --0.5
 =

 -- returns true if female
 function IsBodyIDFemale (bodyid) =

@@ -183,7 +183,9 @@
 =

 -- some tests if the granny model format is as expected (for models, not f=
or anims)
 function CheckGrannyModel	(granny) =

-	if (granny:GetSubMeshCount() ~=3D 1) then print(&quot;WARNING ! unexpected sum=
eshcount &quot;,granny:GetSubMeshCount()) end
+	if (granny:GetSubMeshCount() ~=3D 1) then
+		printdebug(&quot;granny&quot;,&quot;WARNING ! unexpected sumeshcount &quot;,granny:GetSubMes=
hCount())
+	end
 	assert(granny:GetSubMeshCount() &gt;=3D 1,&quot;GetSubMeshCount=3D=3D&quot;..tostring(=
granny:GetSubMeshCount()))
 	assert(granny:GetTextureIDCount() &gt;=3D 1,&quot;GetTextureIDCount=3D=3D&quot;..tostr=
ing(granny:GetTextureIDCount()))
 	if (granny:GetTextureIDCount() &gt; 1) then
@@ -297,15 +299,6 @@
 	return loader
 end
 =

-
-function MobileArtId2BodyId (mobileartid)
-	if (mobileartid =3D=3D  987) then return 400 end --   male admin robe
-	if (mobileartid =3D=3D 1987) then return 401 end -- female admin robe
-	=

-	if (mobileartid =3D=3D 778) then print(&quot;TODO : Mobile 778 doesn't work -&gt;=
 mapping to modelid 16&quot;) return 16 end
-	return mobileartid
-end
-
 -- returns array with granny-model ids for bodyparts and clothing
 function GetMobileModelPartModelIDs (mobile) =

 	local iPrimaryHandItem =3D nil
@@ -347,7 +340,15 @@
 						modelid =3D modelid + kGrannyEquipmentFemaleAdd =

 					end
 					local hue =3D item.hue or 0
-					table.insert(modelidarr,{hue=3Dhue,modelid=3Dmodelid}) =

+					table.insert(modelidarr,{hue=3Dhue,modelid=3Dmodelid})
+					=

+					--local bShieldHand=3Dfalse
+					-- check for shields (if wearable -&gt; take quality as layer) (stupid)
+					--if (BitwiseAND(tiledata.miFlags,kTileDataFlag_Wearable)~=3D0) then
+						--print(&quot;QualityLayer=3D&quot;..tiledata.miQuality..&quot; &quot;..tiledata.msName)
+					--	bShieldHand=3Dtrue
+					--end
+					=

 					local bDoubleHanded =3D (layer =3D=3D kLayer_TwoHanded) and (BitwiseA=
ND(tiledata.miFlags,kTileDataFlag_Weapon) ~=3D 0)
 					if (layer =3D=3D kLayer_OneHanded or bDoubleHanded) then =

 						iPrimaryHandItem =3D {hue=3Dhue,modelid=3Dmodelid}
@@ -375,6 +376,7 @@
 -- creates childnodes of parentgfx and adds inserts them into the partsarr=
 table
 function CreateMobileModelPartsFromModelIDArray (mobileartid,parentgfx,par=
tsarr,modelidarr,iPrimaryHandItem,iSecondaryHandItem) =

 	local bodyid =3D MobileArtId2BodyId(mobileartid)
+
 	local skeleton =3D GetOrCreateSkeleton(bodyid) -- skeleton is determined =
by the bodyid, not possible from the wearables
 	printdebug(&quot;granny&quot;,&quot;CreateMobileModelParts...&quot;,mobileartid,bodyid,skelet=
on.name)
 	local leftHandEntity1
@@ -483,6 +485,10 @@
 function UpdateMobileModel (mobile)
 	if (not gAnimInfoLists) then return end
 	--if (mobile.body ~=3D 400 and mobile.body ~=3D 401) then return end
+
+	-- TODO: Debug and check why RunUO sends kPacket_Equipped_MOB with artid =
=3D=3D Zero
+	if (mobile.artid =3D=3D 0) then return end
+	if (not mobile.equipment) then return end -- happens when being teleported
 	=

 	local mount =3D mobile:getequipment(kLayer_Mount)
 	local modelidarr,iPrimaryHandItem,iSecondaryHandItem =3D GetMobileModelPa=
rtModelIDs(mobile)
@@ -532,7 +538,9 @@
 			--print(&quot;equip&quot;,item.artid,tiledata and tiledata.miAnimID or 0)
 			--local mountbodyid =3D tiledata and tiledata.miAnimID  -- this fails, =
animid is often zero, seems to be hardcoded
 			local mountbodyid =3D gMountTranslate[mount.artid]
-			print(&quot;MOUNT&quot;,mountbodyid,mount.artid)
+
+			printdebug(&quot;granny&quot;,&quot;MOUNT &quot;,mountbodyid,mount.artid)
+
 			if ((not mountbodyid) or mountbodyid =3D=3D 0) then mountbodyid =3D gSt=
andardHorse end
 			--print(&quot;mountbodyid&quot;,mountbodyid,mount.artid)
 			--print(&quot;mount&quot;,mountbodyid,vardump2(mount),tiledata and vardump2(tiled=
ata))
@@ -542,7 +550,7 @@
 				=

 				-- fallback to standard horse mount
 				if (not meshname) then
-					print(&quot;warning, broken mountid, falling back to horse&quot;,mountbodyid)
+					printdebug(&quot;granny&quot;,&quot;warning, broken mountid, falling back to horse &quot;=
,mountbodyid)
 					mountbodyid =3D gStandardHorse
 					mountskeleton =3D GetOrCreateSkeleton(mountbodyid) -- skeleton is det=
ermined by the bodyid, not possible from the wearables
 					meshname =3D GetGrannyMeshName(mountbodyid,mountskeleton.name,mount.h=
ue)					=


Modified: branches/knut/data/lua/lib.mount.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.mount.lua (original)
+++ branches/knut/data/lua/lib.mount.lua Wed Aug  1 22:26:16 2007
@@ -68,3 +68,48 @@
 gMountGrannyOverride[hex2num(&quot;0x31F&quot;)] =3D gStandardHorse
 gMountGrannyOverride[hex2num(&quot;0x11C&quot;)] =3D gStandardHorse
 for k,v in pairs(gMountTranslate) do if (gMountGrannyOverride[v]) then gMo=
untTranslate[k] =3D gMountGrannyOverride[v] end end
+
+--[[
+(tipp from btbn from uox3 code)
+skeletalmount=3D0x3EBB
+darksteed=3D0x3EA9
+etherealhorse=3D0x3EAA
+nightmare=3D0x3EB5
+silversteed=3D0x3EA8
+britwarhorse=3D0x3EB2
+comwarhorse=3D0x3EB1
+minaxwarhorse=3D0x3EAF
+slwarhorse=3D0x3EB0
+unicorn=3D0x3EB4
+kirin=3D0x3EAD
+seahorse=3D0x3EB3
+giantfirebeetle=3D0x3E95
+ethereal_llama=3D0x3EAB
+etherealostard=3D0x3EAC
+nightmare2=3D0x3EA7
+nightmare3=3D0x3EA9
+tdnightmare=3D0x3EB7
+ridgeback=3D0x3EB8
+firesteed=3D0x3E9E
+etherealkirin=3D0x3E9C
+horse1=3D0x3EA2
+etherealunicorn=3D0x3EB4
+etherealridgeback=3D0x3E9A
+etherealswampdragon=3D0x3E98
+etherealbeetle=3D0x3E97
+horse2=3D0x3E9F
+desertostard=3D0x3EA3
+frenziedostard=3D0x3EA4
+forestostard=3D0x3EA5
+llama=3D0x3EA6
+horse3=3D0x3EA0
+horse4=3D0x3EA1
+hiryu=3D0x3E94
+chimera=3D0x3E90  -- also known as reptalon/raptalon ?
+cusidhe=3D0x3E91
+mondainsteed=3D0x3E92
+giantbeetle=3D0x3EBC
+swampdragon=3D0x3EBD
+armorswampdragon=3D0x3EBE
+kirin=3D0x3EAD
+]]--

Modified: branches/knut/data/lua/lib.net.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.net.lua (original)
+++ branches/knut/data/lua/lib.net.lua Wed Aug  1 22:26:16 2007
@@ -30,8 +30,10 @@
 	NetDisconnect()							-- close old connection
 	gMainConnection =3D NetConnect(host,port)
 	if (not gMainConnection) then return false end
-	gSendFifo:PushUint32(key)				--norm. IP from Client, only required for os=
i servers (uncompressed/unencrypted)
 	NetTrafficStep()
+	local out =3D GetSendFIFO()
+	out:PushNetUint32(key)		--IP from Client/or GameAccount, only required fo=
r osi servers (uncompressed/unencrypted)
+	out:SendPacket()
 	return true
 end
 =


Modified: branches/knut/data/lua/lib.packet.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.packet.lua (original)
+++ branches/knut/data/lua/lib.packet.lua Wed Aug  1 22:26:16 2007
@@ -9,7 +9,6 @@
 gPacketType.kPacket_Drop_Object										=3D { id=3Dhex2num(&quot;0x08&quot;) }
 gPacketType.kPacket_Single_Click									=3D { id=3Dhex2num(&quot;0x09&quot;) }
 gPacketType.kPacket_Edit											=3D { id=3Dhex2num(&quot;0x0A&quot;) }
---gPacketType.kPacket_Edit_Area										=3D { id=3Dhex2num(&quot;0x0B&quot;) } -- o=
ld client packet, not used anymore since 4.0.7a
 gPacketType.kPacket_Damage											=3D { id=3Dhex2num(&quot;0x0B&quot;) }
 gPacketType.kPacket_Tile_Data										=3D { id=3Dhex2num(&quot;0x0C&quot;) }
 gPacketType.kPacket_NPC_Data										=3D { id=3Dhex2num(&quot;0x0D&quot;) }
@@ -232,16 +231,14 @@
 gPacketType.kPacket_Mahjong											=3D { id=3Dhex2num(&quot;0xDA&quot;) }
 gPacketType.kPacket_Character_Transfer_Log							=3D { id=3Dhex2num(&quot;0xDB&quot;=
) }
 gPacketType.kPacket_AOSObjProp										=3D { id=3Dhex2num(&quot;0xDC&quot;) } -- si=
ze was not in necro list
-
 -- dd df (compressed gump und buff system)
 gPacketType.kPacket_Compressed_Gump									=3D { id=3Dhex2num(&quot;0xDD&quot;) }
+-- unknown yet
+gPacketType.kPacket_unknownDEpacket									=3D { id=3Dhex2num(&quot;0xDE&quot;) }
+-- buff/debuff packet
+gPacketType.kPacket_BuffDebuff_System								=3D { id=3Dhex2num(&quot;0xDF&quot;) }
 =

 --[[
-
-gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xDD&quot;) }
-gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xDE&quot;) }
-gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xDF&quot;) }
-
 gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xE0&quot;) }
 gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xE1&quot;) }
 gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xE2&quot;) }
@@ -275,5 +272,4 @@
 gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xFD&quot;) }
 gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xFE&quot;) }
 gPacketType.kPacket_								=3D { id=3Dhex2num(&quot;0xFF&quot;) }
-
 ]]--

Modified: branches/knut/data/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.protocol.lua (original)
+++ branches/knut/data/lua/lib.protocol.lua Wed Aug  1 22:26:16 2007
@@ -6,9 +6,9 @@
 -- changed NecroPacketData - (0x0B oldsize=3D&quot;0x010A&quot; , damage packet)
 -- packet sizes from necrotoolz.sourceforge.net/kairpacketguide/index.html=
 (0 means dynamic) contains all sizes from 0x00 to 0xDB
 gNecroPacketData_ID 	=3D {  &quot;0x00&quot;,  &quot;0x01&quot;,  &quot;0x02&quot;,  &quot;0x03&quot;,  &quot;0x04&quot;,  &quot;=
0x05&quot;,  &quot;0x06&quot;,  &quot;0x07&quot;,  &quot;0x08&quot;,  &quot;0x09&quot;,  &quot;0x0A&quot;,  &quot;0x0B&quot;,  &quot;0x0C&quot;,  &quot;0x0=
D&quot;,  &quot;0x0E&quot;,  &quot;0x0F&quot;,  &quot;0x10&quot;,  &quot;0x11&quot;,  &quot;0x12&quot;,  &quot;0x13&quot;,  &quot;0x14&quot;,  &quot;0x15&quot;,=
  &quot;0x16&quot;,  &quot;0x17&quot;,  &quot;0x18&quot;,  &quot;0x19&quot;,  &quot;0x1A&quot;,  &quot;0x1B&quot;,  &quot;0x1C&quot;,  &quot;0x1D&quot;,  &quot;=
0x1E&quot;,  &quot;0x1F&quot;,  &quot;0x20&quot;,  &quot;0x21&quot;,  &quot;0x22&quot;,  &quot;0x23&quot;,  &quot;0x24&quot;,  &quot;0x25&quot;,  &quot;0x2=
6&quot;,  &quot;0x27&quot;,  &quot;0x28&quot;,  &quot;0x29&quot;,  &quot;0x2A&quot;,  &quot;0x2B&quot;,  &quot;0x2C&quot;,  &quot;0x2D&quot;,  &quot;0x2E&quot;,=
  &quot;0x2F&quot;,  &quot;0x30&quot;,  &quot;0x31&quot;,  &quot;0x32&quot;,  &quot;0x33&quot;,  &quot;0x34&quot;,  &quot;0x35&quot;,  &quot;0x36&quot;,  &quot;=
0x37&quot;,  &quot;0x38&quot;,  &quot;0x39&quot;,  &quot;0x3A&quot;,  &quot;0x3B&quot;,  &quot;0x3C&quot;,  &quot;0x3D&quot;,  &quot;0x3E&quot;,  &quot;0x3=
F&quot;,  &quot;0x40&quot;,  &quot;0x41&quot;,  &quot;0x42&quot;,  &quot;0x43&quot;,  &quot;0x44&quot;,  &quot;0x45&quot;,  &quot;0x46&quot;,  &quot;0x47&quot;,=
  &quot;0x48&quot;,  &quot;0x49&quot;,  &quot;0x4A&quot;,  &quot;0x4B&quot;,  &quot;0x4C&quot;,  &quot;0x4D&quot;,  &quot;0x4E&quot;,  &quot;0x4F&quot;,  &quot;=
0x50&quot;,  &quot;0x51&quot;,  &quot;0x52&quot;,  &quot;0x53&quot;,  &quot;0x54&quot;,  &quot;0x55&quot;,  &quot;0x56&quot;,  &quot;0x57&quot;,  &quot;0x5=
8&quot;,  &quot;0x59&quot;,  &quot;0x5A&quot;,  &quot;0x5B&quot;,  &quot;0x5C&quot;,  &quot;0x5D&quot;,  &quot;0x5E&quot;,  &quot;0x5F&quot;,  &quot;0x60&quot;,=
  &quot;0x61&quot;,  &quot;0x62&quot;,  &quot;0x63&quot;,  &quot;0x64&quot;,  &quot;0x65&quot;,  &quot;0x66&quot;,  &quot;0x67&quot;,  &quot;0x68&quot;,  &quot;=
0x69&quot;,  &quot;0x6A&quot;,  &quot;0x6B&quot;,  &quot;0x6C&quot;,  &quot;0x6D&quot;,  &quot;0x6E&quot;,  &quot;0x6F&quot;,  &quot;0x70&quot;,  &quot;0x7=
1&quot;,  &quot;0x72&quot;,  &quot;0x73&quot;,  &quot;0x74&quot;,  &quot;0x75&quot;,  &quot;0x76&quot;,  &quot;0x77&quot;,  &quot;0x78&quot;,  &quot;0x79&quot;,=
  &quot;0x7A&quot;,  &quot;0x7B&quot;,  &quot;0x7C&quot;,  &quot;0x7D&quot;,  &quot;0x7E&quot;,  &quot;0x7F&quot;,  &quot;0x80&quot;,  &quot;0x81&quot;,  &quot;=
0x82&quot;,  &quot;0x83&quot;,  &quot;0x84&quot;,  &quot;0x85&quot;,  &quot;0x86&quot;,  &quot;0x87&quot;,  &quot;0x88&quot;,  &quot;0x89&quot;,  &quot;0x8=
A&quot;,  &quot;0x8B&quot;,  &quot;0x8C&quot;,  &quot;0x8D&quot;,  &quot;0x8E&quot;,  &quot;0x8F&quot;,  &quot;0x90&quot;,  &quot;0x91&quot;,  &quot;0x92&quot;,=
  &quot;0x93&quot;,  &quot;0x94&quot;,  &quot;0x95&quot;,  &quot;0x96&quot;,  &quot;0x97&quot;,  &quot;0x98&quot;,  &quot;0x99&quot;,  &quot;0x9A&quot;,  &quot;=
0x9B&quot;,  &quot;0x9C&quot;,  &quot;0x9D&quot;,  &quot;0x9E&quot;,  &quot;0x9F&quot;,  &quot;0xA0&quot;,  &quot;0xA1&quot;,  &quot;0xA2&quot;,  &quot;0xA=
3&quot;,  &quot;0xA4&quot;,  &quot;0xA5&quot;,  &quot;0xA6&quot;,  &quot;0xA7&quot;,  &quot;0xA8&quot;,  &quot;0xA9&quot;,  &quot;0xAA&quot;,  &quot;0xAB&quot;,=
  &quot;0xAC&quot;,  &quot;0xAD&quot;,  &quot;0xAE&quot;,  &quot;0xAF&quot;,  &quot;0xB0&quot;,  &quot;0xB1&quot;,  &quot;0xB2&quot;,  &quot;0xB3&quot;,  &quot;=
0xB4&quot;,  &quot;0xB5&quot;,  &quot;0xB6&quot;,  &quot;0xB7&quot;,  &quot;0xB8&quot;,  &quot;0xB9&quot;,  &quot;0xBA&quot;,  &quot;0xBB&quot;,  &quot;0xB=
C&quot;,  &quot;0xBD&quot;,  &quot;0xBE&quot;,  &quot;0xBF&quot;,  &quot;0xC0&quot;,  &quot;0xC1&quot;,  &quot;0xC2&quot;,  &quot;0xC3&quot;,  &quot;0xC4&quot;,=
  &quot;0xC5&quot;,  &quot;0xC6&quot;,  &quot;0xC7&quot;,  &quot;0xC8&quot;,  &quot;0xC9&quot;,  &quot;0xCA&quot;,  &quot;0xCB&quot;,  &quot;0xCC&quot;,  &quot;=
0xCD&quot;,  &quot;0xCE&quot;,  &quot;0xCF&quot;,  &quot;0xD0&quot;,  &quot;0xD1&quot;,  &quot;0xD2&quot;,  &quot;0xD3&quot;,  &quot;0xD4&quot;,  &quot;0xD=
5&quot;,  &quot;0xD6&quot;,  &quot;0xD7&quot;,  &quot;0xD8&quot;,  &quot;0xD9&quot;,  &quot;0xDA&quot;,  &quot;0xDB&quot;,  &quot;0xDC&quot;,
-&quot;0xDD&quot;}
+&quot;0xDD&quot;, &quot;0xDE&quot;, &quot;0xDF&quot;}
 gNecroPacketData_Size 	=3D {&quot;0x0068&quot;,&quot;0x0005&quot;,&quot;0x0007&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;=
0x0005&quot;,&quot;0x0005&quot;,&quot;0x0007&quot;,&quot;0x000E&quot;,&quot;0x0005&quot;,&quot;0x000B&quot;,&quot;0x0007&quot;,     &quot;0&quot;,&quot;0x0=
003&quot;,     &quot;0&quot;,&quot;0x003D&quot;,&quot;0x00D7&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x000A&quot;,&quot;0x0006&quot;,&quot;0x0009=
&quot;,&quot;0x0001&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0025&quot;,     &quot;0&quot;,&quot;0x0005&quot;,&quot;=
0x0004&quot;,&quot;0x0008&quot;,&quot;0x0013&quot;,&quot;0x0008&quot;,&quot;0x0003&quot;,&quot;0x001A&quot;,&quot;0x0007&quot;,&quot;0x0014&quot;,&quot;0x0=
005&quot;,&quot;0x0002&quot;,&quot;0x0005&quot;,&quot;0x0001&quot;,&quot;0x0005&quot;,&quot;0x0002&quot;,&quot;0x0002&quot;,&quot;0x0011&quot;,&quot;0x000F=
&quot;,&quot;0x000A&quot;,&quot;0x0005&quot;,&quot;0x0001&quot;,&quot;0x0002&quot;,&quot;0x0002&quot;,&quot;0x000A&quot;,&quot;0x028D&quot;,     &quot;0&quot;,&quot;=
0x0008&quot;,&quot;0x0007&quot;,&quot;0x0009&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;0x0025&quot;,    =
 &quot;0&quot;,&quot;0x00C9&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0229&quot;,&quot;0x02C9&quot;,&quot;0x0005&quot;,     &quot;0&quot;,&quot;0x000B=
&quot;,&quot;0x0049&quot;,&quot;0x005D&quot;,&quot;0x0005&quot;,&quot;0x0009&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0006&quot;,&quot;0x0002&quot;, =
    &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;0x000C&quot;,&quot;0x0001&quot;,&quot;0x000B&quot;,&quot;0x006E&quot;,&quot;0x0=
06A&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0004&quot;,&quot;0x0002&quot;,&quot;0x0049&quot;,     &quot;0&quot;,&quot;0x0031&quot;,&quot;0x0005=
&quot;,&quot;0x0009&quot;,&quot;0x000F&quot;,&quot;0x000D&quot;,&quot;0x0001&quot;,&quot;0x0004&quot;,     &quot;0&quot;,&quot;0x0015&quot;,     &quot;0&quot;, =
    &quot;0&quot;,&quot;0x0003&quot;,&quot;0x0009&quot;,&quot;0x0013&quot;,&quot;0x0003&quot;,&quot;0x000E&quot;,     &quot;0&quot;,&quot;0x001C&quot;,    =
 &quot;0&quot;,&quot;0x0005&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x0023&quot;,&quot;0x0010&quot;,&quot;0x0011&quot;,     &quot;0&quot;,&quot;0x0009=
&quot;,     &quot;0&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x000D&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x003E&quot;,     &quot;0&quot;,&quot;=
0x0002&quot;,&quot;0x0027&quot;,&quot;0x0045&quot;,&quot;0x0002&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0042&quot;,     &quot;0&quot;,    =
 &quot;0&quot;,     &quot;0&quot;,&quot;0x000B&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0013&quot;,&quot;0x0041&quot;,     &quot;0=
&quot;,&quot;0x0063&quot;,     &quot;0&quot;,&quot;0x0009&quot;,     &quot;0&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x001A&quot;,     &quot;0&quot;,&quot;=
0x0102&quot;,&quot;0x0135&quot;,&quot;0x0033&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0003&quot;,&quot;0x0009&quot;,&quot;0x0009&quot;,&quot;0x0=
009&quot;,&quot;0x0095&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0004&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0005&quot;,     &quot;0=
&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x000D&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;, =
    &quot;0&quot;,&quot;0x0040&quot;,&quot;0x0009&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0003&quot;,&quot;0x0006&quot;,&quot;0x0009&quot;,&quot;0x0=
003&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0024&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0006=
&quot;,&quot;0x00CB&quot;,&quot;0x0001&quot;,&quot;0x0031&quot;,&quot;0x0002&quot;,&quot;0x0006&quot;,&quot;0x0006&quot;,&quot;0x0007&quot;,     &quot;0&quot;,&quot;=
0x0001&quot;,     &quot;0&quot;,&quot;0x004E&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;0x0019&quot;,     &quot;0&quot;,     &quot;0&quot;,    =
 &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x010C&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0009&quot;,
-&quot;0&quot;}
+&quot;0&quot;, &quot;0&quot;, &quot;0&quot;}
 gNecroPacketSize =3D {}
 for i =3D 1,table.getn(gNecroPacketData_ID) do =

 	gNecroPacketSize[hex2num(gNecroPacketData_ID[i])] =3D hex2num(gNecroPacke=
tData_Size[i]) =

@@ -43,6 +43,8 @@
 	dofile(libpath .. &quot;net.securetrade.lua&quot;)
 	dofile(libpath .. &quot;net.walk.lua&quot;)
 	dofile(libpath .. &quot;net.world.lua&quot;)
+	dofile(libpath .. &quot;net.customhouse.lua&quot;)
+	dofile(libpath .. &quot;net.corpse.lua&quot;)
 =

 	=

 	--OldIrisPacketLenTest()
@@ -238,3 +240,4 @@
 	out:PushNetUint32(serial)
 	out:SendPacket()
 end
+

Modified: branches/knut/data/lua/lib.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.skill.lua (original)
+++ branches/knut/data/lua/lib.skill.lua Wed Aug  1 22:26:16 2007
@@ -262,7 +262,7 @@
 				skill.index =3D listindex	-- index in the skilllist
 				listindex =3D listindex + 1
 				=

-				vardump(skill)
+				printdebug(&quot;skill&quot;,&quot;Skill &quot;..vardump(skill))
 				table.insert(dialog.lSkill,skill)
 			end
 		end

Modified: branches/knut/data/lua/lib.sound.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.sound.lua (original)
+++ branches/knut/data/lua/lib.sound.lua Wed Aug  1 22:26:16 2007
@@ -1,38 +1,41 @@
-glSound =3D {}
+glSoundEffect =3D {}
 gSoundSystem =3D nil
 gSoundMusic =3D nil
 gSoundMusicLoop =3D true
 gSoundMusicCurrent =3D nil
 =

 function SoundInit(name,frequency)
-	SoundDone()
-	gSoundSystem =3D CreateSoundSystem(name,frequency)
-	if gSoundSystem then gSoundSystem:SetDistanceFactor(1) end
+	printdebug(&quot;sound&quot;,sprintf(&quot;SoundInit(%s,%f)\n&quot;,name,frequency))
+	if gSoundSystem then SoundDone() end
+	gSoundSystem =3D CreateSoundSystem(name,frequency)
+	if gSoundSystem then
+		SoundStep()
+		gSoundSystem:SetDistanceFactor(1)
+	end
 end
 =

 function SoundDone()
+	printdebug(&quot;sound&quot;,sprintf(&quot;SoundDone()\n&quot;))
 	if gSoundSystem then gSoundSystem:Destroy() end
 end
 =

 function SoundSetListenerPosition(x,y,z)
 	if gSoundSystem then
 		printdebug(&quot;sound&quot;,sprintf(&quot;SoundSetListenerPosition(%f,%f,%f)\n&quot;,x,y,z))
-		-- TODO fmod sound position seems not wo work =

-		-- gSoundSystem:SetListenerPosition(x,y,z)
-		gSoundSystem:SetListenerPosition(0,0,0)
+		gSoundSystem:SetListenerPosition(x,y,z)
 	end
 end
 =

 -- just adds a sound effect to the global effect list
 function AddSound(effect)
-	table.insert(glSound, effect)
+	table.insert(glSoundEffect, effect)
 end
 =

--- removes all not playing sounds from glSound
+-- removes all not playing sounds from glSoundEffect
 function FlushSoundEffects()
-	for k,o in pairs(glSound) do =

+	for k,o in pairs(glSoundEffect) do =

 		if not o:IsPlaying() then
-			table.remove(glSound, k)
+			table.remove(glSoundEffect, k)
 			o:Destroy()
 		end
 	end
@@ -40,7 +43,7 @@
 =

 function IsSoundEffectPlaying()
 	local playing =3D 0
-	for k,o in pairs(glSound) do =

+	for k,o in pairs(glSoundEffect) do =

 		if o:IsPlaying() then playing =3D playing + 1 end
 	end
 	=

@@ -73,92 +76,100 @@
 =

 function SoundPlayMusic(file)
 	if gSoundSystem then
-		if gSoundMusic then
-			gSoundMusic:Stop()
-			gSoundMusic =3D nil
-		end
-		=

+		SoundStopMusic()
 		gSoundMusic =3D gSoundSystem:CreateSoundSourceFromFile(file)
 		gSoundMusic:Play()
 	end
 end
 =

+function SoundStopMusic()
+	if gSoundSystem then
+		if gSoundMusic then
+			gSoundMusic:Stop()
+			gSoundMusic =3D nil
+		end
+	end
+end
+
 function SoundPlayEffect(x,y,z,effect)
-	if gSoundSystem then
-		printdebug(&quot;sound&quot;,sprintf(&quot;SoundPlayEffect(%f,%f,%f,%i)\n&quot;,x,y,z,effect=
))
-		FlushSoundEffects()
-		-- TODO fmod sound position seems not wo work =

-		-- local e =3D gSoundSystem:CreateSoundSource3DFromEffect(gSoundLoader,x=
,y,z,effect)
-		local e =3D gSoundSystem:CreateSoundSource3DFromEffect(gSoundLoader,0,0,=
0,effect)
-		if e then
-			e:SetMinMaxDistance(5,1000)
-			-- glSound:SetReferenceDistance(100)
-			e:Play()
-			printdebug(&quot;sound&quot;,&quot;volume&quot;)
-			printdebug(&quot;sound&quot;,e:GetVolume())
-			printdebug(&quot;sound&quot;,&quot;position&quot;)
-			printdebug(&quot;sound&quot;,e:GetPosition())
-			printdebug(&quot;sound&quot;,&quot;listener&quot;)
-			printdebug(&quot;sound&quot;,gSoundSystem:GetListenerPosition())
-			AddSound(e)
+	if gSoundLoader then
+		if gSoundSystem then
+			printdebug(&quot;sound&quot;,sprintf(&quot;SoundPlayEffect(%f,%f,%f,%i)\n&quot;,x,y,z,effec=
t))
+			FlushSoundEffects()
+			local e =3D gSoundSystem:CreateSoundSource3DFromEffect(gSoundLoader,x,y=
,z,effect)
+			if e then
+				e:SetMinMaxDistance(50,100000)
+				-- glSoundEffect:SetReferenceDistance(100)
+				e:Play()
+				printdebug(&quot;sound&quot;,&quot;volume&quot;)
+				printdebug(&quot;sound&quot;,e:GetVolume())
+				printdebug(&quot;sound&quot;,&quot;position&quot;)
+				printdebug(&quot;sound&quot;,e:GetPosition())
+				printdebug(&quot;sound&quot;,&quot;listener&quot;)
+				printdebug(&quot;sound&quot;,gSoundSystem:GetListenerPosition())
+				AddSound(e)
+			end
 		end
 	end
 end
 =

 function SoundPlayMusicById(musicid)
-	printdebug(&quot;sound&quot;,sprintf(&quot;SoundPlayMusicById(%s)\n&quot;,musicid))
-	local config =3D CorrectPath(gUOPath..&quot;Music/Digital/Config.txt&quot;)
-	local mp3 =3D nil
-	local loop =3D nil
-	local file =3D nil
-	=

-	-- TODO : not Config.txt not available if midi only, see ticket #32
-	if ((not config) or config =3D=3D &quot;&quot; or (not file_exists(config))) then r=
eturn end
-	=

-	-- parse uo sound config file
-	for line in io.lines(config) do
-		local id,loop,name
-		local poss =3D string.find(line,&quot; &quot;)
-		local posc =3D string.find(line,&quot;,&quot;)
+	if gUseMusic then
+		printdebug(&quot;sound&quot;,sprintf(&quot;SoundPlayMusicById(%s)\n&quot;,musicid))
+		local config =3D CorrectPath(gUOPath..&quot;Music/Digital/Config.txt&quot;)
+		local mp3 =3D nil
+		local loop =3D nil
+		local file =3D nil
 		=

-		if poss then
-			if posc =3D=3D nil then
-				-- no loop specified
-				loop =3D 0
-				id =3D string.sub(line,0,poss-1)
-				name =3D string.sub(line,poss+1)
-			else
-				loop =3D 1
-				id =3D string.sub(line,0,poss-1)
-				name =3D string.sub(line,poss+1,posc-1)
-			end
+		-- TODO : not Config.txt not available if midi only, see ticket #32
+		if ((not config) or config =3D=3D &quot;&quot; or (not file_exists(config))) then =
return end
+		=

+		-- parse uo sound config file
+		for line in io.lines(config) do
+			local id,loop,name
+			local poss =3D string.find(line,&quot; &quot;)
+			local posc =3D string.find(line,&quot;,&quot;)
 			=

-			if tonumber(id) =3D=3D musicid then
-				printdebug(&quot;sound&quot;,&quot;id=3D&quot;,id,&quot; name=3D&quot;,name,&quot; loop=3D&quot;,loop,&quot; file=
=3D&quot;,file)
-				if (string.find(string.lower(name),&quot;.mp3&quot;) =3D=3D nil) then
-					-- add mp3 suffix
-					file =3D CorrectPath(gUOPath..&quot;Music/Digital/&quot;..name..&quot;.mp3&quot;)
+			if poss then
+				if posc =3D=3D nil then
+					-- no loop specified
+					loop =3D 0
+					id =3D trim(string.sub(line,0,poss-1))
+					name =3D trim(string.sub(line,poss+1))
 				else
-					-- mp3 suffix aready present
-					file =3D CorrectPath(gUOPath..&quot;Music/Digital/&quot;..name)
+					loop =3D 1
+					id =3D trim(string.sub(line,0,poss-1))
+					name =3D trim(string.sub(line,poss+1,posc-1))
 				end
 				=

-				if loop =3D=3D 1 then
-					gSoundMusicLoop =3D true
-				else =

-					gSoundMusicLoop =3D false
+				if tonumber(id) =3D=3D musicid then
+					if (string.find(string.lower(name),&quot;.mp3&quot;) =3D=3D nil) then
+						-- add mp3 suffix
+						file =3D CorrectPath(gUOPath..&quot;Music/Digital/&quot;..name..&quot;.mp3&quot;)
+					else
+						-- mp3 suffix aready present
+						file =3D CorrectPath(gUOPath..&quot;Music/Digital/&quot;..name)
+					end
+					=

+					printdebug(&quot;sound&quot;,sprintf(&quot;load sound id=3D%d name=3D%s loop=3D%d fi=
le=3D%s\n&quot;,id,name,loop,file))
+					=

+					if loop =3D=3D 1 then
+						gSoundMusicLoop =3D true
+					else =

+						gSoundMusicLoop =3D false
+					end
 				end
 			end
 		end
-	end
-	=

-	if file and (not gSoundMusicCurrent or gSoundMusicCurrent ~=3D file) then
-		-- play it :) only if new or other sound
-		if file_exists(file) then
-			SoundPlayMusic(file)
-			gSoundMusicCurrent =3D file
-		else =

-			print(&quot;ERROR sound file not found: &quot;..file)
+		=

+		if file and (not gSoundMusicCurrent or gSoundMusicCurrent ~=3D file) then
+			-- play it :) only if new or other sound
+			if file_exists(file) then
+				SoundPlayMusic(file)
+				gSoundMusicCurrent =3D file
+			else =

+				print(&quot;ERROR sound file not found: &quot;..file)
+			end
 		end
 	end
 end

Modified: branches/knut/data/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.spellbooks.lua (original)
+++ branches/knut/data/lua/lib.spellbooks.lua Wed Aug  1 22:26:16 2007
@@ -1,6 +1,23 @@
 -- Spellbook definitions
 -- TODO: update definition needed
 =

+--RunUO1 old_spellbook Items
+--[[
+NET: Old_Spellbook: serial=3D0x41b72b8a itemId=3D0xffff offset=3D0x0000
+container=3D0x41b72b8a item.serial=3D0x7fffffff artid=3D0x0000 artid_stack=
=3D0 item.amount=3D1
+container=3D0x41b72b8a item.serial=3D0x7ffffffc artid=3D0x0000 artid_stack=
=3D0 item.amount=3D4
+container=3D0x41b72b8a item.serial=3D0x7ffffffb artid=3D0x0000 artid_stack=
=3D0 item.amount=3D5
+container=3D0x41b72b8a item.serial=3D0x7ffffffa artid=3D0x0000 artid_stack=
=3D0 item.amount=3D6
+container=3D0x41b72b8a item.serial=3D0x7ffffff5 artid=3D0x0000 artid_stack=
=3D0 item.amount=3D11
+container=3D0x41b72b8a item.serial=3D0x7ffffff4 artid=3D0x0000 artid_stack=
=3D0 item.amount=3D12
+container=3D0x41b72b8a item.serial=3D0x7ffffff0 artid=3D0x0000 artid_stack=
=3D0 item.amount=3D16
+container=3D0x41b72b8a item.serial=3D0x7fffffee artid=3D0x0000 artid_stack=
=3D0 item.amount=3D18
+container=3D0x41b72b8a item.serial=3D0x7fffffec artid=3D0x0000 artid_stack=
=3D0 item.amount=3D20
+container=3D0x41b72b8a item.serial=3D0x7fffffea artid=3D0x0000 artid_stack=
=3D0 item.amount=3D22
+container=3D0x41b72b8a item.serial=3D0x7fffffe4 artid=3D0x0000 artid_stack=
=3D0 item.amount=3D28
+container=3D0x41b72b8a item.serial=3D0x7fffffe3 artid=3D0x0000 artid_stack=
=3D0 item.amount=3D29
+container=3D0x41b72b8a item.serial=3D0x7fffffe2 artid=3D0x0000 artid_stack=
=3D0 item.amount=3D30
+]]--
 function Convert_Spellbookcontainer(matrix,container)
 	if (container.items) then
 		for k,v in pairs(container.items) do
@@ -34,18 +51,23 @@
 gAvailSpellbooks =3D {}
 function Open_Spellbook(spellbook)
 	local dialog =3D gAvailSpellbooks[spellbook.serial]
-	if (dialog) then printf(&quot;Spellbook found serial=3D0x%08x\n&quot;,spellbook.ser=
ial) end
+	if (dialog and not(spellbook.old)) then
+		printf(&quot;Spellbook Container already exists. Delete this Container. seria=
l=3D0x%08x\n&quot;,spellbook.serial)
+		dialog:SetVisible(false)
+		gAvailSpellbooks[dialog.spellbookserial]=3Dnil
+		dialog =3D nil
+	end
 	if (not(dialog)) then
 		dialog =3D guimaker.MakeSortedDialog()
 		dialog.Close =3D function (dialog)
-	        -- TODO : close this properly, destroy widgets etc... =

-	        dialog:SetVisible(false)
+			-- TODO : close this properly, destroy widgets etc... =

+			dialog:SetVisible(false)
 			gAvailSpellbooks[dialog.spellbookserial]=3Dnil
 			dialog =3D nil
 		end
 =

 		--Mapping for Old_Spellbook package
-		if ( gServerType[gServerEmulator]~=3D&quot;RunUO&quot; ) then
+		if (spellbook.old) then
 			if (spellbook.itemid =3D=3D hex2num(&quot;0xffff&quot;)) then
 				-- check and get invisible spellbook container with spellbook items (s=
crolls)
 				local container =3D GetOrCreateContainer(spellbook.serial)

Modified: branches/knut/data/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.static.lua (original)
+++ branches/knut/data/lua/lib.static.lua Wed Aug  1 22:26:16 2007
@@ -8,10 +8,19 @@
 end
 =

 -- returns path to the model file, for importing
--- TODO handle custom stuff?
-function GetModelPath(id)
+gCustomModelCache =3D {}
+function GetModelPath(id) =

+	local cached =3D gCustomModelCache[id]
+	if (cached) then return cached end
+
 	local base =3D id - math.mod(id,1000) + 1000
-	return sprintf(datapath..&quot;models/models/to_%06d/mdl_%06d.mesh&quot;,base,id)
+	local relpath  =3D sprintf(&quot;models/to_%06d/mdl_%06d.mesh&quot;,base,id)
+	local custompath =3D datapath..&quot;custom/&quot;..relpath
+	if file_exists(custompath) then gCustomModelCache[id] =3D custompath  ret=
urn custompath end
+
+	local meshpath =3D datapath..&quot;models/&quot;..relpath
+	gCustomModelCache[id] =3D meshpath  =

+	return meshpath
 end
 =

 gHasModelOnlyOneUoArtCache =3D {}
@@ -54,22 +63,31 @@
 	end
 end
 =

--- generates or retrieves mehsname for static model
+-- generates or retrieves meshname for static model
 -- TODO : not flexible enough, what if model should be skipped, or multipl=
e models set ? or model depending on surrounding ?
 gLegacyModelCache =3D {}
 function GetStaticMeshName (iTileTypeID,iHue)
+	--1st: Seasonal Translation
+	local iTranslatedTileTypeID =3D TranslateTileTypeID(iTileTypeID, gSeasonS=
etting)
+
+	-- FILTER: map Mesh to other Mesh
+	iTranslatedTileTypeID =3D FilterMesh(iTranslatedTileTypeID)
+
+	-- FILTER: static water
+	iTranslatedTileTypeID =3D FilterStaticWater(iTranslatedTileTypeID)
+	=

 	-- hue default value is 0
 	iHue =3D iHue or 0
-	=

-	local meshname =3D gLegacyModelCache[iTileTypeID..&quot;_&quot;..iHue]
+
+	local meshname =3D gLegacyModelCache[iTranslatedTileTypeID..&quot;_&quot;..iHue]
 	if (meshname =3D=3D nil) then
-		=

-		--Seasonal Translation
-		local iTranslatedTileTypeID =3D TranslateTileTypeID(iTileTypeID, gSeason=
Setting)
-		=

 		-- try to load the new models
 		if gUseNewModelLoader then
-			meshname =3D GetModelName(iTranslatedTileTypeID) -- &quot;mdl_&quot;..iTileTypeID=
..&quot;.mesh&quot;
+
+			if (not meshname) then
+				meshname =3D GetModelName(iTranslatedTileTypeID) -- &quot;mdl_&quot;..iTileTypeI=
D..&quot;.mesh&quot;
+			end
+
 			-- mesh available?
 			printdebug(&quot;static&quot;,&quot;query model&quot;,meshname)
 			if not OgreMeshAvailable(meshname) then =

@@ -88,8 +106,14 @@
 						gManualArtMaterialLoader:CreateMatchingIfUnavailable(v)
 					end
 				end
-				=

-				HueMesh(meshname,gHueLoader,iHue)
+				-- Hue this Model | TODO : Partitial Hue
+				if (gHueLoader) then
+					if( BitwiseAND(GetStaticTileTypeFlags(iTranslatedTileTypeID) or 0,kTi=
leDataFlag_Partial_Hue) ~=3D 0 ) then
+						printdebug(&quot;static&quot;,&quot;parthuedmodel=3D&quot;,iTranslatedTileTypeID)
+					else
+						HueMesh(meshname,gHueLoader,iHue)
+					end
+				end
 			end
 		end
 		=

@@ -97,16 +121,16 @@
 			meshname =3D gLegacyModelAndTextureLoader:CreateMesh(iTranslatedTileTyp=
eID)
 			printdebug(&quot;static&quot;,&quot;used OLD model loader:&quot;,iTranslatedTileTypeID,iHue=
,meshname)
 		end
-		=

-		if (meshname =3D=3D &quot;&quot;) then meshname =3D false end
-		gLegacyModelCache[iTileTypeID..&quot;_&quot;..iHue] =3D meshname
+
+		if (meshname =3D=3D &quot;&quot;) then meshname =3D nil end
+		gLegacyModelCache[iTranslatedTileTypeID..&quot;_&quot;..iHue] =3D meshname
 	end
 	return meshname
 end
 =

 -- called by the c methods of LegacyModelAndTextureLoader, has to return a=
 material name, used for statics
 gLegacyModelMaterialCache =3D {}
-function LegacyModelLoader_GetMaterial (iModelID,iTextureID) =

+function LegacyModelLoader_GetMaterial (iModelID,iTextureID)
 	local matname =3D gLegacyModelMaterialCache[iTextureID]
 	if ((not matname)) then =

 		if (iTextureID &gt;=3D 0) then =

@@ -126,13 +150,10 @@
 end
 =

 function GetStaticMeshOrientation (iTileTypeID)
-	local w,x,y,z =3D Quaternion.identity()
-
-	-- custom Ogre Mesh Test
-	--if (iTileTypeID =3D=3D hex2num(&quot;0x0cd3&quot;)) then
-	--	w,x,y,z =3D Quaternion.fromAngleAxis (gfDeg2Rad * 90.0,1,0,0)  -- ang,=
x,y,z
-	--end
-
+	local w,x,y,z =3D FilterOrientation(iTileTypeID)
+	if (not w or not x or not y or not z) then
+		w,x,y,z =3D Quaternion.identity()
+	end
 	return w,x,y,z
 end
 =


Modified: branches/knut/data/lua/lib.terrain.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.terrain.lua (original)
+++ branches/knut/data/lua/lib.terrain.lua Wed Aug  1 22:26:16 2007
@@ -7,7 +7,6 @@
 	if (translator) then return translator[iTileTypeID] or iTileTypeID else r=
eturn iTileTypeID end
 end
 =

-
 -- called by the c function BuildTerrainEntity_Shaded, has to return a mat=
erial name for a tiletypeid, used for terrain
 function BuildTerrainEntity_Shaded_GetMaterial (iTileTypeID) return GetTer=
rainMaterial(iTileTypeID,true) end
 =

@@ -15,15 +14,21 @@
 function BuildTerrainEntity_Simple_GetMaterial (iTileTypeID) return GetTer=
rainMaterial(iTileTypeID,false) end
 =

 =

-
 gTerrainMaterialCache =3D {}
 function GetTerrainMaterial (iTileTypeID,bLighting)
+	--Seasonal Translation
+	local iTranslatedTileTypeID=3DTranslateTileTypeID(iTileTypeID, gSeasonSet=
ting)
+
+	-- FILTER: Special Filters
+	iTranslatedTileTypeID =3D FilterMap(iTranslatedTileTypeID)
+
+	--temporary for testing material/shader use for tiles (mystiqq)
+	if (gTerrainShader and OgreMaterialNameKnown(&quot;tileid_&quot; .. iTranslatedTile=
TypeID)) then  =

+		return &quot;tileid_&quot; .. iTranslatedTileTypeID
+	end
+
 	local matname =3D gTerrainMaterialCache[iTileTypeID]
 	if ((not matname) and gTexMapLoader) then
-	=

-		--Seasonal Translation
-		local iTranslatedTileTypeID=3DTranslateTileTypeID(iTileTypeID, gSeasonSe=
tting)
-		=

 		local miFlags,miTexID,msName =3D gTileTypeLoader:GetGroundTileType(iTran=
slatedTileTypeID)
 		-- only if miTexID is !=3D 0 take tiledata value for iTranslatedTileType=
ID
 		if (miTexID ~=3D 0) then

Modified: branches/knut/data/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.test.lua (original)
+++ branches/knut/data/lua/lib.test.lua Wed Aug  1 22:26:16 2007
@@ -54,21 +54,12 @@
 	--SoundSetListenerPosition(100,500,0)
 	SoundSetListenerPosition(100,100,0)
 	=

-	SoundPlayEffect(100,100,0,150)
-	--SoundPlayEffect(100,0,0,1)
+	--SoundPlayEffect(100,100,0,150)
+	SoundPlayEffect(50,100,0,20)
 	=

 	while IsSoundEffectPlaying() do =

 		SoundStep()
 	end
-	=

-	--[[
-	SoundPlayEffect(500,0,0,197)
-	SoundPlayEffect(-500,0,0,197)
-	=

-	while IsSoundEffectPlaying() do =

-		SoundStep()
-	end
-	]]--
 	=

 	SoundDone()
 	Crash()

Modified: branches/knut/data/lua/lib.time.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.time.lua (original)
+++ branches/knut/data/lua/lib.time.lua Wed Aug  1 22:26:16 2007
@@ -2,20 +2,27 @@
 gTimerEveryFrame_New =3D {}
 gMyTicks =3D 0
 =

-gFPS_NextCalc =3D 0
-gFPS_Counter =3D 0
-gFPS =3D 0
-
+gStats_NextUpdate =3D 0
 -- called from main.lua
-function UpdateFPS (ticks)
-	-- calc fps
-	gFPS_Counter =3D gFPS_Counter + 1
-	if (gFPS_NextCalc &lt; ticks) then =

-		DisplayFPS(gFPS_Counter)
-		gFPS_NextCalc =3D ticks + 1000
-		gFPS_Counter =3D 0
-		gFPS =3D gFPS_Counter
-		=

+function UpdateStats (ticks)
+	if (gHideFPS) then return end
+	if (ticks &gt; gStats_NextUpdate) then
+		gStats_NextUpdate =3D ticks + 1000
+		local text =3D sprintf(&quot;%5.1f fps %5d bat %10d tri&quot;,OgreAvgFPS(),OgreBat=
chCount(),OgreTriangleCount())
+		if (not gStatsField) then
+			local vw,vh =3D GetViewportSize()
+			local w,h =3D 0,12
+			local x,y =3D vw-w,0
+			local col_back =3D {0,0,0,0}
+			local col_text =3D {1,0,0,1}
+			gStatsField =3D guimaker.MyCreateDialog()
+			gStatsField.panel	=3D guimaker.MakeBorderPanel(gStatsField,x,y,w,h,col_=
back)
+			gStatsField.text	=3D guimaker.MakeText(gStatsField.panel,0,0,text,16,co=
l_text)
+		else
+			gStatsField.text.gfx:SetText(text)
+		end
+		local tw,th =3D gStatsField.text.gfx:GetTextBounds()
+		gStatsField.text.gfx:SetPos(-tw,0)
 		-- also update memory usage
 		DisplayMemoryUsage(OgreMemoryUsage(&quot;all&quot;))
 	end
@@ -46,3 +53,13 @@
 function RegisterStepper (fun,param) =

 	table.insert(gTimerEveryFrame_New,{fun,param})
 end
+
+-- calls the function fun after timout ms
+function InvokeLater	(timeout, fun)
+	RegisterStepper(function(starttime)
+		if starttime + timeout &lt; gMyTicks then
+			fun()
+			return true
+		end
+	end, gMyTicks)
+end

Modified: branches/knut/data/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.uoids.lua (original)
+++ branches/knut/data/lua/lib.uoids.lua Wed Aug  1 22:26:16 2007
@@ -6,6 +6,7 @@
 gGender =3D { [0] =3D &quot;Male&quot;, [1] =3D &quot;Female&quot; } =

 gRace =3D { [1] =3D &quot;Human&quot;, [2] =3D &quot;Elf&quot; }
 =

+gMaxHueValue =3D 2999 -- hues.mul has only 2999 values
 =

 -- the meaning of mobile.flag
 kMobileFlag_Unknown1		=3D hex2num(&quot;0x01&quot;)
@@ -268,5 +269,5 @@
 	[52]	=3D 0,
 	[53]	=3D 0,
 	[54]	=3D 0,
-	[55]	=3D 0	-- ? correct?
+	[55]	=3D 0
 }

Modified: branches/knut/data/lua/lib.util.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.util.lua (original)
+++ branches/knut/data/lua/lib.util.lua Wed Aug  1 22:26:16 2007
@@ -325,6 +325,24 @@
 				aw * bz + az * bw + ax * by - ay * bx
 	end
 	=

+	-- returns qw,qx,qy,qz  , input comma seperated list &quot;x:90,y:90,z:30&quot; =

+	function QuaternionFromString (txt) =

+		local qw,qx,qy,qz =3D Quaternion.identity()
+		local arr =3D strsplit(&quot;,&quot;,txt)
+		for k,axis_ang in pairs(arr) do
+			local axis,ang =3D unpack(strsplit(&quot;:&quot;,axis_ang))
+			local x,y,z =3D 0,0,0
+				if (axis =3D=3D &quot;x&quot;) then x =3D 1 =

+			elseif (axis =3D=3D &quot;y&quot;) then y =3D 1 =

+			elseif (axis =3D=3D &quot;z&quot;) then z =3D 1 =

+			else assert(false,&quot;illegal axis&quot;..tostring(axis))
+			end
+			local ow,ox,oy,oz =3D Quaternion.fromAngleAxis(tonumber(ang)*gfDeg2Rad,=
x,y,z)
+			qw,qx,qy,qz =3D Quaternion.Mul(ow,ox,oy,oz,qw,qx,qy,qz) =

+		end
+		return qw,qx,qy,qz
+	end
+	=

 	function Quaternion.lookAt (x,y,z) =

 		return Quaternion.getRotation(0,0,1,x,y,z)
 	end

Modified: branches/knut/data/lua/lib.walking2.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/lib.walking2.lua (original)
+++ branches/knut/data/lua/lib.walking2.lua Wed Aug  1 22:26:16 2007
@@ -1,10 +1,10 @@
 -- Walking Implementation for PC
 -- thx for helping to Arahil
 =

-gDebugWalkingDetailed =3D true =

+gDebugWalkingDetailed =3D true =

 =

 function printwalkdebug (...) if (gDebugWalkingDetailed) then printdebug(&quot;=
walking&quot;,unpack(arg)) end end =

-
+
 -- returns tiletype,zloc
 function GetAbsTile (xloc,yloc) =

 	return gGroundBlockLoader:GetTile(	math.floor(xloc/8), =

@@ -82,7 +82,7 @@
 			end
 			=

 			flaglist[zloc].bSurface =3D flaglist[zloc].bSurface or isSurface(t.miFl=
ags)
-			flaglist[zloc].bBridge =3D flaglist[zloc].bBridge or isBridge (t.miFlag=
s)
+			flaglist[zloc].bBridge =3D flaglist[zloc].bBridge or isBridge (t.miFlag=
s)
 			=

 			if (iHeight &gt; 0) then
 				flaglist[zloc].bImpassable =3D flaglist[zloc].bImpassable or isImpassa=
ble(t.miFlags)
@@ -91,14 +91,14 @@
 						flaglist[zloc + j] =3D { }
 					end
 					flaglist[zloc + j].bImpassable =3D flaglist[zloc + j].bImpassable or =
isImpassable(t.miFlags)
-					flaglist[zloc + j].bSurface =3D flaglist[zloc + j].bSurface or isSurf=
ace(t.miFlags)
+					flaglist[zloc + j].bSurface =3D flaglist[zloc + j].bSurface or isSurf=
ace(t.miFlags)
 					flaglist[zloc + j].bBridge =3D flaglist[zloc + j].bBridge or isBridge=
 (t.miFlags) =

 				end
 				=

 				if (flaglist[zloc + iHeight] =3D=3D nil) then
 					flaglist[zloc + iHeight] =3D { }
 				end
-				flaglist[zloc + iHeight].bSurface =3D flaglist[zloc + iHeight].bSurfac=
e or isSurface(t.miFlags)
+				flaglist[zloc + iHeight].bSurface =3D flaglist[zloc + iHeight].bSurfac=
e or isSurface(t.miFlags)
 				flaglist[zloc + iHeight].bBridge =3D flaglist[zloc + iHeight].bBridge =
or isBridge(t.miFlags) =

 			end
 			=

@@ -109,7 +109,7 @@
 =

 -- returns an array of flags (impassable, surface, maptile)
 -- array might contain empty entries (meaning on the specific z level is n=
either something blocking nor a surface/maptile)
-function GetWalkingBlockFlags(bx, by, tx, ty)
+function GetWalkingBlockFlags(bx, by, tx, ty)
 	printwalkdebug(&quot;--GetWalkingBlockFlags() for bx=3D&quot;..bx..&quot;  by=3D&quot;..by..&quot;=
  tx=3D&quot;..tx..&quot;  ty=3D&quot;..ty..&quot;  (&quot;..(bx*8 + tx)..&quot;/&quot;..(by*8+ty)..&quot;)&quot;) =

 	=

 	if ( not(gTileTypeLoader) ) then return {} end
@@ -146,8 +146,10 @@
 		iStaticCount =3D 0
 	end
 	-- TODO : maybe include Seasonal translation also here!?
+	=

+	local iTileTypeID,iX,iY,iZ,iHue
 	for i =3D 0,iStaticCount-1 do
-		local iTileTypeID,iX,iY,iZ =3D gStaticBlockLoader:GetStatic(i)
+		iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i)
 		if (iX =3D=3D tx and iY =3D=3D ty) then
 			printwalkdebug(&quot;----new Static ID=3D&quot; .. iTileTypeID)
 			GetWalkingBlockFlagsHelper(iZ,iTileTypeID,flaglist)
@@ -157,37 +159,50 @@
 	-- dynamics
 	printwalkdebug(&quot;---Dynamics&quot;)
 	=

-	local xloc=3Dbx*8+tx
+	local xloc=3Dbx*8+tx
 	local yloc=3Dby*8+ty
 	for k,object in pairs(gObjectList) do =

 		if (object.isdynamic) then
-			local dynamic =3D object
-			-- is this a multi?
-			if(dynamic.artid &lt; gMulti_ID + 100) then
-				-- no mulit just a normal tile
-				if (dynamic.x =3D=3D xloc and dynamic.y =3D=3D yloc) then
-					printwalkdebug(&quot;----new dynamic ID=3D&quot; .. dynamic.artid)
-					GetWalkingBlockFlagsHelper(dynamic.z,dynamic.artid,flaglist)
-				end
-			else
-				-- multi found, special collision handling
-				local id =3D dynamic.artid - gMulti_ID
-				local parts =3D gMultiLoader:CountMultiParts(id)
-				printwalkdebug(&quot;---Dynamics multi id=3D&quot; .. id .. &quot; parts=3D&quot; .. parts)
-				for p =3D 0, parts-1 do
-					local blocknum,x,y,z,flags
-					blocknum,x,y,z,flags =3D gMultiLoader:GetMultiParts(id,p)
-					=

-					local pxloc,pyloc,pzloc
-					pxloc =3D dynamic.x + x
-					pyloc =3D dynamic.y + y
-					pzloc =3D dynamic.z + z
-					=

-					if (flags =3D=3D 1 and pxloc =3D=3D xloc and pyloc =3D=3D yloc) then
-						printwalkdebug(&quot;----new dynamic ID=3D&quot; .. blocknum)
-						GetWalkingBlockFlagsHelper(pzloc,blocknum,flaglist)
-					end						=

-				end
+			local dynamic =3D object
+
+			-- is this a normal statictile or multi?
+			if (dynamic.artid &gt;=3D gMulti_ID) then -- gMulti_ID + 100
+				if (dynamic.lTile) then
+					for k,v in pairs(dynamic.lTile) do
+						if ((dynamic.x+v.x) =3D=3D xloc and (dynamic.y+v.y) =3D=3D yloc) then
+							printwalkdebug(&quot;----new serverside multi tile ID=3D&quot; .. v.artid)
+							GetWalkingBlockFlagsHelper(v.z,v.artid,flaglist)	-- todo flaglist
+				end
+					end
+				elseif gMultiLoader then
+				-- multi found, special collision handling
+				local id =3D dynamic.artid - gMulti_ID
+				local parts =3D gMultiLoader:CountMultiParts(id)
+				printwalkdebug(&quot;---Dynamics multi id=3D&quot; .. id .. &quot; parts=3D&quot; .. parts)
+				for p =3D 0, parts-1 do
+					local blocknum,x,y,z,flags
+					blocknum,x,y,z,flags =3D gMultiLoader:GetMultiParts(id,p)
+					=

+					local pxloc,pyloc,pzloc
+						pxloc =3D dynamic.x + x
+						pyloc =3D dynamic.y + y
+						pzloc =3D dynamic.z + z
+					=

+					if (flags =3D=3D 1 and pxloc =3D=3D xloc and pyloc =3D=3D yloc) then
+						printwalkdebug(&quot;----new dynamic ID=3D&quot; .. blocknum)
+						GetWalkingBlockFlagsHelper(pzloc,blocknum,flaglist)
+					end						=

+				end
+				else
+					printwalkdebug(&quot;no Multi found&quot;)
+				end
+			else
+				--elseif(dynamic.artid &lt; gMulti_ID + 100) then
+				-- no mulit just a normal tile
+				if (dynamic.x =3D=3D xloc and dynamic.y =3D=3D yloc) then
+					printwalkdebug(&quot;----new dynamic ID=3D&quot; .. dynamic.artid)
+					GetWalkingBlockFlagsHelper(dynamic.z,dynamic.artid,flaglist)
+				end
 			end
 		end
 	end
@@ -197,112 +212,112 @@
 end
 =

 =

--- check for free space (!impassable), char is 15 zlevels tall
+-- check for free space (!impassable), char is 15 zlevels tall
 -- if diagonalCheck is true land tiles above zloc+gMaxZ_Climb (resp. +5 fo=
r maptiles) are blocking, underneath they are ignored
--- returns true or false
-function CheckZSpace(flaglist, zloc, diagonalCheck, height)  =

+-- returns true or false
+function CheckZSpace(flaglist, zloc, diagonalCheck, height)  =

 	diagonalCheck =3D diagonalCheck or false =

 	height =3D height or 15
 	for i=3D1, height, 1 do
-		if (flaglist[zloc+i] ~=3D nil) then
-			if (diagonalCheck) then
-				if (flaglist[zloc+i].bImpassable
-					or (flaglist[zloc+i].bMaptile and (i &gt; gMaxZ_Climb + 5)) =

-					or (flaglist[zloc+i].bSurface and (i &gt; gMaxZ_Climb))
-				) then
-					return false =

-				end
-			elseif (flaglist[zloc+i].bImpassable or flaglist[zloc+i].bSurface) then =

-				return false
+		if (flaglist[zloc+i] ~=3D nil) then
+			if (diagonalCheck) then
+				if (flaglist[zloc+i].bImpassable
+					or (flaglist[zloc+i].bMaptile and (i &gt; gMaxZ_Climb + 5)) =

+					or (flaglist[zloc+i].bSurface and (i &gt; gMaxZ_Climb))
+				) then
+					return false =

+				end
+			elseif (flaglist[zloc+i].bImpassable or flaglist[zloc+i].bSurface) then =

+				return false
 			end
 		end
 	end
 	=

 	return true
 end
-
-
--- check adjacent coordinates when walking diagonally
--- OSI is not looking for a surface on those tiles, it only checks that th=
ere is nothing blocking
--- OSI takes the current z level to check for that, not the z level of the=
 target tile
--- returns true or false
-function CheckAdjacentTiles(bx, by, tx, ty, iDir, iStartZ)
-	local bDiagonal
-	local diagonalFlagList1, diagonalFlagList2
-	printwalkdebug(&quot;------direction: &quot;..iDir)
-	if (iDir =3D=3D 1) then --northeast (right)
-		bDiagonal =3D true
-		if (tx =3D=3D 0) then
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx-1, by, 7, ty)
-		else
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx-1, ty)
-		end
-		=

-		if (ty =3D=3D 7) then
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by+1, tx, 0)
-		else
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty+1)
-		end
-							=

-	elseif (iDir =3D=3D 3) then --southeast (down)
-		bDiagonal =3D true
-		if (tx =3D=3D 0) then
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx-1, by, 7, ty)
-		else
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx-1, ty)
-		end
-		=

-		if (ty =3D=3D 0) then
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by-1, tx, 7)
-		else
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty-1)
-		end
-		=

-	elseif (iDir =3D=3D 5) then --southwest (left)
-		bDiagonal =3D true
-		if (tx =3D=3D 7) then
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx+1, by, 0, ty)
-		else
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx+1, ty)
-		end
-		=

-		if (ty =3D=3D 0) then
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by-1, tx, 7)
-		else
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty-1)
-		end
-		=

-	elseif (iDir =3D=3D 7) then --northwest (up)
-		bDiagonal =3D true
-		if (tx =3D=3D 7) then
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx+1, by, 0, ty)
-		else
-			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx+1, ty)
-		end
-		=

-		if (ty =3D=3D 7) then
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by+1, tx, 0)
-		else
-			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty+1)
-		end
-	end
-			=

-	if (bDiagonal) then
-		printwalkdebug(&quot;------walking diagonally&quot;)
-				=

-		if (CheckZSpace(diagonalFlagList1, iStartZ, true) and CheckZSpace(diagon=
alFlagList2, iStartZ, true)) then
-			printwalkdebug(&quot;-------no obstacles on adjacent coordinates&quot;)
-			return true
-		else
-			printwalkdebug(&quot;-------adjacent tiles are not free to walk, blocking&quot;)
-			return false
-		end
-	else
-		return true
-	end
-end
-
-
+
+
+-- check adjacent coordinates when walking diagonally
+-- OSI is not looking for a surface on those tiles, it only checks that th=
ere is nothing blocking
+-- OSI takes the current z level to check for that, not the z level of the=
 target tile
+-- returns true or false
+function CheckAdjacentTiles(bx, by, tx, ty, iDir, iStartZ)
+	local bDiagonal
+	local diagonalFlagList1, diagonalFlagList2
+	printwalkdebug(&quot;------direction: &quot;..iDir)
+	if (iDir =3D=3D 1) then --northeast (right)
+		bDiagonal =3D true
+		if (tx =3D=3D 0) then
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx-1, by, 7, ty)
+		else
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx-1, ty)
+		end
+		=

+		if (ty =3D=3D 7) then
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by+1, tx, 0)
+		else
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty+1)
+		end
+							=

+	elseif (iDir =3D=3D 3) then --southeast (down)
+		bDiagonal =3D true
+		if (tx =3D=3D 0) then
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx-1, by, 7, ty)
+		else
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx-1, ty)
+		end
+		=

+		if (ty =3D=3D 0) then
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by-1, tx, 7)
+		else
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty-1)
+		end
+		=

+	elseif (iDir =3D=3D 5) then --southwest (left)
+		bDiagonal =3D true
+		if (tx =3D=3D 7) then
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx+1, by, 0, ty)
+		else
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx+1, ty)
+		end
+		=

+		if (ty =3D=3D 0) then
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by-1, tx, 7)
+		else
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty-1)
+		end
+		=

+	elseif (iDir =3D=3D 7) then --northwest (up)
+		bDiagonal =3D true
+		if (tx =3D=3D 7) then
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx+1, by, 0, ty)
+		else
+			diagonalFlagList1 =3D GetWalkingBlockFlags(bx, by, tx+1, ty)
+		end
+		=

+		if (ty =3D=3D 7) then
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by+1, tx, 0)
+		else
+			diagonalFlagList2 =3D GetWalkingBlockFlags(bx, by, tx, ty+1)
+		end
+	end
+			=

+	if (bDiagonal) then
+		printwalkdebug(&quot;------walking diagonally&quot;)
+				=

+		if (CheckZSpace(diagonalFlagList1, iStartZ, true) and CheckZSpace(diagon=
alFlagList2, iStartZ, true)) then
+			printwalkdebug(&quot;-------no obstacles on adjacent coordinates&quot;)
+			return true
+		else
+			printwalkdebug(&quot;-------adjacent tiles are not free to walk, blocking&quot;)
+			return false
+		end
+	else
+		return true
+	end
+end
+
+
 =

 -- Can walk the tile, the tile's height and if the tile's a stair
 -- (about 30 in int, or 3.0 in float (*0.1) is the height of a door)
@@ -339,20 +354,20 @@
 			printwalkdebug(&quot;-----iCur=3D&quot; .. iCur)
 			if (i &lt; gMaxZ_Climb or (i &lt; (gMaxZ_Climb + 5) and (flaglist[iCur].bMapt=
ile or flaglist[iCur].bBridge))) then
 				if ((not flaglist[iCur].bImpassable) and flaglist[iCur].bSurface) then
-					printwalkdebug(&quot;------found Surface&quot;);
-					if (CheckZSpace(flaglist, iCur)) then
+					printwalkdebug(&quot;------found Surface&quot;);
+					if (CheckZSpace(flaglist, iCur)) then
 						printwalkdebug(&quot;------checkSpace successful&quot;)
-						=

-						local bAdjacent =3D CheckAdjacentTiles(bx, by, tx, ty, iDir, iStartZ)
+						=

+						local bAdjacent =3D CheckAdjacentTiles(bx, by, tx, ty, iDir, iStartZ)
 						=

 						printwalkdebug(&quot;End GetNearestGroundLevel()&quot;)
 						printwalkdebug(&quot;----------------------------&quot;)
 						printwalkdebug()
-						printdebug(&quot;walking&quot;,sprintf( &quot;Walking calculations took %d msec.\n&quot;=
, Client_GetTicks() - Walking_Start ))
-						if (bAdjacent) then
-							return true, iCur
-						else
-							return false, 255
+						printdebug(&quot;walking&quot;,sprintf( &quot;Walking calculations took %d msec.\n&quot;=
, Client_GetTicks() - Walking_Start ))
+						if (bAdjacent) then
+							return true, iCur
+						else
+							return false, 255
 						end
 					end
 				end
@@ -367,18 +382,18 @@
 				if ((not flaglist[iCur].bImpassable) and flaglist[iCur].bSurface) then
 					printwalkdebug(&quot;------found Surface&quot;);
 					if (CheckZSpace(flaglist, iCur)) then
-						printwalkdebug(&quot;------ checkSpace successful&quot;)
-						=

-						local bAdjacent =3D CheckAdjacentTiles(bx, by, tx, ty, iDir, iStartZ)
+						printwalkdebug(&quot;------ checkSpace successful&quot;)
+						=

+						local bAdjacent =3D CheckAdjacentTiles(bx, by, tx, ty, iDir, iStartZ)
 						=

 						printwalkdebug(&quot;End GetNearestGroundLevel()&quot;)
 						printwalkdebug(&quot;----------------------------&quot;)
 						printwalkdebug()
-						printdebug(&quot;walking&quot;,sprintf( &quot;Walking calculations took %d msec.\n&quot;=
, Client_GetTicks() - Walking_Start ))
-						if (bAdjacent) then
-							return true, iCur
-						else
-							return false, 255
+						printdebug(&quot;walking&quot;,sprintf( &quot;Walking calculations took %d msec.\n&quot;=
, Client_GetTicks() - Walking_Start ))
+						if (bAdjacent) then
+							return true, iCur
+						else
+							return false, 255
 						end
 					end
 				end

Modified: branches/knut/data/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/main.lua (original)
+++ branches/knut/data/lua/main.lua Wed Aug  1 22:26:16 2007
@@ -84,8 +84,13 @@
 dofile(libpath .. &quot;gui/gui.main.lua&quot;)
 dofile(libpath .. &quot;obj/obj.main.lua&quot;)
 dofile(libpath .. &quot;net/net.main.lua&quot;)
-
---can be removed with gamerelease
+dofile(libpath .. &quot;lib.corpse.lua&quot;)
+
+dofile(libpath .. &quot;filter.art.lua&quot;)
+dofile(libpath .. &quot;filter.granny.lua&quot;)
+dofile(libpath .. &quot;filter.map.lua&quot;)
+
+--can be removed from release
 dofile(libpath .. &quot;lib.meshexporter.lua&quot;)
 =

 dofile(gConfigPathFallback)
@@ -134,12 +139,13 @@
 =

 --- main function, when it returns, the program ends
 function Main ()
-	HandleCommandLine()
-	=

-	CheckUODir()
-	=

 	local luaversion =3D string.sub(_VERSION, 5, 7)
 	print(&quot;Lua version : &quot;..luaversion)
+	=

+	HandleCommandLine()
+	=

+	CheckUODir()
+	=

 	-- if (gHuffmanCompression) then LuaHuffmanTest() end
 	-- if (false) then MyGrannyTest_PreOgre() end	-- TODO : just a test, see =
lib.models.lua
 	-- if (false) then LuaBitwiseTest() end
@@ -148,10 +154,18 @@
 	-- if (false) then ExpressionTest() end
 	-- if (false) then TestSound() end
 	-- if (false) then TestMultiLoader() end
-	-- if (false) then MeshExporter() end
-	-- TestZLib()
+	-- if (false) then TestZLib() end
+	-- if (false) then TestUniFontLoader() end
+	-- if (false) then TestUOP() end
+	=

 	=

 	gMyTicks =3D Client_GetTicks()
+	=

+	-- register pixel format constants, like PF_FLOAT16_R
+	if (OgrePixelFormatList) then
+		local mylist =3D OgrePixelFormatList()
+		for id,name in pairs(mylist) do _G[name] =3D id end
+	end
 	=

 	LoadingProfile(&quot;initializing Ogre&quot;,true)
 	gPreOgreTime =3D gLoadingProfileLastTime
@@ -159,12 +173,15 @@
 =

 	-- set global shadow settings
 	if (gEnableShadows) then
+		--OgreSetShadowTexturePixelFormat(PF_FLOAT32_R) --??
+		--OgreSetShadowTextureSize(512)
+		--OgreSetShadowTextureCasterMaterial
+		--OgreSetShadowTextureReceiverMaterial
+		--OgreSetShadowTextureSelfShadow(false)
 		OgreShadowTechnique(gShadowTechnique)
-		OgreAmbientLight(gAmbientColor.r, gAmbientColor.g, gAmbientColor.b)
-	end
-
-	-- if (true) then TestUniFontLoader() end
-	=

+		--OgreSetShadowFarDistance(100.0)
+	end
+
 	-- maybe we should check here if in offline or online mode!?
 	InitNet()
 =

@@ -178,10 +195,15 @@
 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
 =

 	PreLoad()
+
 	gCurrentRenderer:PreInit()
 =

 	MainMenuFinishedPreLoading()
+
+	gCurrentRenderer:Init()
+
 	StartMainMenu()
+
 	if (gStartInDebugMode) then StopMainMenu() StartDebugMenu() end
 =

 	TestGuiSystem2_Init()
@@ -201,10 +223,16 @@
 	print(&quot;##################################&quot;)
 	=

 	ExecuteMapChangeIfNeeded()
-	gCurrentRenderer:Init()
+
 	gCurrentRenderer:BlendOutLayersAbovePlayer()
-	=

+
+	-- Binds all InGame-Keys
+	BindInGameKeys()
+
 	print(&quot;Welcome to Iris&quot;)
+
+	-- stop menu music
+	SoundStopMusic()
 =

 	gInGameStarted =3D true
 end
@@ -212,11 +240,12 @@
 -- called every frame, after all timer-steppers, see Step() in lib.time.lua
 function MainStep (curticks)
 	gMyTicks =3D curticks
-	UpdateFPS(curticks)
+	UpdateStats(curticks)
 	StepTimer(curticks)
 	--TestGuiSystem2_Step()
 	=

 	NetStep()
+
 	if (gInGameStarted) then
 		gCurrentRenderer:UpdateMap()
 		gCurrentRenderer:MousePickStep()
@@ -229,6 +258,7 @@
 	else
 		StepMainMenu()
 	end
+
 	StepDebugMenu()
 	gui.Step()
 	=


Modified: branches/knut/data/lua/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/net.login.lua (original)
+++ branches/knut/data/lua/net.login.lua Wed Aug  1 22:26:16 2007
@@ -34,6 +34,44 @@
 	MainMenuShowServerList(serverlist)
 end
 =

+-- len: 0x10C
+function ProtocolSend_SystemSpecs()
+	print(&quot;NET: Send_SystemSpecs:&quot;)
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Metrics)
+	out:PushNetUint8(hex2num(&quot;0x02&quot;))
+	out:PushNetUint32(hex2num(&quot;0x442C637A&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00000005&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00000001&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00000A28&quot;))
+	out:PushNetUint8(hex2num(&quot;0x02&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00000006&quot;))
+	out:PushNetUint32(hex2num(&quot;0x0000000F&quot;))
+	out:PushNetUint32(hex2num(&quot;0x0000095A&quot;))
+	out:PushNetUint8(hex2num(&quot;0x02&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00000600&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00000500&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00000400&quot;))
+	out:PushNetUint16(hex2num(&quot;0x0000&quot;))
+	out:PushNetUint16(hex2num(&quot;0x0020&quot;)) -- 48
+	for i=3D1, 76 do
+		out:PushNetUint8(0)
+	end	-- 124
+	out:PushNetUint32(hex2num(&quot;0x10020000&quot;))
+	out:PushNetUint32(hex2num(&quot;0x71C20000&quot;))
+	out:PushNetUint32(hex2num(&quot;0x01080002&quot;))
+	out:PushNetUint8(hex2num(&quot;0x06&quot;))
+	out:PushNetUint8(hex2num(&quot;0x10&quot;))
+	out:PushNetUint8(hex2num(&quot;0x64&quot;))
+	out:PushNetUint8(hex2num(&quot;0x00&quot;))
+	out:PushNetUint8(hex2num(&quot;0x65&quot;))
+	out:PushNetUint32(hex2num(&quot;0x00750000&quot;)) -- 145
+	for i=3D1, 123 do
+		out:PushNetUint8(0)
+	end
+	out:SendPacket()
+end
+
 -- Recieve Serverredirect from LoginServer (0x8c)
 function gPacketHandler.kPacket_Server_Redirect ()
 	local input =3D GetRecvFIFO()
@@ -41,17 +79,18 @@
 	gGameServerIP =3D input:PopNetUint32()
 	gGameServerPort =3D input:PopNetUint16()
 	gGameServerAccount =3D input:PopNetUint32()
-	printdebug(&quot;login&quot;,sprintf(&quot;NET: server redirect: id=3D%i ip=3D%x port=3D=
%i AccountNr.:%x\n&quot;,
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: server redirect: id=3D%i ip=3D%x port=3D=
%i AccountNr.:0x%08x\n&quot;,
 			id,gGameServerIP,gGameServerPort,gGameServerAccount))
-			=

-	--wait redirect is received
-	if ( gServerType[gServerEmulator]~=3D&quot;RunUO&quot; ) then
+	printdebug(&quot;login&quot;,sprintf(&quot;DEBUG IP STRINGS %s &lt;&gt; %s\n&quot;,NtoA(gGameServer=
IP),GetHostByName(gLoginServerIP)))
+
+	-- login &amp; gameserver are not the same: redirect is received
+	if ((NtoA(gGameServerIP) ~=3D GetHostByName(gLoginServerIP)) or (gGameSer=
verPort ~=3D gLoginServerPort)) then
 		--disconnect from Loginserver
 		printdebug(&quot;login&quot;,&quot;NET: disconnect from loginserver&quot;)
 		NetDisconnect()
 		--connect to gameserver
 		printdebug(&quot;login&quot;,&quot;NET: connect to gameserver&quot;)
-		local res =3D NetConnectWithKey(NtoA(gGameServerIP),gGameServerPort,gSer=
verSeed)
+		local res =3D NetConnectWithKey(NtoA(gGameServerIP),gGameServerPort,gGam=
eServerAccount)
 		if (not res) then
 			FatalErrorMessage(&quot;kPacket_Server_Redirect : login server redirect fail=
ed&quot;)
 		end
@@ -110,12 +149,12 @@
 	for i =3D 0,charlist.citynumber-1 do
 		gCities[i] =3D {}
 		gCities[i].index=3Dinput:PopNetUint8()
-		gCities[i].cityname=3Dinput:PopFilledString(30)
+		gCities[i].name=3Dinput:PopFilledString(30)
 		gCities[i].terminator1=3Dinput:PopNetUint8()
 		gCities[i].tavern=3Dinput:PopFilledString(30)
 		gCities[i].terminator2=3Dinput:PopNetUint8()
 =

-		printdebug(&quot;login&quot;,sprintf(&quot;NET: Index: %i City: %s Tavern: %s\n&quot;,gCitie=
s[i].index,gCities[i].cityname,gCities[i].tavern))
+		printdebug(&quot;login&quot;,sprintf(&quot;NET: Index: %i City: %s Tavern: %s\n&quot;,gCitie=
s[i].index,gCities[i].name,gCities[i].tavern))
 	end
 	charlist.cities =3D gCities
 =

@@ -223,6 +262,79 @@
 	end
 end
 =

+-- Server requests Clientversion (NEW?)
+function gPacketHandler.kPacket_Client_Version()
+	local input =3D GetRecvFIFO()
+	local id =3D input:PopNetUint8()
+	local value =3D input:PopNetUint16()
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: Request Clientversion =3D %i\n&quot;,value))
+
+	--Send Client ident string
+	Send_ClientVersion(gClientVersion or &quot;4.0.11c5 3D&quot;)
+end
+
+-- Send Packets -----------------------------------------------------------
+
+-- send login server request 0x80
+-- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
+function ProtocolSend_Account_Login_Request	(sName,sPassword)
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: Account_Login_Request: Name: %s Password=
:<i> %s\n&quot;,sName,sPassword))
</I>+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Account_Login_Request)
+	out:PushFilledString(sName,30)
+	out:PushFilledString(sPassword,30)
+	out:PushNetUint8(hex2num(&quot;0x5D&quot;))
+	out:SendPacket()
+end
+
+-- send gameserverselect to loginserver : kPacket_Server_Select 0xA0
+-- answered by kPacket_Server_Redirect 0x8C
+-- which calls ProtocolSend_GameServer_PostLogin kPacket_Post_Login 0x91 =

+function ProtocolSend_GameServer_Select(iGameServerID)
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: GameServer_Select: %i\n&quot;,iGameServerID))
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Server_Select)
+	out:PushNetUint16(iGameServerID)
+	out:SendPacket()
+end
+
+-- send postlogin to gameserver  kPacket_Post_Login 0x91
+-- something is wrong...runuo &amp; wolfpack detects invalid client
+-- answered by kPacket_Features 0xB9 (gClientFeatures)  and  kPacket_Chara=
cter_List 0xA9
+function ProtocolSend_GameServer_PostLogin(sName,sPassword,iAccount)
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: GameServer_PostLogin: Name: %s Password:=
 %s AccountNr.: 0x%08x\n&quot;,sName,sPassword,iAccount))
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Post_Login)
+	out:PushNetUint32(iAccount)
+	out:PushFilledString(sName,30)
+	out:PushFilledString(sPassword,30)
+	out:SendPacket()
+end
+
+-- send characterselect to gameserver
+function ProtocolSend_Character_Select(iCharacterID,iAccount)
+	printdebug(&quot;login&quot;,sprintf(&quot;NET: Character_Select: %i Name: %s Password: =
%s AccountNr.:%x\n&quot;,
+			iCharacterID,gCharacterList[iCharacterID].name,gCharacterList[iCharacte=
rID].pw,iAccount))
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Pre_Login)
+	out:PushNetUint32(hex2num(&quot;0xedededed&quot;))
+	out:PushFilledString(gCharacterList[iCharacterID].name,30)
+	out:PushFilledString(gCharacterList[iCharacterID].pw,30)
+	out:PushNetUint32(iCharacterID)
+	out:PushNetUint32(hex2num(&quot;0xC0A83016&quot;))	--out:PushNetUint32(gGameServerI=
P)		--TODO: check: iAccount or gGameServerIP
+	out:SendPacket()
+end
+
+-- client identification
+function Send_ClientQuery(iMode,iCharacterID)
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Client_Query)
+	out:PushNetUint32(hex2num(&quot;0xedededed&quot;))
+	out:PushNetUint8(iMode)
+	out:PushNetUint32(iCharacterID)
+	out:SendPacket()
+end
+
 -- Submits ClientVersion to Server
 function Send_ClientVersion(sClientVersion)
 	printdebug(&quot;login&quot;,sprintf(&quot;NET: Client_Version: Client identified as %s.=
\n&quot;, sClientVersion))

Modified: branches/knut/data/lua/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/net.other.lua (original)
+++ branches/knut/data/lua/net.other.lua Wed Aug  1 22:26:16 2007
@@ -23,7 +23,8 @@
 kPacket_Generic_SubCommand_ExtendedStats2		=3D hex2num(&quot;0x1A&quot;)
 kPacket_Generic_SubCommand_NewSpellbook			=3D hex2num(&quot;0x1B&quot;)	-- Create Ne=
w Spellbook
 kPacket_Generic_SubCommand_SpellSelected		=3D hex2num(&quot;0x1C&quot;)	-- Client -&gt;=
 Server packet ! Doppelclick auf Spell
-kPacket_Generic_SubCommand_HouseRevisionState	=3D hex2num(&quot;0x1D&quot;)
+kPacket_Generic_SubCommand_RevisionCustomHouse	=3D hex2num(&quot;0x1D&quot;)	-- Send=
s a house Revision number for handling client multi cache.
+																	-- If revision is newer than what client has it asks for =
the new multi packets to cache it.
 kPacket_Generic_SubCommand_HouseSerial			=3D hex2num(&quot;0x1E&quot;)
 kPacket_Generic_SubCommand_Ability_Icon			=3D hex2num(&quot;0x21&quot;)	-- nodata ju=
st (bf 00 05 21)
 kPacket_Generic_SubCommand_OldDamage			=3D hex2num(&quot;0x22&quot;)	-- Done!
@@ -225,6 +226,39 @@
 		DisplayPopupMenu(popupmenu) -- see net.popup.lua
 	end
 =

+	-- enable diff files for felucca,trammel,ilshenar,malas
+	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableMapDiff) then -- 0x18
+		local mapnumbers =3D input:PopNetUint32()
+		local myEnableDiff =3D {}
+		for i =3D 0, mapnumbers-1 do
+			myEnableDiff[i] =3D {}
+			myEnableDiff[i].iNumPatchesMap 		=3D input:PopNetUint32() -- Number of =
map patches in this map
+			myEnableDiff[i].iNumPatchesStatic	=3D input:PopNetUint32() -- Number of=
 static patches in this map
+		end
+		EnableDiff(myEnableDiff) -- see lib.diff.lua
+	end
+	=

+	-- States LockInfo	-- bonded status
+	if (subcmd =3D=3D kPacket_Generic_SubCommand_ExtendedStats) then -- 0x19
+		local party_cmd =3D input:PopNetUint8()
+		if (party_cmd =3D=3D hex2num(&quot;0x00&quot;)) then
+			local party_serial =3D input:PopNetUint32()
+			local party_value  =3D input:PopNetUint8()
+			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x p=
arty_value: 0x%02x\n&quot;,party_cmd,party_serial,party_value)
+		end
+		if (party_cmd =3D=3D hex2num(&quot;0x02&quot;)) then
+			local party_serial =3D input:PopNetUint32()
+			local party_value  =3D input:PopNetUint8()
+			local party_lockflags  =3D input:PopNetUint8()
+			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x p=
arty_value: 0x%02x party_lockflags: 0x%02x\n&quot;,party_cmd,party_serial,party_=
value,party_lockflags)
+		end
+		if (party_cmd =3D=3D hex2num(&quot;0x1a&quot;)) then
+			local party_stattype  =3D input:PopNetUint8()
+			local party_lockvalue  =3D input:PopNetUint8()
+			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_stattype: 0x%02x=
 party_lockvalue: 0x%02x\n&quot;,party_cmd,party_stattype,party_lockvalue)
+		end
+	end
+
 	-- first bit of first byte =3D spell #1, second bit of first byte =3D spe=
ll #2, first bit of second byte =3D spell #8, etc
 	-- Create Spellbook Container
 	-- matix 0xff030000
@@ -247,36 +281,24 @@
 		Open_Spellbook(spellbook)
 	end
 =

-	-- enable diff files for felucca,trammel,ilshenar,malas
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableMapDiff) then -- 0x18
-		local mapnumbers =3D input:PopNetUint32()
-		local myEnableDiff =3D {}
-		for i =3D 0, mapnumbers-1 do
-			myEnableDiff[i] =3D {}
-			myEnableDiff[i].iNumPatchesMap 		=3D input:PopNetUint32() -- Number of =
map patches in this map
-			myEnableDiff[i].iNumPatchesStatic	=3D input:PopNetUint32() -- Number of=
 static patches in this map
-		end
-		EnableDiff(myEnableDiff) -- see lib.diff.lua
-	end
-	=

-	-- States LockInfo	-- bonded status
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_ExtendedStats) then -- 0x19
-		local party_cmd =3D input:PopNetUint8()
-		if (party_cmd =3D=3D hex2num(&quot;0x00&quot;)) then
-			local party_serial =3D input:PopNetUint32()
-			local party_value  =3D input:PopNetUint8()
-			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x p=
arty_value: 0x%02x\n&quot;,party_cmd,party_serial,party_value)
-		end
-		if (party_cmd =3D=3D hex2num(&quot;0x02&quot;)) then
-			local party_serial =3D input:PopNetUint32()
-			local party_value  =3D input:PopNetUint8()
-			local party_lockflags  =3D input:PopNetUint8()
-			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x p=
arty_value: 0x%02x party_lockflags: 0x%02x\n&quot;,party_cmd,party_serial,party_=
value,party_lockflags)
-		end
-		if (party_cmd =3D=3D hex2num(&quot;0x1a&quot;)) then
-			local party_stattype  =3D input:PopNetUint8()
-			local party_lockvalue  =3D input:PopNetUint8()
-			--printf(&quot;NET: States LockInfo party_cmd: 0x%02x party_stattype: 0x%02x=
 party_lockvalue: 0x%02x\n&quot;,party_cmd,party_stattype,party_lockvalue)
+	-- Receives a CustomHouse Serial &amp; Revision Hash Number
+	if (subcmd =3D=3D kPacket_Generic_SubCommand_RevisionCustomHouse) then	--=
 0x1D
+		local customhouseserial =3D input:PopNetUint32()
+		local customhouserevision =3D input:PopNetUint32()
+
+		local dyn =3D gDynamics[customhouseserial]
+		-- check if houserevision exists
+		if (dyn) then
+			if (dyn.customhouserevision) then
+				-- compare new_houserevisiont with old_houserevision, if different cha=
nge to new
+				if (customhouserevision~=3Ddyn.customhouserevision) then
+					Send_CustomHouseRevision(customhouseserial)
+					print(&quot;CH: Old Custom House Revision request New&quot;)
+				end
+			else
+				Send_CustomHouseRevision(customhouseserial)
+				print(&quot;CH: Old Custom House Revision request New&quot;)
+			end
 		end
 	end
 =

@@ -542,7 +564,7 @@
 BYTE[4]	-Beheld Serial (Only if (Gump ID =3D 461 &amp;&amp; Button ID =3D 1 &amp;&amp; Swi=
tches Count &gt; 0))
 ]]--
 --TODO : readout checkboxes,radiobuttons and edit text fields
-function GumpReturnMsg(playerserial, gumpserial, ret_value, params)	-- len=
 0x17
+function GumpReturnMsg(playerserial, gumpserial, ret_value, params, switch=
count, textcount)	-- len 0x17
 	local packetlen =3D 1 + 2 + 4*5 -- size for empty params
 	if (params) then
 		packetlen =3D packetlen + 4 * table.getn(params.switches)
@@ -561,13 +583,13 @@
 	=

 	=

 	if (params) then
-		out:PushNetUint32(table.getn(params.switches))	--switchcount =

+		out:PushNetUint32(table.getn(params.switches))	--switchcount
 		for k,v in pairs(params.switches) do =

 			out:PushNetUint32(v) =

 			--print(&quot;GumpReturnMsg switch:&quot;,v) =

 		end
 		=

-		out:PushNetUint32(table.getn(params.texts))	--textcount =

+		out:PushNetUint32(table.getn(params.texts))	--textcount
 		for k,v in pairs(params.texts) do =

 			local len =3D string.len(v.text)
 			out:PushNetUint16(v.id) =

@@ -576,10 +598,25 @@
 			--print(&quot;GumpReturnMsg text:&quot;,v.id,len,v.text)
 		end
 	else
-		out:PushNetUint32(0)	--switchcount =

-		out:PushNetUint32(0)	--textcount
-	end
-
+		if (switchcount and textcount) then
+			out:PushNetUint32(switchcount)	--switchcount
+			out:PushNetUint32(textcount)	--textcount
+		else
+			out:PushNetUint32(0)	--switchcount
+			out:PushNetUint32(0)	--textcount
+		end
+	end
+
+	out:SendPacket()
+end
+
+-- send combat request to server, triggers kPacket_Combat
+function Send_CombatMode(iWarMode)
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Combat)
+	out:PushNetUint8(iWarMode)
+	out:PushNetUint16(hex2num(&quot;0x0032&quot;))
+	out:PushNetUint8(hex2num(&quot;0x00&quot;))
 	out:SendPacket()
 end
 =

@@ -664,27 +701,47 @@
 end
 =

 -- compressed Gump
+--[[
+			EnsureCapacity( 28 + (int) m_Layout.Length + (int) m_Strings.Length );
+			m_Stream.Write( (int) m_Gump.Serial );
+			m_Stream.Write( (int) m_Gump.TypeID );
+			m_Stream.Write( (int) m_Gump.X );
+			m_Stream.Write( (int) m_Gump.Y );
+			// Note: layout seems to be null terminated on OSI, but it works either=
 ways
+			WritePacked( m_Layout );
+			m_Stream.Write( (int) m_StringCount );
+			WritePacked( m_Strings );
+			--
+		private void WritePacked( PacketWriter src )
+			m_Stream.Write( (int) ( 4 + packLength ) );
+			m_Stream.Write( (int) length );
+			m_Stream.Write( m_PackBuffer, 0, packLength );
+
+]]--
 function gPacketHandler.kPacket_Compressed_Gump ()	--0xDD
 	local input =3D GetRecvFIFO()
+	local popped_start =3D input:GetTotalPopped()
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local newgump =3D {}
+
 	newgump.playerid =3D input:PopNetUint32()
 	newgump.dialogId =3D input:PopNetUint32()
 	newgump.x =3D input:PopNetUint32()
 	newgump.y =3D input:PopNetUint32()
-	=

+
 	newgump.Length_CompressedData =3D input:PopNetUint32() - 4
 	newgump.Length_Data =3D input:PopNetUint32()
-	=

-	print(&quot;DEBUG data&quot;,newgump.Length_CompressedData,newgump.Length_Data)
-	=

-	if (1 + 2 + 4*4 + 2*4 + newgump.Length_CompressedData &gt; size) then =

-		printf(&quot;NET: broken kPacket_Compressed_Gump packet, compressed gumplen =
=3D 0x%08x\n&quot;,newgump.Length_CompressedData)
+
+	printdebug(&quot;net&quot;,sprintf(&quot;NET: Length_CompressedData=3D%d Length_Uncompre=
ssedData=3D%d\n&quot;,newgump.Length_CompressedData,newgump.Length_Data))
+
+	if (28 + newgump.Length_CompressedData &gt; size) then =

+		printf(&quot;NET: BROKEN - kPacket_Compressed_Gump packet, compressed gumplen=
 =3D 0x%08x\n&quot;,newgump.Length_CompressedData)
+		print(&quot;Error: Server Sends bad COmpressed Gumpdata ! Please report.&quot;)
 		Crash()
 	end
-	=

-	-- data part
+
+	--- Data Part ---
 	local decompressed =3D CreateFIFO()
 	-- pop and decompress data into decompress fifo
 	input:PeekDecompressIntoFifo(newgump.Length_CompressedData,newgump.Length=
_Data,decompressed)
@@ -695,32 +752,39 @@
 	decompressed:Clear()
 	=

 	-- WARNING  strange -4 on compression ahead (see runuo2 source)
-	=

-	-- textlines part
+	--- Textlines Part ---
 	newgump.numTextLines =3D input:PopNetUint32()
-	newgump.Length_CompressedTextLines =3D input:PopNetUint32() - 4
-	newgump.Length_TextLines =3D input:PopNetUint32()
-	print(&quot;DEBUG text&quot;,newgump.numTextLines,newgump.Length_CompressedTextLine=
s,newgump.Length_TextLines)
-	-- pop and decompress data into decompress fifo
-	input:PeekDecompressIntoFifo(newgump.Length_CompressedTextLines,newgump.L=
ength_TextLines,decompressed)
-	-- skip compressed part (peeked)
-	input:PopRaw(newgump.Length_CompressedTextLines)
-	=

-	for k,v in pairs(newgump) do printdebug(&quot;gump&quot;,sprintf(&quot;newgump.%s =3D &quot;,=
k),v) end
-	=

-	local totaltext =3D &quot;&quot;
-	newgump.textline =3D {}
-	--Index 0 because Serverside Gump Commands use this Index as textline ref=
erences
-	for i =3D 0,newgump.numTextLines-1 do
-		local textlen =3D decompressed:PopNetUint16()
-		printdebug(&quot;gump&quot;,&quot;reading text line &quot;,i,&quot; with length &quot;,textlen)
-		newgump.textline[i] =3D decompressed:PopUnicodeString(textlen) -- warnin=
g, data is sent as unicode, we only interpret the asci part at the moment
-		-- TODO : maybe textlen / 2 ?
-		printdebug(&quot;gump&quot;,sprintf(&quot;newgump.textline[%d](len=3D%d)=3D\n&quot;,i,textle=
n),newgump.textline[i])
-		totaltext =3D totaltext .. &quot;\n&quot; .. newgump.textline[i]
+
+	if (newgump.numTextLines ~=3D 0) then
+		newgump.Length_CompressedTextLines =3D input:PopNetUint32() - 4
+		newgump.Length_TextLines =3D input:PopNetUint32()
+	=

+		-- pop and decompress data into decompress fifo
+		input:PeekDecompressIntoFifo(newgump.Length_CompressedTextLines,newgump.=
Length_TextLines,decompressed)
+		-- skip compressed part (peeked)
+		input:PopRaw(newgump.Length_CompressedTextLines)
+		=

+		-- print gumpdata
+		for k,v in pairs(newgump) do printdebug(&quot;gump&quot;,sprintf(&quot;newgump.%s =3D &quot;=
,k),v) end
+		=

+		local totaltext =3D &quot;&quot;
+		newgump.textline =3D {}
+		--Index 0 because Serverside Gump Commands use this Index as textline re=
ferences
+		for i =3D 0,newgump.numTextLines-1 do
+			local textlen =3D decompressed:PopNetUint16()
+			printdebug(&quot;gump&quot;,&quot;reading text line &quot;,i,&quot; with length &quot;,textlen)
+			newgump.textline[i] =3D decompressed:PopUnicodeString(textlen) -- warni=
ng, data is sent as unicode, we only interpret the asci part at the moment
+			-- TODO : maybe textlen / 2 ?
+			printdebug(&quot;gump&quot;,sprintf(&quot;newgump.textline[%d](len=3D%d)=3D\n&quot;,i,textl=
en),newgump.textline[i])
+			totaltext =3D totaltext .. &quot;\n&quot; .. newgump.textline[i]
+		end
 	end
 =

 	decompressed:Destroy()
+
+	if ( (input:Size() &gt;=3D 4) and (input:GetTotalPopped()-popped_start &lt; siz=
e) ) then
+		local unknownterminator=3Dinput:PopNetUint32()
+	end
 =

 	GumpParser(newgump)
 end
@@ -731,12 +795,6 @@
 dword	Serial ( if Has Spellbook )
 byte	Expansions Flag
 byte	Spell ID (if Spell ID =3D 0, this means last spell)
------
-17:26:03.933 Client -&gt; Server: 0xBF (NewCommand::Unknown), frequ: 1, len: =
0x06
-0000: BF 06 00 00 24 83                               -&gt;....$.
-
-17:26:06.714 Client -&gt; Server: 0xBF (NewCommand::Unknown), frequ: 2, len: =
0x09
-0000: BF 09 00 00 1C 00 02 00 65                      -&gt;........e
 ]]--
 --BYTE[2] unknown, always 2
 --BYTE[2] selected spell(0-indexed)+scroll offset from sub 0x1b
@@ -772,6 +830,7 @@
 		out:PushNetUint16(spellid)
 		out:SendPacket()
 	end
+-- unused new packet
 --[[
 	else
 		local out =3D GetSendFIFO()
@@ -902,6 +961,7 @@
 	end
 end =

 =

+
 --[[
 Packet ID: 0xAD
 Packet Name: Unicode/Ascii speech request

Modified: branches/knut/data/lua/net.securetrade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/net.securetrade.lua (original)
+++ branches/knut/data/lua/net.securetrade.lua Wed Aug  1 22:26:16 2007
@@ -105,16 +105,6 @@
 	end
 end
 =

---[[
-Bind(&quot;f9&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0) =
then =

-	print(&quot;rebuild all securetrades&quot;)
-	for k,mysectrade in pairs(gSecureTrades) do =

-		print(&quot;rebuild sectrade&quot;,mysectrade.id)
-		SecureTradeRebuildContainers(mysectrade)
-	end
- end end end)
-]]--	=

-
 function SecureTradeRebuildContainers (mysectrade)
 	local container_my =3D gContainer[mysectrade.myContainerID]
 	if (container_my) then SecureTradeRebuildContainerWidgets(mysectrade,cont=
ainer_my,true) end

Modified: branches/knut/data/lua/net.sound.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/net.sound.lua (original)
+++ branches/knut/data/lua/net.sound.lua Wed Aug  1 22:26:16 2007
@@ -9,14 +9,8 @@
 	local x =3D input:PopNetUint16()
 	local y =3D input:PopNetUint16()
 	local z =3D input:PopNetUint16()
-	=

 	printdebug(&quot;sound&quot;,sprintf(&quot;NET: kPacket_Sound: effect: %i singular: %i x=
:<i> %i y: %i z: %i\n&quot;,effect,singular,x,y,z))
</I>-	=

-	if (gUseSoundeffects) then
-		if (gSoundLoader) then
-			SoundPlayEffect(x,y,z * 0.1,effect)
-		end
-	end
+	SoundPlayEffect(x,y,z * 0.1,effect)
 end
 =

 -- ProtocolRecv_Play_Midi
@@ -25,9 +19,6 @@
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local music_id =3D input:PopNetUint16()
-	printf(&quot;NET: Music id: %i music_id: %i\n&quot;,id,music_id)
-	=

-	if (gUseMusic) then
-		SoundPlayMusicById(music_id)
-	end
+	printdebug(&quot;sound&quot;,sprintf(&quot;NET: kPacket_Music: music_id: %i\n&quot;,music_id))
+	SoundPlayMusicById(music_id)
 end

Modified: branches/knut/data/lua/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/knut/data/lua/net.uodragdrop.lua (original)
+++ branches/knut/data/lua/net.uodragdrop.lua Wed Aug  1 22:26:16 2007
@@ -165,17 +165,21 @@
 	PrepareUODragDrop(item,widget,mat,w,h,offx,offy)
 end
 =

-function PrepareDragDynamic (dynamic) =

-	local iArtID =3D dynamic.artid + hex2num(&quot;0x4000&quot;)
-	local matname =3D GetArtMat(iArtID,dynamic.hue)
-	local w,h =3D GetArtSize(iArtID)
-	local offx,offy =3D -w/2,-h/2 =

-	-- TODO : correct offy would be : bottom of bitmask visible boundbox (NOT=
 -h !), but center looks good enough for most items for now
-	=

-	-- used fields of gDragDrop.item : 	.artid .serial .amount =

-	-- set fields of dynamic : 			.artid .serial .amount .flag  =

-	-- local t =3D GetStaticTileType(dynamic.artid)
-	PrepareUODragDrop(dynamic,nil,matname,w,h,offx,offy)
+-- SiENcE: just skip Multis here
+-- Todo: Multi support
+function PrepareDragDynamic (dynamic)
+	if dynamic.artid &lt; gMulti_ID then
+		local iArtID =3D dynamic.artid + hex2num(&quot;0x4000&quot;)
+		local matname =3D GetArtMat(iArtID,dynamic.hue)
+		local w,h =3D GetArtSize(iArtID)
+		local offx,offy =3D -w/2,-h/2 =

+		-- TODO : correct offy would be : bottom of bitmask visible boundbox (NO=
T -h !), but center looks good enough for most items for now
+		=

+		-- used fields of gDragDrop.item : 	.artid .serial .amount =

+		-- set fields of dynamic : 			.artid .serial .amount .flag  =

+		-- local t =3D GetStaticTileType(dynamic.artid)
+		PrepareUODragDrop(dynamic,nil,matname,w,h,offx,offy)
+	end
 end
 =

 function PrepareUODragDrop (item,widget,matname,w,h,offx,offy)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000133.html">[Iris-commit] [IRIS] r1318 - in /branches/knut/src: profile.cpp	sound_fmod.cpp
</A></li>
	<LI>Next message: <A HREF="000134.html">[Iris-commit] [IRIS] r1320 - in /trunk/data/lua: gui.container.lua gui/ gui/gui.paperdoll.lua net.container.lua net.mobile.lua net.objects.lua net.paperdoll.lua net.player.lua net/ net/net.object.lua obj.mobile.lua obj/ obj/obj.player.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#142">[ date ]</a>
              <a href="thread.html#142">[ thread ]</a>
              <a href="subject.html#142">[ subject ]</a>
              <a href="author.html#142">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
