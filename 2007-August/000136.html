<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1322 - in /trunk/data/lua: ./ gui/ net/ obj/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1322%20-%20in%20/trunk/data/lua%3A%20./%20gui/%20net/%20obj/&In-Reply-To=%3C20070801220554.818A41058006%40localhost.localdomain%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000135.html">
   <LINK REL="Next"  HREF="000137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1322 - in /trunk/data/lua: ./ gui/ net/ obj/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1322%20-%20in%20/trunk/data/lua%3A%20./%20gui/%20net/%20obj/&In-Reply-To=%3C20070801220554.818A41058006%40localhost.localdomain%3E"
       TITLE="[Iris-commit] [IRIS] r1322 - in /trunk/data/lua: ./ gui/ net/ obj/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Thu Aug  2 00:05:47 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000135.html">[Iris-commit] [IRIS] r1321 - in /trunk/data/lua: gui.container.lua gui/gui.container.lua gui/gui.main.lua lib.protocol.lua main.lua net/net.main.lua obj.mobile.lua obj/obj.main.lua obj/obj.mobile.lua
</A></li>
        <LI>Next message: <A HREF="000137.html">[Iris-commit] [IRIS] r1323 - in /trunk/data/lua: lib.protocol.lua	main.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#136">[ date ]</a>
              <a href="thread.html#136">[ thread ]</a>
              <a href="subject.html#136">[ subject ]</a>
              <a href="author.html#136">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Thu Aug  2 00:05:30 2007
New Revision: 1322

Log:
moving code and files around in preperation for merge

Added:
    trunk/data/lua/net/net.dynamic.lua
    trunk/data/lua/net/net.effect.lua
    trunk/data/lua/net/net.mobile.lua
    trunk/data/lua/net/net.multi.lua
      - copied unchanged from r1313, trunk/data/lua/net.customhouse.lua
    trunk/data/lua/net/net.packethandlers.lua
    trunk/data/lua/net/net.uodragdrop.lua
    trunk/data/lua/obj/obj.dynamic.lua
Removed:
    trunk/data/lua/net.customhouse.lua
Modified:
    trunk/data/lua/gui/gui.container.lua
    trunk/data/lua/gui/gui.paperdoll.lua
    trunk/data/lua/lib.packet.lua
    trunk/data/lua/net.other.lua
    trunk/data/lua/net.uodragdrop.lua
    trunk/data/lua/net.walk.lua
    trunk/data/lua/net/net.main.lua
    trunk/data/lua/net/net.object.lua
    trunk/data/lua/obj/obj.main.lua
    trunk/data/lua/obj/obj.mobile.lua

Modified: trunk/data/lua/gui/gui.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.container.lua (original)
+++ trunk/data/lua/gui/gui.container.lua Thu Aug  2 00:05:30 2007
@@ -37,80 +37,6 @@
 		container.dialog =3D nil
 	end
 	gContainer[serial] =3D nil
-end
-
--- create and/or show graphical representation of container
-function gPacketHandler.kPacket_Open_Container() -- 0x24
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local container_serial =3D input:PopNetUint32()
-	local container_gumpid =3D input:PopNetUint16()
-	=

-	print(&quot;# kPacket_Open_Container&quot;,container_serial,container_gumpid)
-	=

-	local container =3D GetOrCreateContainer(container_serial)
-	container.gumpid =3D container_gumpid
-
-	--Ignore Shop container - created somewhere else
-	if (container.gumpid =3D=3D kGumpIDShopContainer) then
-		AddFadeLines(sprintf(&quot;Open_ShopContainer id=3D0x%08x&quot;,container_serial))
-	--Old_Spellbook Container (Pol,Sphere,Lonewolf,RunUO1 etc.)
-	elseif ((container.gumpid =3D=3D kGumpIDSpellbookContainer) and not(conta=
iner.dialog)) then
-		local spellbook =3D {}
-		spellbook.old=3Dtrue
-		spellbook.serial =3D container_serial
-		spellbook.itemid =3D container_gumpid
-		spellbook.scrolloffset =3D 0
-		spellbook.matrix =3D {}
-		for i=3D1, 8 do spellbook.matrix[i] =3D 0 end
-		-- container with spell is already created (invisible)
-		Open_Spellbook(spellbook)
-		printf(&quot;NET: Old_Spellbook: serial=3D0x%08x itemId=3D0x%04x offset=3D0x%=
04x\n&quot;,spellbook.serial, spellbook.itemid, spellbook.scrolloffset)
-	else
-		-- 0x003c =3D backpack
-		-- 0x0030 =3D shopcontainer
-		--AddFadeLines(sprintf(&quot;Open_Container gumpid=3D%d&quot;,container.gumpid))
-		if (not container.dialog) then
-			-- create dialog from scratch
-			local dialog =3D guimaker.MakeSortedDialog()
-			container.dialog =3D dialog
-			dialog.uoContainer =3D container
-			dialog.rootwidget.gfx:SetPos(200,100) -- TODO : choose position
-			dialog.backpane =3D MakeBorderGumpPart(dialog.rootwidget,container.gump=
id,0,0)
-			dialog.backpane.mbIgnoreMouseOver =3D false
-			dialog.backpane.onMouseDown =3D function (widget,mousebutton)
-											if (mousebutton =3D=3D 2) then CloseContainer(widget.dialog.uoC=
ontainer.serial) end
-											if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui=
.StartMoveDialog(widget.dialog.rootwidget) end
-										  end
-		end
-		RefreshContainerItemWidgets(container)
-	end
-	SecureTradeRebuildContainerHook(container)
-end
-
--- pol sends this after kPacket_Open_Container, runuo before, see also kPa=
cket_Object_to_Object
-function gPacketHandler.kPacket_Container_Contents() -- 0x3c
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local itemcount =3D input:PopNetUint16()
-	for i=3D1,itemcount do
-		local item =3D {}
-		item.serial =3D input:PopNetUint32()
-		item.artid =3D input:PopNetUint16()
-		item.artid_addstack =3D input:PopNetUint8()	--unknown1 (alyways 0x00) !?
-		item.amount =3D input:PopNetUint16()
-		item.xloc =3D input:PopNetInt16()
-		item.yloc =3D input:PopNetInt16()
-		--print(&quot;kPacket_Container_Contents&quot;,item.xloc,item.yloc)
-		item.iContainerSerial =3D input:PopNetUint32()
-		item.hue =3D input:PopNetUint16()
-
-		ApplyArtidStackManipulation(item)
-		RefreshContainerItem(item)
-		--printf(&quot;container=3D0x%08x item.serial=3D0x%08x artid=3D0x%04x artid_s=
tack=3D%i item.amount=3D%d\n&quot;,item.iContainerSerial,item.serial,item.artid,=
item.artid_addstack,item.amount)
-		--AddFadeLines(sprintf(&quot;kPacket_Container_Contents type=3D%s&quot;,GetStaticT=
ileTypeName(item.artid)))
-	end
 end
 =

 -- TODO : Add sepearate FILTER : for several Clientside GFX manipulation (=
Game Pieces &amp; Gold,Silver,...)
@@ -155,27 +81,6 @@
 =

 	-- just for testing, remove me
 	--if (item.artid_addstack ~=3D 0) then print(&quot;unexpected item.artid_addst=
ack&quot;,item.artid_addstack) Crash() end
-end
-
--- This is sent by the server to add/update a single item to a container. =
(response to player dragdrop)
-function gPacketHandler.kPacket_Object_to_Object() -- 0x25
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local item =3D {}
-	item.serial =3D input:PopNetUint32()
-	item.artid =3D input:PopNetUint16()
-	item.artid_addstack =3D input:PopNetUint8()
-	item.amount =3D input:PopNetUint16()
-	item.xloc =3D input:PopNetInt16()
-	item.yloc =3D input:PopNetInt16()
-	--print(&quot;kPacket_Object_to_Object&quot;,item.xloc,item.yloc)
-	item.iContainerSerial =3D input:PopNetUint32()
-	item.hue =3D input:PopNetUint16()
-	printdebug(&quot;net&quot;,sprintf(&quot;NET : kPacket_Object_to_Object : container=3D0x=
%08x item=3D0x%08x artid=3D0x%04x amount=3D%d\n&quot;,
-				item.iContainerSerial,item.serial,item.artid,item.amount))
-
-	ApplyArtidStackManipulation(item)
-	RefreshContainerItem(item)
 end
 =

 -- creates if necessary

Modified: trunk/data/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.paperdoll.lua (original)
+++ trunk/data/lua/gui/gui.paperdoll.lua Thu Aug  2 00:05:30 2007
@@ -279,27 +279,6 @@
 	end
 end
 =

-function gPacketHandler.kPacket_Open_Paperdoll() -- 0x88
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local paperdoll =3D {}
-	paperdoll.mobileserial =3D input:PopNetUint32()
-	paperdoll.name =3D input:PopFilledString(60)
-	paperdoll.flag =3D input:PopNetUint8()
-	paperdoll.Close =3D ClosePaperdoll
-	=

-	-- close old paperdoll
-	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
-	if (oldpaperdoll) then oldpaperdoll:Close() end =

-	=

-	-- register paperdoll
-	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
-	=

-	--AddFadeLines(&quot;Open Paperdoll for [&quot;..(paperdoll.mobileserial)..&quot;] &quot;..(p=
aperdoll.name or &quot;&quot;))
-	=

-	RebuildPaperdoll(paperdoll)
-end
-
 --Send Quest, Guild Button req. to Server -&gt; Server returns a Serverside G=
ump
 function Send_AOSCommand(subcmd,player_serial)
 	print(&quot;NET: Send_AOSCommand: &quot;..subcmd..&quot; Player_Serial=3D&quot;..player_seria=
l)

Modified: trunk/data/lua/lib.packet.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.packet.lua (original)
+++ trunk/data/lua/lib.packet.lua Thu Aug  2 00:05:30 2007
@@ -118,7 +118,7 @@
 =

 gPacketType.kPacket_Effect											=3D { id=3Dhex2num(&quot;0x70&quot;) }
 gPacketType.kPacket_Bulletin_Board									=3D { id=3Dhex2num(&quot;0x71&quot;) }
-gPacketType.kPacket_Combat											=3D { id=3Dhex2num(&quot;0x72&quot;) }
+gPacketType.kPacket_SetPlayerWarmode								=3D { id=3Dhex2num(&quot;0x72&quot;) }
 gPacketType.kPacket_Ping											=3D { id=3Dhex2num(&quot;0x73&quot;) }
 gPacketType.kPacket_Shop_Data										=3D { id=3Dhex2num(&quot;0x74&quot;) }
 gPacketType.kPacket_Rename_MOB										=3D { id=3Dhex2num(&quot;0x75&quot;) }
@@ -170,7 +170,7 @@
 gPacketType.kPacket_Server_Select									=3D { id=3Dhex2num(&quot;0xA0&quot;) }
 gPacketType.kPacket_HP_Health										=3D { id=3Dhex2num(&quot;0xA1&quot;) }
 gPacketType.kPacket_Mana_Health										=3D { id=3Dhex2num(&quot;0xA2&quot;) }
-gPacketType.kPacket_Fat_Health										=3D { id=3Dhex2num(&quot;0xA3&quot;) }
+gPacketType.kPacket_Stamina											=3D { id=3Dhex2num(&quot;0xA3&quot;) }
 gPacketType.kPacket_Hardware_Info									=3D { id=3Dhex2num(&quot;0xA4&quot;) }
 gPacketType.kPacket_Web_Browser										=3D { id=3Dhex2num(&quot;0xA5&quot;) }
 gPacketType.kPacket_Message											=3D { id=3Dhex2num(&quot;0xA6&quot;) }	--Tips/=
Notice window

Modified: trunk/data/lua/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.other.lua (original)
+++ trunk/data/lua/net.other.lua Thu Aug  2 00:05:30 2007
@@ -610,30 +610,10 @@
 	out:SendPacket()
 end
 =

--- Request WarMode Change/Send War Mode Status
-function gPacketHandler.kPacket_Combat()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local flag =3D input:PopNetUint8()
-	local unknown1 =3D input:PopNetUint8()
-	local unknown2 =3D input:PopNetUint16()
-	if (flag =3D=3D gWarmode_Normal) then
-		gActWarmode=3DgWarmode_Normal
-		AddFadeLines(&quot;Be the peace with you!&quot;)
-		--printf(&quot;NET: kPacket_Combat id: 0x%02x gWarmode: normal\n&quot;,id)
-	end
-	if (flag =3D=3D gWarmode_Combat) then
-		gActWarmode=3DgWarmode_Combat
-		AddFadeLines(&quot;You go into War!&quot;)
-		--printf(&quot;NET: kPacket_Combat id: 0x%02x gWarmode: combat\n&quot;,id)
-	end
-	gui.SetWarmode(gActWarmode)
-end
-
--- send combat request to server, triggers kPacket_Combat
+-- send combat request to server, triggers kPacket_SetPlayerWarmode
 function Send_CombatMode(iWarMode)
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Combat)
+	out:PushNetUint8(kPacket_SetPlayerWarmode)
 	out:PushNetUint8(iWarMode)
 	out:PushNetUint16(hex2num(&quot;0x0032&quot;))
 	out:PushNetUint8(hex2num(&quot;0x00&quot;))

Modified: trunk/data/lua/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.uodragdrop.lua (original)
+++ trunk/data/lua/net.uodragdrop.lua Thu Aug  2 00:05:30 2007
@@ -54,82 +54,6 @@
 gDragStartDist =3D 5 -- in pixels
 gSquareDragStartDist =3D gDragStartDist * gDragStartDist
 =

-
--- Equip Item Request   (answer is 0x2E, see also 0x78). 0x13
-function Send_Equip_Item_Request(serial,layer,player_serial)
-	print(&quot;NET: Send_Equip_Item_Request:&quot;,sprintf(&quot;0x%08x&quot;,serial),layer,play=
er_serial)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Equip_Item_Request)
-	out:PushNetUint32(serial)
-	out:PushNetUint8(layer)
-	out:PushNetUint32(player_serial)
-	out:SendPacket()
-end
-
--- This is sent by the client when the player picks up an item. 0x07
-function Send_Take_Object(serial,amount)
-	print(&quot;NET: Send_Take_Object:&quot;,sprintf(&quot;0x%08x&quot;,serial),serial,amount)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Take_Object)
-	out:PushNetUint32(serial)
-	out:PushNetUint16(amount or 1)
-	out:SendPacket()
-end
-
--- This is sent by the client when the player drops an item. 0x08
--- containerid =3D 0xFFFFFFFF  when the container is the ground
-function Send_Drop_Object(serial,x,y,z,containerid)
-	print(&quot;NET: Send_Drop_Object:&quot;,sprintf(&quot;0x%08x&quot;,serial),x,y,z,containerid)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Drop_Object)
-	out:PushNetUint32(serial)
-	out:PushNetUint16(x)
-	out:PushNetUint16(y)
-	out:PushInt8(z) -- SIGNED !!
-	out:PushNetUint32(containerid)
-	out:SendPacket()
-end
- =

--- This is sent to deny the player's request to get an item. (servers resp=
onse to 0x07)
-function gPacketHandler.kPacket_Get_Item_Failed() -- 0x27
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local reason =3D input:PopNetUint8()
-	local reasontxt =3D &quot;unknown_Get_Item_Failed&quot;
-	if (reason =3D=3D hex2num(&quot;0x00&quot;)) then reasontxt =3D &quot;You cannot pick th=
at up.&quot; end
-	if (reason =3D=3D hex2num(&quot;0x01&quot;)) then reasontxt =3D &quot;That is too far aw=
ay.&quot; end
-	if (reason =3D=3D hex2num(&quot;0x02&quot;)) then reasontxt =3D &quot;That is out of sig=
ht.&quot; end
-	if (reason =3D=3D hex2num(&quot;0x03&quot;)) then reasontxt =3D &quot;That item does not=
 belong to you. You will have to steal it.&quot; end
-	if (reason =3D=3D hex2num(&quot;0x04&quot;)) then reasontxt =3D &quot;You are already ho=
lding an item.&quot; end
-	if (reason =3D=3D hex2num(&quot;0x05&quot;)) then =

-		reasontxt =3D &quot;The item was destroyed.&quot;  -- TODO : no message ??
-		-- TODO : Destroy the item.
-	end
-	if (reason =3D=3D hex2num(&quot;0x06&quot;)) then -- No message.
-		reasontxt =3D false
-	end
-	print(&quot;NET : Get_Item_Failed&quot;,reasontxt)
-	CleanUpUODragDrop() -- server side cancel
-end
-
--- Clear Square or Drop Failed ? (servers response to 0x08 ?)
-function gPacketHandler.kPacket_Drop_Item_Failed() -- 0x28
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local xloc =3D input:PopNetUint16()
-	local yloc =3D input:PopNetUint16()
-	-- TODO ?
-	print(&quot;NET : Drop_Item_Failed&quot;)
-end
-
--- Drop Item OK ? Paperdoll Clothing Added ? (servers response to 0x08 ?)
-function gPacketHandler.kPacket_Drop_Item_OK() -- 0x29
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	-- TODO ?
-	print(&quot;NET : Drop_Item_OK&quot;)
-end
- =

 gDragDrop =3D false
 =

 function PrepareDragPaperdollItem (item) =


Modified: trunk/data/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.walk.lua (original)
+++ trunk/data/lua/net.walk.lua Thu Aug  2 00:05:30 2007
@@ -615,69 +615,6 @@
 	out:SendPacket()
 end
 =

--- 0x20 Teleport packet (also known as ProtocolRecv_Draw_Player)
--- Note: Only used with the character being played by the client. =

--- TODO : center cam on player etc. , check z_location on the ground
-function gPacketHandler.kPacket_Teleport()
-	gLastResyncRequest =3D nil
-	--ResetWalkQueue()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local player_id =3D input:PopNetUint32()
-	local player_bodytype =3D input:PopNetUint16()
-	local unknown1 =3D input:PopNetUint8()
-	local player_skin_hue =3D input:PopNetUint16()
-	local player_status =3D input:PopNetUint8()
-	local player_xloc =3D input:PopNetUint16()
-	local player_yloc =3D input:PopNetUint16()
-	local unknown2 =3D input:PopNetUint16()
-	local player_dir =3D input:PopNetUint8()
-	local player_zloc =3D input:PopInt8()
-	=

-	local bPlayerRunning =3D BitwiseAND(player_dir,kWalkFlag_Run) ~=3D 0
-	local fullplayerdir =3D player_dir
-	player_dir =3D BitwiseAND(player_dir,hex2num(&quot;0x07&quot;))
-	=

-	gCurrentRenderer:ClientSideMobileAnimPlayerTeleported()
-
-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player (Pos before Teleport) XLoc: =
%i YLoc: %i ZLoc: %i Dir: [%s]\n&quot;,
-			gPlayerXLoc or 0, gPlayerYLoc or 0, gPlayerZLoc or 0, gDirection[gPlaye=
rDir or 0] or &quot;&quot;))
-	=

-	-- TODO : (Check if char is in Boat!)
-
-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player: id: %i player_id: %i body: =
%i XLoc: %i YLoc: %i ZLoc: %i Dir: 0x%02x [%s]\n&quot;,
-			id, player_id, player_bodytype, player_xloc, player_yloc, player_zloc, =
fullplayerdir, gDirection[player_dir] or &quot;&quot;))
-
-	-- Check if Player is already on Teleported Pos
-	if (gPlayerXLoc ~=3D player_xloc or gPlayerYLoc ~=3D player_yloc or
-		gPlayerZLoc ~=3D player_zloc or gPlayerDir ~=3D player_dir) then
-		SetPlayerPos(player_xloc,player_yloc,player_zloc,fullplayerdir)
-		print(&quot;Player is teleported.&quot;)
-	else
-		print(&quot;Player not teleported, because already on the same pos+dir!&quot;)
-	end
-
-	UpdatePlayerBodySerial(player_id)
-	local playerMobile=3DGetPlayerMobile()
-	if (playerMobile) then
-		if (playerMobile.artid ~=3D player_bodytype) then
-			print(&quot;Change PC Bodytype=3D&quot;..player_bodytype)
-			playerMobile.artid=3Dplayer_bodytype
-
-			-- currently only for human (not elfs)
-			if ( (playerMobile.artid=3D=3D402) or (playerMobile.artid=3D=3D403) or
-				 (playerMobile.artid=3D=3D607) or (playerMobile.artid=3D=3D608) or
-				 (playerMobile.artid=3D=3D970)) then
-				print(&quot;TODO : pc character is now ghost. new bodymodel=3D&quot;..player_bod=
ytype)
-			end
-
-			gCurrentRenderer:UpdateMobile( playerMobile )
-		end
-	end
-
-	ResetWalkQueue() -- todo : (here or only if setplayerpos is done?)
-end
-
 -- Moves Player to Direction
 -- This packet works with the latest clients, but is never used by the ser=
ver.
 -- TODO : Move Player
@@ -736,7 +673,7 @@
 MaxZClimb =3D 20;
 MaxZFall =3D 20;
 =

-received lots of kPacket_Fat_Health 0xA3 : update stamina
+received lots of kPacket_Stamina 0xA3 : update stamina
 BYTE cmd
 BYTE[4] playerID
 BYTE[2] maxStamina

Modified: trunk/data/lua/net/net.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.main.lua (original)
+++ trunk/data/lua/net/net.main.lua Thu Aug  2 00:05:30 2007
@@ -1,6 +1,9 @@
---~ dofile(libpath .. &quot;net/net.mobile.lua&quot;)
---~ dofile(libpath .. &quot;net/net.dynamic.lua&quot;)
+dofile(libpath .. &quot;net/net.mobile.lua&quot;)
+dofile(libpath .. &quot;net/net.dynamic.lua&quot;)
 dofile(libpath .. &quot;net/net.object.lua&quot;)
---~ dofile(libpath .. &quot;net/net.effect.lua&quot;)
---~ dofile(libpath .. &quot;net/net.multi.lua&quot;)
---~ dofile(libpath .. &quot;net/net.uodragdrop.lua&quot;)
+dofile(libpath .. &quot;net/net.effect.lua&quot;)
+dofile(libpath .. &quot;net/net.multi.lua&quot;)
+dofile(libpath .. &quot;net/net.uodragdrop.lua&quot;)
+
+-- only things that have at least 2 packets get its own file, everything e=
lse is handled here:
+dofile(libpath .. &quot;net/net.packethandlers.lua&quot;)

Modified: trunk/data/lua/net/net.object.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.object.lua (original)
+++ trunk/data/lua/net/net.object.lua Thu Aug  2 00:05:30 2007
@@ -76,148 +76,3 @@
 	-- TODO : gCurrentRenderer:DestroyMousePickItemBySerial(serial)
 	-- TODO : DestroyDragDropItemBySerial ?? done by CancelUODragDrop
 end
-
--- Dynamics/Object Information (Variable # of bytes)
--- (recieved when item first appears on char visualrange on the ground)
---			// 14 base length
---			// +2 - Amount
---			// +2 - Hue
---			// +1 - Flags
--- TODO : here Tooltip request   0x1A  (old iris:PCK_Put)
---[[
-Packet [1a], Length: 17, Type: Server
-1a 00 11 c0 02 9d aa 00 00 00 01 15 44 44 88 9c =

-80
-]]--
-function gPacketHandler.kPacket_Show_Item()
-	local newitem =3D {}
-	local input =3D GetRecvFIFO()
-	local popped_start =3D input:GetTotalPopped()
-	local id =3D input:PopNetUint8()
-	=

-	local iPacketSize =3D input:PopNetUint16()
-	newitem.serial =3D input:PopNetUint32() -- id =3D serial . Include the fl=
ag 0x80000000 if the item's amount is greater than one.
-	newitem.artid =3D input:PopNetUint16() -- model =3D artwork . Include the=
 flag 0x8000 if the item's stackid is greater than zero.	=

-	=

-	-- newitem.amount  (or model # for corpses)
-	if ( BitwiseAND(newitem.serial,hex2num(&quot;0x80000000&quot;)) ~=3D 0) then =

-			newitem.amount =3D input:PopNetUint16() =

-	else 	newitem.amount =3D 1 end
-	=

-	--print(&quot;artid,artidhex,bitwiseand&quot;,newitem.artid,sprintf(&quot;0x%04x&quot;,newite=
m.artid),BitwiseAND(newitem.artid,hex2num(&quot;0x8000&quot;)))
-	=

-	-- newitem.artid_addstack : The number to add to the item's artwork when =
Amount &gt; 1.
-	if ( BitwiseAND(newitem.artid,hex2num(&quot;0x8000&quot;)) ~=3D 0) then =

-			newitem.artid_addstack =3D input:PopNetUint8() =

-	else	newitem.artid_addstack =3D 0 end
-
-	newitem.xloc =3D input:PopNetUint16() --only use lowest significant 15 bi=
ts)
-	newitem.yloc =3D input:PopNetUint16()
-
-	if ( BitwiseAND(newitem.xloc,hex2num(&quot;0x8000&quot;)) ~=3D 0) then
-			newitem.dir =3D input:PopNetUint8()
-	else	newitem.dir =3D 0 end
-
-	newitem.zloc =3D input:PopInt8()
-
-	newitem.hue =3D 0
-	newitem.flag =3D 0
-	if (iPacketSize - (input:GetTotalPopped() - popped_start) &gt;=3D 2) then
-		if (BitwiseAND(newitem.yloc,hex2num(&quot;0x8000&quot;)) ~=3D 0) then newitem.hue =
=3D input:PopNetUint16() end
-	end
-	if (iPacketSize - (input:GetTotalPopped() - popped_start) &gt;=3D 1) then
-		if (BitwiseAND(newitem.yloc,hex2num(&quot;0x4000&quot;)) ~=3D 0) then newitem.flag=
 =3D input:PopNetUint8() end
-	end
-	-- item_flag : some kind of status or flags, usage unknown
-	=

-	newitem.serial	=3D BitwiseAND(newitem.serial,hex2num(&quot;0x7fffffff&quot;))
-	newitem.artid	=3D BitwiseAND(newitem.artid,hex2num(&quot;0x7fff&quot;))
-	newitem.xloc	=3D BitwiseAND(newitem.xloc,hex2num(&quot;0x7fff&quot;))
-	newitem.yloc	=3D BitwiseAND(newitem.yloc,hex2num(&quot;0x3fff&quot;))
-	if (newitem.amount &gt; 1) then newitem.artid =3D newitem.artid + newitem.ar=
tid_addstack end
-	=

-	=

-	-- TODO : corpse is spawned
-	if (newitem.artid =3D=3D hex2num(&quot;0x2006&quot;)) then
-		print(&quot;TODO: char died. sethue,setdirection,setascorpse&quot;)
-	end
-
-	-- TODO : if (newitem.artid &gt;=3D gMulti_ID +100) .. model is multi
-	-- gMulti_ID =3D hex2num(&quot;0x4000&quot;)
-	-- TODO : check newitem.artid for boat
-	=

-	if (gTileTypeLoader) then
-		local miFlags,miWeight,miQuality,miUnknown,miUnknown1,miQuantity,miAnimI=
D,miUnknown2,miHue,miUnknown3,miHeight,msName =3D gTileTypeLoader:GetStatic=
TileType(newitem.artid+32*512) -- add 0x00004000
-		newitem.z_typename =3D msName
-	end
-	=

-	printdebug(&quot;mobile&quot;,&quot;ShowItem &quot;..vardump(newitem))
-	=

-	newitem.isdynamic =3D true -- needed to identify the dynamic in 2d render=
er
-	=

-	local bCreateNew =3D true
-	=

-	local olditem =3D gDynamics[newitem.serial]
-	if (olditem) then
-		-- if only the position changed we can just update the old one
-		if (	newitem.artid =3D=3D olditem.artid and =

-				newitem.amount =3D=3D olditem.amount and =

-				newitem.flag =3D=3D olditem.flag and =

-				newitem.hue =3D=3D olditem.hue and =

-				newitem.dir =3D=3D olditem.dir and =

-				newitem.artid_addstack =3D=3D olditem.artid_addstack ) then
-			-- update old item
-			bCreateNew =3D false
-			olditem.xloc =3D newitem.xloc
-			olditem.yloc =3D newitem.yloc
-			olditem.zloc =3D newitem.zloc
-			newitem =3D olditem
-		else
-			gCurrentRenderer:RemoveDynamicItem( olditem )
-		end
-	end
-	=

-	if (bCreateNew) then gCurrentRenderer:AddDynamicItem( newitem ) end
-	=

-	gCurrentRenderer:UpdateDynamicItemPos(newitem)
-	gDynamics[newitem.serial] =3D newitem	=

-end
-
--- Graphical Effect (Hued Art-Gfx / see Tiledata for Animation) - Billboar=
d or 3d Statics?
--- TODO : organize HUED_FX
-function gPacketHandler.kPacket_Hued_FX()	--0xC0
-	local effect =3D {}
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	effect.effect_type =3D input:PopNetUint8()
-	effect.sourceserial =3D input:PopNetUint32()
-	effect.targetserial =3D input:PopNetUint32()
-	effect.itemid =3D input:PopNetUint16()
-	=

-	effect.source_locx =3D input:PopNetUint16()
-	effect.source_locy =3D input:PopNetUint16()
-	effect.source_locz =3D input:PopNetUint8()
-	=

-	effect.target_locx =3D input:PopNetUint16()
-	effect.target_locy =3D input:PopNetUint16()
-	effect.target_locz =3D input:PopNetUint8()
-
-	effect.current_locx =3D effect.source_locx
-	effect.current_locy =3D effect.source_locy
-	effect.current_locz =3D effect.source_locz
-
-	effect.speed =3D input:PopNetUint8()
-	effect.duration =3D input:PopNetUint8()
-	effect.unkown =3D input:PopNetUint16()
-	effect.fixeddirection =3D input:PopNetUint8()
-	effect.explodes =3D input:PopNetUint8()
-	effect.hue =3D input:PopNetUint32()
-	effect.rendermode =3D input:PopNetUint32()
-	effect.iseffect =3D true
-	=

-	printf(&quot;NET: Hued_FX: artid=3D0x%04x locx=3D%i locy=3D%i locz=3D%i target=
x=3D%i targety=3D%i targetz=3D%i effect_type=3D%s\n&quot;,
-			effect.itemid, effect.source_locx, effect.source_locy, effect.source_lo=
cz,
-			effect.target_locx, effect.target_locy, effect.target_locz, gEffectType=
s[effect.effect_type] or &quot;&quot;)
-	=

-	if (gParticleEffectSystem) then gCurrentRenderer:AddEffect( effect ) end
-end

Modified: trunk/data/lua/obj/obj.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.main.lua (original)
+++ trunk/data/lua/obj/obj.main.lua Thu Aug  2 00:05:30 2007
@@ -1,3 +1,3 @@
 dofile(libpath .. &quot;obj/obj.mobile.lua&quot;)
---dofile(libpath .. &quot;obj/obj.dynamic.lua&quot;)
+dofile(libpath .. &quot;obj/obj.dynamic.lua&quot;)
 dofile(libpath .. &quot;obj/obj.player.lua&quot;)

Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Thu Aug  2 00:05:30 2007
@@ -122,377 +122,6 @@
 	gCurrentRenderer:UpdateMobile( mobile )
 end
 =

--- Character Animation
-function gPacketHandler.kPacket_Animation ()	-- [0x6e] 14 Bytes
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local anim =3D {}
-	anim.mobileserial	=3D input:PopNetUint32()	=

-	anim.m_animation		=3D input:PopNetUint16()
-	anim.m_framecount	=3D input:PopNetUint16()
-	anim.m_repeat		=3D input:PopNetUint16()	--repeat (1 =3D once / 2 =3D twic=
e / 0 =3D repeat forever)
-	anim.m_animForward	=3D input:PopNetUint8()	--(0x00=3Dforward, 0x01=3Dback=
wards)
-	anim.m_repeatFlag	=3D input:PopNetUint8()	--(0 - Don't repeat / 1 repeat)
-	anim.m_frameDelay	=3D input:PopNetUint8()	--(0x00 - fastest / 0xFF - Too =
slow to watch)
-	printdebug(&quot;animation&quot;,&quot;Animation &quot;..vardump2(anim))
-	gCurrentRenderer:MobileStartServerSideAnim(anim)
-end
-
--- simple mobile, no equipment, fixed size packet 0x77
-function gPacketHandler.kPacket_Naked_MOB ()
-	local mobile =3D {}
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	mobile.serial =3D input:PopNetUint32()
-	=

-	local oldmobile =3D gMobiles[mobile.serial]
-	if (oldmobile) then mobile =3D oldmobile end -- update	=

-	mobile.ismobile =3D true -- needed to identify the mobile in 2d renderer
-	=

-	mobile.artid =3D input:PopNetUint16()
-	mobile.xloc =3D input:PopNetUint16()
-	mobile.yloc =3D input:PopNetUint16()
-	mobile.zloc =3D input:PopInt8()
-	mobile.dir =3D input:PopNetUint8()
-	mobile.hue =3D input:PopNetUint16() -- hue/skin color
-	mobile.flag =3D input:PopNetUint8()
-	mobile.notoriety =3D input:PopNetUint8()
-	=

-	--AddFadeLines(&quot;nakedmob [&quot;..(mobile.serial)..&quot;]&quot;)
-	--print(&quot;\t\tNaked_MOB &quot;..vardump(mobile))
-	=

-	gMobiles[mobile.serial] =3D mobile
-	=

-	-- request basic stats info
-	Send_ClientQuery(gRequest_States,mobile.serial)
-	=

-	UpdateMobile(mobile)
-end
-
--- Equipped_MOB packet (0x78)
--- TODO : rest of the packet
--- TODO : Tooltip request
-function gPacketHandler.kPacket_Equipped_MOB() -- ProtocolRecv_AddMobile
-	local mobile =3D {}
-	local input =3D GetRecvFIFO()
-	local fifolen_start =3D input:Size()
-	local id =3D input:PopNetUint8()
-	local iPacketSize =3D input:PopNetUint16()
-	mobile.serial =3D input:PopNetUint32()
-	=

-	local oldmobile =3D gMobiles[mobile.serial]
-	if (oldmobile) then mobile =3D oldmobile end -- update
-	mobile.ismobile =3D true -- needed to identify the mobile in 2d renderer
-	=

-	mobile.artid =3D input:PopNetUint16()
-
-	if (BitwiseAND(mobile.serial,hex2num(&quot;0x80000000&quot;)) ~=3D 0) then
-			mobile.amount =3D input:PopNetUint16()
-			print(&quot;tag corpse&quot;)
-	else 	mobile.amount =3D 1 end -- amount/Corpse Model Num
-	=

-	mobile.xloc =3D input:PopNetUint16()
-	mobile.yloc =3D input:PopNetUint16()
-	=

-	-- TOOD : check if this 2nd dir actually is used, or just a copy/paste er=
ror in the packet guide ?!?
-	if (BitwiseAND(mobile.xloc,hex2num(&quot;0x8000&quot;)) ~=3D 0) then
-			mobile.dir2 =3D input:PopNetUint16()
-			print(&quot;tag dir2&quot;)
-	else 	mobile.dir2 =3D -1 end -- why 2 directions ?!?
-
-	mobile.zloc =3D input:PopInt8()
-	mobile.dir =3D input:PopNetUint8()
-	mobile.hue =3D input:PopNetUint16()  -- dye/skin color
-	mobile.flag =3D input:PopNetUint8()
-	mobile.notoriety =3D input:PopNetUint8() -- TODO : (2's complement signed)
-	mobile.equipment =3D {}
-
-	local equipcount =3D 0
-	local loopalive =3D true
-
-	while loopalive do =

-		local item =3D {}
-		if ( iPacketSize &gt;=3D (fifolen_start - input:Size()+4) ) then
-			item.serial =3D input:PopNetUint32()
-			if (item.serial =3D=3D 0) then
-				loopalive =3D false
-			else
-				item.mobile =3D mobile
-				item.mobile_serial =3D mobile.serial
-				=

-				if ( iPacketSize &gt;=3D (fifolen_start - input:Size()+3) ) then
-					item.artid =3D input:PopNetUint16()
-					item.layer =3D input:PopNetUint8()
-					if ((BitwiseAND(item.artid,hex2num(&quot;0x8000&quot;)) ~=3D 0) and ( iPacketSi=
ze &gt;=3D (fifolen_start - input:Size()+2) )) then
-							item.hue =3D input:PopNetUint16()
-					else	item.hue =3D 0 -- TODO : default value ?
-					end
-					item.artid =3D BitwiseAND(item.artid,hex2num(&quot;0x7fff&quot;))
-					if (mobile.equipment[item.layer]) then print(&quot;Equipped_MOB : layer co=
ntains more than one item&quot;,item.layer) end
-					mobile.equipment[item.layer] =3D item
-					gMobileItemsBySerial[item.serial] =3D item
-					--print(&quot;Equipped_MOB add item&quot;,mobile.serial,sprintf(&quot;0x%02x&quot;,item.l=
ayer),item.artid)
-					equipcount =3D equipcount + 1
-				else
-					loopalive =3D false
-				end
-			end
-		else
-			loopalive =3D false
-		end
-	end
-	=

-	if (equipcount &gt; 2) then gMobileWithPaperdoll =3D mobile end
-	=

-	mobile.serial	=3D BitwiseAND(mobile.serial,hex2num(&quot;0x7fffffff&quot;))
-	mobile.xloc		=3D BitwiseAND(mobile.xloc,hex2num(&quot;0x7fff&quot;))
-
-	--AddFadeLines(&quot;equippedmob [&quot;..(mobile.serial)..&quot;]&quot;)
-	--print(&quot;\t\tEquipped_MOB &quot;..vardump(mobile))
-	gMobiles[mobile.serial] =3D mobile
-	=

-	-- request basic stats info
-	Send_ClientQuery(gRequest_States,mobile.serial)
-
-	UpdateMobile(mobile)	=

-	=

-	UpdateMobileEquipment(mobile)
-end
-
-
--- 0x2E  Equip Item  (single item update version of 0x78 : equipped mobile)
--- This is sent by the server to equip a single item on a character.
---Packet [2e], Length: 15, Type: Server
---2e 40 02 21 9b 20 3b 00 0b 00 00 00 03 04 5e =

-function gPacketHandler.kPacket_Equip_Item() -- ProtocolRecv_AddMobile
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local item =3D {}
-	item.serial  =3D input:PopNetUint32() -- (always starts 0x40 in my data)
-	item.artid =3D input:PopNetUint16() -- also known as model
-	item.unknown1 =3D input:PopNetUint8() if (item.unknown1 ~=3D 0) then prin=
t(&quot;NET : kPacket_Equip_Item : unexpected unknown1 : &quot;,vardump(item)) end
-	item.layer =3D input:PopNetUint8()
-	item.mobile_serial  =3D input:PopNetUint32() -- &quot;container&quot; for item
-	item.hue =3D input:PopNetUint16()
-	=

-	--print(&quot;NET : Equip_Item&quot;,vardump(item))
-	=

-	local mobile =3D gMobiles[item.mobile_serial]
-	if (mobile) then
-		item.mobile =3D mobile
-		if (mobile.equipment[item.layer]) then
-			DestroyMobileItem(mobile.equipment[item.layer])
-		end
-		mobile.equipment[item.layer] =3D item
-		gMobileItemsBySerial[item.serial] =3D item
-		--printf(&quot;NET : kPacket_Equip_Item mobile=3D0x%08x item=3D0x%08x\n&quot;,item=
.mobile_serial,item.serial)
-		UpdateMobileEquipment(mobile)
-	else =

-		print(&quot;WARNING ! mobile update for unknown mobile received, update lost =
!&quot;)
-
-		-- don't crash on UOX3, Lonewolf (this servers sends unknown Equip messa=
ges)
-		if ((gServerType[gServerEmulator] ~=3D &quot;Lonewolf&quot;) and (gServerType[gSer=
verEmulator] ~=3D &quot;SpherePolUox3&quot;)) then
-			print(&quot;Crash Client here!&quot;..gServerType[gServerEmulator])
-			Crash()
-		end
-
-		-- the client state would loose sync with server, this is fatal, =

-		-- but should never happen for correct server implementation ? (there ar=
e strange servers however...)
-		-- an alternative would be to create the mobile if unknown , something l=
ike GetOrCreateMobile like in net.container.lua
-	end
-end
-
--- Note: For characters other than the player, currentHitpoints and maxHit=
points are not the actual values.
--- MaxHitpoints is a fixed value, and currentHitpoints works like a percen=
tage.
--- triggered by Send_ClientQuery(gRequest_States,playermobile.serial)
--- TODO : Set also HP,Stamina,Mana here
-function gPacketHandler.kPacket_Mobile_Stats() -- 0x11
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local iPacketSize =3D input:PopNetUint16()
-	=

-	local stats =3D {}
-	mobile_id	=3D input:PopNetUint32()
-	local mobilename =3D input:PopFilledString(30)
-	=

-	--printf(&quot;NET : kPacket_Mobile_Stats mobile=3D0x%08x name=3D%s\n&quot;,mobile_=
id,mobilename)
-	=

-	local mobile =3D gMobiles[mobile_id]
-	local oldhp =3D 0
-	if (mobile) then
-		if (mobile.stats) then =

-			oldhp =3D mobile.stats.currentHitpoints	-- save old HitPoints for notif=
ication (see below)
-			stats =3D mobile.stats					-- is stats, use old stats and update it
-		else
-			print(&quot;mobile has no stats yet&quot;)
-		end
-	end
-
-	stats.currentHitpoints		=3D input:PopNetUint16()
-	stats.maxHitpoints 			=3D input:PopNetUint16()
-	stats.flagChangeNameFlag	=3D input:PopNetUint8()		--(0x1 =3D allowed, 0 =
=3D not allowed)
-	stats.bCanChangeName =3D stats.flagChangeNameFlag ~=3D 0
-	local flag =3D input:PopNetUint8()
-	stats.flag =3D flag
-	=

-	-- more data following
-	if ((flag =3D=3D 1) or (flag =3D=3D 3) or (flag =3D=3D 4) or (flag =3D=3D=
 5)) then -- stats
-		stats.char_sex		=3D input:PopNetUint8() -- * 0x00 - Male     * 0x01 - Fe=
male
-		stats.char_str		=3D input:PopNetUint16()
-		stats.char_dex		=3D input:PopNetUint16()
-		stats.char_int		=3D input:PopNetUint16()
-		stats.char_curSta	=3D input:PopNetUint16()
-		stats.char_maxSta	=3D input:PopNetUint16()
-		stats.char_curMana	=3D input:PopNetUint16()
-		stats.char_maxMana	=3D input:PopNetUint16()
-		stats.char_gold		=3D input:PopNetUint32()
-		stats.char_armorC	=3D input:PopNetUint16() -- resistPhysical (old client=
s: AC).
-		stats.char_curWeight=3D input:PopNetUint16()
-
-		if (flag =3D=3D 5) then
-			stats.char_maxWeight =3D input:PopNetUint16()
-			stats.char_race		 =3D input:PopNetUint8()
-		end
-
-		if ((flag =3D=3D 3) or (flag =3D=3D 4) or (flag =3D=3D 5)) then -- Follo=
wers (pets)
-			stats.char_statcap	=3D input:PopNetUint16()		-- The character's total a=
llowable sum of Strength, Intelligence, and Dexterity
-			stats.char_curPet	=3D input:PopNetUint8()			=

-			stats.char_maxPet	=3D input:PopNetUint8()
-			=

-			if ((flag =3D=3D 4) or (flag =3D=3D 5)) then -- Resistances
-				stats.char_fireresist	=3D input:PopNetUint16()			=

-				stats.char_coldresist	=3D input:PopNetUint16()			=

-				stats.char_poisonresist	=3D input:PopNetUint16()			=

-				stats.char_energyresist	=3D input:PopNetUint16()			=

-				stats.char_luck			=3D input:PopNetUint16()			=

-				stats.char_minDamage	=3D input:PopNetUint16()			=

-				stats.char_maxDamage	=3D input:PopNetUint16()			=

-				stats.char_tithing		=3D input:PopNetUint32()			=

-			end
-		end
-	end
-
-	-- Update Mobile
-	if (mobile) then
-		mobile.name=3Dmobilename
-		mobile.stats =3D stats
-		-- not needed due to normal damage packet
-		-- TODO is this ok for every server?
-		-- gCurrentRenderer:NotifyHPChange(mobile_id, oldhp, mobile.stats.curren=
tHitpoints)
-		UpdateMobile(mobile)
-	end
-	=

-	TradeUpdatePlayerGold()
-end
-
---[[
-Mobile Stats    0x11  	=

-Show Mobile .. 0xD3
-Rename MOB  0x75  	=

-MOB Name	0x98  	=

-kPacket_Naked_MOB    	0x77  	=

-kPacket_Update_Mobile	0xD2  (extended 0x20)  similar to the Naked MOB pack=
et.   pos..
-
-0xD2 : kPacket_Update_Mobile : &quot;Extended 0x20&quot;  25 Byte length
-    * BYTE cmd
-    * Preamble: Exactly like 0x20
-    * BYTE[2] unknown 1
-    * BYTE[2] unknown 2
-    * BYTE[2] unknown 3
-
-Note: currently unknown's don't seem to do anything.
-That packet has never been sighted on OSI servers as well.
-We probably have to wait till OSI activates it/finishes implementation., t=
o see what it does.
-
-]]--
-
-
---[[
-Mobile Flag Byte: maybe those are similar to the kPacket_Show_Item flag/st=
atus byte ?
-0x00 - None
-0x02 - Female
-0x04 - Poisoned
-0x08 - YellowHits // healthbar gets yellow
-0x10 - FactionShip // unsure why client needs to know
-0x20 - Movable if normally not
-0x40 - War mode
-0x80 - Hidden =

-]]--
-
-
---# Update Current Health [0xA1]
--- TODO : not only player gets update packets here - also the defender of =
a combat
-function gPacketHandler.kPacket_HP_Health()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local mobile_id =3D input:PopNetUint32()
-	local maxval =3D input:PopNetUint16()
-	local curval =3D input:PopNetUint16()
-	printdebug(&quot;mobile&quot;,sprintf(&quot;NET: update HP: mobile_serial=3D0x%08x  %i /=
 %i\n&quot;,mobile_id,curval,maxval))
-	=

-	local mobile =3D gMobiles[mobile_id]
-	-- TODO pol sends normal hp update and x/1000 hp update ???? so i ignore =
the strange one
-	if (mobile and (maxval ~=3D 1000) and mobile.stats) then
-		if mobile.stats.currentHitpoints then
-			-- if there was a change, plop a text
-			local old =3D mobile.stats.currentHitpoints
-			gCurrentRenderer:NotifyHPChange(mobile_id, old, curval)
-		end
-		-- update values
-		mobile.stats.currentHitpoints =3D curval
-		mobile.stats.maxHitpoints =3D maxval
-
-		UpdateMobile(mobile)
-	end
-end
-
---# Update Current Mana [0xA2]
--- TODO : not only player gets update packets here
-function gPacketHandler.kPacket_Mana_Health()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local mobile_id =3D input:PopNetUint32()
-	local maxval =3D input:PopNetUint16()
-	local curval =3D input:PopNetUint16()
-	printdebug(&quot;mobile&quot;,sprintf(&quot;NET: update MANA: mobile_serial=3D0x%08x  %i=
 / %i\n&quot;,mobile_id,curval,maxval))
-	=

-	local mobile =3D gMobiles[mobile_id]
-	if mobile and mobile.stats then
-		-- update values
-		mobile.stats.char_curMana =3D curval
-		mobile.stats.char_maxMana =3D maxval
-
-		if (mobile_id =3D=3D gPlayerBodySerial) then
-			gui.SetMana(curval/maxval)
-			-- update big_stats window
-			UpdateStatusAos()
-		end
-	end
-end
-
---# Update Current Stamina [0xA3]
--- TODO : not only player gets update packets here
-function gPacketHandler.kPacket_Fat_Health()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local mobile_id =3D input:PopNetUint32()
-	local maxval =3D input:PopNetUint16()
-	local curval =3D input:PopNetUint16()
-	printdebug(&quot;mobile&quot;,sprintf(&quot;NET: update STAMINA: mobile_serial=3D0x%08x =
 %i / %i\n&quot;,mobile_id,curval,maxval))
-
-	local mobile =3D gMobiles[mobile_id]
-	if mobile and mobile.stats then
-		-- update values
-		mobile.stats.char_curSta =3D curval
-		mobile.stats.char_maxSta =3D maxval
-
-		if (mobile_id =3D=3D gPlayerBodySerial) then
-			gui.SetStamina(curval/maxval)
-			-- update big_stats window
-			UpdateStatusAos()
-		end
-	end
-end
 =

 -- Fighting - Swing [0x2F] 10bytes
 -- TODO : handle animation
@@ -503,22 +132,6 @@
 	local attacker_serial =3D input:PopNetUint32()
 	local defender_serial =3D input:PopNetUint32()
 	printf(&quot;NET: Swing Attack Animation, attacker=3D0x%08x defender=3D0x%08x\=
n&quot;,attacker_serial,defender_serial)
-end
-
-function gPacketHandler.kPacket_Damage()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local mobile_serial =3D input:PopNetUint32()
-	local damage_amount =3D input:PopNetUint16()
-	=

-	printf(&quot;NET: (new) Damage: mobile-serial: 0x%08x Damage_Amount: %i\n&quot;,mob=
ile_serial,damage_amount)
-	if (mobile_serial =3D=3D gPlayerBodySerial) then
-		AddFadeLines(sprintf(&quot;%s&quot;,damage_amount)..&quot; Damage received&quot;)
-	else
-		AddFadeLines(sprintf(&quot;%s&quot;,damage_amount)..&quot; Damage done&quot;)
-	end
-
-	gCurrentRenderer:NotifyHPChange(mobile_serial,damage_amount,0)
 end
 =

 -- TODO : what is the result of this packet?


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000135.html">[Iris-commit] [IRIS] r1321 - in /trunk/data/lua: gui.container.lua gui/gui.container.lua gui/gui.main.lua lib.protocol.lua main.lua net/net.main.lua obj.mobile.lua obj/obj.main.lua obj/obj.mobile.lua
</A></li>
	<LI>Next message: <A HREF="000137.html">[Iris-commit] [IRIS] r1323 - in /trunk/data/lua: lib.protocol.lua	main.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#136">[ date ]</a>
              <a href="thread.html#136">[ thread ]</a>
              <a href="subject.html#136">[ subject ]</a>
              <a href="author.html#136">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
