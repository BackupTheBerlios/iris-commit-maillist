<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1366 - in /trunk/data/lua: ./ gui/ net/ obj/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1366%20-%20in%20/trunk/data/lua%3A%20./%20gui/%20net/%20obj/&In-Reply-To=%3C20070830191719.603221C1813E%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000180.html">
   <LINK REL="Next"  HREF="000182.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1366 - in /trunk/data/lua: ./ gui/ net/ obj/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1366%20-%20in%20/trunk/data/lua%3A%20./%20gui/%20net/%20obj/&In-Reply-To=%3C20070830191719.603221C1813E%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1366 - in /trunk/data/lua: ./ gui/ net/ obj/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Thu Aug 30 21:17:18 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000180.html">[Iris-commit] [IRIS] r1365 - in /trunk/data/lua: gui/gui.paperdoll.lua lib.3d.mobileanim.lua lib.3d.renderer.lua lib.input.lua lib.util.lua net.other.lua net.walk.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
</A></li>
        <LI>Next message: <A HREF="000182.html">[Iris-commit] [IRIS] r1367 - in /trunk/data/lua: lib.debugmenu.lua obj/obj.container.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.player.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#181">[ date ]</a>
              <a href="thread.html#181">[ thread ]</a>
              <a href="subject.html#181">[ subject ]</a>
              <a href="author.html#181">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Thu Aug 30 21:17:18 2007
New Revision: 1366

Log:
merging in progress...

Added:
    trunk/data/lua/obj/obj.container.lua
Modified:
    trunk/data/lua/gui/gui.container.lua
    trunk/data/lua/gui/gui.paperdoll.lua
    trunk/data/lua/lib.3d.map.lua
    trunk/data/lua/lib.3d.mobileanim.lua
    trunk/data/lua/lib.3d.mousepick.lua
    trunk/data/lua/lib.3d.renderer.lua
    trunk/data/lua/lib.cam.lua
    trunk/data/lua/lib.corpse.lua
    trunk/data/lua/lib.debugmenu.lua
    trunk/data/lua/lib.devtool.lua
    trunk/data/lua/lib.fallback.lua
    trunk/data/lua/lib.models.lua
    trunk/data/lua/lib.spellbooks.lua
    trunk/data/lua/lib.walking2.lua
    trunk/data/lua/net.securetrade.lua
    trunk/data/lua/net.trade.lua
    trunk/data/lua/net.walk.lua
    trunk/data/lua/net/net.dynamic.lua
    trunk/data/lua/net/net.mobile.lua
    trunk/data/lua/net/net.packethandlers.lua
    trunk/data/lua/obj/obj.dynamic.lua
    trunk/data/lua/obj/obj.main.lua
    trunk/data/lua/obj/obj.mobile.lua
    trunk/data/lua/obj/obj.player.lua

Modified: trunk/data/lua/gui/gui.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.container.lua (original)
+++ trunk/data/lua/gui/gui.container.lua Thu Aug 30 21:17:18 2007
@@ -1,134 +1,1 @@
--- packet handlers for containers (chests, drawers, inventory..)
--- see also lib.packet.lua and lib.protocol.lua
-
-gContainer =3D {}
-
--- pols sends kPacket_Open_Container first and then kPacket_Container_Cont=
ents , runuo the other way around
--- every container (data structure) can have zero-or-one associated dialog=
 (graphical representation)
--- dialog is only created when it is displayed, on kPacket_Open_Container
--- TODO : check if iContainerSerial is secure trade serial
--- TODO : check if spellbook
-
-
--- warning ! do not call while iterating over original container.items arr=
ay, item is removed from that array, might break iterator
-function DestroyContainerItemBySerial (serial)
-	for k,container in pairs(gContainer) do =

-		local item =3D container.items[serial]
-		if (item) then
-			if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
-			container.items[item.serial] =3D nil
-			SecureTradeRebuildContainerHook(container)
-		end
-	end
-end
-
-function IsContainerOpen (serial)
-	local container =3D gContainer[serial]
-	return (container and container.dialog)
-end
-
-function CloseContainer (serial) =

-	local container =3D gContainer[serial]
-	if (container and container.dialog) then
-		DestroyContainerItemWidgets(container)
-		container.dialog:Destroy()
-		container.dialog =3D nil
-	end
-	gContainer[serial] =3D nil
-end
-
--- creates if necessary
-function GetOrCreateContainer (serial) =

-	local container =3D gContainer[serial]
-	if (not container) then =

-		-- container didn't exist yet, create from scratch
-		container =3D {} =

-		container.serial =3D serial
-		container.items =3D {}
-		gContainer[container.serial] =3D container
-	end
-	return container
-end
-
--- destroys old widgets if neccessary
-function DestroyContainerItemWidgets (container) =

-	for k,item in pairs(container.items) do
-		if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
-	end
-end
-
--- destroys old widgets and creates new ones from contents
-function RefreshContainerItemWidgets (container) =

-	if (container.dialog) then
-		DestroyContainerItemWidgets(container)
-		for k,item in pairs(container.items) do MakeContainerItemWidget(item) end
-	end
-end
-
--- updates item data and graphical representation
-function RefreshContainerItem (item) =

-	DestroyContainerItemBySerial(item.serial) -- kill the any old items with =
same serial in case of move
-	local container =3D GetOrCreateContainer(item.iContainerSerial)
-	item.container =3D container
-	=

-	-- TODO : remove item if amount =3D 0 ? (or don't add)
-	container.items[item.serial] =3D item
-	=

-	-- refresh whole container, to keep zorder correct
-	RefreshContainerItemWidgets(container)
-	SecureTradeRebuildContainerHook(container)
-end
-
--- TODO use lib.gfm.lua : MakeArtGumpPart ?
--- create graphical representation (use only if container dialog is alread=
y visible)
-function MakeContainerItemWidget (item)
-	local parent =3D item.container.dialog.rootwidget
-	local iArtID =3D item.artid + hex2num(&quot;0x4000&quot;)
-	local x,y =3D item.xloc,item.yloc
-	local widget =3D nil
-
-	-- If it's not an ART-gfx to display -&gt; Display GUMP-gfx
-	if (item.usegump=3D=3Dtrue) then
-		widget =3D MakeBorderGumpPart (parent,item.artid,x,y)
-
-		widget.mbIgnoreMouseOver =3D false
-		widget.uoContainer =3D item.container
-		widget.item =3D item
-		item.widget =3D widget
-
-		widget.onMouseLeave =3D function () gCurrentRenderer.gMousePickTippOverr=
ide =3D false end
-		widget.onMouseDown	=3D function (widget,mousebutton) end
-	else
-		local mat =3D GetArtMat(iArtID,item.hue)
-		if ((not mat) or mat =3D=3D &quot;&quot;) then
-			print(&quot;WARNING ! MakeContainerItemWidget : material load failed for art=
id=3D&quot;, iArtID)
-		else
-			local bitmask =3D GetArtBitMask(iArtID)
-			local w,h =3D GetArtSize(iArtID)
-			widget =3D guimaker.MakePlane(parent,mat,x,y,w,h)
-			local tw,th =3D texsize(w),texsize(h)
-			widget.gfx:SetUV(0,(0)/th,w/tw,(h+0)/th)
-			widget:SetBitMask(bitmask)
-			widget.mbIgnoreMouseOver =3D false
-			widget.uoContainer =3D item.container
-			widget.item =3D item
-			item.widget =3D widget
-		=

-			-- item debuginfo on mouseover (clientside,debuginfos)
-			widget.onMouseLeave =3D function () =

-				gCurrentRenderer.gMousePickTippOverride =3D false =

-				Client_SetBottomLine(&quot;&quot;)
-			end
-			widget.onMouseDown	=3D function (widget,mousebutton) end
-			widget.onMouseEnter =3D function ()
-				-- TODO : find a cleaner solution to override the mousepick tipp
-				local item =3D widget.item
-				local name =3D GetStaticTileTypeName(item.artid) or &quot;&quot;
-				info =3D sprintf(&quot;item %s amount=3D%d (artid=3D%04x=3D%d)&quot;,name,item.a=
mount,item.artid,item.artid)
-				--print(&quot;MakeContainerItemWidget onMouseEnter &quot;,name,vardump(item))
-				gCurrentRenderer.gMousePickTippOverride =3D info
-				Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
-			end
-		end
-	end
-end
+-- moved to obj/obj.container.lua

Modified: trunk/data/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.paperdoll.lua (original)
+++ trunk/data/lua/gui/gui.paperdoll.lua Thu Aug 30 21:17:18 2007
@@ -38,6 +38,26 @@
 =

 gPaperdolls =3D {}
 =

+
+-- called from kPacket_Open_Paperdoll
+function HandleOpenPaperdoll	(paperdoll)
+	paperdoll.mobileserial	=3D paperdoll.serial
+	paperdoll.Close =3D ClosePaperdoll
+	=

+	-- close old paperdoll
+	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
+	if (oldpaperdoll) then oldpaperdoll:Close() end =

+	=

+	-- register paperdoll
+	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
+	=

+	--AddFadeLines(&quot;Open Paperdoll for [&quot;..(paperdoll.mobileserial)..&quot;] &quot;..(p=
aperdoll.name or &quot;&quot;))
+	=

+	RebuildPaperdoll(paperdoll)
+end
+
+
+
 -- rebuild needed on update to have correct layerorder
 -- paperdoll.bIsPlayer (check if is player or npc)
 function RebuildPaperdoll (paperdoll)
@@ -164,7 +184,7 @@
 	DestroyPaperdollItemWidgets(paperdoll)
 	=

 	-- create bodywidget and item widgets
-	if (mobile and mobile.equipment) then
+	if (mobile) then
 		local bodyid =3D mobile.artid
 		local bodygumpid,base_id =3D GetPaperdollBodyAndBaseID(bodyid)
 		=

@@ -185,7 +205,7 @@
 		-- create item widgets
 		for index,layer in pairs(gLayerOrder) do =

 			local k =3D gLayerTypeName[layer]
-			local item =3D mobile.equipment[layer]
+			local item =3D GetMobileEquipmentItem(mobile,layer)
 			if (item) then CreatePaperdollItemWidget(paperdoll,item,base_id) end
 		end
 	end
@@ -250,8 +270,8 @@
 =

 -- destroys old widgets if neccessary
 function DestroyPaperdollItemWidgets (paperdoll) =

-	if (paperdoll.mobile and paperdoll.mobile.equipment) then
-		for k,item in pairs(paperdoll.mobile.equipment) do
+	if (paperdoll.mobile) then
+		for k,item in pairs(GetMobileEquipmentList(paperdoll.mobile)) do
 			if (item.widget) then item.widget:Destroy()  item.widget =3D nil end
 		end
 	end

Modified: trunk/data/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.map.lua (original)
+++ trunk/data/lua/lib.3d.map.lua Thu Aug 30 21:17:18 2007
@@ -303,7 +303,7 @@
 		=

 		-- check dynamics for multis to detect house roofs and stuff like this
 		for k,dynamic in pairs(GetDynamicList()) do
-			if (dynamic.lMultiChildGfx) then
+			if (DynamicIsInWorld(dynamic) and dynamic.lMultiChildGfx) then
 				for k,child in pairs(dynamic.lMultiChildGfx) do
 					if (x =3D=3D dynamic.xloc+child.xloc and y =3D=3D dynamic.yloc+child.=
yloc and dynamic.zloc+child.zloc &gt; playerheadpos) then
 						playerIsInside =3D true
@@ -349,7 +349,7 @@
 		end
 		=

 		-- update dynamics
-		for k,dynamic in pairs(GetDynamicList()) do self:UpdateDynamicVisibility=
(dynamic) end
+		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
)) then self:UpdateDynamicVisibility(dynamic) end end
 		-- update mobiles
 		for k,mobile in pairs(GetMobileList()) do self:UpdateMobileVisibility(mo=
bile) end
 	end

Modified: trunk/data/lua/lib.3d.mobileanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.mobileanim.lua (original)
+++ trunk/data/lua/lib.3d.mobileanim.lua Thu Aug 30 21:17:18 2007
@@ -55,7 +55,6 @@
 =

 -- calling this interrupts any playing serverside anim
 function Renderer3D:MobileStartClientSideAnim (mobile)
-	if (not mobile.equipment) then return end
 	mobile.animinit =3D true
 	local bodyid =3D MobileArtId2BodyId(mobile.artid)
 	=


Modified: trunk/data/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.mousepick.lua (original)
+++ trunk/data/lua/lib.3d.mousepick.lua Thu Aug 30 21:17:18 2007
@@ -172,7 +172,7 @@
 	-- dynamics
 	for k,dynamic in pairs(GetDynamicList()) do
 		-- does this dynamic consists of many gfx parts (multi)?
-		if dynamic.lMultiChildGfx then
+		if dynamic.lMultiChildGfx and DynamicIsInWorld(dynamic) then
 			-- handle multi collision
 			for k,gfx in pairs(dynamic.lMultiChildGfx) do =

 				if (self:IsZLayerVisible(gfx.zloc)) then
@@ -186,7 +186,7 @@
 						end
 				end
 			end
-		elseif (dynamic.gfx) then
+		elseif (dynamic.gfx and DynamicIsInWorld(dynamic)) then
 			-- WARNING copy &amp; paste code
 			if (self:IsZLayerVisible(dynamic.zloc)) then
 				if (dynamic.gfx.billboard) then

Modified: trunk/data/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.renderer.lua (original)
+++ trunk/data/lua/lib.3d.renderer.lua Thu Aug 30 21:17:18 2007
@@ -88,13 +88,13 @@
 	self:SetMapEnvironment()
 	=

 	self.gbCamRotChanged =3D true
-	for k,dynamic in pairs(GetDynamicList()) do self:CreateDynamicGfx(dynamic=
) end
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:CreateDynamicGfx(dynamic) end end
 	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
 end
 =

 function Renderer3D:DeInit()
 	--print(&quot;deactivating Renderer3D&quot;)
-	for k,dynamic in pairs(GetDynamicList()) do self:DestroyDynamicGfx(dynami=
c) end
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:DestroyDynamicGfx(dynamic) end end
 	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
 	self:DeactivateMousePick()
 	self:ClearMapCache()

Modified: trunk/data/lua/lib.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.cam.lua (original)
+++ trunk/data/lua/lib.cam.lua Thu Aug 30 21:17:18 2007
@@ -15,7 +15,7 @@
 	return cam:GetNearClipDistance(),cam:GetFarClipDistance() =

 end
 =

---- initialise ortho mode, useful for 2d rendering
+--- initialize ortho mode, useful for 2d rendering
 function Client_SetPixelCoordSystem	()
 	local cam =3D GetMainCam() =

 	cam:SetFOVy( gfDeg2Rad*90 )

Modified: trunk/data/lua/lib.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.corpse.lua (original)
+++ trunk/data/lua/lib.corpse.lua Thu Aug 30 21:17:18 2007
@@ -1,4 +1,5 @@
 -- handles special cases for corpses
+-- see also net.corpse.lua
 =

 =

 =

@@ -50,4 +51,4 @@
 	end
 	RefreshContainerItemWidgets(container)
 end
-]]--
+]]--

Modified: trunk/data/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.debugmenu.lua (original)
+++ trunk/data/lua/lib.debugmenu.lua Thu Aug 30 21:17:18 2007
@@ -16,121 +16,120 @@
 gDebugMenuModelIndex =3D 1
 gDebugMenuMainGfxPos =3D {-0.5,0.5,-0.15}
 =

+-- TODO : might have to be adjusted for knut merge
 function RepairEquipIndex (arr) =

-	local res =3D {}
-	for k,v in pairs(arr) do =

+	for k,item in pairs(arr) do =

 		local layer =3D GetPaperdollLayerFromTileType(v.artid)
 		if (not layer) then print(&quot;could't get layer for artid &quot;,v.artid) end
-		res[layer or (1000 + k)] =3D v =

-	end
-	return res
+		item.layer =3D layer or (1000 + k)
+	end
 end
 =

 gDebugTestMobiles =3D {
-	{artid=3D 292 , equipment=3D{}}, --broken llamas_llama_pack (crash) -&gt; ma=
pped to id: 220
-
-	{artid=3D hex2num(&quot;0xA9&quot;) , equipment=3D{}}, --169 broken horse
-	{artid=3D hex2num(&quot;0x317&quot;), equipment=3D{}}, --791 broken horse
-	{artid=3D	hex2num(&quot;0x76&quot;) , equipment=3D{}}, --horse ok
-	{artid=3D	hex2num(&quot;0x78&quot;) , equipment=3D{}}, --horse ok
-
-	{artid=3D hex2num(&quot;0x123&quot;) , equipment=3D{}}, =

-	{artid=3D hex2num(&quot;0xD5&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xF1&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xF3&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xCC&quot;) , equipment=3D{}}, -- 204, broken
-	{artid=3D	hex2num(&quot;0xC8&quot;) , equipment=3D{}}, -- 200 : standard horse
-	{artid=3D	hex2num(&quot;0xE2&quot;) , equipment=3D{}}, -- 226 broken
-	{artid=3D	hex2num(&quot;0xE4&quot;) , equipment=3D{}}, -- 228 broken
-	{artid=3D	hex2num(&quot;0xDC&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xD2&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xDA&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xDB&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x3C&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xD5&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xB1&quot;) , equipment=3D{}}, -- 177 broken
-	{artid=3D	hex2num(&quot;0x75&quot;) , equipment=3D{}}, -- 117 broken =

-	{artid=3D	hex2num(&quot;0x72&quot;) , equipment=3D{}}, -- 114 broken =

-	{artid=3D	hex2num(&quot;0x73&quot;) , equipment=3D{}},  -- 115 broken
-	{artid=3D	hex2num(&quot;0xC8&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x79&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x77&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x90&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x74&quot;) , equipment=3D{}},  -- 116 broken
-	{artid=3D	hex2num(&quot;0xB2&quot;) , equipment=3D{}},  -- 178 broken
-	{artid=3D	hex2num(&quot;0x84&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xB3&quot;) , equipment=3D{}},  -- 179 broken
-	{artid=3D	hex2num(&quot;0xBB&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0xBC&quot;) , equipment=3D{}}, =

-	{artid=3D	hex2num(&quot;0x319&quot;) , equipment=3D{}},
-	{artid=3D	hex2num(&quot;0x317&quot;) , equipment=3D{}}, -- brokenanim
-	{artid=3D	hex2num(&quot;0x31A&quot;) , equipment=3D{}}, -- brokenanim
-	{artid=3D	hex2num(&quot;0x31F&quot;) , equipment=3D{}}, -- brokenanim
-	{artid=3D	hex2num(&quot;0xBE&quot;) , equipment=3D{}},  -- 190 broken
-	{artid=3D hex2num(&quot;0x11C&quot;) , equipment=3D{}}, -- 284 anim broken, scale b=
roken..
-	{artid=3D	hex2num(&quot;0xFB&quot;) , equipment=3D{}}, =

-
-	{artid=3D400,hue=3D33780, equipment=3D{[4]=3D{artid=3D5422,hue=3D1728,ani=
mid=3D430},[26]=3D{artid=3D3701,hue=3D0,animid=3D422},[16]=3D{artid=3D8269,=
hue=3D1147,animid=3D906},[27]=3D{artid=3D3701,hue=3D0,animid=3D422},[17]=3D=
{artid=3D8059,hue=3D1652,animid=3D913},[11]=3D{artid=3D8252,hue=3D1147,anim=
id=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=3D466},[21]=3D{artid=3D3701,h=
ue=3D0,animid=3D422},}},
-	{artid=3D400,hue=3D33780, equipment=3D{[26]=3D{artid=3D3701,hue=3D0,animi=
d=3D422},[16]=3D{artid=3D8269,hue=3D1147,animid=3D906},[27]=3D{artid=3D3701=
,hue=3D0,animid=3D422},[17]=3D{artid=3D8059,hue=3D1652,animid=3D913},[11]=
=3D{artid=3D8252,hue=3D1147,animid=3D701},[12]=3D{artid=3D5435,hue=3D0,anim=
id=3D466},[21]=3D{artid=3D3701,hue=3D0,animid=3D422},}},
-	{artid=3D400,hue=3D33780, equipment=3D{[27]=3D{artid=3D3701,hue=3D0,animi=
d=3D422},[17]=3D{artid=3D8059,hue=3D1652,animid=3D913},[11]=3D{artid=3D8252=
,hue=3D1147,animid=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=3D466},[21]=
=3D{artid=3D3701,hue=3D0,animid=3D422},}},
-	{artid=3D400,hue=3D33780, equipment=3D{[11]=3D{artid=3D8252,hue=3D1147,an=
imid=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=3D466},[21]=3D{artid=3D3701=
,hue=3D0,animid=3D422},}},
-
-
-	--{artid=3D2011, equipment=3D{{animid=3D2002}}}, -- 02:feet 11:ulegs
-	{artid=3D400, equipment=3D{}},
-	{artid=3D400, equipment=3D{[1]=3D{artid=3D3932,animid=3D631},[2]=3D{artid=
=3D7107,animid=3D993},[4]=3D{artid=3D5137,animid=3D529},[6]=3D{artid=3D9797=
,animid=3D682},[7]=3D{artid=3D5140,animid=3D530},[19]=3D{artid=3D5136,animi=
d=3D528},[16]=3D{artid=3D8256,animid=3D800},[21]=3D{artid=3D3701,animid=3D4=
22},[13]=3D{artid=3D5141,animid=3D527},[29]=3D{artid=3D3708,animid=3D0},[11=
]=3D{artid=3D8266,animid=3D903},}},
-	{artid=3D401, equipment=3D{}},
-	{artid=3D401, equipment=3D{[1]=3D{artid=3D3932,animid=3D631},[2]=3D{artid=
=3D7107,animid=3D993},[4]=3D{artid=3D5137,animid=3D529},[6]=3D{artid=3D9797=
,animid=3D682},[7]=3D{artid=3D5140,animid=3D530},[19]=3D{artid=3D5136,animi=
d=3D528},[16]=3D{artid=3D8256,animid=3D800},[21]=3D{artid=3D3701,animid=3D4=
22},[13]=3D{artid=3D5141,animid=3D527},[29]=3D{artid=3D3708,animid=3D0},[11=
]=3D{artid=3D8266,animid=3D903},}},
-	{artid=3D040, equipment=3D{}},
-	{artid=3D014, equipment=3D{}},
-	{artid=3D199, equipment=3D{}},
-	{artid=3D256, equipment=3D{}},
-	{artid=3D778, equipment=3D{}},
-	{artid=3D225, equipment=3D{}}, -- timberwolf
-	{artid=3D401, equipment=3D{[1]=3D{artid=3D3932,animid=3D631},[2]=3D{artid=
=3D7107,animid=3D993},[4]=3D{artid=3D5137,animid=3D529},[6]=3D{artid=3D9797=
,animid=3D682},[7]=3D{artid=3D5140,animid=3D530},[19]=3D{artid=3D5136,animi=
d=3D528},[16]=3D{artid=3D8256,animid=3D800},[21]=3D{artid=3D3701,animid=3D4=
22},[13]=3D{artid=3D5141,animid=3D527},[29]=3D{artid=3D3708,animid=3D0},[11=
]=3D{artid=3D8266,animid=3D903},}},
-	{artid=3D401, equipment=3D{[1]=3D{artid=3D3932,animid=3D631},[4]=3D{artid=
=3D5137,animid=3D529},[6]=3D{artid=3D9797,animid=3D682},[7]=3D{artid=3D5140=
,animid=3D530},[19]=3D{artid=3D5136,animid=3D528},[16]=3D{artid=3D8256,anim=
id=3D800},[21]=3D{artid=3D3701,animid=3D422},[13]=3D{artid=3D5141,animid=3D=
527},[29]=3D{artid=3D3708,animid=3D0},[11]=3D{artid=3D8266,animid=3D903},}},
-	{artid=3D401, equipment=3D({{artid=3D3932,animid=3D631},{artid=3D7107,ani=
mid=3D993},{artid=3D5137,animid=3D529},{artid=3D9797,animid=3D682},{artid=
=3D5140,animid=3D530},{artid=3D5136,animid=3D528},{artid=3D8256,animid=3D80=
0},{artid=3D3701,animid=3D422},{artid=3D5141,animid=3D527},{artid=3D3708,an=
imid=3D0},{artid=3D8266,animid=3D903},})},
-	=

-	{artid=3D400, equipment=3D({{artid=3D3519,animid=3D972},})},
-	{artid=3D400, equipment=3D({{artid=3D3519,animid=3D972},{artid=3D5901,ani=
mid=3D479},{artid=3D5422,animid=3D430},{artid=3D5399,animid=3D434},{artid=
=3D5907,animid=3D404},{artid=3D3701,animid=3D422},{artid=3D8252,animid=3D70=
1},})},
-	{artid=3D987, equipment=3D({{artid=3D5182,animid=3D624},{artid=3D5903,ani=
mid=3D480},{artid=3D5399,animid=3D434},{artid=3D5130,animid=3D565},{artid=
=3D5397,animid=3D468},{artid=3D3701,animid=3D422},{artid=3D7939,animid=3D46=
9},})},
-	{artid=3D401, equipment=3D({{artid=3D2594,animid=3D500},{artid=3D5899,ani=
mid=3D477},{artid=3D7933,animid=3D435},{artid=3D5431,animid=3D455},{artid=
=3D5397,animid=3D468},{artid=3D5441,animid=3D490},{artid=3D8261,animid=3D71=
0},{artid=3D3701,animid=3D422},})},
-	{artid=3D401, equipment=3D({{artid=3D2594,animid=3D500},{artid=3D5905,ani=
mid=3D476},{artid=3D5399,animid=3D434},{artid=3D5431,animid=3D455},{artid=
=3D5441,animid=3D490},{artid=3D3701,animid=3D422},{artid=3D8262,animid=3D71=
2},})},
-	{artid=3D401, equipment=3D({{artid=3D5899,animid=3D477},{artid=3D5422,ani=
mid=3D430},{artid=3D5399,animid=3D434},{artid=3D5435,animid=3D466},{artid=
=3D8251,animid=3D700},{artid=3D3701,animid=3D422},})},
-	{artid=3D400, equipment=3D({{artid=3D5905,animid=3D476},{artid=3D5422,ani=
mid=3D430},{artid=3D7933,animid=3D435},{artid=3D5909,animid=3D406},{artid=
=3D5441,animid=3D490},{artid=3D3701,animid=3D422},{artid=3D8251,animid=3D70=
0},})},
-	{artid=3D400, equipment=3D({{artid=3D5899,animid=3D477},{artid=3D5422,ani=
mid=3D430},{artid=3D7933,animid=3D435},{artid=3D8266,animid=3D903},{artid=
=3D3701,animid=3D422},})},
-	{artid=3D256, equipment=3D{}},
-	{artid=3D252, equipment=3D{}},
-	{artid=3D204, equipment=3D{}}, -- should be horse
-	--{artid=3D3006, equipment=3D{}}, -- female lower legs, sience was having=
 problem with them, 2 submeshes !
+	{artid=3D 292 , content=3D{}}, --broken llamas_llama_pack (crash) -&gt; mapp=
ed to id: 220
+
+	{artid=3D hex2num(&quot;0xA9&quot;) , content=3D{}}, --169 broken horse
+	{artid=3D hex2num(&quot;0x317&quot;), content=3D{}}, --791 broken horse
+	{artid=3D	hex2num(&quot;0x76&quot;) , content=3D{}}, --horse ok
+	{artid=3D	hex2num(&quot;0x78&quot;) , content=3D{}}, --horse ok
+
+	{artid=3D hex2num(&quot;0x123&quot;) , content=3D{}}, =

+	{artid=3D hex2num(&quot;0xD5&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xF1&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xF3&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xCC&quot;) , content=3D{}}, -- 204, broken
+	{artid=3D	hex2num(&quot;0xC8&quot;) , content=3D{}}, -- 200 : standard horse
+	{artid=3D	hex2num(&quot;0xE2&quot;) , content=3D{}}, -- 226 broken
+	{artid=3D	hex2num(&quot;0xE4&quot;) , content=3D{}}, -- 228 broken
+	{artid=3D	hex2num(&quot;0xDC&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xD2&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xDA&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xDB&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0x3C&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xD5&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xB1&quot;) , content=3D{}}, -- 177 broken
+	{artid=3D	hex2num(&quot;0x75&quot;) , content=3D{}}, -- 117 broken =

+	{artid=3D	hex2num(&quot;0x72&quot;) , content=3D{}}, -- 114 broken =

+	{artid=3D	hex2num(&quot;0x73&quot;) , content=3D{}},  -- 115 broken
+	{artid=3D	hex2num(&quot;0xC8&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0x79&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0x77&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0x90&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0x74&quot;) , content=3D{}},  -- 116 broken
+	{artid=3D	hex2num(&quot;0xB2&quot;) , content=3D{}},  -- 178 broken
+	{artid=3D	hex2num(&quot;0x84&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xB3&quot;) , content=3D{}},  -- 179 broken
+	{artid=3D	hex2num(&quot;0xBB&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0xBC&quot;) , content=3D{}}, =

+	{artid=3D	hex2num(&quot;0x319&quot;) , content=3D{}},
+	{artid=3D	hex2num(&quot;0x317&quot;) , content=3D{}}, -- brokenanim
+	{artid=3D	hex2num(&quot;0x31A&quot;) , content=3D{}}, -- brokenanim
+	{artid=3D	hex2num(&quot;0x31F&quot;) , content=3D{}}, -- brokenanim
+	{artid=3D	hex2num(&quot;0xBE&quot;) , content=3D{}},  -- 190 broken
+	{artid=3D hex2num(&quot;0x11C&quot;) , content=3D{}}, -- 284 anim broken, scale bro=
ken..
+	{artid=3D	hex2num(&quot;0xFB&quot;) , content=3D{}}, =

+
+	{artid=3D400,hue=3D33780, content=3D{[4]=3D{artid=3D5422,hue=3D1728,animi=
d=3D430},[26]=3D{artid=3D3701,hue=3D0,animid=3D422},[16]=3D{artid=3D8269,hu=
e=3D1147,animid=3D906},[27]=3D{artid=3D3701,hue=3D0,animid=3D422},[17]=3D{a=
rtid=3D8059,hue=3D1652,animid=3D913},[11]=3D{artid=3D8252,hue=3D1147,animid=
=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=3D466},[21]=3D{artid=3D3701,hue=
=3D0,animid=3D422},}},
+	{artid=3D400,hue=3D33780, content=3D{[26]=3D{artid=3D3701,hue=3D0,animid=
=3D422},[16]=3D{artid=3D8269,hue=3D1147,animid=3D906},[27]=3D{artid=3D3701,=
hue=3D0,animid=3D422},[17]=3D{artid=3D8059,hue=3D1652,animid=3D913},[11]=3D=
{artid=3D8252,hue=3D1147,animid=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=
=3D466},[21]=3D{artid=3D3701,hue=3D0,animid=3D422},}},
+	{artid=3D400,hue=3D33780, content=3D{[27]=3D{artid=3D3701,hue=3D0,animid=
=3D422},[17]=3D{artid=3D8059,hue=3D1652,animid=3D913},[11]=3D{artid=3D8252,=
hue=3D1147,animid=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=3D466},[21]=3D=
{artid=3D3701,hue=3D0,animid=3D422},}},
+	{artid=3D400,hue=3D33780, content=3D{[11]=3D{artid=3D8252,hue=3D1147,anim=
id=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=3D466},[21]=3D{artid=3D3701,h=
ue=3D0,animid=3D422},}},
+
+
+	--{artid=3D2011, content=3D{{animid=3D2002}}}, -- 02:feet 11:ulegs
+	{artid=3D400, content=3D{}},
+	{artid=3D400, content=3D{[1]=3D{artid=3D3932,animid=3D631},[2]=3D{artid=
=3D7107,animid=3D993},[4]=3D{artid=3D5137,animid=3D529},[6]=3D{artid=3D9797=
,animid=3D682},[7]=3D{artid=3D5140,animid=3D530},[19]=3D{artid=3D5136,animi=
d=3D528},[16]=3D{artid=3D8256,animid=3D800},[21]=3D{artid=3D3701,animid=3D4=
22},[13]=3D{artid=3D5141,animid=3D527},[29]=3D{artid=3D3708,animid=3D0},[11=
]=3D{artid=3D8266,animid=3D903},}},
+	{artid=3D401, content=3D{}},
+	{artid=3D401, content=3D{[1]=3D{artid=3D3932,animid=3D631},[2]=3D{artid=
=3D7107,animid=3D993},[4]=3D{artid=3D5137,animid=3D529},[6]=3D{artid=3D9797=
,animid=3D682},[7]=3D{artid=3D5140,animid=3D530},[19]=3D{artid=3D5136,animi=
d=3D528},[16]=3D{artid=3D8256,animid=3D800},[21]=3D{artid=3D3701,animid=3D4=
22},[13]=3D{artid=3D5141,animid=3D527},[29]=3D{artid=3D3708,animid=3D0},[11=
]=3D{artid=3D8266,animid=3D903},}},
+	{artid=3D040, content=3D{}},
+	{artid=3D014, content=3D{}},
+	{artid=3D199, content=3D{}},
+	{artid=3D256, content=3D{}},
+	{artid=3D778, content=3D{}},
+	{artid=3D225, content=3D{}}, -- timberwolf
+	{artid=3D401, content=3D{[1]=3D{artid=3D3932,animid=3D631},[2]=3D{artid=
=3D7107,animid=3D993},[4]=3D{artid=3D5137,animid=3D529},[6]=3D{artid=3D9797=
,animid=3D682},[7]=3D{artid=3D5140,animid=3D530},[19]=3D{artid=3D5136,animi=
d=3D528},[16]=3D{artid=3D8256,animid=3D800},[21]=3D{artid=3D3701,animid=3D4=
22},[13]=3D{artid=3D5141,animid=3D527},[29]=3D{artid=3D3708,animid=3D0},[11=
]=3D{artid=3D8266,animid=3D903},}},
+	{artid=3D401, content=3D{[1]=3D{artid=3D3932,animid=3D631},[4]=3D{artid=
=3D5137,animid=3D529},[6]=3D{artid=3D9797,animid=3D682},[7]=3D{artid=3D5140=
,animid=3D530},[19]=3D{artid=3D5136,animid=3D528},[16]=3D{artid=3D8256,anim=
id=3D800},[21]=3D{artid=3D3701,animid=3D422},[13]=3D{artid=3D5141,animid=3D=
527},[29]=3D{artid=3D3708,animid=3D0},[11]=3D{artid=3D8266,animid=3D903},}},
+	{artid=3D401, content=3D({{artid=3D3932,animid=3D631},{artid=3D7107,animi=
d=3D993},{artid=3D5137,animid=3D529},{artid=3D9797,animid=3D682},{artid=3D5=
140,animid=3D530},{artid=3D5136,animid=3D528},{artid=3D8256,animid=3D800},{=
artid=3D3701,animid=3D422},{artid=3D5141,animid=3D527},{artid=3D3708,animid=
=3D0},{artid=3D8266,animid=3D903},})},
+	=

+	{artid=3D400, content=3D({{artid=3D3519,animid=3D972},})},
+	{artid=3D400, content=3D({{artid=3D3519,animid=3D972},{artid=3D5901,animi=
d=3D479},{artid=3D5422,animid=3D430},{artid=3D5399,animid=3D434},{artid=3D5=
907,animid=3D404},{artid=3D3701,animid=3D422},{artid=3D8252,animid=3D701},}=
)},
+	{artid=3D987, content=3D({{artid=3D5182,animid=3D624},{artid=3D5903,animi=
d=3D480},{artid=3D5399,animid=3D434},{artid=3D5130,animid=3D565},{artid=3D5=
397,animid=3D468},{artid=3D3701,animid=3D422},{artid=3D7939,animid=3D469},}=
)},
+	{artid=3D401, content=3D({{artid=3D2594,animid=3D500},{artid=3D5899,animi=
d=3D477},{artid=3D7933,animid=3D435},{artid=3D5431,animid=3D455},{artid=3D5=
397,animid=3D468},{artid=3D5441,animid=3D490},{artid=3D8261,animid=3D710},{=
artid=3D3701,animid=3D422},})},
+	{artid=3D401, content=3D({{artid=3D2594,animid=3D500},{artid=3D5905,animi=
d=3D476},{artid=3D5399,animid=3D434},{artid=3D5431,animid=3D455},{artid=3D5=
441,animid=3D490},{artid=3D3701,animid=3D422},{artid=3D8262,animid=3D712},}=
)},
+	{artid=3D401, content=3D({{artid=3D5899,animid=3D477},{artid=3D5422,animi=
d=3D430},{artid=3D5399,animid=3D434},{artid=3D5435,animid=3D466},{artid=3D8=
251,animid=3D700},{artid=3D3701,animid=3D422},})},
+	{artid=3D400, content=3D({{artid=3D5905,animid=3D476},{artid=3D5422,animi=
d=3D430},{artid=3D7933,animid=3D435},{artid=3D5909,animid=3D406},{artid=3D5=
441,animid=3D490},{artid=3D3701,animid=3D422},{artid=3D8251,animid=3D700},}=
)},
+	{artid=3D400, content=3D({{artid=3D5899,animid=3D477},{artid=3D5422,animi=
d=3D430},{artid=3D7933,animid=3D435},{artid=3D8266,animid=3D903},{artid=3D3=
701,animid=3D422},})},
+	{artid=3D256, content=3D{}},
+	{artid=3D252, content=3D{}},
+	{artid=3D204, content=3D{}}, -- should be horse
+	--{artid=3D3006, content=3D{}}, -- female lower legs, sience was having p=
roblem with them, 2 submeshes !
 	--[[
-	{artid=3D1924, equipment=3D{{animid=3D3012}}},
-	{artid=3D3604, equipment=3D{{animid=3D3012}}},
-	{artid=3D1925, equipment=3D{{animid=3D3012}}},
-	{artid=3D3605, equipment=3D{{animid=3D3012}}},
+	{artid=3D1924, content=3D{{animid=3D3012}}},
+	{artid=3D3604, content=3D{{animid=3D3012}}},
+	{artid=3D1925, content=3D{{animid=3D3012}}},
+	{artid=3D3605, content=3D{{animid=3D3012}}},
 	]]--
 	--[[
-	{artid=3D2013, equipment=3D{}},
-	{artid=3D2009, equipment=3D{}},
-	{artid=3D2012, equipment=3D{}},
-	{artid=3D3013, equipment=3D{}},
-	{artid=3D3009, equipment=3D{}},
-	{artid=3D3012, equipment=3D{}},
-	{artid=3D3009, equipment=3D{}},
-	{artid=3D3012, equipment=3D{}},
-	{artid=3D3009, equipment=3D{}},
-	{artid=3D3012, equipment=3D{}},
-	{artid=3D3009, equipment=3D{}},
-	{artid=3D3012, equipment=3D{}},
+	{artid=3D2013, content=3D{}},
+	{artid=3D2009, content=3D{}},
+	{artid=3D2012, content=3D{}},
+	{artid=3D3013, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
 	]]--
 	--[[
-	{artid=3D1466, equipment=3D{}}, -- flimmer, need culling? (fixed)
-	{artid=3D1700, equipment=3D{}}, -- hair, texcoords or normals broken ? (f=
ixed)
-	{artid=3D500, equipment=3D{}}, -- lantern, texcoords broken ?! (fixed)
-	{artid=3D468, equipment=3D{}}, -- cape, texcoords broken ? culling? (fixe=
d)
-	{artid=3D1468, equipment=3D{}}, -- cape, texcoords broken ? culling? (fix=
ed)
-	{artid=3D490, equipment=3D{}}, -- sash, texcoords broken ? culling? (fixe=
d)
-	{artid=3D1490, equipment=3D{}},  -- sash, texcoords broken ? culling? (fi=
xed)
+	{artid=3D1466, content=3D{}}, -- flimmer, need culling? (fixed)
+	{artid=3D1700, content=3D{}}, -- hair, texcoords or normals broken ? (fix=
ed)
+	{artid=3D500, content=3D{}}, -- lantern, texcoords broken ?! (fixed)
+	{artid=3D468, content=3D{}}, -- cape, texcoords broken ? culling? (fixed)
+	{artid=3D1468, content=3D{}}, -- cape, texcoords broken ? culling? (fixed)
+	{artid=3D490, content=3D{}}, -- sash, texcoords broken ? culling? (fixed)
+	{artid=3D1490, content=3D{}},  -- sash, texcoords broken ? culling? (fixe=
d)
 	]]--
 }
 =

@@ -160,7 +159,7 @@
 	if (gCurDebugMode =3D=3D kDebugMode_Granny) then
 		local mobile =3D gDebugTestMobiles[index]
 		if (not mobile) then return end
-		mobile.equipment =3D RepairEquipIndex(mobile.equipment)
+		RepairEquipIndex(mobile.content)
 		AddFadeLines(sprintf(&quot;DebugMenuShowModel model=3D%04x(=3D%d) anim=3D%d[%=
s]&quot;,mobile.artid,mobile.artid,gDebugMenuAnimIndex,GetAnimName(mobile.artid,=
gDebugMenuAnimIndex) or &quot;&quot;))
 		=

 		local animid =3D gDebugMenuAnimIndex

Modified: trunk/data/lua/lib.devtool.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.devtool.lua (original)
+++ trunk/data/lua/lib.devtool.lua Thu Aug 30 21:17:18 2007
@@ -262,7 +262,7 @@
 	local res =3D {}
 	for k,item in pairs(GetDynamicList()) do =

 		local d =3D dist2(x,y,item.xloc,item.yloc)
-		if (d &lt;=3D radius) then table.insert(res,item) end =

+		if (DynamicIsInWorld(item) and d &lt;=3D radius) then table.insert(res,item=
) end =

 	end
 	return res
 end

Modified: trunk/data/lua/lib.fallback.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.fallback.lua (original)
+++ trunk/data/lua/lib.fallback.lua Thu Aug 30 21:17:18 2007
@@ -136,7 +136,7 @@
 	local res =3D {}
 	for k,item in pairs(GetDynamicList()) do =

 		local d =3D dist2(x,y,item.xloc,item.yloc)
-		if (d &lt;=3D radius) then table.insert(res,item) end =

+		if (DynamicIsInWorld(item) and d &lt;=3D radius) then table.insert(res,item=
) end =

 	end
 	return res
 end

Modified: trunk/data/lua/lib.models.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.models.lua (original)
+++ trunk/data/lua/lib.models.lua Thu Aug 30 21:17:18 2007
@@ -488,7 +488,6 @@
 =

 	-- TODO: Debug and check why RunUO sends kPacket_Equipped_MOB with artid =
=3D=3D Zero
 	if (mobile.artid =3D=3D 0) then return end
-	if (not mobile.equipment) then return end -- happens when being teleported
 	=

 	local mount =3D GetMobileEquipmentItem(mobile,kLayer_Mount)
 	local modelidarr,iPrimaryHandItem,iSecondaryHandItem =3D GetMobileModelPa=
rtModelIDs(mobile)
@@ -579,11 +578,11 @@
 		end
 		=

 		if (false) then
-			local txt =3D sprintf(&quot;##### {artid=3D%d,hue=3D%d, equipment=3D{&quot;,mobil=
e.artid,mobile.hue)
-			if (mobile.equipment) then for k,item in pairs(mobile.equipment) do
+			local txt =3D sprintf(&quot;##### {artid=3D%d,hue=3D%d, content=3D{&quot;,mobile.=
artid,mobile.hue)
+			for k,item in pairs(GetMobileEquipmentList(mobile)) do
 				local tiledata =3D GetStaticTileType(item.artid)
-				txt =3D txt .. sprintf(&quot;[%d]=3D{artid=3D%d,hue=3D%d,animid=3D%d},&quot;,k,i=
tem.artid,item.hue,tiledata and tiledata.miAnimID or 0)
-			end end =

+				txt =3D txt .. sprintf(&quot;{layer=3D%d,artid=3D%d,hue=3D%d,animid=3D%d},&quot;=
,item.layer,item.artid,item.hue,tiledata and tiledata.miAnimID or 0)
+			end =

 			txt =3D txt .. sprintf(&quot;}},\n&quot;)
 			printdebug(&quot;equip&quot;,txt)
 		end

Modified: trunk/data/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.spellbooks.lua (original)
+++ trunk/data/lua/lib.spellbooks.lua Thu Aug 30 21:17:18 2007
@@ -19,8 +19,8 @@
 container=3D0x41b72b8a item.serial=3D0x7fffffe2 artid=3D0x0000 artid_stack=
=3D0 item.amount=3D30
 ]]--
 function Convert_Spellbookcontainer(matrix,container)
-	if (container.items) then
-		for k,v in pairs(container.items) do
+	if (container:GetContent()) then
+		for k,v in pairs(container:GetContent()) do
 			local circle=3D0
 			v.artid=3Dtonumber(v.artid)
 			if (v.artid &gt;=3D hex2num(&quot;0x1F2D&quot;) and v.artid &lt; hex2num(&quot;0x1F35&quot;)) then

Modified: trunk/data/lua/lib.walking2.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.walking2.lua (original)
+++ trunk/data/lua/lib.walking2.lua Thu Aug 30 21:17:18 2007
@@ -162,7 +162,7 @@
 	local xloc=3Dbx*8+tx
 	local yloc=3Dby*8+ty
 	for k,dynamic in pairs(GetDynamicList()) do
-		if(dynamic.artid) then
+		if(DynamicIsInWorld(dynamic) and dynamic.artid) then
 =

 			-- is this a normal statictile or multi?
 			if (dynamic.artid &gt;=3D gMulti_ID) then -- gMulti_ID + 100

Modified: trunk/data/lua/net.securetrade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.securetrade.lua (original)
+++ trunk/data/lua/net.securetrade.lua Thu Aug 30 21:17:18 2007
@@ -37,7 +37,7 @@
 	--print(&quot;SecureTradeRebuildContainerWidgets&quot;,mysectrade.id,bIsMyStuff)
 	=

 	local parent =3D mysectrade.dialog.rootwidget
-	for k,item in pairs(container.items) do
+	for k,item in pairs(container:GetContent()) do
 		-- todo : gold art modifyer
 		local iArtID =3D item.artid + hex2num(&quot;0x4000&quot;)
 		local mat =3D GetArtMat(iArtID,item.hue)
@@ -72,7 +72,6 @@
 				local item =3D widget.item
 				local name =3D GetStaticTileTypeName(item.artid) or &quot;&quot;
 				info =3D sprintf(&quot;tradeitem %s amount=3D%d (artid=3D%04x=3D%d)&quot;,name,i=
tem.amount,item.artid,item.artid)
-				--print(&quot;MakeContainerItemWidget onMouseEnter &quot;,name,vardump(item))
 				gCurrentRenderer.gMousePickTippOverride =3D info
 				Client_SetBottomLine(gCurrentRenderer.gMousePickTippOverride)
 			end
@@ -80,7 +79,6 @@
 		end
 	end
 	=

-	-- container.items[item.serial] =3D item
 	--[[
 	SecureTradeObjectToObjectHook(item)
 	=

@@ -96,8 +94,8 @@
 	]]--
 end
 =

--- triggered when anythin is changed,added or removed in/from a container
--- kPacket_Container_Contents kPacket_Object_to_Object DestroyContainerIte=
mBySerial
+-- triggered when anything is changed,added or removed in/from a container
+-- kPacket_Container_Contents kPacket_Object_to_Object
 function SecureTradeRebuildContainerHook (container)
 	for k,mysectrade in pairs(gSecureTrades) do =

 		if (mysectrade.myContainerID	=3D=3D container.serial) then SecureTradeRe=
buildContainerWidgets(mysectrade,container,true) end
@@ -106,9 +104,9 @@
 end
 =

 function SecureTradeRebuildContainers (mysectrade)
-	local container_my =3D gContainer[mysectrade.myContainerID]
+	local container_my =3D GetContainer(mysectrade.myContainerID)
 	if (container_my) then SecureTradeRebuildContainerWidgets(mysectrade,cont=
ainer_my,true) end
-	local container_their =3D gContainer[mysectrade.theirContainerID]
+	local container_their =3D GetContainer(mysectrade.theirContainerID)
 	if (container_their) then SecureTradeRebuildContainerWidgets(mysectrade,c=
ontainer_their,false) end
 end
 =


Modified: trunk/data/lua/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.trade.lua (original)
+++ trunk/data/lua/net.trade.lua Thu Aug 30 21:17:18 2007
@@ -70,7 +70,7 @@
 		if (not playerBackpackContainer)	then print(&quot;FATAL : kPacket_Shop_Sell :=
 playerBackpackContainer not found&quot;) Crash() end
 		if (not playerMobile)				then print(&quot;FATAL : kPacket_Shop_Sell : playerM=
obile not found&quot;) Crash() end
 	=

-		if (true) then -- debug
+		if (false) then -- debug
 			for k,item in pairs(GetContainerContentList(playerBackpackContainer)) d=
o =

 				printf(&quot;item serial=3D0x%08x artid=3D0x%04x in backpack\n&quot;,item.serial=
,item.artid)
 			end
@@ -92,7 +92,7 @@
 			good.tradeamount=3D 0
 			good.index 		=3D i
 			good.item		=3D GetObjectBySerial(good.itemserial)
-			--- old : see also playerBackpackContainer.items[good.itemserial]			=

+			--- old : see also get obj with good.itemserial from playerBackpackCont=
ainer
 =

 			if (good.item) then -- item is not always available, especially if its =
in the backpack, and that has not been opened yet
 				if (good.itemartid ~=3D good.item.artid)	then printf(&quot;FATAL : kPacket_=
Shop_Sell : artid mismatch 0x%04x !=3D 0x%04x\n&quot;,good.itemartid,good.item.a=
rtid) Crash()  end
@@ -142,12 +142,12 @@
 	if (shop.goodcount &gt; 0) then
 		-- get associated container (probably on one of the special layers, kLay=
er_NPCBuyRestock or NPCBuyNoRestock)
 		-- usually sent together with this packet as kPacket_Container_Contents
-		local container =3D gContainer[shop.shopContainerID]
+		local container =3D GetContainer(shop.shopContainerID)
 		if (not container) then print(&quot;FATAL ! shop container not found&quot;,vardump=
(shop.shopContainerID)) Crash() end
 		=

 		-- goods are associate with items in container sorted by serial, ascendi=
ng or descending, depending on server Emu
 		local sorteditems =3D {}
-		for k,v in pairs(container.items) do table.insert(sorteditems,v) end
+		for k,v in pairs(container:GetContent()) do table.insert(sorteditems,v) =
end
 		if (gPolServer) then
 			table.sort(sorteditems,CompareSerialDesc)
 		else

Modified: trunk/data/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.walk.lua (original)
+++ trunk/data/lua/net.walk.lua Thu Aug 30 21:17:18 2007
@@ -90,7 +90,7 @@
 	=

 	-- destroy objects outside view range
 	-- dynamics
-	for k,dynamic in pairs(GetDynamicList()) do if (IsObjectFarEnoughToDestro=
y(dynamic.xloc,dynamic.yloc)) then
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
 and IsObjectFarEnoughToDestroy(dynamic.xloc,dynamic.yloc)) then
 		DestroyObjectBySerial(dynamic.serial) =

 	end end
 	-- mobiles

Modified: trunk/data/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.dynamic.lua (original)
+++ trunk/data/lua/net/net.dynamic.lua Thu Aug 30 21:17:18 2007
@@ -4,19 +4,22 @@
 -- This is sent by the server to equip a single item on a character.
 --Packet [2e], Length: 15, Type: Server
 --2e 40 02 21 9b 20 3b 00 0b 00 00 00 03 04 5e =

+-- watch out for kLayer_NPCBuyRestock and kLayer_NPCBuyNoRestock
 function gPacketHandler.kPacket_Equip_Item() -- ProtocolRecv_AddMobile
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 =

-	local item =3D {}
-	item.serial  			=3D input:PopNetUint32() -- (always starts 0x40 in my dat=
a)
-	item.artid				=3D input:PopNetUint16() -- also known as model
-	item.unknown1			=3D input:PopNetUint8() if (item.unknown1 ~=3D 0) then pr=
int(&quot;NET : kPacket_Equip_Item : unexpected unknown1 : &quot;,vardump(item)) end
-	item.layer				=3D input:PopNetUint8()
-	local container_serial	=3D input:PopNetUint32() -- &quot;container&quot; for item
-	item.hue				=3D input:PopNetUint16()
+	local dynamicdata =3D {}
+	dynamicdata.serial  			=3D input:PopNetUint32() -- (always starts 0x40 in=
 my data)
+	dynamicdata.artid_base			=3D input:PopNetUint16() -- also known as model
+	dynamicdata.unknown1			=3D input:PopNetUint8()  -- artid_addstack ? amoun=
t for corpse ?	=

+	if (dynamicdata.unknown1 ~=3D 0) then print(&quot;NET : kPacket_Equip_Item : u=
nexpected unknown1 : &quot;,vardump(dynamicdata)) end
 	=

-	ContainerEquipItem(item,container_serial)
+	dynamicdata.layer				=3D input:PopNetUint8()
+	dynamicdata.iContainerSerial	=3D input:PopNetUint32() -- &quot;container&quot; for =
item
+	dynamicdata.hue					=3D input:PopNetUint16()
+	=

+	HandleEquipItem(dynamicdata)
 end
 =

 =

@@ -35,90 +38,83 @@
 =

 -- show item (0x1a)
 function gPacketHandler.kPacket_Show_Item()
-	local newitem =3D {}
+	local dynamicdata =3D {}
 	local input =3D GetRecvFIFO()
 	local popped_start =3D input:GetTotalPopped()
 	local id =3D input:PopNetUint8()
 	=

 	local iPacketSize =3D input:PopNetUint16()
-	newitem.serial =3D input:PopNetUint32() -- id =3D serial . Include the fl=
ag 0x80000000 if the item's amount is greater than one.
-	newitem.artid =3D input:PopNetUint16() -- model =3D artwork . Include the=
 flag 0x8000 if the item's stackid is greater than zero.	=

+	dynamicdata.serial			=3D input:PopNetUint32() -- id =3D serial . Include =
the flag 0x80000000 if the item's amount is greater than one.
+	dynamicdata.artid_base		=3D input:PopNetUint16() -- model =3D artwork . I=
nclude the flag 0x8000 if the item's stackid is greater than zero.	=

 	=

-	-- newitem.amount  (or model # for corpses)
-	if (TestBit(newitem.serial,hex2num(&quot;0x80000000&quot;))) then =

-		newitem.amount =3D input:PopNetUint16() =

+	-- dynamicdata.amount  (or model # for corpses)
+	if (TestBit(dynamicdata.serial,hex2num(&quot;0x80000000&quot;))) then =

+		dynamicdata.amount =3D input:PopNetUint16() =

 	else 	=

-		newitem.amount =3D 1
+		dynamicdata.amount =3D 1
 	end
 	=

-	--print(&quot;artid,artidhex,bitwiseand&quot;,newitem.artid,sprintf(&quot;0x%04x&quot;,newite=
m.artid),BitwiseAND(newitem.artid,hex2num(&quot;0x8000&quot;)))
+	--print(&quot;artid_base,artidhex,bitwiseand&quot;,dynamicdata.artid_base,sprintf(&quot;=
0x%04x&quot;,dynamicdata.artid_base),BitwiseAND(dynamicdata.artid_base,hex2num(&quot;=
0x8000&quot;)))
 	=

-	-- newitem.artid_addstack : The number to add to the item's artwork when =
Amount &gt; 1.
-	if (TestBit(newitem.artid,hex2num(&quot;0x8000&quot;))) then =

-			newitem.artid_addstack =3D input:PopNetUint8() =

-	else	newitem.artid_addstack =3D 0 end
+	-- dynamicdata.artid_addstack : The number to add to the item's artwork w=
hen Amount &gt; 1.
+	if (TestBit(dynamicdata.artid_base,hex2num(&quot;0x8000&quot;))) then =

+			dynamicdata.artid_addstack =3D input:PopNetUint8() =

+	else	dynamicdata.artid_addstack =3D 0 end
 =

-	newitem.xloc =3D input:PopNetUint16() --only use lowest significant 15 bi=
ts)
-	newitem.yloc =3D input:PopNetUint16()
+	dynamicdata.xloc =3D input:PopNetUint16() --only use lowest significant 1=
5 bits)
+	dynamicdata.yloc =3D input:PopNetUint16()
 =

-	if (TestBit(newitem.xloc,hex2num(&quot;0x8000&quot;))) then
-		newitem.dir =3D input:PopNetUint8()
+	if (TestBit(dynamicdata.xloc,hex2num(&quot;0x8000&quot;))) then
+		dynamicdata.dir =3D input:PopNetUint8()
 	else	=

-		newitem.dir =3D 0
+		dynamicdata.dir =3D 0
 	end
 =

-	newitem.zloc =3D input:PopInt8()
+	dynamicdata.zloc =3D input:PopInt8()
 =

-	newitem.hue =3D 0
-	newitem.flag =3D 0
+	dynamicdata.hue =3D 0
+	dynamicdata.flag =3D 0
 	if (iPacketSize - (input:GetTotalPopped() - popped_start) &gt;=3D 2) then
-		if (TestBit(newitem.yloc,hex2num(&quot;0x8000&quot;))) then
-			newitem.hue =3D input:PopNetUint16()
+		if (TestBit(dynamicdata.yloc,hex2num(&quot;0x8000&quot;))) then
+			dynamicdata.hue =3D input:PopNetUint16()
 		end
 	end
 	if (iPacketSize - (input:GetTotalPopped() - popped_start) &gt;=3D 1) then
-		if (TestBit(newitem.yloc,hex2num(&quot;0x4000&quot;))) then
-			newitem.flag =3D input:PopNetUint8()
+		if (TestBit(dynamicdata.yloc,hex2num(&quot;0x4000&quot;))) then
+			dynamicdata.flag =3D input:PopNetUint8()
 		end
 	end
-	-- item_flag : some kind of status or flags, usage unknown
 	=

-	newitem.serial	=3D BitwiseAND(newitem.serial,hex2num(&quot;0x7fffffff&quot;))
-	newitem.artid	=3D BitwiseAND(newitem.artid,hex2num(&quot;0x7fff&quot;))
-	newitem.xloc	=3D BitwiseAND(newitem.xloc,hex2num(&quot;0x7fff&quot;))
-	newitem.yloc	=3D BitwiseAND(newitem.yloc,hex2num(&quot;0x3fff&quot;))
+	dynamicdata.serial		=3D BitwiseAND(dynamicdata.serial,hex2num(&quot;0x7fffffff=
&quot;))
+	dynamicdata.artid_base	=3D BitwiseAND(dynamicdata.artid_base,hex2num(&quot;0x7=
fff&quot;))
+	dynamicdata.xloc		=3D BitwiseAND(dynamicdata.xloc,hex2num(&quot;0x7fff&quot;))
+	dynamicdata.yloc		=3D BitwiseAND(dynamicdata.yloc,hex2num(&quot;0x3fff&quot;))
+	dynamicdata.iContainerSerial =3D 0
 	=

-	-- TODO : corpse is spawned
-	if (newitem.artid =3D=3D hex2num(&quot;0x2006&quot;)) then
-		print(&quot;TODO: char died. sethue,setdirection,setascorpse&quot;)
-	end
-
-	ApplyArtidStackManipulation(newitem)
-	=

-	CreateOrUpdateDynamic(newitem)
+	CreateOrUpdateDynamic(dynamicdata)
 end
 =

 -- AddItemToContainer (0x3C)
 -- pol sends this after kPacket_Open_Container, runuo before, see also kPa=
cket_Object_to_Object
 function gPacketHandler.kPacket_Container_Contents() -- 0x3c
 	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local itemcount =3D input:PopNetUint16()
+	local id		=3D input:PopNetUint8()
+	local size		=3D input:PopNetUint16()
+	local itemcount	=3D input:PopNetUint16()
 =

 	for i=3D1,itemcount do
-		local item =3D {}
-		item.serial =3D input:PopNetUint32()
-		item.artid =3D input:PopNetUint16()
-		item.artid_addstack =3D input:PopNetUint8()	--unknown1 (alyways 0x00) !?
-		item.amount =3D input:PopNetUint16()
-		item.xloc =3D input:PopNetInt16()
-		item.yloc =3D input:PopNetInt16()
-		item.zloc =3D 0
-		item.iContainerSerial =3D input:PopNetUint32()
-		item.hue =3D input:PopNetUint16()
+		local dynamicdata =3D {}
+		dynamicdata.serial				=3D input:PopNetUint32()
+		dynamicdata.artid_base			=3D input:PopNetUint16()
+		dynamicdata.artid_addstack		=3D input:PopNetUint8()
+		dynamicdata.amount				=3D input:PopNetUint16()
+		dynamicdata.xloc				=3D input:PopNetInt16()
+		dynamicdata.yloc				=3D input:PopNetInt16()
+		dynamicdata.zloc				=3D 0
+		dynamicdata.iContainerSerial 	=3D input:PopNetUint32()
+		dynamicdata.hue 				=3D input:PopNetUint16()
 =

-		ContainerSetContentItem(item)
+		CreateOrUpdateDynamic(dynamicdata)
 	end
 end
 =

@@ -126,17 +122,16 @@
 function gPacketHandler.kPacket_Object_to_Object() -- 0x25
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
-	local item =3D {}
-	item.serial =3D input:PopNetUint32()
-	item.artid =3D input:PopNetUint16()
-	item.artid_addstack =3D input:PopNetUint8()
-	item.amount =3D input:PopNetUint16()
-	item.xloc =3D input:PopNetInt16()
-	item.yloc =3D input:PopNetInt16()
-	item.iContainerSerial =3D input:PopNetUint32()
-	item.hue =3D input:PopNetUint16()
-	printdebug(&quot;net&quot;,sprintf(&quot;NET : kPacket_Object_to_Object : container=3D0x=
%08x item=3D0x%08x artid=3D0x%04x amount=3D%d\n&quot;,
-				item.iContainerSerial,item.serial,item.artid,item.amount))
-				=

-	ContainerObjectToObject(item)
+	local dynamicdata =3D {}
+	dynamicdata.serial				=3D input:PopNetUint32()
+	dynamicdata.artid_base			=3D input:PopNetUint16()
+	dynamicdata.artid_addstack		=3D input:PopNetUint8()
+	dynamicdata.amount				=3D input:PopNetUint16()
+	dynamicdata.xloc				=3D input:PopNetInt16()
+	dynamicdata.yloc				=3D input:PopNetInt16()
+	dynamicdata.zloc				=3D 0
+	dynamicdata.iContainerSerial	=3D input:PopNetUint32()
+	dynamicdata.hue					=3D input:PopNetUint16()
+	=

+	CreateOrUpdateDynamic(dynamicdata)
 end

Modified: trunk/data/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.mobile.lua (original)
+++ trunk/data/lua/net/net.mobile.lua Thu Aug 30 21:17:18 2007
@@ -55,20 +55,20 @@
 	while true do =

 		if ( iPacketSize &lt; (fifolen_start - input:Size()+4) ) then break end
 		=

-		local itemdata =3D {}
-		itemdata.serial =3D input:PopNetUint32()
-		if (itemdata.serial =3D=3D 0) then break end
+		local dynamicdata =3D {}
+		dynamicdata.serial =3D input:PopNetUint32()
+		if (dynamicdata.serial =3D=3D 0) then break end
 		=

 		if ( iPacketSize &lt; (fifolen_start - input:Size()+3) ) then break end
-		itemdata.artid =3D input:PopNetUint16()
-		itemdata.layer =3D input:PopNetUint8()
-		if (TestBit(itemdata.artid,hex2num(&quot;0x8000&quot;)) and ( iPacketSize &gt;=3D (fi=
folen_start - input:Size()+2) )) then
-				itemdata.hue =3D input:PopNetUint16()
-		else	itemdata.hue =3D 0 -- TODO : default value ?
+		dynamicdata.artid_base =3D input:PopNetUint16()
+		dynamicdata.layer =3D input:PopNetUint8()
+		if (TestBit(dynamicdata.artid_base,hex2num(&quot;0x8000&quot;)) and ( iPacketSize =
&gt;<i>=3D (fifolen_start - input:Size()+2) )) then
</I>+				dynamicdata.hue =3D input:PopNetUint16()
+		else	dynamicdata.hue =3D 0 -- TODO : default value ?
 		end
-		itemdata.artid =3D BitwiseAND(itemdata.artid,hex2num(&quot;0x7fff&quot;))
-		if (equipmentdata[itemdata.layer]) then print(&quot;warning ! Equipped_MOB : =
layer contains more than one item&quot;,itemdata.layer) end
-		equipmentdata[itemdata.layer] =3D itemdata
+		dynamicdata.artid_base =3D BitwiseAND(dynamicdata.artid_base,hex2num(&quot;0x=
7fff&quot;))
+		if (equipmentdata[dynamicdata.layer]) then print(&quot;warning ! Equipped_MOB=
 : layer contains more than one item&quot;,dynamicdata.layer) end
+		equipmentdata[dynamicdata.layer] =3D dynamicdata
 	end
 	=

 	CreateOrUpdateMobile(mobiledata,equipmentdata)
@@ -256,3 +256,26 @@
 	=

 	gCurrentRenderer:NotifyHPChange( serial, damage, 0 )
 end
+
+
+-- Fighting - Swing [0x2F] 10bytes
+-- TODO : handle animation
+-- TODO : is this packet actually used ?
+function gPacketHandler.kPacket_Swing()
+	local input =3D GetRecvFIFO()
+	local id =3D input:PopNetUint8()
+	local unknown1 =3D input:PopNetUint8()
+	local attacker_serial =3D input:PopNetUint32()
+	local defender_serial =3D input:PopNetUint32()
+	printf(&quot;NET: Swing Attack Animation, attacker=3D0x%08x defender=3D0x%08x\=
n&quot;,attacker_serial,defender_serial)
+end
+
+-- TODO : what is the result of this packet?
+--BYTE cmd =

+--BYTE action (2=3Dghost, 1=3Dresurrect, 0=3Dfrom server)
+function gPacketHandler.kPacket_Death()
+	local input =3D GetRecvFIFO()
+	local id =3D input:PopNetUint8()
+	local action =3D input:PopNetUint8()
+	print(&quot;NET: Server sends, that player is now (2=3Dghost, 1=3Dresurrect, 0=
=3Dfrom server)=3D&quot;..action)
+end

Modified: trunk/data/lua/net/net.packethandlers.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.packethandlers.lua (original)
+++ trunk/data/lua/net/net.packethandlers.lua Thu Aug 30 21:17:18 2007
@@ -9,27 +9,7 @@
 	containerdata =3D {}
 	containerdata.serial =3D input:PopNetUint32()
 	containerdata.gumpid =3D input:PopNetUint16()
-	=

-	print(&quot;# kPacket_Open_Container&quot;,containerdata.serial,containerdata.gumpi=
d)
-	=

-	--Ignore Shop container - created somewhere else
-	if (containerdata.gumpid =3D=3D kGumpIDShopContainer) then
-		AddFadeLines(sprintf(&quot;Open_ShopContainer id=3D0x%08x&quot;,containerdata.seri=
al))
-	--Old_Spellbook Container (Pol,Sphere,Lonewolf,RunUO1 etc.)
-	elseif ((containerdata.gumpid =3D=3D kGumpIDSpellbookContainer) and (not =
IsContainerAlreadyOpen(containerdata.serial))) then
-		local spellbook =3D {}
-		spellbook.old=3Dtrue
-		spellbook.serial =3D containerdata.serial
-		spellbook.itemid =3D containerdata.gumpid
-		spellbook.scrolloffset =3D 0
-		spellbook.matrix =3D {}
-		for i=3D1, 8 do spellbook.matrix[i] =3D 0 end
-		-- container with spell is already created (invisible)
-		Open_Spellbook(spellbook)
-		printf(&quot;NET: Old_Spellbook: serial=3D0x%08x itemId=3D0x%04x offset=3D0x%=
04x\n&quot;,spellbook.serial, spellbook.itemid, spellbook.scrolloffset)
-	else
-		HandleOpenContainer(containerdata)
-	end
+	HandleOpenContainer(containerdata)
 end
 =

 function gPacketHandler.kPacket_Open_Paperdoll() -- 0x88

Modified: trunk/data/lua/obj/obj.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.dynamic.lua (original)
+++ trunk/data/lua/obj/obj.dynamic.lua Thu Aug 30 21:17:18 2007
@@ -1,175 +1,252 @@
 -- handles dynamic items (lamps,doors,inventory,...)
-
--- called from kPacket_Show_Item
-function CreateOrUpdateDynamic	(newitem)
-	-- TODO : if (newitem.artid &gt;=3D gMulti_ID +100) .. model is multi
+-- see also obj.container.lua
+
+-- NOTE : pre-knut old-trunk-dynamics were ONLY objects in world, =

+-- new/post-knut dynamics are containers, items inside container and mobil=
e equipment as well
+
+--[[
+dynamic.serial				=

+dynamic.artid	-- see ApplyArtidStackManipulation
+dynamic.artid_base			=

+dynamic.artid_addstack		=

+dynamic.amount				=

+dynamic.layer	-- only if dynamic is mobile equipment from kPacket_Equipped=
_MOB	 or from kPacket_Equip_Item	=

+dynamic.xloc				=

+dynamic.yloc				=

+dynamic.zloc	-- only nonzero if in world : kPacket_Show_Item				=

+dynamic.dir		-- only nonzero if in world : kPacket_Show_Item				=

+dynamic.iContainerSerial 	=

+dynamic.hue 				=

+dynamic.flag	-- only nonzero if in world : kPacket_Show_Item -- some kind =
of status or flags, usage unknown	=

+
+CreateOrUpdateDynamic(dynamicdata)
+]]--
+
+gDynamicPrototype =3D {}
+
+function GetDynamic (dynamic_or_serial) =

+	if (not dynamic_or_serial) then return nil end
+	if (type(dynamic_or_serial) =3D=3D &quot;table&quot;) then return dynamic_or_serial=
 end
+	return gDynamics[dynamic_or_serial] -- look up by serial
+end
+
+
+-- constructor, don't call directly, use CreateOrUpdateDynamic() instead
+function InitializeDynamic	(serial)
+	assert(serial ~=3D 0)
+	=

+	-- create base object and register in mobile-list
+	local dynamic =3D InitializeObject(serial)
+	gDynamics[serial] =3D dynamic
+	=

+	-- install methods
+	ArrayOverwrite(dynamic,gContainerPrototype)
+	ArrayOverwrite(dynamic,gDynamicPrototype)
+	=

+	dynamic.content =3D {}
+	dynamic.isdynamic =3D true -- needed to identify type in 2d renderer and =
for asserts
+	dynamic.artid =3D 0		=

+	dynamic.artid_base =3D 0			=

+	dynamic.artid_addstack =3D 0		=

+	dynamic.amount =3D 0					=

+	dynamic.xloc =3D 0				=

+	dynamic.yloc =3D 0				=

+	dynamic.zloc =3D 0			=

+	dynamic.dir =3D 0				=

+	dynamic.iContainerSerial =3D 0 	=

+	dynamic.hue =3D 0 				=

+	dynamic.flag =3D 0
+	=

+	return dynamic
+end
+
+
+
+-- called from kPacket_Show_Item,kPacket_Object_to_Object,kPacket_Containe=
r_Contents
+-- mobile is only set if called from mobile:Update with equipmentdata , e.=
g. from kPacket_Equipped_MOB or kPacket_Equip_Item
+function CreateOrUpdateDynamic	(dynamicdata,mobile)
+	local dynamic =3D GetDynamic(dynamicdata.serial)
+	if (not dynamic) then dynamic =3D InitializeDynamic(dynamicdata.serial) e=
nd
+	dynamic:Update(dynamicdata,mobile)
+	return dynamic
+end
+
+
+-- see also CreateOrUpdateDynamic
+function gDynamicPrototype:Update (dynamicdata,mobile)
+	if (self.bDestructionInProgress) then return end -- avoid updates during =
destruction
+	--print(&quot;gDynamicPrototype:Update&quot;,self,self.serial,_TRACEBACK())
+	=

+	if (dynamicdata) then =

+		assert(not dynamicdata.artid,&quot;this shouldn't be set from dynamicdata, re=
placed by artid_base&quot;) -- bugcheck
+		for k,v in pairs(dynamicdata) do self[k] =3D v end =

+	end
+	self:ApplyArtidStackManipulation()
+	=

+	=

+	-- TODO : corpse is spawned
+	if (dynamicdata and dynamicdata.artid_base =3D=3D hex2num(&quot;0x2006&quot;)) then
+		print(&quot;TODO: char died. sethue,setdirection,setascorpse&quot;)
+	end =

+	=

+	-- self is mobile equipment
+	local mobile =3D mobile or GetMobile(self.iContainerSerial)
+	if (mobile and mobile.ismobile)  then
+		-- kPacket_Equipped_MOB : =

+		-- dynamicdata.serial =

+		-- dynamicdata.artid
+		-- dynamicdata.layer
+		-- dynamicdata.hue
+		=

+		-- kPacket_Equip_Item : =

+		-- dynamicdata.serial  		=

+		-- dynamicdata.artid_base		=

+		-- dynamicdata.layer			=

+		-- dynamicdata.iContainerSerial -- mobile serial
+		-- dynamicdata.hue	=

+		=

+		self.iContainerSerial =3D mobile.serial
+		=

+		self.mobile =3D mobile 					-- TODO : knutmerge : should this be removed=
 ?
+		self.mobile_serial =3D mobile.serial		-- TODO : knutmerge : should this =
be removed ?
+		=

+		-- destroy old item on layer, if any
+		if (self.layer) then =

+			local old =3D mobile:GetEquipmentAtLayer(self.layer)
+			if (old and old ~=3D self) then old:Destroy() end
+		end
+		-- self:SetContainer(self.iContainerSerial) is called later and tiggers =
mobile:Update()
+	end
+	=

+	local bIsInWorld =3D self.iContainerSerial =3D=3D 0
+	-- i think bIsInWorld is only true if the object was initially created us=
ing kPacket_Show_Item
+	-- or is it possible for object_to_object/equip_item to set iContainerSer=
ial to zero ?
+
+	if (not bIsInWorld) then =

+		-- TODO : burn in gumpyoffset if dynamicdata contains position ?? =

+		-- self.yloc =3D self.yloc+self.gumpyoffset
+	end
+
+
+	-- TODO : if (self.artid &gt;=3D gMulti_ID +100) .. model is multi
 	-- gMulti_ID =3D hex2num(&quot;0x4000&quot;)
-	-- TODO : check newitem.artid for boat
+	-- TODO : check self.artid for boat
 	=

 	if (gTileTypeLoader) then
-		local miFlags,miWeight,miQuality,miUnknown,miUnknown1,miQuantity,miAnimI=
D,miUnknown2,miHue,miUnknown3,miHeight,msName =3D gTileTypeLoader:GetStatic=
TileType(newitem.artid+32*512) -- add 0x00004000
-		newitem.z_typename =3D msName
-	end
-	=

-	printdebug(&quot;mobile&quot;,&quot;ShowItem &quot;..vardump(newitem))
-	=

-	newitem.isdynamic =3D true -- needed to identify the dynamic in 2d render=
er
-	=

-	local bCreateNew =3D true
-	=

-	local olditem =3D GetDynamic(newitem.serial)
-	if (olditem) then
-		-- if only the position changed we can just update the old one
-		if (	newitem.artid =3D=3D olditem.artid and =

-				newitem.amount =3D=3D olditem.amount and =

-				newitem.flag =3D=3D olditem.flag and =

-				newitem.hue =3D=3D olditem.hue and =

-				newitem.dir =3D=3D olditem.dir and =

-				newitem.artid_addstack =3D=3D olditem.artid_addstack ) then
-			-- update old item
-			bCreateNew =3D false
-			olditem.xloc =3D newitem.xloc
-			olditem.yloc =3D newitem.yloc
-			olditem.zloc =3D newitem.zloc
-			newitem =3D olditem
-		else
-			gCurrentRenderer:RemoveDynamicItem( olditem )
-		end
-	end
-	=

-	if (bCreateNew) then gCurrentRenderer:AddDynamicItem( newitem ) end
-	=

-	gCurrentRenderer:UpdateDynamicItemPos(newitem)
-	gDynamics[newitem.serial] =3D newitem	=

-	gObjectList[newitem.serial] =3D newitem	 -- TODO : fix this like in mobile
-end
-
-
--- called from kPacket_Object_to_Object
-function ContainerObjectToObject	(item)
-	ApplyArtidStackManipulation(item)
-	RefreshContainerItem(item)
-end
-
--- called from kPacket_Container_Contents
-function ContainerSetContentItem	(item)
-	ApplyArtidStackManipulation(item)
-	RefreshContainerItem(item)
-	--printf(&quot;container=3D0x%08x item.serial=3D0x%08x artid=3D0x%04x artid_st=
ack=3D%i item.amount=3D%d\n&quot;,item.iContainerSerial,item.serial,item.artid,i=
tem.artid_addstack,item.amount)
-	--AddFadeLines(sprintf(&quot;kPacket_Container_Contents type=3D%s&quot;,GetStaticTi=
leTypeName(item.artid)))
-end
-
--- called from kPacket_Equip_Item
-function ContainerEquipItem(item,container_serial)
-	--print(&quot;NET : Equip_Item&quot;,vardump(item))
-	=

-	item.mobile_serial =3D container_serial
-	local mobile =3D GetMobile(item.mobile_serial)
-	if (mobile) then
-		item.mobile =3D mobile
-		if (mobile.equipment[item.layer]) then
-			DestroyMobileItem(mobile.equipment[item.layer])
-		end
-		mobile.equipment[item.layer] =3D item
-		gMobileItemsBySerial[item.serial] =3D item
-		--printf(&quot;NET : kPacket_Equip_Item mobile=3D0x%08x item=3D0x%08x\n&quot;,item=
.mobile_serial,item.serial)
-		mobile:Update()
-	else =

-		print(&quot;WARNING ! mobile update for unknown mobile received, update lost =
!&quot;)
-
-		-- don't crash on UOX3, Lonewolf (this servers sends unknown Equip messa=
ges)
-		if ((gServerType[gServerEmulator] ~=3D &quot;Lonewolf&quot;) and (gServerType[gSer=
verEmulator] ~=3D &quot;SpherePolUox3&quot;)) then
-			print(&quot;Crash Client here!&quot;..gServerType[gServerEmulator])
-			Crash()
-		end
-
-		-- the client state would loose sync with server, this is fatal, =

-		-- but should never happen for correct server implementation ? (there ar=
e strange servers however...)
-		-- an alternative would be to create the mobile if unknown , something l=
ike GetOrCreateMobile like in net.container.lua
-	end
-end
-
--- called from kPacket_Open_Container
-function IsContainerAlreadyOpen (containerserial) =

-	local container =3D GetOrCreateContainer(containerdata.serial)
-	return container.dialog ~=3D nil
-end
-
-
--- called from kPacket_Open_Container
-function HandleOpenContainer	(containerdata)
-
-	local container =3D GetOrCreateContainer(containerdata.serial)
-	container.gumpid =3D containerdata.gumpid
-	=

-	-- 0x003c =3D backpack
-	-- 0x0030 =3D shopcontainer
-	--AddFadeLines(sprintf(&quot;Open_Container gumpid=3D%d&quot;,container.gumpid))
-	if (not container.dialog) then
-		-- create dialog from scratch
-		local dialog =3D guimaker.MakeSortedDialog()
-		container.dialog =3D dialog
-		dialog.uoContainer =3D container
-		dialog.rootwidget.gfx:SetPos(200,100) -- TODO : choose position
-		dialog.backpane =3D MakeBorderGumpPart(dialog.rootwidget,container.gumpi=
d,0,0)
-		dialog.backpane.mbIgnoreMouseOver =3D false
-		dialog.backpane.onMouseDown =3D function (widget,mousebutton)
-										if (mousebutton =3D=3D 2) then CloseContainer(widget.dialog.uoCo=
ntainer.serial) end
-										if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.=
StartMoveDialog(widget.dialog.rootwidget) end
-									  end
-	end
-	RefreshContainerItemWidgets(container)
-
-	SecureTradeRebuildContainerHook(container)
-end
-
-
-
+		local miFlags,miWeight,miQuality,miUnknown,miUnknown1,miQuantity,miAnimI=
D,miUnknown2,miHue,miUnknown3,miHeight,msName =3D gTileTypeLoader:GetStatic=
TileType(self.artid+32*512) -- add 0x00004000
+		self.z_typename =3D msName
+	end
+	=

+	-- update container
+	self:SetContainer(self.iContainerSerial)
+	=

+	-- secure trade hook (new here since knut merge)
+	SecureTradeRebuildContainerHook(self)
+	=

+	-- update stuff if self is container
+	RefreshContainerItemWidgets(self)
+	=

+	self:NotifyListener(&quot;Dynamic_Update&quot;)
+	=

+	-- destroy old world gfx
+	if (self.bWorldGfxInitialised) then =

+		self.bWorldGfxInitialised =3D false
+		gCurrentRenderer:RemoveDynamicItem(self) =

+	end
+	=

+	-- only create WorldGfx if item IS IN WORLD (and not in inside a containe=
r, or being a container itself like shop stuff)
+	if (bIsInWorld) then =

+		self.bWorldGfxInitialised =3D true
+		gCurrentRenderer:AddDynamicItem(self) -- create new gfx
+		gCurrentRenderer:UpdateDynamicItemPos(self)
+	end
+end
+
+function gDynamicPrototype:UpdateContent () self:Update() end
+
+function gDynamicPrototype:Destroy	()
+	self.bDestructionInProgress =3D true
+	--print(&quot;gDynamicPrototype:Destroy&quot;,self,self.serial,_TRACEBACK())
+	if (self.bIsDead) then print(&quot;warning, double free dyamic&quot;) return end --=
 already destroyed before
+	self:NotifyListener(&quot;Dynamic_Destroy&quot;)
+	self:SetContainer(nil) -- calls self.mobile:Update() if self is equipment=
 item in mobile
+	=

+	-- paperdoll widgets (and maybe others?)
+	-- TODO : knutmerge : check me
+	if (self.widget) then self.widget:Destroy() self.widget =3D nil end
+	=

+	-- destroy old world gfx
+	if (self.bWorldGfxInitialised) then =

+		self.bWorldGfxInitialised =3D false
+		gCurrentRenderer:RemoveDynamicItem(self) =

+	end
+	=

+	gDynamics[self.serial] =3D nil
+	CleanupObject(self)
+end
+
+-- updates widgets automatically through old,new:UpdateContent() message
+function gDynamicPrototype:SetContainer	(newcontainer_or_serial)
+	newcontainer =3D GetContainer(newcontainer_or_serial)
+	if (self.container =3D=3D newcontainer) then return end
+	if (self.container) then self.container:RemoveContentObject(self) end -- =
remove from old
+	if (newcontainer) then newcontainer:AddContentObject(self) end -- add to =
new (sets self.container)
+end
+
+function gDynamicPrototype:NotifyListener	(eventname)
+	NotifyListener(eventname..self.serial,self)
+	NotifyListener(eventname,self)
+end
+
+-- only called from dynamic:Update
 -- TODO : Add sepearate FILTER : for several Clientside GFX manipulation (=
Game Pieces &amp; Gold,Silver,...)
-function ApplyArtidStackManipulation (item)
-	item.baseartid =3D item.artid
+-- calculates artid from artid_base,artid_addstack and several special cas=
es (coins,chess pieces..)
+-- chess pieces etc have an y offset : self.yloc =3D self.yloc+self.gumpyo=
ffset, but don't change the original y here, =

+-- as this method is called for every update. also DON'T DO THIS FOR DYNAM=
ICS IN WORLD ! (offset 20 tiles is deadly)
+function gDynamicPrototype:ApplyArtidStackManipulation ()
 	local custom_artid =3D false
+	self.artid =3D self.artid_base
+	self.usegump =3D false
+	self.gumpyoffset =3D 0
 	=

 	-- from varan
 	-- gold
-	if (item.baseartid =3D=3D hex2num(&quot;0xEED&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEEE&quot;) custom_artid =3D true end
-	if (item.baseartid =3D=3D hex2num(&quot;0xEED&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEEF&quot;) custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0xEED&quot;) and self.amount &gt;=3D 2) then =
self.artid =3D hex2num(&quot;0xEEE&quot;) custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0xEED&quot;) and self.amount &gt;=3D 6) then =
self.artid =3D hex2num(&quot;0xEEF&quot;) custom_artid =3D true end
 	-- gold
-	if (item.baseartid =3D=3D hex2num(&quot;0xEEA&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEEB&quot;) custom_artid =3D true end
-	if (item.baseartid =3D=3D hex2num(&quot;0xEEA&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEEC&quot;) custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0xEEA&quot;) and self.amount &gt;=3D 2) then =
self.artid =3D hex2num(&quot;0xEEB&quot;) custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0xEEA&quot;) and self.amount &gt;=3D 6) then =
self.artid =3D hex2num(&quot;0xEEC&quot;) custom_artid =3D true end
 	-- Silver
-	if (item.baseartid =3D=3D hex2num(&quot;0xEF0&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEF1&quot;) custom_artid =3D true end
-	if (item.baseartid =3D=3D hex2num(&quot;0xEF0&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEF2&quot;) custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0xEF0&quot;) and self.amount &gt;=3D 2) then =
self.artid =3D hex2num(&quot;0xEF1&quot;) custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0xEF0&quot;) and self.amount &gt;=3D 6) then =
self.artid =3D hex2num(&quot;0xEF2&quot;) custom_artid =3D true end
 	-- cannonball
-	if (item.baseartid =3D=3D hex2num(&quot;0xE73&quot;) and item.amount &gt;=3D 4) then i=
tem.artid =3D hex2num(&quot;0xE74&quot;) custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0xE73&quot;) and self.amount &gt;=3D 4) then =
self.artid =3D hex2num(&quot;0xE74&quot;) custom_artid =3D true end
 =

 	--TODO : if not in this list, and amount &gt; 0 : draw the graphic 2 times
-	--for example: if (item.baseartid =3D=3D hex2num(&quot;0xE73&quot;) and item.amount=
 &gt; 0) then item.artid =3D hex2num(&quot;0xE74&quot;) item.drawcount=3D2 end
+	--for example: if (self.artid_base =3D=3D hex2num(&quot;0xE73&quot;) and self.amoun=
t &gt; 0) then self.artid =3D hex2num(&quot;0xE74&quot;) self.drawcount=3D2 end
 =

 	-- ART -&gt; GUMP
 	-- white backgammon game piece
-	if (item.baseartid =3D=3D hex2num(&quot;0x3584&quot;)) then item.artid =3D hex2num(=
&quot;0x91B&quot;) item.usegump=3Dtrue custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3584&quot;)) then self.artid =3D hex2num=
(&quot;0x91B&quot;) self.usegump=3Dtrue custom_artid =3D true end
 	-- brown backgammon game piece
-	if (item.baseartid =3D=3D hex2num(&quot;0x358b&quot;)) then item.artid =3D hex2num(=
&quot;0x922&quot;) item.usegump=3Dtrue custom_artid =3D true end
+	if (self.artid_base =3D=3D hex2num(&quot;0x358b&quot;)) then self.artid =3D hex2num=
(&quot;0x922&quot;) self.usegump=3Dtrue custom_artid =3D true end
 	-- brown chess pieces
-	if (item.baseartid =3D=3D hex2num(&quot;0x3590&quot;)) then item.artid =3D hex2num(=
&quot;0x927&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358d&quot;)) then item.artid =3D hex2num(=
&quot;0x924&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358f&quot;)) then item.artid =3D hex2num(=
&quot;0x926&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358c&quot;)) then item.artid =3D hex2num(=
&quot;0x923&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3591&quot;)) then item.artid =3D hex2num(=
&quot;0x928&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358e&quot;)) then item.artid =3D hex2num(=
&quot;0x925&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3590&quot;)) then self.artid =3D hex2num=
(&quot;0x927&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x358d&quot;)) then self.artid =3D hex2num=
(&quot;0x924&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x358f&quot;)) then self.artid =3D hex2num=
(&quot;0x926&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x358c&quot;)) then self.artid =3D hex2num=
(&quot;0x923&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3591&quot;)) then self.artid =3D hex2num=
(&quot;0x928&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x358e&quot;)) then self.artid =3D hex2num=
(&quot;0x925&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
 	-- white chess pieces
-	if (item.baseartid =3D=3D hex2num(&quot;0x3589&quot;)) then item.artid =3D hex2num(=
&quot;0x920&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3586&quot;)) then item.artid =3D hex2num(=
&quot;0x91D&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3588&quot;)) then item.artid =3D hex2num(=
&quot;0x91F&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3585&quot;)) then item.artid =3D hex2num(=
&quot;0x91C&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358a&quot;)) then item.artid =3D hex2num(=
&quot;0x921&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3587&quot;)) then item.artid =3D hex2num(=
&quot;0x91E&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue custom_artid =3D true=
 end
-
-	if ((not custom_artid) and item.artid_addstack and item.amount &gt; 1) then =

-		item.artid =3D item.artid + item.artid_addstack =

-		item.artid_addstack =3D 0 -- avoid bad errors if this function is applie=
d more than once
-	end
-	-- just for testing, remove me
-	--if (item.artid_addstack ~=3D 0) then print(&quot;unexpected item.artid_addst=
ack&quot;,item.artid_addstack) Crash() end
-end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3589&quot;)) then self.artid =3D hex2num=
(&quot;0x920&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3586&quot;)) then self.artid =3D hex2num=
(&quot;0x91D&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3588&quot;)) then self.artid =3D hex2num=
(&quot;0x91F&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3585&quot;)) then self.artid =3D hex2num=
(&quot;0x91C&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x358a&quot;)) then self.artid =3D hex2num=
(&quot;0x921&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+	if (self.artid_base =3D=3D hex2num(&quot;0x3587&quot;)) then self.artid =3D hex2num=
(&quot;0x91E&quot;) self.gumpyoffset =3D -20 self.usegump=3Dtrue custom_artid =3D tru=
e end
+
+	-- self.yloc =3D self.yloc+self.gumpyoffset =

+	if ((not custom_artid) and self.artid_addstack and self.amount &gt; 1) then =

+		self.artid =3D self.artid + self.artid_addstack =

+	end
+end

Modified: trunk/data/lua/obj/obj.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.main.lua (original)
+++ trunk/data/lua/obj/obj.main.lua Thu Aug 30 21:17:18 2007
@@ -1,64 +1,64 @@
 dofile(libpath .. &quot;obj/obj.mobile.lua&quot;)
 dofile(libpath .. &quot;obj/obj.dynamic.lua&quot;)
-dofile(libpath .. &quot;obj/obj.player.lua&quot;)
+dofile(libpath .. &quot;obj/obj.player.lua&quot;)
+dofile(libpath .. &quot;obj/obj.container.lua&quot;)
 =

 gObjectList =3D {}
 gDynamics =3D {}
 gMobiles =3D {}
-gMobileItemsBySerial =3D {} -- items equipped on mobiles TODO : killme !
 =

 function GetDynamic (serial) return gDynamics[serial] end
-function GetMobileEquipmentItem (mobile,layer) return mobile.equipment[lay=
er] end
-function GetMobileEquipmentList (mobile) return mobile.equipment end
-function GetContainerContentList (container) return container.items end
-function GetObjectBySerial (serial) return gMobileItemsBySerial[serial] or=
 GetMobile(serial) or gDynamics[serial] end
+function GetMobileEquipmentItem (mobile,layer) return mobile:GetEquipmentA=
tLayer(layer) end
+function GetMobileEquipmentList (mobile) return mobile:GetContent() end
+function GetContainerContentList (container) return container:GetContent()=
 end
+function GetObjectBySerial (serial) return GetObject(serial) end
+function GetObject (object_or_serial) =

+	if (not object_or_serial) then return nil end
+	if (type(object_or_serial) =3D=3D &quot;table&quot;) then return object_or_serial e=
nd
+	return gObjectList[object_or_serial] -- look up by serial
+end
 =

-function DynamicIsInWorld (dynamic) return not dynamic.container end  -- T=
ODO : spelling of container correct ???
+function DynamicIsInWorld (dynamic) return not dynamic.container end  -- d=
oes not have parent container
 =

 function GetDynamicList	() return gDynamics end
 function GetMobileList	() return gMobiles end
 =

--- temporary knut merge wrappers for syncing, naming will be fixed as the =
merge progresses
-function KNUTMERGETEMP_CREATE_EMPTY_OBJECT	(serial) =

-	local newitem =3D {serial=3Dserial} =

-	gObjectList[serial] =3D newitem
-	return newitem
-end
-function KNUTMERGETEMP_CREATE_EMPTY_ITEM	(serial) return KNUTMERGETEMP_CRE=
ATE_EMPTY_OBJECT(serial) end
-
-function DestroyDynamicItemBySerial (serial) =

-	local dynamic =3D GetDynamic(serial)
-	if (dynamic) then
-		gCurrentRenderer:RemoveDynamicItem( dynamic )
-		gDynamics[dynamic.serial] =3D nil
-	end
+function InitializeObject	(serial) =

+	local object =3D {serial=3Dserial} =

+	gObjectList[serial] =3D object
+	return object
 end
 =

+
+
+-- don't call directly, called from object:Destroy()
+function CleanupObject	(object)
+	local serial =3D object.serial
+	=

+	CloseContainer(serial)
+	object:DestroyContent()
+	=

+	-- TODO : knutmerge : check which of these is obsolete
+	DestroyPaperdollByMobileSerial(serial)
+	DestroyDragDropItemBySerial(serial)
+	gCurrentRenderer:DestroyMousePickItemBySerial(serial)
+	=

+	gObjectList[object.serial] =3D nil =

+	--object.serial =3D nil -- seems to cause a lot of trouble, e.g. dragdrop
+	object.bIsDead =3D true
+end
+
+
+
 function DestroyObjectBySerial (serial) =

-	-- destroy items in containers
-	DestroyContainerItemBySerial(serial)
-	-- destroy items in mobiles
-	DestroyMobileItemBySerial(serial)
-	-- destroy dynamics
-	DestroyDynamicItemBySerial(serial)
-	-- destroy mobiles (npcs, monsters,...)
-	Mobile_Destroy(serial)
-	DestroyPaperdollByMobileSerial(serial)
-	-- TODO : destroy container
-	gCurrentRenderer:DestroyMousePickItemBySerial(serial)
-	DestroyDragDropItemBySerial(serial)
+	local object =3D GetObject(serial)
+	if (object) then object:Destroy() end
 end
 =

 -- needed for mapchange
 function DestroyAllObjects () =

 	CancelUODragDrop()
-	for serial,v in pairs(gContainer) do 			CloseContainer(serial) end
-	for serial,v in pairs(gMobileItemsBySerial) do 	DestroyMobileItemBySerial=
(serial) end
-	for serial,v in pairs(GetMobileList()) do 		Mobile_Destroy(serial) end
-	for serial,v in pairs(GetDynamicList()) do 		DestroyDynamicItemBySerial(s=
erial) end
-	for serial,v in pairs(gPaperdolls) do 			DestroyPaperdollByMobileSerial(s=
erial) end
-	-- TODO : gCurrentRenderer:DestroyMousePickItemBySerial(serial)
-	-- TODO : DestroyDragDropItemBySerial ?? done by CancelUODragDrop
+	for k,object in pairs(gObjectList) do object:Destroy() end
 end
 =

 =


Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Thu Aug 30 21:17:18 2007
@@ -16,8 +16,8 @@
 mobile.amount	-- only kPacket_Equipped_MOB, corpse related ?
 mobile.dir2		-- only kPacket_Equipped_MOB, unknown
 =

-Mobile_GetEquipmentList 	(mobile_or_serial)
-Mobile_NotifyListener		(mobile_or_serial,eventname)
+CreateOrUpdateMobile (mobiledata,equipmentdata)
+
 Mobile_Update 				(mobile_or_serial,mobiledata,equipmentdata)
 Mobile_UpdateFlags			(mobile_or_serial)
 Mobile_UpdateStats 			(mobile_or_serial,stats)
@@ -28,22 +28,27 @@
 Mobile_Destroy				(mobile_or_serial)
 Mobile_DisplayTextOverHead	(mobile_or_serial,message,r,g,b)
 =

-each of those is also available as method you can call like mobile:(...) w=
ithout the first param
+each of those is also available as method you can call like mobile:(...) w=
ithout the first param and without the Mobile_
 ]]--
 =

 =

 gMobilePrototype =3D {}
-gbMobileMethodWrappersInitialised =3D false
+gbMobileMethodWrappersInitialized =3D false
 =

 function GetMobile (mobile_or_serial) =

+	if (not mobile_or_serial) then return nil end
 	if (type(mobile_or_serial) =3D=3D &quot;table&quot;) then return mobile_or_serial e=
nd
 	return gMobiles[mobile_or_serial] -- look up by serial
 end
 =

-function KNUTMERGETEMP_CREATE_EMPTY_MOBILE	(serial)
+
+-- constructor, don't call directly, use CreateOrUpdateMobile() instead
+function InitializeMobile	(serial)
+	assert(serial ~=3D 0)
+	=

 	-- create method wrapppers, e.g. Mobile_UpdateFlags(serial) calls mobile:=
UpdateFlags()
-	if (not gbMobileMethodWrappersInitialised) then =

-		gbMobileMethodWrappersInitialised =3D true
+	if (not gbMobileMethodWrappersInitialized) then =

+		gbMobileMethodWrappersInitialized =3D true
 		for method_name,method_impl in pairs(gMobilePrototype) do
 			local mymethod_impl =3D method_impl
 			_G[&quot;Mobile_&quot;..method_name] =3D function (mobile_or_serial,...)
@@ -54,23 +59,29 @@
 	end
 	=

 	-- create base object and register in mobile-list
-	local newmobile =3D KNUTMERGETEMP_CREATE_EMPTY_OBJECT(serial)
-	gMobiles[serial] =3D newmobile
-	=

-	-- install methods and call constructor
-	ArrayOverwrite(newmobile,gMobilePrototype)
-	newmobile:Construct()
-	=

-	return newmobile
-end
-
-
--- constructor, don't call directly, use CreateOrUpdateMobile() instead
-function gMobilePrototype:Construct () =

-	self.equipment =3D {} -- TODO : rename to content to share code with cont=
ainer stuff ??
-	self.ismobile =3D true -- needed to identify the mobile in 2d renderer --=
 TODO : is this obsolete since knut ?
-	self.flag =3D 0
-	self:UpdateFlags()
+	local mobile =3D InitializeObject(serial)
+	gMobiles[serial] =3D mobile
+	=

+	-- install methods
+	ArrayOverwrite(mobile,gContainerPrototype)
+	ArrayOverwrite(mobile,gMobilePrototype)
+	=

+	mobile.content =3D {}
+	mobile.stats =3D {}
+	mobile.serial =3D 0		=

+	mobile.artid =3D 0		=

+	mobile.xloc =3D 0
+	mobile.yloc =3D 0
+	mobile.zloc =3D 0		=

+	mobile.dir =3D 0			=

+	mobile.hue =3D 0			=

+	mobile.flag =3D 0			=

+	mobile.notoriety =3D 0	=

+	mobile.amount =3D 0
+	mobile.ismobile =3D true -- needed to identify type in 2d renderer and fo=
r asserts
+	mobile:UpdateFlags()
+	=

+	return mobile
 end
 =

 =

@@ -78,16 +89,15 @@
 -- called from kPacket_Naked_MOB kPacket_Equipped_MOB kPacket_Teleport
 function CreateOrUpdateMobile (mobiledata,equipmentdata)
 	local mobile =3D GetMobile(mobiledata.serial)
-	if (not mobile) then mobile =3D KNUTMERGETEMP_CREATE_EMPTY_MOBILE(mobiled=
ata.serial) end
+	if (not mobile) then mobile =3D InitializeMobile(mobiledata.serial) end
 	mobile:Update(mobiledata,equipmentdata)
 	return mobile
 end
 =

 =

-function gMobilePrototype:GetEquipmentList () return self.equipment end
-
 function gMobilePrototype:NotifyListener	(eventname)
 	NotifyListener(eventname..self.serial,self)
+	NotifyListener(eventname,self)
 end
 =

 =

@@ -97,33 +107,29 @@
 =

 =

 =

+
+function gMobilePrototype:UpdateContent () self:Update() end
 =

 =

 -- updates mobile status, and the position of the graphical representation=
 and other things
 function gMobilePrototype:Update (mobiledata,equipmentdata)
-	if (mobiledata) then
-		for k,v in pairs(mobiledata) do self[k] =3D v end
-	end
+	if (self.bDestructionInProgress) then return end -- avoid updates during =
destruction
+	if (mobiledata) then for k,v in pairs(mobiledata) do self[k] =3D v end end
 	self:UpdateFlags()
 	=

-	=

-	-- create empty stats if there is not stats table
-	self.stats =3D self.stats or {} -- TODO : needs to be adjusted for knut m=
erge ?
-	=

 	-- request basic stats info
-	if (not self.state_request_sent) then  =

-			self.state_request_sent =3D true
+	if (not self.stat_request_sent) then  =

+			self.stat_request_sent =3D true
 		Send_ClientQuery(gRequest_States,self.serial)
 	end
 	=

-	-- TODO : needs to be adjusted for knut merge ?
 	-- update life stats in gui elements
 	if (self.stats.curHits and self.stats.maxHits) then
 		if (self.serial =3D=3D gPlayerBodySerial) then
 			-- for player
 			gui.SetHitpoints(self.stats.curHits/self.stats.maxHits)
-			if (self.stats.curMana) then gui.SetMana(self.stats.curMana/self.stats.=
maxMana) end
-			if (self.stats.curStamina) then gui.SetStamina(self.stats.curStamina/se=
lf.stats.maxStamina) end
+			if (self.stats.curMana)		then gui.SetMana(	self.stats.curMana		/self.st=
ats.maxMana		) end
+			if (self.stats.curStamina)	then gui.SetStamina(self.stats.curStamina	/s=
elf.stats.maxStamina	) end
 			-- update big_stats window
 			UpdateStatusAos()
 		else
@@ -132,34 +138,26 @@
 		end
 	end
 	=

-	-- TODO : needs to be adjusted for knut merge ?
+	-- full equipment overwrite
 	if (equipmentdata) then
-		self.equipment =3D {} -- todo : knut merge : KILL old equipment items ???
-
-		for layer,itemdata in pairs(equipmentdata) do
-			local item =3D KNUTMERGETEMP_CREATE_EMPTY_ITEM(itemdata.serial) -- dyna=
mic ? =

-			=

-			for k,v in pairs(itemdata) do item[k] =3D v end
-			-- item.serial
-			-- item.artid
-			-- item.layer
-			-- item.hue
-			=

-			item.mobile =3D self
-			item.mobile_serial =3D self.serial
-			self.equipment[item.layer] =3D item
-			gMobileItemsBySerial[item.serial] =3D item -- TODO : obsoleted by knut =
merge ??
+		self:DestroyContent() -- destroy old equipment items
+
+		for layer,dynamicdata in pairs(equipmentdata) do
+			CreateOrUpdateDynamic(dynamicdata,self)
 		end
 	end
 	=

 	-- if something related to equipment might have changed =

+	-- this can also have happened if equipmentdata=3Dnil, e.g. when an equip=
ment item was destroyed directly
+	-- maybe only in UpdateContent and/or if equipmentdata is set ?
 	if (true) then
-		if (self.serial =3D=3D gPlayerBodySerial and self.equipment) then Player=
EquipmentUpdated() end
+		if (self.serial =3D=3D gPlayerBodySerial) then PlayerEquipmentUpdated() =
end
 		local paperdoll =3D gPaperdolls[self.serial]
 		if (paperdoll) then RebuildPaperdoll(paperdoll) end
 		=

-		-- TODO : does check for changes, but still a little expensive, only cal=
l if neccessary
+		-- TODO : UpdateMobileModel does check for changes, but still a little e=
xpensive, only call if neccessary ?
 		if (gCurrentRenderer =3D=3D Renderer3D) then UpdateMobileModel(self) end =

+		if (gCurrentRenderer =3D=3D Renderer2D) then assert(false,&quot;FIXME?&quot;) gCur=
rentRenderer:UpdateMobileEquipment(self) end
 	end
 		=

 	self:NotifyListener(&quot;Mobile_Update&quot;)
@@ -194,7 +192,7 @@
 	self:NotifyListener(&quot;Mobile_UpdateStats&quot;)
 	-- not needed due to normal damage packet
 	-- TODO is this ok for every server?
-	-- gCurrentRenderer:NotifyHPChange(mobileserial, oldhp, mobile.stats.curH=
its)
+	-- gCurrentRenderer:NotifyHPChange(self.serial, oldhp, mobile.stats.curHi=
ts)
 	self:Update()
 end
 =

@@ -211,7 +209,7 @@
 		self.stats.curHits =3D curvalue
 		self.stats.maxHits =3D maxvalue
 =

-		self:NotifyListener(&quot;Mobile_UpdateHealth&quot;)
+		self:NotifyListener(&quot;Mobile_UpdateStats&quot;)
 		self:Update()
 	end
 end
@@ -229,7 +227,7 @@
 			UpdateStatusAos()
 		end
 =

-		self:NotifyListener(&quot;Mobile_UpdateMana&quot;)
+		self:NotifyListener(&quot;Mobile_UpdateStats&quot;)
 		self:Update()
 	end
 end
@@ -247,7 +245,7 @@
 			UpdateStatusAos()
 		end
 =

-		self:NotifyListener(&quot;Mobile_UpdateStamina&quot;)
+		self:NotifyListener(&quot;Mobile_UpdateStats&quot;)
 		self:Update()
 	end
 end
@@ -279,43 +277,29 @@
 =

 =

 function gMobilePrototype:Destroy ()
-	-- clean up equipment  -- TODO : has to be adjusted for knut merge
-	for k,item in pairs(self:GetEquipmentList()) do DestroyMobileItem(item) e=
nd
-	=

+	self.bDestructionInProgress =3D true
+	if (self.bIsDead) then print(&quot;warning, double free mobile&quot;) return end --=
 already destroyed before
 	self:NotifyListener(&quot;Mobile_Destroy&quot;)
-	=

-	gCurrentRenderer:RemoveMobile( self )
 	=

 	-- destroy Status Gump from NPC
 	CloseStatus(self)
 	=

-	gObjectList[self.serial] =3D nil =

+	self:DestroyContent() -- warning, triggers self:Update()
+	=

+	gCurrentRenderer:RemoveMobile( self )
+	=

 	gMobiles[self.serial] =3D nil
-	self.serial =3D nil
-end
-
--- note : modifying existing elements and removing from a lua table while =
iterating is save, only inserting is dangerous
-function DestroyMobileItemBySerial (serial) =

-	local item =3D gMobileItemsBySerial[serial]
-	if (item) then DestroyMobileItem(item) end
-end
-
-
--- TODO : has to be adjusted for knut merge
-function DestroyMobileItem (item) =

-	item.mobile.equipment[item.layer] =3D nil
-	gMobileItemsBySerial[item.serial] =3D nil
-	if (item.widget) then item.widget:Destroy()  item.widget =3D nil end -- p=
aperdoll widgets
-	item.mobile:Update() =

-end
-
-
+	CleanupObject(self)
+end
 =

 =

 =

 -- ##### ##### ##### ##### ##### the rest =

 =

 =

+function gMobilePrototype:GetEquipmentAtLayer(layer)
+	for k,dynamic in pairs(self:GetContent()) do if (dynamic.layer =3D=3D lay=
er) then return dynamic end end
+end
 =

 =

 =

@@ -335,23 +319,6 @@
 	gCurrentRenderer:MobileStartServerSideAnim(animdata)
 end
 =

-
--- called from kPacket_Open_Paperdoll
-function HandleOpenPaperdoll	(paperdoll)
-	paperdoll.mobileserial	=3D paperdoll.serial
-	paperdoll.Close =3D ClosePaperdoll
-	=

-	-- close old paperdoll
-	local oldpaperdoll =3D gPaperdolls[paperdoll.mobileserial]
-	if (oldpaperdoll) then oldpaperdoll:Close() end =

-	=

-	-- register paperdoll
-	gPaperdolls[paperdoll.mobileserial] =3D paperdoll
-	=

-	--AddFadeLines(&quot;Open Paperdoll for [&quot;..(paperdoll.mobileserial)..&quot;] &quot;..(p=
aperdoll.name or &quot;&quot;))
-	=

-	RebuildPaperdoll(paperdoll)
-end
 =

 =

 =

@@ -398,26 +365,3 @@
 	if (n =3D=3D  7) then return 1.0 , 0.0 , 1.0 end -- 7 =3D unknown use (tr=
anslucent (like 0x4000 hue)) =

 	return 0.5,0.5,0.5
 end
-
-
--- Fighting - Swing [0x2F] 10bytes
--- TODO : handle animation
--- TODO : is this packet actually used ?
-function gPacketHandler.kPacket_Swing()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local unknown1 =3D input:PopNetUint8()
-	local attacker_serial =3D input:PopNetUint32()
-	local defender_serial =3D input:PopNetUint32()
-	printf(&quot;NET: Swing Attack Animation, attacker=3D0x%08x defender=3D0x%08x\=
n&quot;,attacker_serial,defender_serial)
-end
-
--- TODO : what is the result of this packet?
---BYTE cmd =

---BYTE action (2=3Dghost, 1=3Dresurrect, 0=3Dfrom server)
-function gPacketHandler.kPacket_Death()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local action =3D input:PopNetUint8()
-	print(&quot;NET: Server sends, that player is now (2=3Dghost, 1=3Dresurrect, 0=
=3Dfrom server)=3D&quot;..action)
-end

Modified: trunk/data/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.player.lua (original)
+++ trunk/data/lua/obj/obj.player.lua Thu Aug 30 21:17:18 2007
@@ -23,7 +23,6 @@
 		if ((not gPlayerBackPack) or (gPlayerBackPack.serial ~=3D backpack.seria=
l)) then
 			-- backpack item changed
 			gPlayerBackPack =3D backpack
-			-- RegisterStepper(function ()  return true end) -- only performs one s=
tep
 		end
 	-- else TODO : maybe check if backpack was removed ? must look if playeri=
d is available so far
 	end
@@ -50,16 +49,14 @@
 end
 =

 function GetPlayerBackPackItem ()
-	local res =3D nil
 	local playermobile =3D GetPlayerMobile()
-	if (playermobile) then res =3D playermobile.equipment and playermobile.eq=
uipment[kLayer_Backpack] end
-	return res
+	if (playermobile) then return GetMobileEquipmentItem(playermobile,kLayer_=
Backpack) end
 end
 =

 -- only available some time after login, see PlayerEquipmentUpdated()
 function TogglePlayerBackpack ()
 	if (gPlayerBackPack) then
-		if (IsContainerOpen(gPlayerBackPack.serial)) then
+		if (IsContainerAlreadyOpen(gPlayerBackPack)) then
 			-- close backpack
 			CloseContainer(gPlayerBackPack.serial)
 		else
@@ -111,13 +108,13 @@
 	=

 	gCurrentRenderer:ClientSideMobileAnimPlayerTeleported()
 =

-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player (Pos before Teleport) XLoc: =
%i YLoc: %i ZLoc: %i Dir: [%s]\n&quot;,
-			gPlayerXLoc or 0, gPlayerYLoc or 0, gPlayerZLoc or 0, gDirection[gPlaye=
rDir or 0] or &quot;&quot;))
+--~ 	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player (Pos before Teleport) XL=
oc: %i YLoc: %i ZLoc: %i Dir: [%s]\n&quot;,
+--~ 			gPlayerXLoc or 0, gPlayerYLoc or 0, gPlayerZLoc or 0, gDirection[gP=
layerDir or 0] or &quot;&quot;))
 	=

 	-- TODO : (Check if char is in Boat!)
 =

-	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player: mobiledata.serial: %i body:=
 %i XLoc: %i YLoc: %i ZLoc: %i Dir: 0x%02x [%s]\n&quot;,
-			mobiledata.serial, mobiledata.artid, mobiledata.xloc, mobiledata.yloc, =
mobiledata.zloc, fullplayerdir, gDirection[mobiledata.dir] or &quot;&quot;))
+--~ 	printdebug(&quot;login&quot;,sprintf(&quot;NET: Draw_Player: mobiledata.serial: %i b=
ody: %i XLoc: %i YLoc: %i ZLoc: %i Dir: 0x%02x [%s]\n&quot;,
+--~ 			mobiledata.serial, mobiledata.artid, mobiledata.xloc, mobiledata.yl=
oc, mobiledata.zloc, fullplayerdir, gDirection[mobiledata.dir] or &quot;&quot;))
 =

 	-- Check if Player is already on Teleported Pos
 	if (gPlayerXLoc ~=3D mobiledata.xloc or gPlayerYLoc ~=3D mobiledata.yloc =
or


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000180.html">[Iris-commit] [IRIS] r1365 - in /trunk/data/lua: gui/gui.paperdoll.lua lib.3d.mobileanim.lua lib.3d.renderer.lua lib.input.lua lib.util.lua net.other.lua net.walk.lua net/net.mobile.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
</A></li>
	<LI>Next message: <A HREF="000182.html">[Iris-commit] [IRIS] r1367 - in /trunk/data/lua: lib.debugmenu.lua obj/obj.container.lua obj/obj.dynamic.lua obj/obj.main.lua obj/obj.player.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#181">[ date ]</a>
              <a href="thread.html#181">[ thread ]</a>
              <a href="subject.html#181">[ subject ]</a>
              <a href="author.html#181">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
