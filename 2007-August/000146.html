<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1330 - in /trunk/data/lua: ./ gui/ net/ obj/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1330%20-%20in%20/trunk/data/lua%3A%20./%20gui/%20net/%20obj/&In-Reply-To=%3C20070802151339.8A268B140B4%40localhost.localdomain%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000145.html">
   <LINK REL="Next"  HREF="000147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1330 - in /trunk/data/lua: ./ gui/ net/ obj/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1330%20-%20in%20/trunk/data/lua%3A%20./%20gui/%20net/%20obj/&In-Reply-To=%3C20070802151339.8A268B140B4%40localhost.localdomain%3E"
       TITLE="[Iris-commit] [IRIS] r1330 - in /trunk/data/lua: ./ gui/ net/ obj/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Thu Aug  2 17:13:37 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000145.html">[Iris-commit] [IRIS] r1329 - in /branches/knut/data/lua: ./ gui/	net/ obj/
</A></li>
        <LI>Next message: <A HREF="000147.html">[Iris-commit] [IRIS] r1331 - in /branches/knut/data/lua/net: net.effect.lua net.multi.lua net.packethandlers.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#146">[ date ]</a>
              <a href="thread.html#146">[ thread ]</a>
              <a href="subject.html#146">[ subject ]</a>
              <a href="author.html#146">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Thu Aug  2 17:13:37 2007
New Revision: 1330

Log:
syncing with branch..

Added:
    trunk/data/lua/gui/gui.gumpmanager.lua
    trunk/data/lua/gui/gui.journal.lua
    trunk/data/lua/gui/gui.quit.lua
    trunk/data/lua/gui/gui.widget.lua
    trunk/data/lua/lib.uodragdrop.lua
Modified:
    trunk/data/lua/gui/gui.container.lua
    trunk/data/lua/gui/gui.main.lua
    trunk/data/lua/gui/gui.paperdoll.lua
    trunk/data/lua/gui/gui.status.lua
    trunk/data/lua/lib.3d.combat.lua
    trunk/data/lua/lib.3d.map.lua
    trunk/data/lua/lib.3d.mobileanim.lua
    trunk/data/lua/lib.3d.mousepick.lua
    trunk/data/lua/lib.3d.renderer.lua
    trunk/data/lua/lib.devtool.lua
    trunk/data/lua/lib.fallback.lua
    trunk/data/lua/lib.models.lua
    trunk/data/lua/lib.mousepick.lua
    trunk/data/lua/lib.protocol.lua
    trunk/data/lua/lib.walking2.lua
    trunk/data/lua/main.lua
    trunk/data/lua/net.login.lua
    trunk/data/lua/net.other.lua
    trunk/data/lua/net.trade.lua
    trunk/data/lua/net.uodragdrop.lua
    trunk/data/lua/net.walk.lua
    trunk/data/lua/net/net.effect.lua
    trunk/data/lua/net/net.main.lua
    trunk/data/lua/net/net.mobile.lua
    trunk/data/lua/net/net.object.lua
    trunk/data/lua/obj/obj.dynamic.lua
    trunk/data/lua/obj/obj.main.lua
    trunk/data/lua/obj/obj.mobile.lua
    trunk/data/lua/obj/obj.player.lua

Modified: trunk/data/lua/gui/gui.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.container.lua (original)
+++ trunk/data/lua/gui/gui.container.lua Thu Aug  2 17:13:37 2007
@@ -37,50 +37,6 @@
 		container.dialog =3D nil
 	end
 	gContainer[serial] =3D nil
-end
-
--- TODO : Add sepearate FILTER : for several Clientside GFX manipulation (=
Game Pieces &amp; Gold,Silver,...)
-function ApplyArtidStackManipulation (item)
-	item.baseartid =3D item.artid
-	=

-	-- from varan
-	-- gold
-	if (item.baseartid =3D=3D hex2num(&quot;0xEED&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEEE&quot;) end
-	if (item.baseartid =3D=3D hex2num(&quot;0xEED&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEEF&quot;) end
-	-- gold
-	if (item.baseartid =3D=3D hex2num(&quot;0xEEA&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEEB&quot;) end
-	if (item.baseartid =3D=3D hex2num(&quot;0xEEA&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEEC&quot;) end
-	-- Silver
-	if (item.baseartid =3D=3D hex2num(&quot;0xEF0&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEF1&quot;) end
-	if (item.baseartid =3D=3D hex2num(&quot;0xEF0&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEF2&quot;) end
-	-- cannonball
-	if (item.baseartid =3D=3D hex2num(&quot;0xE73&quot;) and item.amount &gt;=3D 4) then i=
tem.artid =3D hex2num(&quot;0xE74&quot;) end
-
-	--TODO : if not in this list, and amount &gt; 0 : draw the graphic 2 times
-	--for example: if (item.baseartid =3D=3D hex2num(&quot;0xE73&quot;) and item.amount=
 &gt; 0) then item.artid =3D hex2num(&quot;0xE74&quot;) item.drawcount=3D2 end
-
-	-- ART -&gt; GUMP
-	-- white backgammon game piece
-	if (item.baseartid =3D=3D hex2num(&quot;0x3584&quot;)) then item.artid =3D hex2num(=
&quot;0x91B&quot;) item.usegump=3Dtrue end
-	-- brown backgammon game piece
-	if (item.baseartid =3D=3D hex2num(&quot;0x358b&quot;)) then item.artid =3D hex2num(=
&quot;0x922&quot;) item.usegump=3Dtrue end
-	-- brown chess pieces
-	if (item.baseartid =3D=3D hex2num(&quot;0x3590&quot;)) then item.artid =3D hex2num(=
&quot;0x927&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358d&quot;)) then item.artid =3D hex2num(=
&quot;0x924&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358f&quot;)) then item.artid =3D hex2num(=
&quot;0x926&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358c&quot;)) then item.artid =3D hex2num(=
&quot;0x923&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3591&quot;)) then item.artid =3D hex2num(=
&quot;0x928&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358e&quot;)) then item.artid =3D hex2num(=
&quot;0x925&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	-- white chess pieces
-	if (item.baseartid =3D=3D hex2num(&quot;0x3589&quot;)) then item.artid =3D hex2num(=
&quot;0x920&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3586&quot;)) then item.artid =3D hex2num(=
&quot;0x91D&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3588&quot;)) then item.artid =3D hex2num(=
&quot;0x91F&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3585&quot;)) then item.artid =3D hex2num(=
&quot;0x91C&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x358a&quot;)) then item.artid =3D hex2num(=
&quot;0x921&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-	if (item.baseartid =3D=3D hex2num(&quot;0x3587&quot;)) then item.artid =3D hex2num(=
&quot;0x91E&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
-
-	-- just for testing, remove me
-	--if (item.artid_addstack ~=3D 0) then print(&quot;unexpected item.artid_addst=
ack&quot;,item.artid_addstack) Crash() end
 end
 =

 -- creates if necessary

Modified: trunk/data/lua/gui/gui.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.main.lua (original)
+++ trunk/data/lua/gui/gui.main.lua Thu Aug  2 17:13:37 2007
@@ -1,7 +1,7 @@
---~ dofile(libpath .. &quot;gui/gui.widget.lua&quot;)
---~ dofile(libpath .. &quot;gui/gui.gumpmanager.lua&quot;)
+dofile(libpath .. &quot;gui/gui.widget.lua&quot;)
+dofile(libpath .. &quot;gui/gui.gumpmanager.lua&quot;)
 dofile(libpath .. &quot;gui/gui.container.lua&quot;)
 dofile(libpath .. &quot;gui/gui.paperdoll.lua&quot;)
---~ dofile(libpath .. &quot;gui/gui.journal.lua&quot;)
---~ dofile(libpath .. &quot;gui/gui.quit.lua&quot;)
+dofile(libpath .. &quot;gui/gui.journal.lua&quot;)
+dofile(libpath .. &quot;gui/gui.quit.lua&quot;)
 dofile(libpath .. &quot;gui/gui.status.lua&quot;)

Modified: trunk/data/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.paperdoll.lua (original)
+++ trunk/data/lua/gui/gui.paperdoll.lua Thu Aug  2 17:13:37 2007
@@ -300,17 +300,6 @@
 	out:SendPacket()
 end
 =

--- request serverside helppage
-function Send_RequestHelp()
-	print(&quot;NET: Send_RequestHelp&quot;)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Request_Assistance)
-	for i=3D1, 257 do
-		out:PushNetUint8(0)
-	end
-	out:SendPacket()
-end
-
 -- TODO : Clean
 function TogglePlayerPaperdoll ()
 	if (gPlayerBodySerial and gPaperdolls[gPlayerBodySerial]) then

Modified: trunk/data/lua/gui/gui.status.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.status.lua (original)
+++ trunk/data/lua/gui/gui.status.lua Thu Aug  2 17:13:37 2007
@@ -64,7 +64,7 @@
 					local s =3D m.stats
 					=

 					local l =3D {	char_str =3D &quot;status_str&quot;, char_dex =3D &quot;status_dex&quot;, c=
har_int =3D &quot;status_int&quot;,
-								currentHitpoints =3D &quot;status_hits&quot;, maxHitpoints =3D &quot;status_maxhi=
ts&quot;,
+								curHits =3D &quot;status_hits&quot;, maxHits =3D &quot;status_maxhits&quot;,
 								char_curMana =3D &quot;status_mana&quot;, char_maxMana =3D &quot;status_maxmana&quot;,
 								char_curSta =3D &quot;status_stamina&quot;, char_maxSta =3D &quot;status_maxstami=
na&quot;,
 								char_luck =3D &quot;status_luck&quot;, char_gold =3D &quot;status_gold&quot;,

Modified: trunk/data/lua/lib.3d.combat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.combat.lua (original)
+++ trunk/data/lua/lib.3d.combat.lua Thu Aug  2 17:13:37 2007
@@ -39,7 +39,7 @@
 =

 -- helper to plop hp adds and damage
 function Renderer3D:NotifyHPChange (serial, oldhp, newhp)
-	local mobile =3D gMobiles[serial]
+	local mobile =3D GetMobile(serial)
 	if mobile and oldhp and newhp then
 		local r,g,b =3D 0.0, 0.0, 0.0
 		-- hp change, d&lt;0 means damage, d&gt;0 hp gain

Modified: trunk/data/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.map.lua (original)
+++ trunk/data/lua/lib.3d.map.lua Thu Aug  2 17:13:37 2007
@@ -302,7 +302,7 @@
 		end
 		=

 		-- check dynamics for multis to detect house roofs and stuff like this
-		for k,dynamic in pairs(gDynamics) do
+		for k,dynamic in pairs(GetDynamicList()) do
 			if (dynamic.lMultiChildGfx) then
 				for k,child in pairs(dynamic.lMultiChildGfx) do
 					if (x =3D=3D dynamic.xloc+child.xloc and y =3D=3D dynamic.yloc+child.=
yloc and dynamic.zloc+child.zloc &gt; playerheadpos) then
@@ -349,9 +349,9 @@
 		end
 		=

 		-- update dynamics
-		for k,dynamic in pairs(gDynamics) do self:UpdateDynamicVisibility(dynami=
c) end
+		for k,dynamic in pairs(GetDynamicList()) do self:UpdateDynamicVisibility=
(dynamic) end
 		-- update mobiles
-		for k,mobile in pairs(gMobiles) do self:UpdateMobileVisibility(mobile) e=
nd
+		for k,mobile in pairs(GetMobileList()) do self:UpdateMobileVisibility(mo=
bile) end
 	end
 end
 =


Modified: trunk/data/lua/lib.3d.mobileanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.mobileanim.lua (original)
+++ trunk/data/lua/lib.3d.mobileanim.lua Thu Aug  2 17:13:37 2007
@@ -40,7 +40,7 @@
 =

 =

 function Renderer3D:MobileStartServerSideAnim (anim) =

-	local mobile =3D gMobiles[anim.mobileserial]	=

+	local mobile =3D GetMobile(anim.mobileserial)
 	if (not mobile) then return end
 	=

 	anim.repeatcount =3D (anim.m_repeatFlag =3D=3D 0) and 1 or (1 + anim.m_re=
peat) -- here -1 for infinite
@@ -60,8 +60,8 @@
 	local bodyid =3D MobileArtId2BodyId(mobile.artid)
 	=

 	-- detect animation modifiers : staff, mount=3Dhorse, combat
-	local mount		=3D mobile.equipment[kLayer_Mount]
-	local twohand	=3D mobile.equipment[kLayer_TwoHanded] -- staff
+	local mount		=3D GetMobileEquipmentItem(mobile,kLayer_Mount)
+	local twohand	=3D GetMobileEquipmentItem(mobile,kLayer_TwoHanded) -- staff
 	local bHasStaff =3D twohand and BitwiseAND(GetStaticTileTypeFlags(twohand=
.artid) or 0,kTileDataFlag_Weapon) ~=3D 0
 	local bWarMode 	=3D BitwiseAND(mobile.flag,kMobileFlag_WarMode) ~=3D 0 --=
 combat
 	local bRunning 	=3D mobile.walksmooth_moving and (BitwiseAND(mobile.dir,k=
WalkFlag_Run) ~=3D 0)

Modified: trunk/data/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.mousepick.lua (original)
+++ trunk/data/lua/lib.3d.mousepick.lua Thu Aug  2 17:13:37 2007
@@ -170,7 +170,7 @@
 	end end
 =

 	-- dynamics
-	for k,dynamic in pairs(gDynamics) do
+	for k,dynamic in pairs(GetDynamicList()) do
 		-- does this dynamic consists of many gfx parts (multi)?
 		if dynamic.lMultiChildGfx then
 			-- handle multi collision
@@ -210,7 +210,7 @@
 	=

 	-- mobiles
 	local bIgnorePlayer =3D self:IsFirstPersonCam()
-	for k,mobile in pairs(gMobiles) do if (mobile.gfx and self:IsZLayerVisibl=
e(mobile.zloc) and ((not bIgnorePlayer) or (not IsPlayerMobile(mobile)))) t=
hen
+	for k,mobile in pairs(GetMobileList()) do if (mobile.gfx and self:IsZLaye=
rVisible(mobile.zloc) and ((not bIgnorePlayer) or (not IsPlayerMobile(mobil=
e)))) then
 		if (true) then
 			-- small bbox mousepick as fallback in case model is not available/invi=
sible (horse)
 			bHit,fHitDist =3D mobile.gfx:RayPick(rx,ry,rz,rvx,rvy,rvz)

Modified: trunk/data/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.renderer.lua (original)
+++ trunk/data/lua/lib.3d.renderer.lua Thu Aug  2 17:13:37 2007
@@ -84,14 +84,14 @@
 	self:SetMapEnvironment()
 	=

 	self.gbCamRotChanged =3D true
-	for k,dynamic in pairs(gDynamics) do self:CreateDynamicGfx(dynamic) end
-	for k,mobile in pairs(gMobiles) do self:CreateMobileGfx(mobile) end
+	for k,dynamic in pairs(GetDynamicList()) do self:CreateDynamicGfx(dynamic=
) end
+	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
 end
 =

 function Renderer3D:DeInit()
 	--print(&quot;deactivating Renderer3D&quot;)
-	for k,dynamic in pairs(gDynamics) do self:DestroyDynamicGfx(dynamic) end
-	for k,mobile in pairs(gMobiles) do self:DestroyMobileGfx(mobile) end
+	for k,dynamic in pairs(GetDynamicList()) do self:DestroyDynamicGfx(dynami=
c) end
+	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
 	self:DeactivateMousePick()
 	self:ClearMapCache()
 	Client_SetFog()
@@ -294,10 +294,16 @@
 --###############################
 =

 =

+function Renderer3D:AddMobile () end
+
+
+function Renderer3D:UpdateMobileEquipment( mobile )
+end
+
 function Renderer3D:UpdateMobile( mobile )
 	if (not self.gbActive) then return end
 	=

-	if IsPlayerMobile(mobile) then
+	if (IsPlayerMobile(mobile)) then
 		-- set audio listener position if this is the playerbody
 		SoundSetListenerPosition(mobile.xloc,mobile.yloc,mobile.zloc * 0.1 + sel=
f.gZ_Factor)
 	end
@@ -325,13 +331,13 @@
 	end
 =

 	-- update mobile bar color
-	if (mobile and mobile.stats and mobile.stats.currentHitpoints and =

-		mobile.bar.lastn ~=3D mobile.stats.currentHitpoints) then
+	if (mobile and mobile.stats and mobile.stats.curHits and =

+		mobile.bar.lastn ~=3D mobile.stats.curHits) then
 =

 		-- store current as last value
-		mobile.bar.lastn =3D mobile.stats.currentHitpoints
-		=

-		local p =3D mobile.stats.currentHitpoints / mobile.stats.maxHitpoints
+		mobile.bar.lastn =3D mobile.stats.curHits
+		=

+		local p =3D mobile.stats.curHits / mobile.stats.maxHits
 		-- print(&quot;#### health&quot;,p)
 		=

 		-- bar color
@@ -477,6 +483,7 @@
 				mobile.nametext.lastn =3D nil
 				mobile.nametext.lastname =3D nil
 			end
+			mobile.name =3D mobile.stats and mobile.stats.name
 			if (mobile.nametext.lastn ~=3D mobile.notoriety or mobile.nametext.last=
name ~=3D mobile.name) then
 				mobile.nametext.lastn =3D mobile.notoriety
 				mobile.nametext.lastname =3D mobile.name
@@ -496,7 +503,7 @@
 function Renderer3D:UpdateMobilePos (mobile,x,y,z,qw,qx,qy,qz)
 	-- set position and orientation
 	if (mobile.modelgfx) then
-		local mount =3D mobile.equipment[kLayer_Mount]
+		local mount =3D GetMobileEquipmentItem(mobile,kLayer_Mount)
 		mobile.modelgfx:SetPosition(x-0.5, y+0.5, z + (mount and -kMountZAdd or =
0))
 		mobile.modelgfx:SetOrientation(qw,qx,qy,qz)
 	end
@@ -518,7 +525,9 @@
 	-- chat text over player head
 	if mobile.mlastChatText and mobile.mlastChatTime and mobile.mlastChatColo=
r then
 		-- chat text graphic present?
-		local r,g,b =3D mobile.mlastChatColor.r,mobile.mlastChatColor.g,mobile.m=
lastChatColor.b
+		local r,g,b =3D	mobile.mlastChatColor.r,
+						mobile.mlastChatColor.g,
+						mobile.mlastChatColor.b
 		local a =3D 1
 		=

 		if not mobile.chattext then
@@ -597,7 +606,7 @@
 	local iTimeSinceLastStepInSeconds =3D self.giLastAnimStepTime and ((gMyTi=
cks - self.giLastAnimStepTime) / 1000) or 0
 	self.giLastAnimStepTime =3D gMyTicks
 	=

-	for k,mobile in pairs(gMobiles) do Renderer3D:StepMobile(mobile,iTimeSinc=
eLastStepInSeconds) end
+	for k,mobile in pairs(GetMobileList()) do Renderer3D:StepMobile(mobile,iT=
imeSinceLastStepInSeconds) end
 end
 =

 -- obsolete but might be interesting
@@ -656,11 +665,11 @@
 		self.giLastMapOriginX =3D self.giMapOriginX
 		self.giLastMapOriginY =3D self.giMapOriginY
 		=

-		for k,mobile in pairs(gMobiles) do =

+		for k,mobile in pairs(GetMobileList()) do =

 			UpdateMobile(mobile) =

 		end
-		for k,dynamic in pairs(gDynamics) do if (dynamic.gfx) then
-			Renderer3D:UpdateDynamicItemPos(dynamic)
+		for k,dynamic in pairs(GetDynamicList()) do if (dynamic.gfx) then
+			self:UpdateDynamicItemPos(dynamic)
 		end end
 	end
 end
@@ -912,7 +921,7 @@
 -- removes the current mobile selection
 function Renderer3D:DeselectMobile ()
 	if (giSelectedMobile ~=3D 0) then
-		local mobile =3D gMobiles[giSelectedMobile]
+		local mobile =3D GetMobile(giSelectedMobile)
 		if (mobile) then
 			mobile.isselected =3D false
 			mobile.selection:SetVisible(false)
@@ -926,7 +935,7 @@
 	-- print (&quot;selectmobile&quot;,iSerial)
 	self:DeselectMobile()
 	if (iSerial ~=3D 0) then
-		local mobile =3D gMobiles[iSerial]
+		local mobile =3D GetMobile(iSerial)
 		if (mobile) then
 			mobile.isselected =3D true
 			-- TODO is it possible that selection is not created (UpdateMobile crea=
tes selection)

Modified: trunk/data/lua/lib.devtool.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.devtool.lua (original)
+++ trunk/data/lua/lib.devtool.lua Thu Aug  2 17:13:37 2007
@@ -260,7 +260,7 @@
 =

 function ListDynamicsNearPos (x,y,z,radius)
 	local res =3D {}
-	for k,item in pairs(gDynamics) do =

+	for k,item in pairs(GetDynamicList()) do =

 		local d =3D dist2(x,y,item.xloc,item.yloc)
 		if (d &lt;=3D radius) then table.insert(res,item) end =

 	end

Modified: trunk/data/lua/lib.fallback.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.fallback.lua (original)
+++ trunk/data/lua/lib.fallback.lua Thu Aug  2 17:13:37 2007
@@ -25,9 +25,14 @@
 	f:write(sprintf(&quot;RegisterSkippedArtBillboardFallBack(%d) -- 0x%04x name=
=3D%s\n&quot;,i,i,GetStaticTileTypeName(i) or &quot;unknown&quot;))
 	f:close()
 	-- hide existing dynamics
-	for k,item in pairs(gDynamics) do if (item.iTileTypeID =3D=3D i) then
-		if (item.gfx and item.gfx.billboard) then item.gfx.billboard:Destroy() i=
tem.gfx.billboard =3D nil end
-	end end
+
+	for k,item in pairs(GetDynamicList()) do
+		if (item.iTileTypeID =3D=3D i and item.gfx and item.gfx.billboard) then =

+			item.gfx.billboard:Destroy() =

+			item.gfx.billboard =3D nil =

+		end
+	end
+
 	-- hide existing statics (requires map rebuild)
 	gCurrentRenderer:ClearMapCache()
 end
@@ -129,7 +134,7 @@
 =

 function List3DDynamicsNearPos (x,y,z,radius)
 	local res =3D {}
-	for k,item in pairs(gDynamics) do =

+	for k,item in pairs(GetDynamicList()) do =

 		local d =3D dist2(x,y,item.xloc,item.yloc)
 		if (d &lt;=3D radius) then table.insert(res,item) end =

 	end

Modified: trunk/data/lua/lib.models.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.models.lua (original)
+++ trunk/data/lua/lib.models.lua Thu Aug  2 17:13:37 2007
@@ -326,10 +326,10 @@
 	end
 	=

 	-- equipment, ORDER IS IMPORTANT FOR STITCHIN !!! (gLayerOrder?)
-	if (mobile.equipment) then =

+	if (GetMobileEquipmentList(mobile)) then =

 		-- TODO : i assume the paperdoll layerorder is the same as the granny la=
yeroder, check if this is correct
 		for index,layer in pairs(gLayerOrder) do
-			local item =3D mobile.equipment[layer]
+			local item =3D GetMobileEquipmentItem(mobile,layer)
 			if (item and layer ~=3D kLayer_Mount) then  -- ignore mounts here, hand=
led seperately
 				local tiledata =3D GetStaticTileType(item.artid or 0)
 				--print(&quot;equip&quot;,item.artid,tiledata and tiledata.miAnimID or 0)
@@ -490,7 +490,7 @@
 	if (mobile.artid =3D=3D 0) then return end
 	if (not mobile.equipment) then return end -- happens when being teleported
 	=

-	local mount =3D mobile.equipment[kLayer_Mount]
+	local mount =3D GetMobileEquipmentItem(mobile,kLayer_Mount)
 	local modelidarr,iPrimaryHandItem,iSecondaryHandItem =3D GetMobileModelPa=
rtModelIDs(mobile)
 	local bModelPartsChanged =3D false
 	if (not mobile.modelgfx) then bModelPartsChanged =3D true end

Modified: trunk/data/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.mousepick.lua (original)
+++ trunk/data/lua/lib.mousepick.lua Thu Aug  2 17:13:37 2007
@@ -1,145 +1,146 @@
-kMousePickHitType_Static =3D 0
-kMousePickHitType_Terrain =3D 1
-kMousePickHitType_Dynamic =3D 2
-kMousePickHitType_Mobile =3D 3
-kMousePickHitType_ContainerItem =3D 4
-kMousePickHitType_PaperdollItem =3D 5
-
-gMousePickFoundHit =3D false
-
-giSelectedMobile =3D 0
+kMousePickHitType_Static =3D 0
+kMousePickHitType_Terrain =3D 1
+kMousePickHitType_Dynamic =3D 2
+kMousePickHitType_Mobile =3D 3
+kMousePickHitType_ContainerItem =3D 4
+kMousePickHitType_PaperdollItem =3D 5
 =

--- OBSOLETED CODE ! don't use this, hasn't been adjusted to xmirror fix&gt;f =
TerrainRayIntersect_Hit .lua
-function TerrainRayIntersect_Hit(tx,ty,tiletype,hit_dist,minz,maxz)
-	gCurrentRenderer:TerrainRayIntersect_Hit (tx,ty,tiletype,hit_dist,minz,ma=
xz)
+gMousePickFoundHit =3D false
+
+giSelectedMobile =3D 0
+
+-- OBSOLETED CODE ! don't use this, hasn't been adjusted to xmirror fix&gt;f =
TerrainRayIntersect_Hit .lua
+function TerrainRayIntersect_Hit(tx,ty,tiletype,hit_dist,minz,maxz)
+	gCurrentRenderer:TerrainRayIntersect_Hit (tx,ty,tiletype,hit_dist,minz,ma=
xz)
 end
 =

 function IrisRightDoubleClick ()
-	-- TODO implement pathfinding and use it here
+	-- TODO implement pathfinding and use it here
 	-- SetAutoWalkTarget()
-end
-
-function IrisDoubleClick ()
-	local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
-
-	if gbControlDown then
-		-- open status window if control pressed and mobile targeted
-		if (iSerial and iSerial ~=3D 0) then =

-			local mobile =3D gMobiles[iSerial]
-			local iMouseX,iMouseY =3D PollInput()
-			-- -50,-30 to place the dialog beneath the mouse
-			OpenStatus(mobile,iMouseX - 50,iMouseY - 30)
-		end
-	else
-		-- normal doubleclick handling
-		pm =3D GetPlayerMobile()
-		if (gActWarmode =3D=3D gWarmode_Normal or (pm and iSerial =3D=3D pm.seri=
al) ) then
-			if (iSerial and iSerial ~=3D 0) then
-				printf(&quot;IrisDoubleClick: serial=3D0x%08x\n&quot;,iSerial)
-				Send_DoubleClick(iSerial)
-			end
-		end
-		if (gActWarmode =3D=3D gWarmode_Combat) then
-			if (iSerial and iSerial ~=3D 0) then
-				printf(&quot;IrisDoubleClickAttack: serial=3D0x%08x\n&quot;,iSerial)
-				Send_AttackReq(iSerial)
-			end
-		end
-	end
-end
-
--- currently sent on mousedown
--- TODO : maybe only send on mouseup if no dragdrop took place ?
-function IrisSingleClick ()
-	if (IsTargetModeActive()) then =

-		CompleteTargetMode() -- see net.cursor.lua
-	else
-		local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
-		if (iSerial and iSerial ~=3D 0) then =

-			printf(&quot;IrisSingleClick: serial=3D0x%08x\n&quot;,iSerial)
-			Send_SingleClick(iSerial)
-			gCurrentRenderer:SelectMobile(iSerial)
-		else
-			-- TODO is this too removey?
-			-- gCurrentRenderer:DeselectMobile()
-		end
-	end
-end
-
-function IrisRightClick ()
-	local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
-	if (iSerial and iSerial ~=3D 0) then =

-		printf(&quot;IrisRightClick: serial=3D0x%08x\n&quot;,iSerial)
-		Send_PopupRequest(iSerial) =

-	end
-end
-
--- find mobile with the minimum distance to player (x,y 2d based)
-function SelectNearestMobile ()
-	gCurrentRenderer:DeselectMobile()
-	=

-	local mindist =3D -1
-	local minserial =3D 0
-	local playermobile =3D gMobiles[gPlayerBodySerial]
-	if (playermobile) then
-		for k,mobile in pairs(gMobiles) do =

-			if (k ~=3D gPlayerBodySerial) then
-				-- calculate distance to player
-				local dx =3D (mobile.xloc - playermobile.xloc)
-				local dy =3D (mobile.yloc - playermobile.yloc)
-				local d =3D math.sqrt(dx*dx + dy*dy)
-				if (mindist &lt; 0 or d &lt; mindist) then
-					-- new min found
-					minserial =3D k
-					mindist =3D d
-				end
-			end
-		end
-	end
-	-- select the nearest if found
-	if (minserial ~=3D 0) then
-		gCurrentRenderer:SelectMobile(minserial)
-	end
-end
-
--- selects the next mobile cycling through all mobiles
-function SelectNextMobile ()
-	local current =3D giSelectedMobile
-	local minserial =3D -1
-	local nextminserial =3D -1
-	-- print (&quot;current&quot;, current)
-	for k,mobile in pairs(gMobiles) do
-		if (current &lt; k and (k &lt; nextminserial or nextminserial &lt; 0)) then
-			-- small serial (bigger than current found)
-			nextminserial =3D k
-			-- print (&quot;nextminserial&quot;,nextminserial)
-		end
-		if (minserial &lt; 0 or k &lt; minserial) then
-			-- searches for the absolute min serial, cycle start
-			minserial =3D k
-			-- print (&quot;minserial&quot;,minserial)
-		end
-	end
-	=

-	-- select the next if found
-	if (nextminserial &gt; 0) then
-		gCurrentRenderer:SelectMobile(nextminserial)
-	else
-		-- or the start if no next found
-		if (minserial &gt; 0) then
-			gCurrentRenderer:SelectMobile(minserial)
-		end
-	end
-end
-
--- attack the current selected mobile or just go to it (depends in warmode=
 on/off)
-function AttackSelectedMobile ()
-	if (giSelectedMobile ~=3D 0) then
-		-- who shall i kill, master?
-		local target =3D gMobiles[giSelectedMobile]
-		if target then
-			-- run to the target
-			SetFollowMobile(giSelectedMobile)
-		end
-	end
-end
+end
+
+function IrisDoubleClick ()
+	gCurrentRenderer:MousePick()
+	local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
+	if gbControlDown then
+		-- open status window if control pressed and mobile targeted
+		if (iSerial and iSerial ~=3D 0) then =

+			local mobile =3D GetMobile(iSerial)
+			local iMouseX,iMouseY =3D PollInput()
+			-- -50,-30 to place the dialog beneath the mouse
+			OpenStatus(mobile,iMouseX - 50,iMouseY - 30)
+		end
+	else
+		-- normal doubleclick handling
+		pm =3D GetPlayerMobile()
+		if (gActWarmode =3D=3D gWarmode_Normal or (pm and iSerial =3D=3D pm.seri=
al) ) then
+			if (iSerial and iSerial ~=3D 0) then
+				printdebug(&quot;UO&quot;,&quot;IrisDoubleClick: serial=3D0x%08x\n&quot;,iSerial)
+				Send_DoubleClick(iSerial)
+			end
+		end
+		if (gActWarmode =3D=3D gWarmode_Combat) then
+			if (iSerial and iSerial ~=3D 0) then
+				printdebug(&quot;UO&quot;,&quot;IrisDoubleClickAttack: serial=3D0x%08x\n&quot;,iSerial)
+				Send_AttackReq(iSerial)
+			end
+		end
+	end
+end
+
+-- currently sent on mousedown
+-- TODO : maybe only send on mouseup if no dragdrop took place ?
+function IrisSingleClick ()
+	if (IsTargetModeActive()) then =

+		CompleteTargetMode() -- see net.cursor.lua
+	else
+		local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
+		if (iSerial and iSerial ~=3D 0) then =

+			printdebug(&quot;UO&quot;,&quot;IrisSingleClick: serial=3D0x%08x\n&quot;,iSerial)
+			Send_SingleClick(iSerial)
+			gCurrentRenderer:SelectMobile(iSerial)
+		else
+			-- TODO is this too removey?
+			-- gCurrentRenderer:DeselectMobile()
+		end
+	end
+end
+
+function IrisRightClick ()
+	local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
+	if (iSerial and iSerial ~=3D 0) then =

+		printdebug(&quot;UO&quot;,&quot;IrisRightClick: serial=3D0x%08x\n&quot;,iSerial)
+		Send_PopupRequest(iSerial) =

+	end
+end
+
+-- find mobile with the minimum distance to player (x,y 2d based)
+function SelectNearestMobile ()
+	gCurrentRenderer:DeselectMobile()
+	=

+	local mindist =3D -1
+	local minserial =3D 0
+	local playermobile =3D GetMobile(gPlayerBodySerial)
+	if (playermobile) then
+		for k,mobile in pairs(GetMobileList()) do =

+			if (k ~=3D gPlayerBodySerial) then
+				-- calculate distance to player
+				local dx =3D (mobile.xloc - playermobile.xloc)
+				local dy =3D (mobile.yloc - playermobile.yloc)
+				local d =3D math.sqrt(dx*dx + dy*dy)
+				if (mindist &lt; 0 or d &lt; mindist) then
+					-- new min found
+					minserial =3D k
+					mindist =3D d
+				end
+			end
+		end
+	end
+	-- select the nearest if found
+	if (minserial ~=3D 0) then
+		gCurrentRenderer:SelectMobile(minserial)
+	end
+end
+
+-- selects the next mobile cycling through all mobiles
+function SelectNextMobile ()
+	local current =3D giSelectedMobile
+	local minserial =3D -1
+	local nextminserial =3D -1
+	-- print (&quot;current&quot;, current)
+
+	for k,mobile in pairs(GetMobileList()) do
+		if (current &lt; k and (k &lt; nextminserial or nextminserial &lt; 0)) then
+			-- small serial (bigger than current found)
+			nextminserial =3D k
+			-- print (&quot;nextminserial&quot;,nextminserial)
+		end
+		if (minserial &lt; 0 or k &lt; minserial) then
+			-- searches for the absolute min serial, cycle start
+			minserial =3D k
+			-- print (&quot;minserial&quot;,minserial)
+		end
+	end
+	=

+	-- select the next if found
+	if (nextminserial &gt; 0) then
+		gCurrentRenderer:SelectMobile(nextminserial)
+	else
+		-- or the start if no next found
+		if (minserial &gt; 0) then
+			gCurrentRenderer:SelectMobile(minserial)
+		end
+	end
+end
+
+-- attack the current selected mobile or just go to it (depends in warmode=
 on/off)
+function AttackSelectedMobile ()
+	if (giSelectedMobile ~=3D 0) then
+		-- who shall i kill, master?
+		local target =3D GetMobile(giSelectedMobile)
+		if target then
+			-- run to the target
+			SetFollowMobile(giSelectedMobile)
+		end
+	end
+end

Modified: trunk/data/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.protocol.lua (original)
+++ trunk/data/lua/lib.protocol.lua Thu Aug  2 17:13:37 2007
@@ -148,3 +148,26 @@
 	file:write(info)
 	file:close()
 end
+
+-- Send Packets -----------------------------------------------------------
+
+-- request serverside helppage
+function Send_RequestHelp()
+	print(&quot;NET: Send_RequestHelp&quot;)
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Request_Assistance)
+	for i=3D1, 257 do
+		out:PushNetUint8(0)
+	end
+	out:SendPacket()
+end
+
+-- request profile
+function Send_RequestProfile( serial )
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Character_Profile)
+	out:PushNetUint16(8)
+	out:PushNetUint8(0)
+	out:PushNetUint32(serial)
+	out:SendPacket()
+end

Modified: trunk/data/lua/lib.walking2.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.walking2.lua (original)
+++ trunk/data/lua/lib.walking2.lua Thu Aug  2 17:13:37 2007
@@ -161,11 +161,11 @@
 	=

 	local xloc=3Dbx*8+tx
 	local yloc=3Dby*8+ty
-	for k,dynamic in pairs(gDynamics) do
+	for k,dynamic in pairs(GetDynamicList()) do
 		if(dynamic.artid) then
 =

 			-- is this a normal statictile or multi?
-			if dynamic.artid &gt;=3D gMulti_ID then
+			if (dynamic.artid &gt;=3D gMulti_ID) then -- gMulti_ID + 100
 				if (dynamic.lTile) then
 					for k,v in pairs(dynamic.lTile) do
 						if ((dynamic.xloc+v.x) =3D=3D xloc and (dynamic.yloc+v.y) =3D=3D ylo=
c) then
@@ -203,7 +203,6 @@
 					GetWalkingBlockFlagsHelper(dynamic.zloc,dynamic.artid,flaglist)
 				end
 			end
-
 		end
 	end
 	=


Modified: trunk/data/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/main.lua (original)
+++ trunk/data/lua/main.lua Thu Aug  2 17:13:37 2007
@@ -16,6 +16,7 @@
 =

 -- utils first
 dofile(libpath .. &quot;lib.util.lua&quot;)
+dofile(libpath .. &quot;lib.listener.lua&quot;)
 =

 -- renderer second
 gRendererList =3D {}
@@ -78,6 +79,8 @@
 dofile(libpath .. &quot;lib.devtool.lua&quot;)
 dofile(libpath .. &quot;lib.3d.mobileanim.lua&quot;)
 dofile(libpath .. &quot;lib.mount.lua&quot;)
+dofile(libpath .. &quot;lib.debug.lua&quot;)
+dofile(libpath .. &quot;lib.uodragdrop.lua&quot;)
 dofile(libpath .. &quot;gui/gui.main.lua&quot;)
 dofile(libpath .. &quot;obj/obj.main.lua&quot;)
 dofile(libpath .. &quot;net/net.main.lua&quot;)
@@ -208,6 +211,9 @@
 =

 	if (gStartInDebugMode) then StopMainMenu() StartDebugMenu() end
 =

+	--TestGuiSystem2_Init()
+	--TestGuiSystem3_Init()
+	=

 	-- mainloop
 	while (Client_IsAlive()) do
 		MainStep(Client_GetTicks())
@@ -241,6 +247,7 @@
 	gMyTicks =3D curticks
 	UpdateStats(curticks)
 	StepTimer(curticks)
+	--TestGuiSystem2_Step()
 =

 	NetStep()
 =

@@ -259,6 +266,9 @@
 =

 	StepDebugMenu()
 	gui.Step()
+
+	NotifyListener( &quot;EveryFrame&quot; )
+	=

 	Client_RenderOneFrame()
 	SoundStep()
 	Client_USleep(1) -- just 1 millisecond, but gives other processes a chanc=
e to do something

Modified: trunk/data/lua/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.login.lua (original)
+++ trunk/data/lua/net.login.lua Thu Aug  2 17:13:37 2007
@@ -274,13 +274,13 @@
 =

 -- send login server request 0x80
 -- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
-function ProtocolSend_Account_Login_Request	(sName,sPassword)
+function ProtocolSend_Account_Login_Request	(sName,sPassword,iSeed)
 	printdebug(&quot;login&quot;,sprintf(&quot;NET: Account_Login_Request: Name: %s Password=
:<i> %s\n&quot;,sName,sPassword))
</I> 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Account_Login_Request)
 	out:PushFilledString(sName,30)
 	out:PushFilledString(sPassword,30)
-	out:PushNetUint8(hex2num(&quot;0x5D&quot;))
+	out:PushNetUint8(iSeed or hex2num(&quot;0x5D&quot;))
 	out:SendPacket()
 end
 =


Modified: trunk/data/lua/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.other.lua (original)
+++ trunk/data/lua/net.other.lua Thu Aug  2 17:13:37 2007
@@ -371,7 +371,7 @@
 -- prevents the answer to the tooltipp request from being displayed as nor=
mal message
 -- returns true if the info was caught and should not be displayed
 function CatchTooltippRequest (serial,model,charname,message) =

-	local mobile =3D gMobiles[serial]
+	local mobile =3D GetMobile(serial)
 	=

 	if (mobile) then
 		if (charname =3D=3D message) then
@@ -383,7 +383,7 @@
 		end
 		if (not mobile.name) then =

 			mobile.name =3D charname
-			UpdateMobile(mobile)
+			UpdateMobile(mobile) -- TODO : set mobile name
 			if (charname ~=3D message) then print(&quot;CatchTooltippRequest : unexpecte=
d text:&quot;,charname,message) return false end
 			return true
 		end

Modified: trunk/data/lua/net.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.trade.lua (original)
+++ trunk/data/lua/net.trade.lua Thu Aug  2 17:13:37 2007
@@ -71,10 +71,10 @@
 		if (not playerMobile)				then print(&quot;FATAL : kPacket_Shop_Sell : playerM=
obile not found&quot;) Crash() end
 	=

 		if (true) then -- debug
-			for k,item in pairs(playerBackpackContainer.items) do =

+			for k,item in pairs(GetContainerContentList(playerBackpackContainer)) d=
o =

 				printf(&quot;item serial=3D0x%08x artid=3D0x%04x in backpack\n&quot;,item.serial=
,item.artid)
 			end
-			for k,item in pairs(playerMobile.equipment) do =

+			for k,item in pairs(GetMobileEquipmentList(playerMobile)) do =

 				printf(&quot;item serial=3D0x%08x artid=3D0x%04x equipped\n&quot;,item.serial,it=
em.artid)
 			end
 		end
@@ -91,8 +91,9 @@
 			good.name 		=3D input:PopFilledString(good.namelen)
 			good.tradeamount=3D 0
 			good.index 		=3D i
-			good.item		=3D playerBackpackContainer.items[good.itemserial] or gMobil=
eItemsBySerial[good.itemserial]
-			=

+			good.item		=3D GetObjectBySerial(good.itemserial)
+			--- old : see also playerBackpackContainer.items[good.itemserial]			=

+
 			if (good.item) then -- item is not always available, especially if its =
in the backpack, and that has not been opened yet
 				if (good.itemartid ~=3D good.item.artid)	then printf(&quot;FATAL : kPacket_=
Shop_Sell : artid mismatch 0x%04x !=3D 0x%04x\n&quot;,good.itemartid,good.item.a=
rtid) Crash()  end
 				if (good.itemamount ~=3D good.item.amount)	then printf(&quot;FATAL : kPacke=
t_Shop_Sell : amount mismatch 0x%04x !=3D 0x%04x\n&quot;,good.itemamount,good.it=
em.amount) Crash()  end
@@ -397,7 +398,7 @@
 =

 function GetShopMobileID (shop)
 	if (shop.shopMobileID) then return shop.shopMobileID end -- only set for =
sell-shop
-	local shopContainerItem =3D gMobileItemsBySerial[shop.shopContainerID]
+	local shopContainerItem =3D GetObjectBySerial(shop.shopContainerID)
 	if (not shopContainerItem) then printf(&quot;FATAL : GetShopMobileID : shopCon=
tainerItem not found %08x\n&quot;,shop.shopContainerID) return end
 	local shopmobile =3D shopContainerItem.mobile
 	if (not shopmobile) then printf(&quot;FATAL : GetShopMobileID : shopmobile not=
 found for container %08x\n&quot;,shop.shopContainerID) return end

Modified: trunk/data/lua/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.uodragdrop.lua (original)
+++ trunk/data/lua/net.uodragdrop.lua Thu Aug  2 17:13:37 2007
@@ -260,7 +260,7 @@
 		local iTileTypeID =3D item.artid -- can come from paperdoll or container=
 or dynamic
 		local layer =3D GetPaperdollLayerFromTileType(iTileTypeID)
 		local mobileserial =3D paperdoll.mobileserial
-		local mobile =3D gMobiles[mobileserial]
+		local mobile =3D GetMobile(mobileserial)
 		print(&quot;MouseUpUODragDrop: drop on paperdoll &quot;,item.serial,item.amount,iT=
ileTypeID,layer,paperdoll.mobileserial)
 		if (not layer) then
 			print(&quot;CompleteUODragDrop : item is not wearable&quot;,vardump(item))
@@ -268,7 +268,7 @@
 		elseif (not mobile) then
 			print(&quot;CompleteUODragDrop : paperdoll mobile not found&quot;,vardump(item))
 			CancelUODragDrop()
-		elseif (mobile.equipment[layer]) then
+		elseif (GetMobileEquipmentItem(mobile,layer)) then
 			print(&quot;CompleteUODragDrop : layer already full&quot;,vardump(item))
 			-- TODO : if layer is not empty, drop dragged item to backpack, take it=
em from layer to backpack, equip dragged item
 			-- NOTE : if layer is not empty and it's not possible to put item to ba=
ckpack -&gt; check and solve this problem!

Modified: trunk/data/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.walk.lua (original)
+++ trunk/data/lua/net.walk.lua Thu Aug  2 17:13:37 2007
@@ -125,7 +125,7 @@
 gNextAutoWalkCheck =3D 0
 -- timeout to next autowalk check on pressed right button
 gNextAutoWalkCheckTimeout =3D 500
--- if this is &gt; 0 and the mobile (given as serial) is existing in gMobiles=
, autowalk tries to follow the mobile
+-- if this is &gt; 0 and the mobile (given as serial) is existing, autowalk t=
ries to follow the mobile
 gFollowMobile =3D 0
 function WalkStep ()
 	-- runnung if shift is pressed
@@ -141,7 +141,7 @@
 	=

 	-- follow target
 	if (gFollowMobile ~=3D 0) then
-		local target =3D gMobiles[gFollowMobile]
+		local target =3D GetMobile(gFollowMobile)
 		if target then
 			SetAutoWalkTo(target.xloc, target.yloc,true)
 		else
@@ -233,7 +233,7 @@
 =

 -- will follow a given mobile
 function SetFollowMobile (serial)
-	local target =3D gMobiles[serial]
+	local target =3D GetMobile(serial)
 	if target then
 		gFollowMobile =3D serial
 		SetAutoWalkTo(target.xloc, target.yloc , true)

Modified: trunk/data/lua/net/net.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.effect.lua (original)
+++ trunk/data/lua/net/net.effect.lua Thu Aug  2 17:13:37 2007
@@ -31,7 +31,7 @@
 	effect.rendermode =3D input:PopNetUint32()
 	effect.iseffect =3D true
 	=

-	printf(&quot;NET: Hued_FX: artid=3D0x%04x locx=3D%i locy=3D%i locz=3D%i target=
x=3D%i targety=3D%i targetz=3D%i effect_type=3D%s\n&quot;,
+	printdebug(&quot;NET&quot;, &quot;Hued_FX: artid=3D0x%04x locx=3D%i locy=3D%i locz=3D%i =
targetx=3D%i targety=3D%i targetz=3D%i effect_type=3D%s\n&quot;,
 			effect.itemid, effect.source_locx, effect.source_locy, effect.source_lo=
cz,
 			effect.target_locx, effect.target_locy, effect.target_locz, gEffectType=
s[effect.effect_type] or &quot;&quot;)
 	=


Modified: trunk/data/lua/net/net.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.main.lua (original)
+++ trunk/data/lua/net/net.main.lua Thu Aug  2 17:13:37 2007
@@ -1,9 +1,12 @@
-dofile(libpath .. &quot;net/net.mobile.lua&quot;)
-dofile(libpath .. &quot;net/net.dynamic.lua&quot;)
-dofile(libpath .. &quot;net/net.object.lua&quot;)
-dofile(libpath .. &quot;net/net.effect.lua&quot;)
-dofile(libpath .. &quot;net/net.multi.lua&quot;)
-dofile(libpath .. &quot;net/net.uodragdrop.lua&quot;)
+dofile(libpath .. &quot;net/net.mobile.lua&quot;)
+dofile(libpath .. &quot;net/net.dynamic.lua&quot;)
+dofile(libpath .. &quot;net/net.object.lua&quot;)
+dofile(libpath .. &quot;net/net.effect.lua&quot;)
+dofile(libpath .. &quot;net/net.multi.lua&quot;)
+dofile(libpath .. &quot;net/net.uodragdrop.lua&quot;)
 =

 -- only things that have at least 2 packets get its own file, everything e=
lse is handled here:
 dofile(libpath .. &quot;net/net.packethandlers.lua&quot;)
+
+gLastDoubleClickSerial =3D 0
+

Modified: trunk/data/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.mobile.lua (original)
+++ trunk/data/lua/net/net.mobile.lua Thu Aug  2 17:13:37 2007
@@ -198,8 +198,8 @@
 	gCurrentRenderer:MobileStartServerSideAnim(anim)
 end
 =

--- Note: For characters other than the player, currentHitpoints and maxHit=
points are not the actual values.
--- MaxHitpoints is a fixed value, and currentHitpoints works like a percen=
tage.
+-- Note: For characters other than the player, curHits and maxHits are not=
 the actual values.
+-- maxHits is a fixed value, and curHits works like a percentage.
 -- triggered by Send_ClientQuery(gRequest_States,playermobile.serial)
 -- TODO : Set also HP,Stamina,Mana here
 function gPacketHandler.kPacket_Mobile_Stats() -- 0x11
@@ -217,15 +217,15 @@
 	local oldhp =3D 0
 	if (mobile) then
 		if (mobile.stats) then =

-			oldhp =3D mobile.stats.currentHitpoints	-- save old HitPoints for notif=
ication (see below)
+			oldhp =3D mobile.stats.curHits	-- save old HitPoints for notification (=
see below)
 			stats =3D mobile.stats					-- is stats, use old stats and update it
 		else
 			print(&quot;mobile has no stats yet&quot;)
 		end
 	end
 =

-	stats.currentHitpoints		=3D input:PopNetUint16()
-	stats.maxHitpoints 			=3D input:PopNetUint16()
+	stats.curHits		=3D input:PopNetUint16()
+	stats.maxHits 			=3D input:PopNetUint16()
 	stats.flagChangeNameFlag	=3D input:PopNetUint8()		--(0x1 =3D allowed, 0 =
=3D not allowed)
 	stats.bCanChangeName =3D stats.flagChangeNameFlag ~=3D 0
 	local flag =3D input:PopNetUint8()
@@ -274,7 +274,7 @@
 		mobile.stats =3D stats
 		-- not needed due to normal damage packet
 		-- TODO is this ok for every server?
-		-- gCurrentRenderer:NotifyHPChange(mobile_id, oldhp, mobile.stats.curren=
tHitpoints)
+		-- gCurrentRenderer:NotifyHPChange(mobile_id, oldhp, mobile.stats.curHit=
s)
 		UpdateMobile(mobile)
 	end
 	=

@@ -328,14 +328,14 @@
 	local mobile =3D gMobiles[mobile_id]
 	-- TODO pol sends normal hp update and x/1000 hp update ???? so i ignore =
the strange one
 	if (mobile and (maxval ~=3D 1000) and mobile.stats) then
-		if mobile.stats.currentHitpoints then
+		if mobile.stats.curHits then
 			-- if there was a change, plop a text
-			local old =3D mobile.stats.currentHitpoints
+			local old =3D mobile.stats.curHits
 			gCurrentRenderer:NotifyHPChange(mobile_id, old, curval)
 		end
 		-- update values
-		mobile.stats.currentHitpoints =3D curval
-		mobile.stats.maxHitpoints =3D maxval
+		mobile.stats.curHits =3D curval
+		mobile.stats.maxHits =3D maxval
 =

 		UpdateMobile(mobile)
 	end

Modified: trunk/data/lua/net/net.object.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.object.lua (original)
+++ trunk/data/lua/net/net.object.lua Thu Aug  2 17:13:37 2007
@@ -1,10 +1,5 @@
 -- packet handlers for receiving creating and updating game-objects (dynam=
ics, statics, multis...)
 -- see also lib.packet.lua and lib.protocol.lua
-
--- quick hack to test if it works (its 4:42 am, i'm getting tired)
-gDynamics =3D {}
-
-gLastDoubleClickSerial =3D 0
 =

 function Send_DoubleClick (iSerial)
 	printdebug(&quot;net&quot;,sprintf(&quot;NET: Send_DoubleClick: 0x%08x\n&quot;,iSerial))
@@ -30,14 +25,6 @@
 	out:SendPacket()
 end
 =

-function DestroyDynamicItemBySerial (serial) =

-	local dynamic =3D gDynamics[serial]
-	if (dynamic) then
-		gCurrentRenderer:RemoveDynamicItem( dynamic )
-		gDynamics[dynamic.serial] =3D nil
-	end
-end
-
 -- Server sends Delete/Destroy command of char/item (usually during drag&amp;d=
rop from container)
 -- TODO : multis (serverside multis)
 --		  destroy statics?, containers ?? (associated dialogs,widgets..)
@@ -47,32 +34,7 @@
 	local id =3D input:PopNetUint8()
 	local serial =3D input:PopNetUint32()
 	printdebug(&quot;net&quot;,sprintf(&quot;NET: Destroy item with serial: 0x%08x\n&quot;,serial=
))
+	=

 	DestroyObjectBySerial(serial)
 end
 =

-function DestroyObjectBySerial (serial) =

-	-- destroy items in containers
-	DestroyContainerItemBySerial(serial)
-	-- destroy items in mobiles
-	DestroyMobileItemBySerial(serial)
-	-- destroy dynamics
-	DestroyDynamicItemBySerial(serial)
-	-- destroy mobiles (npcs, monsters,...)
-	DestroyMobileBySerial(serial)
-	DestroyPaperdollByMobileSerial(serial)
-	-- TODO : destroy container
-	gCurrentRenderer:DestroyMousePickItemBySerial(serial)
-	DestroyDragDropItemBySerial(serial)
-end
-
--- needed for mapchange
-function DestroyAllObjects () =

-	CancelUODragDrop()
-	for serial,v in pairs(gContainer) do 			CloseContainer(serial) end
-	for serial,v in pairs(gMobileItemsBySerial) do 	DestroyMobileItemBySerial=
(serial) end
-	for serial,v in pairs(gMobiles) do 				DestroyMobileBySerial(serial) end
-	for serial,v in pairs(gDynamics) do 			DestroyDynamicItemBySerial(serial)=
 end
-	for serial,v in pairs(gPaperdolls) do 			DestroyPaperdollByMobileSerial(s=
erial) end
-	-- TODO : gCurrentRenderer:DestroyMousePickItemBySerial(serial)
-	-- TODO : DestroyDragDropItemBySerial ?? done by CancelUODragDrop
-end

Modified: trunk/data/lua/obj/obj.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.dynamic.lua (original)
+++ trunk/data/lua/obj/obj.dynamic.lua Thu Aug  2 17:13:37 2007
@@ -1,2 +1,46 @@
 -- empty so far, will be filled on knut merge
 =

+
+-- TODO : Add sepearate FILTER : for several Clientside GFX manipulation (=
Game Pieces &amp; Gold,Silver,...)
+function ApplyArtidStackManipulation (item)
+	item.baseartid =3D item.artid
+	=

+	-- from varan
+	-- gold
+	if (item.baseartid =3D=3D hex2num(&quot;0xEED&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEEE&quot;) end
+	if (item.baseartid =3D=3D hex2num(&quot;0xEED&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEEF&quot;) end
+	-- gold
+	if (item.baseartid =3D=3D hex2num(&quot;0xEEA&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEEB&quot;) end
+	if (item.baseartid =3D=3D hex2num(&quot;0xEEA&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEEC&quot;) end
+	-- Silver
+	if (item.baseartid =3D=3D hex2num(&quot;0xEF0&quot;) and item.amount &gt;=3D 2) then i=
tem.artid =3D hex2num(&quot;0xEF1&quot;) end
+	if (item.baseartid =3D=3D hex2num(&quot;0xEF0&quot;) and item.amount &gt;=3D 6) then i=
tem.artid =3D hex2num(&quot;0xEF2&quot;) end
+	-- cannonball
+	if (item.baseartid =3D=3D hex2num(&quot;0xE73&quot;) and item.amount &gt;=3D 4) then i=
tem.artid =3D hex2num(&quot;0xE74&quot;) end
+
+	--TODO : if not in this list, and amount &gt; 0 : draw the graphic 2 times
+	--for example: if (item.baseartid =3D=3D hex2num(&quot;0xE73&quot;) and item.amount=
 &gt; 0) then item.artid =3D hex2num(&quot;0xE74&quot;) item.drawcount=3D2 end
+
+	-- ART -&gt; GUMP
+	-- white backgammon game piece
+	if (item.baseartid =3D=3D hex2num(&quot;0x3584&quot;)) then item.artid =3D hex2num(=
&quot;0x91B&quot;) item.usegump=3Dtrue end
+	-- brown backgammon game piece
+	if (item.baseartid =3D=3D hex2num(&quot;0x358b&quot;)) then item.artid =3D hex2num(=
&quot;0x922&quot;) item.usegump=3Dtrue end
+	-- brown chess pieces
+	if (item.baseartid =3D=3D hex2num(&quot;0x3590&quot;)) then item.artid =3D hex2num(=
&quot;0x927&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x358d&quot;)) then item.artid =3D hex2num(=
&quot;0x924&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x358f&quot;)) then item.artid =3D hex2num(=
&quot;0x926&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x358c&quot;)) then item.artid =3D hex2num(=
&quot;0x923&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x3591&quot;)) then item.artid =3D hex2num(=
&quot;0x928&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x358e&quot;)) then item.artid =3D hex2num(=
&quot;0x925&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	-- white chess pieces
+	if (item.baseartid =3D=3D hex2num(&quot;0x3589&quot;)) then item.artid =3D hex2num(=
&quot;0x920&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x3586&quot;)) then item.artid =3D hex2num(=
&quot;0x91D&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x3588&quot;)) then item.artid =3D hex2num(=
&quot;0x91F&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x3585&quot;)) then item.artid =3D hex2num(=
&quot;0x91C&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x358a&quot;)) then item.artid =3D hex2num(=
&quot;0x921&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+	if (item.baseartid =3D=3D hex2num(&quot;0x3587&quot;)) then item.artid =3D hex2num(=
&quot;0x91E&quot;) item.yloc=3Ditem.yloc-20 item.usegump=3Dtrue end
+
+	-- just for testing, remove me
+	--if (item.artid_addstack ~=3D 0) then print(&quot;unexpected item.artid_addst=
ack&quot;,item.artid_addstack) Crash() end
+end

Modified: trunk/data/lua/obj/obj.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.main.lua (original)
+++ trunk/data/lua/obj/obj.main.lua Thu Aug  2 17:13:37 2007
@@ -1,3 +1,52 @@
 dofile(libpath .. &quot;obj/obj.mobile.lua&quot;)
 dofile(libpath .. &quot;obj/obj.dynamic.lua&quot;)
 dofile(libpath .. &quot;obj/obj.player.lua&quot;)
+
+function GetMobile (mobileserial) return gMobiles[mobileserial] end
+function GetMobileEquipmentItem (mobile,layer) return mobile.equipment[lay=
er] end
+function GetMobileEquipmentList (mobile) return mobile.equipment end
+function GetContainerContentList (container) return container.items end
+function GetObjectBySerial (serial) return gMobileItemsBySerial[serial] or=
 gMobiles[serial] or gDynamics[serial] end
+
+function GetDynamicList () return gDynamics end
+function GetMobileList () return gMobiles end
+
+gDynamics =3D {}
+
+
+function DestroyDynamicItemBySerial (serial) =

+	local dynamic =3D gDynamics[serial]
+	if (dynamic) then
+		gCurrentRenderer:RemoveDynamicItem( dynamic )
+		gDynamics[dynamic.serial] =3D nil
+	end
+end
+
+function DestroyObjectBySerial (serial) =

+	-- destroy items in containers
+	DestroyContainerItemBySerial(serial)
+	-- destroy items in mobiles
+	DestroyMobileItemBySerial(serial)
+	-- destroy dynamics
+	DestroyDynamicItemBySerial(serial)
+	-- destroy mobiles (npcs, monsters,...)
+	DestroyMobileBySerial(serial)
+	DestroyPaperdollByMobileSerial(serial)
+	-- TODO : destroy container
+	gCurrentRenderer:DestroyMousePickItemBySerial(serial)
+	DestroyDragDropItemBySerial(serial)
+end
+
+-- needed for mapchange
+function DestroyAllObjects () =

+	CancelUODragDrop()
+	for serial,v in pairs(gContainer) do 			CloseContainer(serial) end
+	for serial,v in pairs(gMobileItemsBySerial) do 	DestroyMobileItemBySerial=
(serial) end
+	for serial,v in pairs(gMobiles) do 				DestroyMobileBySerial(serial) end
+	for serial,v in pairs(gDynamics) do 			DestroyDynamicItemBySerial(serial)=
 end
+	for serial,v in pairs(gPaperdolls) do 			DestroyPaperdollByMobileSerial(s=
erial) end
+	-- TODO : gCurrentRenderer:DestroyMousePickItemBySerial(serial)
+	-- TODO : DestroyDragDropItemBySerial ?? done by CancelUODragDrop
+end
+
+

Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Thu Aug  2 17:13:37 2007
@@ -98,17 +98,17 @@
 	end
 	=

 	-- update life stats in gui elements
-	if (mobile.stats.currentHitpoints and mobile.stats.maxHitpoints) then
+	if (mobile.stats.curHits and mobile.stats.maxHits) then
 		if (mobile.serial =3D=3D gPlayerBodySerial) then
 			-- for player
-			gui.SetHitpoints(mobile.stats.currentHitpoints/mobile.stats.maxHitpoint=
s)
+			gui.SetHitpoints(mobile.stats.curHits/mobile.stats.maxHits)
 			if (mobile.stats.char_curMana) then gui.SetMana(mobile.stats.char_curMa=
na/mobile.stats.char_maxMana) end
 			if (mobile.stats.char_curSta) then gui.SetStamina(mobile.stats.char_cur=
Sta/mobile.stats.char_maxSta) end
 			-- update big_stats window
 			UpdateStatusAos()
 		else
 			-- for other mobiles
-			SetNpcStatusHitpoints(mobile, mobile.stats.currentHitpoints / mobile.st=
ats.maxHitpoints)
+			SetNpcStatusHitpoints(mobile, mobile.stats.curHits / mobile.stats.maxHi=
ts)
 		end
 	end
 	=


Modified: trunk/data/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.player.lua (original)
+++ trunk/data/lua/obj/obj.player.lua Thu Aug  2 17:13:37 2007
@@ -47,15 +47,14 @@
 	return playermobile and playermobile.stats and playermobile.stats.char_go=
ld or 0
 end
 =

+function GetPlayerMobile ()
+	return gPlayerBodySerial and GetMobile(gPlayerBodySerial)
+end
+
 -- used by secure trade, mobile.name is filled by kPacket_Mobile_Stats
 function GetPlayerName ()
 	local mobile =3D GetPlayerMobile()
 	return mobile and mobile.name
-end
-
-function GetPlayerMobile ()
-	if (not gPlayerBodySerial) then return end -- not yet received from server
-	return gMobiles[gPlayerBodySerial]
 end
 =

 function GetPlayerBackPackContainer ()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000145.html">[Iris-commit] [IRIS] r1329 - in /branches/knut/data/lua: ./ gui/	net/ obj/
</A></li>
	<LI>Next message: <A HREF="000147.html">[Iris-commit] [IRIS] r1331 - in /branches/knut/data/lua/net: net.effect.lua net.multi.lua net.packethandlers.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#146">[ date ]</a>
              <a href="thread.html#146">[ thread ]</a>
              <a href="subject.html#146">[ subject ]</a>
              <a href="author.html#146">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
