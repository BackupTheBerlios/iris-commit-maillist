<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r2210 - in /trunk: bin/plugins_linux.cfg lua/lib.2d.mobile.lua lua/lib.2d.renderer.lua lua/lib.bugreport.lua lua/lib.loading.lua lua/lib.mainmenu.lua lua/lib.map.lua lua/lib.uoanim.lua lua/main.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2210%20-%20in%20/trunk%3A%20bin/plugins_linux.cfg%0A%20lua/lib.2d.mobile.lua%20lua/lib.2d.renderer.lua%20lua/lib.bugreport.lua%0A%20lua/lib.loading.lua%20lua/lib.mainmenu.lua%20lua/lib.map.lua%20lua/lib.uoanim.lua%0A%20lua/main.lua&In-Reply-To=%3C20080531003445.7C31C1C180F1%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001018.html">
   <LINK REL="Next"  HREF="001020.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r2210 - in /trunk: bin/plugins_linux.cfg lua/lib.2d.mobile.lua lua/lib.2d.renderer.lua lua/lib.bugreport.lua lua/lib.loading.lua lua/lib.mainmenu.lua lua/lib.map.lua lua/lib.uoanim.lua lua/main.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2210%20-%20in%20/trunk%3A%20bin/plugins_linux.cfg%0A%20lua/lib.2d.mobile.lua%20lua/lib.2d.renderer.lua%20lua/lib.bugreport.lua%0A%20lua/lib.loading.lua%20lua/lib.mainmenu.lua%20lua/lib.map.lua%20lua/lib.uoanim.lua%0A%20lua/main.lua&In-Reply-To=%3C20080531003445.7C31C1C180F1%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r2210 - in /trunk: bin/plugins_linux.cfg lua/lib.2d.mobile.lua lua/lib.2d.renderer.lua lua/lib.bugreport.lua lua/lib.loading.lua lua/lib.mainmenu.lua lua/lib.map.lua lua/lib.uoanim.lua lua/main.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Sat May 31 02:34:45 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001018.html">[Iris-commit] [IRIS] r2209 - /trunk/bin/iris2.exe
</A></li>
        <LI>Next message: <A HREF="001020.html">[Iris-commit] [IRIS] r2211 - in /trunk/lua: lib.2d.cam.lua lib.2d.mobile.lua lib.2d.renderer.lua lib.uoanim.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1019">[ date ]</a>
              <a href="thread.html#1019">[ thread ]</a>
              <a href="subject.html#1019">[ subject ]</a>
              <a href="author.html#1019">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Sat May 31 02:34:44 2008
New Revision: 2210

Log:
bugreport:replaced sfz with iris in text, 2d:worked on anims, autologin:add=
ed charname option -co servername charname, option for exporting tree-locat=
ions, bugfix:mapchange when no map loaded, 2d: online-mode : cam centers on=
 playerpos

Modified:
    trunk/bin/plugins_linux.cfg
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.bugreport.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.map.lua
    trunk/lua/lib.uoanim.lua
    trunk/lua/main.lua

Modified: trunk/bin/plugins_linux.cfg
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/bin/plugins_linux.cfg (original)
+++ trunk/bin/plugins_linux.cfg Sat May 31 02:34:44 2008
@@ -16,4 +16,4 @@
 Plugin=3DPlugin_ParticleFX.so 	=

 Plugin=3DPlugin_BSPSceneManager.so 	=

 Plugin=3DPlugin_OctreeSceneManager.so 	=

-Plugin=3DPlugin_CgProgramManager.so =

+#~ Plugin=3DPlugin_CgProgramManager.so =


Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Sat May 31 02:34:44 2008
@@ -4,29 +4,57 @@
 k2D_ScaleH		=3D kSq2 / 44
 k2D_ScaleW05	=3D 0.5 / 44 -- 0.5 : applied left and right
 =

-function Renderer2D:UpdateMobile				() end -- main updater, create, positi=
on ...
-function Renderer2D:UpdateMobileModel			() end -- check equipment change e=
tc ??
-function Renderer2D:DestroyMobileGfx			() end
+-- main updater, create, position ...
+function Renderer2D:UpdateMobile				(mobile) =

+	local gfx =3D mobile.gfx2d
+	if (not gfx) then
+		local iModelID,iAnimID =3D 401,0
+		local iHue =3D 0x03F4 -- human skin hue (0x83F4=3D33780, but 0x8* is par=
tial hue and turned out all gray here)
+		--~ local iHue =3D 0
+	=

+		gfx =3D CreateRootGfx3D()
+		mobile.gfx2d =3D gfx
+		gfx:SetSimpleRenderable()
+		=

+		local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

+		local animinfo =3D GetAnimDataInfo(iModelID) -- o.miFrames,o.miUnknown,o=
.miCount,o.miFrameInterval,o.miFrameStart
+		gfx.animinfo =3D animinfo
+		gfx.iAnimStartTime =3D Client_GetTicks()
+		gfx.iFrame =3D 0
+		=

+		local o =3D animinfo =

+		--~ print(&quot;animinfo&quot;,o.miFrames,o.miUnknown,o.miCount,o.miFrameInterval,=
o.miFrameStart)
+		--animinfo        table: 0x93e5d90        -1      -1      -1      -1
+		--~ for k,v in pairs(o.miFrames) do print(&quot;frame&quot;,k,v) end -- were all -=
1 =

+
+		self:MobileGfxUpdateGeometry(gfx,iModelID,iAnimID,gfx.iFrame,iHue)
+		print(&quot;gfx.iMaxFrames&quot;,gfx.iMaxFrames)
+	end
+	=

+	=

+	=

+	local x,y,z =3D self:UOPosToLocal(mobile.xloc,mobile.yloc,0 or mobile.zlo=
c)
+	print(&quot;UpdateMobile&quot;,mobile.xloc,mobile.yloc,mobile.zloc,x,y,z)
+	gfx:SetPosition(x,y,z)
+	=

+	=

+	DestroyList_Add(mobile.gfx2d,gfx)
+end =

+
+function Renderer2D:DestroyMobileGfx			(mobile) if (mobile.gfx2d) then Des=
troyList_Destroy(mobile.gfx2d) end end
+
+function Renderer2D:UpdateMobileModel			() end -- check equipment change e=
tc ?? called every time when UpdateMobile() is called ..
+
 function Renderer2D:MobileAnimStep				() end -- from mainstep
 function Renderer2D:MobileStartServerSideAnim	(animdata) end
 =

-gMobile2DTestGfx =3D nil
-
--- todo : humans : one atlas with complete equipment, will need alpha-blit=
 for images ?
--- todo : mobile : load anim only on demand, e.g. only load walk anim when=
 the mobile actually walks
--- returns sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1
-function Anim2DAtlas_Load (iModelID,iAnimID,iFrame,iHue)
-	local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

-	local pImage,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrame=
ToImage(iRealID,iFrame,iHue)
-	local tex =3D pImage:MakeTexture()
-	local sMatName =3D GetPlainTextureMat(tex,true)
-	local u0,v0,u1,v1 =3D 0,0,1,1
-	return sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1
-end
 =

 -- TODO : bMirrorX !
 function Renderer2D:MobileGfxUpdateGeometry (gfx,iModelID,iAnimID,iFrame,i=
Hue)
 	local sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1 =3D A=
nim2DAtlas_Load(iModelID,iAnimID,iFrame,iHue)
+	if (not sMatName) then return end
+	print(&quot;MobileGfxUpdateGeometry&quot;,sMatName,iWidth,iHeight,iCenterX,iCenterY=
,iFrames,u0,v0,u1,v1)
+	--~ sMatName =3D &quot;BaseWhiteNoLighting&quot;
 	--~ print(&quot;MobileGfxUpdateGeometry&quot;,iAnimID,iFrame,iWidth,iHeight,iCenter=
X,iCenterY,iFrames)
 	-- MobileGfxUpdateGeometry : cen=3D  12      -11
 	local zoom =3D 1
@@ -49,80 +77,16 @@
 end
 =

 function Renderer2D:MobileTestStep()
-	-- iAnimID : 0-4=3Dwalk down,down-left,left,up-left,up
-	=

-	-- iAnimID : 5-9=3Dwalk down (something in hand)
-	-- iAnimID : 10-14=3Drun
-	-- iAnimID : 15-19=3Drun (something in hand?)
-	-- iAnimID : 20-24 idle (1 frame) =

-	-- iAnimID : 25-29 idle anim? look from left to right
-	-- iAnimID : 30-24 idle anim? spread arms
-	-- iAnimID : 35- combat idle
-	-- iAnimID : 40- combat idle 2hand ?
-	-- iAnimID : 45- punch/bash anim
-	-- iAnimID : 50- stab anim
-	-- iAnimID : 55- punch/bash2 anim
-	-- iAnimID : 60- punch/bash 2-handed
-	-- iAnimID : 65- swing 2-handed
-	-- iAnimID : 70- stab 2-handed ?
-	-- iAnimID : 75- combat-walk-2-handed
-	-- iAnimID : 80- cast1
-	-- iAnimID : 85- cast2
-	-- iAnimID : 90- fire-bow/crossbow?
-	-- iAnimID : 95- fire-bow/crossbow?
-	-- iAnimID : 100- gethit/flinch/pain
-	-- iAnimID : 105- die backwards
-	-- iAnimID : 110- die forwards
-	-- iAnimID : 115- mount-walk-horse
-	-- iAnimID : 120- mount-walk-ostard
-	-- iAnimID : 125- mount-idle-ostard
-	-- iAnimID : 130- mount-attack-swing?-ostard
-	-- iAnimID : 135- mount-attack-bow-ostard
-	-- iAnimID : 140- mount-attack-crossbow-ostard
-	-- iAnimID : 145- mount-attack-bash?-ostard
-	-- iAnimID : 150- attack-stab?
-	-- iAnimID : 155- attack-punch?
-	-- iAnimID : 160- bow
-	-- iAnimID : 165- salute
-	-- iAnimID : 170- cough
-	=

-	local iModelID,iAnimID =3D 401,0
-	local iHue =3D 0x03F4 -- human skin hue (0x83F4=3D33780, but 0x8* is part=
ial hue and turned out all gray here)
-	--~ local iHue =3D 0
+	if true then return end
 	=

 	=

-	if (not gMobile2DTestGfx) then
-		local gfx =3D CreateRootGfx3D()
-		gfx:SetSimpleRenderable()
-		gMobile2DTestGfx =3D gfx
-		=

-		local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

-		local animinfo =3D GetAnimDataInfo(iModelID) -- o.miFrames,o.miUnknown,o=
.miCount,o.miFrameInterval,o.miFrameStart
-		gMobile2DTestGfx.animinfo =3D animinfo
-		gMobile2DTestGfx.iAnimStartTime =3D Client_GetTicks()
-		gMobile2DTestGfx.iFrame =3D 0
-		=

-		local o =3D animinfo =

-		print(&quot;animinfo&quot;,o.miFrames,o.miUnknown,o.miCount,o.miFrameInterval,o.mi=
FrameStart)
-		--animinfo        table: 0x93e5d90        -1      -1      -1      -1
-		for k,v in pairs(o.miFrames) do print(&quot;frame&quot;,k,v) end -- were all -1 =

-
-		self:MobileGfxUpdateGeometry(gfx,iModelID,iAnimID,gMobile2DTestGfx.iFram=
e,iHue)
-		print(&quot;gfx.iMaxFrames&quot;,gfx.iMaxFrames)
-	end
-	=

-	local gfx =3D gMobile2DTestGfx
-	local xloc,yloc =3D self:GetCamPos()
-	local x,y,z =3D self:UOPosToLocal(xloc,yloc,4)
-	gfx:SetPosition(x,y,z)
-	=

-	local t =3D Client_GetTicks() - gfx.iAnimStartTime
-	local framedt =3D 200
-	local framecount =3D gfx.iMaxFrames
-	local iFrameNum =3D math.mod(math.floor(t/framedt),framecount)
-	if (gfx.iFrame ~=3D iFrameNum) then
-		gfx.iFrame  =3D iFrameNum
-		self:MobileGfxUpdateGeometry(gfx,iModelID,iAnimID,gfx.iFrame,iHue)
-	end
+	--~ local t =3D Client_GetTicks() - gfx.iAnimStartTime
+	--~ local framedt =3D 200
+	--~ local framecount =3D gfx.iMaxFrames
+	--~ local iFrameNum =3D math.mod(math.floor(t/framedt),framecount)
+	--~ if (gfx.iFrame ~=3D iFrameNum) then
+		--~ gfx.iFrame  =3D iFrameNum
+		--~ self:MobileGfxUpdateGeometry(gfx,iModelID,iAnimID,gfx.iFrame,iHue)
+	--~ end
 end
 =


Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Sat May 31 02:34:44 2008
@@ -48,6 +48,9 @@
 	self:MobileAnimStep()
 	-- TODO : self:CombatGuiStep() ?
 	-- TODO : self:MousePickStep() ?
+	local xloc,yloc,zloc =3D GetPlayerPos()
+	print(&quot;playerpos&quot;,xloc,yloc,zloc)
+	self:SetCamPos(xloc,yloc)
 end
 =

  =


Modified: trunk/lua/lib.bugreport.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bugreport.lua (original)
+++ trunk/lua/lib.bugreport.lua Sat May 31 02:34:44 2008
@@ -54,9 +54,9 @@
 	end
 	=

 	local rows =3D {
-		{ {&quot;SFZ has encountered an error,&quot;} },
+		{ {&quot;Iris has encountered an error,&quot;} },
 		{ {&quot;it will try to ignore it and continue running, but some things might=
 not work correctly&quot;} },
-		{ {&quot;updating to a newer sfz version might help, e.g. 'svn up' in linux o=
r running 'updater.exe' in win&quot;} },
+		{ {&quot;updating to a newer iris version might help, e.g. 'svn up' in linux =
or running 'updater.exe' in win&quot;} },
 		{ {&quot;the report has been saved to &quot;..kBugReportPath} },
 		{ {&quot;do you want to send us a bug report ?&quot;} },
 		{ {&quot;you can also attach a note:&quot;} },
@@ -72,7 +72,7 @@
 					PlainMessageBox(&quot;bug report received, thank you =3D)&quot;,gGuiDefaultStyl=
eSet,gGuiDefaultStyleSet)
 				else =

 					PlainMessageBox(&quot;sorry, something went wrong, we didn't get your bugr=
eport\n&quot;..
-									&quot;please see <A HREF="http://sfz.sourceforge.net">http://sfz.sourceforge.net</A> for how to contact us dire=
ctly\n&quot;..result,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
+									&quot;please see <A HREF="http://iris.sourceforge.net">http://iris.sourceforge.net</A> for how to contact us dir=
ectly\n&quot;..result,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
 				end
 			end} },
 		}

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Sat May 31 02:34:44 2008
@@ -217,7 +217,7 @@
 =

 -- don't load new map immediately, several mapchanges might be sent at log=
in quickly
 function MapChangeRequest (iMaxNewIndex)
-	if (gMapIndex =3D=3D iMaxNewIndex) then return end
+	if (gMapLoaded and gMapIndex =3D=3D iMaxNewIndex) then return end
 	print(&quot;#### MapChangeRequest=3D&quot;..iMaxNewIndex)
 	=

 	-- unloading of all objects must happen immediately on change request, =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sat May 31 02:34:44 2008
@@ -208,9 +208,10 @@
 		-- answered by kPacket_Features 0xB9 and  kPacket_Character_List 0xA9 wh=
ich calls MainMenuShowCharList
 	end
 	=

-	-- if there is only one entry, select it automatically
-	if (countarr(serverlist.servers) =3D=3D 1) then
+	-- if there is only one entry or if autologin, select it automatically
+	if (countarr(serverlist.servers) =3D=3D 1 or gCommandLineSwitches[&quot;-co&quot;])=
 then
 		local k,v =3D next(serverlist.servers) -- get first entry
+		gSelectedShardName =3D v.name
 		MySelectServer(v)
 		return
 	end
@@ -252,9 +253,9 @@
 	--characterlist selection or new char creation
 	--check first, if the choose slot is available!
 	=

-	local MySelectChar =3D function(widget) =

-		Send_Character_Select(widget.iCharNum,gGameServerAccount)
-		widget.dialog:Destroy()
+	=

+	local MySelectChar =3D function(iCharNum) =

+		Send_Character_Select(iCharNum,gGameServerAccount)
 	end
 	local MyCreateCharTemplatePicker =3D function(widget) =

 		MainMenuShowCharCreationDialog(widget.chartemplate,gNextFreeCharSlot)
@@ -267,10 +268,18 @@
 	}
 	-- existing characters
 	gNextFreeCharSlot =3D 0
+	local autologin_charname
+	if (gCommandLineSwitches[&quot;-co&quot;]) then autologin_charname =3D gCommandLine=
Arguments[gCommandLineSwitches[&quot;-co&quot;]+2] end -- autologin
 	for k,v in pairs(charlist.chars) do if (v.name ~=3D &quot;&quot;) then
+		if (v.name =3D=3D autologin_charname) then =

+			local iCharNum =3D k
+			Send_Character_Select(iCharNum,gGameServerAccount)
+			gSelectedCharName =3D v.name
+			return
+		end
 		gNextFreeCharSlot =3D gNextFreeCharSlot + 1
 		table.insert(rows,{
-			{type=3D&quot;Button&quot;,onLeftClick=3Dfunction(widget) MySelectChar(widget) gS=
electedCharName =3D v.name end ,iCharNum=3Dk,text=3D&quot;Login as &quot;..v.name}
+			{type=3D&quot;Button&quot;,onLeftClick=3Dfunction(widget) MySelectChar(widget.iCh=
arNum) widget.dialog:Destroy() gSelectedCharName =3D v.name end ,iCharNum=
=3Dk,text=3D&quot;Login as &quot;..v.name}
 		})
 	end end
 	-- char creation (TODO)

Modified: trunk/lua/lib.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.map.lua (original)
+++ trunk/lua/lib.map.lua Sat May 31 02:34:44 2008
@@ -21,9 +21,9 @@
 =

 =

 function MapGetWInBlocks	()	return gGroundBlockLoader:GetMapW() end
-function MapGetHInBlocks	()	return gGroundBlockLoader:GetMapW() end
+function MapGetHInBlocks	()	return gGroundBlockLoader:GetMapH() end
 function MapGetWInTiles		()	return gGroundBlockLoader:GetMapW() * 8 end
-function MapGetHInTiles		()	return gGroundBlockLoader:GetMapW() * 8 end
+function MapGetHInTiles		()	return gGroundBlockLoader:GetMapH() * 8 end
 =

 =

 -- ***** ***** ***** ***** ***** caching

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Sat May 31 02:34:44 2008
@@ -1,15 +1,66 @@
 -- 2d char anim graphics
+-- loads the 2d anim-art, not specific to 2d renderer, might also be used =
in 3d mode for fallbacks
 =

-kAnim_IdRangeLen_HighDetailed	=3D 200  -- mHighDetailed
-kAnim_IdRangeLen_LowDetailed	=3D 200  -- mLowDetailed
+gAnimAtlasCache =3D {}
+kAnimID_Human_Idle =3D 20 =

+kAnimIDRangeLen_HighDetailed	=3D 200  -- mHighDetailed
+kAnimIDRangeLen_LowDetailed		=3D 200  -- mLowDetailed
+
+-- todo : humans : one atlas with complete equipment, will need alpha-blit=
 for images ?
+-- todo : mobile : load anim only on demand, e.g. only load walk anim when=
 the mobile actually walks
+-- returns sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1
+function Anim2DAtlas_Load (iModelID,iAnimID,iFrame,iHue)
+	iAnimID =3D 0 -- kAnimID_Human_Idle
+	iFrame =3D 0
+	--~ iHue =3D 0
+	local n =3D iModelID..&quot;,&quot;..iAnimID..&quot;,&quot;..iFrame..&quot;,&quot;..iHue
+	local o =3D gAnimAtlasCache[n]
+	if (o) then return unpack(o) end
+	local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

+	local pImage,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrame=
ToImage(iRealID,iFrame,iHue)
+	print(&quot;Anim2DAtlas_Load&quot;,iRealID,iFrame,iHue,&quot;#&quot;,pImage,iWidth,iHeight,iC=
enterX,iCenterY,iFrames)
+	if (not pImage) then print(&quot;Anim2DAtlas_Load : dead anim &quot;,iModelID,iAnim=
ID,iFrame,iHue) end
+	if (not pImage) then o =3D {} gAnimAtlasCache[n] =3D o return unpack(o) e=
nd
+		=

+	=

+	local w =3D 64
+	while (w &lt; iWidth) do w =3D w * 2 end
+	while (w &lt; iHeight) do w =3D w * 2 end
+	local atlas =3D CreateTexAtlas(w,w)
+	local iBorderPixels =3D 0
+	local bWrap =3D false
+	local bSuccess,l,r,t,b =3D atlas:AddImage(pImage,iBorderPixels,bWrap)
+	pImage:Destroy()
+
+	--~ if (2 =3D=3D 1) then
+		--~ local img2 =3D CreateImage()
+		--~ atlas:MakeImage(img2)
+		--~ img2:SaveAsFile(&quot;../animtest.png&quot;)
+		--~ img2:Destroy()
+	--~ end
+	=

+	local tex =3D atlas:MakeTexture() -- generate new texture
+	local sMatName =3D CloneMaterial(&quot;renderer2dbillboard&quot;)
+	SetTexture(sMatName,tex)
+	=

+	local u0,v0,u1,v1 =3D l,t,r,b
+	o =3D {sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1}
+	print(&quot;anim2d&quot;,sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1=
,v1)
+	gAnimAtlasCache[n] =3D o
+	return unpack(o)
+end
+
+
+
+
 =

 -- iID is probably bodyid, and animid the animation ? ported from varans c=
ode
 function Anim_GetRealID (iModelID,iAnimID) =

-	if (iModelID &lt; kAnim_IdRangeLen_HighDetailed) then return iAnimID + iMode=
lID*110 end
-	if (iModelID &lt; kAnim_IdRangeLen_HighDetailed + kAnim_IdRangeLen_LowDetail=
ed) then
-		return iAnimID + kAnim_IdRangeLen_HighDetailed*110 + (iModelID-kAnim_IdR=
angeLen_HighDetailed)*65
+	if (iModelID &lt; kAnimIDRangeLen_HighDetailed) then return iAnimID + iModel=
ID*110 end
+	if (iModelID &lt; kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
) then
+		return iAnimID + kAnimIDRangeLen_HighDetailed*110 + (iModelID-kAnimIDRan=
geLen_HighDetailed)*65
 	end
-	return iAnimID + kAnim_IdRangeLen_HighDetailed*110 + kAnim_IdRangeLen_Low=
Detailed*65 + (iModelID-kAnim_IdRangeLen_HighDetailed-kAnim_IdRangeLen_LowD=
etailed)*175
+	return iAnimID + kAnimIDRangeLen_HighDetailed*110 + kAnimIDRangeLen_LowDe=
tailed*65 + (iModelID-kAnimIDRangeLen_HighDetailed-kAnimIDRangeLen_LowDetai=
led)*175
 end
 =

 gGetAnimDataInfoCache =3D {}
@@ -96,3 +147,42 @@
 	=

 ]]--
 =

+
+--[[
+-- iAnimID : 0-4=3Dwalk down,down-left,left,up-left,up
+-- iAnimID : 5-9=3Dwalk down (something in hand)
+-- iAnimID : 10-14=3Drun
+-- iAnimID : 15-19=3Drun (something in hand?)
+-- iAnimID : 20-24 idle (1 frame) =

+-- iAnimID : 25-29 idle anim? look from left to right
+-- iAnimID : 30-24 idle anim? spread arms
+-- iAnimID : 35- combat idle
+-- iAnimID : 40- combat idle 2hand ?
+-- iAnimID : 45- punch/bash anim
+-- iAnimID : 50- stab anim
+-- iAnimID : 55- punch/bash2 anim
+-- iAnimID : 60- punch/bash 2-handed
+-- iAnimID : 65- swing 2-handed
+-- iAnimID : 70- stab 2-handed ?
+-- iAnimID : 75- combat-walk-2-handed
+-- iAnimID : 80- cast1
+-- iAnimID : 85- cast2
+-- iAnimID : 90- fire-bow/crossbow?
+-- iAnimID : 95- fire-bow/crossbow?
+-- iAnimID : 100- gethit/flinch/pain
+-- iAnimID : 105- die backwards
+-- iAnimID : 110- die forwards
+-- iAnimID : 115- mount-walk-horse
+-- iAnimID : 120- mount-walk-ostard
+-- iAnimID : 125- mount-idle-ostard
+-- iAnimID : 130- mount-attack-swing?-ostard
+-- iAnimID : 135- mount-attack-bow-ostard
+-- iAnimID : 140- mount-attack-crossbow-ostard
+-- iAnimID : 145- mount-attack-bash?-ostard
+-- iAnimID : 150- attack-stab?
+-- iAnimID : 155- attack-punch?
+-- iAnimID : 160- bow
+-- iAnimID : 165- salute
+-- iAnimID : 170- cough
+]]--
+

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat May 31 02:34:44 2008
@@ -317,6 +317,7 @@
 	InitArtFilter()
 	=

 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
+	--~ Client_USleep(1000/30)
 =

 	NotifyListener(&quot;Hook_PreLoad&quot;)
 	PreLoad()
@@ -420,6 +421,32 @@
 =

 -- exports data if some commandline parameters are set
 function InvokeExporters ()
+	if (gCommandLineArguments[1] =3D=3D &quot;-tree&quot;) then -- export trees
+		print(&quot;# # # # # # # # # #  #  #    #     #      starting tree exporter&quot;)
+		local treetypes =3D {}
+		for iFacet =3D 0,0 do -- 0 Felucca, 1 Trammel, 2 Ilshenar, 3 Malas, 4 To=
kuno
+			MapChangeRequest(iFacet)
+			local mapw =3D MapGetWInBlocks()
+			local maph =3D MapGetHInBlocks()
+			for bx =3D 0,mapw-1 do
+				for by =3D 0,maph-1 do
+					for k,static in pairs(MapGetBlockStatics(bx,by)) do =

+						local iTileTypeID =3D static.artid
+						local bIsTree =3D treetypes[iTileTypeID]
+						if (bIsTree =3D=3D nil) then
+							bIsTree =3D string.find(string.lower(GetStaticTileTypeName(iTileTyp=
eID)),&quot;tree&quot;)
+							treetypes[iTileTypeID] =3D bIsTree
+						end
+						if (bIsTree) then
+							local o =3D static
+							print(&quot;Tree(&quot;..iFacet..&quot;,&quot;..o.xloc..&quot;,&quot;..o.yloc..&quot;,&quot;..o.zloc..&quot;,&quot;..=
o.artid,&quot;)&quot;)
+						end
+					end
+				end
+			end
+		end
+		os.exit(0)
+	end
 	if (gCommandLineArguments[1] =3D=3D &quot;-em&quot;) then -- export map xloc,yloc,m=
apblocksw,mapblocksh
 		local img =3D CreateImage()
 		local bx		=3D math.floor(tonumber(gCommandLineArguments[2])/8)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001018.html">[Iris-commit] [IRIS] r2209 - /trunk/bin/iris2.exe
</A></li>
	<LI>Next message: <A HREF="001020.html">[Iris-commit] [IRIS] r2211 - in /trunk/lua: lib.2d.cam.lua lib.2d.mobile.lua lib.2d.renderer.lua lib.uoanim.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1019">[ date ]</a>
              <a href="thread.html#1019">[ thread ]</a>
              <a href="subject.html#1019">[ subject ]</a>
              <a href="author.html#1019">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
