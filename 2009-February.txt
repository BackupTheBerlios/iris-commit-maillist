From no-reply at zwischenwelt.org  Sun Feb  1 17:27:31 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 01 Feb 2009 16:27:31 -0000
Subject: [Iris-commit] [IRIS] r2894 - /trunk/lua/lib.cliloc.lua
Message-ID: <20090201162731.41BC81C18854@zwischenwelt.org>

Author: sience
Date: Sun Feb  1 17:27:30 2009
New Revision: 2894

Log:
-fix to prevent crash when shard uses wrong tooltips with no cliloc ids (ht=
tp://www.iris2.de/forums/viewtopic.php?t=3D1343)

Modified:
    trunk/lua/lib.cliloc.lua

Modified: trunk/lua/lib.cliloc.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.cliloc.lua (original)
+++ trunk/lua/lib.cliloc.lua Sun Feb  1 17:27:30 2009
@@ -89,6 +89,7 @@
 function ParseClilocParam (param)
 	if (string.sub(param,1,1) ~=3D "#") then return param end -- first char
 	local cliloc_id =3D tonumber(string.sub(param,2))
+	if not(cliloc_id) then cliloc_id=3D"no id" end
 	return gClilocLoader and gClilocLoader:Get(cliloc_id) or ("unknown_cliloc=
_"..cliloc_id)
 end
 =




From no-reply at zwischenwelt.org  Mon Feb  2 20:22:51 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 02 Feb 2009 19:22:51 -0000
Subject: [Iris-commit] [IRIS] r2895 - in /trunk: lua/lib.macrolist.lua
 plugins/moblist.lua premakelinux.sh
Message-ID: <20090202200009.03D5A1C18662@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Feb  2 20:22:51 2009
New Revision: 2895

Log:
premakelinux.sh improvement by idl0r : switch to avoid broken luajit on 64 =
bit systems, number of parallel compiling jobs determined by number of proc=
essors.

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/plugins/moblist.lua
    trunk/premakelinux.sh

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Feb  2 20:22:51 2009
@@ -58,12 +58,12 @@
 	if (gSmartLastSpellID) then =

 		if (gSmartLastSpellID =3D=3D kSmartSpellHealSmall or gSmartLastSpellID =
=3D=3D kSmartSpellHealBig) then
 			local target =3D MobileList_GetWeakestFromList(MobileList_HealableParty=
Members())
-			print("healtarget",target)
+			--~ print("healtarget",target)
 			return target and target.serial or GetPlayerSerial()
 		end
 		if (gSmartLastSpellID =3D=3D kSmartSpellCureSmall or gSmartLastSpellID =
=3D=3D kSmartSpellCureBig) then
 			local target =3D MobileList_GetWeakestFromList(MobileList_CurablePartyM=
embers())
-			print("curetarget",target)
+			--~ print("curetarget",target)
 			return target and target.serial or GetPlayerSerial()
 		end
 	end

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Mon Feb  2 20:22:51 2009
@@ -25,6 +25,11 @@
 RegisterWidgetClass("UOMobList")
 RegisterWidgetClass("UOMobListItem")
 =

+
+function gWidgetPrototype.UOMobList:UpdateSmartTargetIndicator ()
+	local serial =3D MacroCmd_GetSmartTargetForLastSpell()
+end
+	=

 function gWidgetPrototype.UOMobList:Init (parentwidget,params)
 	self:InitAsGroup(parentwidget,params)
 	self.items =3D {}

Modified: trunk/premakelinux.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premakelinux.sh (original)
+++ trunk/premakelinux.sh Mon Feb  2 20:22:51 2009
@@ -1,5 +1,20 @@
 #!/bin/bash
+
+# use multi-core/multi-processor correctly
+JOBS=3D$(($(grep -c 'processor' /proc/cpuinfo) + 1))
+
+
 ./premake --clean
-./premake --useluajit --noassert --target gnu && make CXX=3D"ccache gcc" C=
ONFIG=3DRelease
-#~ ./premake --target gnu && make CONFIG=3DRelease
-# tipp : try "make -j 2" : start 2 jobs in parallel, to avoid wait-for-io =
and use multi-cpu processors efficiently during compile
+
+echo ${JOBS}
+if [ "$(uname -m)" =3D=3D "x86_64" ]; # luajit doesn't work on 64 bit
+then
+	./premake --noassert --target gnu
+else
+	./premake --useluajit --noassert --target gnu
+fi
+
+#~  old : -./premake --useluajit --noassert --target gnu && make CXX=3D"cc=
ache gcc" CONFIG=3DRelease
+
+make -j${JOBS} CONFIG=3DRelease
+



From no-reply at zwischenwelt.org  Mon Feb  2 20:53:46 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 02 Feb 2009 19:53:46 -0000
Subject: [Iris-commit] [IRIS] r2896 - /trunk/premakelinux.sh
Message-ID: <20090202200009.883C11C18852@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Feb  2 20:53:46 2009
New Revision: 2896

Log:
removed --useluajit for linux make due to popen error at startup

Modified:
    trunk/premakelinux.sh

Modified: trunk/premakelinux.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premakelinux.sh (original)
+++ trunk/premakelinux.sh Mon Feb  2 20:53:46 2009
@@ -11,9 +11,10 @@
 then
 	./premake --noassert --target gnu
 else
-	./premake --useluajit --noassert --target gnu
+	./premake --noassert --target gnu
 fi
 =

+#  --useluajit
 #~  old : -./premake --useluajit --noassert --target gnu && make CXX=3D"cc=
ache gcc" CONFIG=3DRelease
 =

 make -j${JOBS} CONFIG=3DRelease



From no-reply at zwischenwelt.org  Mon Feb  2 22:24:02 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 02 Feb 2009 21:24:02 -0000
Subject: [Iris-commit] [IRIS] r2897 - /trunk/installdeps.ubuntu.sh
Message-ID: <20090202212402.4CF551C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Feb  2 22:24:01 2009
New Revision: 2897

Log:
added --enable-cg to enable cg shader support

Modified:
    trunk/installdeps.ubuntu.sh

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Mon Feb  2 22:24:01 2009
@@ -10,7 +10,7 @@
 echo cd ogrenew
 echo aclocal
 echo ./bootstrap
-echo ./configure CXXFLAGS=3D\"-DNDEBUG=3D1\"       =

+echo ./configure --enable-cg CXXFLAGS=3D\"-DNDEBUG=3D1\"       =

 echo make
 echo sudo make install
 echo    add a line \"/usr/local/lib\" to /etc/ld.so.conf



From no-reply at zwischenwelt.org  Mon Feb  2 23:16:48 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 02 Feb 2009 22:16:48 -0000
Subject: [Iris-commit] [IRIS] r2898 - /trunk/premakelinux.sh
Message-ID: <20090202221648.CD9311C18853@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Feb  2 23:16:48 2009
New Revision: 2898

Log:
added make clean and notes

Modified:
    trunk/premakelinux.sh

Modified: trunk/premakelinux.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premakelinux.sh (original)
+++ trunk/premakelinux.sh Mon Feb  2 23:16:48 2009
@@ -14,8 +14,10 @@
 	./premake --noassert --target gnu
 fi
 =

-#  --useluajit
+#  --useluajit .. was supposed to work at least in 32 bit, but seems to ca=
use trouble with lua popen
+
 #~  old : -./premake --useluajit --noassert --target gnu && make CXX=3D"cc=
ache gcc" CONFIG=3DRelease
+# note : to clrea ccache : rm -rf ~/.ccache obj *.a
 =

-make -j${JOBS} CONFIG=3DRelease
+make clean && make -j${JOBS} CONFIG=3DRelease
 =




From no-reply at zwischenwelt.org  Sat Feb  7 01:07:19 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 07 Feb 2009 00:07:19 -0000
Subject: [Iris-commit] [IRIS] r2899 - in /trunk: lua/lib.mousepick.lua
 lua/main.lua plugins/moblist.lua premakelinux_noclean.sh
Message-ID: <20090207000719.673091C18860@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Feb  7 01:07:18 2009
New Revision: 2899

Log:
preparation for directx9 version error tipp

Modified:
    trunk/lua/lib.mousepick.lua
    trunk/lua/main.lua
    trunk/plugins/moblist.lua
    trunk/premakelinux_noclean.sh

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Sat Feb  7 01:07:18 2009
@@ -161,8 +161,7 @@
 		if (CompleteTargetMode()) then gbMouseLastLeftDownWasTarget =3D true end=
 -- see net/net.cursor.lua
 	else =

 		if (MobListSetMainTargetSerial) then
-			local serial =3D GetMouseHitSerial()
-			if (serial and GetMobile(serial)) then MobListSetMainTargetSerial(seria=
l) end
+			MobListSetMainTargetSerial(GetMouseHitSerial())
 		end
 	end
 end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Feb  7 01:07:18 2009
@@ -251,7 +251,9 @@
 	end
 =

 	--~ OgreAddResLoc(kObjTypePreviewDir.."."			,"FileSystem","General")
+	print("OgreInitResLocs...")
 	OgreInitResLocs()
+	print("OgreInitResLocs done")
 end
 =

 --###############################
@@ -319,8 +321,31 @@
 	end
 end
 =

+function LugreExceptionTipps (descr)
+	print("#################")
+	print("###  LugreExceptionTipps  ###")
+	print("#################")
+	print(descr)
+	print("#################")
+	if (StringContains(descr,"Could not load dynamic library") and StringCont=
ains(descr,"Direct3D9")) then =

+		local url =3D "http://download.microsoft.com/download/5/c/8/5c8b7216-bbc=
2-4215-8aa5-9dfef9cdb3df/directx_aug2008_redist.exe"
+		local tipp =3D	"Your DirectX9 version is too old to run Iris.\n"..
+						"Would you like to open a browser and download an Updated Version fr=
om the following url ?\n"..url
+		print(tipp)
+	end
+end
+
 --- main function, when it returns, the program ends
 function Main ()
+	--~ if (LugreMessageBox) then =

+		--~ print("LugreMessageBox defined")
+		--~ local res =3D LugreMessageBox(kLugreMessageBoxType_YesNo,"Update Dir=
ectX9","blaa, tollertipp")
+		--~ if (res =3D=3D kLugreMessageBoxResult_Yes) then
+		=

+		--~ end
+		=

+	--~ end
+		=

 	gRegistry =3D cRegistry:New(gTempPath.."global.reg")
 =

 	-- detect UOPath
@@ -333,6 +358,7 @@
 	TestUOAM()
 	local luaversion =3D string.sub(_VERSION, 5, 7)
 	print("Lua version : "..luaversion)
+	print("Ogre platform : "..OGRE_PLATFORM)
 	=

 	HandleCommandLine()
 	=

@@ -354,10 +380,12 @@
 	LoadingProfile("initializing Ogre",true)
 	if (SetOgreInputOptions) then SetOgreInputOptions(gbHideMouse,gbGrabInput=
) end
 	gPreOgreTime =3D gLoadingProfileLastTime
+	print("initializing ogre...")
 	if (not gNoOgre) then
 		if (not InitOgre("Iris2",gOgrePluginPathOverride or lugre_detect_ogre_pl=
ugin_path(),"../bin/")) then Exit() end
 		CollectOgreResLocs()
 	end
+	print("initializing ogre done")
 	SetCursorBaseOffset(0,0)
 	if (MyArtDebug) then MyArtDebug() end
 	=


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Sat Feb  7 01:07:18 2009
@@ -193,6 +193,7 @@
 =

 function gWidgetPrototype.UOMobList:SetMainTarget (serial,name)
 	if (serial =3D=3D 0 or serial =3D=3D GetPlayerSerial() or serial =3D=3D s=
elf.maintarget_serial) then serial =3D nil end
+	if (serial and (not IsOrWasMobile(serial))) then return end
 	self.maintarget_serial =3D serial
 	self:UpdateMainTargetListMarker()
 	--~ print("UOMobList:SetMainTarget",serial,name)

Modified: trunk/premakelinux_noclean.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premakelinux_noclean.sh (original)
+++ trunk/premakelinux_noclean.sh Sat Feb  7 01:07:18 2009
@@ -1,4 +1,23 @@
 #!/bin/bash
-./premake --noassert --openalsoft --target gnu && make CXX=3D"ccache gcc" =
CONFIG=3DRelease
-#~ ./premake --target gnu && make CONFIG=3DRelease
-# tipp : try "make -j 2" : start 2 jobs in parallel, to avoid wait-for-io =
and use multi-cpu processors efficiently during compile
+
+# use multi-core/multi-processor correctly
+JOBS=3D$(($(grep -c 'processor' /proc/cpuinfo) + 1))
+
+echo ${JOBS}
+if [ "$(uname -m)" =3D=3D "x86_64" ]; # luajit doesn't work on 64 bit
+then
+	./premake --noassert --target gnu
+else
+	./premake --noassert --target gnu
+fi
+
+# make CXX=3D"ccache gcc"
+#  --useluajit .. was supposed to work at least in 32 bit, but seems to ca=
use trouble with lua popen
+
+#~  old : -./premake --useluajit --noassert --target gnu && make CXX=3D"cc=
ache gcc" CONFIG=3DRelease
+# note : to clrea ccache : rm -rf ~/.ccache obj *.a
+
+make -j${JOBS} CONFIG=3DRelease
+
+
+



From no-reply at zwischenwelt.org  Sat Feb  7 15:21:20 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 07 Feb 2009 14:21:20 -0000
Subject: [Iris-commit] [IRIS] r2900 - in /trunk: config/ config/shards/ lua/
	lua/net/
Message-ID: <20090207142120.761481C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Feb  7 15:21:20 2009
New Revision: 2900

Log:
added support for uo protocol changes in clientversion 6.0.1.7 , so now the=
 client version can be set beyond that without crashing, current default is=
 6.0.9.2.  started work on shardlist internal redesign.

Added:
    trunk/config/shards/
    trunk/lua/lib.shardlist.lua
Modified:
    trunk/config/   (props changed)
    trunk/lua/config_declarations.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.packet.lua
    trunk/lua/lib.protocol.lua
    trunk/lua/lib.razorpacketvideo.lua
    trunk/lua/lib.xml.lua
    trunk/lua/main.lua
    trunk/lua/net/net.dynamic.lua
    trunk/lua/net/net.other.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sat Feb  7 15:21:20 2009
@@ -16,7 +16,11 @@
 ]]--
 =

 gConfig:DeclareFloat("kGuiToolTipWait", "gui", "tooltip timeout", "TODO", =
100)
-gConfig:DeclareString("gClientVersion", "protocol", "client version", 'Cli=
ent Identification String (try other version for example "4.0.11c5")', "6.0=
.1.6")
+
+
+
+gConfig:DeclareString("gClientVersion", "protocol", "client version", 'Cli=
ent Identification String (try other version for example "4.0.11c5")', "6.0=
.9.2") -- old was 6.0.1.6, but the protocol changes in 6017 are supported n=
ow =3D)
+
 =

 -- Camera Rotation - Input stuff use: "mouse1", "mouse2" or "mouse3"
 gInput_CamMouseButton =3D GetNamedKey("mouse3")
@@ -141,6 +145,10 @@
 -- Server Emulator Configuration
 --------------------------------
 gShardList =3D {}
+
+
+--~ preset shards now loaded from config/shards/*.xml
+
 gShardList["localhost"] =3D {
 		gLoginname =3D "admin",	-- Loginname
 		gPassword =3D "admin",	-- Password
@@ -197,14 +205,7 @@
 		gServerSeed =3D hex2num("0xFFFFFFFF"),
 		gPolServer =3D false
 	}
-
-gShardList["# - Offline Mode"] =3D { =

-		gStartGameWithoutNetwork =3D true
-	}
-
-gShardList["# - Debug Mode"] =3D { =

-		gStartInDebugMode =3D true
-	}
+--~ ]]--
 =

 -- in config.lua you can add shards like this: 	=

 -- gShardList["myshard"] =3D { ..... } =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sat Feb  7 15:21:20 2009
@@ -375,6 +375,8 @@
 				return
 		end
 	end -- connect to shard
+	=

+	LoadShardList()
 =

 	-- start menu sound
 	SoundPlayMusicById(8)
@@ -399,6 +401,14 @@
 		table.insert(rows,{ {type=3D"Button",	onLeftClick=3Dfun,shard=3Dshard,sh=
ardname=3Dshardname,text=3DGetShardButtonText(shard,shardname)} })
 	end
 =

+	=

+	local shardname,shard =3D "# - Offline Mode",{gStartGameWithoutNetwork =
=3D true}
+		table.insert(rows,{ {type=3D"Button",	onLeftClick=3Dfun,shard=3Dshard,sh=
ardname=3Dshardname,text=3DGetShardButtonText(shard,shardname)} })
+	local shardname,shard =3D "# - Debug Mode",{gStartInDebugMode =3D true}
+		table.insert(rows,{ {type=3D"Button",	onLeftClick=3Dfun,shard=3Dshard,sh=
ardname=3Dshardname,text=3DGetShardButtonText(shard,shardname)} })
+
+	=

+	=

 	table.insert(rows,{ {type=3D"Button",text=3D"# - Graphic Options",onLeftC=
lick=3Dfunction ()
 		StopMainMenu()
 		if (Client_ShowOgreConfig()) then

Modified: trunk/lua/lib.packet.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packet.lua (original)
+++ trunk/lua/lib.packet.lua Sat Feb  7 15:21:20 2009
@@ -1,243 +1,267 @@
-gPacketType.kPacket_CharacterCreation 								=3D { id=3D0x00 }
-gPacketType.kPacket_Logout					 						=3D { id=3D0x01 }
-gPacketType.kPacket_Request_Movement								=3D { id=3D0x02 }
-gPacketType.kPacket_Speech											=3D { id=3D0x03 }
-gPacketType.kPacket_Request_God_Mode								=3D { id=3D0x04 }
-gPacketType.kPacket_Attack											=3D { id=3D0x05 }
-gPacketType.kPacket_Double_Click									=3D { id=3D0x06 }
-gPacketType.kPacket_Take_Object										=3D { id=3D0x07 }
-gPacketType.kPacket_Drop_Object										=3D { id=3D0x08 }
-gPacketType.kPacket_Single_Click									=3D { id=3D0x09 }
-gPacketType.kPacket_Edit											=3D { id=3D0x0A }
-gPacketType.kPacket_Damage											=3D { id=3D0x0B }
-gPacketType.kPacket_Tile_Data										=3D { id=3D0x0C }
-gPacketType.kPacket_NPC_Data										=3D { id=3D0x0D }
-gPacketType.kPacket_Edit_Template_Data								=3D { id=3D0x0E }
-gPacketType.kPacket_Paperdoll_Old									=3D { id=3D0x0F }
-gPacketType.kPacket_Hue_Data										=3D { id=3D0x10 }
-gPacketType.kPacket_Mobile_Stats									=3D { id=3D0x11 }
-gPacketType.kPacket_Request_SkillOrSpell							=3D { id=3D0x12 }
-gPacketType.kPacket_Equip_Item_Request								=3D { id=3D0x13 }
-gPacketType.kPacket_Change_Elevation								=3D { id=3D0x14 }
-gPacketType.kPacket_Follow											=3D { id=3D0x15 }
-gPacketType.kPacket_Request_Script_Names							=3D { id=3D0x16 }
-gPacketType.kPacket_Script_Tree_Command								=3D { id=3D0x17 }
-gPacketType.kPacket_Script_Attach									=3D { id=3D0x18 }
-gPacketType.kPacket_NPC_Conversation_Data							=3D { id=3D0x19 }
-gPacketType.kPacket_Show_Item										=3D { id=3D0x1A }
-gPacketType.kPacket_Login_Confirm									=3D { id=3D0x1B }
-gPacketType.kPacket_Text											=3D { id=3D0x1C }
-gPacketType.kPacket_Destroy											=3D { id=3D0x1D }
-gPacketType.kPacket_Animate											=3D { id=3D0x1E }
-gPacketType.kPacket_Explode											=3D { id=3D0x1F }
-
-gPacketType.kPacket_Teleport										=3D { id=3D0x20 }
-gPacketType.kPacket_Block_Movement									=3D { id=3D0x21 }
-gPacketType.kPacket_Accept_Movement_Resync_Request					=3D { id=3D0x22 }
-gPacketType.kPacket_Drag_Item										=3D { id=3D0x23 }
-gPacketType.kPacket_Open_Container									=3D { id=3D0x24 }
-gPacketType.kPacket_Object_to_Object								=3D { id=3D0x25 }
-gPacketType.kPacket_Old_Client										=3D { id=3D0x26 }
-gPacketType.kPacket_Get_Item_Failed									=3D { id=3D0x27 }
-gPacketType.kPacket_Drop_Item_Failed								=3D { id=3D0x28 }
-gPacketType.kPacket_Drop_Item_OK									=3D { id=3D0x29 }
-gPacketType.kPacket_Blood											=3D { id=3D0x2A }
-gPacketType.kPacket_God_Mode										=3D { id=3D0x2B }
-gPacketType.kPacket_Death											=3D { id=3D0x2C }
-gPacketType.kPacket_Health											=3D { id=3D0x2D }
-gPacketType.kPacket_Equip_Item										=3D { id=3D0x2E }
-gPacketType.kPacket_Swing											=3D { id=3D0x2F }
-
-gPacketType.kPacket_Attack_OK										=3D { id=3D0x30 }
-gPacketType.kPacket_Attack_End										=3D { id=3D0x31 }
-gPacketType.kPacket_Hack_Mover										=3D { id=3D0x32 }
-gPacketType.kPacket_Group											=3D { id=3D0x33 }
-gPacketType.kPacket_Client_Query									=3D { id=3D0x34 }
-gPacketType.kPacket_Resource_Type									=3D { id=3D0x35 }
-gPacketType.kPacket_Resource_Tile_Data								=3D { id=3D0x36 }
-gPacketType.kPacket_Move_Object										=3D { id=3D0x37 }
-gPacketType.kPacket_Follow_Move										=3D { id=3D0x38 }
-gPacketType.kPacket_Groups											=3D { id=3D0x39 }
-gPacketType.kPacket_Skills											=3D { id=3D0x3A }
-gPacketType.kPacket_Accept_Offer									=3D { id=3D0x3B }
-gPacketType.kPacket_Container_Contents								=3D { id=3D0x3C }
-gPacketType.kPacket_Ship											=3D { id=3D0x3D }
-gPacketType.kPacket_Versions										=3D { id=3D0x3E }
-gPacketType.kPacket_Update_Statics									=3D { id=3D0x3F }
-
-gPacketType.kPacket_Update_Terrain									=3D { id=3D0x40 }
-gPacketType.kPacket_Update_Tiledata									=3D { id=3D0x41 }
-gPacketType.kPacket_Update_Art										=3D { id=3D0x42 }
-gPacketType.kPacket_Update_Anim										=3D { id=3D0x43 }
-gPacketType.kPacket_Update_Hues										=3D { id=3D0x44 }
-gPacketType.kPacket_Ver_OK											=3D { id=3D0x45 }
-gPacketType.kPacket_New_Art											=3D { id=3D0x46 }
-gPacketType.kPacket_New_Terrain										=3D { id=3D0x47 }
-gPacketType.kPacket_New_Anim										=3D { id=3D0x48 }
-gPacketType.kPacket_New_Hues										=3D { id=3D0x49 }
-gPacketType.kPacket_Destroy_Art										=3D { id=3D0x4A }
-gPacketType.kPacket_Check_Ver										=3D { id=3D0x4B }
-gPacketType.kPacket_Script_Names									=3D { id=3D0x4C }
-gPacketType.kPacket_Script_File										=3D { id=3D0x4D }
-gPacketType.kPacket_Light_Change									=3D { id=3D0x4E }
-gPacketType.kPacket_Sunlight										=3D { id=3D0x4F }
-
-gPacketType.kPacket_Board_Header									=3D { id=3D0x50 }
-gPacketType.kPacket_Board_Message									=3D { id=3D0x51 }
-gPacketType.kPacket_Post_Message									=3D { id=3D0x52 }
-gPacketType.kPacket_Login_Reject									=3D { id=3D0x53 }
-gPacketType.kPacket_Sound											=3D { id=3D0x54 }
-gPacketType.kPacket_Login_Complete									=3D { id=3D0x55 }
-gPacketType.kPacket_Map_Command										=3D { id=3D0x56 }
-gPacketType.kPacket_Update_Regions									=3D { id=3D0x57 }
-gPacketType.kPacket_New_Region										=3D { id=3D0x58 }
-gPacketType.kPacket_New_Context_FX									=3D { id=3D0x59 }
-gPacketType.kPacket_Update_Context_FX								=3D { id=3D0x5A }
-gPacketType.kPacket_Game_Time										=3D { id=3D0x5B }
-gPacketType.kPacket_Restart_Ver										=3D { id=3D0x5C }
-gPacketType.kPacket_Pre_Login										=3D { id=3D0x5D }
-gPacketType.kPacket_Server_List2									=3D { id=3D0x5E }
-gPacketType.kPacket_Add_Server										=3D { id=3D0x5F }
-
-gPacketType.kPacket_Server_Remove									=3D { id=3D0x60 }
-gPacketType.kPacket_Destroy_Static									=3D { id=3D0x61 }
-gPacketType.kPacket_Move_Static										=3D { id=3D0x62 }
-gPacketType.kPacket_Area_Load										=3D { id=3D0x63 }
-gPacketType.kPacket_Area_Load_Request								=3D { id=3D0x64 }
-gPacketType.kPacket_Weather_Change									=3D { id=3D0x65 }
-gPacketType.kPacket_Book_Contents									=3D { id=3D0x66 }
-gPacketType.kPacket_Simple_Edit										=3D { id=3D0x67 }
-gPacketType.kPacket_Script_LS_Attach								=3D { id=3D0x68 }
-gPacketType.kPacket_Friends											=3D { id=3D0x69 }
-gPacketType.kPacket_Friend_Notify									=3D { id=3D0x6A }
-gPacketType.kPacket_Key_Use											=3D { id=3D0x6B }
-gPacketType.kPacket_Target											=3D { id=3D0x6C }
-gPacketType.kPacket_Music											=3D { id=3D0x6D }
-gPacketType.kPacket_Animation										=3D { id=3D0x6E }
-gPacketType.kPacket_SecureTrade										=3D { id=3D0x6F }
-
-gPacketType.kPacket_Effect											=3D { id=3D0x70 }
-gPacketType.kPacket_Bulletin_Board									=3D { id=3D0x71 }
-gPacketType.kPacket_SetPlayerWarmode								=3D { id=3D0x72 }
-gPacketType.kPacket_Ping											=3D { id=3D0x73 }
-gPacketType.kPacket_Shop_Data										=3D { id=3D0x74 }
-gPacketType.kPacket_Rename_MOB										=3D { id=3D0x75 }
-gPacketType.kPacket_Server_Change									=3D { id=3D0x76 }
-gPacketType.kPacket_Naked_MOB										=3D { id=3D0x77 }
-gPacketType.kPacket_Equipped_MOB									=3D { id=3D0x78 }
-gPacketType.kPacket_Resource_Query									=3D { id=3D0x79 }
-gPacketType.kPacket_Resource_Data									=3D { id=3D0x7A }
-gPacketType.kPacket_Sequence										=3D { id=3D0x7B }
-gPacketType.kPacket_Object_Picker									=3D { id=3D0x7C }
-gPacketType.kPacket_Picked_Object									=3D { id=3D0x7D }
-gPacketType.kPacket_God_View_Query									=3D { id=3D0x7E }
-gPacketType.kPacket_God_View_Data									=3D { id=3D0x7F }
-
-gPacketType.kPacket_Account_Login_Request							=3D { id=3D0x80 }
-gPacketType.kPacket_Account_Login_OK								=3D { id=3D0x81 }
-gPacketType.kPacket_Account_Login_Failed							=3D { id=3D0x82 }
-gPacketType.kPacket_Account_Delete_Character						=3D { id=3D0x83 }
-gPacketType.kPacket_Change_Character_Password						=3D { id=3D0x84 }
-gPacketType.kPacket_Delete_Character_Failed							=3D { id=3D0x85 }
-gPacketType.kPacket_All_Characters									=3D { id=3D0x86 }
-gPacketType.kPacket_Send_Resources									=3D { id=3D0x87 }
-gPacketType.kPacket_Open_Paperdoll									=3D { id=3D0x88 }
-gPacketType.kPacket_Corpse_Equipment								=3D { id=3D0x89 }
-gPacketType.kPacket_Trigger_Edit									=3D { id=3D0x8A }
-gPacketType.kPacket_Display_Sign									=3D { id=3D0x8B }
-gPacketType.kPacket_Server_Redirect									=3D { id=3D0x8C }
-gPacketType.kPacket_KR_CharacterCreation							=3D { id=3D0x8D }
-gPacketType.kPacket_Move_Character									=3D { id=3D0x8E }
-gPacketType.kPacket_Unused4											=3D { id=3D0x8F }
-
-gPacketType.kPacket_Open_Course_Gump								=3D { id=3D0x90 }
-gPacketType.kPacket_Post_Login										=3D { id=3D0x91 }
-gPacketType.kPacket_Update_Multi									=3D { id=3D0x92 }
-gPacketType.kPacket_Book_Header										=3D { id=3D0x93 }
-gPacketType.kPacket_Update_Skill									=3D { id=3D0x94 }
-gPacketType.kPacket_Hue_Picker										=3D { id=3D0x95 }
-gPacketType.kPacket_Game_Central_Monitor							=3D { id=3D0x96 }
-gPacketType.kPacket_Move_Player										=3D { id=3D0x97 }
-gPacketType.kPacket_MOB_Name										=3D { id=3D0x98 }
-gPacketType.kPacket_Target_Multi									=3D { id=3D0x99 }
-gPacketType.kPacket_Text_Entry										=3D { id=3D0x9A }
-gPacketType.kPacket_Request_Assistance								=3D { id=3D0x9B }
-gPacketType.kPacket_Assist_Request									=3D { id=3D0x9C }
-gPacketType.kPacket_GM_Single										=3D { id=3D0x9D }
-gPacketType.kPacket_Shop_Sell										=3D { id=3D0x9E }
-gPacketType.kPacket_Shop_Offer										=3D { id=3D0x9F }
-
-gPacketType.kPacket_Server_Select									=3D { id=3D0xA0 }
-gPacketType.kPacket_HP_Health										=3D { id=3D0xA1 }
-gPacketType.kPacket_Mana_Health										=3D { id=3D0xA2 }
-gPacketType.kPacket_Stamina											=3D { id=3D0xA3 }
-gPacketType.kPacket_Hardware_Info									=3D { id=3D0xA4 }
-gPacketType.kPacket_Web_Browser										=3D { id=3D0xA5 }
-gPacketType.kPacket_Message											=3D { id=3D0xA6 }	--Tips/Notice wind=
ow
-gPacketType.kPacket_Request_Tip										=3D { id=3D0xA7 }
-gPacketType.kPacket_Server_List										=3D { id=3D0xA8 } =

-gPacketType.kPacket_Character_List									=3D { id=3D0xA9 }
-gPacketType.kPacket_Current_Target									=3D { id=3D0xAA }
-gPacketType.kPacket_String_Query									=3D { id=3D0xAB }
-gPacketType.kPacket_String_Response									=3D { id=3D0xAC }
-gPacketType.kPacket_Speech_Unicode									=3D { id=3D0xAD }
-gPacketType.kPacket_Text_Unicode									=3D { id=3D0xAE }
-gPacketType.kPacket_Death_Animation									=3D { id=3D0xAF }
-
-gPacketType.kPacket_Generic_Gump									=3D { id=3D0xB0 }
-gPacketType.kPacket_Generic_Gump_Trigger							=3D { id=3D0xB1 }
-gPacketType.kPacket_Chat_Message									=3D { id=3D0xB2 }
-gPacketType.kPacket_Chat_Text										=3D { id=3D0xB3 }
-gPacketType.kPacket_Target_Object_List								=3D { id=3D0xB4 }
-gPacketType.kPacket_Open_Chat										=3D { id=3D0xB5 }
-gPacketType.kPacket_Help_Request									=3D { id=3D0xB6 }
-gPacketType.kPacket_Help_Text										=3D { id=3D0xB7 }
-gPacketType.kPacket_Character_Profile								=3D { id=3D0xB8 }
-gPacketType.kPacket_Features										=3D { id=3D0xB9 }
-gPacketType.kPacket_TrackingArrow									=3D { id=3D0xBA }
-gPacketType.kPacket_Account_ID										=3D { id=3D0xBB }
-gPacketType.kPacket_Game_Season										=3D { id=3D0xBC }
-gPacketType.kPacket_Client_Version									=3D { id=3D0xBD }
-gPacketType.kPacket_Assist_Version									=3D { id=3D0xBE }
-gPacketType.kPacket_Generic_Command									=3D { id=3D0xBF }
-
-gPacketType.kPacket_Hued_FX											=3D { id=3D0xC0 }
-gPacketType.kPacket_Localized_Text									=3D { id=3D0xC1 }
-gPacketType.kPacket_Unicode_Text_Entry								=3D { id=3D0xC2 }
-gPacketType.kPacket_Global_Queue									=3D { id=3D0xC3 }
-gPacketType.kPacket_Semivisible										=3D { id=3D0xC4 }
-gPacketType.kPacket_Invalid_Map										=3D { id=3D0xC5 }
-gPacketType.kPacket_Invalid_Map_Enable								=3D { id=3D0xC6 }
-gPacketType.kPacket_Particle_Effect									=3D { id=3D0xC7 }
-gPacketType.kPacket_Change_Update_Range								=3D { id=3D0xC8 }
-gPacketType.kPacket_Trip_Time										=3D { id=3D0xC9 }
-gPacketType.kPacket_UTrip_Time										=3D { id=3D0xCA }
-gPacketType.kPacket_Global_Queue_Count								=3D { id=3D0xCB }
-gPacketType.kPacket_Localized_Text_Plus_String						=3D { id=3D0xCC }
-gPacketType.kPacket_Unknown_God_Packet								=3D { id=3D0xCD }
-gPacketType.kPacket_IGR_Client										=3D { id=3D0xCE }
-gPacketType.kPacket_IGR_Login										=3D { id=3D0xCF }
-
-gPacketType.kPacket_IGR_Configuration								=3D { id=3D0xD0 }
-gPacketType.kPacket_IGR_Logout										=3D { id=3D0xD1 }
-gPacketType.kPacket_Update_Mobile									=3D { id=3D0xD2 }
-gPacketType.kPacket_Show_Mobile										=3D { id=3D0xD3 }
-gPacketType.kPacket_Book_Info										=3D { id=3D0xD4 }
-gPacketType.kPacket_Unknown_Client_Packet							=3D { id=3D0xD5 }
-gPacketType.kPacket_Mega_Cliloc										=3D { id=3D0xD6 }
-gPacketType.kPacket_AOS_Command										=3D { id=3D0xD7 }
-gPacketType.kPacket_Custom_House									=3D { id=3D0xD8 }
-gPacketType.kPacket_Metrics											=3D { id=3D0xD9 }
-gPacketType.kPacket_Mahjong											=3D { id=3D0xDA }
-gPacketType.kPacket_Character_Transfer_Log							=3D { id=3D0xDB }
-gPacketType.kPacket_AOSObjProp										=3D { id=3D0xDC } -- size was not =
in necro list
+gPacketType =3D {}
+
+gPacketType.kPacket_CharacterCreation 								=3D { id=3D0x00, size=3D104 }
+gPacketType.kPacket_Logout					 						=3D { id=3D0x01, size=3D5 }
+gPacketType.kPacket_Request_Movement								=3D { id=3D0x02, size=3D7 }
+gPacketType.kPacket_Speech											=3D { id=3D0x03, size=3D0 }
+gPacketType.kPacket_Request_God_Mode								=3D { id=3D0x04, size=3D2 }
+gPacketType.kPacket_Attack											=3D { id=3D0x05, size=3D5 }
+gPacketType.kPacket_Double_Click									=3D { id=3D0x06, size=3D5 }
+gPacketType.kPacket_Take_Object										=3D { id=3D0x07, size=3D7 }
+gPacketType.kPacket_Drop_Object										=3D { id=3D0x08, size=3D14 }
+gPacketType.kPacket_Single_Click									=3D { id=3D0x09, size=3D5 }
+gPacketType.kPacket_Edit											=3D { id=3D0x0A, size=3D11 }
+gPacketType.kPacket_Damage											=3D { id=3D0x0B, size=3D7 }
+gPacketType.kPacket_Tile_Data										=3D { id=3D0x0C, size=3D0 }
+gPacketType.kPacket_NPC_Data										=3D { id=3D0x0D, size=3D3 }
+gPacketType.kPacket_Edit_Template_Data								=3D { id=3D0x0E, size=3D0 }
+gPacketType.kPacket_Paperdoll_Old									=3D { id=3D0x0F, size=3D61 }
+gPacketType.kPacket_Hue_Data										=3D { id=3D0x10, size=3D215 }
+gPacketType.kPacket_Mobile_Stats									=3D { id=3D0x11, size=3D0 }
+gPacketType.kPacket_Request_SkillOrSpell							=3D { id=3D0x12, size=3D0 }
+gPacketType.kPacket_Equip_Item_Request								=3D { id=3D0x13, size=3D10 }
+gPacketType.kPacket_Change_Elevation								=3D { id=3D0x14, size=3D6 }
+gPacketType.kPacket_Follow											=3D { id=3D0x15, size=3D9 }
+gPacketType.kPacket_Request_Script_Names							=3D { id=3D0x16, size=3D1 }
+gPacketType.kPacket_Script_Tree_Command								=3D { id=3D0x17, size=3D0 }
+gPacketType.kPacket_Script_Attach									=3D { id=3D0x18, size=3D0 }
+gPacketType.kPacket_NPC_Conversation_Data							=3D { id=3D0x19, size=3D0 }
+gPacketType.kPacket_Show_Item										=3D { id=3D0x1A, size=3D0 }
+gPacketType.kPacket_Login_Confirm									=3D { id=3D0x1B, size=3D37 }
+gPacketType.kPacket_Text											=3D { id=3D0x1C, size=3D0 }
+gPacketType.kPacket_Destroy											=3D { id=3D0x1D, size=3D5 }
+gPacketType.kPacket_Animate											=3D { id=3D0x1E, size=3D4 }
+gPacketType.kPacket_Explode											=3D { id=3D0x1F, size=3D8 }
+
+gPacketType.kPacket_Teleport										=3D { id=3D0x20, size=3D19 }
+gPacketType.kPacket_Block_Movement									=3D { id=3D0x21, size=3D8 }
+gPacketType.kPacket_Accept_Movement_Resync_Request					=3D { id=3D0x22, si=
ze=3D3 }
+gPacketType.kPacket_Drag_Item										=3D { id=3D0x23, size=3D26 }
+gPacketType.kPacket_Open_Container									=3D { id=3D0x24, size=3D7 }
+gPacketType.kPacket_Object_to_Object								=3D { id=3D0x25, size=3D20 }
+gPacketType.kPacket_Old_Client										=3D { id=3D0x26, size=3D5 }
+gPacketType.kPacket_Get_Item_Failed									=3D { id=3D0x27, size=3D2 }
+gPacketType.kPacket_Drop_Item_Failed								=3D { id=3D0x28, size=3D5 }
+gPacketType.kPacket_Drop_Item_OK									=3D { id=3D0x29, size=3D1 }
+gPacketType.kPacket_Blood											=3D { id=3D0x2A, size=3D5 }
+gPacketType.kPacket_God_Mode										=3D { id=3D0x2B, size=3D2 }
+gPacketType.kPacket_Death											=3D { id=3D0x2C, size=3D2 }
+gPacketType.kPacket_Health											=3D { id=3D0x2D, size=3D17 }
+gPacketType.kPacket_Equip_Item										=3D { id=3D0x2E, size=3D15 }
+gPacketType.kPacket_Swing											=3D { id=3D0x2F, size=3D10 }
+
+gPacketType.kPacket_Attack_OK										=3D { id=3D0x30, size=3D5 }
+gPacketType.kPacket_Attack_End										=3D { id=3D0x31, size=3D1 }
+gPacketType.kPacket_Hack_Mover										=3D { id=3D0x32, size=3D2 }
+gPacketType.kPacket_Group											=3D { id=3D0x33, size=3D2 }
+gPacketType.kPacket_Client_Query									=3D { id=3D0x34, size=3D10 }
+gPacketType.kPacket_Resource_Type									=3D { id=3D0x35, size=3D653 }
+gPacketType.kPacket_Resource_Tile_Data								=3D { id=3D0x36, size=3D0 }
+gPacketType.kPacket_Move_Object										=3D { id=3D0x37, size=3D8 }
+gPacketType.kPacket_Follow_Move										=3D { id=3D0x38, size=3D7 }
+gPacketType.kPacket_Groups											=3D { id=3D0x39, size=3D9 }
+gPacketType.kPacket_Skills											=3D { id=3D0x3A, size=3D0 }
+gPacketType.kPacket_Accept_Offer									=3D { id=3D0x3B, size=3D0 }
+gPacketType.kPacket_Container_Contents								=3D { id=3D0x3C, size=3D0 }
+gPacketType.kPacket_Ship											=3D { id=3D0x3D, size=3D2 }
+gPacketType.kPacket_Versions										=3D { id=3D0x3E, size=3D37 }
+gPacketType.kPacket_Update_Statics									=3D { id=3D0x3F, size=3D0 }
+
+gPacketType.kPacket_Update_Terrain									=3D { id=3D0x40, size=3D201 }
+gPacketType.kPacket_Update_Tiledata									=3D { id=3D0x41, size=3D0 }
+gPacketType.kPacket_Update_Art										=3D { id=3D0x42, size=3D0 }
+gPacketType.kPacket_Update_Anim										=3D { id=3D0x43, size=3D553 }
+gPacketType.kPacket_Update_Hues										=3D { id=3D0x44, size=3D713 }
+gPacketType.kPacket_Ver_OK											=3D { id=3D0x45, size=3D5 }
+gPacketType.kPacket_New_Art											=3D { id=3D0x46, size=3D0 }
+gPacketType.kPacket_New_Terrain										=3D { id=3D0x47, size=3D11 }
+gPacketType.kPacket_New_Anim										=3D { id=3D0x48, size=3D73 }
+gPacketType.kPacket_New_Hues										=3D { id=3D0x49, size=3D93 }
+gPacketType.kPacket_Destroy_Art										=3D { id=3D0x4A, size=3D5 }
+gPacketType.kPacket_Check_Ver										=3D { id=3D0x4B, size=3D9 }
+gPacketType.kPacket_Script_Names									=3D { id=3D0x4C, size=3D0 }
+gPacketType.kPacket_Script_File										=3D { id=3D0x4D, size=3D0 }
+gPacketType.kPacket_Light_Change									=3D { id=3D0x4E, size=3D6 }
+gPacketType.kPacket_Sunlight										=3D { id=3D0x4F, size=3D2 }
+
+gPacketType.kPacket_Board_Header									=3D { id=3D0x50, size=3D0 }
+gPacketType.kPacket_Board_Message									=3D { id=3D0x51, size=3D0 }
+gPacketType.kPacket_Post_Message									=3D { id=3D0x52, size=3D0 }
+gPacketType.kPacket_Login_Reject									=3D { id=3D0x53, size=3D2 }
+gPacketType.kPacket_Sound											=3D { id=3D0x54, size=3D12 }
+gPacketType.kPacket_Login_Complete									=3D { id=3D0x55, size=3D1 }
+gPacketType.kPacket_Map_Command										=3D { id=3D0x56, size=3D11 }
+gPacketType.kPacket_Update_Regions									=3D { id=3D0x57, size=3D110 }
+gPacketType.kPacket_New_Region										=3D { id=3D0x58, size=3D106 }
+gPacketType.kPacket_New_Context_FX									=3D { id=3D0x59, size=3D0 }
+gPacketType.kPacket_Update_Context_FX								=3D { id=3D0x5A, size=3D0 }
+gPacketType.kPacket_Game_Time										=3D { id=3D0x5B, size=3D4 }
+gPacketType.kPacket_Restart_Ver										=3D { id=3D0x5C, size=3D2 }
+gPacketType.kPacket_Pre_Login										=3D { id=3D0x5D, size=3D73 }
+gPacketType.kPacket_Server_List2									=3D { id=3D0x5E, size=3D0 }
+gPacketType.kPacket_Add_Server										=3D { id=3D0x5F, size=3D49 }
+
+gPacketType.kPacket_Server_Remove									=3D { id=3D0x60, size=3D5 }
+gPacketType.kPacket_Destroy_Static									=3D { id=3D0x61, size=3D9 }
+gPacketType.kPacket_Move_Static										=3D { id=3D0x62, size=3D15 }
+gPacketType.kPacket_Area_Load										=3D { id=3D0x63, size=3D13 }
+gPacketType.kPacket_Area_Load_Request								=3D { id=3D0x64, size=3D1 }
+gPacketType.kPacket_Weather_Change									=3D { id=3D0x65, size=3D4 }
+gPacketType.kPacket_Book_Contents									=3D { id=3D0x66, size=3D0 }
+gPacketType.kPacket_Simple_Edit										=3D { id=3D0x67, size=3D21 }
+gPacketType.kPacket_Script_LS_Attach								=3D { id=3D0x68, size=3D0 }
+gPacketType.kPacket_Friends											=3D { id=3D0x69, size=3D0 }
+gPacketType.kPacket_Friend_Notify									=3D { id=3D0x6A, size=3D3 }
+gPacketType.kPacket_Key_Use											=3D { id=3D0x6B, size=3D9 }
+gPacketType.kPacket_Target											=3D { id=3D0x6C, size=3D19 }
+gPacketType.kPacket_Music											=3D { id=3D0x6D, size=3D3 }
+gPacketType.kPacket_Animation										=3D { id=3D0x6E, size=3D14 }
+gPacketType.kPacket_SecureTrade										=3D { id=3D0x6F, size=3D0 }
+
+gPacketType.kPacket_Effect											=3D { id=3D0x70, size=3D28 }
+gPacketType.kPacket_Bulletin_Board									=3D { id=3D0x71, size=3D0 }
+gPacketType.kPacket_SetPlayerWarmode								=3D { id=3D0x72, size=3D5 }
+gPacketType.kPacket_Ping											=3D { id=3D0x73, size=3D2 }
+gPacketType.kPacket_Shop_Data										=3D { id=3D0x74, size=3D0 }
+gPacketType.kPacket_Rename_MOB										=3D { id=3D0x75, size=3D35 }
+gPacketType.kPacket_Server_Change									=3D { id=3D0x76, size=3D16 }
+gPacketType.kPacket_Naked_MOB										=3D { id=3D0x77, size=3D17 }
+gPacketType.kPacket_Equipped_MOB									=3D { id=3D0x78, size=3D0 }
+gPacketType.kPacket_Resource_Query									=3D { id=3D0x79, size=3D9 }
+gPacketType.kPacket_Resource_Data									=3D { id=3D0x7A, size=3D0 }
+gPacketType.kPacket_Sequence										=3D { id=3D0x7B, size=3D2 }
+gPacketType.kPacket_Object_Picker									=3D { id=3D0x7C, size=3D0 }
+gPacketType.kPacket_Picked_Object									=3D { id=3D0x7D, size=3D13 }
+gPacketType.kPacket_God_View_Query									=3D { id=3D0x7E, size=3D2 }
+gPacketType.kPacket_God_View_Data									=3D { id=3D0x7F, size=3D0 }
+
+gPacketType.kPacket_Account_Login_Request							=3D { id=3D0x80, size=3D62=
 }
+gPacketType.kPacket_Account_Login_OK								=3D { id=3D0x81, size=3D0 }
+gPacketType.kPacket_Account_Login_Failed							=3D { id=3D0x82, size=3D2 }
+gPacketType.kPacket_Account_Delete_Character						=3D { id=3D0x83, size=3D=
39 }
+gPacketType.kPacket_Change_Character_Password						=3D { id=3D0x84, size=
=3D69 }
+gPacketType.kPacket_Delete_Character_Failed							=3D { id=3D0x85, size=3D=
2 }
+gPacketType.kPacket_All_Characters									=3D { id=3D0x86, size=3D0 }
+gPacketType.kPacket_Send_Resources									=3D { id=3D0x87, size=3D0 }
+gPacketType.kPacket_Open_Paperdoll									=3D { id=3D0x88, size=3D66 }
+gPacketType.kPacket_Corpse_Equipment								=3D { id=3D0x89, size=3D0 }
+gPacketType.kPacket_Trigger_Edit									=3D { id=3D0x8A, size=3D0 }
+gPacketType.kPacket_Display_Sign									=3D { id=3D0x8B, size=3D0 }
+gPacketType.kPacket_Server_Redirect									=3D { id=3D0x8C, size=3D11 }
+gPacketType.kPacket_KR_CharacterCreation							=3D { id=3D0x8D, size=3D0 }
+gPacketType.kPacket_Move_Character									=3D { id=3D0x8E, size=3D0 }
+gPacketType.kPacket_Unused4											=3D { id=3D0x8F, size=3D0 }
+
+gPacketType.kPacket_Open_Course_Gump								=3D { id=3D0x90, size=3D19 }
+gPacketType.kPacket_Post_Login										=3D { id=3D0x91, size=3D65 }
+gPacketType.kPacket_Update_Multi									=3D { id=3D0x92, size=3D0 }
+gPacketType.kPacket_Book_Header										=3D { id=3D0x93, size=3D99 }
+gPacketType.kPacket_Update_Skill									=3D { id=3D0x94, size=3D0 }
+gPacketType.kPacket_Hue_Picker										=3D { id=3D0x95, size=3D9 }
+gPacketType.kPacket_Game_Central_Monitor							=3D { id=3D0x96, size=3D0 }
+gPacketType.kPacket_Move_Player										=3D { id=3D0x97, size=3D2 }
+gPacketType.kPacket_MOB_Name										=3D { id=3D0x98, size=3D0 }
+gPacketType.kPacket_Target_Multi									=3D { id=3D0x99, size=3D26 }
+gPacketType.kPacket_Text_Entry										=3D { id=3D0x9A, size=3D0 }
+gPacketType.kPacket_Request_Assistance								=3D { id=3D0x9B, size=3D258 }
+gPacketType.kPacket_Assist_Request									=3D { id=3D0x9C, size=3D309 }
+gPacketType.kPacket_GM_Single										=3D { id=3D0x9D, size=3D51 }
+gPacketType.kPacket_Shop_Sell										=3D { id=3D0x9E, size=3D0 }
+gPacketType.kPacket_Shop_Offer										=3D { id=3D0x9F, size=3D0 }
+
+gPacketType.kPacket_Server_Select									=3D { id=3D0xA0, size=3D3 }
+gPacketType.kPacket_HP_Health										=3D { id=3D0xA1, size=3D9 }
+gPacketType.kPacket_Mana_Health										=3D { id=3D0xA2, size=3D9 }
+gPacketType.kPacket_Stamina											=3D { id=3D0xA3, size=3D9 }
+gPacketType.kPacket_Hardware_Info									=3D { id=3D0xA4, size=3D149 }
+gPacketType.kPacket_Web_Browser										=3D { id=3D0xA5, size=3D0 }
+gPacketType.kPacket_Message											=3D { id=3D0xA6, size=3D0 }	--Tips/N=
otice window
+gPacketType.kPacket_Request_Tip										=3D { id=3D0xA7, size=3D4 }
+gPacketType.kPacket_Server_List										=3D { id=3D0xA8, size=3D0 } =

+gPacketType.kPacket_Character_List									=3D { id=3D0xA9, size=3D0 }
+gPacketType.kPacket_Current_Target									=3D { id=3D0xAA, size=3D5 }
+gPacketType.kPacket_String_Query									=3D { id=3D0xAB, size=3D0 }
+gPacketType.kPacket_String_Response									=3D { id=3D0xAC, size=3D0 }
+gPacketType.kPacket_Speech_Unicode									=3D { id=3D0xAD, size=3D0 }
+gPacketType.kPacket_Text_Unicode									=3D { id=3D0xAE, size=3D0 }
+gPacketType.kPacket_Death_Animation									=3D { id=3D0xAF, size=3D13 }
+
+gPacketType.kPacket_Generic_Gump									=3D { id=3D0xB0, size=3D0 }
+gPacketType.kPacket_Generic_Gump_Trigger							=3D { id=3D0xB1, size=3D0 }
+gPacketType.kPacket_Chat_Message									=3D { id=3D0xB2, size=3D0 }
+gPacketType.kPacket_Chat_Text										=3D { id=3D0xB3, size=3D0 }
+gPacketType.kPacket_Target_Object_List								=3D { id=3D0xB4, size=3D0 }
+gPacketType.kPacket_Open_Chat										=3D { id=3D0xB5, size=3D64 }
+gPacketType.kPacket_Help_Request									=3D { id=3D0xB6, size=3D9 }
+gPacketType.kPacket_Help_Text										=3D { id=3D0xB7, size=3D0 }
+gPacketType.kPacket_Character_Profile								=3D { id=3D0xB8, size=3D0 }
+gPacketType.kPacket_Features										=3D { id=3D0xB9, size=3D3 }
+gPacketType.kPacket_TrackingArrow									=3D { id=3D0xBA, size=3D6 }
+gPacketType.kPacket_Account_ID										=3D { id=3D0xBB, size=3D9 }
+gPacketType.kPacket_Game_Season										=3D { id=3D0xBC, size=3D3 }
+gPacketType.kPacket_Client_Version									=3D { id=3D0xBD, size=3D0 }
+gPacketType.kPacket_Assist_Version									=3D { id=3D0xBE, size=3D0 }
+gPacketType.kPacket_Generic_Command									=3D { id=3D0xBF, size=3D0 }
+
+gPacketType.kPacket_Hued_FX											=3D { id=3D0xC0, size=3D36 }
+gPacketType.kPacket_Localized_Text									=3D { id=3D0xC1, size=3D0 }
+gPacketType.kPacket_Unicode_Text_Entry								=3D { id=3D0xC2, size=3D0 }
+gPacketType.kPacket_Global_Queue									=3D { id=3D0xC3, size=3D0 }
+gPacketType.kPacket_Semivisible										=3D { id=3D0xC4, size=3D6 }
+gPacketType.kPacket_Invalid_Map										=3D { id=3D0xC5, size=3D203 }
+gPacketType.kPacket_Invalid_Map_Enable								=3D { id=3D0xC6, size=3D1 }
+gPacketType.kPacket_Particle_Effect									=3D { id=3D0xC7, size=3D49 }
+gPacketType.kPacket_Change_Update_Range								=3D { id=3D0xC8, size=3D2 }
+gPacketType.kPacket_Trip_Time										=3D { id=3D0xC9, size=3D6 }
+gPacketType.kPacket_UTrip_Time										=3D { id=3D0xCA, size=3D6 }
+gPacketType.kPacket_Global_Queue_Count								=3D { id=3D0xCB, size=3D7 }
+gPacketType.kPacket_Localized_Text_Plus_String						=3D { id=3D0xCC, size=
=3D0 }
+gPacketType.kPacket_Unknown_God_Packet								=3D { id=3D0xCD, size=3D1 }
+gPacketType.kPacket_IGR_Client										=3D { id=3D0xCE, size=3D0 }
+gPacketType.kPacket_IGR_Login										=3D { id=3D0xCF, size=3D78 }
+
+gPacketType.kPacket_IGR_Configuration								=3D { id=3D0xD0, size=3D0 }
+gPacketType.kPacket_IGR_Logout										=3D { id=3D0xD1, size=3D2 }
+gPacketType.kPacket_Update_Mobile									=3D { id=3D0xD2, size=3D25 }
+gPacketType.kPacket_Show_Mobile										=3D { id=3D0xD3, size=3D0 }
+gPacketType.kPacket_Book_Info										=3D { id=3D0xD4, size=3D0 }
+gPacketType.kPacket_Unknown_Client_Packet							=3D { id=3D0xD5, size=3D0 }
+gPacketType.kPacket_Mega_Cliloc										=3D { id=3D0xD6, size=3D0 }
+gPacketType.kPacket_AOS_Command										=3D { id=3D0xD7, size=3D0 }
+gPacketType.kPacket_Custom_House									=3D { id=3D0xD8, size=3D0 }
+gPacketType.kPacket_Metrics											=3D { id=3D0xD9, size=3D268 }
+gPacketType.kPacket_Mahjong											=3D { id=3D0xDA, size=3D0 }
+gPacketType.kPacket_Character_Transfer_Log							=3D { id=3D0xDB, size=3D0=
 }
+gPacketType.kPacket_AOSObjProp										=3D { id=3D0xDC, size=3D9 } -- siz=
e was not in necro list
 -- dd df (compressed gump und buff system)
-gPacketType.kPacket_Compressed_Gump									=3D { id=3D0xDD }
+gPacketType.kPacket_Compressed_Gump									=3D { id=3D0xDD, size=3D0 }
 -- unknown yet
-gPacketType.kPacket_unknownDEpacket									=3D { id=3D0xDE }
+gPacketType.kPacket_unknownDEpacket									=3D { id=3D0xDE, size=3D0 }
 -- buff/debuff packet
-gPacketType.kPacket_BuffDebuff_System								=3D { id=3D0xDF }
-gPacketType.kPacket_ExtBundledPacket								=3D { id=3D0xF0 } -- party pos=
itions, used by razor positioning system
+gPacketType.kPacket_BuffDebuff_System								=3D { id=3D0xDF, size=3D0 }
+gPacketType.kPacket_ExtBundledPacket								=3D { id=3D0xF0, size=3D0 } --=
 party positions, used by razor positioning system
+
+gPacketSizeOverride6017 =3D {[0x25]=3D21,[0x08]=3D15,} -- 0x3C is changed =
as well, but was dynamic anyway
+
+gPacketSizeByID =3D {}
+for k,v in pairs(gPacketType) do gPacketSizeByID[v.id] =3D v.size end
+
+gPacketTypeId2Name =3D {}
+for k,v in pairs(gPacketType) do gPacketTypeId2Name[v.id] =3D k end
+
+-- make names available as global constants, like kPacket_Account_Login_Re=
quest, needed for sending
+for k,v in pairs(gPacketType) do _G[k] =3D v.id end =

+
+function InitPackets ()
+	if (ClientVersionIsPost6017()) then =

+		print("initializing packets for 6.0.1.7 or later")
+		for id,newsize in pairs(gPacketSizeOverride6017) do gPacketSizeByID[id] =
=3D newsize end
+		--~ os.exit(0)
+	end
+end
+	=

+-- changed NecroPacketData - (0x0B oldsize=3D"0x010A" , damage packet)
+-- packet sizes from necrotoolz.sourceforge.net/kairpacketguide/index.html=
 (0 means dynamic) contains all sizes from 0x00 to 0xDB
 =

 --[[
 gPacketType.kPacket_								=3D { id=3D0xE0 }
@@ -257,7 +281,6 @@
 gPacketType.kPacket_								=3D { id=3D0xEE }
 gPacketType.kPacket_								=3D { id=3D0xEF }
 =

-gPacketType.kPacket_								=3D { id=3D0xF0 }
 gPacketType.kPacket_								=3D { id=3D0xF1 }
 gPacketType.kPacket_								=3D { id=3D0xF2 }
 gPacketType.kPacket_								=3D { id=3D0xF3 }

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Sat Feb  7 15:21:20 2009
@@ -1,4 +1,8 @@
 -- handles the interpretation of the uo protocol (fixed & dynamic packetsi=
zes, calling receive handlers, logging, ...)
+
+-- register packet types
+dofile(libpath .. "lib.packet.lua")
+
 =

 gCharacterList =3D {}
 gCities =3D {}
@@ -6,47 +10,19 @@
 -- register packet handlers
 gPacketHandler =3D {}
 =

+gNoLogPackets =3D { kPacket_Ping } -- can be used to shorten the standard =
log for every packet
+
 =

 function ClientVersionIsPost6017	() return ClientVersionIsPost(6017) end -=
- see http://iris2.de/index.php/Clientversion_6.0.1.7_and_later
 function GetClientVersionAsNumber	() return tonumber((string.gsub(gClientV=
ersion,"%D",""))) end -- gClientVersion =3D "6.0.1.6"
 function ClientVersionIsPost		(version) return GetClientVersionAsNumber() =
>=3D version end
 =

 =

--- changed NecroPacketData - (0x0B oldsize=3D"0x010A" , damage packet)
--- packet sizes from necrotoolz.sourceforge.net/kairpacketguide/index.html=
 (0 means dynamic) contains all sizes from 0x00 to 0xDB
-gNecroPacketData_ID 	=3D {  "0x00",  "0x01",  "0x02",  "0x03",  "0x04",  "=
0x05",  "0x06",  "0x07",  "0x08",  "0x09",  "0x0A",  "0x0B",  "0x0C",  "0x0=
D",  "0x0E",  "0x0F",  "0x10",  "0x11",  "0x12",  "0x13",  "0x14",  "0x15",=
  "0x16",  "0x17",  "0x18",  "0x19",  "0x1A",  "0x1B",  "0x1C",  "0x1D",  "=
0x1E",  "0x1F",  "0x20",  "0x21",  "0x22",  "0x23",  "0x24",  "0x25",  "0x2=
6",  "0x27",  "0x28",  "0x29",  "0x2A",  "0x2B",  "0x2C",  "0x2D",  "0x2E",=
  "0x2F",  "0x30",  "0x31",  "0x32",  "0x33",  "0x34",  "0x35",  "0x36",  "=
0x37",  "0x38",  "0x39",  "0x3A",  "0x3B",  "0x3C",  "0x3D",  "0x3E",  "0x3=
F",  "0x40",  "0x41",  "0x42",  "0x43",  "0x44",  "0x45",  "0x46",  "0x47",=
  "0x48",  "0x49",  "0x4A",  "0x4B",  "0x4C",  "0x4D",  "0x4E",  "0x4F",  "=
0x50",  "0x51",  "0x52",  "0x53",  "0x54",  "0x55",  "0x56",  "0x57",  "0x5=
8",  "0x59",  "0x5A",  "0x5B",  "0x5C",  "0x5D",  "0x5E",  "0x5F",  "0x60",=
  "0x61",  "0x62",  "0x63",  "0x64",  "0x65",  "0x66",  "0x67",  "0x68",  "=
0x69",  "0x6A",  "0x6B",  "0x6C",  "0x6D",  "0x6E",  "0x6F",  "0x70",  "0x7=
1",  "0x72",  "0x73",  "0x74",  "0x75",  "0x76",  "0x77",  "0x78",  "0x79",=
  "0x7A",  "0x7B",  "0x7C",  "0x7D",  "0x7E",  "0x7F",  "0x80",  "0x81",  "=
0x82",  "0x83",  "0x84",  "0x85",  "0x86",  "0x87",  "0x88",  "0x89",  "0x8=
A",  "0x8B",  "0x8C",  "0x8D",  "0x8E",  "0x8F",  "0x90",  "0x91",  "0x92",=
  "0x93",  "0x94",  "0x95",  "0x96",  "0x97",  "0x98",  "0x99",  "0x9A",  "=
0x9B",  "0x9C",  "0x9D",  "0x9E",  "0x9F",  "0xA0",  "0xA1",  "0xA2",  "0xA=
3",  "0xA4",  "0xA5",  "0xA6",  "0xA7",  "0xA8",  "0xA9",  "0xAA",  "0xAB",=
  "0xAC",  "0xAD",  "0xAE",  "0xAF",  "0xB0",  "0xB1",  "0xB2",  "0xB3",  "=
0xB4",  "0xB5",  "0xB6",  "0xB7",  "0xB8",  "0xB9",  "0xBA",  "0xBB",  "0xB=
C",  "0xBD",  "0xBE",  "0xBF",  "0xC0",  "0xC1",  "0xC2",  "0xC3",  "0xC4",=
  "0xC5",  "0xC6",  "0xC7",  "0xC8",  "0xC9",  "0xCA",  "0xCB",  "0xCC",  "=
0xCD",  "0xCE",  "0xCF",  "0xD0",  "0xD1",  "0xD2",  "0xD3",  "0xD4",  "0xD=
5",  "0xD6",  "0xD7",  "0xD8",  "0xD9",  "0xDA",  "0xDB",  "0xDC",
-  "0xDD", "0xDE", "0xDF",  "0xF0"}
-gNecroPacketData_Size 	=3D {"0x0068","0x0005","0x0007",     "0","0x0002","=
0x0005","0x0005","0x0007","0x000E","0x0005","0x000B","0x0007",     "0","0x0=
003",     "0","0x003D","0x00D7",     "0",     "0","0x000A","0x0006","0x0009=
","0x0001",     "0",     "0",     "0",     "0","0x0025",     "0","0x0005","=
0x0004","0x0008","0x0013","0x0008","0x0003","0x001A","0x0007","0x0014","0x0=
005","0x0002","0x0005","0x0001","0x0005","0x0002","0x0002","0x0011","0x000F=
","0x000A","0x0005","0x0001","0x0002","0x0002","0x000A","0x028D",     "0","=
0x0008","0x0007","0x0009",     "0",     "0",     "0","0x0002","0x0025",    =
 "0","0x00C9",     "0",     "0","0x0229","0x02C9","0x0005",     "0","0x000B=
","0x0049","0x005D","0x0005","0x0009",     "0",     "0","0x0006","0x0002", =
    "0",     "0",     "0","0x0002","0x000C","0x0001","0x000B","0x006E","0x0=
06A",     "0",     "0","0x0004","0x0002","0x0049",     "0","0x0031","0x0005=
","0x0009","0x000F","0x000D","0x0001","0x0004",     "0","0x0015",     "0", =
    "0","0x0003","0x0009","0x0013","0x0003","0x000E",     "0","0x001C",    =
 "0","0x0005","0x0002",     "0","0x0023","0x0010","0x0011",     "0","0x0009=
",     "0","0x0002",     "0","0x000D","0x0002",     "0","0x003E",     "0","=
0x0002","0x0027","0x0045","0x0002",     "0",     "0","0x0042",     "0",    =
 "0",     "0","0x000B",     "0",     "0",     "0","0x0013","0x0041",     "0=
","0x0063",     "0","0x0009",     "0","0x0002",     "0","0x001A",     "0","=
0x0102","0x0135","0x0033",     "0",     "0","0x0003","0x0009","0x0009","0x0=
009","0x0095",     "0",     "0","0x0004",     "0",     "0","0x0005",     "0=
",     "0",     "0",     "0","0x000D",     "0",     "0",     "0",     "0", =
    "0","0x0040","0x0009",     "0",     "0","0x0003","0x0006","0x0009","0x0=
003",     "0",     "0",     "0","0x0024",     "0",     "0",     "0","0x0006=
","0x00CB","0x0001","0x0031","0x0002","0x0006","0x0006","0x0007",     "0","=
0x0001",     "0","0x004E",     "0","0x0002","0x0019",     "0",     "0",    =
 "0",     "0",     "0",     "0","0x010C",     "0",     "0","0x0009",
-     "0",    "0",    "0",     "0"}
-
-gNecroPacketSize =3D {}
-for i =3D 1,table.getn(gNecroPacketData_ID) do =

-	gNecroPacketSize[hex2num(gNecroPacketData_ID[i])] =3D hex2num(gNecroPacke=
tData_Size[i]) =

-end
-gNoLogPackets =3D { kPacket_Ping } -- can be used to shorten the standard =
log for every packet
-
-	=

--- register packet types
-	gPacketType =3D {}
-	gPacketSizeById =3D {}
-	gPacketTypeId2Name =3D {}
-	dofile(libpath .. "lib.packet.lua")
-	-- register packets type with size set : if(v.size) is true for size=3D0,=
 this is no mistake here, packets with size 0 should be registered, =

-	-- those with size not set =3D nil should not be registered, and if (v.si=
ze) is false for size=3Dnil =3D not set
-	for k,v in pairs(gPacketType) do =

-		local packetsize =3D -1
-		if (v.size) then packetsize =3D v.size else packetsize =3D gNecroPacketS=
ize[v.id] end
-		-- if no packet size specified in lib.packet.lua, use the one from necro=
toolz
-		gPacketSizeById[v.id] =3D packetsize
-	end
-	for k,v in pairs(gPacketType) do gPacketTypeId2Name[v.id] =3D k end
-	for k,v in pairs(gPacketType) do _G[k] =3D v.id end -- make names availab=
le as global constants, like kPacket_Account_Login_Request, needed for send=
ing
-	=

-
 gProfiler_Packets =3D CreateRoughProfiler("Packets")
 =

 -- check if packets are complete and handle them
 function HandlePackets ()
+	if (not gPacketInit) then gPacketInit =3D true InitPackets() end
 	if (not gNoLogPackets_ByPacket) then gNoLogPackets_ByPacket =3D {} for k,=
v in pairs(gNoLogPackets) do gNoLogPackets_ByPacket[v] =3D true end end
 	local input =3D GetRecvFIFO()
 	=

@@ -54,7 +30,7 @@
 	=

 	while (input:Size() >=3D 1) do
 		local iId =3D input:PeekNetUint8(0)
-		local iPacketSize =3D gPacketSizeById[iId]
+		local iPacketSize =3D gPacketSizeByID[iId]
 		--~ print("packet",gPacketTypeId2Name[iId],iPacketSize)
 		if (not iPacketSize) then
 			print("Packet with unknown Packetsize received : ",iId)
@@ -149,15 +125,3 @@
 	file:write(info)
 	file:close()
 end
-
--- Send Packets -----------------------------------------------------------
-
--- request serverside helppage
-function Send_RequestHelp()
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Request_Assistance)
-	for i=3D1, 257 do
-		out:PushNetUint8(0)
-	end
-	out:SendPacket()
-end

Modified: trunk/lua/lib.razorpacketvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.razorpacketvideo.lua (original)
+++ trunk/lua/lib.razorpacketvideo.lua Sat Feb  7 15:21:20 2009
@@ -149,7 +149,7 @@
 		=

 		packet.iPacketID		=3D fifo:PeekNetUint8(0)
 		if (packet.iPacketID =3D=3D 0xff) then fifo:PopRaw(1) break end
-		packet.iPacketSize		=3D myPacketSizeOverride[packet.iPacketID] or gPacke=
tSizeById[packet.iPacketID]
+		packet.iPacketSize		=3D myPacketSizeOverride[packet.iPacketID] or gPacke=
tSizeByID[packet.iPacketID]
 		=

 		if (not packet.iPacketSize) then 	=

 			print("rpv : warning, unknown packettype-size",sprintf("0x%02x",packet.=
iPacketID))

Modified: trunk/lua/lib.xml.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.xml.lua (original)
+++ trunk/lua/lib.xml.lua Sat Feb  7 15:21:20 2009
@@ -1,4 +1,11 @@
 -- utilities for xml
+
+-- use this instead of table.insert, as the .n field is not set by table.i=
nsert
+function XMLNodeAddChild (node,child)
+	local newsize =3D (node.n or 0) + 1
+	node.n =3D newsize
+	node[newsize] =3D child
+end
 =

 -- finds the first (or index'th) child with child.name=3Dname
 -- index : one-based indices   default =3D one =3D first

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Feb  7 15:21:20 2009
@@ -102,6 +102,7 @@
 dofile(libpath .. "lib.razorconfig.lua")
 dofile(libpath .. "lib.razorpacketvideo.lua")
 dofile(libpath .. "lib.configdialog.lua")
+dofile(libpath .. "lib.shardlist.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")
@@ -350,16 +351,13 @@
 =

 	-- detect UOPath
 	if (not gUOPath) then AutoDetectUOPath() end
-	if (ClientVersionIsPost6017()) then =

-		local errmsg =3D "FATAL, gClientVersion >=3D 6.0.1.7 not supported yet (=
protocol changes), cur version =3D "..tostring(GetClientVersionAsNumber())
-		-- see http://iris2.de/index.php/Clientversion_6.0.1.7_and_later
-		FatalErrorMessage(errmsg)
-	end
+	print("uo protocol version used by iris",GetClientVersionAsNumber()) -- s=
ee http://iris2.de/index.php/Clientversion_6.0.1.7_and_later
 	TestUOAM()
 	local luaversion =3D string.sub(_VERSION, 5, 7)
 	print("Lua version : "..luaversion)
 	print("Ogre platform : "..OGRE_PLATFORM)
 	=

+	InitShardList()
 	HandleCommandLine()
 	=

 	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end

Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Sat Feb  7 15:21:20 2009
@@ -111,12 +111,14 @@
 		local dynamicdata =3D {}
 		dynamicdata.container_content_order =3D i
 		dynamicdata.serial				=3D input:PopNetUint32()
-		dynamicdata.artid_base			=3D input:PopNetUint16()
+		dynamicdata.artid_base			=3D input:PopNetUint16() --~ runuo code before =
sending this : if ( artid_base > 0x3FFF ) artid_base =3D 0x9D7;  =

 		dynamicdata.artid_addstack		=3D input:PopNetUint8()
 		dynamicdata.amount				=3D input:PopNetUint16()
 		dynamicdata.xloc				=3D input:PopNetInt16()
 		dynamicdata.yloc				=3D input:PopNetInt16()
 		dynamicdata.zloc				=3D 0						--Grid Index (only since 6.0.1.7 2D and 2=
.45.5.6 KR)
+		=

+		if (ClientVersionIsPost6017()) then dynamicdata.gridloc =3D input:PopNet=
Int8(0) end =

 		dynamicdata.iContainerSerial 	=3D input:PopNetUint32()
 		dynamicdata.hue 				=3D input:PopNetUint16()
 		=

@@ -151,6 +153,7 @@
 	dynamicdata.xloc				=3D input:PopNetInt16()
 	dynamicdata.yloc				=3D input:PopNetInt16()
 	dynamicdata.zloc				=3D 0						--Grid Index (only since 6.0.1.7 2D and 2.=
45.5.6 KR)
+	if (ClientVersionIsPost6017()) then dynamicdata.gridloc =3D input:PopNetI=
nt8(0) end =

 	dynamicdata.iContainerSerial	=3D input:PopNetUint32()
 	dynamicdata.hue					=3D input:PopNetUint16()
 	--~ print("kPacket_Object_to_Object",SmartDump(dynamicdata))

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sat Feb  7 15:21:20 2009
@@ -247,3 +247,15 @@
 ]]--
 end
 =

+
+-- Send Packets -----------------------------------------------------------
+
+-- request serverside helppage
+function Send_RequestHelp()
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Request_Assistance)
+	for i=3D1, 257 do
+		out:PushNetUint8(0)
+	end
+	out:SendPacket()
+end



From no-reply at zwischenwelt.org  Sat Feb  7 15:53:13 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 07 Feb 2009 14:53:13 -0000
Subject: [Iris-commit] [IRIS] r2901 - in /trunk: config/shards/ lua/
Message-ID: <20090207145318.331A21C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Feb  7 15:53:00 2009
New Revision: 2901

Log:
shardlist moved to xml files, fixed bug in mainmenu when going back : bg im=
age was not destroyed

Added:
    trunk/config/shards/Jarrys (chinese).xml
    trunk/config/shards/defianceuo.com.xml
    trunk/config/shards/localhost.xml
    trunk/config/shards/uogamers.com.xml
    trunk/config/shards/vetus-mundus.xml
Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.shardlist.lua
    trunk/lua/main.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sat Feb  7 15:53:00 2009
@@ -149,6 +149,7 @@
 =

 --~ preset shards now loaded from config/shards/*.xml
 =

+--[[
 gShardList["localhost"] =3D {
 		gLoginname =3D "admin",	-- Loginname
 		gPassword =3D "admin",	-- Password
@@ -205,7 +206,7 @@
 		gServerSeed =3D hex2num("0xFFFFFFFF"),
 		gPolServer =3D false
 	}
---~ ]]--
+]]--
 =

 -- in config.lua you can add shards like this: 	=

 -- gShardList["myshard"] =3D { ..... } =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sat Feb  7 15:53:00 2009
@@ -349,6 +349,7 @@
 		local w =3D vp:GetActualWidth()
 		local h =3D vp:GetActualHeight()
 		local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPlain=
TextureGUIMat("menu_bg.jpg"), 1024, 768)
+		if (gMenuBgImage) then gMenuBgImage:Destroy() end
 		gMenuBgImage =3D GetDesktopWidget():CreateChild("Image",{gfxparam_init=
=3Dgfxparam_init})
 		gMenuBgImage:SetPos(0,0)
 		gMenuBgImage:SetSize(w,h)

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Sat Feb  7 15:53:00 2009
@@ -10,25 +10,32 @@
 ]]--
 =

 function InitShardList () =

-	print("GetClientVersionAsNumber",GetClientVersionAsNumber())
 	--~ for shardname,shard in pairs(gShardList) do
 		--~ local filepath =3D GetShardConfigFilePath(shardname)
 		--~ print("InitShardList",shardname,shard,filepath)
 		--~ SimpleXMLSave(filepath,shard)
 	--~ end
+	--~ SimpleXML_Test()
+	LoadShardList()
 	--~ os.exit(0)
-	--~ SimpleXML_Test()
-	--~ LoadShardList()
 end
 =

 function GetConfigDirPath				() return gMainWorkingDir.."config/" end
 function GetShardListDirPath			() return GetConfigDirPath().."shards/" end
-function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..string.gsub(shardname,"[^0-9a-zA-Z_-]",".")..".xml" end
+function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..string.gsub(shardname,"[^0-9a-zA-Z_%-%(%) ]",".")..".xml" end
 =

 function LoadShardList () =

 	local path_folder =3D GetShardListDirPath()
 	local arr_files =3D dirlist(path_folder,false,true)
-	for k,filename in pairs(arr_files) do  print("LoadShardList",filename) end
+	for k,filename in pairs(arr_files) do
+		local ext =3D string.lower(string.sub(filename,-4))
+		local shardname =3D string.sub(filename,1,-5)
+		local filepath =3D path_folder .. filename
+		print("LoadShardList",shardname,filepath,ext) =

+		if (ext =3D=3D ".xml") then =

+			gShardList[shardname] =3D SimpleXMLLoad(filepath)
+		end
+	end
 end
 =

 -- returns {

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Feb  7 15:53:00 2009
@@ -114,6 +114,7 @@
 dofile(libpath .. "lib.uoam.lua")
 =

 dofile(libpath .. "config_declarations.lua")
+InitShardList() -- was previously in configdecl, should be done before con=
fig.lua is loaded, so overrides can be done there
 =

 =

 if (LugreActivateGlobalVarChecking) then LugreActivateGlobalVarChecking() =
end
@@ -357,7 +358,6 @@
 	print("Lua version : "..luaversion)
 	print("Ogre platform : "..OGRE_PLATFORM)
 	=

-	InitShardList()
 	HandleCommandLine()
 	=

 	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end



From no-reply at zwischenwelt.org  Sat Feb  7 16:22:47 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 07 Feb 2009 15:22:47 -0000
Subject: [Iris-commit] [IRIS] r2902 - in /trunk/lua: lib.mainmenu.lua
 lib.shardlist.lua net/net.login.lua
Message-ID: <20090207152247.B1A721C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Feb  7 16:22:47 2009
New Revision: 2902

Log:
shardlist bugfix

Modified:
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.shardlist.lua
    trunk/lua/net/net.login.lua

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sat Feb  7 16:22:47 2009
@@ -376,8 +376,6 @@
 				return
 		end
 	end -- connect to shard
-	=

-	LoadShardList()
 =

 	-- start menu sound
 	SoundPlayMusicById(8)

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Sat Feb  7 16:22:47 2009
@@ -38,13 +38,6 @@
 	end
 end
 =

--- returns {
-function LoadShardInfos (shardname) =

-	local filename =3D GetShardListDirPath()..shardname..".xml"
-end
-
-
-
 -- stored passwords
 =

 gStoredPasswords =3D {}

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Sat Feb  7 16:22:47 2009
@@ -128,7 +128,7 @@
 end
 =

 -- Receive Character List from GameServer
-function gPacketHandler.kPacket_Character_List()
+function gPacketHandler.kPacket_Character_List() -- 0xA9
 	local characterslots =3D 5
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()



From no-reply at zwischenwelt.org  Sun Feb  8 04:09:03 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 08 Feb 2009 03:09:03 -0000
Subject: [Iris-commit] [IRIS] r2903 - in /trunk: config/ config/chars/
 lua/lib.macrolist.lua lua/lib.net.lua lua/lib.protocol.lua
 lua/lib.shardlist.lua lua/main.lua lua/net/net.login.lua
 lua/net/net.mobile.lua lua/net/net.skill.lua plugins/moblist.lua
Message-ID: <20090208030903.BBC081C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Feb  8 04:09:02 2009
New Revision: 2903

Log:
startingame : removed execmapchange, since the facet is not yet known at th=
at point, so it's usually wasted time, so login should be a few secs faster=
 now. ping can now be sent before ingame, might be needed for char creation=
 menu later, but doesn't work during charlist. account+char memory, now use=
rnames,charnames and the equip+skills of chars that are logged in are store=
d, these infos will later be used for displaying 3d or 2d images of the cha=
rs, and skillinfos, before logging in.  moblist : blue arrow indicating Mac=
roCmd_GetSmartTargetForLastSpell

Added:
    trunk/config/chars/   (with props)
Modified:
    trunk/config/   (props changed)
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.net.lua
    trunk/lua/lib.protocol.lua
    trunk/lua/lib.shardlist.lua
    trunk/lua/main.lua
    trunk/lua/net/net.login.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/net/net.skill.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Feb  8 04:09:02 2009
@@ -54,17 +54,18 @@
 kSmartSpellHealBig		=3D 29
 kSmartSpellCureSmall	=3D 11
 kSmartSpellCureBig		=3D 25
+-- returns serial,bIsFriendly
 function MacroCmd_GetSmartTargetForLastSpell () -- smart targets for frien=
dly spells (heal,cure)
 	if (gSmartLastSpellID) then =

 		if (gSmartLastSpellID =3D=3D kSmartSpellHealSmall or gSmartLastSpellID =
=3D=3D kSmartSpellHealBig) then
 			local target =3D MobileList_GetWeakestFromList(MobileList_HealableParty=
Members())
 			--~ print("healtarget",target)
-			return target and target.serial or GetPlayerSerial()
+			return target and target.serial or GetPlayerSerial(),true
 		end
 		if (gSmartLastSpellID =3D=3D kSmartSpellCureSmall or gSmartLastSpellID =
=3D=3D kSmartSpellCureBig) then
 			local target =3D MobileList_GetWeakestFromList(MobileList_CurablePartyM=
embers())
 			--~ print("curetarget",target)
-			return target and target.serial or GetPlayerSerial()
+			return target and target.serial or GetPlayerSerial(),true
 		end
 	end
 	-- gLastSpellID

Modified: trunk/lua/lib.net.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.net.lua (original)
+++ trunk/lua/lib.net.lua Sun Feb  8 04:09:02 2009
@@ -68,6 +68,8 @@
 	gHuffmanDecode =3D true
 end
 =

+function IsNetConnected () return gMainConnection and gMainConnection:IsCo=
nnected() end
+
 -- only sending, receiving and decoding, no packet handling triggered
 function NetTrafficStep ()
 	if (not gMainConnection) then return end

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Sun Feb  8 04:09:02 2009
@@ -2,10 +2,6 @@
 =

 -- register packet types
 dofile(libpath .. "lib.packet.lua")
-
-
-gCharacterList =3D {}
-gCities =3D {}
 =

 -- register packet handlers
 gPacketHandler =3D {}

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Sun Feb  8 04:09:02 2009
@@ -1,3 +1,14 @@
+
+-- paths
+
+function GetConfigDirPath				() return gMainWorkingDir.."config/" end
+function GetShardListDirPath			() return GetConfigDirPath().."shards/" end
+function GetShardMemoryFilePath			() return GetConfigDirPath().."shardmemo=
ry.xml" end
+function GetCharFilePath				() return GetConfigDirPath().."chars/"..gLogin=
ServerIP.."."..gLoginServerPort.."."..gLoginname.."."..gCharID..".xml" end
+function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..string.gsub(shardname,"[^0-9a-zA-Z_%-%(%) ]",".")..".xml" end
+
+
+-- notes
 =

 --[[
 shard=3D{
@@ -7,22 +18,87 @@
 			charname,skills,body(male,female,skintone),equip(hair,armor,weap,mount)
 		}
 	}
+
+shardclick : =

+	acclist + charlist soweit bekannt. =

+		charlist nach shardlogin updaten
+
 ]]--
 =

+
+
+
 function InitShardList () =

+	LoadShardMemory()
+	LoadShardList()
 	--~ for shardname,shard in pairs(gShardList) do
 		--~ local filepath =3D GetShardConfigFilePath(shardname)
 		--~ print("InitShardList",shardname,shard,filepath)
 		--~ SimpleXMLSave(filepath,shard)
 	--~ end
 	--~ SimpleXML_Test()
-	LoadShardList()
 	--~ os.exit(0)
 end
 =

-function GetConfigDirPath				() return gMainWorkingDir.."config/" end
-function GetShardListDirPath			() return GetConfigDirPath().."shards/" end
-function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..string.gsub(shardname,"[^0-9a-zA-Z_%-%(%) ]",".")..".xml" end
+
+
+
+-- ***** ***** ***** ***** ***** chars
+
+
+RegisterListener("Hook_Packet_Character_List",function (charlist) =

+	-- gLoginname,gPassword,gLoginServerIP,gLoginServerPort
+	local plaincharlist =3D {}
+	for k,v in pairs(charlist.chars) do plaincharlist[k] =3D v.name end
+	ShardMemorySet("charlist",gLoginServerIP..":"..gLoginServerPort..":"..gLo=
ginname,plaincharlist)
+end)
+
+RegisterListener("Hook_Player_Full_equip",function (mobiledata,equipmentda=
ta) =

+	if (gShardListPlayerEquipAlreadySaved) then return end
+	gShardListPlayerEquipAlreadySaved =3D true
+	ShardListSavePlayerMobile()
+	RegisterIntervalStepper(30*1000,ShardListSavePlayerMobile) =

+end)
+
+RegisterListener("Hook_Player_Skills",function (skills) =

+	if (gShardListPlayerSkillAlreadySaved) then return end
+	gShardListPlayerSkillAlreadySaved =3D true
+	ShardListSavePlayerMobile()
+end)
+
+-- stores body,equip,mount       todo : skills, but change too often for x=
ml
+function ShardListSavePlayerMobile ()
+	local mobile =3D GetPlayerMobile()
+	print("###ShardListSavePlayerMobile",mobile,gPlayerSkills)
+	if (not mobile) then return end
+	if (not gPlayerSkills) then return end
+	local charname =3D gCharName
+	=

+	-- calc and check has, no need to save if nothing changed
+	local hash =3D {mobile.artid,mobile.hue}
+	for k,layer in pairs(gLayerType) do =

+		local item =3D mobile:GetEquipmentAtLayer(layer) =

+		if (item) then table.insert(hash,item.serial) end
+	end
+	for skillid,skill in pairs(gPlayerSkills) do table.insert(hash,skill.base=
_value) end
+	hash =3D table.concat(hash,"#")
+	if (hash =3D=3D gShardListSavePlayerMobile_LastHash) then return end
+	gShardListSavePlayerMobile_LastHash =3D hash
+	=

+	-- save the data
+	print("saving data...",hash)
+	local data =3D {	charname=3Dcharname, artid=3Dmobile.artid, hue=3Dmobile.=
hue, xloc=3Dmobile.xloc, yloc=3Dmobile.yloc, map=3DgMapIndex, equip=3D{},sk=
ills=3D{} }
+	for k,layer in pairs(gLayerType) do =

+		local item =3D mobile:GetEquipmentAtLayer(layer) =

+		if (item) then data.equip[layer] =3D {artid=3Ditem.artid,hue=3Ditem.hue}=
 end
+	end
+	for skillid,skill in pairs(gPlayerSkills) do =

+		data.skills[skillid] =3D {value=3Dskill.value,base_value=3Dskill.base_va=
lue,lockstate=3Dskill.lockstate,name=3DglSkillNames[skillid]} =

+	end
+	SimpleXMLSave(GetCharFilePath(),data)
+end
+
+-- ***** ***** ***** ***** ***** shard list =

 =

 function LoadShardList () =

 	local path_folder =3D GetShardListDirPath()
@@ -37,8 +113,25 @@
 		end
 	end
 end
+ =

+-- ***** ***** ***** ***** ***** shard memory =

 =

--- stored passwords
+function LoadShardMemory	() gShardMemory =3D	SimpleXMLLoad(GetShardMemoryF=
ilePath()) or {} end
+function SaveShardMemory	()					SimpleXMLSave(GetShardMemoryFilePath(),gSh=
ardMemory) end
+
+function ShardMemoryGet		(listname,key) =

+	local list =3D gShardMemory[listname]
+	return list and list[key]
+end
+function ShardMemorySet		(listname,key,value)
+	local list =3D gShardMemory[listname]
+	if (not list) then list =3D {} gShardMemory[listname] =3D list end
+	list[key] =3D value
+	SaveShardMemory()
+	print("ShardMemorySet",listname,key)
+end
+
+-- ***** ***** ***** ***** ***** stored passwords
 =

 gStoredPasswords =3D {}
 function GetStoredPasswordsFilePath () return GetConfigDirPath().."passwor=
ds.xml" end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Feb  8 04:09:02 2009
@@ -522,8 +522,6 @@
 =

 	gCurrentRenderer:Init()
 =

-	ExecuteMapChangeIfNeeded()
-
 	gCurrentRenderer:BlendOutLayersAbovePlayer()
 	=

 	-- Binds all InGame-Keys
@@ -583,6 +581,11 @@
 =

 	gProfiler_MainStep:Section("StepDebugMenu")
 	StepDebugMenu()
+	=

+	if (IsNetConnected() and gPingActive) then -- ping needed during characte=
r selection and char create also
+		gProfiler_MainStep:Section("PingStep")
+		PingStep()
+	end
 =

 	if (gInGameStarted) then
 		gProfiler_MainStep:Section("StepUODragDrop")
@@ -593,8 +596,6 @@
 		if (not gNoOgre) then DisplayMemoryUsage(OgreMemoryUsage("all")) end
 		gProfiler_MainStep:Section("DisplayLoadingState")
 		DisplayLoadingState()
-		gProfiler_MainStep:Section("PingStep")
-		PingStep()
 		gProfiler_MainStep:Section("gCurrentRenderer:MainStep",true)
 		gCurrentRenderer:MainStep()
 	else

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Sun Feb  8 04:09:02 2009
@@ -4,8 +4,16 @@
 gTooltipSupport =3D false
 gPWReplace =3D "??????" -- prevent username/password appearing in debug du=
mp
 =

+gCities =3D {}
+gCharacterList =3D {}
+
+function LoginDebug2 (txt) =

+	--~ print("#>--<#LoginDebug2:"..os.date("%H:%M:%S")..":"..txt)
+end
+
 -- TODO : write Set_ClientFeatures function !!
-function gPacketHandler.kPacket_Server_List () --0xa8 - Recieve Serverlist=
 from LoginServer
+function gPacketHandler.kPacket_Server_List ()  -- 0x5E  --0xa8 - Recieve =
Serverlist from LoginServer
+	LoginDebug2("r:0x5E kPacket_Server_List")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local serverlist =3D {}
@@ -34,7 +42,8 @@
 end
 =

 -- len: 0x10C
-function Send_SystemSpecs()
+function Send_SystemSpecs() -- 0xD9
+	LoginDebug2("s:0xD9 Send_SystemSpecs")
 	printdebug("login","NET: Send_SystemSpecs:")
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Metrics)
@@ -72,7 +81,8 @@
 end
 =

 -- Recieve Serverredirect from LoginServer (0x8c)
-function gPacketHandler.kPacket_Server_Redirect ()
+function gPacketHandler.kPacket_Server_Redirect () -- 0x8c
+	LoginDebug2("r:0x8c kPacket_Server_Redirect")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	=

@@ -96,6 +106,8 @@
 		NetDisconnect()
 		--connect to gameserver
 		printdebug("login","NET: connect to gameserver")
+		gPingActive =3D true
+		gNextPingTime =3D 0
 		local res =3D NetConnectWithKey(gameserverip,gameserverport,gameserverac=
count)
 		if (not res) then
 			FatalErrorMessage("kPacket_Server_Redirect : login server redirect fail=
ed")
@@ -120,7 +132,8 @@
 0x0080 =3D Enable ML Features: new race, spells
 ]]--
 --NET: Client features received: 0x80fb
-function gPacketHandler.kPacket_Features ()
+function gPacketHandler.kPacket_Features () -- 0xB9
+	LoginDebug2("r:0xB9 kPacket_Features")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local clientfeatures =3D input:PopNetUint16()
@@ -129,6 +142,7 @@
 =

 -- Receive Character List from GameServer
 function gPacketHandler.kPacket_Character_List() -- 0xA9
+	LoginDebug2("r:0xA9 kPacket_Character_List")
 	local characterslots =3D 5
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
@@ -210,11 +224,13 @@
 	0x400 =3D KR support flag2
 	]]--
 	=

+	NotifyListener("Hook_Packet_Character_List",charlist)
 	MainMenuShowCharList(charlist)
 end
 =

 -- Receive Login Confirm from GameServer
-function gPacketHandler.kPacket_Login_Confirm()
+function gPacketHandler.kPacket_Login_Confirm() -- 0x1B
+	LoginDebug2("r:0x1B kPacket_Login_Confirm")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 =

@@ -224,8 +240,7 @@
 	mobiledata.artid	=3D input:PopNetUint16()
 	mobiledata.xloc	=3D input:PopNetUint16()
 	mobiledata.yloc	=3D input:PopNetUint16()
-	mobiledata.unknown0 =3D input:PopNetUint8()
-	mobiledata.zloc	=3D input:PopInt8()
+	mobiledata.zloc	=3D input:PopInt16()
 	mobiledata.dir	=3D input:PopNetUint8()
 =

 	mobiledata.unknown2 =3D input:PopNetUint16()
@@ -265,6 +280,7 @@
 -- works on RunUO...don't know if all servers send this !?
 -- StartGame Packet
 function gPacketHandler.kPacket_Login_Complete()
+	LoginDebug2("r:0x55 kPacket_Login_Complete")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	printdebug("login",sprintf("NET: Login_Complete with id: %i\n",id))
@@ -283,6 +299,7 @@
 =

 -- Loginserver Login rejected - Errorcode returned
 function gPacketHandler.kPacket_Login_Reject() -- 0x53
+	LoginDebug2("r:0x53 kPacket_Login_Reject")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local value =3D input:PopNetUint8()
@@ -303,6 +320,7 @@
 		=

 -- GameServer Login failed - Errorcode returned
 function gPacketHandler.kPacket_Account_Login_Failed() -- 0x82
+	LoginDebug2("r:0x82 kPacket_Account_Login_Failed")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local value =3D input:PopNetUint8()
@@ -315,7 +333,8 @@
 end
 =

 -- Server requests Clientversion (NEW?)
-function gPacketHandler.kPacket_Client_Version()
+function gPacketHandler.kPacket_Client_Version() -- 0xBD
+	LoginDebug2("r:0xBD kPacket_Client_Version")
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local value =3D input:PopNetUint16()
@@ -330,10 +349,11 @@
 =

 -- send login server request 0x80
 -- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
-function Send_Account_Login_Request	(sName,sPassword,iSeed)
+function Send_Account_Login_Request	(sName,sPassword,iSeed) -- 0x80
+	LoginDebug2("s:0x80 Send_Account_Login_Request")
 	printdebug("login",sprintf("NET: Account_Login_Request: Name: %s Password=
: %s\n",gPWReplace or sName,gPWReplace or sPassword))
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Account_Login_Request)
+	out:PushNetUint8(kPacket_Account_Login_Request) -- 0x80
 	out:PushFilledString(sName,30)
 	out:PushFilledString(sPassword,30)
 	out:PushNetUint8(iSeed or hex2num("0x5D"))
@@ -343,10 +363,11 @@
 -- send gameserverselect to loginserver : kPacket_Server_Select 0xA0
 -- answered by kPacket_Server_Redirect 0x8C
 -- which calls Send_GameServer_PostLogin kPacket_Post_Login 0x91 =

-function Send_GameServer_Select(iGameServerID)
+function Send_GameServer_Select(iGameServerID) -- 0xA0
+	LoginDebug2("s:0xA0 Send_GameServer_Select")
 	printdebug("login",sprintf("NET: GameServer_Select: %i\n",iGameServerID))
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Server_Select)
+	out:PushNetUint8(kPacket_Server_Select) -- 0xA0
 	out:PushNetUint16(iGameServerID)
 	out:SendPacket()
 end
@@ -354,10 +375,11 @@
 -- send postlogin to gameserver  kPacket_Post_Login 0x91
 -- something is wrong...runuo & wolfpack detects invalid client
 -- answered by kPacket_Features 0xB9 and  kPacket_Character_List 0xA9
-function Send_GameServer_PostLogin(sName,sPassword,iAccount)
+function Send_GameServer_PostLogin(sName,sPassword,iAccount) -- 0x91
+	LoginDebug2("s:0x91 Send_GameServer_PostLogin")
 	printdebug("login",sprintf("NET: GameServer_PostLogin: Name: %s Password:=
 %s AccountNr.: 0x%08x\n",gPWReplace or sName,gPWReplace or sPassword,iAcco=
unt))
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Post_Login)
+	out:PushNetUint8(kPacket_Post_Login) -- 0x91
 	out:PushNetUint32(iAccount)
 	out:PushFilledString(sName,30)
 	out:PushFilledString(sPassword,30)
@@ -410,16 +432,21 @@
 	out:SendPacket()
 end
 =

--- send characterselect to gameserver
+-- send characterselect to gameserver  0x5D
 function Send_Character_Select(iCharacterID,iAccount)
+	LoginDebug2("s:0x5D Send_Character_Select")
 	printdebug("login",sprintf("NET: Character_Select: %i Name: %s Password: =
%s AccountNr.:%x\n",
 			iCharacterID,gCharacterList[iCharacterID].name,gCharacterList[iCharacte=
rID].pw,iAccount))
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Pre_Login)
+			=

+	gCharName =3D gCharacterList[iCharacterID].name
+	gCharID =3D iCharacterID
+	=

+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Pre_Login) -- 0x5D
 	out:PushNetUint32(hex2num("0xedededed"))
-	out:PushFilledString(gCharacterList[iCharacterID].name,30)
-
---	out:PushFilledString(gCharacterList[iCharacterID].pw,30)
+	out:PushFilledString(gCharName,30)
+
+	--	out:PushFilledString(gCharacterList[iCharacterID].pw,30)
 =

 	out:PushNetUint16(0)
 	out:PushNetUint32(hex2num("0x0000001F"))	-- RunUO uses this unknown flags=
 (maybe for map 3,4 support)
@@ -433,10 +460,12 @@
 	out:SendPacket()
 end
 =

--- client identification
+-- client identification  0x34
 function Send_ClientQuery(iMode,iCharacterID)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Client_Query)
+	LoginDebug2("s:0x34 Send_ClientQuery"..iMode..sprintf(":0x%08x",iCharacte=
rID))
+	--~ print(_TRACEBACK())
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Client_Query) -- 0x34
 	out:PushNetUint32(hex2num("0xedededed"))
 	out:PushNetUint8(iMode)
 	out:PushNetUint32(iCharacterID)
@@ -445,10 +474,11 @@
 =

 -- Submits ClientVersion to Server
 function Send_ClientVersion(sClientVersion)
+	LoginDebug2("s:0xBD Send_ClientVersion")
 	printdebug("login",sprintf("NET: Client_Version: Client identified as %s.=
\n", sClientVersion))
 	local out =3D GetSendFIFO()
 	local size =3D string.len(sClientVersion)
-	out:PushNetUint8(kPacket_Client_Version)
+	out:PushNetUint8(kPacket_Client_Version) -- 0xBD
 	out:PushNetUint16(4+size)
 	out:PushFilledString(sClientVersion,size)
 	out:PushNetUint8(0)
@@ -457,9 +487,10 @@
 =

 -- Submits Client Language to Server
 function Send_ClientLanguage(lang)
+	LoginDebug2("s:0xBF Send_ClientLanguage")
 	printdebug("login",sprintf("NET: Client submits ClientLanguage=3D%s\n",la=
ng))
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
+	out:PushNetUint8(kPacket_Generic_Command) -- 0xBF
 	out:PushNetUint16(hex2num("0x09"))
 	out:PushNetUint16(kPacket_Generic_SubCommand_ClientLanguage)
 	out:PushFilledString(lang, 3)
@@ -469,9 +500,10 @@
 =

 -- Submits Screensize
 function Send_Screensize()
+	LoginDebug2("s:0xBF Send_Screensize")
 	printdebug("login",sprintf("NET: Client submits Screensize=3D%s\n","x,y"))
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
+	out:PushNetUint8(kPacket_Generic_Command) -- 0xBF
 	out:PushNetUint16(hex2num("0x0D"))
 	out:PushNetUint16(kPacket_Generic_SubCommand_Screensize)
 	out:PushNetUint32(hex2num("0x00000320"))
@@ -481,9 +513,10 @@
 =

 -- Submits Unknown Cmd2
 function Send_UnknownCommand()
+	LoginDebug2("s:0xBF Send_UnknownCommand")
 	printdebug("login",sprintf("NET: Client submits Unknowncmd=3D%s\n","0x0A0=
000001F"))
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
+	out:PushNetUint8(kPacket_Generic_Command) -- 0xBF
 	out:PushNetUint16(hex2num("0x0A"))
 	out:PushNetUint16(hex2num("0x000F"))
 	out:PushNetUint32(hex2num("0x0A000000"))
@@ -493,9 +526,10 @@
 =

 -- Submits UnknownSE
 function Send_UnknownSE()
+	LoginDebug2("s:0xBF Send_UnknownSE")
 	printdebug("login",sprintf("NET: Client submits UnknownSE%s\n",""))
 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
+	out:PushNetUint8(kPacket_Generic_Command) -- 0xBF
 	out:PushNetUint16(hex2num("0x06"))
 	out:PushNetUint16(kPacket_Generic_SubCommand_UnknownSE)
 	out:PushNetUint8(hex2num("0x83"))

Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Sun Feb  8 04:09:02 2009
@@ -14,13 +14,14 @@
 	mobiledata.flag			=3D input:PopNetUint8()
 	mobiledata.notoriety	=3D input:PopNetUint8()
 	=

-	local xloc,yloc =3D GetPlayerPos()
-	local dist =3D dist2max(xloc,yloc,mobiledata.xloc,mobiledata.yloc)
+	--~ print("#>--<#kPacket_Naked_MOB",sprintf("0x%08x",mobiledata.serial),m=
obiledata.xloc,mobiledata.yloc)
+	--~ local xloc,yloc =3D GetPlayerPos()
+	--~ local dist =3D dist2max(xloc,yloc,mobiledata.xloc,mobiledata.yloc)
 	--~ if (dist > gUpdateRange_MobileDestroy) then print("kPacket_Naked_MOB =
: dist >=3D ",dist) end
 	=

-	if (mobiledata.serial =3D=3D 0x001b5369) then
-		printdebug("corpse","CORPSECODE kPacket_Naked_MOB",mobiledata.artid,mobi=
ledata.flag,mobiledata.notoriety)
-	end
+	--~ if (mobiledata.serial =3D=3D 0x001b5369) then
+		--~ printdebug("corpse","CORPSECODE kPacket_Naked_MOB",mobiledata.artid,=
mobiledata.flag,mobiledata.notoriety)
+	--~ end
 	=

 	local mobile =3D CreateOrUpdateMobile(mobiledata)
 end
@@ -80,7 +81,9 @@
 		equipmentdata[dynamicdata.layer] =3D dynamicdata
 	end
 	=

+	--~ print("#>--<#kPacket_Equipped_MOB",sprintf("0x%08x",mobiledata.serial=
),mobiledata.xloc,mobiledata.yloc)
 	CreateOrUpdateMobile(mobiledata,equipmentdata)
+	if (mobiledata.serial =3D=3D GetPlayerSerial()) then NotifyListener("Hook=
_Player_Full_equip",mobiledata,equipmentdata) end
 end
 =

 -- 0x20 Teleport packet (also known as ProtocolRecv_Draw_Player)
@@ -102,6 +105,7 @@
 	mobiledata.dir 					=3D input:PopNetUint8()
 	mobiledata.zloc 				=3D input:PopInt8()
 	=

+	--~ print("#>--<#kPacket_Teleport",sprintf("0x%08x",mobiledata.serial),mo=
biledata.xloc,mobiledata.yloc)
 	NotifyTeleport(mobiledata) -- calls CreateOrUpdateMobile and assigns play=
erid
 end
 =


Modified: trunk/lua/net/net.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.skill.lua (original)
+++ trunk/lua/net/net.skill.lua Sun Feb  8 04:09:02 2009
@@ -69,6 +69,8 @@
 		printdebug("skill",sprintf("NET (todo): skill: %s [id=3D%i] skill_value:=
 %i skill_base_value: %i locked?: %i\n",skill_name,skill_id,skill_value,ski=
ll_base_value,skill_lock_state))
 		SkillUpdate(skill_id,skill_value,skill_base_value,skill_lock_state,skill=
_name)
 	end
+	=

+	NotifyListener("Hook_Player_Skills",gPlayerSkills)
 end
 =

 =


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Sun Feb  8 04:09:02 2009
@@ -26,9 +26,6 @@
 RegisterWidgetClass("UOMobListItem")
 =

 =

-function gWidgetPrototype.UOMobList:UpdateSmartTargetIndicator ()
-	local serial =3D MacroCmd_GetSmartTargetForLastSpell()
-end
 	=

 function gWidgetPrototype.UOMobList:Init (parentwidget,params)
 	self:InitAsGroup(parentwidget,params)
@@ -40,6 +37,8 @@
 	=

 	self.gfx_maintarget_listmarker =3D self:CreateChild("UOText",{x=3D0,y=3D0=
,text=3D">",col=3D{r=3D1,g=3D0,b=3D0},bold=3Dtrue})
 	self.gfx_maintarget_listmarker:SetVisible(false)
+	self.gfx_maintarget_listmarker2 =3D self:CreateChild("UOText",{x=3D0,y=3D=
0,text=3D">",col=3D{r=3D0,g=3D0,b=3D1},bold=3Dtrue})
+	self.gfx_maintarget_listmarker2:SetVisible(false)
 	self.gfx_maintarget =3D gRootWidget.tooltip:CreateChild("UOText",{x=3D0,y=
=3D0,text=3D"",col=3D{r=3D1,g=3D0,b=3D0},bold=3Dtrue,html=3Dtrue})
 	self.gfx_maintarget_line =3D gRootWidget.tooltip:CreateChild("LineList",{=
matname=3D"BaseWhiteNoLighting",bDynamic=3Dtrue,r=3D1,g=3D0,b=3D0})
 	=

@@ -188,6 +187,31 @@
 		end
 	else
 		self.gfx_maintarget_listmarker:SetVisible(false)
+	end
+end
+
+function gWidgetPrototype.UOMobList:UpdateSmartTargetIndicator ()
+	local serial =3D MacroCmd_GetSmartTargetForLastSpell()
+	local ypos =3D nil
+	=

+	if (serial) then
+		local mobile =3D GetMobile(serial)
+		local moblist_item =3D mobile and mobile.moblist_item
+		if (moblist_item) then =

+			local ax,ay =3D moblist_item:GetDerivedPos()
+			local bx,by =3D self:GetDerivedPos()
+			ypos =3D ay-by
+		end
+	end
+	-- only update if changed
+	if (self.mySmartTargetIndicator_lastypos ~=3D ypos) then
+		self.mySmartTargetIndicator_lastypos  =3D ypos
+		if (ypos) then
+			self.gfx_maintarget_listmarker2:SetVisible(true)
+			self.gfx_maintarget_listmarker2:SetPos(kMainTargetListMarkerOffX-5,kMai=
nTargetListMarkerOffY+ypos)
+		else =

+			self.gfx_maintarget_listmarker2:SetVisible(false)
+		end
 	end
 end
 =

@@ -237,6 +261,7 @@
 	-- uoam-name-widgets
 	self:UOAMStep()
 	self:StepPartyMarkers()
+	self:UpdateSmartTargetIndicator()
 	=

 	-- maintarget text : update position on screen
 	if (self.maintarget_serial) then



From no-reply at zwischenwelt.org  Sun Feb  8 19:46:21 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 08 Feb 2009 18:46:21 -0000
Subject: [Iris-commit] [IRIS] r2904 - in /trunk/lua: lib.shardlist.lua
	net/net.login.lua
Message-ID: <20090208184621.BCDEE1C18861@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Feb  8 19:46:21 2009
New Revision: 2904

Log:
login:charselect : flags updated to match original client version 6.0.9.2

Modified:
    trunk/lua/lib.shardlist.lua
    trunk/lua/net/net.login.lua

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Sun Feb  8 19:46:21 2009
@@ -4,9 +4,10 @@
 function GetConfigDirPath				() return gMainWorkingDir.."config/" end
 function GetShardListDirPath			() return GetConfigDirPath().."shards/" end
 function GetShardMemoryFilePath			() return GetConfigDirPath().."shardmemo=
ry.xml" end
-function GetCharFilePath				() return GetConfigDirPath().."chars/"..gLogin=
ServerIP.."."..gLoginServerPort.."."..gLoginname.."."..gCharID..".xml" end
-function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..string.gsub(shardname,"[^0-9a-zA-Z_%-%(%) ]",".")..".xml" end
+function GetCharFilePath				() return GetConfigDirPath().."chars/"..table.=
concat({gLoginServerIP,gLoginServerPort,ShardListFileNamePartEncode(gLoginn=
ame),giGameServerID,gCharID},".")..".xml" end
+function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..ShardListFileNamePartEncode(shardname)..".xml" end
 =

+function ShardListFileNamePartEncode	(x) return string.gsub(x,"[^0-9a-zA-Z=
_%-%(%) ]",".") end
 =

 -- notes
 =

@@ -29,6 +30,7 @@
 =

 =

 function InitShardList () =

+	LoadStoredPasswords()
 	LoadShardMemory()
 	LoadShardList()
 	--~ for shardname,shard in pairs(gShardList) do
@@ -47,10 +49,9 @@
 =

 =

 RegisterListener("Hook_Packet_Character_List",function (charlist) =

-	-- gLoginname,gPassword,gLoginServerIP,gLoginServerPort
-	local plaincharlist =3D {}
+	local plaincharlist =3D {serverid=3DgiGameServerID}
 	for k,v in pairs(charlist.chars) do plaincharlist[k] =3D v.name end
-	ShardMemorySet("charlist",gLoginServerIP..":"..gLoginServerPort..":"..gLo=
ginname,plaincharlist)
+	ShardMemorySet("charlist",table.concat({gLoginServerIP,gLoginServerPort,S=
hardListFileNamePartEncode(gLoginname),giGameServerID},":"),plaincharlist)
 end)
 =

 RegisterListener("Hook_Player_Full_equip",function (mobiledata,equipmentda=
ta) =

@@ -133,6 +134,11 @@
 =

 -- ***** ***** ***** ***** ***** stored passwords
 =

+-- store password when login succeeds
+RegisterListener("Hook_Packet_Server_List",function ()
+	if (not gRememberPassword) then return end
+	SetStoredPassword(gLoginServerIP,gLoginServerPort,gLoginname,gPassword)
+end)
 gStoredPasswords =3D {}
 function GetStoredPasswordsFilePath () return GetConfigDirPath().."passwor=
ds.xml" end
 function SaveStoredPasswords () 					SimpleXMLSave(GetStoredPasswordsFileP=
ath(),gStoredPasswords) end

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Sun Feb  8 19:46:21 2009
@@ -39,6 +39,7 @@
 		printdebug("login",sprintf("NET: [%i] '%s' full=3D%i tz=3D%i ip=3D%x\n",=
server.index,server.name,server.full,server.tz,server.ip))
 	end
 	MainMenuShowServerList(serverlist)
+	NotifyListener("Hook_Packet_Server_List",serverlist)
 end
 =

 -- len: 0x10C
@@ -350,6 +351,8 @@
 -- send login server request 0x80
 -- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
 function Send_Account_Login_Request	(sName,sPassword,iSeed) -- 0x80
+	if (sPassword =3D=3D "") then sPassword =3D GetStoredPassword(gLoginServe=
rIP,gLoginServerPort,gLoginname) or sPassword end
+	gLoginname,gPassword =3D sName,sPassword
 	LoginDebug2("s:0x80 Send_Account_Login_Request")
 	printdebug("login",sprintf("NET: Account_Login_Request: Name: %s Password=
: %s\n",gPWReplace or sName,gPWReplace or sPassword))
 	local out =3D GetSendFIFO()
@@ -366,6 +369,7 @@
 function Send_GameServer_Select(iGameServerID) -- 0xA0
 	LoginDebug2("s:0xA0 Send_GameServer_Select")
 	printdebug("login",sprintf("NET: GameServer_Select: %i\n",iGameServerID))
+	giGameServerID =3D iGameServerID
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Server_Select) -- 0xA0
 	out:PushNetUint16(iGameServerID)
@@ -433,6 +437,14 @@
 end
 =

 -- send characterselect to gameserver  0x5D
+--[[
+       -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+0000   5D ED ED ED ED 47 68 6F  6E 67 6F 6C 61 73 00 00   ]....Ghongolas..
+0010   00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ................
+0020   00 00 00 00 00 00 00 00  3F 00 00 00 00 00 00 00   ........?.......
+0030   30 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   0...............
+0040   00 00 00 00 02 0A 00 02  0F                        .........
+]]--
 function Send_Character_Select(iCharacterID,iAccount)
 	LoginDebug2("s:0x5D Send_Character_Select")
 	printdebug("login",sprintf("NET: Character_Select: %i Name: %s Password: =
%s AccountNr.:%x\n",
@@ -442,21 +454,33 @@
 	gCharID =3D iCharacterID
 	=

 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Pre_Login) -- 0x5D
-	out:PushNetUint32(hex2num("0xedededed"))
-	out:PushFilledString(gCharName,30)
-
+	out:PushNetUint8(kPacket_Pre_Login) -- 0x5D		--  1 :  1
+	out:PushNetUint32(hex2num("0xedededed"))		--  4 :  5
+	out:PushFilledString(gCharName,30)				-- 30 : 35
+
+	=

+
+			=

+			=

 	--	out:PushFilledString(gCharacterList[iCharacterID].pw,30)
 =

-	out:PushNetUint16(0)
-	out:PushNetUint32(hex2num("0x0000001F"))	-- RunUO uses this unknown flags=
 (maybe for map 3,4 support)
-
-	out:PushFilledString("",6)					-- obsolete for RunUO
-	out:PushNetUint16(hex2num("0x004B"))		-- obsolete for RunUO - 0x4A (2D_V.=
5.0.8.2_ML) 0x4B (2D_V.5.0.9.1_ML)
-	out:PushFilledString("",16)					-- obsolete for RunUO
-
-	out:PushNetUint32(iCharacterID)
-	out:PushNetUint32(hex2num("0xC0A83016"))	--TODO: check: iAccount or GameS=
erverIP
+	out:PushNetUint16(0)							--  2 : 37
+	=

+			=

+													--  4 : 41
+	--~ out:PushNetUint32(hex2num("0x0000001F"))	-- RunUO uses this unknown f=
lags (maybe for map 3,4 support) (pre.08.02.2008)
+	out:PushNetUint32(hex2num("0x0000003F"))		-- 6.0.9.2 RunUO uses this unkn=
own flags (maybe for map 3,4 support) (08.02.2008:ghoul:packetlog from razo=
r login has 0x3f here)
+	-- razor : int flags =3D pvSrc.ReadInt32();
+	=

+	out:PushFilledString("",6)					--  6 : 47 -- obsolete for RunUO
+	--~ out:PushNetUint16(hex2num("0x004B"))		--  2 : 49 -- obsolete for RunU=
O - 0x4A (2D_V.5.0.8.2_ML) 0x4B (2D_V.5.0.9.1_ML) (pre.08.02.2008)
+	out:PushNetUint16(hex2num("0x0030"))		--  2 : 49 -- obsolete for RunUO - =
6.0.9.2 (08.02.2008:ghoul:packetlog from razor login has 0x30 here)
+	out:PushFilledString("",16)					-- 16 : 65 -- obsolete for RunUO
+
+	out:PushNetUint32(iCharacterID)				--  4 : 69
+	--~ int charSlot =3D pvSrc.ReadInt32();
+	=

+	out:PushNetUint32(hex2num("0xC0A83016"))	--  4 : 73 --TODO: check: iAccou=
nt or GameServerIP
 	out:SendPacket()
 end
 =




From no-reply at zwischenwelt.org  Sun Feb  8 19:53:41 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 08 Feb 2009 18:53:41 -0000
Subject: [Iris-commit] [IRIS] r2905 - in /trunk: bin/ lua/ vc8/ vc9/
Message-ID: <20090208185344.D67091C18861@zwischenwelt.org>

Author: sience
Date: Sun Feb  8 19:53:30 2009
New Revision: 2905

Log:
-vc9 peoject files updated
-all win32 binary updated to VC 2008 Express (Ogre VC 2008 SDK).
-config.lua and mymacros.lua are saved now in "config/" directory not data/=
 anymore !!!

Added:
    trunk/vc9/iris_luajit.sln
    trunk/vc9/iris_luajit.vcproj
Removed:
    trunk/vc9/THIS_IS_OBSOLETE
    trunk/vc9/iris.sln
    trunk/vc9/iris.vcproj
Modified:
    trunk/bin/OIS.dll
    trunk/bin/OgreMain.dll
    trunk/bin/Plugin_CgProgramManager.dll
    trunk/bin/Plugin_ParticleFX.dll
    trunk/bin/RenderSystem_Direct3D9.dll
    trunk/bin/RenderSystem_GL.dll
    trunk/bin/cg.dll
    trunk/bin/iris2.exe
    trunk/lua/config_declarations.lua
    trunk/lua/lib.keybinds.lua
    trunk/lua/main.lua
    trunk/vc8/iris_luajit.sln

Modified: trunk/bin/OIS.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/OgreMain.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_CgProgramManager.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/Plugin_ParticleFX.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_Direct3D9.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/RenderSystem_GL.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/cg.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sun Feb  8 19:53:30 2009
@@ -221,7 +221,7 @@
 -- gShardList["localhost"].gGameServerPort=3D5003
 =

 -- you can specify a specialised filter file for your shard
--- gShardList["localhost"].gCustomArtFilterFilePath =3D "data\\iris.filter=
.lua"
+-- gShardList["localhost"].gCustomArtFilterFilePath =3D "config\\iris.filt=
er.lua"
 =

 =

 -- Standard Serversettings

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Sun Feb  8 19:53:30 2009
@@ -85,7 +85,7 @@
 	=

 	-------------------------------------------------------------------------=
----------
 =

-	if (false) then
+	if (true) then
 		Bind("f7",		function (state) if (not gActiveEditText) then if (state > 0=
) then
 			if (gAmbientLight.r < 1.0) then
 				gAmbientLight.r=3DgAmbientLight.r+0.1
@@ -113,11 +113,11 @@
 		Bind("f9",		function (state) if (not gActiveEditText) then if (state > 0=
) then
 			if (gCompositor) then
 				print("remove compositor")
-				OgreRemoveCompositor(GetMainViewport(),"B&W")
+				OgreRemoveCompositor(GetMainViewport(),"ImageSharpen")
 				gCompositor =3D false
 			else
 				print("add compositor")
-				OgreAddCompositor(GetMainViewport(), "B&W")
+				OgreAddCompositor(GetMainViewport(), "ImageSharpen")
 				gCompositor =3D true
 			end
 		 end end end)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Feb  8 19:53:30 2009
@@ -6,13 +6,15 @@
 datapath 			=3D gMainWorkingDir.."data/"
 libpath 			=3D gMainWorkingDir.."lua/"
 lugreluapath 		=3D gMainWorkingDir..(file_exists(gMainWorkingDir.."mylugre=
") and "mylugre/lua/" or "lugre/lua/")
---~ gConfigPathFallback	=3D datapath.."config.lua.dist"
---~ gConfigPathFallback	=3D libpath.."config_declarations.lua"
-gConfigPath 		=3D datapath.."config.lua"
-gMacroPath 			=3D datapath.."mymacros.lua"
 gMacroPathFallback	=3D datapath.."mymacros.lua.dist"
 gMainPluginDir 		=3D gMainWorkingDir.."plugins/"
-gConfigDirPath 		=3D gMainWorkingDir.."config/"
+gConfigPath 		=3D gMainWorkingDir.."config/"
+gMacroFile			=3D "mymacros.lua"
+gMacroPathFile		=3D gConfigPath..gMacroFile
+gMacroPathFile_old	=3D datapath..gMacroFile			-- only as Fallback for old =
users
+gConfigFile			=3D "config.lua"
+gConfigPathFile		=3D gConfigPath..gConfigFile
+gConfigPathFile_old =3D datapath..gConfigFile			-- only as Fallback for ol=
d users
 gIrisWidgetDir 		=3D libpath.."widgets/"
 gTempPath			=3D datapath.."tmp/"
 gSecondsSinceLastFrame =3D 0
@@ -123,24 +125,21 @@
 --###        CONFIG           ###
 --###############################
 =

---~ dofile(gConfigPathFallback)
-if (file_exists(gConfigPath)) then
+if (file_exists(gConfigPathFile)) then
 	-- execute local config
-	dofile(gConfigPath)
+	dofile(gConfigPathFile)
+elseif (file_exists(gConfigPathFile_old)) then
+	-- search for old config in data/ directory
+	dofile(gConfigPathFile_old)
 else
 	-- no local config file, copy dist config
-	local fp =3D io.open(gConfigPath,"w")
+	local fp =3D io.open(gConfigPathFile,"w")
 	fp:write("-- this is your local config file, here you can override the de=
fault options\n")
 	fp:write("-- gUOPath =3D \"C:\\\\stuff\\\\iris\\\\uo\\\\\" -- enter the p=
ath to your uo data dir here\n")
 	fp:write("\n")
 	fp:write("-- \"ultralow\", \"low\", \"med\", \"high\", \"ultrahigh\, \"no=
ne\"\n")
 	fp:write("gGraphicProfile =3D \"med\"\n")
 	fp:write("\n")
---	for line in io.lines(gConfigPathFallback) do =

---		if (not string.find(line,"DO NOT EDIT THIS FILE DIRECTLY")) then =

---			fp:write(line.."\n") =

---		end =

---	end
 	fp:close()
 end
 =

@@ -151,12 +150,15 @@
 function LoadMacros ()
 	dofile(gMacroPathFallback)
 =

-	if (file_exists(gMacroPath)) then
+	if (file_exists(gMacroPathFile)) then
 		-- execute local config
-		dofile(gMacroPath)
+		dofile(gMacroPathFile)
+	elseif (file_exists(gMacroPathFile_old)) then
+		-- search for old config in data/ directory
+		dofile(gMacroPathFile_old)
 	else
 		-- no local config file, copy dist config
-		local fp =3D io.open(gMacroPath,"w")
+		local fp =3D io.open(gMacroPathFile,"w")
 		fp:write("-- this is your local macro file, here you can configure your =
macro commands\n")
 		for line in io.lines(gMacroPathFallback) do =

 			if (not string.find(line,"DO NOT EDIT THIS FILE DIRECTLY")) then =

@@ -182,10 +184,13 @@
 	end
 end
 =

--- reparse config to overwrite profile settings
-if (file_exists(gConfigPath)) then
+-- reparse config.lua to overwrite profile settings
+if (file_exists(gConfigPathFile)) then
 	-- execute local config
-	dofile(gConfigPath)
+	dofile(gConfigPathFile)
+elseif (file_exists(gConfigPathFile_old)) then
+	-- search for old config in data/ directory
+	dofile(gConfigPathFile_old)
 end
 =

 --###############################

Modified: trunk/vc8/iris_luajit.sln
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc8/iris_luajit.sln (original)
+++ trunk/vc8/iris_luajit.sln Sun Feb  8 19:53:30 2009
@@ -6,7 +6,7 @@
 		{D7488B96-456A-1E46-8B0B-0F698E025694} =3D {D7488B96-456A-1E46-8B0B-0F69=
8E025694}
 	EndProjectSection
 EndProject
-Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "LuaJIT-1.1.5", "..\=
lugre\lib\LuaJIT-1.1.5\mak.vs2005\LuaJIT-1.1.5_lib.vcproj", "{D7488B96-456A=
-1E46-8B0B-0F698E025694}"
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "LuaJIT-1.1.5", "..\=
lugre\lib\LuaJIT-1.1.5\mak.vc2005\LuaJIT-1.1.5_lib.vcproj", "{D7488B96-456A=
-1E46-8B0B-0F698E025694}"
 EndProject
 Global
 	GlobalSection(SolutionConfigurationPlatforms) =3D preSolution



From no-reply at zwischenwelt.org  Sun Feb  8 19:57:22 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 08 Feb 2009 18:57:22 -0000
Subject: [Iris-commit] [IRIS] r2906 - /trunk/lua/lib.keybinds.lua
Message-ID: <20090208185723.0D9C91C18861@zwischenwelt.org>

Author: sience
Date: Sun Feb  8 19:57:22 2009
New Revision: 2906

Log:
-revert the former changes

Modified:
    trunk/lua/lib.keybinds.lua

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Sun Feb  8 19:57:22 2009
@@ -85,7 +85,7 @@
 	=

 	-------------------------------------------------------------------------=
----------
 =

-	if (true) then
+	if (false) then
 		Bind("f7",		function (state) if (not gActiveEditText) then if (state > 0=
) then
 			if (gAmbientLight.r < 1.0) then
 				gAmbientLight.r=3DgAmbientLight.r+0.1
@@ -113,11 +113,11 @@
 		Bind("f9",		function (state) if (not gActiveEditText) then if (state > 0=
) then
 			if (gCompositor) then
 				print("remove compositor")
-				OgreRemoveCompositor(GetMainViewport(),"ImageSharpen")
+				OgreRemoveCompositor(GetMainViewport(),"B&W")
 				gCompositor =3D false
 			else
 				print("add compositor")
-				OgreAddCompositor(GetMainViewport(), "ImageSharpen")
+				OgreAddCompositor(GetMainViewport(), "B&W")
 				gCompositor =3D true
 			end
 		 end end end)



From no-reply at zwischenwelt.org  Sun Feb  8 20:41:07 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 08 Feb 2009 19:41:07 -0000
Subject: [Iris-commit] [IRIS] r2907 - /trunk/lua/main.lua
Message-ID: <20090208194108.19A0A1C1866A@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Feb  8 20:41:07 2009
New Revision: 2907

Log:
directx9 exception messagebox with explanation and browser opening for down=
load if ok is pressed

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sun Feb  8 20:41:07 2009
@@ -339,20 +339,16 @@
 		local tipp =3D	"Your DirectX9 version is too old to run Iris.\n"..
 						"Would you like to open a browser and download an Updated Version fr=
om the following url ?\n"..url
 		print(tipp)
+		=

+		local res =3D LugreMessageBox(kLugreMessageBoxType_YesNo,"Update DirectX=
9",tipp)
+		if (res =3D=3D kLugreMessageBoxResult_Yes) then
+			OpenBrowser(url)
+		end
 	end
 end
 =

 --- main function, when it returns, the program ends
 function Main ()
-	--~ if (LugreMessageBox) then =

-		--~ print("LugreMessageBox defined")
-		--~ local res =3D LugreMessageBox(kLugreMessageBoxType_YesNo,"Update Dir=
ectX9","blaa, tollertipp")
-		--~ if (res =3D=3D kLugreMessageBoxResult_Yes) then
-		=

-		--~ end
-		=

-	--~ end
-		=

 	gRegistry =3D cRegistry:New(gTempPath.."global.reg")
 =

 	-- detect UOPath



From no-reply at zwischenwelt.org  Tue Feb 10 01:08:17 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Feb 2009 00:08:17 -0000
Subject: [Iris-commit] [IRIS] r2908 - in /trunk: bin/fmodex.dll
 bin/iris2.exe vc8/iris.sln vc9/iris.sln vc9/iris.vcproj
Message-ID: <20090210000817.746401C1866A@zwischenwelt.org>

Author: sience
Date: Tue Feb 10 01:08:16 2009
New Revision: 2908

Log:
-win32 binary now compiled again with LUA 5.1.4 (not luajit because i got u=
nexpected crashes)
-fmod updated
-vc9 project for lua added (not luajit)

Added:
    trunk/vc9/iris.sln
    trunk/vc9/iris.vcproj
Modified:
    trunk/bin/fmodex.dll
    trunk/bin/iris2.exe
    trunk/vc8/iris.sln

Modified: trunk/bin/fmodex.dll
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/vc8/iris.sln
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc8/iris.sln (original)
+++ trunk/vc8/iris.sln Tue Feb 10 01:08:16 2009
@@ -6,7 +6,7 @@
 		{D7488B96-456A-1E46-8B0B-0F698E025694} =3D {D7488B96-456A-1E46-8B0B-0F69=
8E025694}
 	EndProjectSection
 EndProject
-Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "lua5.1_lib", "..\lu=
gre\lib\lua-5.1.4\mak.vs2005\lua5.1_lib.vcproj", "{D7488B96-456A-1E46-8B0B-=
0F698E025694}"
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "lua5.1_lib", "..\lu=
gre\lib\lua-5.1.4\mak.vc2005\lua5.1_lib.vcproj", "{D7488B96-456A-1E46-8B0B-=
0F698E025694}"
 EndProject
 Global
 	GlobalSection(SolutionConfigurationPlatforms) =3D preSolution



From no-reply at zwischenwelt.org  Tue Feb 10 01:15:54 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Feb 2009 00:15:54 -0000
Subject: [Iris-commit] [IRIS] r2909 - in /branches/stable_release:
 vc8/iris.sln vc8/iris_luajit.sln vc9/iris.sln vc9/iris.vcproj
Message-ID: <20090210001554.8E4BC1C1884D@zwischenwelt.org>

Author: sience
Date: Tue Feb 10 01:15:54 2009
New Revision: 2909

Log:
-updated for vc2005

Modified:
    branches/stable_release/vc8/iris.sln
    branches/stable_release/vc8/iris_luajit.sln
    branches/stable_release/vc9/iris.sln
    branches/stable_release/vc9/iris.vcproj

Modified: branches/stable_release/vc8/iris.sln
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/stable_release/vc8/iris.sln (original)
+++ branches/stable_release/vc8/iris.sln Tue Feb 10 01:15:54 2009
@@ -6,7 +6,7 @@
 		{D7488B96-456A-1E46-8B0B-0F698E025694} =3D {D7488B96-456A-1E46-8B0B-0F69=
8E025694}
 	EndProjectSection
 EndProject
-Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "lua5.1_lib", "..\lu=
gre\lib\lua-5.1.4\mak.vs2005\lua5.1_lib.vcproj", "{D7488B96-456A-1E46-8B0B-=
0F698E025694}"
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "lua5.1_lib", "..\lu=
gre\lib\lua-5.1.4\mak.vc2005\lua5.1_lib.vcproj", "{D7488B96-456A-1E46-8B0B-=
0F698E025694}"
 EndProject
 Global
 	GlobalSection(SolutionConfigurationPlatforms) =3D preSolution

Modified: branches/stable_release/vc8/iris_luajit.sln
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/stable_release/vc8/iris_luajit.sln (original)
+++ branches/stable_release/vc8/iris_luajit.sln Tue Feb 10 01:15:54 2009
@@ -6,7 +6,7 @@
 		{D7488B96-456A-1E46-8B0B-0F698E025694} =3D {D7488B96-456A-1E46-8B0B-0F69=
8E025694}
 	EndProjectSection
 EndProject
-Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "LuaJIT-1.1.5", "..\=
lugre\lib\LuaJIT-1.1.5\mak.vs2005\LuaJIT-1.1.5_lib.vcproj", "{D7488B96-456A=
-1E46-8B0B-0F698E025694}"
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "LuaJIT-1.1.5", "..\=
lugre\lib\LuaJIT-1.1.5\mak.vc2005\LuaJIT-1.1.5_lib.vcproj", "{D7488B96-456A=
-1E46-8B0B-0F698E025694}"
 EndProject
 Global
 	GlobalSection(SolutionConfigurationPlatforms) =3D preSolution

Modified: branches/stable_release/vc9/iris.sln
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/stable_release/vc9/iris.sln (original)
+++ branches/stable_release/vc9/iris.sln Tue Feb 10 01:15:54 2009
@@ -6,7 +6,7 @@
 		{D7488B96-456A-1E46-8B0B-0F698E025694} =3D {D7488B96-456A-1E46-8B0B-0F69=
8E025694}
 	EndProjectSection
 EndProject
-Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "lua5.1_lib", "..\lu=
gre\lib\lua-5.1.3\mak.vs2005\lua5.1_lib.vcproj", "{D7488B96-456A-1E46-8B0B-=
0F698E025694}"
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") =3D "lua5.1_lib", "..\lu=
gre\lib\lua-5.1.4\mak.vc2008\lua5.1_lib.vcproj", "{D7488B96-456A-1E46-8B0B-=
0F698E025694}"
 EndProject
 Global
 	GlobalSection(SolutionConfigurationPlatforms) =3D preSolution

Modified: branches/stable_release/vc9/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- branches/stable_release/vc9/iris.vcproj (original)
+++ branches/stable_release/vc9/iris.vcproj Tue Feb 10 01:15:54 2009
@@ -126,7 +126,7 @@
 				OmitFramePointers=3D"true"
 				EnableFiberSafeOptimizations=3D"false"
 				WholeProgramOptimization=3D"true"
-				AdditionalIncludeDirectories=3D"&quot;c:\Programme\Microsoft SDKs\Wind=
ows\v6.0A\Include\&quot;;&quot;$(OGRE_HOME)\include\&quot;;&quot;$(OGRE_HOM=
E)\include\OIS\&quot;;..\include\;..\include\zlib;..\lugre\include;..\inclu=
de\fmodx;&quot;..\lugre\lib\lua-5.1.3\src\&quot;;..\lugre\lib\md5\include;.=
.\lugre\lib\cadune_tree\include;..\lugre\lib\paged_geometry\include;..\lugr=
e\lib\caelum\include"
+				AdditionalIncludeDirectories=3D"&quot;c:\Programme\Microsoft SDKs\Wind=
ows\v6.0A\Include\&quot;;&quot;$(OGRE_HOME)\include\&quot;;&quot;$(OGRE_HOM=
E)\include\OIS\&quot;;..\include\;..\include\zlib;..\lugre\include;..\inclu=
de\fmodx;&quot;..\lugre\lib\lua-5.1.4\src\&quot;;..\lugre\lib\md5\include;.=
.\lugre\lib\cadune_tree\include;..\lugre\lib\paged_geometry\include;..\lugr=
e\lib\caelum\include"
 				PreprocessorDefinitions=3D"WIN32;NDEBUG;_WINDOWS;MAIN_WORKING_DIR=3D\&=
quot;../\&quot;;USE_FMOD;USE_LUGRE_LIB_MD5;USE_LUGRE_LIB_CADUNE_TREE;USE_LU=
GRE_LIB_CAELUM"
 				GeneratePreprocessedFile=3D"0"
 				StringPooling=3D"true"
@@ -152,7 +152,7 @@
 				Name=3D"VCLinkerTool"
 				AdditionalDependencies=3D"AdvAPI32.Lib User32.Lib ws2_32.lib zlib.lib =
OgreMain.lib OIS.lib lua5.1.lib fmodex_vc.lib"
 				OutputFile=3D"$(OutDir)\..\..\bin\iris2.exe"
-				AdditionalLibraryDirectories=3D"&quot;c:\Programme\Microsoft SDKs\Wind=
ows\v6.0A\Lib\&quot;;&quot;$(OGRE_HOME)\lib\&quot;;..\libs\fmodx;..\libs\zl=
ib;&quot;..\lugre\lib\lua-5.1.3\lib\static&quot;;&quot;c:\Programme\Microso=
ft Platform SDK\Lib&quot;;..\lugre\lib\caelum\lib\static;..\lugre\lib\paged=
_geometry\lib\static;c:\Programme\boost\boost_1_34_1\lib"
+				AdditionalLibraryDirectories=3D"&quot;c:\Programme\Microsoft SDKs\Wind=
ows\v6.0A\Lib\&quot;;&quot;$(OGRE_HOME)\lib\&quot;;..\libs\fmodx;..\libs\zl=
ib;&quot;..\lugre\lib\lua-5.1.4\lib\static&quot;;&quot;c:\Programme\Microso=
ft Platform SDK\Lib&quot;;..\lugre\lib\caelum\lib\static;..\lugre\lib\paged=
_geometry\lib\static;c:\Programme\boost\boost_1_34_1\lib"
 				GenerateManifest=3D"true"
 				IgnoreAllDefaultLibraries=3D"false"
 				IgnoreDefaultLibraryNames=3D"LIBCMT.lib"



From no-reply at zwischenwelt.org  Tue Feb 10 16:34:00 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Feb 2009 15:34:00 -0000
Subject: [Iris-commit] [IRIS] r2910 - in /trunk: config/ lua/ lua/net/
	plugins/
Message-ID: <20090210153400.DA1011C1866A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Feb 10 16:33:59 2009
New Revision: 2910

Log:
rewrote mainmenu (cleanup + improved acclist and new charcreate dialog (so =
far skills+stats, but no hairstyle+colors yet)), xml-based registry-slow, p=
ing sent during charlist+charcreate to avoid kick after 1 minute, small imp=
rovement in charcreate netcode

Added:
    trunk/lua/lib.mainmenu.accountlist.lua
    trunk/lua/lib.mainmenu.background.lua
    trunk/lua/lib.mainmenu.charcreate.lua
    trunk/lua/lib.mainmenu.charlist.lua
    trunk/lua/lib.mainmenu.old.lua
    trunk/lua/lib.mainmenu.shardlist.lua
    trunk/lua/lib.registry.slow.lua
Modified:
    trunk/config/   (props changed)
    trunk/lua/lib.charcreate.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.shardlist.lua
    trunk/lua/main.lua
    trunk/lua/net/net.login.lua
    trunk/lua/net/net.other.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.charcreate.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.charcreate.lua (original)
+++ trunk/lua/lib.charcreate.lua Tue Feb 10 16:33:59 2009
@@ -17,6 +17,15 @@
 	chardata.name =3D name
 	chardata.pass =3D pass
 	chardata.sex =3D 0
+	for k,v in pairs(CharCreateTemplateMod_GetValues(template)) do chardata[k=
] =3D v end
+	if (MyCharCreateHack) then MyCharCreateHack(chardata) end
+	Send_CharCreate(chardata)
+	return true
+end
+
+function CharCreateTemplateMod_GetValues (template)
+	local chardata =3D {}
+	chardata.prof =3D tonumber(template["Desc"])
 	chardata.skill1 =3D gCharCreateSkillIDs[template.skills[1].name] or 0
 	chardata.skill2 =3D gCharCreateSkillIDs[template.skills[2].name] or 0
 	chardata.skill3 =3D gCharCreateSkillIDs[template.skills[3].name] or 0
@@ -26,9 +35,7 @@
 	chardata.str =3D template.stats["Str"]
 	chardata.dex =3D template.stats["Dex"]
 	chardata.int =3D template.stats["Int"]
-	if (MyCharCreateHack) then MyCharCreateHack(chardata) end
-	Send_CharCreate(chardata)
-	return true
+	return chardata
 end
 =

 function GetCharCreationTemplates () =

@@ -52,6 +59,7 @@
 			if (tokens[2] =3D=3D "Skill")		then table.insert(lastinfo.skills,{name=
=3Dtrim(tokens[3]),value=3Dval})
 			elseif (tokens[2] =3D=3D "Stat")	then lastinfo.stats[trim(tokens[3])] =
=3D val
 			else lastinfo[trim(tokens[2])] =3D trim(tokens[3]) end
+			-- Desc			3  : prof id for charcreate message ?
 		end
 	end
 	end

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Tue Feb 10 16:33:59 2009
@@ -1,82 +1,306 @@
 -- handles the menu before starting the game
 =

-gMainMenuCamAng =3D 0
-
-local function GetShardButtonText (shard,shardname)
-	if (shard.gLoginname) then
-		return shardname..":"..(shard.gLoginname or "")
+dofile(libpath .. "lib.mainmenu.background.lua")
+dofile(libpath .. "lib.mainmenu.shardlist.lua")
+dofile(libpath .. "lib.mainmenu.accountlist.lua")
+dofile(libpath .. "lib.mainmenu.charlist.lua")
+dofile(libpath .. "lib.mainmenu.charcreate.lua")
+
+
+
+function StartMainMenu	() =

+	SetUOCursor(0)
+	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
+	ChatLine_Init()	=

+	if (MainMenuCommandLine()) then return end
+	MainMenu_Background_Start()
+	MainMenu_ShardList_Start()
+end
+function StepMainMenu	() end
+
+function MainMenuStopAllMenus	() =

+	MainMenu_ShardList_Stop()
+	MainMenu_AccountList_Stop()
+	MainMenu_ServerList_Stop()
+	MainMenu_CharList_Stop()
+	MainMenu_CharCreate_Stop()
+end
+
+function MainMenuResetNetwork () =

+	NetDisconnect()
+	gHuffmanDecode =3D false
+end
+
+
+
+-- ***** ***** ***** ***** ***** commandline
+
+function MainMenuCommandLine ()
+	if (gTestNoMainMenu) then return end
+	if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end -- =
journaltest
+	if (gCommandLineSwitches["-jt"]) then ToggleJournal() return true end -- =
journaltest
+	if (gCommandLineSwitches["-mt"]) then ToggleMacroList() return true end -=
- macrolist-test
+	if (gCommandLineSwitches["-so"]) then StartOfflineMode(gCommandLineArgume=
nts[gCommandLineSwitches["-so"]+1]) return true end -- start in offline mode
+	if (gCommandLineSwitches["-sd"]) then StartDebugMenu() return true end --=
 start in debug mode
+	if (gCommandLineSwitches["-co"]) then =

+		local name =3D gCommandLineArguments[gCommandLineSwitches["-co"]+1]
+		local shard =3D gShardList[name]
+		if (shard) then =

+			gAutoLoginCharName =3D gCommandLineArguments[gCommandLineSwitches["-co"=
]+2]
+			=

+			-- if charname specified, and shard hasn't full login already, search k=
nown charlists and passwords
+			if (gAutoLoginCharName and (((shard.gLoginname or "") =3D=3D "") or ((s=
hard.gPassword or "") =3D=3D ""))) then =

+				print("autologin...searching for charname:",gAutoLoginCharName)
+				local charlists =3D FilterTable(ShardMemoryGetList("charlist"),functio=
n (charlist) return	=

+																	charlist.gLoginServerIP		=3D=3D shard.gLoginServerIP and =

+																	charlist.gLoginServerPort	=3D=3D shard.gLoginServerPort e=
nd)
+				for k,charlist in pairs(charlists) do =

+					for i=3D0,20 do =

+						print("..",charlist[i])
+						if (not charlist[i]) then break end
+						if (string.lower(charlist[i]) =3D=3D string.lower(gAutoLoginCharName=
)) then
+							gAutoLoginCharName =3D charlist[i]
+							gLoginname =3D charlist.gLoginname
+							gPassword =3D MainMenu_GetStoredPassword(shard.gLoginServerIP,shard=
.gLoginServerPort,gLoginname)
+							print("found",gAutoLoginCharName,gLoginname,gPassword)
+						end
+					end
+				end
+			end
+			MainMenu_SelectShard(shard)
+			return true
+		end
+	end -- connect to shard
+end
+
+
+-- ***** ***** ***** ***** ***** actions and events
+
+function MainMenu_SelectShard (shard)
+	print("MainMenu_SelectShard",shard,shard.gShardName)
+	MainMenuStopAllMenus()
+	gSelectedShardName =3D shard.gShardName
+	=

+	LoadShardfilter(shard.gCustomArtFilterFilePath) -- todo : revert on error=
 or back-button ?
+	=

+	-- load global config from shard
+	for k,v in pairs(shard) do _G[k] =3D v end
+	=

+	if (shard.gStartGameWithoutNetwork =3D=3D true) then
+		StartOfflineMode()
+	elseif(shard.gStartInDebugMode =3D=3D true) then
+		StartDebugMenu()
 	else
-		return shardname
-	end
-end
-
-local function StopLoadingBackground ()
-	if (gLoadingBackground) then
-		gLoadingBackground:Destroy()
-	end
-end
-
-local function MainMenuConnectToShard (shard,shardname,loginname,loginpass)
-	-- activate shard
-	for k,v in pairs(shard) do =

-		--print("shard",k,v) =

-		_G[k] =3D v  -- set global var with name k and value v
-	end
-	if (loginname) then gLoginname =3D loginname end	-- Loginname
-	if (loginpass) then gPassword =3D loginpass end	-- Password
-	=

-	if ((not gLoginname) or gLoginname =3D=3D "" or (not gPassword) or gPassw=
ord =3D=3D "") then
-		local text =3D "cannot connect to shard '"..shardname.."', no username/p=
assword specified"
+		if (gLoginname and gLoginname ~=3D "" and gPassword and gPassword ~=3D "=
") then MainMenu_SendLogin(gLoginname,gPassword) return end
+		MainMenu_AccountList_Start()
+	end
+end
+
+-- answered by MainMenuShowServerList
+function MainMenu_SendLogin (user,pass)
+	print("##################################")
+	print("MainMenu_SendLogin",user)
+	MainMenuStopAllMenus()
+	--~ (gSelectedShardName or "???") fails here...
+	GuiAddChatLine("connecting to shard "..gLoginServerIP..":"..gLoginServerP=
ort.." with user "..user)
+	=

+	-- init net
+	gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServerS=
eed)
+	if (not gNet_State) then =

+		local text =3D "connecting to shard on "..gLoginServerIP..":"..gLoginSer=
verPort.." FAILED !"
 		GuiAddChatLine(text)
 		PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
+		MainMenu_AccountList_Start()
 		return
 	end
 	=

-	GuiAddChatLine("connecting to shard '"..shardname.."' on "..gLoginServerI=
P..":"..gLoginServerPort)
-	=

-	-- todo : move to gui ?
+	Send_Account_Login_Request(user,pass) -- 0x80 kPacket_Account_Login_Reque=
st
+end
+
+function MainMenu_SendLoginAndChar (user,pass,charid,charname)
+	print("##################################")
+	print("MainMenu_SendLoginAndChar",user,charid,charname)
+	gAutoLoginCharID =3D charid
+	gAutoLoginCharName =3D charname
+	MainMenu_SendLogin(user,pass)
+end	=

+
+function MainMenu_GetStoredPassword(host,port,user)
+	-- stored passwords
+	local pass =3D GetStoredPassword(host,port,user)
+	if (pass and pass ~=3D "") then return pass end
+	-- shard configs
+	for k,shard in pairs(gShardList) do =

+		if (shard.gLoginname =3D=3D user and
+			shard.gLoginServerIP =3D=3D host and
+			shard.gLoginServerPort =3D=3D port and
+			shard.gPassword and shard.gPassword ~=3D "") then return shard.gPasswor=
d end
+	end
+end
+
+function MainMenuLoginRejected	(msg)
+	print("##################################")
+	print("MainMenuLoginRejected")
+	MainMenuResetNetwork()
+	MainMenu_AccountList_Start()
+	PlainMessageBox(msg)
+end
+	=

+function MainMenuShowServerList	(serverlist)	=

+	print("##################################")
+	print("MainMenuShowServerList")
+	MainMenuStopAllMenus()
+	=

+	-- if there is only once choice, select it immediately
+	if (countarr(serverlist.servers) =3D=3D 1) then
+		local k,v =3D next(serverlist.servers)
+		MainMenu_SendServer(v.index)
+		return
+	end
+	=

+	-- show serverlist
+	local rows =3D {}
+	for k,v in pairs(serverlist.servers) do
+		local label =3D sprintf("Choose server [%d]%s full=3D%d tz=3D%d ip=3D%s"=
,v.index,v.name,v.full,v.tz,NtoA(v.ip))
+		table.insert(rows,{{label,function () MainMenu_SendServer(v.index) end}})
+	end
+	gMainMenuDialog_ServerList =3D MainMenu_MakeTableDlg(rows)
+end
+
+function MainMenu_ServerList_Stop ()
+	if (gMainMenuDialog_ServerList) then =

+		gMainMenuDialog_ServerList:Destroy() =

+		gMainMenuDialog_ServerList =3D nil
+	end
+end
+
+-- answered by MainMenuShowCharList
+function MainMenu_SendServer (iServerID)
+	print("##################################")
+	print("MainMenu_SendServer",iServerID)
+	MainMenuStopAllMenus()
+	Send_GameServer_Select(iServerID or 0) -- 0xA0 kPacket_Server_Select =

+	-- answered by kPacket_Server_Redirect 0x8C, =

+	-- which calls Send_GameServer_PostLogin kPacket_Post_Login 0x91 =

+	-- answered by kPacket_Features 0xB9 and kPacket_Character_List 0xA9 whic=
h calls MainMenuShowCharList
+end
+
+function MainMenu_SendSelectChar	(charid)
+	print("##################################")
+	print("MainMenu_SendSelectChar",charid)		=

+	MainMenuStopAllMenus() =

+	PreLoadAfterManualRenderSwitch()
+	Send_Character_Select(charid,gGameServerAccount) -- 0x5D
+end
+		=

+function MainMenuShowCharList	(charlist)		=

+	print("##################################")
+	print("MainMenuShowCharList")	=

+	MainMenuStopAllMenus() =

+	=

+	gPingActive =3D true
+	gNextPingTime =3D 0
+	gShardCharlist =3D charlist
+	=

+	-- login by charslot id
+	if (gAutoLoginCharID) then MainMenu_SendSelectChar(gAutoLoginCharID) retu=
rn end
+	=

+	-- login by name (commandline)
+	if (gAutoLoginCharName) then =

+		for k,v in pairs(charlist.chars) do
+			if (v.name ~=3D "" and (v.name =3D=3D gAutoLoginCharName or tonumber(gA=
utoLoginCharName) =3D=3D k + 1)) then =

+				local iCharNum =3D k
+				MainMenu_SendSelectChar(iCharNum)
+				gSelectedCharName =3D v.name
+				return
+			end
+		end
+	end
+	=

+	MainMenu_CharList_Start()
+end
+
+-- ***** ***** ***** ***** ***** MakeTableDlg for common styling
+
+function MainMenu_MakeTableDlg		(rows,x,y)
+	return guimaker.MakeTableDlg(rows,x or 10,y or 10,false,true,gGuiDefaultS=
tyleSet,"window") =

+end
+ =

+-- ***** ***** ***** ***** ***** specials
+
+function MainMenu_Special_OfflineMode	() MainMenu_SelectShard({gStartGameW=
ithoutNetwork =3D true}) end
+function MainMenu_Special_DebugMode		() MainMenu_SelectShard({gStartInDebu=
gMode =3D true}) end
+function MainMenu_Special_GfxConfig		()
+	MainMenuStopAllMenus()
+	if (Client_ShowOgreConfig()) then
+		DisplayNotice("please restart iris2 for the changes to take effekt")
+		StopMainMenu()
+		Exit() -- Terminate()  -- terminate softly is not enough, no frame can b=
e drawn since ogre::root has to be killed for fullscreen switch
+		-- todo : reinit ogre here ? might loose already loaded textures =3D(
+	end
+end
+function MainMenu_Special_Exit			() MainMenuStopAllMenus() Terminate() end
+
+-- ***** ***** ***** ***** ***** offline mode
+
+-- postxt is a string for the position, e.g. 5260,1333  , can be nil
+function StartOfflineMode (postxt)
+	print("##################################")
+	print("StartOfflineMode",postxt)		=

+	MainMenuStopAllMenus() =

+	=

+	if (gCommandLineSwitches["-som"]) then =

+		local confname =3D gCommandLineArguments[gCommandLineSwitches["-som"]+1]
+		print("StartOfflineMode config",confname)
+		gMaps =3D gMaps or {}
+		for k,v in pairs((gShardList[confname] or {}).gMaps or {}) do print("gMa=
ps["..k.."] override") gMaps[k] =3D v end
+	end
+	if (gCommandLineSwitches["-so"]) then =

+		gOfflineModeMapIndex =3D tonumber(gCommandLineArguments[gCommandLineSwit=
ches["-so"]+2]) or gOfflineModeMapIndex
+	end
+	if (gOfflineModeMapIndex) then MapChangeRequest(gOfflineModeMapIndex) end
+	=

 	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-	ChatLine_Init()	=

-	=

-	gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServerS=
eed)
-	if (not gNet_State) then =

-		local text =3D "connecting to shard '"..shardname.."' on "..gLoginServer=
IP..":"..gLoginServerPort.." FAILED !"
-		GuiAddChatLine(text)
-		PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
-		return
-	end
-	=

-	Send_Account_Login_Request(gLoginname,gPassword) -- 0x80 kPacket_Account_=
Login_Request
-	-- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
-end
-
-local function MainMenuShowCharCreationDialog (template,slot)
-	-- TODO : unfinished, need more gui-elements for colorpicking, skill valu=
es etc..
-	=

-	local MyCreateChar =3D function(widget) =

-		local edittextwidget =3D widget.dialog.controls["nameinput"]
-		--print("MyCreateChar",widget.chartemplate,widget.charslot,edittextwidge=
t.plaintext)
-		CreateCharFromTemplate(widget.chartemplate,widget.charslot,edittextwidge=
t.plaintext ,"") -- see lib.charcreate.lua
-		widget.dialog:Destroy()
-	end
-	local rows =3D {
-		{	{type=3D"Label",		text=3D"Character Creation"} },
+
+	gStartGameWithoutNetwork =3D true
+	MultiTexTerrain_NotifyMapChange()
+	=

+	--~ local x,y,z =3D -183,203,0
+	local x,y,z =3D -1483,1527,2 -- osi-britannia
+	=

+	--if (gGroundBlockLoader) then x,y,z =3D -gGroundBlockLoader:GetMapW()*8/=
2,gGroundBlockLoader:GetMapH()*8/2,0 end
+	if (gOfflineModeCamStart) then x,y,z =3D unpack(gOfflineModeCamStart) end
+	=

+	if (postxt) then
+		local t1,t2,t3 =3D unpack(strsplit(",",postxt))
+		x,y,z =3D tonumber(t1) and -tonumber(t1) or x, tonumber(t2) or y, tonumb=
er(t3) or z
+		print("StartOfflineMode ",x,y,z,t1,t2,t3)
+	end
 		=

-		{	{type=3D"Label",		text=3D"Name:"},
-			{type=3D"EditText",	w=3D300,h=3D16,text=3D"",controlname=3D"nameinput"}=
  }, -- "IrisTestChar"
-			=

-		{	{type=3D"Button",onLeftClick=3DMyCreateChar,chartemplate=3Dtemplate,ch=
arslot=3Dslot,text=3D"Create Character"},
-			{type=3D"Label",	text=3D"(iris does not support all the options for cha=
r creation yet,\n"..
-								"you can only pick a name, if you want to set all the options your=
self,\n"..
-								"you can create the char using another client, and then login with=
 iris)"}
-			},
-		=

-	}
-	=

-	gCharCreateDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefa=
ultStyleSet,"window")
-end
-
-local function LoadShardfilter(filterfilepath)
+	gCurrentRenderer:InitLocalCam(x,y,z)
+
+	-- Binds key and Inits all InGame-Data
+	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
+
+	-- set z position to terrainheight at starting location
+	local tt,zz =3D GetGroundAtAbsPos(-x,y)
+	if zz then
+		--~ print("#",x,y,tt,z,zz) =

+		z =3D zz
+	end
+
+	gCurrentRenderer:SetOfflineStartPos(x,y,z)
+
+	-- offline : tilefree walk teleport
+	BindDown("f6",function () gCurrentRenderer:OfflineTeleportToMouse() end)
+	=

+	-- Unbind some keys only for offline mode (rest is the same as InGame)
+	UnBindArr({"u","q","e","tab","r","t","k","j","b","p","g","h","y"})
+end
+
+-- ***** ***** ***** ***** ***** Shardfilter
+
+function LoadShardfilter	(filterfilepath)
 	if (filterfilepath) then
 		if (file_exists(gMainWorkingDir..filterfilepath) ) then
 			print("Load custom shard-specific Filter: "..gMainWorkingDir..filterfil=
epath)
@@ -86,346 +310,3 @@
 		end
 	end
 end
-
--- postxt is a string for the position, e.g. 5260,1333  , can be nil
-local function StartOfflineMode (postxt)
-	if (gCommandLineSwitches["-som"]) then =

-		local confname =3D gCommandLineArguments[gCommandLineSwitches["-som"]+1]
-		print("StartOfflineMode config",confname)
-		gMaps =3D gMaps or {}
-		for k,v in pairs((gShardList[confname] or {}).gMaps or {}) do print("gMa=
ps["..k.."] override") gMaps[k] =3D v end
-	end
-	if (gCommandLineSwitches["-so"]) then =

-		gOfflineModeMapIndex =3D tonumber(gCommandLineArguments[gCommandLineSwit=
ches["-so"]+2]) or gOfflineModeMapIndex
-	end
-	if (gOfflineModeMapIndex) then MapChangeRequest(gOfflineModeMapIndex) end
-	=

-	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-
-	gStartGameWithoutNetwork =3D true
-	MultiTexTerrain_NotifyMapChange()
-	=

-	--~ local x,y,z =3D -183,203,0
-	local x,y,z =3D -1483,1527,2 -- osi-britannia
-	=

-	--if (gGroundBlockLoader) then x,y,z =3D -gGroundBlockLoader:GetMapW()*8/=
2,gGroundBlockLoader:GetMapH()*8/2,0 end
-	if (gOfflineModeCamStart) then x,y,z =3D unpack(gOfflineModeCamStart) end
-	=

-	if (postxt) then
-		local t1,t2,t3 =3D unpack(strsplit(",",postxt))
-		x,y,z =3D tonumber(t1) and -tonumber(t1) or x, tonumber(t2) or y, tonumb=
er(t3) or z
-		print("StartOfflineMode ",x,y,z,t1,t2,t3)
-	end
-		=

-	gCurrentRenderer:InitLocalCam(x,y,z)
-
-	-- Binds key and Inits all InGame-Data
-	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
-
-	-- set z position to terrainheight at starting location
-	local tt,zz =3D GetGroundAtAbsPos(-x,y)
-	if zz then
-		--~ print("#",x,y,tt,z,zz) =

-		z =3D zz
-	end
-
-	gCurrentRenderer:SetOfflineStartPos(x,y,z)
-
-	-- offline : tilefree walk teleport
-	BindDown("f6",function () gCurrentRenderer:OfflineTeleportToMouse() end)
-	=

-	-- Unbind some keys only for offline mode (rest is the same as InGame)
-	UnBindArr({"u","q","e","tab","r","t","k","j","b","p","g","h","y"})
-end
-
-local function MainMenuShowLoginDialog (shard,shardname)
-	-- TODO : unfinished, pol server options...
-	=

-	LoadShardfilter(shard.gCustomArtFilterFilePath)
-
-	if (shard.gStartGameWithoutNetwork =3D=3D true) then
-		for k,v in pairs(shard) do _G[k] =3D v end
-		StartOfflineMode()
-	elseif(shard.gStartInDebugMode =3D=3D true) then
-		StartDebugMenu()
-	else
-		local MyLogin =3D function (widget) =

-			local shard =3D widget.shard
-			shard.gLoginServerIP 	=3D 			widget.dialog.controls["loginserverinput"]=
.plaintext
-			shard.gLoginServerPort 	=3D tonumber(	widget.dialog.controls["loginport=
input"].plaintext)
-			local nameinput =3D widget.dialog.controls["nameinput"].plaintext
-			local passinput =3D widget.dialog.controls["passinput"].plaintext
-			-- TOOD : password style field
-			--print("MainMenuConnectToShard",shard,widget.shardname,nameinput,passi=
nput)
-			MainMenuConnectToShard(shard,widget.shardname,nameinput,passinput)
-			widget.dialog:Destroy()
-		end
-		local MyGoBack =3D function(widget)
-			StartMainMenu()
-			widget.dialog:Destroy()
-		end
-		local rows =3D {
-			{	{type=3D"Label",		text=3D"Login"} },
-				=

-			{	{type=3D"Label",		text=3D"LoginServer:"},
-				{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gLoginServerIP or "")=
,controlname=3D"loginserverinput"},
-				{type=3D"EditText",	w=3D100,h=3D16,text=3D(shard.gLoginServerPort or "=
"),controlname=3D"loginportinput"}  },
-				=

-			{	{type=3D"Label",		text=3D"Name:"},
-				{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gLoginname or ""),con=
trolname=3D"nameinput"}  },
-				=

-			{	{type=3D"Label",		text=3D"Pass:"},
-				{type=3D"EditText",	w=3D300,h=3D16,text=3D(shard.gPassword or ""),cont=
rolname=3D"passinput",bPassWordStyle=3Dtrue}  },
-				=

-			{	{type=3D"Label",		text=3D"Tipp:"},
-				{type=3D"Label",		text=3D	"On many shards you can you can just login w=
ith a username/password you wish\n"..
-											"to create a new account if you don't have one already"}, },
-				=

-			{	{type=3D"Button",onLeftClick=3DMyLogin,shard=3Dshard,shardname=3Dshar=
dname,text=3D"Login ..."}, },
-			{	{type=3D"Button",onLeftClick=3DMyGoBack,text=3D"<- back"}, },
-		}
-		=

-		gLoginDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefaultS=
tyleSet,"window")
-	end
-end
-
-local function StopMainMenu ()
-	if (gMainMenuDialog) then
-		gMainMenuDialog:Destroy()
-		gMainMenuDialog=3Dnil
-	end
-end
-
-local function SetMainMenuCam (roth,rotv)
-	local cam =3D GetMainCam()
-	cam:SetFOVy(gfDeg2Rad*45)
-	cam:SetNearClipDistance(0.5) -- old : 1
-	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
-	cam:SetProjectionType(kCamera_PT_PERSPECTIVE) -- perspective
-	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
-	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

-	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
-	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
-	=

-	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
-	GetMainCam():SetRot(w,x,y,z)	=

-end
-
--- ----------------------------------------------- End of local functions =
-----------------------------
-
---gameserverlist selection
-function MainMenuShowServerList (serverlist)
-	local MySelectServer =3D function(server) =

-		GuiAddChatLine(sprintf("connecting to server %s[%d]",server.name or "???=
",server.index or 0))
-		=

---		Send_SystemSpecs()
-		=

-		Send_GameServer_Select(server.index or 0) -- 0xA0 kPacket_Server_Select =

-		-- answered by kPacket_Server_Redirect 0x8C, =

-		-- which calls Send_GameServer_PostLogin kPacket_Post_Login 0x91 =

-		-- answered by kPacket_Features 0xB9 and  kPacket_Character_List 0xA9 wh=
ich calls MainMenuShowCharList
-	end
-	=

-	-- if there is only one entry or if autologin, select it automatically
-	if (countarr(serverlist.servers) =3D=3D 1 or gCommandLineSwitches["-co"])=
 then
-		local k,v =3D next(serverlist.servers) -- get first entry
-		gSelectedShardName =3D v.name
-		MySelectServer(v)
-		return
-	end
-	=

-	local MySelectServerWidgetFunc =3D function(widget) =

-		MySelectServer(widget.server)
-		widget.dialog:Destroy()
-	end
-	=

-	local rows =3D {
-		{	{type=3D"Label",	text=3D"Server List"}  }
-	}
-	-- known servers
-	for k,v in pairs(serverlist.servers) do
-		local label =3D sprintf("Choose server [%d]%s full=3D%d tz=3D%d ip=3D%s"=
,v.index,v.name,v.full,v.tz,NtoA(v.ip))
-		table.insert(rows,{
-			{type=3D"Button",onLeftClick=3Dfunction(widget) MySelectServerWidgetFun=
c(widget) gSelectedShardName =3D v.name end,server=3Dv,text=3Dlabel}
-		})
-		-- TODO : server.ip unused ? might not be needed when server sends redir=
ect packet
-	end
-
-	local MyGoBack =3D function(widget)
-		NetDisconnect()
-		gHuffmanDecode =3D false
-		=

-		Client_USleep( 500 )
-		StartMainMenu()
-		widget.dialog:Destroy()
-	end
-	-- back button
-	table.insert(rows,{
-		{type=3D"Button",onLeftClick=3DMyGoBack,text=3D"<- back"}
-	})
-
-	gServerListDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefa=
ultStyleSet,"window")
-end
-
-function MainMenuShowCharList (charlist)
-	--characterlist selection or new char creation
-	--check first, if the choose slot is available!
-	=

-	=

-	local MySelectChar =3D function(iCharNum,myrenderer) =

-		gCurrentRenderer =3D myrenderer or gCurrentRenderer
-		PreLoadAfterManualRenderSwitch()
-		Send_Character_Select(iCharNum,gGameServerAccount)
-	end
-	local MyCreateCharTemplatePicker =3D function(widget) =

-		MainMenuShowCharCreationDialog(widget.chartemplate,gNextFreeCharSlot)
-		widget.dialog:Destroy()
-	end
-	=

-	local templates =3D GetCharCreationTemplates() -- see lib.charcreate.lua =
: uo/Prof.txt =

-	local rows =3D {
-		{	{type=3D"Label",	text=3D"Character List"}  }
-	}
-	-- existing characters
-	gNextFreeCharSlot =3D 0
-	local autologin_charname
-	if (gCommandLineSwitches["-co"]) then autologin_charname =3D gCommandLine=
Arguments[gCommandLineSwitches["-co"]+2] end -- autologin
-	for k,v in pairs(charlist.chars) do if (v.name ~=3D "") then
-		if (v.name =3D=3D autologin_charname or tonumber(autologin_charname) =3D=
=3D k + 1) then =

-			local iCharNum =3D k
-			Send_Character_Select(iCharNum,gGameServerAccount)
-			gSelectedCharName =3D v.name
-			return
-		end
-		gNextFreeCharSlot =3D gNextFreeCharSlot + 1
-		table.insert(rows,{
-			{type=3D"Button",onLeftClick=3Dfunction(widget) MySelectChar(widget.iCh=
arNum) widget.dialog:Destroy() gSelectedCharName =3D v.name end ,iCharNum=
=3Dk,text=3D"Login as "..v.name},
-			{type=3D"Button",onLeftClick=3Dfunction(widget) MySelectChar(widget.iCh=
arNum,Renderer3D) widget.dialog:Destroy() gSelectedCharName =3D v.name end =
,iCharNum=3Dk,text=3D"3D"},
-			{type=3D"Button",onLeftClick=3Dfunction(widget) MySelectChar(widget.iCh=
arNum,Renderer2D) widget.dialog:Destroy() gSelectedCharName =3D v.name end =
,iCharNum=3Dk,text=3D"2D"},
-		})
-	end end
-	-- char creation (TODO)
-	for k,v in pairs(templates) do
-		if (v.Name =3D=3D "Samurai" or v.Name =3D=3D "Ninja" or v.Name =3D=3D "P=
aladin" or
-			v.Name =3D=3D "Necromancer" or v.Name =3D=3D "Warrior" or v.Name =3D=3D=
 "Mage" or
-			v.Name =3D=3D "Blacksmith") then
-			table.insert(rows,{
-				{type=3D"Button",onLeftClick=3DMyCreateCharTemplatePicker,chartemplate=
=3Dv,text=3D"Create "..v.Name}
-			})
-		end
-	end
-	-- TODO : custom char creation
-	=

-	local MyGoBack =3D function(widget)
-		NetDisconnect()
-		gHuffmanDecode =3D false
-		=

-		Client_USleep( 500 )
-		StartMainMenu()
-		widget.dialog:Destroy()
-	end
-	-- back button
-	table.insert(rows,{
-		{type=3D"Button",onLeftClick=3DMyGoBack,text=3D"<- back"}
-	})
-	=

-	gCharListDialog =3D guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefaul=
tStyleSet,"window")
-end
-
-function MainMenuFinishedPreLoading ()
-	SetUOCursor(0)
-	if (gLoadingBackground) then StopLoadingBackground () end
-end
-
-function StepMainMenu ()
-	if (gMainMenuDialog) then =

-		-- currently unused
-	end
-end
-
-function StartMainMenu ()
-	if (not gNoRender) then =

-		local vp =3D GetMainViewport()
-		local w =3D vp:GetActualWidth()
-		local h =3D vp:GetActualHeight()
-		local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPlain=
TextureGUIMat("menu_bg.jpg"), 1024, 768)
-		if (gMenuBgImage) then gMenuBgImage:Destroy() end
-		gMenuBgImage =3D GetDesktopWidget():CreateChild("Image",{gfxparam_init=
=3Dgfxparam_init})
-		gMenuBgImage:SetPos(0,0)
-		gMenuBgImage:SetSize(w,h)
-		RegisterListener("Hook_StartInGame"	,function () =

-			DestroyIfAlive(gMenuBgImage)
-			gMenuBgImage =3D nil
-		end)
-		if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-	end
-
-	if (gTestNoMainMenu) then return end
-	if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end -- =
journaltest
-	if (gCommandLineSwitches["-jt"]) then ToggleJournal() return end -- journ=
altest
-	if (gCommandLineSwitches["-mt"]) then ToggleMacroList() return end -- mac=
rolist-test
-	if (gCommandLineSwitches["-so"]) then StartOfflineMode(gCommandLineArgume=
nts[gCommandLineSwitches["-so"]+1]) return end -- start in offline mode
-	if (gCommandLineSwitches["-sd"]) then StartDebugMenu() return end -- star=
t in debug mode
-	if (gCommandLineSwitches["-co"]) then =

-		local name =3D gCommandLineArguments[gCommandLineSwitches["-co"]+1]
-		if name and gShardList[name] and =

-			gShardList[name].gLoginname and gShardList[name].gPassword then
-				local shard =3D gShardList[name]
-				gSelectedShardName =3D name
-				MainMenuConnectToShard(shard,name,shard.gLoginname,shard.gPassword)
-				return
-		end
-	end -- connect to shard
-
-	-- start menu sound
-	SoundPlayMusicById(8)
-	SetMainMenuCam(0,gfDeg2Rad)
-	gCurrentRenderer:SetMapEnvironment()
-
-	local rows =3D {
-		{ {type=3D"Label",	text=3D"Login:"} }
-	}
-
-	local fun =3D function (widget)
-		MainMenuShowLoginDialog(widget.shard,widget.shardname)
-		StopMainMenu()
-	end
-
---	local command =3D "/masterserver.php?query"
---	local res, reponse =3D HTTPGetEx("localhost",80,command)
---	print(res)
---	print(reponse)
-
-	for shardname,shard in pairs(gShardList) do
-		table.insert(rows,{ {type=3D"Button",	onLeftClick=3Dfun,shard=3Dshard,sh=
ardname=3Dshardname,text=3DGetShardButtonText(shard,shardname)} })
-	end
-
-	=

-	local shardname,shard =3D "# - Offline Mode",{gStartGameWithoutNetwork =
=3D true}
-		table.insert(rows,{ {type=3D"Button",	onLeftClick=3Dfun,shard=3Dshard,sh=
ardname=3Dshardname,text=3DGetShardButtonText(shard,shardname)} })
-	local shardname,shard =3D "# - Debug Mode",{gStartInDebugMode =3D true}
-		table.insert(rows,{ {type=3D"Button",	onLeftClick=3Dfun,shard=3Dshard,sh=
ardname=3Dshardname,text=3DGetShardButtonText(shard,shardname)} })
-
-	=

-	=

-	table.insert(rows,{ {type=3D"Button",text=3D"# - Graphic Options",onLeftC=
lick=3Dfunction ()
-		StopMainMenu()
-		if (Client_ShowOgreConfig()) then
-			DisplayNotice("please restart iris2 for the changes to take effekt")
-			StopMainMenu()
-			Exit() -- Terminate()  -- terminate softly is not enough, no frame can =
be drawn since ogre::root has to be killed for fullscreen switch
-			-- todo : reinit ogre here ? might loose already loaded textures =3D(
-		end	=

-		end } })
-	table.insert(rows,{ {type=3D"Button",text=3D"# - Exit",onLeftClick=3Dfunc=
tion ()
-			StopMainMenu()
-			Terminate()
-		end } })
-
-
-	if (not gNoRender) then =

-	if (not(gMainMenuDialog)) then
-		gMainMenuDialog =3D guimaker.MakeTableDlg(rows,10,10,false,true,gGuiDefa=
ultStyleSet,"window") =

-	end
-	end
-end

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Tue Feb 10 16:33:59 2009
@@ -10,24 +10,6 @@
 function ShardListFileNamePartEncode	(x) return string.gsub(x,"[^0-9a-zA-Z=
_%-%(%) ]",".") end
 =

 -- notes
-
---[[
-shard=3D{
-	host,port,
-	accountlist=3D{
-		username,charlist=3D{
-			charname,skills,body(male,female,skintone),equip(hair,armor,weap,mount)
-		}
-	}
-
-shardclick : =

-	acclist + charlist soweit bekannt. =

-		charlist nach shardlogin updaten
-
-]]--
-
-
-
 =

 function InitShardList () =

 	LoadStoredPasswords()
@@ -51,6 +33,10 @@
 RegisterListener("Hook_Packet_Character_List",function (charlist) =

 	local plaincharlist =3D {serverid=3DgiGameServerID}
 	for k,v in pairs(charlist.chars) do plaincharlist[k] =3D v.name end
+	plaincharlist.gLoginServerIP =3D gLoginServerIP
+	plaincharlist.gLoginServerPort =3D gLoginServerPort
+	plaincharlist.gLoginname =3D gLoginname
+	plaincharlist.giGameServerID =3D giGameServerID
 	ShardMemorySet("charlist",table.concat({gLoginServerIP,gLoginServerPort,S=
hardListFileNamePartEncode(gLoginname),giGameServerID},":"),plaincharlist)
 end)
 =

@@ -120,6 +106,7 @@
 function LoadShardMemory	() gShardMemory =3D	SimpleXMLLoad(GetShardMemoryF=
ilePath()) or {} end
 function SaveShardMemory	()					SimpleXMLSave(GetShardMemoryFilePath(),gSh=
ardMemory) end
 =

+function ShardMemoryGetList	(listname) return gShardMemory[listname] end
 function ShardMemoryGet		(listname,key) =

 	local list =3D gShardMemory[listname]
 	return list and list[key]

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Feb 10 16:33:59 2009
@@ -105,6 +105,7 @@
 dofile(libpath .. "lib.razorpacketvideo.lua")
 dofile(libpath .. "lib.configdialog.lua")
 dofile(libpath .. "lib.shardlist.lua")
+dofile(libpath .. "lib.registry.slow.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")
@@ -115,9 +116,10 @@
 =

 dofile(libpath .. "lib.uoam.lua")
 =

+gRegistrySlow:Load() -- loading this early might be good, so it's availabl=
e everywhere
+
 dofile(libpath .. "config_declarations.lua")
 InitShardList() -- was previously in configdecl, should be done before con=
fig.lua is loaded, so overrides can be done there
-
 =

 if (LugreActivateGlobalVarChecking) then LugreActivateGlobalVarChecking() =
end
 =

@@ -335,7 +337,9 @@
 	print(descr)
 	print("#################")
 	if (StringContains(descr,"Could not load dynamic library") and StringCont=
ains(descr,"Direct3D9")) then =

-		local url =3D "http://download.microsoft.com/download/5/c/8/5c8b7216-bbc=
2-4215-8aa5-9dfef9cdb3df/directx_aug2008_redist.exe"
+		local url =3D "http://www.microsoft.com/downloads/details.aspx?FamilyID=
=3D886acb56-c91a-4a8e-8bb8-9f20f1244a8e&DisplayLang=3Den" -- nov2008
+		-- old : "http://download.microsoft.com/download/5/c/8/5c8b7216-bbc2-421=
5-8aa5-9dfef9cdb3df/directx_aug2008_redist.exe" -- aug2008
+		-- generic : http://www.microsoft.com/downloads/details.aspx?familyid=3D=
2DA43D38-DB71-4C1B-BC6A-9B6652CD92A3&displaylang=3Dde (todo:displaylang=3De=
n?) (link to newest, but requires windows validation procedure)
 		local tipp =3D	"Your DirectX9 version is too old to run Iris.\n"..
 						"Would you like to open a browser and download an Updated Version fr=
om the following url ?\n"..url
 		print(tipp)
@@ -421,8 +425,6 @@
 	=

 	InvokeExporters()
 =

-	MainMenuFinishedPreLoading()
-	=

 	-- set fadelines font
 	gFadeLinesFont =3D gFontDefs["Chat"].name
 	gFadeLineTextH =3D gFontDefs["Chat"].size
@@ -583,10 +585,9 @@
 	gProfiler_MainStep:Section("StepDebugMenu")
 	StepDebugMenu()
 	=

-	if (IsNetConnected() and gPingActive) then -- ping needed during characte=
r selection and char create also
-		gProfiler_MainStep:Section("PingStep")
-		PingStep()
-	end
+	-- ping needed during character selection and char create also
+	gProfiler_MainStep:Section("PingStep")
+	PingStep()
 =

 	if (gInGameStarted) then
 		gProfiler_MainStep:Section("StepUODragDrop")

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Tue Feb 10 16:33:59 2009
@@ -107,8 +107,6 @@
 		NetDisconnect()
 		--connect to gameserver
 		printdebug("login","NET: connect to gameserver")
-		gPingActive =3D true
-		gNextPingTime =3D 0
 		local res =3D NetConnectWithKey(gameserverip,gameserverport,gameserverac=
count)
 		if (not res) then
 			FatalErrorMessage("kPacket_Server_Redirect : login server redirect fail=
ed")
@@ -184,6 +182,7 @@
 	for i =3D 0,charlist.citynumber-1 do
 		iBytesLeft =3D iBytesLeft - iBytesPerCity
 		gCities[i] =3D {}
+		gCities[i].i=3Di
 		gCities[i].index=3Dinput:PopNetUint8()
 		gCities[i].name=3Dinput:PopFilledString(30)
 		gCities[i].terminator1=3Dinput:PopNetUint8()
@@ -330,7 +329,8 @@
 	for k,v in pairs(kAccountLoginRejectReason) do if (value =3D=3D v.code) t=
hen txt =3D k.." "..v.text end end
 	local msg =3D sprintf("Account_Login_Failed %d %s",value,txt)
 	print(msg)
-	FatalErrorMessage(msg) =

+	MainMenuLoginRejected(msg) =

+	--~ FatalErrorMessage(msg) =

 end
 =

 -- Server requests Clientversion (NEW?)
@@ -406,12 +406,20 @@
 			chardata.skill3 ~=3D skillid,"Spellweaving skill not allowed at charcre=
ate")
 			=

 	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_CharacterCreation)
+	out:PushNetUint8(kPacket_CharacterCreation) -- 0x00
 	out:PushNetUint32(hex2num("0xedededed"))
 	out:PushNetUint32(hex2num("0xffffffff"))
 	out:PushNetUint8(hex2num("0x00"))
 	out:PushFilledString(chardata.name,30)
-	out:PushFilledString(chardata.pass,30)
+	=

+	-- old : password
+	out:PushNetUint16(0)						-- 2
+	out:PushNetUint32(chardata.flags or 0)		-- 4
+	out:PushNetUint32(0)						-- 4
+	out:PushNetUint32(0)						-- 4
+	out:PushNetUint8(chardata.prof or 0)		-- 1
+	out:PushFilledString("",15)
+			=

 	out:PushNetUint8(chardata.sex) -- (0=3Dmale, 1=3Dfemale, 2=3Delf male, 3=
=3Delf female)
 	out:PushNetUint8(chardata.str)
 	out:PushNetUint8(chardata.dex)
@@ -430,7 +438,7 @@
 	out:PushNetUint16(chardata.location) --  The character's starting city (a=
s listed in the character list).
 	out:PushNetUint16(hex2num("0x0000"))
 	out:PushNetUint16(chardata.slot) -- is this really 16 bit ?  The characte=
r slot number.
-	out:PushNetUint32(gServerSeed) -- The user's gameplay encryption key ? cl=
ientIP ?
+	out:PushNetUint32(gServerSeed) -- The user's gameplay encryption key ? cl=
ientIP ?    (runuo2.0 : clientIP)
 	out:PushNetUint16(chardata.shirtColor)
 	out:PushNetUint16(chardata.pantsColor)
 	out:SendPacket()
@@ -445,7 +453,7 @@
 0030   30 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   0...............
 0040   00 00 00 00 02 0A 00 02  0F                        .........
 ]]--
-function Send_Character_Select(iCharacterID,iAccount)
+function Send_Character_Select(iCharacterID,iAccount) -- 0x5D
 	LoginDebug2("s:0x5D Send_Character_Select")
 	printdebug("login",sprintf("NET: Character_Select: %i Name: %s Password: =
%s AccountNr.:%x\n",
 			iCharacterID,gCharacterList[iCharacterID].name,gCharacterList[iCharacte=
rID].pw,iAccount))

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Tue Feb 10 16:33:59 2009
@@ -10,7 +10,7 @@
 gPingInterval =3D 61000 --61000 exact pingpong time from client->server->c=
lient (61sec) in msec, 1000=3D1second
 =

 function PingStep ()
-	if (gMyTicks >=3D gNextPingTime) then
+	if (gMyTicks >=3D gNextPingTime and IsNetConnected() and gPingActive) then
 		gNextPingTime =3D gMyTicks + gPingInterval
 		if (not gStartGameWithoutNetwork) then Send_Ping() end
 	end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Tue Feb 10 16:33:59 2009
@@ -269,8 +269,11 @@
 =

 RegisterListener("Hook_Spell_Interrupt",function () SpellBarInterrupt() en=
d)
 =

+gSpellBarLoadRevision =3D (gSpellBarLoadRevision or 0) + 1
+ local myrev =3D gSpellBarLoadRevision
 --~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_Te=
xt_Unicode
 RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum,texttype,data)
+	if (myrev ~=3D gSpellBarLoadRevision) then return true end
 	--~ if (texttype =3D=3D kTextType_Label) then return end
 	if (data.bIsAutoGenerated) then return end
 	local short =3D gSpellbarShortMessages[text_messagenum]



From no-reply at zwischenwelt.org  Tue Feb 10 19:05:46 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Feb 2009 18:05:46 -0000
Subject: [Iris-commit] [IRIS] r2911 - in /trunk/lua: lib.desktop.lua
 lib.mainmenu.lua lib.shardlist.lua net/net.login.lua
Message-ID: <20090210180548.10A0F1C1866A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Feb 10 19:05:45 2009
New Revision: 2911

Log:
mainmenu : sub-server-name fixed, used for storing item positions

Modified:
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.shardlist.lua
    trunk/lua/net/net.login.lua

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Feb 10 19:05:45 2009
@@ -288,7 +288,7 @@
 end)
 =

 RegisterListener("Hook_StartInGame",function() =

-	gSelectedShardName =3D gSelectedShardName or "unknown"
+	gSelectedShardName =3D gSelectedShardName or (gLoginServerIP.."."..gLogin=
ServerPort) -- "unknown"
 	gSelectedCharName =3D gSelectedCharName or "unknown"
 	local filename =3D gSelectedShardName.."-"..gSelectedCharName..".lua"
 	LoadDesktop(filename) =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Tue Feb 10 19:05:45 2009
@@ -36,6 +36,7 @@
 -- ***** ***** ***** ***** ***** commandline
 =

 function MainMenuCommandLine ()
+	for shardname,shard in pairs(gShardList) do shard.gShardName =3D shardnam=
e end
 	if (gTestNoMainMenu) then return end
 	if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end -- =
journaltest
 	if (gCommandLineSwitches["-jt"]) then ToggleJournal() return true end -- =
journaltest
@@ -56,13 +57,13 @@
 																	charlist.gLoginServerPort	=3D=3D shard.gLoginServerPort e=
nd)
 				for k,charlist in pairs(charlists) do =

 					for i=3D0,20 do =

-						print("..",charlist[i])
+						--~ print("..",charlist[i])
 						if (not charlist[i]) then break end
 						if (string.lower(charlist[i]) =3D=3D string.lower(gAutoLoginCharName=
)) then
 							gAutoLoginCharName =3D charlist[i]
 							gLoginname =3D charlist.gLoginname
 							gPassword =3D MainMenu_GetStoredPassword(shard.gLoginServerIP,shard=
.gLoginServerPort,gLoginname)
-							print("found",gAutoLoginCharName,gLoginname,gPassword)
+							print("found",gAutoLoginCharName,gLoginname)
 						end
 					end
 				end
@@ -79,7 +80,6 @@
 function MainMenu_SelectShard (shard)
 	print("MainMenu_SelectShard",shard,shard.gShardName)
 	MainMenuStopAllMenus()
-	gSelectedShardName =3D shard.gShardName
 	=

 	LoadShardfilter(shard.gCustomArtFilterFilePath) -- todo : revert on error=
 or back-button ?
 	=

@@ -101,9 +101,8 @@
 	print("##################################")
 	print("MainMenu_SendLogin",user)
 	MainMenuStopAllMenus()
-	--~ (gSelectedShardName or "???") fails here...
-	GuiAddChatLine("connecting to shard "..gLoginServerIP..":"..gLoginServerP=
ort.." with user "..user)
-	=

+	GuiAddChatLine("connecting to shard Login-Server on "..gLoginServerIP..":=
"..gLoginServerPort.." with user "..user)
+
 	-- init net
 	gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServerS=
eed)
 	if (not gNet_State) then =

@@ -178,6 +177,10 @@
 function MainMenu_SendServer (iServerID)
 	print("##################################")
 	print("MainMenu_SendServer",iServerID)
+	gSelectedShardName =3D gSubServerNamesByID[iServerID]
+	print("############# + + ++ +++ + +++ + +MainMenu_SendServer",iServerID,g=
SelectedShardName)
+	GuiAddChatLine("connecting to shard Game-Server "..(gSelectedShardName or=
 "???").." on "..gLoginServerIP..":"..gLoginServerPort.." with user "..gLog=
inname)
+	=

 	MainMenuStopAllMenus()
 	Send_GameServer_Select(iServerID or 0) -- 0xA0 kPacket_Server_Select =

 	-- answered by kPacket_Server_Redirect 0x8C, =


Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Tue Feb 10 19:05:45 2009
@@ -61,6 +61,7 @@
 	if (not gPlayerSkills) then return end
 	local charname =3D gCharName
 	=

+	--[[
 	-- calc and check has, no need to save if nothing changed
 	local hash =3D {mobile.artid,mobile.hue}
 	for k,layer in pairs(gLayerType) do =

@@ -71,10 +72,11 @@
 	hash =3D table.concat(hash,"#")
 	if (hash =3D=3D gShardListSavePlayerMobile_LastHash) then return end
 	gShardListSavePlayerMobile_LastHash =3D hash
+	print("saving data...",hash)
+	]]--
 	=

 	-- save the data
-	print("saving data...",hash)
-	local data =3D {	charname=3Dcharname, artid=3Dmobile.artid, hue=3Dmobile.=
hue, xloc=3Dmobile.xloc, yloc=3Dmobile.yloc, map=3DgMapIndex, equip=3D{},sk=
ills=3D{} }
+	local data =3D {	charname=3Dcharname, artid=3Dmobile.artid, hue=3Dmobile.=
hue, xloc=3Dmobile.xloc, yloc=3Dmobile.yloc, zloc=3Dmobile.zloc, map=3DgMap=
Index, equip=3D{},skills=3D{} }
 	for k,layer in pairs(gLayerType) do =

 		local item =3D mobile:GetEquipmentAtLayer(layer) =

 		if (item) then data.equip[layer] =3D {artid=3Ditem.artid,hue=3Ditem.hue}=
 end
@@ -82,6 +84,8 @@
 	for skillid,skill in pairs(gPlayerSkills) do =

 		data.skills[skillid] =3D {value=3Dskill.value,base_value=3Dskill.base_va=
lue,lockstate=3Dskill.lockstate,name=3DglSkillNames[skillid]} =

 	end
+	data.time =3D os.time()
+	data.timetext =3D os.date("%d %b %Y %H:%M",data.time) -- 10 Feb 2009 16:1=
4       %H:%M:%S
 	SimpleXMLSave(GetCharFilePath(),data)
 end
 =


Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Tue Feb 10 19:05:45 2009
@@ -27,6 +27,7 @@
 	printdebug("login",sprintf("-> Emulator=3D: %s\n",gServerType[gServerEmul=
ator] or "Unknown Server"))
 =

 	serverlist.servers =3D {}
+	gSubServerNamesByID =3D {}
 	for i =3D 0,serverlist.iServerNumber - 1 do
 		local server =3D {}
 		server.index =3D input:PopNetUint16()
@@ -35,6 +36,8 @@
 		server.tz =3D input:PopNetUint8() -- timezone
 		server.ip =3D input:PopNetUint32()
 		serverlist.servers[i] =3D server
+		gSubServerNamesByID[server.index] =3D server.name
+		print("############# + + ++ +++ + +++ + +gSubServerNamesByID",server.ind=
ex,server.name)
 =

 		printdebug("login",sprintf("NET: [%i] '%s' full=3D%i tz=3D%i ip=3D%x\n",=
server.index,server.name,server.full,server.tz,server.ip))
 	end



From no-reply at zwischenwelt.org  Tue Feb 10 21:06:31 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Feb 2009 20:06:31 -0000
Subject: [Iris-commit] [IRIS] r2912 - in /trunk: lua/lib.macrolist.lua
 lua/net/net.object.lua lua/net/net.uodragdrop.lua plugins/loot.lua
Message-ID: <20090210200631.689741C18861@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Feb 10 21:06:30 2009
New Revision: 2912

Log:
new macrocommand : MacroCmd_HideAllCorpses, fixed goldlooter

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.object.lua
    trunk/lua/net/net.uodragdrop.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Tue Feb 10 21:06:30 2009
@@ -519,6 +519,13 @@
 	return res
 end
 =

+
+function MacroCmd_HideAllCorpses	()
+	for k,item in pairs(GetDynamicList()) do =

+		if (item.artid_base =3D=3D kCorpseDynamicArtID and (not Renderer2D:Mobil=
eHasVisibleEquip(item.amount))) then item:Destroy() end
+	end
+end			=

+		=

 function MacroCmd_AutoClickItems	()
 	for k,item in pairs(GetDynamicList()) do =

 		if (DynamicIsInWorld(item) and (not gItemAutoClickSent[item.serial])) th=
en

Modified: trunk/lua/net/net.object.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.object.lua (original)
+++ trunk/lua/net/net.object.lua Tue Feb 10 21:06:30 2009
@@ -45,5 +45,6 @@
 	printdebug("net",sprintf("NET: Destroy item with serial: 0x%08x\n",serial=
))
 =

 	DestroyObjectBySerial(serial)
+	NotifyListener("Hook_Packet_Destroy",serial)
 end
 =


Modified: trunk/lua/net/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.uodragdrop.lua (original)
+++ trunk/lua/net/net.uodragdrop.lua Tue Feb 10 21:06:30 2009
@@ -11,6 +11,7 @@
 =

 -- This is sent by the client when the player picks up an item. 0x07
 function Send_Take_Object(serial,amount)
+	--~ print("+++++++Send_Take_Object",serial,amount)
 	printdebug("net","NET: Send_Take_Object:",sprintf("0x%08x",serial),serial=
,amount)
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Take_Object)
@@ -25,6 +26,7 @@
 -- This is sent by the client when the player drops an item. 0x08
 -- containerid =3D 0xFFFFFFFF  when the container is the ground
 function Send_Drop_Object(serial,x,y,z,containerid)
+	--~ print("+++++++Send_Drop_Object",serial,x,y,z,containerid)
 	--~ print("Send_Drop_Object",_TRACEBACK())
 	printdebug("net","NET: Send_Drop_Object:",sprintf("0x%08x",serial),x,y,z,=
containerid)
 	local out =3D GetSendFIFO()
@@ -55,6 +57,8 @@
 	if (reason =3D=3D hex2num("0x06")) then -- No message.
 		reasontxt =3D false
 	end
+	MacroCmd_RiseText(1,0,0,"Get_Item_Failed:"..reasontxt)
+	print("NET : Get_Item_Failed",reasontxt)
 	printdebug("net","NET : Get_Item_Failed",reasontxt)
 	CancelUODragDrop() -- server side cancel
 end
@@ -66,6 +70,8 @@
 	local xloc =3D input:PopNetUint16()
 	local yloc =3D input:PopNetUint16()
 	-- TODO ?
+	print("NET : Drop_Item_Failed --> nothing todo?")
+	MacroCmd_RiseText(1,0,0,"Drop_Item_Failed")
 	printdebug("net","NET : Drop_Item_Failed --> nothing todo?")
 end
 =

@@ -73,6 +79,7 @@
 function gPacketHandler.kPacket_Drop_Item_OK() -- 0x29
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
+	print("NET : Drop_Item_OK --> nothing todo?")
 	printdebug("net","NET : Drop_Item_OK --> nothing todo?")
 end
  =


Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Tue Feb 10 21:06:30 2009
@@ -95,6 +95,23 @@
 		gLootNextCorpseContainerTimeout =3D Client_GetTicks() + 500
 	end
 end)
+
+gMyLootPlugin_LootItems =3D {}
+RegisterIntervalStepper(600,function ()
+	for serial,item in pairs(gMyLootPlugin_LootItems) do
+		if (GetUODistToPlayer(	item.mylootplugin_worldxloc or 0,
+								item.mylootplugin_worldyloc or 0) <=3D 2) then
+			job.create(function ()
+				Send_Take_Object(item.serial,item.amount)
+				job.wait(math.random(100,300))
+				Send_Drop_Object_AutoStack(item.serial,GetPlayerBackPackSerial())
+			end)
+			return =

+		end
+	end
+end) =

+RegisterListener("Hook_Packet_Destroy",function (serial) gMyLootPlugin_Loo=
tItems[serial] =3D nil end)
+
 RegisterListener("Hook_Container_Contents",function (serial) =

 	if (not serial) then return end -- empty corpse
 	if (not gLootNextCorpseContainer) then return end
@@ -122,16 +139,18 @@
 				LootCancel() -- don't hide this corpse
 				return
 			else
+				gMyLootPlugin_LootItems[item.serial] =3D item
+				item.mylootplugin_worldxloc =3D container.xloc
+				item.mylootplugin_worldyloc =3D container.yloc
 				SpellBarRiseTextOnMob(GetPlayerSerial(),1,0.5,0,
 						sprintf("%d[%d:%d,%s]",item.amount,gLootCorpseArt,gLootCorpseHue,Aos=
ToolTip_GetText(serial) or ""))
-				Send_Take_Object(item.serial,item.amount)
-				Send_Drop_Object_AutoStack(item.serial,GetPlayerBackPackSerial())
 			end
 		else =

 			--~ print("######------#######  takeitem =3D=3D other",item.artid,item.=
amount , kLoot_GoldWeight,curw,maxw )
 			SpellBarRiseTextOnMob(GetPlayerSerial(),1,0.5,0,GetStaticTileTypeName(i=
tem.artid) or "???")
-			Send_Take_Object(item.serial,item.amount)
-			Send_Drop_Object_AutoStack(item.serial,GetPlayerBackPackSerial())
+			gMyLootPlugin_LootItems[item.serial] =3D item
+			item.mylootplugin_worldxloc =3D container.xloc
+			item.mylootplugin_worldyloc =3D container.yloc
 		end
 	end =

 	LootCleanup()



From no-reply at zwischenwelt.org  Thu Feb 12 20:37:25 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 12 Feb 2009 19:37:25 -0000
Subject: [Iris-commit] [IRIS] r2913 - in /trunk: bin/iris2.exe
 vc9/iris_luajit.sln vc9/iris_luajit.vcproj
Message-ID: <20090212193729.D48A41C1866A@zwischenwelt.org>

Author: sience
Date: Thu Feb 12 20:37:24 2009
New Revision: 2913

Log:
-new win32 binary
-luajit project files removed (luajit couses many undefined errors, mem lea=
ks?)

Removed:
    trunk/vc9/iris_luajit.sln
    trunk/vc9/iris_luajit.vcproj
Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Fri Feb 13 17:22:03 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 16:22:03 -0000
Subject: [Iris-commit] [IRIS] r2914 - /trunk/lua/lib.mainmenu.lua
Message-ID: <20090213162206.1003C1C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 17:22:02 2009
New Revision: 2914

Log:
gfx config change crash fix

Modified:
    trunk/lua/lib.mainmenu.lua

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Fri Feb 13 17:22:02 2009
@@ -237,7 +237,6 @@
 	MainMenuStopAllMenus()
 	if (Client_ShowOgreConfig()) then
 		DisplayNotice("please restart iris2 for the changes to take effekt")
-		StopMainMenu()
 		Exit() -- Terminate()  -- terminate softly is not enough, no frame can b=
e drawn since ogre::root has to be killed for fullscreen switch
 		-- todo : reinit ogre here ? might loose already loaded textures =3D(
 	end



From no-reply at zwischenwelt.org  Fri Feb 13 17:23:58 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 16:23:58 -0000
Subject: [Iris-commit] [IRIS] r2915 - /trunk/lua/lib.mainmenu.accountlist.lua
Message-ID: <20090213162358.244E81C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 17:23:57 2009
New Revision: 2915

Log:
mainmenu fix for empty charlist

Modified:
    trunk/lua/lib.mainmenu.accountlist.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Fri Feb 13 17:23:57 2009
@@ -23,7 +23,7 @@
 	=

 	-- saved charlists
 	local lastpassedit
-	local charlists =3D SortedArrayFromAssocTable(ShardMemoryGetList("charlis=
t"),function (a,b) return a.gLoginname < b.gLoginname end)
+	local charlists =3D SortedArrayFromAssocTable(ShardMemoryGetList("charlis=
t") or {},function (a,b) return a.gLoginname < b.gLoginname end)
 	charlists =3D FilterArray(charlists,function (charlist) return	charlist.g=
LoginServerIP		=3D=3D gLoginServerIP and =

 																	charlist.gLoginServerPort	=3D=3D gLoginServerPort end)
 	for charlist_idx,charlist in pairs(charlists) do



From no-reply at zwischenwelt.org  Fri Feb 13 19:31:04 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 18:31:04 -0000
Subject: [Iris-commit] [IRIS] r2916 - /trunk/lua/lib.shardlist.lua
Message-ID: <20090213183104.BA1BD1C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 19:31:03 2009
New Revision: 2916

Log:
shardlist stored password file not found error fix

Modified:
    trunk/lua/lib.shardlist.lua

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Fri Feb 13 19:31:03 2009
@@ -133,7 +133,7 @@
 gStoredPasswords =3D {}
 function GetStoredPasswordsFilePath () return GetConfigDirPath().."passwor=
ds.xml" end
 function SaveStoredPasswords () 					SimpleXMLSave(GetStoredPasswordsFileP=
ath(),gStoredPasswords) end
-function LoadStoredPasswords () gStoredPasswords =3D	SimpleXMLLoad(GetStor=
edPasswordsFilePath()) end
+function LoadStoredPasswords () gStoredPasswords =3D	SimpleXMLLoad(GetStor=
edPasswordsFilePath()) or {} end
 =

 function GetStoredPassword			(host,port,username) return gStoredPasswords[=
host..":"..port..":"..username] end
 function SetStoredPassword			(host,port,username,password) gStoredPassword=
s[host..":"..port..":"..username] =3D password SaveStoredPasswords() end



From no-reply at zwischenwelt.org  Fri Feb 13 19:36:11 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 18:36:11 -0000
Subject: [Iris-commit] [IRIS] r2917 - /trunk/lua/lib.mainmenu.lua
Message-ID: <20090213183611.7A4EF1C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 19:36:11 2009
New Revision: 2917

Log:
bugfix : offline mode mapswitch

Modified:
    trunk/lua/lib.mainmenu.lua

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Fri Feb 13 19:36:11 2009
@@ -260,7 +260,7 @@
 	if (gCommandLineSwitches["-so"]) then =

 		gOfflineModeMapIndex =3D tonumber(gCommandLineArguments[gCommandLineSwit=
ches["-so"]+2]) or gOfflineModeMapIndex
 	end
-	if (gOfflineModeMapIndex) then MapChangeRequest(gOfflineModeMapIndex) end
+	MapChangeRequest(gOfflineModeMapIndex or 1)
 	=

 	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
 =




From no-reply at zwischenwelt.org  Fri Feb 13 19:41:10 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 18:41:10 -0000
Subject: [Iris-commit] [IRIS] r2918 - in /trunk: installdeps.ubuntu.sh
 lua/lib.2d.mousepick.lua lua/lib.macrolist.lua
Message-ID: <20090213184110.4B2791C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 19:41:09 2009
New Revision: 2918

Log:
installdeps.ubuntu.sh:fmod install instructions, mousepick:dynamic amount (=
for corpse types), MacroCmd_Item_FindNearCorpses : option to search for spe=
cific corpsetype (elementals), findbyartid now accepts a list of artids as =
param, getsmarttarget restricted to living humans (trying to heal ghosts =
=3D bad, we need to improve death-detection)

Modified:
    trunk/installdeps.ubuntu.sh
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.macrolist.lua

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Fri Feb 13 19:41:09 2009
@@ -3,6 +3,9 @@
 DEPS=3D"nvidia-cg-toolkit libwxbase2.8-dev libwxgtk2.8-dev wx2.8-headers c=
cache liblua50-dev liblualib50-dev libalut-dev libopenal-dev libvorbisfile3=
 libvorbis-dev libogg-dev libboost-dev libboost-thread-dev libois-dev g++ g=
cc"
 echo apt-get install $DEPS
 sudo apt-get install $DEPS
+echo ------------------------------
+echo iris 2 uses fmod ex 4.* to play music files. alternatively you can us=
e openal, but that no music then.
+echo you can download fmod for linux from http://www.fmod.org/index.php/do=
wnload
 echo ------------------------------
 echo iris 2 uses ogre1.6 now, there is no package for that yet, so you wil=
l need to compile that from source
 echo to do that, download the source from =


Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Fri Feb 13 19:41:09 2009
@@ -143,6 +143,9 @@
 		if (o.hittype =3D=3D kMousePickHitType_PaperdollItem 	) then =

 			hitinfo =3D hitinfo..sprintf("layer=3D0x%02x,",GetPaperdollLayerFromTil=
eType(o.item.artid) or 0) =

 		end
+		if (o.hittype =3D=3D kMousePickHitType_Dynamic 	) then =

+			hitinfo =3D hitinfo..sprintf("amount=3D0x%02x,",data.amount or 0) =

+		end
 		=

 		if (o.hittype =3D=3D kMousePickHitType_Static			) then hitinfo =3D hitin=
fo.."static" end
 		if (o.hittype =3D=3D kMousePickHitType_Terrain 			) then hitinfo =3D hit=
info.."terrain" end

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Fri Feb 13 19:41:09 2009
@@ -77,7 +77,7 @@
 	local foundhp
 	for k,mobile in pairs(list) do =

 		local curhp =3D mobile:GetRelHP() or 1
-		print("MobileList_GetWeakestFromList",curhp)
+		--~ print("MobileList_GetWeakestFromList",curhp)
 		if ((not foundhp) or foundhp > curhp) then foundhp =3D curhp found =3D m=
obile end
 	end
 	return found =

@@ -87,7 +87,7 @@
 	for serial,v in pairs(GetPartyMemberList()) do =

 		local mobile =3D GetMobile(serial)
 		print("MobileList_HealablePartyMembers:",mobile and (not TestBit(mobile.=
flag,kMobileFlag_Poisoned)))
-		if (mobile and (not TestBit(mobile.flag,kMobileFlag_Poisoned)) and =

+		if (mobile and (not TestBit(mobile.flag,kMobileFlag_Poisoned) and (mobil=
e.artid =3D=3D 400 or mobile.artid =3D=3D 401)) and =

 			(not IsOutsideRange(mobile.xloc,mobile.yloc,gPlayerXLoc,gPlayerYLoc,gSp=
ellCastRange))) then table.insert(list,mobile) end
 	end
 	return list =

@@ -413,7 +413,8 @@
 end
 =

 function MacroCmd_Dress (dresslist)
-	for k,serial in pairs(dresslist) do MacroCmd_EquipItem(serial) end
+	for k,serial in pairs(dresslist) do =

+		if (MacroCmd_EquipItem(serial)) then return end end
 end
 =

 function MacroCmd_EquipItem (serial)
@@ -559,10 +560,10 @@
 	return res
 end =

 =

-function MacroCmd_Item_FindNearCorpses	(dist)
+function MacroCmd_Item_FindNearCorpses	(dist,corpsetype)
 	local res =3D {}
 	for k,item in pairs(GetDynamicList()) do =

-		if (DynamicIsInWorld(item) and IsCorpseArtID(item.artid) and
+		if (DynamicIsInWorld(item) and IsCorpseArtID(item.artid) and ((not corps=
etype) or (item.amount =3D=3D corpsetype)) and
 			(dist =3D=3D nil or item:GetUODistToPlayer() <=3D dist) ) then
 			table.insert(res,item)
 		end
@@ -583,8 +584,9 @@
 	container =3D container or GetPlayerBackPackContainer()
 	if (not container) then return end
 	local res =3D {}
+	local artidlist =3D (type(artid) =3D=3D "number") and {artid} or artid
 	for k,item in pairs(container:GetContent()) do =

-		if (item.artid =3D=3D artid and (hue =3D=3D nil or hue =3D=3D item.hue))=
 then
+		if (in_array(item.artid,artidlist) and (hue =3D=3D nil or hue =3D=3D ite=
m.hue)) then
 			table.insert(res,item)
 		end
 	end



From no-reply at zwischenwelt.org  Fri Feb 13 20:15:05 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 19:15:05 -0000
Subject: [Iris-commit] [IRIS] r2919 - /trunk/lua/net/net.login.lua
Message-ID: <20090213191506.022D11C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 20:15:05 2009
New Revision: 2919

Log:
bugfix

Modified:
    trunk/lua/net/net.login.lua

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Fri Feb 13 20:15:05 2009
@@ -354,8 +354,9 @@
 -- send login server request 0x80
 -- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
 function Send_Account_Login_Request	(sName,sPassword,iSeed) -- 0x80
+	gLoginname =3D sName
 	if (sPassword =3D=3D "") then sPassword =3D GetStoredPassword(gLoginServe=
rIP,gLoginServerPort,gLoginname) or sPassword end
-	gLoginname,gPassword =3D sName,sPassword
+	gPassword =3D sPassword
 	LoginDebug2("s:0x80 Send_Account_Login_Request")
 	printdebug("login",sprintf("NET: Account_Login_Request: Name: %s Password=
: %s\n",gPWReplace or sName,gPWReplace or sPassword))
 	local out =3D GetSendFIFO()



From no-reply at zwischenwelt.org  Fri Feb 13 20:20:54 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 19:20:54 -0000
Subject: [Iris-commit] [IRIS] r2920 - in /trunk/lua: lib.2d.renderer.lua
	lib.mainmenu.lua
Message-ID: <20090213192055.20FE51C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 20:20:54 2009
New Revision: 2920

Log:
bugfix : offline mode 2d terrain visible

Modified:
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.mainmenu.lua

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Feb 13 20:20:54 2009
@@ -135,17 +135,22 @@
 	end
 	=

 	-- keyboard move cam
+	=

 	local bKeyBoardMoveCam =3D g2DCamMove or bOfflineMode
 	if (bKeyBoardMoveCam) then
+		if (bOfflineMode) then self.gbBlendOutTerrainVisible =3D true end
 		local dt =3D math.min(Renderer2D.kGoodTicksBetweenFrames/1000,gSecondsSi=
nceLastFrame)
 		local curticks =3D Client_GetTicks()
 		local xloc,yloc =3D self:GetCamPos()
 		local move =3D 16 * dt  * (gKeyPressed[key_lshift] and 8*16 or 1)
 		local dx =3D move * ((gKeyPressed[key_left] and -1 or 0) + (gKeyPressed[=
key_right] and 1 or 0))
 		local dy =3D move * ((gKeyPressed[key_up] and -1 or 0) + (gKeyPressed[ke=
y_down] and 1 or 0))
-		if (dx ~=3D 0 or dy ~=3D 0) then self:SetCamPos(xloc+dx,yloc+dy) end
+		if (dx ~=3D 0 or dy ~=3D 0) then =

+			local tt,zz =3D GetGroundAtAbsPos(math.floor(xloc+dx),math.floor(yloc+d=
y))
+			self:SetCamPos(xloc+dx,yloc+dy,zz) =

+		end
 	end
-
+	=

 	=

 	gProfiler_R2D_MainStep:Section("EffectAnimStep")			self:EffectAnimStep() =
-- should be after player pos is updated, for effects moving with player
 	gProfiler_R2D_MainStep:Section("MapStep")					self:MapStep()

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Fri Feb 13 20:20:54 2009
@@ -279,17 +279,19 @@
 		print("StartOfflineMode ",x,y,z,t1,t2,t3)
 	end
 		=

-	gCurrentRenderer:InitLocalCam(x,y,z)
-
-	-- Binds key and Inits all InGame-Data
-	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
-
 	-- set z position to terrainheight at starting location
 	local tt,zz =3D GetGroundAtAbsPos(-x,y)
 	if zz then
 		--~ print("#",x,y,tt,z,zz) =

 		z =3D zz
 	end
+	=

+	=

+	gCurrentRenderer:InitLocalCam(x,y,z)
+
+	-- Binds key and Inits all InGame-Data
+	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
+
 =

 	gCurrentRenderer:SetOfflineStartPos(x,y,z)
 =




From no-reply at zwischenwelt.org  Fri Feb 13 21:09:04 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 20:09:04 -0000
Subject: [Iris-commit] [IRIS] r2921 - /trunk/lua/lib.mainmenu.charlist.lua
Message-ID: <20090213200904.B89731C1866A@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 21:09:04 2009
New Revision: 2921

Log:
fixed accountlist back button

Modified:
    trunk/lua/lib.mainmenu.charlist.lua

Modified: trunk/lua/lib.mainmenu.charlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.charlist.lua (original)
+++ trunk/lua/lib.mainmenu.charlist.lua Fri Feb 13 21:09:04 2009
@@ -44,7 +44,7 @@
 	=

 	if (bFreeSlotAvailable) then table.insert(rows,{{"Create New Character",M=
ainMenu_CharCreate_Start}}) end
 	if (not bAllSlotsEmpty) then table.insert(rows,{{"Delete Character",MainM=
enu_CharDelete_Start}}) end
-	table.insert(rows,{{"Back",MainMenu_AccountList_Back}})
+	table.insert(rows,{{"Back",MainMenu_CharList_Back}})
 	gMainMenuDialog_CharList =3D MainMenu_MakeTableDlg(rows) =

 end
 =

@@ -119,7 +119,7 @@
 =

 -- acc list =

 =

-function MainMenu_AccountList_Back ()
+function MainMenu_CharList_Back ()
 	MainMenuResetNetwork()
 	MainMenu_AccountList_Start()
 end



From no-reply at zwischenwelt.org  Fri Feb 13 21:19:52 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 20:19:52 -0000
Subject: [Iris-commit] [IRIS] r2922 - /trunk/lua/lib.loading.lua
Message-ID: <20090213201952.B15931C18869@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 21:19:52 2009
New Revision: 2922

Log:
map fallback fix

Modified:
    trunk/lua/lib.loading.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Fri Feb 13 21:19:52 2009
@@ -397,10 +397,8 @@
 	print("gMapIndex",gMapIndex)
 =

 	-- fallback to default maps because wrong map is better that client crash
-	if gMaps =3D=3D nil or gMaps[index] =3D=3D nil then
-		gMaps =3D gMaps or {}
-		gMaps[index] =3D gDefaultMaps[index]
-	end
+	gMaps =3D gMaps or {}
+	for k,v in pairs(gDefaultMaps) do gMaps[k] =3D gMaps[k] or v end
 	=

 	if (not gInitialMapLoaded) then LoadingProfile("load MapInfo") end
 	if (gMaps[index] =3D=3D nil) then print("gMaps["..index.."] not defined."=
) Crash() end



From no-reply at zwischenwelt.org  Fri Feb 13 21:46:49 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 20:46:49 -0000
Subject: [Iris-commit] [IRIS] r2923 - /trunk/installdeps.ubuntu.sh
Message-ID: <20090213204649.D13041C1886C@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 21:46:49 2009
New Revision: 2923

Log:
improved installdeps.ubuntu.sh fmod instructions

Modified:
    trunk/installdeps.ubuntu.sh

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Fri Feb 13 21:46:49 2009
@@ -5,7 +5,7 @@
 sudo apt-get install $DEPS
 echo ------------------------------
 echo iris 2 uses fmod ex 4.* to play music files. alternatively you can us=
e openal, but that no music then.
-echo you can download fmod for linux from http://www.fmod.org/index.php/do=
wnload
+echo you can download fmod ex 4.* stable for linux from http://www.fmod.or=
g/index.php/download
 echo ------------------------------
 echo iris 2 uses ogre1.6 now, there is no package for that yet, so you wil=
l need to compile that from source
 echo to do that, download the source from =




From no-reply at zwischenwelt.org  Fri Feb 13 21:57:46 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 20:57:46 -0000
Subject: [Iris-commit] [IRIS] r2924 - /trunk/premake.lua
Message-ID: <20090213205747.705331C18877@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 21:57:45 2009
New Revision: 2924

Log:
premake debug for fmod not found

Modified:
    trunk/premake.lua

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Fri Feb 13 21:57:45 2009
@@ -210,6 +210,7 @@
 		-- search for include path
 		for k,v in pairs(ibase) do
 			local x =3D string.format(v, libname)
+			print("addcustomlib",libname,"searching",v,x,os.direxists(x))
 			if os.direxists(x) then
 				tinsert (package.includepaths, x)
 				print("using "..x.." as "..libname.." include path")



From no-reply at zwischenwelt.org  Fri Feb 13 22:07:19 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 21:07:19 -0000
Subject: [Iris-commit] [IRIS] r2925 - /trunk/premake.lua
Message-ID: <20090213210719.DB76F1C18886@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 22:07:19 2009
New Revision: 2925

Log:
more premake.lua fmod debug output

Modified:
    trunk/premake.lua

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Fri Feb 13 22:07:19 2009
@@ -130,6 +130,7 @@
 		end
 	end
 	=

+	print("AddLugreDeps: fmod in defines:", in_array("USE_FMOD", package.defi=
nes))
 	if in_array("USE_FMOD", package.defines) then
 		-- fmod	=

 		addcustomlib(package, "fmodex")
@@ -188,6 +189,7 @@
 		"/usr/local/include/%s",
 		"/usr/include/%s",
 	}
+	print("addcustomlib start",package, libname,path)
 	=

 	-- brute force try
 	if not path then



From no-reply at zwischenwelt.org  Fri Feb 13 22:14:30 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 21:14:30 -0000
Subject: [Iris-commit] [IRIS] r2926 - /trunk/lua/lib.2d.cam.lua
Message-ID: <20090213211430.34F461C18869@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 22:14:29 2009
New Revision: 2926

Log:
2d mode zoom limit to avoid assert due to inversed world bbox

Modified:
    trunk/lua/lib.2d.cam.lua

Modified: trunk/lua/lib.2d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.cam.lua (original)
+++ trunk/lua/lib.2d.cam.lua Fri Feb 13 22:14:29 2009
@@ -60,6 +60,7 @@
 end
 =

 function Renderer2D:SetZoom (f)
+	f =3D max(0.1,f)
 	GetMainCam():SetOrthoWindow(f)
 	self.mfZoomFactor =3D f
 end



From no-reply at zwischenwelt.org  Fri Feb 13 22:21:58 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 21:21:58 -0000
Subject: [Iris-commit] [IRIS] r2927 - /trunk/premake.lua
Message-ID: <20090213212159.184F21C18890@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 22:21:58 2009
New Revision: 2927

Log:
premake.lua: customlib : 64 bit searchpaths, e.g. /usr/local/lib64/

Modified:
    trunk/premake.lua

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Fri Feb 13 22:21:58 2009
@@ -182,7 +182,9 @@
 function addcustomlib (package, libname)
 	local path =3D os.findlib(libname)
 	local lbase =3D {
+		"/usr/local/lib64/",
 		"/usr/local/lib/",
+		"/usr/lib64/",
 		"/usr/lib/",
 	}
 	local ibase =3D {
@@ -207,6 +209,7 @@
 	end
 	=

     if path then
+		print("fmod lib:",path,libname)
 		tinsert (package.libpaths,path)
 		tinsert (package.links, libname)
 		-- search for include path



From no-reply at zwischenwelt.org  Fri Feb 13 22:46:16 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 21:46:16 -0000
Subject: [Iris-commit] [IRIS] r2928 - in /trunk: installdeps.ubuntu.sh
	premake.lua
Message-ID: <20090213214616.DB5CF1C18871@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 22:46:16 2009
New Revision: 2928

Log:
premake.lua : 64 bit improved error messages if lib isn't found but headers=
 are there

Modified:
    trunk/installdeps.ubuntu.sh
    trunk/premake.lua

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Fri Feb 13 22:46:16 2009
@@ -6,6 +6,7 @@
 echo ------------------------------
 echo iris 2 uses fmod ex 4.* to play music files. alternatively you can us=
e openal, but that no music then.
 echo you can download fmod ex 4.* stable for linux from http://www.fmod.or=
g/index.php/download
+echo please install the 32 bit version of fmod, even if you have a 64 bit =
system, our buildscript won't be able to find it otherwise
 echo ------------------------------
 echo iris 2 uses ogre1.6 now, there is no package for that yet, so you wil=
l need to compile that from source
 echo to do that, download the source from =


Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Fri Feb 13 22:46:16 2009
@@ -191,7 +191,7 @@
 		"/usr/local/include/%s",
 		"/usr/include/%s",
 	}
-	print("addcustomlib start",package, libname,path)
+	--~ print("addcustomlib start",package, libname,path)
 	=

 	-- brute force try
 	if not path then
@@ -209,19 +209,22 @@
 	end
 	=

     if path then
-		print("fmod lib:",path,libname)
 		tinsert (package.libpaths,path)
 		tinsert (package.links, libname)
-		-- search for include path
-		for k,v in pairs(ibase) do
-			local x =3D string.format(v, libname)
-			print("addcustomlib",libname,"searching",v,x,os.direxists(x))
-			if os.direxists(x) then
-				tinsert (package.includepaths, x)
-				print("using "..x.." as "..libname.." include path")
-			end
+	else
+		print("WARNING:addcustomlib",libname," libfile not found")
+		print("if you installed the 64 bit version, please try installing the 32=
 bit version instead")
+    end
+	=

+	-- search for include path even if lib itself wasn't found, so 64 users w=
ho have the headers but the wrong lib don't get confused
+	for k,v in pairs(ibase) do
+		local x =3D string.format(v, libname)
+		--~ print("addcustomlib",libname,"searching",v,x,os.direxists(x))
+		if os.direxists(x) then
+			tinsert (package.includepaths, x)
+			print("using "..x.." as "..libname.." include path")
 		end
-    end
+	end
  end
 =

 -- ---------------------------------------------



From no-reply at zwischenwelt.org  Fri Feb 13 23:09:57 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 13 Feb 2009 22:09:57 -0000
Subject: [Iris-commit] [IRIS] r2929 - /trunk/premake.lua
Message-ID: <20090213220957.648E21C18861@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Feb 13 23:09:56 2009
New Revision: 2929

Log:
premake.lua : debug output for 64 bit

Modified:
    trunk/premake.lua

Modified: trunk/premake.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/premake.lua (original)
+++ trunk/premake.lua Fri Feb 13 23:09:56 2009
@@ -198,6 +198,7 @@
 		for k,v in pairs(lbase) do
 			local p =3D string.format(v, libname)
 			local b =3D p.."/lib"..libname
+			print("searching for ",b..".so/.a",os.fileexists(b..".so"),os.fileexist=
s(b..".a"))
 			if os.fileexists(b..".so") or os.fileexists(b..".a") then
 				tinsert (package.libpaths, p)
 				tinsert (package.links, libname)		=




From no-reply at zwischenwelt.org  Sat Feb 14 15:12:18 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 14 Feb 2009 14:12:18 -0000
Subject: [Iris-commit] [IRIS] r2930 - /trunk/lua/lib.mainmenu.accountlist.lua
Message-ID: <20090214141218.ED39E1C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Feb 14 15:12:18 2009
New Revision: 2930

Log:
acclist bugfix

Modified:
    trunk/lua/lib.mainmenu.accountlist.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Sat Feb 14 15:12:18 2009
@@ -61,7 +61,7 @@
 			end
 		end
 		-- if it was a fresh account with no chars yet, or charlist is unknown, =
list the login anyway
-		if (not bHadFirstChar) then table.insert(baserow,{char.name,fun_char}) e=
nd
+		if (not bHadFirstChar) then table.insert(rows,baserow) end
 	end
 	if (lastpassedit) then lastpassedit.nextcontrolname =3D "i_user" end
 	=




From no-reply at zwischenwelt.org  Sun Feb 15 18:41:40 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 15 Feb 2009 17:41:40 -0000
Subject: [Iris-commit] [IRIS] r2931 - /trunk/bin/iris2.exe
Message-ID: <20090215174140.7D2FF1C18661@zwischenwelt.org>

Author: sience
Date: Sun Feb 15 18:41:39 2009
New Revision: 2931

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sat Feb 21 15:33:10 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 21 Feb 2009 14:33:10 -0000
Subject: [Iris-commit] [IRIS] r2932 - /trunk/lua/net/net.dynamic.lua
Message-ID: <20090221143310.92BB71C1884D@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Feb 21 15:33:10 2009
New Revision: 2932

Log:
packet 0x3c secured for 6017 autodetection

Modified:
    trunk/lua/net/net.dynamic.lua

Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Sat Feb 21 15:33:10 2009
@@ -107,6 +107,14 @@
 =

 	local oldcount =

 	gProfiler_Container_Contents:Section("items")
+	=

+	local sizeleft =3D size - 5
+	local size_per_entry =3D sizeleft/itemcount -- old:19, 6017:20
+	=

+	local bHasGridLoc =3D size_per_entry =3D=3D 20 -- should only be true if =
ClientVersionIsPost6017()
+	if (size_per_entry ~=3D 19 and itemcount > 0 and
+		size_per_entry ~=3D 20) then print("ERROR in packet 0x3c sizeleft,itemco=
unt,size_per_entry",sizeleft,itemcount,size_per_entry) Crash() end
+	=

 	for i=3D1,itemcount do
 		local dynamicdata =3D {}
 		dynamicdata.container_content_order =3D i
@@ -118,7 +126,7 @@
 		dynamicdata.yloc				=3D input:PopNetInt16()
 		dynamicdata.zloc				=3D 0						--Grid Index (only since 6.0.1.7 2D and 2=
.45.5.6 KR)
 		=

-		if (ClientVersionIsPost6017()) then dynamicdata.gridloc =3D input:PopNet=
Int8(0) end =

+		if (bHasGridLoc) then dynamicdata.gridloc =3D input:PopNetInt8(0) end =

 		dynamicdata.iContainerSerial 	=3D input:PopNetUint32()
 		dynamicdata.hue 				=3D input:PopNetUint16()
 		=




From no-reply at zwischenwelt.org  Sun Feb 22 18:55:57 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 22 Feb 2009 17:55:57 -0000
Subject: [Iris-commit] [IRIS] r2933 - /trunk/lua/lib.mainmenu.charlist.lua
Message-ID: <20090222175601.5D8F71C1886D@zwischenwelt.org>

Author: sience
Date: Sun Feb 22 18:55:50 2009
New Revision: 2933

Log:
-bugfix back button

Modified:
    trunk/lua/lib.mainmenu.charlist.lua

Modified: trunk/lua/lib.mainmenu.charlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.charlist.lua (original)
+++ trunk/lua/lib.mainmenu.charlist.lua Sun Feb 22 18:55:50 2009
@@ -44,7 +44,7 @@
 	=

 	if (bFreeSlotAvailable) then table.insert(rows,{{"Create New Character",M=
ainMenu_CharCreate_Start}}) end
 	if (not bAllSlotsEmpty) then table.insert(rows,{{"Delete Character",MainM=
enu_CharDelete_Start}}) end
-	table.insert(rows,{{"Back",MainMenu_CharList_Back}})
+	table.insert(rows,{{"Back",MainMenu_AccountList_Back}})
 	gMainMenuDialog_CharList =3D MainMenu_MakeTableDlg(rows) =

 end
 =




From no-reply at zwischenwelt.org  Sun Feb 22 19:01:33 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 22 Feb 2009 18:01:33 -0000
Subject: [Iris-commit] [IRIS] r2934 - /trunk/lua/lib.mainmenu.accountlist.lua
Message-ID: <20090222180133.6897F1C1886D@zwischenwelt.org>

Author: sience
Date: Sun Feb 22 19:01:33 2009
New Revision: 2934

Log:
another bugfix disconnect from server after back button is pressed in charl=
ist

Modified:
    trunk/lua/lib.mainmenu.accountlist.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Sun Feb 22 19:01:33 2009
@@ -77,6 +77,7 @@
 end
 =

 function MainMenu_AccountList_Back ()
+	MainMenuResetNetwork()
 	MainMenu_ShardList_Start()
 end
 function MainMenu_AccountList_Stop ()



From no-reply at zwischenwelt.org  Sun Feb 22 19:34:21 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 22 Feb 2009 18:34:21 -0000
Subject: [Iris-commit] [IRIS] r2935 - /trunk/README
Message-ID: <20090222183421.77EDE1C1886D@zwischenwelt.org>

Author: sience
Date: Sun Feb 22 19:34:21 2009
New Revision: 2935

Log:
-updated

Modified:
    trunk/README

Modified: trunk/README
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/README (original)
+++ trunk/README Sun Feb 22 19:34:21 2009
@@ -1,4 +1,4 @@
-Iris2, Copyright (C) 2006 - 2008 Iris Team
+Iris2, Copyright (C) 2006 - 2009 Iris Team
 __________________________________________
 =

 Iris2 is a 3D/2D game client for Online Role Playing Game "Ultima Online" =
(tm)



From no-reply at zwischenwelt.org  Sun Feb 22 19:49:53 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 22 Feb 2009 18:49:53 -0000
Subject: [Iris-commit] [IRIS] r2937 - /branches/stable_release/
Message-ID: <20090222184953.2BFC51C1886E@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Feb 22 19:49:52 2009
New Revision: 2937

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r2936, trunk/



From no-reply at zwischenwelt.org  Sun Feb 22 19:49:52 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 22 Feb 2009 18:49:52 -0000
Subject: [Iris-commit] [IRIS] r2936 - /branches/stable_release/
Message-ID: <20090222184952.B99311C1886D@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Feb 22 19:49:52 2009
New Revision: 2936

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Sun Feb 22 19:49:53 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 22 Feb 2009 18:49:53 -0000
Subject: [Iris-commit] [IRIS] r2938 - /branches/stable_release/
Message-ID: <20090222184953.A29711C18870@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Feb 22 19:49:53 2009
New Revision: 2938

Log:
lugre -r696 svn://zwischenwelt.org/lugre/trunk/lugre

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Mon Feb 23 21:13:11 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 23 Feb 2009 20:13:11 -0000
Subject: [Iris-commit] [IRIS] r2939 - /trunk/vc9/iris.vcproj
Message-ID: <20090223201311.443E91C1886D@zwischenwelt.org>

Author: sience
Date: Mon Feb 23 21:13:10 2009
New Revision: 2939

Log:
-update

Modified:
    trunk/vc9/iris.vcproj

Modified: trunk/vc9/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc9/iris.vcproj (original)
+++ trunk/vc9/iris.vcproj Mon Feb 23 21:13:10 2009
@@ -39,7 +39,7 @@
 			<Tool
 				Name=3D"VCCLCompilerTool"
 				Optimization=3D"0"
-				AdditionalIncludeDirectories=3D"&quot;$(OGRE_HOME)\include&quot;;&quot=
;$(OGRE_HOME)\include\OIS&quot;;E:\OgreSDK;E:\OgreSDK\include\OIS;..\includ=
e\;..\include\zlib;..\lugre\include;..\include\fmodx;&quot;..\lugre\lib\Lua=
JIT-1.1.5\src&quot;;..\lugre\lib\md5\include;..\lugre\lib\cadune_tree\inclu=
de;..\lugre\lib\caelum\include"
+				AdditionalIncludeDirectories=3D"&quot;$(OGRE_HOME)\include&quot;;&quot=
;$(OGRE_HOME)\include\OIS&quot;;E:\OgreSDK;E:\OgreSDK\include\OIS;..\includ=
e\;..\include\zlib;..\lugre\include;..\include\fmodx;&quot;..\lugre\lib\lua=
-5.1.4\lib\static&quot;;..\lugre\lib\md5\include;..\lugre\lib\cadune_tree\i=
nclude;..\lugre\lib\caelum\include"
 				PreprocessorDefinitions=3D"WIN32;_DEBUG;USE_FMOD;MAIN_WORKING_DIR=3D\&=
quot;../\&quot;;USE_LUGRE_LIB_MD5;USE_LUGRE_LIB_CAELUM"
 				RuntimeLibrary=3D"1"
 				RuntimeTypeInfo=3D"false"
@@ -59,7 +59,7 @@
 			/>
 			<Tool
 				Name=3D"VCLinkerTool"
-				AdditionalDependencies=3D"AdvAPI32.Lib User32.Lib ws2_32.lib zlibd.lib=
 luajit-1.1.5_vc2008_debug.lib OgreMain_d.lib OIS_d.lib fmodex_vc.lib"
+				AdditionalDependencies=3D"AdvAPI32.Lib User32.Lib ws2_32.lib zlibd.lib=
 lua5.1_vc2008_debug.lib OgreMain_d.lib OIS_d.lib fmodex_vc.lib"
 				OutputFile=3D"$(OutDir)\..\..\bin\$(ProjectName)_d.exe"
 				AdditionalLibraryDirectories=3D"&quot;$(OGRE_HOME)\lib\&quot;;..\libs\=
fmodx;..\libs\zlib;&quot;..\lugre\lib\LuaJIT-1.1.5\lib\static&quot;;..\lugr=
e\lib\caelum\lib\static"
 				IgnoreAllDefaultLibraries=3D"false"



From no-reply at zwischenwelt.org  Mon Feb 23 21:14:19 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 23 Feb 2009 20:14:19 -0000
Subject: [Iris-commit] [IRIS] r2940 - /trunk/vc9/iris.vcproj
Message-ID: <20090223201419.E12201C1886D@zwischenwelt.org>

Author: sience
Date: Mon Feb 23 21:14:19 2009
New Revision: 2940

Log:
-update

Modified:
    trunk/vc9/iris.vcproj

Modified: trunk/vc9/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc9/iris.vcproj (original)
+++ trunk/vc9/iris.vcproj Mon Feb 23 21:14:19 2009
@@ -61,7 +61,7 @@
 				Name=3D"VCLinkerTool"
 				AdditionalDependencies=3D"AdvAPI32.Lib User32.Lib ws2_32.lib zlibd.lib=
 lua5.1_vc2008_debug.lib OgreMain_d.lib OIS_d.lib fmodex_vc.lib"
 				OutputFile=3D"$(OutDir)\..\..\bin\$(ProjectName)_d.exe"
-				AdditionalLibraryDirectories=3D"&quot;$(OGRE_HOME)\lib\&quot;;..\libs\=
fmodx;..\libs\zlib;&quot;..\lugre\lib\LuaJIT-1.1.5\lib\static&quot;;..\lugr=
e\lib\caelum\lib\static"
+				AdditionalLibraryDirectories=3D"&quot;$(OGRE_HOME)\lib\&quot;;..\libs\=
fmodx;..\libs\zlib;&quot;..\lugre\lib\lua-5.1.4\lib\static&quot;;..\lugre\l=
ib\caelum\lib\static"
 				IgnoreAllDefaultLibraries=3D"false"
 				IgnoreDefaultLibraryNames=3D"LIBCMTD.lib"
 				GenerateDebugInformation=3D"true"



