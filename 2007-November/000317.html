<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1502 - in /trunk/data/lua: ./ filter/ gui/	net/ obj/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1502%20-%20in%20/trunk/data/lua%3A%20./%20filter/%20gui/%0A%09net/%20obj/&In-Reply-To=%3C20071113200131.E14C51C182BC%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000316.html">
   <LINK REL="Next"  HREF="000318.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1502 - in /trunk/data/lua: ./ filter/ gui/	net/ obj/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1502%20-%20in%20/trunk/data/lua%3A%20./%20filter/%20gui/%0A%09net/%20obj/&In-Reply-To=%3C20071113200131.E14C51C182BC%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1502 - in /trunk/data/lua: ./ filter/ gui/	net/ obj/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Tue Nov 13 21:01:31 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000316.html">[Iris-commit] [IRIS] r1501 - /trunk/data/lua/main.lua
</A></li>
        <LI>Next message: <A HREF="000318.html">[Iris-commit] [IRIS] r1503 - in /trunk/data: base/main.material	config.lua.dist
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#317">[ date ]</a>
              <a href="thread.html#317">[ thread ]</a>
              <a href="subject.html#317">[ subject ]</a>
              <a href="author.html#317">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: sience
Date: Tue Nov 13 21:01:30 2007
New Revision: 1502

Log:
-all uo-file definitions are consolidated in config.lua.dist (map+statics+d=
iffs are in maps.xml)
-some comments cleaned up
-AmbientLight setting reorganised like SunLight setting
-Lights are correct created and deleted now
-lots of other changes
-some files moved to subfolders

Added:
    trunk/data/lua/filter/
    trunk/data/lua/filter/filter.art.lua
    trunk/data/lua/filter/filter.granny.lua
    trunk/data/lua/filter/filter.map.lua
    trunk/data/lua/net/net.corpse.lua
    trunk/data/lua/net/net.login.lua
    trunk/data/lua/net/net.skill.lua
    trunk/data/lua/net/net.sound.lua
    trunk/data/lua/net/net.world.lua
Removed:
    trunk/data/lua/filter.art.lua
    trunk/data/lua/filter.granny.lua
    trunk/data/lua/filter.map.lua
    trunk/data/lua/lib.meshexporter.lua
    trunk/data/lua/lib.oldiristest.lua
    trunk/data/lua/net.corpse.lua
    trunk/data/lua/net.login.lua
    trunk/data/lua/net.skill.lua
    trunk/data/lua/net.sound.lua
    trunk/data/lua/net.world.lua
Modified:
    trunk/data/lua/gui/gui.paperdoll.lua
    trunk/data/lua/lib.3d.dynamic.lua
    trunk/data/lua/lib.3d.map.lua
    trunk/data/lua/lib.3d.renderer.lua
    trunk/data/lua/lib.charcreate.lua
    trunk/data/lua/lib.data.lua
    trunk/data/lua/lib.debugmenu.lua
    trunk/data/lua/lib.fallback.lua
    trunk/data/lua/lib.filepath.lua
    trunk/data/lua/lib.granny.lua
    trunk/data/lua/lib.gui.iris.lua
    trunk/data/lua/lib.keybinds.lua
    trunk/data/lua/lib.loading.lua
    trunk/data/lua/lib.protocol.lua
    trunk/data/lua/lib.sound.iris.lua
    trunk/data/lua/lib.static.lua
    trunk/data/lua/lib.stitchin.lua
    trunk/data/lua/lib.test.lua
    trunk/data/lua/main.lua
    trunk/data/lua/net/net.main.lua
    trunk/data/lua/obj/obj.mobile.lua

Modified: trunk/data/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.paperdoll.lua (original)
+++ trunk/data/lua/gui/gui.paperdoll.lua Tue Nov 13 21:01:30 2007
@@ -335,7 +335,7 @@
 			NET: ProtocolPacketRecvHandler typeid=3D0x11,size=3D66,typename=3DkPack=
et_Mobile_Stats
 			NET (todo): Mobile_Stats id: 17 Size: 66 PlayerID: 1707739 Name: Admin
 			NET: ProtocolPacketRecvHandler typeid=3D0x3a,size=3D349,typename=3DkPac=
ket_Skills
-			(see net.skill.lua)
+			(see net/net.skill.lua)
 			]]--
 		end
 	end

Modified: trunk/data/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.dynamic.lua (original)
+++ trunk/data/lua/lib.3d.dynamic.lua Tue Nov 13 21:01:30 2007
@@ -16,8 +16,8 @@
 	self:CreateDynamicGfx(item)
 end
 =

+-- TODO: Multis &amp; Serversidemultis don't recognize kTileDataFlag_LightSour=
ce yet
 function Renderer3D:CreateDynamicGfx( item )
-
 	assert(not item.gfx)
 =

 	-- FILTER: get correction
@@ -93,7 +93,7 @@
 						child.artid =3D blocknum
 						table.insert(item.lMultiChildGfx, child)
 					else
-						printdebug(&quot;missing&quot;,sprintf(&quot;Renderer3D:CreateDynamicGfx: failed lo=
ading sub mesh for dynamic (multi): artid=3D%i\n&quot;,blocknum or -1))
+						printdebug(&quot;multi&quot;,sprintf(&quot;Renderer3D:CreateDynamicGfx: failed load=
ing sub mesh for dynamic (multi): artid=3D%i\n&quot;,blocknum or -1))
 					end
 				end
 			end
@@ -110,24 +110,14 @@
 	else
 		-- normal 1 part object
 		item.gfx =3D CreateRootGfx3D()
-		meshname =3D (not gForceFallBackBillboards_Dynamics) and GetStaticMeshNa=
me(item.artid,item.hue) -- (item.artid+ 0*16384,item.hue)
+		meshname =3D (not gForceFallBackBillboards_Dynamics) and GetStaticMeshNa=
me(item.artid,item.hue)
 		if (meshname and meshname ~=3D &quot;&quot;) then
 			item.gfx:SetMesh(meshname)
 			item.gfx:SetScale(-1,1,1)		-- (-1) thats because xmirror bug and wrong =
mirrored mashes
 			item.gfx:SetNormaliseNormals(true)
 =

-			--kTileDataFlag_LightSource
-			if (gLightsources) then
-			local arrtiletype =3D {}
-			arrtiletype =3D GetStaticTileType(item.artid)
-			if( TestBit(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ) then
-				local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc=
+arrtiletype.miHeight) * 0.1)
-				Client_AddPointLight(x,y,z, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
-			end
-			end
-
 			-- --------------------------------------------------------------------=
-----
-			-- todo: HACK here (zadd because dynamic street-tiles dont look good (f=
lying).)
+			-- todo: HACK here (zadd because dynamic street-tiles dont look good (f=
lying)
 			if (CountMeshTriangles(meshname) &lt;=3D 4) then =

 				item.gfx:SetCastShadows(false)	-- groundtiles and item billboards shou=
ldn't cast shadows
 				if (gTileTypeLoader) then
@@ -140,12 +130,10 @@
 =

 		elseif (gEnableFallBackBillboards_Dynamics) then
 			local iTranslatedTileTypeID =3D SeasonalStaticTranslation(item.artid, g=
SeasonSetting)
-			-- we have to add 16384 for fallbacks
+			-- we have to add 16384 for fallbacks, because static Art starts on 163=
84 in Art.mul file
 			iTranslatedTileTypeID =3D iTranslatedTileTypeID + 16384
 =

-			--print(&quot;######DYNAMIC MESH NOT FOUND : &quot;,item.artid,iTranslatedTileTyp=
eID)
-			--print(&quot;######&quot;,vardump(GetStaticTileType(item.artid)))
-			-- fallback to billboard with original art or =

+			-- fallback to billboard with original art
 			if (not IsArtBillboardFallBackSkipped(item.artid)) then
 				item.gfx.billboard =3D item.gfx:CreateChild()
 				item.xadd =3D item.xadd + 0.5
@@ -159,6 +147,17 @@
 =

 		-- FILTER: correction
 		item.gfx:SetOrientation(GetStaticMeshOrientation(item.artid))
+
+		-- creates a light if lights are enabled and static is a lightsource
+		-- note! lights don't cast shadows
+		if (gLightsources) then
+			local arrtiletype =3D {}
+			arrtiletype =3D GetStaticTileType(item.artid)
+			if( TestBit(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ) then
+				local x,y,z =3D Renderer3D:UOPosToLocal(item.xloc,item.yloc,(item.zloc=
+arrtiletype.miHeight) * 0.1)
+				item.lightname=3DClient_AddPointLight(x,y,z, 0.3,0.3,0.0, 0.3,0.3,0.0,=
 5.0,0.1,0.1,0.0)
+			end
+		end
 =

 		self:UpdateDynamicItemPos(item)
 	end
@@ -174,7 +173,6 @@
 	if (not h or h =3D=3D 0) then h =3D isotilew end
 	gfx:SetSimpleRenderable()
 	gfx:SetMaterial(matname)
-	--gfx:SetMaterial(&quot;checker&quot;)
 	gfx:SetForceRotCam(GetMainCam())
 	gfx:RenderableBegin(4,6,false,false,OT_TRIANGLE_LIST)
 	gfx:RenderableVertex( 0.5*w / isotilew,-0.5					,0, 1*w/texsize(w),h/texs=
ize(h))
@@ -201,4 +199,6 @@
 		dynamic.gfx:Destroy()
 		dynamic.gfx =3D nil
 	end
-end
+	-- if gfx has an assigned lightsource, delete it
+	if (dynamic.lightname) then Client_RemoveLight(dynamic.lightname) dynamic=
.lightname =3D nil end
+end

Modified: trunk/data/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.map.lua (original)
+++ trunk/data/lua/lib.3d.map.lua Tue Nov 13 21:01:30 2007
@@ -148,7 +148,7 @@
 	chunk.lStaticEntities =3D {}
 	=

 	-- load statics
-	if (gStaticBlockLoader) then -- probably needs gArtMapLoader and gLegacyM=
odelAndTextureLoader
+	if (gStaticBlockLoader) then -- probably needs gArtMapLoader
 		local x,y,i
 		local iTileTypeID,iX,iY,iZ,iHue
 		local entity,meshname
@@ -159,7 +159,7 @@
 =

 				printdebug(&quot;static&quot;,&quot;iStaticCount=3D&quot;..iStaticCount)
 				printdebug(&quot;static&quot;,&quot;iBlockUO_X=3D&quot;..iBlockUO_X..&quot; iBlockUO_Y=3D&quot;..iBl=
ockUO_Y)
-				printdebug(&quot;static&quot;,&quot;BlockX=3D&quot;..iBlockUO_X+x..&quot; BlockY=3D&quot;..iBlockUO_=
Y+y)
+				printdebug(&quot;static&quot;,&quot;BlockX=3D&quot;..x..&quot; BlockY=3D&quot;..y)
 =

 				for i =3D 0,iStaticCount-1 do
 					iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i) -- oper=
ates on the block that was last loaded using :Load()
@@ -182,6 +182,8 @@
 					entity.iHue =3D iHue
 					=

 					meshname =3D (not gForceFallBackBillboards_Statics) and GetStaticMesh=
Name(iTileTypeID,iHue)
+					=

+					-- create Mesh
 					if (meshname and meshname ~=3D &quot;&quot; and (not MeshIsPseudoBillBoard(iTil=
eTypeID))) then
 						entity.staticentity =3D CreateMeshEntity(meshname)
 						local qw,qx,qy,qz =3D GetStaticMeshOrientation(iTileTypeID)
@@ -194,16 +196,6 @@
 						entity.sy =3D sy
 						entity.sz =3D sz
 =

-						-- lights don't cast shadows
-						if (gLightsources) then
-							local arrtiletype =3D {}
-							arrtiletype =3D GetStaticTileType(iTileTypeID)
-							if( TestBit(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ) t=
hen
-								local x,y,z =3D Renderer3D:UOPosToLocal(entity.x,entity.y,entity.z=
 * 0.1)
-								Client_AddPointLight(entity.x-0.5,entity.y-0.5,entity.z+arrtiletyp=
e.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
-							end
-						end
-
 						local myLayer =3D iZ
 						local myLayerStaticGeom =3D chunk.pStaticGeometryLayers[myLayer]
 						if (not myLayerStaticGeom) then
@@ -215,8 +207,8 @@
 						myLayerStaticGeom:AddEntity(entity.staticentity,entity.x,entity.y,en=
tity.z,qw,qx,qy,qz,sx,sy,sz)
 						table.insert(chunk.lStaticEntities,entity)
 =

-					elseif (gEnableFallBackBillboards_Statics) then
-						-- fallback to billboard with original art or						=

+					-- or Fallback to billboard with original art
+					elseif (gEnableFallBackBillboards_Statics) then					=

 						local iTranslatedTileTypeID =3D SeasonalStaticTranslation(iTileTypeI=
D, gSeasonSetting)
 						-- we have to add 16384 for fallbacks
 						iTranslatedTileTypeID =3D iTranslatedTileTypeID + 16384
@@ -231,6 +223,18 @@
 							-- TODO : printdebug(&quot;missing&quot;,sprintf(&quot;Renderer3D:missing static :=
 artid=3D%i z_typename=3D%s\n&quot;,item.artid or -1,item.z_typename or &quot;&quot;))
 						end
 					end
+
+					-- creates a light if lights are enabled and static is a lightsource
+					-- note! lights don't cast shadows
+					if (gLightsources) then
+						local arrtiletype =3D {}
+						arrtiletype =3D GetStaticTileType(iTileTypeID)
+						if( TestBit(arrtiletype.miFlags or 0,kTileDataFlag_LightSource) ) th=
en
+							local x,y,z =3D Renderer3D:UOPosToLocal(entity.x,entity.y,entity.z =
* 0.1)
+							entity.lightname=3DClient_AddPointLight(entity.x-0.5,entity.y-0.5,e=
ntity.z+arrtiletype.miHeight, 0.3,0.3,0.0, 0.3,0.3,0.0, 5.0,0.1,0.1,0.0)
+						end
+					end
+
 					self:UpdateStaticVisibility(entity)
 				end =

 		end end
@@ -367,6 +371,7 @@
 end
 =

 -- coords in chunks
+-- TODO : release anything else that was allocated in CreateMapChunk
 function Renderer3D:DestroyMapChunk (x,y,chunk)
 	if (not chunk.bIsDead) then
 		--print(&quot;DestroyMapChunk&quot;,x,y)
@@ -374,7 +379,8 @@
 		if (chunk.pStaticGeometryTerrain) then chunk.pStaticGeometryTerrain:Dest=
roy() chunk.pStaticGeometryTerrain =3D nil end
 		if (chunk.terraingfx) then chunk.terraingfx:Destroy() chunk.terraingfx =
=3D nil end
 		if (chunk.pTerrainEntity) then chunk.pTerrainEntity:Destroy() chunk.pTer=
rainEntity =3D nil end
-		for k,v in pairs(chunk.lStaticEntities) do =

+		for k,v in pairs(chunk.lStaticEntities) do
+			if (v.lightname) then Client_RemoveLight(v.lightname) v.lightname =3D n=
il end
 			if (v.staticentity) then v.staticentity:Destroy() v.staticentity =3D ni=
l end
 			if (v.gfx and v.gfx.billboard) then v.gfx.billboard:Destroy() v.gfx.bil=
lboard =3D nil end
 			if (v.gfx) then v.gfx:Destroy() v.gfx =3D nil end
@@ -382,6 +388,5 @@
 		chunk.lStaticEntities =3D {}
 		for k,v in pairs(chunk.pStaticGeometryLayers) do v:Destroy() end chunk.p=
StaticGeometryLayers =3D {}
 		if (chunk.sTerrainMeshName) then UnloadMeshName(chunk.sTerrainMeshName) =
chunk.sTerrainMeshName =3D nil end -- unload terrain mesh
-		-- TODO : release anything else that was allocated in CreateMapChunk
-	end
-end
+	end
+end

Modified: trunk/data/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.renderer.lua (original)
+++ trunk/data/lua/lib.3d.renderer.lua Tue Nov 13 21:01:30 2007
@@ -85,6 +85,7 @@
 	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
 	cam:SetProjectionType(0) -- perspective
 	Client_ClearLights()
+
 	-- Sun Light
 	gDirectionalLightSun =3D Client_AddDirectionalLight(
 								gSunLightDirection.x,
@@ -100,7 +101,11 @@
 								gSunLightSpecular.r,
 								gSunLightSpecular.g,
 								gSunLightSpecular.b)
-	Client_SetAmbientLight(0.4, 0.4, 0.4, 1)
+
+	-- Ambient Light
+	Client_SetAmbientLight( gAmbientLight.r,
+							gAmbientLight.g,
+							gAmbientLight.b, 1)
 	=

 	self.gbActive =3D true
 	self:SetMapEnvironment()

Modified: trunk/data/lua/lib.charcreate.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.charcreate.lua (original)
+++ trunk/data/lua/lib.charcreate.lua Tue Nov 13 21:01:30 2007
@@ -33,7 +33,7 @@
 end
 =

 function GetCharCreationTemplates () =

-	return LoadProfInfo(CorrectPath(gUOPath..&quot;Prof.txt&quot;))
+	return LoadProfInfo(CorrectPath( Addfilepath(gProftxtFile) ))
 end
 =

 -- loads an Prof.txt info file with character creation templates

Modified: trunk/data/lua/lib.data.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.data.lua (original)
+++ trunk/data/lua/lib.data.lua Tue Nov 13 21:01:30 2007
@@ -43,21 +43,23 @@
 end
 =

 -- art material loader with caching
+-- if someone what to view runned tiles (static tiles) he has to add (iArt=
ID + 16384)
 gArtMatCache =3D {}
-function GetArtMat (iArtID,hueid)
+--[[
+function old_GetArtMat (iArtID,iHue)
 	if (not gArtMapLoader) then return &quot;art_fallback&quot; end
-	if (not(hueid) or (tonumber(hueid) &gt; gMaxHueValue)) then hueid=3D0 end
-	local res =3D gArtMatCache[iArtID..&quot;_&quot;..hueid]
+	if (not(iHue) or (tonumber(iHue) &gt; gMaxHueValue)) then iHue=3D0 end
+	local res =3D gArtMatCache[iArtID..&quot;_&quot;..iHue]
 	if (not res) then
 		res =3D {}
 		-- bPixelExact,bInvertY,bInvertX,bHasAlpha,bEnableLighting,bEnableDepthW=
rite,HueLoader,iHue
-		res.material =3D gArtMapLoader:CreateMaterial(iArtID,true,false,false,tr=
ue,false,false, gHueLoader, hueid)
+		res.material =3D gArtMapLoader:CreateMaterial(iArtID,true,false,false,tr=
ue,false,false, gHueLoader, iHue)
 		=

 		local iWidth, iHeight =3D gArtMapLoader:GetSize()
 		res.width =3D iWidth
 		res.height =3D iHeight
 		=

-		gArtMatCache[iArtID..&quot;_&quot;..hueid] =3D res
+		gArtMatCache[iArtID..&quot;_&quot;..iHue] =3D res
 	end
 	=

 	if (not res.material) then
@@ -71,18 +73,79 @@
 	=

 	return res.material
 end
-
+]]--
+function SaveUOModelImageToFile(rtt,texname)
+	if (rtt) then rtt:WriteContentsToFile(&quot;t&quot;..texname..&quot;.bmp&quot;) end
+end
+-- New GetArtMat with RTT support
+function GetArtMat (iArtID,iHue)
+	if (not gArtMapLoader) then return &quot;art_fallback&quot; end
+	if (not(iHue) or (tonumber(iHue) &gt; gMaxHueValue)) then iHue=3D0 end
+
+	local res =3D gArtMatCache[iArtID..&quot;_&quot;..iHue]
+	if (not res) then
+		res =3D {}
+		local w,h =3D 0
+
+		-- check if RTT generated Art Tiles is enabled and try to generate a RTT=
 Tile out of an *.mesh
+		if (gEnableRTTModelImages) then
+			printdebug(&quot;static&quot;,&quot;try to create RTT from MeshID (iArtID - 16384): &quot;.=
.iArtID - 16384)
+			local meshname =3D GetModelName(FilterMesh(iArtID - 16384))
+
+			if (OgreMeshAvailable(meshname)) then
+				local iMaxW=3D48
+				local iMaxH=3D32
+				local texname,rtt =3D GetMeshPreviewX (meshname, iMaxW, 0, 1.5, PF_A8R=
8G8B8, 1.0, 1.0, 1.0, 0.0)
+				res.material =3D texname and CloneMaterial(&quot;rtt_base&quot;)
+				SetTexture(res.material,texname)
+			=

+				-- Saves the raw Texture as BMP or PNG
+				if (false) then SaveUOModelImageToFile(rtt,texname) end
+
+				w =3D 44 / math.sqrt(2)
+				h =3D 44 / math.sqrt(2)
+				if (iMaxW) then w =3D math.min(iMaxW,w) end
+				if (iMaxH) then h =3D math.min(iMaxH,h) end
+			else
+				printdebug(&quot;static&quot;,&quot;mesh not available&quot;, meshname)
+			end
+		end
+		=

+		-- if no Art Tile is existent, load the Art Tile from Art.mul
+		if (not res.material or res.material =3D=3D &quot;&quot;) then
+			-- bPixelExact,bInvertY,bInvertX,bHasAlpha,bEnableLighting,bEnableDepth=
Write,HueLoader,iHue
+			res.material =3D gArtMapLoader:CreateMaterial(iArtID,true,false,false,t=
rue,false,false, gHueLoader, iHue)
+			w,h =3D gArtMapLoader:GetSize()
+		end
+
+		res.width =3D w
+		res.height =3D h
+		=

+		gArtMatCache[iArtID..&quot;_&quot;..iHue] =3D res
+	end
+	=

+	if (not res.material) then
+		-- fallbacks if not found
+		if (iArtID &lt; 16384) then
+			return GetArtMat( 0 ) -- fallback first ground
+		else
+			return GetArtMat( 16384 ) -- fallback first static
+		end
+	end
+	=

+	return res.material
+end
 =

 -- art material loader with caching
 gArtBillBoardMatCache =3D {}
-function GetArtBillBoardMat (iArtID,hueid)
-	if (not(hueid) or (hueid &gt; gMaxHueValue)) then hueid=3D0 end
-	local res =3D gArtBillBoardMatCache[iArtID..&quot;_&quot;..hueid]
+function GetArtBillBoardMat (iArtID,iHue)
+	if (not(iHue) or (iHue &gt; gMaxHueValue)) then iHue=3D0 end
+	local res =3D gArtBillBoardMatCache[iArtID..&quot;_&quot;..iHue]
 	if (res) then return res end
 	-- bPixelExact,bInvertY,bInvertX,bHasAlpha,bEnableLighting,bEnableDepthWr=
ite,HueLoader,iHue
-	res =3D gArtMapLoader and gArtMapLoader:CreateMaterial(iArtID,true,false,=
false,true,false,true, gHueLoader,hueid)
+	res =3D gArtMapLoader and gArtMapLoader:CreateMaterial(iArtID,true,false,=
false,true,false,true, gHueLoader,iHue)
 	if (not res or res =3D=3D &quot;&quot;) then res =3D &quot;art_fallback&quot; end
-	gArtBillBoardMatCache[iArtID..&quot;_&quot;..hueid] =3D res
+	gArtBillBoardMatCache[iArtID..&quot;_&quot;..iHue] =3D res
 	return res
 end
 =

@@ -114,12 +177,12 @@
 =

 -- gump material loader with caching
 gGumpMatCache =3D {}
-function GetGumpMat (iGumpID,hueid)
-	if (not(hueid) or (hueid &gt; gMaxHueValue)) then hueid=3D0 end
-	local res =3D gGumpMatCache[iGumpID..&quot;_&quot;..hueid]
+function GetGumpMat (iGumpID,iHue)
+	if (not(iHue) or (iHue &gt; gMaxHueValue)) then iHue=3D0 end
+	local res =3D gGumpMatCache[iGumpID..&quot;_&quot;..iHue]
 	if (not res and gGumpLoader) then
-		res =3D gGumpLoader:CreateMaterial(iGumpID,true,gHueLoader,hueid)
-		gGumpMatCache[iGumpID..&quot;_&quot;..hueid] =3D res
+		res =3D gGumpLoader:CreateMaterial(iGumpID,true,gHueLoader,iHue)
+		gGumpMatCache[iGumpID..&quot;_&quot;..iHue] =3D res
 	end
 	return res
 end
@@ -151,3 +214,59 @@
 	gTexMapLoader:Load(iTexMapID)
 	return gTexMapLoader:GetSize()
 end
+
+------------------------------------------ the following parts are copied =
from lugre and modified, should be merged into lugre ----------------------=
---------------------
+-- this is normally in lugre - just a bit modified - should be removed som=
etimes
+function GetMeshPreviewX (meshname, res, angh, angv, pixelformat, r, g, b,=
 a) =

+	res =3D res or 16
+	angh =3D angh or 45*gfDeg2Rad
+	angv =3D angv or 30*gfDeg2Rad
+
+--~ 	local x1,y1,z1,x2,y2,z2 =3D MeshReadOutExactBounds(meshname)
+--~ 	local boundrad =3D math.max(Vector.len(x1,y1,z1),Vector.len(x2,y2,z2))
+--~ 	MeshSetBounds(meshname,x1,y1,z1,x2,y2,z2)
+--~ 	MeshSetBoundRad(meshname,boundrad)
+
+	local boundrad =3D MeshGetBoundRad(meshname)
+	=

+	local name_scenemanager		=3D GetUniqueName()
+	local name_texture			=3D GetUniqueName()
+	=

+	-- prepare rtt
+	CreateSceneManager(name_scenemanager)
+	local cam =3D CreateCamera(name_scenemanager)
+	local tex =3D CreateRenderTexture(name_texture,res,res,pixelformat or PF_=
A8R8G8B8)
+
+	if (not tex:IsAlive()) then return end
+	tex:SetAutoUpdated(false)
+
+	local vp =3D CreateRTTViewport(tex,cam)
+	vp:SetOverlaysEnabled(false)
+	vp:SetBackCol(r, g, b, a)
+
+	--local dist =3D GetRenderingDistanceForPixelSize(boundrad,res*0.25,vp,ca=
m)
+	local visrad_pixels =3D res*0.5
+	local vw,vh =3D res,res
+	local dist =3D 0.7 * math.max( boundrad/(visrad_pixels/vw), boundrad/(vis=
rad_pixels/vh) ) -- dirty hack, TODO : analyse projection matrix
+	=

+	Client_AddDirectionalLight(-0.3,-0.5,-0.1,name_scenemanager)
+
+	cam:SetAspectRatio(vp:GetActualWidth()/vp:GetActualHeight())
+	cam:SetNearClipDistance(1)
+	cam:SetFarClipDistance(dist*2 + boundrad)
+	=

+	local gfx =3D CreateRootGfx3D(name_scenemanager)
+	gfx:SetMesh(meshname)
+
+	gfx:SetPosition(0.5,-1,-dist);
+
+	local qw,qx,qy,qz =3D Quaternion.fromAngleAxis(angv,1,0,0)
+	gfx:SetOrientation(Quaternion.Mul(qw,qx,qy,qz,Quaternion.fromAngleAxis(an=
gh + 180*gfDeg2Rad,0,1,0)))
+	tex:Update()
+	cam:Destroy()
+	vp:Destroy()
+
+	-- TODO : DestroySceneManager(name_scenemanager)
+	return name_texture,tex
+end
+------------------------------------------ the former parts are copied fro=
m lugre and modified, should be merged into lugre -------------------------=
------------------

Modified: trunk/data/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.debugmenu.lua (original)
+++ trunk/data/lua/lib.debugmenu.lua Tue Nov 13 21:01:30 2007
@@ -371,6 +371,28 @@
 	DebugMenuSetParam1(iArtID)
 end
 =

+-- iMaxW,iMaxH : can be nil for unlimited size
+function MakeUOArtImageForDialog (iTileTypeID, iHue, iMaxW, iMaxH) =

+	iHue =3D iHue or 0
+	local iTranslatedTileTypeID =3D SeasonalStaticTranslation(iTileTypeID, gS=
easonSetting)
+	-- we have to add 16384 for fallbacks
+	iTranslatedTileTypeID =3D iTranslatedTileTypeID + 16384
+
+	local matname =3D GetArtMat(iTranslatedTileTypeID,iHue)
+	local isotilew =3D 44 / math.sqrt(2)
+	local w,h =3D GetArtSize(iTranslatedTileTypeID)
+	if (not w or w =3D=3D 0) then w =3D isotilew end
+	if (not h or h =3D=3D 0) then h =3D isotilew end
+	local tw,th =3D texsize(w),texsize(h)
+	local fw,fh =3D w,h
+	if (iMaxW) then w =3D math.min(iMaxW,w) end
+	if (iMaxH) then h =3D math.min(iMaxH,h) end
+	local offx,offy =3D (fw-w)*0.5,(fh-h)*0.5  -- this is 0,0 if the art is f=
ully visible, centers art if not
+	local u1,v1,u2,v2 =3D offx/tw,offy/th,(offx+w)/tw,(offy+h)/th
+	matname =3D (string.len(matname) &gt; 0) and matname or &quot;BaseWhiteNoLighting&quot;
+	return {type=3D&quot;Img2&quot;,	w=3Dw,h=3Dh,matname=3Dmatname, u1=3Du1,v1=3Dv1,u2=
=3Du2,v2=3Dv2}
+end
+
 function ShowDebugMenuArtList (iStart)
 	local rows =3D { =

 		{ {type=3D&quot;Label&quot;,		text=3D&quot;ArtList&quot;}, },
@@ -402,11 +424,7 @@
 			if (i &lt; iMax) then
 =

 				local dialog_arr =3D {}
-				if (gEnableRTTModelImages) then
-					dialog_arr =3D MakeRTTImageForDialog(i,0,48,32)
-				else
-					dialog_arr =3D MakeUOArtImageForDialog(i,0,48,32)
-				end
+				dialog_arr =3D MakeUOArtImageForDialog(i,0,48,32)
 =

 				if (dialog_arr) then
 					table.insert(row1, dialog_arr)
@@ -424,99 +442,3 @@
 =

 	guimaker.MakeTableDlg(rows,10,10,true,true,gGuiDefaultStyleSet,&quot;window&quot;)
 end
-
------------------------------------------- the following parts are copied =
from lugre and modified, should be merged into lugre ----------------------=
---------------------
-
--- TODO: CACHE and DESTORY !!!!!!!!!!!!!!!!!!!
---
--- iMaxW,iMaxH : can be nil for unlimited size
-gRTTMaterialCache =3D {}
-function MakeRTTImageForDialog (TileTypeID,iHue,iMaxW,iMaxH)
-	local meshname =3D GetModelName(FilterMesh(TileTypeID))
-	if not OgreMeshAvailable(meshname) then printdebug(&quot;static&quot;,&quot;mesh not ava=
ilable&quot;, meshname) return end
-
-	local matname =3D gRTTMaterialCache[TileTypeID..&quot;_&quot;..iHue]
-
-	local w,h,u1,v1,u2,v2 =3D 0
-	if (not matname) then
-		local texname,rtt =3D GetMeshPreviewX (meshname, iMaxW, 0, 1.5, PF_A8R8G=
8B8, 1.0, 1.0, 1.0, 0.0)
-
---		matname =3D texname and GetPlainTextureMat(texname)
-		matname =3D texname and CloneMaterial(&quot;rtt_base&quot;)
-		SetTexture(matname,texname)
---		SaveUOModelImageToFile(rtt,texname)
-
---		w,h =3D GetArtSize(iTranslatedTileTypeID)
-		w =3D 44 / math.sqrt(2)
-		h =3D 44 / math.sqrt(2)
-		local tw,th =3D texsize(w),texsize(h)
-		local fw,fh =3D w,h
-		if (iMaxW) then w =3D math.min(iMaxW,w) end
-		if (iMaxH) then h =3D math.min(iMaxH,h) end
-		local offx,offy =3D (fw-w)*0.5,(fh-h)*0.5  -- this is 0,0 if the art is =
fully visible, centers art if not
-		u1,v1,u2,v2 =3D offx/tw,offy/th,(offx+w)/tw,(offy+h)/th
-		matname =3D (string.len(matname) &gt; 0) and matname or &quot;BaseWhiteNoLightin=
g&quot;
-
-		gRTTMaterialCache[TileTypeID..&quot;_&quot;..iHue] =3D matname
-	end
-	return {type=3D&quot;Img2&quot;, w=3Dw,h=3Dh, matname=3Dmatname, u1=3Du1,v1=3Dv1,u2=
=3Du2,v2=3Dv2}
-end
-
-function SaveUOModelImageToFile(rtt,texname)
-	if (rtt) then rtt:WriteContentsToFile(&quot;t&quot;..texname..&quot;.bmp&quot;) end
-end
-
--- this is normally in lugre - just a bit modified - should be removed som=
etimes
-function GetMeshPreviewX (meshname, res, angh, angv, pixelformat, r, g, b,=
 a) =

-	res =3D res or 16
-	angh =3D angh or 45*gfDeg2Rad
-	angv =3D angv or 30*gfDeg2Rad
-
---~ 	local x1,y1,z1,x2,y2,z2 =3D MeshReadOutExactBounds(meshname)
---~ 	local boundrad =3D math.max(Vector.len(x1,y1,z1),Vector.len(x2,y2,z2))
---~ 	MeshSetBounds(meshname,x1,y1,z1,x2,y2,z2)
---~ 	MeshSetBoundRad(meshname,boundrad)
-
-	local boundrad =3D MeshGetBoundRad(meshname)
-	=

-	local name_scenemanager		=3D GetUniqueName()
-	local name_texture			=3D GetUniqueName()
-	=

-	-- prepare rtt
-	CreateSceneManager(name_scenemanager)
-	local cam =3D CreateCamera(name_scenemanager)
-	local tex =3D CreateRenderTexture(name_texture,res,res,pixelformat or PF_=
A8R8G8B8)
-
-	if (not tex:IsAlive()) then return end
-	tex:SetAutoUpdated(false)
-
-	local vp =3D CreateRTTViewport(tex,cam)
-	vp:SetOverlaysEnabled(false)
-	vp:SetBackCol(r, g, b, a)
-
-	--local dist =3D GetRenderingDistanceForPixelSize(boundrad,res*0.25,vp,ca=
m)
-	local visrad_pixels =3D res*0.5
-	local vw,vh =3D res,res
-	local dist =3D 0.7 * math.max( boundrad/(visrad_pixels/vw), boundrad/(vis=
rad_pixels/vh) ) -- dirty hack, TODO : analyse projection matrix
-	=

-	Client_AddDirectionalLight(-0.3,-0.5,-0.1,name_scenemanager)
-
-	cam:SetAspectRatio(vp:GetActualWidth()/vp:GetActualHeight())
-	cam:SetNearClipDistance(1)
-	cam:SetFarClipDistance(dist*2 + boundrad)
-	=

-	local gfx =3D CreateRootGfx3D(name_scenemanager)
-	gfx:SetMesh(meshname)
-
-	gfx:SetPosition(0.5,-1,-dist);
-
-	local qw,qx,qy,qz =3D Quaternion.fromAngleAxis(angv,1,0,0)
-	gfx:SetOrientation(Quaternion.Mul(qw,qx,qy,qz,Quaternion.fromAngleAxis(an=
gh + 180*gfDeg2Rad,0,1,0)))
-	tex:Update()
-	cam:Destroy()
-	vp:Destroy()
-
-	-- TODO : DestroySceneManager(name_scenemanager)
-	return name_texture,tex
-end
------------------------------------------- the former parts are copied fro=
m lugre and modified, should be merged into lugre -------------------------=
------------------

Modified: trunk/data/lua/lib.fallback.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.fallback.lua (original)
+++ trunk/data/lua/lib.fallback.lua Tue Nov 13 21:01:30 2007
@@ -85,30 +85,6 @@
 	gLastFallBackToolDialog =3D guimaker.MakeTableDlg(rows,100,10,true,true,g=
GuiDefaultStyleSet,&quot;window&quot;)
 end
 =

--- iMaxW,iMaxH : can be nil for unlimited size
-function MakeUOArtImageForDialog (iTileTypeID, iHue, iMaxW, iMaxH) =

-	iHue =3D iHue or 0
-	local iTranslatedTileTypeID =3D SeasonalStaticTranslation(iTileTypeID, gS=
easonSetting)
-	-- we have to add 16384 for fallbacks
-	iTranslatedTileTypeID =3D iTranslatedTileTypeID + 16384
-
-	local matname =3D GetArtMat(iTranslatedTileTypeID,iHue)
-	local isotilew =3D 44 / math.sqrt(2)
-	local w,h =3D GetArtSize(iTranslatedTileTypeID)
-	if (not w or w =3D=3D 0) then w =3D isotilew end
-	if (not h or h =3D=3D 0) then h =3D isotilew end
-	local tw,th =3D texsize(w),texsize(h)
-	local fw,fh =3D w,h
-	if (iMaxW) then w =3D math.min(iMaxW,w) end
-	if (iMaxH) then h =3D math.min(iMaxH,h) end
-	local offx,offy =3D (fw-w)*0.5,(fh-h)*0.5  -- this is 0,0 if the art is f=
ully visible, centers art if not
-	local u1,v1,u2,v2 =3D offx/tw,offy/th,(offx+w)/tw,(offy+h)/th
-	matname =3D (string.len(matname) &gt; 0) and matname or &quot;BaseWhiteNoLighting&quot;
-	return {type=3D&quot;Img2&quot;,	w=3Dw,h=3Dh,matname=3Dmatname, u1=3Du1,v1=3Dv1,u2=
=3Du2,v2=3Dv2}
-end
-
-
-
 function ListFallBackTypesNearPos (x,y,z,radius)
 	local res =3D {}
 	local listall =3D false -- true:all,false:only where fallback is used

Modified: trunk/data/lua/lib.filepath.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.filepath.lua (original)
+++ trunk/data/lua/lib.filepath.lua Tue Nov 13 21:01:30 2007
@@ -1,14 +1,4 @@
 -- utils for working with filepaths
-
--- fixes problems with case sensitive file systems
---function CorrectPath (path)
---	return PathSearch(path) or path
---end
-function CorrectPath (path)  =

-	if (string.sub(path,2,1) =3D=3D &quot;:&quot;) then path =3D string.upper(path) end
-	path =3D string.gsub(path, &quot;\\&quot;, &quot;/&quot;)
-	return PathSearch(path) or path
-end
 =

 -- detect UOPath
 if (not gUOPath) then
@@ -26,3 +16,24 @@
 		gUOPath =3D &quot;../uo/&quot;
 	end
 end
+
+function CorrectPath (path)
+	if (string.sub(path,2,1) =3D=3D &quot;:&quot;) then path =3D string.upper(path) end
+	path =3D string.gsub(path, &quot;\\&quot;, &quot;/&quot;)
+	return PathSearch(path) or path
+end
+
+-- dann machs doch so, dass gUOPath nur dran gehaengt wird, wenn =

+function Addfilepath (filepath)
+	if file_exists(filepath) then
+print(filepath)
+		return filepath
+	else
+print(gUOPath..filepath)
+		return gUOPath..filepath
+	end
+end
+
+function CorrectGrannyPath (filename) =

+	return CorrectPath( Addfilepath(gGrannyPath..filename) )
+end

Modified: trunk/data/lua/lib.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.granny.lua (original)
+++ trunk/data/lua/lib.granny.lua Tue Nov 13 21:01:30 2007
@@ -13,7 +13,6 @@
 gGrannyTypeAnimListFiles =3D {[0]=3D&quot;Monster.lst&quot;,[1]=3D&quot;Sea.lst&quot;,[2]=3D&quot;A=
nimal.lst&quot;,[3]=3D&quot;Human.lst&quot;}
 gSkeletons =3D {}
 gAnimInfoLists =3D false
-
 =

 gGrannyModelsFemale1 =3D {401} -- filled during loading models.txt (all wh=
ere anim=3D401) : 606,184,186,745,751,774,765,770,773
 gGrannyModelsFemale2 =3D {} -- filled during loading models.txt (all where=
 modelname contains female) (a lot)
@@ -57,13 +56,11 @@
 =

 gGrannyScaleFactor =3D 0.65 --0.5
 =

-
-
 function CreateGrannyLoader(loadertype,base_file,localisation_file,bWarnOn=
MissingFile)
 	if (loadertype =3D=3D &quot;OnDemand&quot;) then
 		gAnimInfoLists =3D {}
 		for k,filename in pairs(gGrannyTypeAnimListFiles) do =

-			gAnimInfoLists[k] =3D LoadGrannyAnimInfo(CorrectGrannyPath(filename))
+			gAnimInfoLists[k] =3D LoadGrannyAnimInfo( CorrectPath(Addfilepath(gGran=
nyPath..filename)) )
 		end	=

 		--~ GetOrCreateSkeleton(400) -- precache h_male
 		--~ GetOrCreateSkeleton(401) -- precache h_female
@@ -73,8 +70,6 @@
 		return nil
 	end
 end
-
-
 =

 -- retrieves or creates a skeleton and fills it with bones from the first =
animation
 -- local skeleton =3D GetOrCreateSkeleton(bodyid)
@@ -148,7 +143,7 @@
 	if (not animname) then return nil end
 	--assert(animname,&quot;GetAnimPath failed, name not found : &quot;..tostring(bodyi=
d)..&quot;,&quot;..tostring(animid))
 	--print(&quot;anim&quot;,gGrannyTypeDirs[modelinfo.typeid] .. modelinfo.modelname .=
. &quot;_&quot; .. animname .. &quot;.grn&quot;)
-	return CorrectGrannyPath(gGrannyTypeDirs[modelinfo.typeid] .. modelinfo.m=
odelname .. &quot;_&quot; .. animname .. &quot;.grn&quot;)
+	return CorrectPath( Addfilepath(gGrannyPath..gGrannyTypeDirs[modelinfo.ty=
peid]..modelinfo.modelname..&quot;_&quot;..animname..&quot;.grn&quot;) )
 end
 =

 -- GetAnimName(400,23) looks in Human.lst for animid 23 and returns &quot;Horse=
_Walk_01&quot;
@@ -382,13 +377,8 @@
 	return grannymodelinfo
 end
 =

-
-function CorrectGrannyPath (filename) =

-	return CorrectPath(gUOPath..&quot;models/&quot;..filename)
-end
-
 function GetGrannyModelInfo (modelid) =

-	if (not gGrannyModelInfo) then gGrannyModelInfo =3D LoadGrannyModelInfo(C=
orrectGrannyPath(&quot;Models.txt&quot;)) end
+	if (not gGrannyModelInfo) then gGrannyModelInfo =3D LoadGrannyModelInfo( =
CorrectGrannyPath(gModelstxtFile) ) end
 	return gGrannyModelInfo[modelid]
 end
 =


Modified: trunk/data/lua/lib.gui.iris.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.gui.iris.lua (original)
+++ trunk/data/lua/lib.gui.iris.lua Tue Nov 13 21:01:30 2007
@@ -48,7 +48,7 @@
 	end
 end
 =

-function gui.StartLoading () =

+function gui.StartLoading() =

 	-- iris logo
 	gDialog_IrisLogo =3D guimaker.MyCreateDialog()
 	local widget =3D guimaker.MakePlane(gDialog_IrisLogo,&quot;irislogo&quot;,-128,-128=
,256,256)

Modified: trunk/data/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.keybinds.lua (original)
+++ trunk/data/lua/lib.keybinds.lua Tue Nov 13 21:01:30 2007
@@ -66,30 +66,30 @@
 	end end end)
 =

 	Bind(&quot;f7&quot;,		function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then
-		if (gAmbientColor.r &lt; 1.0) then
-			gAmbientColor.r=3DgAmbientColor.r+0.1
-			gAmbientColor.g=3DgAmbientColor.g+0.1
-			gAmbientColor.b=3DgAmbientColor.b+0.1
+		if (gAmbientLight.r &lt; 1.0) then
+			gAmbientLight.r=3DgAmbientLight.r+0.1
+			gAmbientLight.g=3DgAmbientLight.g+0.1
+			gAmbientLight.b=3DgAmbientLight.b+0.1
 		else
-			gAmbientColor.r=3D1.0
-			gAmbientColor.g=3D1.0
-			gAmbientColor.b=3D1.0
+			gAmbientLight.r=3D1.0
+			gAmbientLight.g=3D1.0
+			gAmbientLight.b=3D1.0
 		end
-		print(&quot;gAmbientColor.r=3D&quot;..gAmbientColor.r)
-		Client_SetAmbientLight(gAmbientColor.r, gAmbientColor.g, gAmbientColor.b=
, 1)
+		print(&quot;gAmbientLight.r=3D&quot;..gAmbientLight.r)
+		Client_SetAmbientLight(gAmbientLight.r, gAmbientLight.g, gAmbientLight.b=
, 1)
  	end end end)
 		Bind(&quot;f8&quot;,	function (state) if (not gActiveEditText) then if (state &gt; 0)=
 then
-		if (gAmbientColor.r &gt; 0.1) then
-			gAmbientColor.r=3DgAmbientColor.r-0.1
-			gAmbientColor.g=3DgAmbientColor.g-0.1
-			gAmbientColor.b=3DgAmbientColor.b-0.1
+		if (gAmbientLight.r &gt; 0.1) then
+			gAmbientLight.r=3DgAmbientLight.r-0.1
+			gAmbientLight.g=3DgAmbientLight.g-0.1
+			gAmbientLight.b=3DgAmbientLight.b-0.1
 		else
-			gAmbientColor.r=3D0.0
-			gAmbientColor.g=3D0.0
-			gAmbientColor.b=3D0.0
+			gAmbientLight.r=3D0.0
+			gAmbientLight.g=3D0.0
+			gAmbientLight.b=3D0.0
 		end
-		print(&quot;gAmbientColor.r=3D&quot;..gAmbientColor.r)
-		Client_SetAmbientLight(gAmbientColor.r, gAmbientColor.g, gAmbientColor.b=
, 1)
+		print(&quot;gAmbientLight.r=3D&quot;..gAmbientLight.r)
+		Client_SetAmbientLight(gAmbientLight.r, gAmbientLight.g, gAmbientLight.b=
, 1)
  	end end end)
 =

 	--[[

Modified: trunk/data/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.loading.lua (original)
+++ trunk/data/lua/lib.loading.lua Tue Nov 13 21:01:30 2007
@@ -1,5 +1,4 @@
 -- handles loading of data
-
 gLoadedMapID =3D -1
 =

 gPreOgreTime =3D 0
@@ -38,50 +37,20 @@
 	=

 	if (gHueLoaderType) then
 		LoadingProfile(&quot;init HueLoader&quot;)
-		gHueLoader =3D CreateHueLoader(gHueLoaderType,CorrectPath(gUOPath..&quot;hues=
.mul&quot;))
+		gHueLoader =3D CreateHueLoader(gHueLoaderType,CorrectPath( Addfilepath(g=
HuesFile) ) )
 	end
 		=

 	if (gArtMapLoaderType) then
 		LoadingProfile(&quot;init ArtMapLoader&quot;)
-		gArtMapLoader =3D CreateArtMapLoader(gArtMapLoaderType,CorrectPath(gUOPa=
th..&quot;artidx.mul&quot;),CorrectPath(gUOPath..&quot;art.mul&quot;))
-		=

-		if gUseNewModelLoader then
-			gManualArtMaterialLoader =3D CreateManualArtMaterialLoader(&quot;uo_art_%i&quot;,=
&quot;tex_base_alpha&quot;,gArtMapLoader,true,true,false)
-			--local count =3D gArtMapLoader:GetCount()
-			-- print(&quot;count&quot;,count)
-			--for i=3D16384,count-1 do
-			--	l:CreateResource(&quot;uo_art_&quot;..i)
-			--end
-			-- if l then l:Destroy() end
-			=

-			=

-			--[[ bad model detector and remover
-			local i =3D 0
-			local mintri =3D -1
-			-- for exporting models from models.uim
-			for i=3D0,20000 do
-				local meshname =3D GetStaticMeshName(i)
-				if meshname then
-					local tris =3D CountMeshTriangles(meshname)
-					=

-					if mintri =3D=3D -1 or tris &lt; mintri then mintri =3D tris end
-					=

-					if tris &lt;=3D 2 and HasModelOnlyOneUoArt(i) then
-						print(&quot;bad mesh found&quot;,i,tris,meshnam)
-						os.execute(&quot;svn rm &quot; .. GetModelPath(i))
-					else
-					end
-				end
-			end
-			print(&quot;mintri&quot;,mintri)
-			Crash()
-			]]--
-		end
+		gArtMapLoader =3D CreateArtMapLoader(gArtMapLoaderType,CorrectPath( Addf=
ilepath(gArtidxFile) ),CorrectPath( Addfilepath(gArtFile) ))
+
+		LoadingProfile(&quot;init ManualArtMaterialLoader&quot;)
+		gManualArtMaterialLoader =3D CreateManualArtMaterialLoader(&quot;uo_art_%i&quot;,&quot;=
tex_base_alpha&quot;,gArtMapLoader,true,true,false)
 	end
 		=

 	if (gGumpLoaderType) then
 		LoadingProfile(&quot;init GumpLoader&quot;)
-		gGumpLoader =3D CreateGumpLoader(gGumpLoaderType,CorrectPath(gUOPath..&quot;g=
umpidx.mul&quot;),CorrectPath(gUOPath..&quot;gumpart.mul&quot;))
+		gGumpLoader =3D CreateGumpLoader(gGumpLoaderType,CorrectPath( Addfilepat=
h(gGumpidxFile) ),CorrectPath( Addfilepath(gGumpFile) ))
 	end
 end
 =

@@ -104,43 +73,43 @@
 	--DebugCallLogStartIgnore()
 	LoadingProfile(&quot;init unifonts&quot;)
 	if (gUniFontLoaderType) then
-		CreateUniFont(CorrectPath(gUOPath..&quot;unifont.mul&quot;),&quot;font_unifont0&quot;)
+		CreateUniFont(CorrectPath( Addfilepath(gUnifontFile) ),&quot;font_unifont0&quot;)
 		for i=3D1,2 do
 			gUniFontName[i] =3D &quot;font_unifont&quot;..i
-			gUniFontHeight[i] =3D CreateUniFont(CorrectPath(gUOPath..&quot;unifont&quot;..i..=
&quot;.mul&quot;),gUniFontName[i])
+			gUniFontHeight[i] =3D CreateUniFont(CorrectPath( Addfilepath(gUnifonts.=
.i..&quot;.mul&quot;) ),gUniFontName[i])
 		end
 	end
 	=

 	if (gClilocLoaderType) then
 		LoadingProfile(&quot;init ClilocLoader&quot;)
 		local localisation_file =3D nil
-		if (gLanguage) then localisation_file =3D CorrectPath(gUOPath..&quot;Cliloc.&quot;=
..gLanguage) end
-		gClilocLoader =3D CreateClilocLoader(gClilocLoaderType,CorrectPath(gUOPa=
th..&quot;Cliloc.enu&quot;),localisation_file,true)
-		=

+		if (gLanguage) then localisation_file =3D CorrectPath( Addfilepath(gClil=
oc..gLanguage) ) end
+		gClilocLoader =3D CreateClilocLoader(gClilocLoaderType,CorrectPath( Addf=
ilepath(gClilocbaseFile) ),localisation_file,true)
+
 		-- intloc loaders, same format as cliloc, like intloc00.enu  intloc11.enu
 		for i =3D 0,20 do
-			local filenamebase =3D gUOPath..sprintf(&quot;intloc%02d.&quot;,i)
+			local filenamebase =3D sprintf(gIntlocFiles,i)
 			local localisation_file =3D nil
-			if (gLanguage) then localisation_file =3D CorrectPath(filenamebase..gLa=
nguage) end
-			gIntLocLoaders[i] =3D CreateClilocLoader(gClilocLoaderType,CorrectPath(=
filenamebase..&quot;enu&quot;),localisation_file)
+			if (gLanguage) then localisation_file =3D CorrectPath( Addfilepath(file=
namebase..gLanguage) ) end
+			gIntLocLoaders[i] =3D CreateClilocLoader(gClilocLoaderType,CorrectPath(=
 Addfilepath(filenamebase..&quot;enu&quot;) ),localisation_file)
 		end
 	end
 =

 	if (gStitchinLoaderType) then
 		LoadingProfile(&quot;init StitchinLoader&quot;)
-		gStitchinLoader =3D CreateStitchinLoader(gStitchinLoaderType,CorrectPath=
(gUOPath..&quot;stitchin.def&quot;))
+		gStitchinLoader =3D CreateStitchinLoader(gStitchinLoaderType,CorrectPath=
( Addfilepath(gStitchinFile) ))
 	end
 =

 	if (gSpeechLoaderType) then
 		LoadingProfile(&quot;init SpeechLoader&quot;)
 		if (gSpeechSupport) then
-			gSpeechLoader =3D CreateSpeechLoader(gSpeechLoaderType,CorrectPath(gUOP=
ath..&quot;speech.mul&quot;),true)
+			gSpeechLoader =3D CreateSpeechLoader(gSpeechLoaderType,CorrectPath( Add=
filepath(gSpeechFile) ),true)
 		end
 	end
 =

 	if (gTileTypeLoaderType) then
 		LoadingProfile(&quot;init TileTypeLoader&quot;)
-		gTileTypeLoader =3D CreateTileTypeLoader(gTileTypeLoaderType,CorrectPath=
(gUOPath..&quot;tiledata.mul&quot;))
+		gTileTypeLoader =3D CreateTileTypeLoader(gTileTypeLoaderType,CorrectPath=
( Addfilepath(gTiledataFile) ))
 		gTileTypeLoader._GetStaticTileType =3D gTileTypeLoader.GetStaticTileType
 		gTileTypeLoader.GetStaticTileType =3D function (...)
 			local arr =3D { gTileTypeLoader._GetStaticTileType(unpack(arg)) }
@@ -153,51 +122,39 @@
 	=

 	if (gTexMapLoaderType) then
 		LoadingProfile(&quot;init TexMapLoader&quot;)
-		gTexMapLoader =3D CreateTexMapLoader(gTexMapLoaderType,CorrectPath(gUOPa=
th..&quot;texidx.mul&quot;),CorrectPath(gUOPath..&quot;texmaps.mul&quot;))
+		gTexMapLoader =3D CreateTexMapLoader(gTexMapLoaderType,CorrectPath( Addf=
ilepath(gTexidxFile) ),CorrectPath( Addfilepath(gTexmapsFile) ))
 	end
 =

 	if (gMultiLoaderType) then
 		LoadingProfile(&quot;init MultiLoader&quot;)
-		gMultiLoader =3D CreateMultiLoader(gMultiLoaderType,CorrectPath(gUOPath.=
.&quot;multi.idx&quot;),CorrectPath(gUOPath..&quot;multi.mul&quot;))
+		gMultiLoader =3D CreateMultiLoader(gMultiLoaderType,CorrectPath( Addfile=
path(gMultiidxFile) ),CorrectPath( Addfilepath(gMultiFile) ))
 	end
 	=

 	if (gSoundLoaderType and gUseEffect) then
 		LoadingProfile(&quot;init SoundLoader&quot;)
-		gSoundLoader =3D CreateSoundLoader(gSoundLoaderType,CorrectPath(gUOPath.=
.&quot;soundidx.mul&quot;),CorrectPath(gUOPath..&quot;sound.mul&quot;))
+		gSoundLoader =3D CreateSoundLoader(gSoundLoaderType,CorrectPath( Addfile=
path(gSoundidxFile) ),CorrectPath( Addfilepath(gSoundFile) ))
 		SoundInit(gUseSoundSystem,22050)
 	end
 	=

 	if (gAnimLoaderType) then
 		LoadingProfile(&quot;init AnimLoader&quot;)
-		gAnimLoader =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(gUO=
Path..&quot;anim.idx&quot;),CorrectPath(gUOPath..&quot;anim.mul&quot;))		=

+		gAnimLoader =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath( Ad=
dfilepath(gAnimidxFile) ),CorrectPath( Addfilepath(gAnimFile) ))		=

 	end
 	=

 	if (gAnimDataLoaderType) then
 		LoadingProfile(&quot;init AnimDataLoader&quot;)
-		gAnimDataLoader =3D CreateAnimDataLoader(gAnimDataLoaderType,CorrectPath=
(gUOPath..&quot;animdata.mul&quot;))
+		gAnimDataLoader =3D CreateAnimDataLoader(gAnimDataLoaderType,CorrectPath=
( Addfilepath(gAnimdataFile) ))
 	end
 	=

 	if (gRadarColorLoaderType) then
 		LoadingProfile(&quot;init RadarColorLoader&quot;)
-		gRadarColorLoader =3D CreateRadarColorLoader(gRadarColorLoaderType,Corre=
ctPath(gUOPath..&quot;radarcol.mul&quot;))
-	end
-	=

-	if (gLegacyModelAndTextureLoaderType) then
-		LoadingProfile(&quot;init LegacyModelAndTextureLoader&quot;)
-		modelspath =3D datapath..&quot;models.uim&quot;
-		if (file_exists(modelspath)) then
-			gLegacyModelAndTextureLoader =3D CreateLegacyModelAndTextureLoader(gLeg=
acyModelAndTextureLoaderType,modelspath)
-			--MeshExporter()
-		else
-			--print(&quot;WARNING ! &quot;..modelspath..&quot; not found, please copy from old iri=
s1 binary distribution on berlios.de&quot;)
-			--print(&quot; statics, such as houses, trees, etc will not be displayed...&quot;)
-		end
-	end
-	=

+		gRadarColorLoader =3D CreateRadarColorLoader(gRadarColorLoaderType,Corre=
ctPath( Addfilepath(gRadarcolFile) ))
+	end
+
 	LoadingProfile(&quot;parsing Equipconv.def&quot;)
 	-- only parse the file if it exists
-	if file_exists(CorrectPath(gUOPath..&quot;Equipconv.def&quot;)) then
-		gDefFile_EquiqConv =3D ParseDefFile(CorrectPath(gUOPath..&quot;Equipconv.def&quot;=
))
+	if file_exists(CorrectPath( Addfilepath(gEquipconvFile) )) then
+		gDefFile_EquiqConv =3D ParseDefFile(CorrectPath( Addfilepath(gEquipconvF=
ile) ))
 	else
 		gDefFile_EquiqConv =3D nil
 	end
@@ -360,7 +317,7 @@
 	elseif (gGroundBlockLoader and gRadarColorLoaderType) then
 		if (not gInitialMapLoaded) then LoadingProfile(&quot;init RadarColorLoader&quot;) =
end
 		if (not gRadarColorLoader) then
-			gRadarColorLoader =3D CreateRadarColorLoader(gRadarColorLoaderType,Corr=
ectPath(gUOPath..&quot;radarcol.mul&quot;))
+			gRadarColorLoader =3D CreateRadarColorLoader(gRadarColorLoaderType,Corr=
ectPath( Addfilepath(gRadarcolFile) ))
 		end
 		=

 		if (not gInitialMapLoaded) then LoadingProfile(&quot;generating &quot;..gMapImageP=
ath_Small) end

Modified: trunk/data/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.protocol.lua (original)
+++ trunk/data/lua/lib.protocol.lua Tue Nov 13 21:01:30 2007
@@ -12,6 +12,7 @@
 &quot;0xDD&quot;, &quot;0xDE&quot;, &quot;0xDF&quot;}
 gNecroPacketData_Size 	=3D {&quot;0x0068&quot;,&quot;0x0005&quot;,&quot;0x0007&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;=
0x0005&quot;,&quot;0x0005&quot;,&quot;0x0007&quot;,&quot;0x000E&quot;,&quot;0x0005&quot;,&quot;0x000B&quot;,&quot;0x0007&quot;,     &quot;0&quot;,&quot;0x0=
003&quot;,     &quot;0&quot;,&quot;0x003D&quot;,&quot;0x00D7&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x000A&quot;,&quot;0x0006&quot;,&quot;0x0009=
&quot;,&quot;0x0001&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0025&quot;,     &quot;0&quot;,&quot;0x0005&quot;,&quot;=
0x0004&quot;,&quot;0x0008&quot;,&quot;0x0013&quot;,&quot;0x0008&quot;,&quot;0x0003&quot;,&quot;0x001A&quot;,&quot;0x0007&quot;,&quot;0x0014&quot;,&quot;0x0=
005&quot;,&quot;0x0002&quot;,&quot;0x0005&quot;,&quot;0x0001&quot;,&quot;0x0005&quot;,&quot;0x0002&quot;,&quot;0x0002&quot;,&quot;0x0011&quot;,&quot;0x000F=
&quot;,&quot;0x000A&quot;,&quot;0x0005&quot;,&quot;0x0001&quot;,&quot;0x0002&quot;,&quot;0x0002&quot;,&quot;0x000A&quot;,&quot;0x028D&quot;,     &quot;0&quot;,&quot;=
0x0008&quot;,&quot;0x0007&quot;,&quot;0x0009&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;0x0025&quot;,    =
 &quot;0&quot;,&quot;0x00C9&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0229&quot;,&quot;0x02C9&quot;,&quot;0x0005&quot;,     &quot;0&quot;,&quot;0x000B=
&quot;,&quot;0x0049&quot;,&quot;0x005D&quot;,&quot;0x0005&quot;,&quot;0x0009&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0006&quot;,&quot;0x0002&quot;, =
    &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;0x000C&quot;,&quot;0x0001&quot;,&quot;0x000B&quot;,&quot;0x006E&quot;,&quot;0x0=
06A&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0004&quot;,&quot;0x0002&quot;,&quot;0x0049&quot;,     &quot;0&quot;,&quot;0x0031&quot;,&quot;0x0005=
&quot;,&quot;0x0009&quot;,&quot;0x000F&quot;,&quot;0x000D&quot;,&quot;0x0001&quot;,&quot;0x0004&quot;,     &quot;0&quot;,&quot;0x0015&quot;,     &quot;0&quot;, =
    &quot;0&quot;,&quot;0x0003&quot;,&quot;0x0009&quot;,&quot;0x0013&quot;,&quot;0x0003&quot;,&quot;0x000E&quot;,     &quot;0&quot;,&quot;0x001C&quot;,    =
 &quot;0&quot;,&quot;0x0005&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x0023&quot;,&quot;0x0010&quot;,&quot;0x0011&quot;,     &quot;0&quot;,&quot;0x0009=
&quot;,     &quot;0&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x000D&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x003E&quot;,     &quot;0&quot;,&quot;=
0x0002&quot;,&quot;0x0027&quot;,&quot;0x0045&quot;,&quot;0x0002&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0042&quot;,     &quot;0&quot;,    =
 &quot;0&quot;,     &quot;0&quot;,&quot;0x000B&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0013&quot;,&quot;0x0041&quot;,     &quot;0=
&quot;,&quot;0x0063&quot;,     &quot;0&quot;,&quot;0x0009&quot;,     &quot;0&quot;,&quot;0x0002&quot;,     &quot;0&quot;,&quot;0x001A&quot;,     &quot;0&quot;,&quot;=
0x0102&quot;,&quot;0x0135&quot;,&quot;0x0033&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0003&quot;,&quot;0x0009&quot;,&quot;0x0009&quot;,&quot;0x0=
009&quot;,&quot;0x0095&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0004&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0005&quot;,     &quot;0=
&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x000D&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;, =
    &quot;0&quot;,&quot;0x0040&quot;,&quot;0x0009&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0003&quot;,&quot;0x0006&quot;,&quot;0x0009&quot;,&quot;0x0=
003&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0024&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0006=
&quot;,&quot;0x00CB&quot;,&quot;0x0001&quot;,&quot;0x0031&quot;,&quot;0x0002&quot;,&quot;0x0006&quot;,&quot;0x0006&quot;,&quot;0x0007&quot;,     &quot;0&quot;,&quot;=
0x0001&quot;,     &quot;0&quot;,&quot;0x004E&quot;,     &quot;0&quot;,&quot;0x0002&quot;,&quot;0x0019&quot;,     &quot;0&quot;,     &quot;0&quot;,    =
 &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x010C&quot;,     &quot;0&quot;,     &quot;0&quot;,&quot;0x0009&quot;,
 &quot;0&quot;, &quot;0&quot;, &quot;0&quot;}
+
 gNecroPacketSize =3D {}
 for i =3D 1,table.getn(gNecroPacketData_ID) do =

 	gNecroPacketSize[hex2num(gNecroPacketData_ID[i])] =3D hex2num(gNecroPacke=
tData_Size[i]) =

@@ -34,8 +35,6 @@
 	for k,v in pairs(gPacketType) do gPacketTypeId2Name[v.id] =3D k end
 	for k,v in pairs(gPacketType) do _G[k] =3D v.id end -- make names availab=
le as global constants, like kPacket_Account_Login_Request, needed for send=
ing
 	=

---OldIrisPacketLenTest()
-
 function DirWrap (iDir) -- wraps into [0,7]
 	while (iDir &lt; 0) do iDir =3D iDir + 8 end
 	while (iDir &gt; 7) do iDir =3D iDir - 8 end

Modified: trunk/data/lua/lib.sound.iris.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.sound.iris.lua (original)
+++ trunk/data/lua/lib.sound.iris.lua Tue Nov 13 21:01:30 2007
@@ -28,7 +28,7 @@
 function SoundPlayMusicById(musicid)
 	if (not gUseMusic) then return end
 	printdebug(&quot;sound&quot;,sprintf(&quot;SoundPlayMusicById(%s)\n&quot;,musicid))
-	local config =3D CorrectPath(gUOPath..&quot;Music/Digital/Config.txt&quot;)
+	local config =3D CorrectPath( Addfilepath(gMusicPath..gMusicConfigFile) )
 	local mp3 =3D nil
 	local loop =3D nil
 	local file =3D nil
@@ -57,10 +57,10 @@
 			if tonumber(id) =3D=3D musicid then
 				if (string.find(string.lower(name),&quot;.mp3&quot;) =3D=3D nil) then
 					-- add mp3 suffix
-					file =3D CorrectPath(gUOPath..&quot;Music/Digital/&quot;..name..&quot;.mp3&quot;)
+					file =3D CorrectPath( Addfilepath(gMusicPath..name..&quot;.mp3&quot;) )
 				else
 					-- mp3 suffix aready present
-					file =3D CorrectPath(gUOPath..&quot;Music/Digital/&quot;..name)
+					file =3D CorrectPath( Addfilepath(gMusicPath..name) )
 				end
 				=

 				printdebug(&quot;sound&quot;,sprintf(&quot;load sound id=3D%d name=3D%s loop=3D%d fil=
e=3D%s\n&quot;,id,name,loop,file))

Modified: trunk/data/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.static.lua (original)
+++ trunk/data/lua/lib.static.lua Tue Nov 13 21:01:30 2007
@@ -68,7 +68,7 @@
 gLegacyModelCache =3D {}
 function GetStaticMeshName (iTileTypeID,iHue)
 	-- hue default value is 0
-	iHue =3D iHue or 0
+	iHue =3D tonumber(iHue) or 0
 =

 	--1st: Seasonal Translation
 	local iTranslatedTileTypeID =3D SeasonalStaticTranslation(iTileTypeID, gS=
easonSetting)
@@ -82,74 +82,45 @@
 	local meshname =3D gLegacyModelCache[iTranslatedTileTypeID..&quot;_&quot;..iHue]
 =

 	if (meshname =3D=3D nil) then
-		-- try to load the new models
-		if gUseNewModelLoader then
+		if (not meshname) then
+			meshname =3D GetModelName(iTranslatedTileTypeID) -- &quot;mdl_&quot;..iTileTypeID=
..&quot;.mesh&quot;
+		end
 =

-			if (not meshname) then
-				meshname =3D GetModelName(iTranslatedTileTypeID) -- &quot;mdl_&quot;..iTileTypeI=
D..&quot;.mesh&quot;
+		-- mesh available?
+		printdebug(&quot;static&quot;,&quot;query model&quot;,meshname)
+
+		if not OgreMeshAvailable(meshname) then =

+			printdebug(&quot;static&quot;,&quot;mesh not available&quot;,meshname)
+			meshname =3D nil
+		else =

+			printdebug(&quot;static&quot;,&quot;Static Meshloader:&quot;,iTranslatedTileTypeID,iHue,mes=
hname)
+			=

+			if gManualArtMaterialLoader then
+				-- create unavailable uo_art_ID materials
+				local path =3D GetModelPath(iTranslatedTileTypeID)
+				printdebug(&quot;static&quot;,&quot;meshname&quot;,meshname,&quot;path&quot;,path)
+				local t =3D OgreMeshTextures(path) -- datapath..&quot;models/models/mesh/&quot;.=
.meshname)
+				for k,v in pairs(t) do =

+					printdebug(&quot;static&quot;,&quot;texture found&quot;,v)
+					gManualArtMaterialLoader:CreateMatchingIfUnavailable(v)
+				end
 			end
 =

-			-- mesh available?
-			printdebug(&quot;static&quot;,&quot;query model&quot;,meshname)
-			if not OgreMeshAvailable(meshname) then =

-				printdebug(&quot;static&quot;,&quot;mesh not available&quot;,meshname)
-				meshname =3D nil
-			else =

-				printdebug(&quot;static&quot;,&quot;Static Meshloader:&quot;,iTranslatedTileTypeID,iHue,me=
shname)
-				=

-				if gManualArtMaterialLoader then
-					-- create unavailable uo_art_ID materials
-					local path =3D GetModelPath(iTranslatedTileTypeID)
-					printdebug(&quot;static&quot;,&quot;meshname&quot;,meshname,&quot;path&quot;,path)
-					local t =3D OgreMeshTextures(path) -- datapath..&quot;models/models/mesh/&quot;=
..meshname)
-					for k,v in pairs(t) do =

-						printdebug(&quot;static&quot;,&quot;texture found&quot;,v)
-						gManualArtMaterialLoader:CreateMatchingIfUnavailable(v)
-					end
-				end
-				-- Hue this Model | TODO : Partitial Hue
-				if (gHueLoader) then
-					if( TestBit(GetStaticTileTypeFlags(iTileTypeID) or 0,kTileDataFlag_Pa=
rtial_Hue) ) then
-						printdebug(&quot;static&quot;,&quot;parthuedmodel=3D&quot;,iTileTypeID)		-- don't use iT=
ranslatedTileTypeID here, because of waterhack
-					elseif ((tonumber(iHue) &gt; 0) and (tonumber(iHue) &lt; gMaxHueValue)) then
-						if (CloneMesh) then meshname=3DCloneMesh(meshname) end
-						HueMesh(meshname,gHueLoader,iHue)
-					end
+			-- Hue this Model | TODO : Partitial Hue
+			if (gHueLoader) then
+				if( TestBit(GetStaticTileTypeFlags(iTileTypeID) or 0,kTileDataFlag_Par=
tial_Hue) ) then
+					printdebug(&quot;static&quot;,&quot;parthuedmodel=3D&quot;,iTileTypeID)		-- don't use iTr=
anslatedTileTypeID here, because of waterhack
+				elseif ( (iHue &gt; 0) and (iHue &lt; gMaxHueValue) ) then
+					if (CloneMesh) then meshname=3DCloneMesh(meshname) end
+					HueMesh(meshname,gHueLoader,iHue)
 				end
 			end
 		end
-		=

-		if ( gLegacyModelAndTextureLoader and (meshname =3D=3D nil) ) then
-			meshname =3D gLegacyModelAndTextureLoader:CreateMesh(iTranslatedTileTyp=
eID)
-			printdebug(&quot;static&quot;,&quot;used OLD model loader:&quot;,iTranslatedTileTypeID,iHue=
,meshname)
-		end
-
 		if (meshname =3D=3D &quot;&quot;) then meshname =3D nil end
 		gLegacyModelCache[iTranslatedTileTypeID..&quot;_&quot;..iHue] =3D meshname
 	end
 =

 	return meshname
-end
-
--- called by the c methods of LegacyModelAndTextureLoader, has to return a=
 material name, used for statics
-gLegacyModelMaterialCache =3D {}
-function LegacyModelLoader_GetMaterial (iModelID,iTextureID)
-	local matname =3D gLegacyModelMaterialCache[iTextureID]
-	if ((not matname)) then =

-		if (iTextureID &gt;=3D 0) then =

-			matname =3D gLegacyModelAndTextureLoader and gLegacyModelAndTextureLoad=
er:CreateMaterial(iTextureID)
-			-- matname =3D &quot;tex_&quot; .. iTextureID
-		else
-			matname =3D gArtMapLoader and gArtMapLoader:CreateMaterial(-iTextureID =
+ 16384,false,true,false,true,true,true)
-			-- matname =3D &quot;uo_art_&quot; .. (-iTextureID + 16384)
-			-- 16384 =3D 0x00004000, end of groundtile, start of static tiles
-			-- after id : pixel,invy,invx,alpha,light,depth
-		end
-		printdebug(&quot;static&quot;,&quot;matname&quot;,matname)
-		gLegacyModelMaterialCache[iTextureID] =3D matname
-	end
-	--return &quot;BaseWhiteNoLighting&quot;
-	return matname or &quot;BaseWhiteNoLighting&quot;
 end
 =

 function GetStaticMeshOrientation (iTileTypeID)
@@ -173,7 +144,7 @@
 				i =3D nil
 			else
 				printdebug(&quot;static&quot;,&quot;i&quot;,i,&quot;name&quot;,name)
-				GetStaticMeshName(i,0)	--TODO: hueing precached meshes
+				GetStaticMeshName(i,hue)	--TODO: hueing precached meshes
 				i =3D i + 1
 			end
 		until i =3D=3D nil

Modified: trunk/data/lua/lib.stitchin.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.stitchin.lua (original)
+++ trunk/data/lua/lib.stitchin.lua Tue Nov 13 21:01:30 2007
@@ -6,8 +6,6 @@
 -- todo : later : whenhuedreplacewith is not yet handled
 =

 gStitchinPartNames =3D {&quot;LOWER_ARMS_TOP&quot;,&quot;HEAD&quot;,&quot;FACE&quot;,&quot;UPPER_LEGS_TOP&quot;,&quot;H=
ANDS&quot;,&quot;TORSO&quot;,&quot;LOWER_LEGS_TOP&quot;,&quot;UPPER_ARMS_BOTTOM&quot;,&quot;FEET&quot;,&quot;EARS&quot;,&quot;LOWER_ARM=
S_BOTTOM&quot;,&quot;UPPER_LEGS_BOTTOM&quot;,&quot;LOWER_LEGS_BOTTOM&quot;,&quot;PELVIS&quot;,&quot;UPPER_ARMS_TOP&quot;=
,&quot;NECK&quot;}
-
--- gStitchinInfo =3D LoadStitchinInfo(CorrectPath(gUOPath..&quot;stitchin.def&quot;))
 =

 function CreateStitchinLoader (loadertype,filepath) =

 	assert(loadertype =3D=3D &quot;FullFile&quot;,&quot;CreateStitchinLoader : only FullFile=
 loader supported&quot;)

Modified: trunk/data/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.test.lua (original)
+++ trunk/data/lua/lib.test.lua Tue Nov 13 21:01:30 2007
@@ -46,7 +46,7 @@
 end
 =

 function TestSound()
-	gSoundLoader =3D CreateSoundLoader(gSoundLoaderType,CorrectPath(gUOPath..=
&quot;soundidx.mul&quot;),CorrectPath(gUOPath..&quot;sound.mul&quot;))
+	gSoundLoader =3D CreateSoundLoader(gSoundLoaderType,CorrectPath( Addfilep=
ath(gSoundidxFile) ),CorrectPath( Addfilepath(gSoundFile) ))
 	SoundInit(&quot;fmod&quot;,22050)
 =

 	gSoundSystem:SetDistanceFactor(0.1)
@@ -62,32 +62,12 @@
 	end
 	=

 	SoundDone()
-	Crash()
-end
-
-function TestLegacyModelAndTextureLoader ()
-	gLegacyModelAndTextureLoaderType =3D &quot;FullFile&quot;
-	if (gLegacyModelAndTextureLoaderType) then
-		LoadingProfile(&quot;init LegacyModelAndTextureLoader&quot;)
-		modelspath =3D datapath..&quot;models.uim&quot;
-		if (file_exists(modelspath)) then
-			gLegacyModelAndTextureLoader =3D CreateLegacyModelAndTextureLoader(gLeg=
acyModelAndTextureLoaderType,modelspath)
-		else
-			print(&quot;WARNING ! &quot;..modelspath..&quot; not found, please copy from old iris1=
 binary distribution on berlios.de&quot;)
-			print(&quot; statics, such as houses, trees, etc will not be displayed...&quot;)
-		end
-	end
-	print(&quot;TestLegacyModelAndTextureLoader : init ok&quot;)
-	local a =3D gLegacyModelAndTextureLoader:CreateMaterial(491)
-	--local a =3D gLegacyModelAndTextureLoader:CreateMaterial(200)
-	print(&quot;TestLegacyModelAndTextureLoader : all ok&quot;,a)
 	Crash()
 end
 =

 function AnalyseStatics ()
 	-- count how often every type of static occurs on the map
 	gMapInfo =3D Check_Map(gMapIndex,&quot;xml/Maps.xml&quot;)
---	gMapInfo =3D xmlchild(xmlchild(LuaXML_ParseFile(datapath..&quot;xml/Maps.xml=
&quot;),&quot;MAPS&quot;),&quot;MAP&quot;,gMapIndex)
 	print(&quot;gMapInfo&quot;,gMapInfo)
 	local mapfilename=3D	 xmlchild(gMapInfo,&quot;MAPFILENAME&quot;)[1]
 	local mapheight=3D	 xmlchild(gMapInfo,&quot;HEIGHT&quot;)[1]
@@ -97,30 +77,13 @@
 	=

 	if (gTileTypeLoaderType) then
 		LoadingProfile(&quot;init TileTypeLoader&quot;)
-		gTileTypeLoader =3D CreateTileTypeLoader(gTileTypeLoaderType,CorrectPath=
(gUOPath..&quot;tiledata.mul&quot;))
+		gTileTypeLoader =3D CreateTileTypeLoader(gTileTypeLoaderType,CorrectPath=
( Addfilepath(gTiledataFile) ))
 	end
 	if (gStaticBlockLoaderType) then
 		LoadingProfile(&quot;init StaticBlockLoader&quot;)
-		gStaticBlockLoader =3D CreateStaticBlockLoader(gStaticBlockLoaderType,ma=
pheight,CorrectPath(gUOPath..staidxfilename),CorrectPath(gUOPath..staticfil=
ename))
-	end
-	=

-	if (true) then
-		if (gArtMapLoaderType) then
-			LoadingProfile(&quot;init ArtMapLoader&quot;)
-			gArtMapLoader =3D CreateArtMapLoader(gArtMapLoaderType,CorrectPath(gUOP=
ath..&quot;artidx.mul&quot;),CorrectPath(gUOPath..&quot;art.mul&quot;))
-		end
-		if (gLegacyModelAndTextureLoaderType) then
-			LoadingProfile(&quot;init LegacyModelAndTextureLoader&quot;)
-			modelspath =3D datapath..&quot;models.uim&quot;
-			if (file_exists(modelspath)) then
-				gLegacyModelAndTextureLoader =3D CreateLegacyModelAndTextureLoader(gLe=
gacyModelAndTextureLoaderType,modelspath)
-			else
-				print(&quot;WARNING ! &quot;..modelspath..&quot; not found, please copy from old iris=
1 binary distribution on berlios.de&quot;)
-				print(&quot; statics, such as houses, trees, etc will not be displayed...&quot;)
-			end
-		end
-	end
-	=

+		gStaticBlockLoader =3D CreateStaticBlockLoader(gStaticBlockLoaderType,ma=
pheight,CorrectPath( Addfilepath(staidxfilename) ),CorrectPath( Addfilepath=
(staticfilename) ))
+	end
+
 	local w,h =3D gStaticBlockLoader:GetMapW(),gStaticBlockLoader:GetMapH()
 	print(&quot;static map size&quot;,w,h)
 	local staticCounter =3D {}
@@ -129,30 +92,40 @@
 	local x,y,i
 	local iTileTypeID,iX,iY,iZ,iHue
 	local entity,meshname
-	for y =3D 0,h-1 do
+
+	for y =3D 0,w-1 do
 		if (math.mod(y,16) =3D=3D 0) then print(&quot;#&quot;,y..&quot;/&quot;..h) end
-		for x =3D 0,w-1 do
-			--if (total_static_count &gt; 100) then break end
+		for x =3D 0,h-1 do
 			gStaticBlockLoader:Load(x,y)
 			local iStaticCount =3D gStaticBlockLoader:Count() -- operates on the bl=
ock that was last loaded using :Load()
 			for i =3D 0,iStaticCount-1 do
 				iTileTypeID,iX,iY,iZ,iHue =3D gStaticBlockLoader:GetStatic(i) -- opera=
tes on the block that was last loaded using :Load()
 				total_static_count =3D total_static_count + 1
 				staticCounter[iTileTypeID] =3D (staticCounter[iTileTypeID] or 0) + 1
-			end =

-	end end
-	=

+			end
+		end
+	end
+	print(&quot;#&quot;,w..&quot;/&quot;..h)
+
 	local staticAnalysis =3D {}
 	for k,v in pairs(staticCounter) do =

 		table.insert(staticAnalysis,{ typeid=3Dk, amount=3Dv, typeobj=3DGetStati=
cTileType(k) })
 	end
 	table.sort(staticAnalysis,function (a,b) return a.amount &gt; b.amount end)
+
+	local polycount =3D 0
 	for k,obj in pairs(staticAnalysis) do
-		local polycount =3D gLegacyModelAndTextureLoader:GetMeshPolyCount(obj.ty=
peid)
+		-- obsolete, because Legacy Loader has been removed
+		--polycount =3D gLegacyModelAndTextureLoader:GetMeshPolyCount(obj.typeid)
+
+--		print(&quot;obj.typeid: &quot;..obj.typeid)
+--		local meshname =3D GetStaticMeshName(obj.typeid,0)
+--		if (meshname and meshname ~=3D &quot;&quot;) then polycount =3D CountMeshTriangl=
es(meshname) end
 		if (polycount &lt; 1) then =

 			print(obj.amount,sprintf(&quot;0x%04x&quot;,obj.typeid),obj.typeid,obj.typeobj.ms=
Name,polycount)
 		end
 	end
+
 	print(&quot;total statics &quot;,total_static_count)
 	Crash()
 end
@@ -320,14 +293,14 @@
 ]]--
 =

 function TestDefFileParser ()
-	local t =3D ParseDefFile(CorrectPath(gUOPath..&quot;Equipconv.def&quot;))
+	local t =3D ParseDefFile(CorrectPath( Addfilepath(gEquipconvFile) ))
 	local a,b,c,d,e =3D GetListFromDefTable(t,605,997)
 	print(a,b,c,d,e)
 	Crash()
 end
 =

 function TestMultiLoader()
-	l =3D CreateMultiLoader(&quot;FullFile&quot;,CorrectPath(gUOPath..&quot;multi.idx&quot;),Corr=
ectPath(gUOPath..&quot;multi.mul&quot;))
+	l =3D CreateMultiLoader(&quot;FullFile&quot;,CorrectPath( Addfilepath(gMultiidxFile=
) ),CorrectPath( Addfilepath(gMultiFile) ))
 	print(l)
 	for id =3D 0, 10 do
 		local parts =3D l:CountMultiParts(id)
@@ -343,12 +316,10 @@
 =

 function TestUniFontLoader()
 	print(CreateUniFontLoader)
-	l =3D CreateUniFontLoader(CorrectPath(gUOPath..&quot;unifont2.mul&quot;))
+	l =3D CreateUniFontLoader(CorrectPath( Addfilepath(gUnifonts..&quot;2.mul&quot;) ))
 =

 	l:CreateOgreFont(&quot;font_unifont2&quot;)
-	=

+
 	l:Destroy()
 	Crash()
 end
-
-

Modified: trunk/data/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/main.lua (original)
+++ trunk/data/lua/main.lua Tue Nov 13 21:01:30 2007
@@ -58,7 +58,6 @@
 dofile(libpath .. &quot;lib.static.lua&quot;)
 dofile(libpath .. &quot;lib.compass.lua&quot;)
 dofile(libpath .. &quot;lib.gfm.lua&quot;)
-dofile(libpath .. &quot;lib.oldiristest.lua&quot;)
 dofile(libpath .. &quot;lib.protocol.lua&quot;)
 dofile(libpath .. &quot;lib.mousepick.lua&quot;)
 dofile(libpath .. &quot;lib.gumpparser.lua&quot;)
@@ -87,21 +86,17 @@
 dofile(libpath .. &quot;lib.mount.lua&quot;)
 dofile(libpath .. &quot;lib.debug.lua&quot;)
 dofile(libpath .. &quot;lib.uodragdrop.lua&quot;)  --(new dragdrop system not yet us=
ed in trunk, see for old)
+dofile(libpath .. &quot;lib.corpse.lua&quot;)
+dofile(libpath .. &quot;lib.tilefreewalk.lua&quot;)
+dofile(libpath .. &quot;lib.oldwalk.lua&quot;)
+dofile(libpath .. &quot;lib.bugreport.lua&quot;)
+
 dofile(libpath .. &quot;gui/gui.main.lua&quot;)
 dofile(libpath .. &quot;obj/obj.main.lua&quot;)
 dofile(libpath .. &quot;net/net.main.lua&quot;)
-dofile(libpath .. &quot;lib.corpse.lua&quot;)
-dofile(libpath .. &quot;lib.tilefreewalk.lua&quot;)
-
-dofile(libpath .. &quot;filter.art.lua&quot;)
-dofile(libpath .. &quot;filter.granny.lua&quot;)
-dofile(libpath .. &quot;filter.map.lua&quot;)
-dofile(libpath .. &quot;lib.oldwalk.lua&quot;)
-
---can be removed from release
-dofile(libpath .. &quot;lib.meshexporter.lua&quot;)
-dofile(libpath .. &quot;lib.bugreport.lua&quot;)
-
+dofile(libpath .. &quot;filter/filter.art.lua&quot;)
+dofile(libpath .. &quot;filter/filter.granny.lua&quot;)
+dofile(libpath .. &quot;filter/filter.map.lua&quot;)
 =

 --###############################
 --###        CONFIG           ###
@@ -135,15 +130,14 @@
 =

 -- checks if iris has found the uo directory and displays an error box if =
not
 function CheckUODir ()
-	=

-	if (not file_exists(CorrectPath(gUOPath..&quot;art.mul&quot;))) then
+	if (not file_exists(CorrectPath( Addfilepath(gArtFile) ))) then
 		gUOPath =3D gUOPath .. &quot;/&quot;  -- append slash and try again
-		if (not file_exists(CorrectPath(gUOPath..&quot;art.mul&quot;))) then
+		if (not file_exists(CorrectPath( Addfilepath(gArtFile) ))) then
 			FatalErrorMessage(sprintf(&quot;iris2 could not find your ultima-online dire=
ctory (searchpath : %s),\n please set gUOPath in data/config.lua&quot;,gUOPath))
 		end
 	end
 	-- check for character(granny) models
-	if (not file_exists(CorrectPath(gUOPath..&quot;models/models.txt&quot;))) then
+	if (not file_exists( CorrectGrannyPath(gModelstxtFile) )) then
 		FatalErrorMessage(sprintf(&quot;iris2 could not find character models in your=
 uo dir\n please install AOS or ML (see README)&quot;))
 	end
 end
@@ -173,7 +167,6 @@
 	-- if (gHuffmanCompression) then LuaHuffmanTest() end
 	-- if (false) then MyGrannyTest_PreOgre() end	-- TODO : just a test, see =
lib.granny.lua
 	-- if (false) then LuaBitwiseTest() end
-	-- if (false) then TestLegacyModelAndTextureLoader() end
 	-- if (false) then AnalyseStatics() end
 	-- if (false) then ExpressionTest() end
 	-- if (false) then TestSound() end
@@ -227,9 +220,6 @@
 =

 	if (gStartInDebugMode) then StopMainMenu() StartDebugMenu() end
 =

-	--TestGuiSystem2_Init()
-	--TestGuiSystem3_Init()
-	=

 	-- mainloop
 	while (Client_IsAlive()) do MainStep() end
 end

Modified: trunk/data/lua/net/net.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.main.lua (original)
+++ trunk/data/lua/net/net.main.lua Tue Nov 13 21:01:30 2007
@@ -4,21 +4,20 @@
 dofile(libpath .. &quot;net/net.effect.lua&quot;)
 dofile(libpath .. &quot;net/net.multi.lua&quot;)
 dofile(libpath .. &quot;net/net.uodragdrop.lua&quot;)
+dofile(libpath .. &quot;net/net.corpse.lua&quot;)
+dofile(libpath .. &quot;net/net.world.lua&quot;)
+dofile(libpath .. &quot;net/net.sound.lua&quot;)
+dofile(libpath .. &quot;net/net.login.lua&quot;)
+dofile(libpath .. &quot;net/net.skill.lua&quot;)
 =

 -- only things that have at least 2 packets get its own file, everything e=
lse is handled here:
 dofile(libpath .. &quot;net/net.packethandlers.lua&quot;)
 =

 dofile(libpath .. &quot;net.cursor.lua&quot;)
-dofile(libpath .. &quot;net.login.lua&quot;)
 dofile(libpath .. &quot;net.other.lua&quot;)
 dofile(libpath .. &quot;net.popup.lua&quot;)
-dofile(libpath .. &quot;net.skill.lua&quot;)
-dofile(libpath .. &quot;net.sound.lua&quot;)
 dofile(libpath .. &quot;net.trade.lua&quot;)
 dofile(libpath .. &quot;net.securetrade.lua&quot;)
 dofile(libpath .. &quot;net.walk.lua&quot;)
-dofile(libpath .. &quot;net.world.lua&quot;)
-dofile(libpath .. &quot;net.corpse.lua&quot;)
 =

 gLastDoubleClickSerial =3D 0
-

Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Tue Nov 13 21:01:30 2007
@@ -1,6 +1,5 @@
 -- functions concerning mobiles (movable entities, npcs, monsters and the =
player)
--- see also net.paperdoll.lua
--- see also net.skill.lua
+-- see also net/net.skill.lua
 =

 --[[
 the following fields are available : =



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000316.html">[Iris-commit] [IRIS] r1501 - /trunk/data/lua/main.lua
</A></li>
	<LI>Next message: <A HREF="000318.html">[Iris-commit] [IRIS] r1503 - in /trunk/data: base/main.material	config.lua.dist
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#317">[ date ]</a>
              <a href="thread.html#317">[ thread ]</a>
              <a href="subject.html#317">[ subject ]</a>
              <a href="author.html#317">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
