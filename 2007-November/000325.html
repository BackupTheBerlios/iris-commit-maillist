<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1510 - in /trunk/data/lua: filter/filter.granny.lua gui/gui.paperdoll.lua lib.3d.map.lua lib.gui.iris.lua lib.loading.lua lib.static.lua lib.uodragdrop.lua main.lua net.popup.lua obj/obj.mobile.lua obj/obj.player.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1510%20-%20in%20/trunk/data/lua%3A%0A%20filter/filter.granny.lua%20gui/gui.paperdoll.lua%20lib.3d.map.lua%0A%20lib.gui.iris.lua%20lib.loading.lua%20lib.static.lua%20lib.uodragdrop.lua%20main.lua%0A%20net.popup.lua%20obj/obj.mobile.lua%20obj/obj.player.lua&In-Reply-To=%3C20071117154855.20E9E1C182C1%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000324.html">
   <LINK REL="Next"  HREF="000326.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1510 - in /trunk/data/lua: filter/filter.granny.lua gui/gui.paperdoll.lua lib.3d.map.lua lib.gui.iris.lua lib.loading.lua lib.static.lua lib.uodragdrop.lua main.lua net.popup.lua obj/obj.mobile.lua obj/obj.player.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1510%20-%20in%20/trunk/data/lua%3A%0A%20filter/filter.granny.lua%20gui/gui.paperdoll.lua%20lib.3d.map.lua%0A%20lib.gui.iris.lua%20lib.loading.lua%20lib.static.lua%20lib.uodragdrop.lua%20main.lua%0A%20net.popup.lua%20obj/obj.mobile.lua%20obj/obj.player.lua&In-Reply-To=%3C20071117154855.20E9E1C182C1%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1510 - in /trunk/data/lua: filter/filter.granny.lua gui/gui.paperdoll.lua lib.3d.map.lua lib.gui.iris.lua lib.loading.lua lib.static.lua lib.uodragdrop.lua main.lua net.popup.lua obj/obj.mobile.lua obj/obj.player.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Sat Nov 17 16:48:54 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000324.html">[Iris-commit] [IRIS] r1509 - in /trunk/data/lua: lib.3d.dynamic.lua lib.static.lua net.other.lua net/net.dynamic.lua
</A></li>
        <LI>Next message: <A HREF="000326.html">[Iris-commit] [IRIS] r1511 - in /trunk/data/lua: gui/gui.gumpmanager.lua lib.bodygfx.lua lib.deffileparser.lua lib.speech.lua lib.tilefreewalk.lua main.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#325">[ date ]</a>
              <a href="thread.html#325">[ thread ]</a>
              <a href="subject.html#325">[ subject ]</a>
              <a href="author.html#325">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: sience
Date: Sat Nov 17 16:48:54 2007
New Revision: 1510

Log:
-several cleanups and bugfixes

Modified:
    trunk/data/lua/filter/filter.granny.lua
    trunk/data/lua/gui/gui.paperdoll.lua
    trunk/data/lua/lib.3d.map.lua
    trunk/data/lua/lib.gui.iris.lua
    trunk/data/lua/lib.loading.lua
    trunk/data/lua/lib.static.lua
    trunk/data/lua/lib.uodragdrop.lua
    trunk/data/lua/main.lua
    trunk/data/lua/net.popup.lua
    trunk/data/lua/obj/obj.mobile.lua
    trunk/data/lua/obj/obj.player.lua

Modified: trunk/data/lua/filter/filter.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/filter/filter.granny.lua (original)
+++ trunk/data/lua/filter/filter.granny.lua Sat Nov 17 16:48:54 2007
@@ -4,7 +4,7 @@
 -- FILTER: Grannys
 function GrannyOverride(mobileartid)
 	if (gGrannyFilter[mobileartid]) then
-		printdebug(&quot;granny&quot;,&quot;Mapping: ArtID to GrannyID &quot;,mobileartid,&quot; -&gt; &quot;,gGr=
annyFilter[mobileartid].grannyid)
+		--printdebug(&quot;granny&quot;,&quot;Mapping: ArtID to GrannyID &quot;,mobileartid,&quot; -&gt; &quot;,g=
GrannyFilter[mobileartid].grannyid)
 		return gGrannyFilter[mobileartid].grannyid
 	end
 	return mobileartid

Modified: trunk/data/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.paperdoll.lua (original)
+++ trunk/data/lua/gui/gui.paperdoll.lua Sat Nov 17 16:48:54 2007
@@ -62,6 +62,8 @@
 -- rebuild needed on update to have correct layerorder
 -- paperdoll.bIsPlayer (check if is player or npc)
 function RebuildPaperdoll (paperdoll)
+	if (not gGumpLoader) then return end
+
 	local mobile =3D GetMobile(paperdoll.mobileserial)
 	paperdoll.mobile =3D mobile
 	paperdoll.bIsPlayer =3D IsPlayerMobile(mobile)

Modified: trunk/data/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.map.lua (original)
+++ trunk/data/lua/lib.3d.map.lua Sat Nov 17 16:48:54 2007
@@ -282,7 +282,7 @@
 -- TODO: blend out mounts
 function Renderer3D:BlendOutLayersAbovePlayer ()
 	local x,y,z =3D GetPlayerPos()
-	if (not z or not gStaticBlockLoader) then return end
+	if (not z or not gStaticBlockLoader or not gGroundBlockLoader) then retur=
n end
 =

 	local playerheadpos =3D z + self.giBlendOutPlayerHeight
 =


Modified: trunk/data/lua/lib.gui.iris.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.gui.iris.lua (original)
+++ trunk/data/lua/lib.gui.iris.lua Sat Nov 17 16:48:54 2007
@@ -4,8 +4,8 @@
 -- list of all open stats dialogs serial-&gt;dialog
 gStatusDialogs =3D {}
 =

--- creates all this fancy gui stuff
-function GuiInit ()
+-- create player status dialog and stuff like this
+function PlayerGuiInit ()
 	-- create player status
 	if GetPlayerMobile() then
 		printdebug(&quot;gump&quot;,&quot;########## UpdatePlayerBodySerial (serial) was called=
 -&gt; Open Status&quot;)

Modified: trunk/data/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.loading.lua (original)
+++ trunk/data/lua/lib.loading.lua Sat Nov 17 16:48:54 2007
@@ -276,10 +276,9 @@
 	end
 =

 	gMapImagePath_Small	=3D datapath..&quot;base/tempmap_&quot;..index..&quot;_small_s.tga&quot;
-
 	local mapfile_exists =3D file_exists(gMapImagePath_Small)
 	if (mapfile_exists) then
-		print(gMapImagePath_Small .. &quot; exists&quot;)
+		print(gMapImagePath_Small..&quot; exists&quot;)
 	elseif (gGroundBlockLoader and gStaticBlockLoader and gRadarColorLoaderTy=
pe) then
 		if (not gInitialMapLoaded) then LoadingProfile(&quot;init RadarColorLoader&quot;) =
end
 		if (not gRadarColorLoader) then

Modified: trunk/data/lua/lib.static.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.static.lua (original)
+++ trunk/data/lua/lib.static.lua Sat Nov 17 16:48:54 2007
@@ -83,7 +83,7 @@
 =

 	if (meshname =3D=3D nil) then
 		if (not meshname) then
-			meshname =3D GetModelName(iTranslatedTileTypeID) -- &quot;mdl_&quot;..iTileTypeID=
..&quot;.mesh&quot;
+			meshname =3D GetModelName(iTranslatedTileTypeID) -- &quot;mdl_&quot;..iTranslated=
TileTypeID..&quot;.mesh&quot;
 		end
 =

 		-- mesh available?
@@ -138,15 +138,16 @@
 		local i =3D 0
 		=

 		repeat
-			local flags,weight,quality,unkn1,unkn2,quantity,animid,unkn3,hue,unkn4,=
height,name =3D gTileTypeLoader:GetStaticTileType(i+32*512)
-			if flags =3D=3D nil then =

-				printdebug(&quot;static&quot;,&quot;i&quot;,i,&quot;not found&quot;)
+			local arrtiletype =3D {}
+			arrtiletype =3D GetStaticTileType(i)
+			if (arrtiletype) then
+				printdebug(&quot;static&quot;,&quot;i&quot;,i,&quot;name&quot;,arrtiletype.msName)
+				GetStaticMeshName(i,arrtiletype.miHue)
+				i =3D i + 1
+			else
+				printdebug(&quot;static&quot;,&quot;i&quot;,i,&quot;not found in Tiledata&quot;)
 				i =3D nil
-			else
-				printdebug(&quot;static&quot;,&quot;i&quot;,i,&quot;name&quot;,name)
-				GetStaticMeshName(i,hue)	--TODO: hueing precached meshes
-				i =3D i + 1
 			end
-		until i =3D=3D nil
+		until (i =3D=3D nil)
 	end
 end

Modified: trunk/data/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.uodragdrop.lua (original)
+++ trunk/data/lua/lib.uodragdrop.lua Sat Nov 17 16:48:54 2007
@@ -345,11 +345,11 @@
 		=

 		-- stack this item with the same beneath?
 		if gMousePickFoundHit and gMousePickFoundHit.hittype =3D=3D kMousePickHi=
tType_ContainerItem then
+			local arrtiletype =3D {}
 			-- read out item infos
-			local flags,weight,quality,unkn1,unkn2,quantity,animid,unkn3,hue,unkn4,=
height,name =3D gTileTypeLoader:GetStaticTileType(item.artid+32*512)
-
+			arrtiletype =3D GetStaticTileType(item.artid)
 			-- if the item beneath has the same artid and stackable, try to stack t=
hem
-			if (TestBit(flags, kTileDataFlag_Generic_Stackable)) and gMousePickFoun=
dHit.item.artid =3D=3D item.artid then =

+			if (TestBit(arrtiletype.miFlags or 0,kTileDataFlag_Generic_Stackable)) =
and gMousePickFoundHit.item.artid =3D=3D item.artid then
 				target =3D gMousePickFoundHit.item.serial =

 			end
 		end

Modified: trunk/data/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/main.lua (original)
+++ trunk/data/lua/main.lua Sat Nov 17 16:48:54 2007
@@ -240,11 +240,15 @@
 =

 	print(&quot;Welcome to Iris&quot;)
 =

+	-- create player status dialog and stuff like this
+	PlayerGuiInit()
+
 	-- stop menu music
 	SoundStopMusic()
 	=

 	-- start playing ingame music
 	SoundPlayMusicById(57)
+	=

 =

 	gInGameStarted =3D true
 	=


Modified: trunk/data/lua/net.popup.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.popup.lua (original)
+++ trunk/data/lua/net.popup.lua Sat Nov 17 16:48:54 2007
@@ -72,6 +72,8 @@
 =

 -- TODO : check if popupmenu is already opened for this mobile ! (otherwis=
e it would be opened twice)
 function DisplayPopupMenu (popupmenu)
+	if (not gGumpLoader) then return end
+
 	--- no request running anymore
 	gPopupRequestRunning =3D false
 	-- update global entry

Modified: trunk/data/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.mobile.lua (original)
+++ trunk/data/lua/obj/obj.mobile.lua Sat Nov 17 16:48:54 2007
@@ -142,6 +142,7 @@
 	end
 	=

 	local bIsPlayer =3D self.serial =3D=3D gPlayerBodySerial
+
 	-- if something related to equipment might have changed =

 	-- this can also have happened if equipmentdata=3Dnil, e.g. when an equip=
ment item was destroyed directly
 	-- maybe only in UpdateContent and/or if equipmentdata is set ?

Modified: trunk/data/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/obj/obj.player.lua (original)
+++ trunk/data/lua/obj/obj.player.lua Sat Nov 17 16:48:54 2007
@@ -17,7 +17,7 @@
 	-- warning ! don't trigger network send here
 	local backpack =3D GetPlayerBackPackItem()
 	if (backpack) then
-		printdebug(&quot;player&quot;,&quot;BACKPACK UPDATE&quot;)
+		printdebug(&quot;player&quot;,&quot;PlayerBackpackItemUpdated: BACKPACK UPDATE&quot;)
 		if ((not gPlayerBackPack) or (gPlayerBackPack.serial ~=3D backpack.seria=
l)) then
 			-- backpack item changed
 			gPlayerBackPack =3D backpack
@@ -85,17 +85,17 @@
 =

 =

 -- called from handlers of kPacket_Login_Confirm and kPacket_Teleport
-function UpdatePlayerBodySerial (serial) =

-	if (gPlayerBodySerial ~=3D 0 and gPlayerBodySerial ~=3D serial) then =

+function UpdatePlayerBodySerial (serial)
+	if (gPlayerBodySerial ~=3D serial) then =

 		print(&quot;WARNING ! playerbody serial changed old,new=3D&quot;,gPlayerBodySerial=
,serial)
+
+		-- update player serial and player backpack
+		gPlayerBodySerial =3D serial
+		PlayerBackpackItemUpdated()
+
+		-- reinit player status dialog and stuff like this
+		PlayerGuiInit()
 	end
-	gPlayerBodySerial =3D serial
-
-	PlayerBackpackItemUpdated()
-	=

-	-- TODO this seems a bit like the wrong place for this stuff
-	-- create player status dialog and stuff like this
-	GuiInit()
 end
 =

 =



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000324.html">[Iris-commit] [IRIS] r1509 - in /trunk/data/lua: lib.3d.dynamic.lua lib.static.lua net.other.lua net/net.dynamic.lua
</A></li>
	<LI>Next message: <A HREF="000326.html">[Iris-commit] [IRIS] r1511 - in /trunk/data/lua: gui/gui.gumpmanager.lua lib.bodygfx.lua lib.deffileparser.lua lib.speech.lua lib.tilefreewalk.lua main.lua
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#325">[ date ]</a>
              <a href="thread.html#325">[ thread ]</a>
              <a href="subject.html#325">[ subject ]</a>
              <a href="author.html#325">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
