<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1506 - in /trunk: data/ data/lua/ data/lua/net/ data/xml/ include/ src/ vc8/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1506%20-%20in%20/trunk%3A%20data/%20data/lua/%0A%20data/lua/net/%20data/xml/%20include/%20src/%20vc8/&In-Reply-To=%3C20071114181014.380FB1524004%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000320.html">
   <LINK REL="Next"  HREF="000322.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1506 - in /trunk: data/ data/lua/ data/lua/net/ data/xml/ include/ src/ vc8/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1506%20-%20in%20/trunk%3A%20data/%20data/lua/%0A%20data/lua/net/%20data/xml/%20include/%20src/%20vc8/&In-Reply-To=%3C20071114181014.380FB1524004%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1506 - in /trunk: data/ data/lua/ data/lua/net/ data/xml/ include/ src/ vc8/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Wed Nov 14 19:10:14 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000320.html">[Iris-commit] [IRIS] r1505 - /trunk/data/lua/lib.filepath.lua
</A></li>
        <LI>Next message: <A HREF="000322.html">[Iris-commit] [IRIS] r1507 - /trunk/bin/iris2.exe
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#321">[ date ]</a>
              <a href="thread.html#321">[ thread ]</a>
              <a href="subject.html#321">[ subject ]</a>
              <a href="author.html#321">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: sience
Date: Wed Nov 14 19:10:13 2007
New Revision: 1506

Log:
-mapdefinitions moved from Maps.xml &amp; Maps_pre6.xml -&gt; config.lua.dist
-Maps.xml &amp; Maps_pre6.xml &amp; xml Folder deleted

Removed:
    trunk/data/xml/
    trunk/include/legacydata.h
    trunk/src/legacydata.cpp
Modified:
    trunk/data/config.lua.dist
    trunk/data/lua/lib.3d.renderer.lua
    trunk/data/lua/lib.gfm.lua
    trunk/data/lua/lib.granny.lua
    trunk/data/lua/lib.loading.lua
    trunk/data/lua/lib.test.lua
    trunk/data/lua/main.lua
    trunk/data/lua/net/net.login.lua
    trunk/vc8/iris.vcproj

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Wed Nov 14 19:10:13 2007
@@ -251,7 +251,7 @@
 gShowTileFreeDebug =3D false
 =

 -- Language
-gLanguage =3D &quot;ENU&quot;		-- used for client localization
+-- gLanguage =3D &quot;DEU&quot;		-- used for client localization
 =

 ------------------------------ UO Files --------------------------
 gHuesFile		=3D &quot;hues.mul&quot;
@@ -275,8 +275,6 @@
 gRadarcolFile	=3D &quot;radarcol.mul&quot;
 =

 gProftxtFile	=3D &quot;Prof.txt&quot;
-gMusicConfigFile=3D &quot;Config.txt&quot;
-gModelstxtFile	=3D &quot;Models.txt&quot;
 =

 gUnifontFile	=3D &quot;unifont.mul&quot;
 gUnifonts		=3D &quot;unifont&quot;				-- abstract filename
@@ -284,6 +282,90 @@
 gCliloc			=3D &quot;Cliloc.&quot;				-- without extension, name depends on gLanguage=
 setting
 gIntlocFiles	=3D &quot;intloc%02d.&quot;			-- abstract filename (intloc names are ge=
nerated)
 =

+gGrannyConfigFile=3D &quot;Models.txt&quot;
 gGrannyPath		=3D &quot;models/&quot;
+gMusicConfigFile=3D &quot;Config.txt&quot;
 gMusicPath		=3D &quot;Music/Digital/&quot;
 =

+gMaps =3D {}
+gMaps[0] =3D {
+	name =3D &quot;Trammel&quot;,
+	mapweidth =3D 896,
+	mapheight =3D 512,
+	skybox =3D &quot;cleansky&quot;,
+	fog_r =3D 228,
+	fog_g =3D 208,
+	fog_b =3D 166,
+	mapfilename		=3D &quot;map0.mul&quot;,
+	staidxfilename	=3D &quot;staidx0.mul&quot;,
+	staticfilename	=3D &quot;statics0.mul&quot;
+
+	-- only relevant for pre 6.0.0 server
+--	,sta_diff_lookup=3D &quot;stadifl0.mul&quot;,
+--	sta_diff_idx	=3D &quot;stadifi0.mul&quot;,
+--	sta_diff_data	=3D &quot;stadif0.mul&quot;,
+--	map_diff_lookup	=3D &quot;mapdifl0.mul&quot;,
+--	map_diff_data	=3D &quot;mapdif0.mul&quot;
+}
+gMaps[1] =3D {
+	name =3D &quot;Felucca&quot;,
+	mapweidth =3D 896,
+	mapheight =3D 512,
+	skybox =3D &quot;cleansky&quot;,
+	fog_r =3D 228,
+	fog_g =3D 208,
+	fog_b =3D 166,
+	mapfilename		=3D &quot;map1.mul&quot;,
+	staidxfilename	=3D &quot;staidx1.mul&quot;,
+	staticfilename	=3D &quot;statics1.mul&quot;
+
+	-- only relevant for pre 6.0.0 server
+--	,sta_diff_lookup=3D &quot;stadifl1.mul&quot;,
+--	sta_diff_idx	=3D &quot;stadifi1.mul&quot;,
+--	sta_diff_data	=3D &quot;stadif1.mul&quot;,
+--	map_diff_lookup	=3D &quot;mapdifl1.mul&quot;,
+--	map_diff_data	=3D &quot;mapdif1.mul&quot;
+}
+gMaps[2] =3D {
+	name =3D &quot;Ilshenar&quot;,
+	mapweidth =3D 288,
+	mapheight =3D 200,
+	skybox =3D &quot;skybox&quot;,
+	fog_r =3D 168,
+	fog_g =3D 168,
+	fog_b =3D 180,
+	mapfilename		=3D &quot;map2.mul&quot;,
+	staidxfilename	=3D &quot;staidx2.mul&quot;,
+	staticfilename	=3D &quot;statics2.mul&quot;
+
+	-- only relevant for pre 6.0.0 server
+--	,sta_diff_lookup=3D &quot;stadifl2.mul&quot;,
+--	sta_diff_idx	=3D &quot;stadifi2.mul&quot;,
+--	sta_diff_data	=3D &quot;stadif2.mul&quot;,
+--	map_diff_lookup =3D &quot;mapdifl2.mul&quot;,
+--	map_diff_data	=3D &quot;mapdif2.mul&quot;
+}
+gMaps[3] =3D {
+	name =3D &quot;Malas&quot;,
+	mapweidth =3D 320,
+	mapheight =3D 256,
+	skybox =3D &quot;sunset&quot;,
+	fog_r =3D 27,
+	fog_g =3D 21,
+	fog_b =3D 9,
+	mapfilename		=3D &quot;map3.mul&quot;,
+	staidxfilename	=3D &quot;staidx3.mul&quot;,
+	staticfilename	=3D &quot;statics3.mul&quot;
+}
+gMaps[4] =3D {
+	name =3D &quot;Tokuno&quot;,
+	mapweidth =3D 181,
+	mapheight =3D 181,
+	skybox =3D &quot;darksun&quot;,
+	fog_r =3D 97,
+	fog_g =3D 76,
+	fog_b =3D 33,
+	mapfilename		=3D &quot;map4.mul&quot;,
+	staidxfilename	=3D &quot;staidx4.mul&quot;,
+	staticfilename	=3D &quot;statics4.mul&quot;
+}

Modified: trunk/data/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.renderer.lua (original)
+++ trunk/data/lua/lib.3d.renderer.lua Wed Nov 14 19:10:13 2007
@@ -42,19 +42,19 @@
 =

 function Renderer3D:SetMapEnvironment (bUnderGround)
 	if (not self.gbActive) then return end
-	if (not gMapInfo) then return end
-	=

-	local skyboxfilename=3Dxmlchild(gMapInfo,&quot;SKYBOX&quot;)[1]
-	gFogcolorred=3Dtonumber(xmlchild(gMapInfo,&quot;FOG_RED&quot;)[1])
-	gFogcolorgreen=3Dtonumber(xmlchild(gMapInfo,&quot;FOG_GREEN&quot;)[1])
-	gFogcolorblue=3Dtonumber(xmlchild(gMapInfo,&quot;FOG_BLUE&quot;)[1])
+	if (not gMapIndex) then return end
+	=

+	local skyboxmaterial	=3D gMaps[gMapIndex].skybox
+	gFogcolorred			=3D gMaps[gMapIndex].fog_r
+	gFogcolorgreen			=3D gMaps[gMapIndex].fog_g
+	gFogcolorblue			=3D gMaps[gMapIndex].fog_b
 	=

 	-- black background when underground
 	if (bUnderGround) then
 		GetMainViewport():SetBackCol(0,0,0)
 		Client_SetSkybox()
 	else
-		Client_SetSkybox(skyboxfilename)
+		Client_SetSkybox(skyboxmaterial)
 	end
 	=

 	if (gUseDistanceFog) then

Modified: trunk/data/lua/lib.gfm.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.gfm.lua (original)
+++ trunk/data/lua/lib.gfm.lua Wed Nov 14 19:10:13 2007
@@ -193,70 +193,6 @@
 		widget.gfx:SetUV(0,0,w/tw,h/th)
 		widget.gfx:SetAlignment(kGfx2DAlign_Center,kGfx2DAlign_Center)
 	end
-end
-
-function GfmTest()
---[[
-	-- gGumpLoader
-	--local iGumpID =3D (hex2num(&quot;0x47E&quot;)) -- small x button
-	--local iGumpID =3D (hex2num(&quot;0x1393&quot;)) -- big compass
-	--local iGumpID =3D (hex2num(&quot;0x1392&quot;)) -- small compass
-	local iGumpID =3D (hex2num(&quot;0xA28&quot;))+0 -- border ?
-	--local iGumpID =3D (hex2num(&quot;0xA28&quot;))+4 -- border ? (funny palette stuff=
 at left-top)
-	--local iGumpID =3D (hex2num(&quot;0xA28&quot;))+13 -- border ?
-	--local iGumpID =3D (hex2num(&quot;0x95&quot;)) -- label ?
-	local testmat =3D gGumpLoader:CreateMaterial(iGumpID) -- big compass
-	=

-	if (false and testmat and testmat ~=3D &quot;&quot;) then
-		gGumpLoader:Load(iGumpID)
-		local w,h =3D gGumpLoader:GetSize()
-		local tw,th =3D texsize(w),texsize(h)
-		=

-		gGumpTestDlg =3D guimaker.MyCreateDialog()
-		gGumpTestDlg.widget =3D guimaker.MakePlane(gGumpTestDlg,testmat,-w/2,-h/=
2,w,h)
-		local widget =3D gGumpTestDlg.widget
-		widget.gfx:SetUV(0,0,w/tw,h/th)
-		widget.gfx:SetAlignment(kGfx2DAlign_Center,kGfx2DAlign_Center)
-	end
-	=

-	if (false) then
-		gGfmTestDlg =3D guimaker.MyCreateDialog()
-		gGfmTestDlg.rootwidget =3D guimaker.MakePlane(gGfmTestDlg,&quot;BaseWhiteNoLi=
ghting&quot;,0,0,0,0) -- need a dummy to get the zorder right
-		local button =3D MakeBorderGumpPart(gGfmTestDlg.rootwidget,hex2num(&quot;0x47=
E&quot;),318,270,28,21)
-		local bordergump =3D MakeBorderGump(gGfmTestDlg.rootwidget,hex2num(&quot;0xA2=
8&quot;),126,146,409,182)
-		--control : class=3Dbutton, name=3D'button_47e', left=3D318,270,28,21
-		--gump(): normal=3D0x47E over=3D0x47F pressed=3D0x47E
-	end
-]]--
-	=

-	if (true and gGumpLoader) then
-		--local path =3D &quot;data/gfm/askquit.gfm&quot;
-		--local path =3D &quot;data/gfm/healthbar.gfm&quot;
-		--local path =3D &quot;data/gfm/background.gfm&quot;  -- broken
-		--local path =3D &quot;data/gfm/main_menu.gfm&quot; -- broken
-		--local path =3D &quot;data/gfm/connecting.gfm&quot;
-		--local path =3D &quot;data/gfm/loading.gfm&quot;
-		--local path =3D &quot;data/gfm/neterror.gfm&quot;
---[[
-		local mydialog =3D CreateGumpDlgFromGfm(path)
-		mydialog.rootwidget.gfx:SetPos(120,0)
-		local w =3D mydialog.controls[&quot;hitsbar&quot;].gfx:GetWidth()
-		local h =3D mydialog.controls[&quot;hitsbar&quot;].gfx:GetHeight()
-		local p =3D 0.4
-		print(&quot;hitsbar: w=3D&quot;,w,&quot;h=3D&quot;,h)
-		mydialog.controls[&quot;hitsbar&quot;].gfx:SetDimensions(w*p,h)
-		--mydialog.controls[&quot;hitsbar&quot;].gfx:SetUV(0.0,0.0,p,1.0)
-		--GfmDump(path)
-]]--
-	end
-	=

-	=

---[[
-	print(&quot;map_ID=3D&quot;,xmlchild(mapinfo,&quot;ID&quot;)[1])
-	print(&quot;map_NAME=3D&quot;,xmlchild(mapinfo,&quot;NAME&quot;)[1])
-	print(&quot;map_HEIGHT=3D&quot;,xmlchild(mapinfo,&quot;HEIGHT&quot;)[1])
-	print(&quot;map_SKYBOX=3D&quot;,xmlchild(mapinfo,&quot;SKYBOX&quot;)[1])
-]]--
 end
 =

 function CreateGumpDlgFromGfm (path) =


Modified: trunk/data/lua/lib.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.granny.lua (original)
+++ trunk/data/lua/lib.granny.lua Wed Nov 14 19:10:13 2007
@@ -378,7 +378,7 @@
 end
 =

 function GetGrannyModelInfo (modelid) =

-	if (not gGrannyModelInfo) then gGrannyModelInfo =3D LoadGrannyModelInfo( =
CorrectGrannyPath(gModelstxtFile) ) end
+	if (not gGrannyModelInfo) then gGrannyModelInfo =3D LoadGrannyModelInfo( =
CorrectGrannyPath(gGrannyConfigFile) ) end
 	return gGrannyModelInfo[modelid]
 end
 =


Modified: trunk/data/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.loading.lua (original)
+++ trunk/data/lua/lib.loading.lua Wed Nov 14 19:10:13 2007
@@ -212,104 +212,70 @@
 	if (gStaticBlockLoader) then gStaticBlockLoader:Destroy() gStaticBlockLoa=
der =3D nil end
 end
 =

---todo: Maps_pre6.xml
-function Check_Map (index, mapsfile)
-	local xml_maps =3D xmlchild(LuaXML_ParseFile(datapath..mapsfile),&quot;MAPS&quot;)
-	local xml_map =3D nil
-	=

-	-- search for MAP node with matching ID
-	for k,child in ipairs(xml_maps) do
-		if tonumber(xmlvalue(child,&quot;ID&quot;)) =3D=3D tonumber(index) then
-			-- map found
-			xml_map =3D child
-		end
-	end
-	=

-	-- crash on &quot;map not found&quot;
-	if not xml_map then
-		print(&quot;FATAL map &quot; .. index .. &quot; not found in &quot;..mapsfile)
-		Crash()
-	end
-
-	local mapfilename =3D	xmlchild(xml_map,&quot;MAPFILENAME&quot;)[1]
-
-	if not(file_exists(CorrectPath(gUOPath..mapfilename))) then
-	end
-
-	-- map found, assign it to the global map info
-	return xml_map
-end
-
+-- Loads Maps+Statics+Diff Files (only pre 6.0.0)
 function LoadMap (index)
 	gMapLoaded =3D true
 	gMapIndex =3D index
+
 	gCurrentRenderer:ClearMapCache()
-	print(&quot;load map&quot;,gMapIndex)
-	gMapImagePath_Small	=3D datapath..&quot;base/tempmap_&quot;..gMapIndex..&quot;_small_s.t=
ga&quot;
+	print(&quot;gMapIndex&quot;,index)
 =

 	if (not gInitialMapLoaded) then LoadingProfile(&quot;load MapInfo&quot;) end
-
-	-- map found, assign map-array to the global map info
-	gMapInfo =3D Check_Map(index,&quot;xml/Maps.xml&quot;)
-	local mapfilename =3D	xmlchild(gMapInfo,&quot;MAPFILENAME&quot;)[1]
-
-	-- if Mapfile (for example map1.mul) don't exists then load
-	if not( file_exists(CorrectPath(gUOPath..mapfilename)) ) then
-		gMapInfo =3D Check_Map(index,&quot;xml/Maps_pre6.xml&quot;)
-		mapfilename =3D xmlchild(gMapInfo,&quot;MAPFILENAME&quot;)[1]
-	end
-	=

-	local mapheight =3D		xmlchild(gMapInfo,&quot;HEIGHT&quot;)[1]
-	local staidxfilename =3D	xmlchild(gMapInfo,&quot;STAIDXFILENAME&quot;)[1]
-	local staticfilename =3D	xmlchild(gMapInfo,&quot;STATICFILENAME&quot;)[1]
-
-	local sta_diff_lookup =3D	xmlvalue(gMapInfo,&quot;STA_DIFF_LOOKUP&quot;)
-	local sta_diff_idx =3D		xmlvalue(gMapInfo,&quot;STA_DIFF_IDX&quot;)
-	local sta_diff_data =3D	xmlvalue(gMapInfo,&quot;STA_DIFF_DATA&quot;)
-
-	local map_diff_lookup =3D	xmlvalue(gMapInfo,&quot;MAP_DIFF_LOOKUP&quot;)
-	local map_diff_data =3D	xmlvalue(gMapInfo,&quot;MAP_DIFF_DATA&quot;)
-
-	local id =3D				xmlchild(gMapInfo,&quot;ID&quot;)[1]
-
-	print(&quot;Loading Map id &quot;..id)
-	print(&quot;Loading Map name &quot;..xmlvalue(gMapInfo,&quot;NAME&quot;))
-	print(&quot;Loading Map terrain &quot;..mapfilename)
-	print(&quot;Loading Map static idx &quot;..staidxfilename)
-	print(&quot;Loading Map static &quot;..staticfilename)
-		=

+	local name				=3D gMaps[index].name
+	local mapheight			=3D gMaps[index].mapheight
+	local mapfilename		=3D gMaps[index].mapfilename
+	local staidxfilename	=3D gMaps[index].staidxfilename
+	local staticfilename	=3D gMaps[index].staticfilename
+
+	-- only relevant for pre 6.0.0 UO Clients
+	local sta_diff_lookup	=3D gMaps[index].sta_diff_lookup
+	local sta_diff_idx		=3D gMaps[index].sta_diff_idx
+	local sta_diff_data		=3D gMaps[index].sta_diff_data
+	local map_diff_lookup	=3D gMaps[index].map_diff_lookup
+	local map_diff_data		=3D gMaps[index].map_diff_data
+
 	if (gGroundBlockLoaderType) then
 		if (not gInitialMapLoaded) then LoadingProfile(&quot;init GroundblockLoader&quot;)=
 end
-		-- gGroundBlockLoader =3D CreateGroundBlockLoader(&quot;Dummy&quot;,3,0)
-		-- second parameter, 512, is map-height.. width is calculated automatica=
lly from filesize
-		=

+		=

+		print(&quot;Loading Map id &quot;..index)
+		print(&quot;Loading Map name &quot;..name)
+		print(&quot;Loading Map terrain &quot;..mapfilename)
 		--- use diff files?
 		if map_diff_lookup and map_diff_data =

-			and file_exists(CorrectPath(gUOPath..map_diff_lookup)) and file_exists(=
CorrectPath(gUOPath..map_diff_data)) then
-			=

-			print(&quot;Applying map diff files&quot;)
-			gGroundBlockLoader =3D CreateGroundBlockLoaderWithDiff(gGroundBlockLoad=
erType,mapheight,CorrectPath(gUOPath..mapfilename),
-				CorrectPath(gUOPath..map_diff_lookup), CorrectPath(gUOPath..map_diff_d=
ata))
+			and file_exists(CorrectPath( Addfilepath(map_diff_lookup) )) and file_e=
xists(CorrectPath( Addfilepath(map_diff_data) )) then
+
+			print(&quot;Loading Map map_diff_lookup &quot;..map_diff_lookup)
+			print(&quot;Loading Map map_diff_data &quot;..map_diff_data)
+			print(&quot;Applying Map diff files&quot;)
+			gGroundBlockLoader =3D CreateGroundBlockLoaderWithDiff(gGroundBlockLoad=
erType,mapheight,CorrectPath( Addfilepath(mapfilename) ),
+				CorrectPath( Addfilepath(map_diff_lookup) ), CorrectPath( Addfilepath(=
map_diff_data) ))
 		else
-			gGroundBlockLoader =3D CreateGroundBlockLoader(gGroundBlockLoaderType,m=
apheight,CorrectPath(gUOPath..mapfilename))
+			gGroundBlockLoader =3D CreateGroundBlockLoader(gGroundBlockLoaderType,m=
apheight,CorrectPath( Addfilepath(mapfilename) ))
 		end
 	end
 		=

 	if (gStaticBlockLoaderType) then
 		if (not gInitialMapLoaded) then LoadingProfile(&quot;init StaticBlockLoader&quot;)=
 end
 		=

-		print(&quot;diff&quot;,sta_diff_lookup , sta_diff_idx , sta_diff_data)
+		print(&quot;Loading Static static idx &quot;..staidxfilename)
+		print(&quot;Loading Static static &quot;..staticfilename)
+		--- use diff files?
 		if(sta_diff_lookup and sta_diff_idx and sta_diff_data)
-			and file_exists(CorrectPath(gUOPath..sta_diff_lookup)) and file_exists(=
CorrectPath(gUOPath..sta_diff_idx)) =

-			and file_exists(CorrectPath(gUOPath..sta_diff_data)) then
-			=

-			print(&quot;Applying static diff files&quot;)
-			gStaticBlockLoader =3D CreateStaticBlockLoaderWithDiff(gStaticBlockLoad=
erType,mapheight,CorrectPath(gUOPath..staidxfilename),CorrectPath(gUOPath..=
staticfilename),
-				CorrectPath(gUOPath..sta_diff_lookup),CorrectPath(gUOPath..sta_diff_id=
x),CorrectPath(gUOPath..sta_diff_data))
+			and file_exists(CorrectPath( Addfilepath(sta_diff_lookup) )) and file_e=
xists(CorrectPath( Addfilepath(sta_diff_idx) )) =

+			and file_exists(CorrectPath( Addfilepath(sta_diff_data) )) then
+
+			print(&quot;Loading Static sta_diff_lookup &quot;..sta_diff_lookup)
+			print(&quot;Loading Static sta_diff_idx &quot;..sta_diff_idx)
+			print(&quot;Loading Static sta_diff_data &quot;..sta_diff_data)
+			print(&quot;Applying Static diff files&quot;)
+			gStaticBlockLoader =3D CreateStaticBlockLoaderWithDiff(gStaticBlockLoad=
erType,mapheight,CorrectPath( Addfilepath(staidxfilename) ),CorrectPath( Ad=
dfilepath(staticfilename) ),
+				CorrectPath( Addfilepath(sta_diff_lookup) ),CorrectPath( Addfilepath(s=
ta_diff_idx) ),CorrectPath( Addfilepath(sta_diff_data) ))
 		else =

-			gStaticBlockLoader =3D CreateStaticBlockLoader(gStaticBlockLoaderType,m=
apheight,CorrectPath(gUOPath..staidxfilename),CorrectPath(gUOPath..staticfi=
lename))
-		end
-	end
+			gStaticBlockLoader =3D CreateStaticBlockLoader(gStaticBlockLoaderType,m=
apheight,CorrectPath( Addfilepath(staidxfilename) ),CorrectPath( Addfilepat=
h(staticfilename) ))
+		end
+	end
+
+	gMapImagePath_Small	=3D datapath..&quot;base/tempmap_&quot;..index..&quot;_small_s.tga&quot;
 =

 	local mapfile_exists =3D file_exists(gMapImagePath_Small)
 	if (mapfile_exists) then
@@ -326,5 +292,5 @@
 	=

 	-- update renderer
 	gCurrentRenderer:SetMapEnvironment()
-	SetCompassMapIndex(gMapIndex)
-end
+	SetCompassMapIndex(index)
+end

Modified: trunk/data/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.test.lua (original)
+++ trunk/data/lua/lib.test.lua Wed Nov 14 19:10:13 2007
@@ -65,15 +65,17 @@
 	Crash()
 end
 =

-function AnalyseStatics ()
-	-- count how often every type of static occurs on the map
-	gMapInfo =3D Check_Map(gMapIndex,&quot;xml/Maps.xml&quot;)
-	print(&quot;gMapInfo&quot;,gMapInfo)
-	local mapfilename=3D	 xmlchild(gMapInfo,&quot;MAPFILENAME&quot;)[1]
-	local mapheight=3D	 xmlchild(gMapInfo,&quot;HEIGHT&quot;)[1]
-	local staidxfilename=3Dxmlchild(gMapInfo,&quot;STAIDXFILENAME&quot;)[1]
-	local staticfilename=3Dxmlchild(gMapInfo,&quot;STATICFILENAME&quot;)[1]
-	local skyboxfilename=3Dxmlchild(gMapInfo,&quot;SKYBOX&quot;)[1]
+-- count how often every type of static occurs on the map
+function AnalyseStatics (index)
+	gMapLoaded =3D true
+	gMapIndex =3D index
+	gCurrentRenderer:ClearMapCache()
+	print(&quot;gMapIndex&quot;,gMapIndex)
+
+	local name				=3D gMaps[index].name
+	local mapheight			=3D gMaps[index].mapheight
+	local staidxfilename	=3D gMaps[index].staidxfilename
+	local staticfilename	=3D gMaps[index].staticfilename
 	=

 	if (gTileTypeLoaderType) then
 		LoadingProfile(&quot;init TileTypeLoader&quot;)

Modified: trunk/data/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/main.lua (original)
+++ trunk/data/lua/main.lua Wed Nov 14 19:10:13 2007
@@ -137,7 +137,7 @@
 		end
 	end
 	-- check for character(granny) models
-	if (not file_exists( CorrectGrannyPath(gModelstxtFile) )) then
+	if (not file_exists( CorrectGrannyPath(gGrannyConfigFile) )) then
 		FatalErrorMessage(sprintf(&quot;iris2 could not find character models in your=
 uo dir\n please install AOS or ML (see README)&quot;))
 	end
 end
@@ -167,7 +167,7 @@
 	-- if (gHuffmanCompression) then LuaHuffmanTest() end
 	-- if (false) then MyGrannyTest_PreOgre() end	-- TODO : just a test, see =
lib.granny.lua
 	-- if (false) then LuaBitwiseTest() end
-	-- if (false) then AnalyseStatics() end
+	-- if (false) then AnalyseStatics(0) end
 	-- if (false) then ExpressionTest() end
 	-- if (false) then TestSound() end
 	-- if (false) then TestMultiLoader() end

Modified: trunk/data/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net/net.login.lua (original)
+++ trunk/data/lua/net/net.login.lua Wed Nov 14 19:10:13 2007
@@ -36,7 +36,7 @@
 =

 -- len: 0x10C
 function ProtocolSend_SystemSpecs()
-	print(&quot;NET: Send_SystemSpecs:&quot;)
+	printdebug(&quot;login&quot;,&quot;NET: Send_SystemSpecs:&quot;)
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Metrics)
 	out:PushNetUint8(hex2num(&quot;0x02&quot;))

Modified: trunk/vc8/iris.vcproj
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/vc8/iris.vcproj (original)
+++ trunk/vc8/iris.vcproj Wed Nov 14 19:10:13 2007
@@ -306,10 +306,6 @@
 				&gt;
 			&lt;/File&gt;
 			&lt;File
-				RelativePath=3D&quot;..\include\legacydata.h&quot;
-				&gt;
-			&lt;/File&gt;
-			&lt;File
 				RelativePath=3D&quot;..\include\ogremanualloader.h&quot;
 				&gt;
 			&lt;/File&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000320.html">[Iris-commit] [IRIS] r1505 - /trunk/data/lua/lib.filepath.lua
</A></li>
	<LI>Next message: <A HREF="000322.html">[Iris-commit] [IRIS] r1507 - /trunk/bin/iris2.exe
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#321">[ date ]</a>
              <a href="thread.html#321">[ thread ]</a>
              <a href="subject.html#321">[ subject ]</a>
              <a href="author.html#321">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
