<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r1373 - in /trunk: ./ data/lua/ data/lua/gui/	include/ src/
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2007-September/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1373%20-%20in%20/trunk%3A%20./%20data/lua/%20data/lua/gui/%0A%09include/%20src/&In-Reply-To=%3C20070902142033.8111C1524003%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000189.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r1373 - in /trunk: ./ data/lua/ data/lua/gui/	include/ src/</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r1373%20-%20in%20/trunk%3A%20./%20data/lua/%20data/lua/gui/%0A%09include/%20src/&In-Reply-To=%3C20070902142033.8111C1524003%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r1373 - in /trunk: ./ data/lua/ data/lua/gui/	include/ src/">no-reply at zwischenwelt.org
       </A><BR>
    <I>Sun Sep  2 16:20:31 CEST 2007</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000189.html">[Iris-commit] [IRIS] r1374 - in /trunk: include/huffman.h src/huffman.cpp src/scripting.iris.cpp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#188">[ date ]</a>
              <a href="thread.html#188">[ thread ]</a>
              <a href="subject.html#188">[ subject ]</a>
              <a href="author.html#188">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ghoulsblade
Date: Sun Sep  2 16:20:30 2007
New Revision: 1373

Log:
lugre built in

Added:
    trunk/SConstruct
    trunk/build_config.py
    trunk/build_support.py
    trunk/data/lua/lib.gui.iris.lua
    trunk/data/lua/lib.input.iris.lua
      - copied, changed from r1371, trunk/data/lua/lib.input.lua
    trunk/data/lua/lib.keybinds.lua
    trunk/data/lua/lib.plaingui.iris.lua
    trunk/data/lua/lib.sound.iris.lua
    trunk/src/scripting.iris.cpp
Removed:
    trunk/data/lua/lib.cam.lua
    trunk/data/lua/lib.edittext.lua
    trunk/data/lua/lib.fadelines.lua
    trunk/data/lua/lib.gui.lua
    trunk/data/lua/lib.guimaker.lua
    trunk/data/lua/lib.input.lua
    trunk/data/lua/lib.listener.lua
    trunk/data/lua/lib.plaingui.lua
    trunk/data/lua/lib.sound.lua
    trunk/data/lua/lib.time.lua
    trunk/data/lua/lib.util.lua
    trunk/data/lua/udata.lua
    trunk/include/BorderColourClipPaneOverlay.h
    trunk/include/ColourClipPaneOverlay.h
    trunk/include/ColourClipTextOverlay.h
    trunk/include/CompassOverlay.h
    trunk/include/RobRenderableOverlay.h
    trunk/include/SortedOverlayContainer.h
    trunk/include/bitmask.h
    trunk/include/camera.h
    trunk/include/fifo.h
    trunk/include/game.h
    trunk/include/gfx2D.h
    trunk/include/gfx3D.h
    trunk/include/huffman.h
    trunk/include/input.h
    trunk/include/listener.h
    trunk/include/luabind.h
    trunk/include/luaxml.h
    trunk/include/meshshape.h
    trunk/include/net.h
    trunk/include/ogrefonthelper.h
    trunk/include/ogrewrapper.h
    trunk/include/prefix.h
    trunk/include/profile.h
    trunk/include/rendertexture.h
    trunk/include/robrenderable.h
    trunk/include/robstring1.2.h
    trunk/include/scripting.h
    trunk/include/shell.h
    trunk/include/smartptr.h
    trunk/include/sound.h
    trunk/include/timer.h
    trunk/include/tinystr.h
    trunk/include/tinyxml.h
    trunk/include/viewport.h
    trunk/include/widget.h
    trunk/src/BorderColourClipPaneOverlay.cpp
    trunk/src/ColourClipPaneOverlay.cpp
    trunk/src/ColourClipTextOverlay.cpp
    trunk/src/CompassOverlay.cpp
    trunk/src/RobRenderableOverlay.cpp
    trunk/src/SortedOverlayContainer.cpp
    trunk/src/bitmask.cpp
    trunk/src/bitmask_L.cpp
    trunk/src/camera.cpp
    trunk/src/camera_L.cpp
    trunk/src/fifo_L.cpp
    trunk/src/game.cpp
    trunk/src/gfx2D.cpp
    trunk/src/gfx2D_L.cpp
    trunk/src/gfx3D.cpp
    trunk/src/gfx3D_L.cpp
    trunk/src/huffman.cpp
    trunk/src/input.cpp
    trunk/src/listener.cpp
    trunk/src/luaxml.cpp
    trunk/src/material_L.cpp
    trunk/src/meshshape.cpp
    trunk/src/net.cpp
    trunk/src/net_L.cpp
    trunk/src/ogrewrapper.cpp
    trunk/src/profile.cpp
    trunk/src/rendertexture.cpp
    trunk/src/rendertexture_L.cpp
    trunk/src/robrenderable.cpp
    trunk/src/robstring1.2.cpp
    trunk/src/scripting.cpp
    trunk/src/shell.cpp
    trunk/src/sound.cpp
    trunk/src/sound_L.cpp
    trunk/src/sound_fmod.cpp
    trunk/src/sound_openal.cpp
    trunk/src/timer.cpp
    trunk/src/tinystr.cpp
    trunk/src/tinyxml.cpp
    trunk/src/tinyxmlerror.cpp
    trunk/src/tinyxmlparser.cpp
    trunk/src/viewport.cpp
    trunk/src/viewport_L.cpp
    trunk/src/widget.cpp
    trunk/src/widget_L.cpp
Modified:
    trunk/   (props changed)
    trunk/data/lua/gui/gui.gumpmanager.lua
    trunk/data/lua/gui/gui.widget.lua
    trunk/data/lua/lib.3d.cam.lua
    trunk/data/lua/lib.3d.mousepick.lua
    trunk/data/lua/lib.3d.renderer.lua
    trunk/data/lua/lib.debugmenu.lua
    trunk/data/lua/lib.devtool.lua
    trunk/data/lua/lib.fallback.lua
    trunk/data/lua/lib.journal.lua
    trunk/data/lua/lib.mousepick.lua
    trunk/data/lua/lib.skill.lua
    trunk/data/lua/lib.test.lua
    trunk/data/lua/lib.uodragdrop.lua
    trunk/data/lua/main.lua
    trunk/data/lua/net.cursor.lua
    trunk/data/lua/net.popup.lua
    trunk/data/lua/net.sound.lua
    trunk/data/lua/net.uodragdrop.lua
    trunk/data/lua/net.walk.lua
    trunk/include/builder.h
    trunk/include/data.h
    trunk/include/grannyloader_i2.h
    trunk/include/grannyparser.h
    trunk/include/legacydata.h
    trunk/include/ogremanualloader.h
    trunk/include/radar.h
    trunk/include/spritemanager.h
    trunk/src/builder.cpp
    trunk/src/builder_L.cpp
    trunk/src/data.cpp
    trunk/src/data_L.cpp
    trunk/src/granny_L.cpp
    trunk/src/grannydump.cpp
    trunk/src/grannyloader_i2.cpp
    trunk/src/grannyogreloader.cpp
    trunk/src/grannyparser.cpp
    trunk/src/legacydata.cpp
    trunk/src/main.cpp
    trunk/src/ogremanualloader.cpp
    trunk/src/ogremanualloader_L.cpp
    trunk/src/pathsearch.cpp
    trunk/src/radar.cpp
    trunk/src/radar_L.cpp
    trunk/src/spritemanager.cpp
    trunk/src/spritemanager_L.cpp
    trunk/src/terrain.cpp
    trunk/start.sh

Modified: trunk/data/lua/gui/gui.gumpmanager.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.gumpmanager.lua (original)
+++ trunk/data/lua/gui/gui.gumpmanager.lua Sun Sep  2 16:20:30 2007
@@ -42,22 +42,22 @@
 	local onRightUp		=3D false
 	=

 	-- get events
-	if (gMouseButtonDown_Left and (not gGumpmanager.MouseLeftDown)) then
+	if (gKeyPressed[key_mouse1] and (not gGumpmanager.MouseLeftDown)) then
 		gGumpmanager.MouseLeftDown =3D true
 		onLeftDown =3D true
 	end
 	=

-	if ((not gMouseButtonDown_Left) and gGumpmanager.MouseLeftDown) then
+	if ((not gKeyPressed[key_mouse1]) and gGumpmanager.MouseLeftDown) then
 		gGumpmanager.MouseLeftDown =3D false
 		onLeftUp =3D true
 	end
 	=

-	if (gMouseButtonDown_Right and (not gGumpmanager.MouseRightDown)) then
+	if (gKeyPressed[key_mouse2] and (not gGumpmanager.MouseRightDown)) then
 		gGumpmanager.MouseRightDown =3D true
 		onRightDown =3D true
 	end
 	=

-	if ((not gMouseButtonDown_Right) and gGumpmanager.MouseRightDown) then
+	if ((not gKeyPressed[key_mouse2]) and gGumpmanager.MouseRightDown) then
 		gGumpmanager.MouseRightDown =3D false
 		onRightUp =3D true
 	end
@@ -132,7 +132,7 @@
 	if (onLeftDown) then
 		if (gGumpmanager.CurrentMouseOverGumpObject) then
 			gGumpmanager.CurrentMouseOverGumpObject:onLeftDown()
-			gGumpmanager.LastMouseMoveX, gGumpmanager.LastMouseMoveY =3D PollInput()
+			gGumpmanager.LastMouseMoveX, gGumpmanager.LastMouseMoveY =3D GetMousePo=
s()
 		end
 		gGumpmanager.LastLeftDownGumpObject =3D gGumpmanager.CurrentMouseOverGum=
pObject
 	end
@@ -159,7 +159,7 @@
 	end
 	=

 	if (gGumpmanager.LastLeftDownGumpObject) then
-		local MouseX, MouseY =3D PollInput()
+		local MouseX, MouseY =3D GetMousePos()
 		local dx =3D MouseX - gGumpmanager.LastMouseMoveX
 		local dy =3D MouseY - gGumpmanager.LastMouseMoveY
 		=

@@ -1034,7 +1034,7 @@
 	GumpImage.onMove =3D function( button, dx, dy )
 		local item =3D gObjectList[ GumpImage.serial ]
 		if (item) then
-			local iMouseX, iMouseY =3D PollInput()
+			local iMouseX, iMouseY =3D GetMousePos()
 			item:grab( -(iMouseX-GumpImage.gump.x-GumpImage.x-item.x), -(iMouseY-Gu=
mpImage.gump.y-GumpImage.y-item.y) )
 		end
 		return false

Modified: trunk/data/lua/gui/gui.widget.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/gui/gui.widget.lua (original)
+++ trunk/data/lua/gui/gui.widget.lua Sun Sep  2 16:20:30 2007
@@ -65,7 +65,10 @@
 	return dialog
 end
 =

-function gui.GetWidgetUnderMouse () return gCurrentWidgetUnderMouse and gC=
urrentWidgetUnderMouse._guisyswidget end
+function gui.GetWidgetUnderMouse () =

+	local w =3D GetWidgetUnderMouse()
+	return w and w._guisyswidget =

+end
 =

 -- ***** ***** ***** ***** ***** dialog Utils
 =


Modified: trunk/data/lua/lib.3d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.cam.lua (original)
+++ trunk/data/lua/lib.3d.cam.lua Sun Sep  2 16:20:30 2007
@@ -33,12 +33,12 @@
 	if (not gActiveEditText) then =

 		if (key =3D=3D gInput_CamMouseButton and (not self.gCamMoveWithMouse)) t=
hen =

 			self.gCamMoveWithMouse =3D true =

-			self.gCamMoveWithMouse_OffX,self.gCamMoveWithMouse_OffY =3D PollInput()
+			self.gCamMoveWithMouse_OffX,self.gCamMoveWithMouse_OffY =3D GetMousePos=
()
 		end
 		local camkeyname =3D self.gCamKeyName[key]
 		if (camkeyname) then self.gCamKeyDown[camkeyname] =3D true end
 		--printf(&quot;CamKeyDown(%s)\n&quot;,GetKeyName(key))
-		-- kKeyMouse1
+		-- key_mouse1
 	end
 end
 =

@@ -121,7 +121,7 @@
 	=

 	if (Renderer3D.gbNeedCorrectAspectRatio) then self:CorrectAspectRatio() e=
nd
 	=

-	local iMouseX,iMouseY =3D PollInput()
+	local iMouseX,iMouseY =3D GetMousePos()
 	local vw,vh =3D GetViewportSize()
 	local fPhysStepTime =3D Client_GetPhysStepTime()
 	=


Modified: trunk/data/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.mousepick.lua (original)
+++ trunk/data/lua/lib.3d.mousepick.lua Sun Sep  2 16:20:30 2007
@@ -285,12 +285,12 @@
 		Client_SetBottomLine(self.gMousePickTippOverride or mouseover)
 		if (self.gbShowMousePickHitBoxes) then =

 			if (entity.staticentity) then =

-				self.gMousePickBBox:SetWireBoundingBoxMeshEntity(entity.staticentity)
-				self.gMousePickBBox:SetVisible(true)
-				self.gMousePickBBox:SetPosition(entity.x,entity.y,entity.z)
-				self.gMousePickBBox:SetOrientation(entity.qw,entity.qx,entity.qy,entit=
y.qz)
-				self.gMousePickBBox:SetScale(entity.sx,entity.sy,entity.sz)
-				self.gMousePickBBox:SetNormaliseNormals(true)
+--~ 				self.gMousePickBBox:SetWireBoundingBoxMeshEntity(entity.staticenti=
ty)
+--~ 				self.gMousePickBBox:SetVisible(true)
+--~ 				self.gMousePickBBox:SetPosition(entity.x,entity.y,entity.z)
+--~ 				self.gMousePickBBox:SetOrientation(entity.qw,entity.qx,entity.qy,e=
ntity.qz)
+--~ 				self.gMousePickBBox:SetScale(entity.sx,entity.sy,entity.sz)
+--~ 				self.gMousePickBBox:SetNormaliseNormals(true)
 			end
 		end
 	elseif (o.hittype =3D=3D kMousePickHitType_Terrain) then -- terrain tile

Modified: trunk/data/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.3d.renderer.lua (original)
+++ trunk/data/lua/lib.3d.renderer.lua Sun Sep  2 16:20:30 2007
@@ -459,7 +459,8 @@
 				mobile.hudname =3D guimaker.MakeText(gHudNamesDialogLayer.panel,0,0,te=
xt,gHudNamesFontSize,col_text)
 				mobile.hudname.gfx:SetTrackPosSceneNode(mobile.headpos)
 				--mobile.hudname.gfx:SetTrackPosSceneNode(mobile.gfx)
-				mobile.hudname.gfx:SetTrackHideIfNotVisible(true)
+				mobile.hudname.gfx.mbTrackHideIfClamped =3D true
+				mobile.hudname.gfx.mbTrackHideIfBehindCam =3D true
 				mobile.hudname.gfx:SetTextAlignment(kGfx2DAlign_Center)
 				mobile.hudname.lastn =3D mobile.notoriety
 				mobile.hudname.lastname =3D mobile.name
@@ -546,7 +547,8 @@
 			-- text parent node for position tracing
 			mobile.chattext_parent =3D guimaker.MakeSOC (gHudHeadChatDialogLayer.pa=
nel)
 			mobile.chattext_parent.gfx:SetTrackPosSceneNode(mobile.headpos)
-			mobile.chattext_parent.gfx:SetTrackHideIfNotVisible(true)
+			mobile.chattext_parent.gfx.mbTrackHideIfClamped =3D true
+			mobile.chattext_parent.gfx.mbTrackHideIfBehindCam =3D true
 			-- and text child for relative position
 			mobile.chattext =3D guimaker.MakeText(mobile.chattext_parent,0,-20,&quot;&quot;,g=
HudNamesFontSize,col_text)
 			mobile.chattext.gfx:SetTextAlignment(kGfx2DAlign_Center)
@@ -625,7 +627,8 @@
 		if (partgfx and partgfx.SetVisible) then partgfx:SetVisible(bVisible) end
 	end
 	if (mobile.hudname and mobile.hudname.gfx) then =

-		mobile.hudname.gfx:SetTrackHideIfNotVisible(bVisible)
+		mobile.hudname.gfx.mbTrackHideIfClamped =3D bVisible
+		mobile.hudname.gfx.mbTrackHideIfBehindCam =3D bVisible
 	end
 end
 =


Modified: trunk/data/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.debugmenu.lua (original)
+++ trunk/data/lua/lib.debugmenu.lua Sun Sep  2 16:20:30 2007
@@ -205,7 +205,7 @@
 =

 function DebugMenuChangeParam1	(delta) =

 	local newval =3D gDebugMenuModelIndex
-	if ((gbShiftDown) and gCurDebugMode =3D=3D kDebugMode_Static) then
+	if ((gKeyPressed[key_lshift]) and gCurDebugMode =3D=3D kDebugMode_Static)=
 then
 		for i=3D1,math.abs(delta) do
 			local tries =3D 400
 			local add =3D (delta &gt; 0) and 1 or -1

Modified: trunk/data/lua/lib.devtool.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.devtool.lua (original)
+++ trunk/data/lua/lib.devtool.lua Sun Sep  2 16:20:30 2007
@@ -6,7 +6,7 @@
 function ShowDevTool ()
 	gCurrentRenderer:MousePick()
 	local x,y,z =3D gCurrentRenderer:GetMouseHitTileCoords()
-	local radius =3D gbShiftDown and 0 or 2
+	local radius =3D gKeyPressed[key_lshift] and 0 or 2
 =

 	=

 	local rows =3D {
@@ -144,7 +144,7 @@
 		gCurrentRenderer:MousePick()
 		if (not gMousePickFoundHit) then return end
 		x,y,z =3D gCurrentRenderer:GetMouseHitTileCoords() =

-		radius =3D gbShiftDown and 0 or 3 =

+		radius =3D gKeyPressed[key_lshift] and 0 or 3 =

 	end
 	print(&quot;DevToolListStuffUnderMouse2&quot;,x,y,z,radius)
 	=


Modified: trunk/data/lua/lib.fallback.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.fallback.lua (original)
+++ trunk/data/lua/lib.fallback.lua Sun Sep  2 16:20:30 2007
@@ -53,7 +53,7 @@
 		gCurrentRenderer:MousePick()
 		if (not gMousePickFoundHit) then return end
 		x,y,z =3D gCurrentRenderer:GetMouseHitTileCoords() =

-		radius =3D gbShiftDown and 0 or 3 =

+		radius =3D gKeyPressed[key_lshift] and 0 or 3 =

 	end
 	local statictypes =3D ListFallBackTypesNearPos(x,y,z,radius)
 	printf(&quot;ShowFallBackTool %d,%d,%d:&quot;,x,y,z)

Modified: trunk/data/lua/lib.journal.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.journal.lua (original)
+++ trunk/data/lua/lib.journal.lua Sun Sep  2 16:20:30 2007
@@ -84,18 +84,18 @@
 		local widget =3D dialog.controls[&quot;journal_resize&quot;]
 		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then =

 			widget.gfx:SetMaterial(widget.mat_pressed)
-			gJournalResizeStartX,gJournalResizeStartY =3D PollInput()
+			gJournalResizeStartX,gJournalResizeStartY =3D GetMousePos()
 			if (true) then
 				gui.bMouseBlocked =3D true
 				RegisterStepper(function ()
-					local x,y =3D PollInput()
+					local x,y =3D GetMousePos()
 					--AddFadeLines(sprintf(&quot;resize %d,%d&quot;,2.0*(x-gJournalResizeStartX),(y=
-gJournalResizeStartY)))
 					--AddFadeLines(sprintf(&quot;resize %d,%d&quot;,gJournalDialog.resize_x_total o=
r 0,gJournalDialog.resize_y_total or 0))
 					local dx =3D 2.0*(x-gJournalResizeStartX)
 					--local dx =3D 0
 					gJournalDialog:ResizeDelta(dx,(y-gJournalResizeStartY))
 					gJournalResizeStartX,gJournalResizeStartY =3D x,y
-					if (gMouseButtonDown_Left) then
+					if (gKeyPressed[key_mouse1]) then
 						return false -- continue stepping
 					else
 						gui.bMouseBlocked =3D false

Modified: trunk/data/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.mousepick.lua (original)
+++ trunk/data/lua/lib.mousepick.lua Sun Sep  2 16:20:30 2007
@@ -14,19 +14,15 @@
 	gCurrentRenderer:TerrainRayIntersect_Hit (tx,ty,tiletype,hit_dist,minz,ma=
xz)
 end
 =

-function IrisRightDoubleClick ()
-	-- TODO implement pathfinding and use it here
-	-- SetAutoWalkTarget()
-end
 =

 function IrisDoubleClick ()
 	gCurrentRenderer:MousePick()
 	local iSerial =3D gCurrentRenderer:GetMouseHitSerial()
-	if gbControlDown then
+	if gKeyPressed[key_lcontrol] then
 		-- open status window if control pressed and mobile targeted
 		if (iSerial and iSerial ~=3D 0) then =

 			local mobile =3D GetMobile(iSerial)
-			local iMouseX,iMouseY =3D PollInput()
+			local iMouseX,iMouseY =3D GetMousePos()
 			-- -50,-30 to place the dialog beneath the mouse
 			OpenStatus(mobile,iMouseX - 50,iMouseY - 30)
 		end

Modified: trunk/data/lua/lib.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.skill.lua (original)
+++ trunk/data/lua/lib.skill.lua Sun Sep  2 16:20:30 2007
@@ -292,18 +292,18 @@
 		local widget =3D dialog.controls[&quot;skill_resize&quot;]
 		widget.onMouseDown 		=3D function (widget,mousebutton) if (mousebutton =
=3D=3D 1) then =

 			widget.gfx:SetMaterial(widget.mat_pressed)
-			gSkillResizeStartX,gSkillResizeStartY =3D PollInput()
+			gSkillResizeStartX,gSkillResizeStartY =3D GetMousePos()
 			if (true) then
 				gui.bMouseBlocked =3D true
 				RegisterStepper(function ()
-					local x,y =3D PollInput()
+					local x,y =3D GetMousePos()
 					--AddFadeLines(sprintf(&quot;resize %d,%d&quot;,2.0*(x-gSkillResizeStartX),(y-g=
SkillResizeStartY)))
 					--AddFadeLines(sprintf(&quot;resize %d,%d&quot;,gSkillDialog.resize_x_total or =
0,gSkillDialog.resize_y_total or 0))
 					local dx =3D 2.0*(x-gSkillResizeStartX)
 					--local dx =3D 0
 					gSkillDialog:ResizeDelta(dx,(y-gSkillResizeStartY))
 					gSkillResizeStartX,gSkillResizeStartY =3D x,y
-					if (gMouseButtonDown_Left) then
+					if (gKeyPressed[key_mouse1]) then
 						return false -- continue stepping
 					else
 						gui.bMouseBlocked =3D false

Modified: trunk/data/lua/lib.test.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.test.lua (original)
+++ trunk/data/lua/lib.test.lua Sun Sep  2 16:20:30 2007
@@ -54,8 +54,8 @@
 	--SoundSetListenerPosition(100,500,0)
 	SoundSetListenerPosition(100,100,0)
 	=

-	--SoundPlayEffect(100,100,0,150)
-	SoundPlayEffect(50,100,0,20)
+	--SoundPlayEffect_UO(100,100,0,150)
+	SoundPlayEffect_UO(50,100,0,20)
 	=

 	while IsSoundEffectPlaying() do =

 		SoundStep()

Modified: trunk/data/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/lib.uodragdrop.lua (original)
+++ trunk/data/lua/lib.uodragdrop.lua Sun Sep  2 16:20:30 2007
@@ -42,7 +42,7 @@
 =

 function DragDropStep()
 	if (gLeftDownItem) then
-		local iMouseX, iMouseY =3D PollInput()
+		local iMouseX, iMouseY =3D GetMousePos()
 		if (iMouseX ~=3D gLeftDownItem.iMouseX or iMouseY ~=3D gLeftDownItem.iMo=
useY) then
 			gLeftDownItem.item:grab()
 			gLeftDownItem =3D nil
@@ -55,7 +55,7 @@
 	if (gMousePickFoundHit and gMousePickFoundHit.hittype =3D=3D kMousePickHi=
tType_Dynamic) then
 		gLeftDownItem =3D {}
 		gLeftDownItem.item =3D gMousePickFoundHit.dynamic
-		gLeftDownItem.iMouseX, gLeftDownItem.iMouseY =3D PollInput()
+		gLeftDownItem.iMouseX, gLeftDownItem.iMouseY =3D GetMousePos()
 	else
 		gLeftDownItem =3D nil
 	end
@@ -76,7 +76,7 @@
 				if (gGumpmanager.CurrentMouseOverGumpObject.type =3D=3D gGumpmanager.g=
umpObjectType_Item) then
 					Send_Drop_Object( gDragDropItem.serial, hex2num(&quot;0xFFFF&quot;), hex2num(&quot;0=
xFFFF&quot;), 0, gGumpmanager.CurrentMouseOverGumpObject.serial )
 				else
-					local iMouseX, iMouseY =3D PollInput()
+					local iMouseX, iMouseY =3D GetMousePos()
 					Send_Drop_Object( gDragDropItem.serial, iMouseX-Gump.x+gDragDropItem.=
offx, iMouseY-Gump.y+gDragDropItem.offy, 0, Gump.contserial )
 				end
 			elseif (Gump.name =3D=3D &quot;paperdoll&quot;) then

Modified: trunk/data/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/main.lua (original)
+++ trunk/data/lua/main.lua Sun Sep  2 16:20:30 2007
@@ -2,10 +2,14 @@
 --###        CONSTANTS        ###
 --###############################
 =

-datapath =3D &quot;../data/&quot;
+gMainWorkingDir =3D GetMainWorkingDir and GetMainWorkingDir() or &quot;&quot;
+datapath =3D gMainWorkingDir..&quot;data/&quot;
 libpath =3D datapath..&quot;lua/&quot;
+lugreluapath =3D gMainWorkingDir..(file_exists(gMainWorkingDir..&quot;mylugre&quot;)=
 and &quot;mylugre/lua/&quot; or &quot;lugre/lua/&quot;)
 gConfigPath 		=3D datapath..&quot;config.lua&quot;
 gConfigPathFallback	=3D datapath..&quot;config.lua.dist&quot;
+gSecondsSinceLastFrame =3D 0
+
 gInGameStarted =3D false
 gNet_State =3D false
 =

@@ -15,8 +19,19 @@
 --###############################
 =

 -- utils first
-dofile(libpath .. &quot;lib.util.lua&quot;)
-dofile(libpath .. &quot;lib.listener.lua&quot;)
+print(&quot;MainWorkingDir&quot;,gMainWorkingDir)
+print(&quot;lugreluapath&quot;,lugreluapath)
+dofile(lugreluapath .. &quot;lugre.lua&quot;)
+lugre_include_libs(lugreluapath)
+dofile(libpath .. &quot;lib.sound.iris.lua&quot;)
+dofile(libpath .. &quot;lib.gui.iris.lua&quot;)
+dofile(libpath .. &quot;lib.input.iris.lua&quot;)
+dofile(libpath .. &quot;lib.keybinds.lua&quot;)
+dofile(libpath .. &quot;lib.plaingui.iris.lua&quot;)
+
+dofile(libpath .. &quot;lib.xml.lua&quot;)
+dofile(libpath .. &quot;lib.net.lua&quot;)
+ =

 =

 -- renderer second
 gRendererList =3D {}
@@ -35,35 +50,24 @@
 end
 =

 dofile(libpath .. &quot;lib.renderer.lua&quot;)
-dofile(libpath .. &quot;lib.time.lua&quot;)
-dofile(libpath .. &quot;lib.cam.lua&quot;)
 dofile(libpath .. &quot;lib.uoids.lua&quot;)
-dofile(libpath .. &quot;lib.input.lua&quot;)
 dofile(libpath .. &quot;lib.season.lua&quot;)
 dofile(libpath .. &quot;lib.terrain.lua&quot;)
 dofile(libpath .. &quot;lib.static.lua&quot;)
-dofile(libpath .. &quot;lib.xml.lua&quot;)
-dofile(libpath .. &quot;lib.gui.lua&quot;)
-dofile(libpath .. &quot;lib.guimaker.lua&quot;)
-dofile(libpath .. &quot;lib.plaingui.lua&quot;)
 dofile(libpath .. &quot;lib.compass.lua&quot;)
 dofile(libpath .. &quot;lib.gfm.lua&quot;)
-dofile(libpath .. &quot;lib.net.lua&quot;)
 dofile(libpath .. &quot;lib.oldiristest.lua&quot;)
 dofile(libpath .. &quot;lib.protocol.lua&quot;)
 dofile(libpath .. &quot;lib.mousepick.lua&quot;)
 dofile(libpath .. &quot;lib.gumpparser.lua&quot;)
 dofile(libpath .. &quot;lib.data.lua&quot;)
 dofile(libpath .. &quot;lib.cliloc.lua&quot;)
-dofile(libpath .. &quot;lib.edittext.lua&quot;)
 dofile(libpath .. &quot;lib.journal.lua&quot;)
-dofile(libpath .. &quot;lib.fadelines.lua&quot;)
 dofile(libpath .. &quot;lib.walking2.lua&quot;)
 dofile(libpath .. &quot;lib.skill.lua&quot;)
 dofile(libpath .. &quot;lib.spellbooks.lua&quot;)
 dofile(libpath .. &quot;lib.speech.lua&quot;)
 dofile(libpath .. &quot;lib.models.lua&quot;)
-dofile(libpath .. &quot;lib.sound.lua&quot;)
 dofile(libpath .. &quot;lib.test.lua&quot;)
 dofile(libpath .. &quot;lib.filepath.lua&quot;)
 dofile(libpath .. &quot;lib.loading.lua&quot;)
@@ -93,6 +97,11 @@
 --can be removed from release
 dofile(libpath .. &quot;lib.meshexporter.lua&quot;)
 =

+
+--###############################
+--###        CONFIG           ###
+--###############################
+
 dofile(gConfigPathFallback)
 if (file_exists(gConfigPath)) then
 	-- execute local config
@@ -111,12 +120,61 @@
 end
 =

 --###############################
+--###     GUI STYLES          ###
+--###############################
+gGuiDefaultStyleSet =3D &quot;ray&quot;
+glGuiMakerStyleSet[&quot;sfz&quot;] =3D {
+window =3D {
+		material=3D&quot;ui_window&quot;,size=3D64,x=3D0,y=3D0,
+		cx1=3D11,cy1=3D11,cx2=3D10,cy2=3D10,cx3=3D11,cy3=3D11,
+		dx=3D0,dy=3D32,border=3D11,clipborder=3D11
+	},
+button =3D {
+		material=3D&quot;ui_window&quot;,size=3D64,x=3D32,y=3D0,
+		cx1=3D5,cy1=3D5,cx2=3D22,cy2=3D22,cx3=3D5,cy3=3D5,
+		dx=3D0,dy=3D32,border=3D5,clipborder=3D5
+	},
+border =3D {
+		material=3D&quot;ui_window&quot;,size=3D64,x=3D32,y=3D0,
+		cx1=3D5,cy1=3D5,cx2=3D22,cy2=3D22,cx3=3D5,cy3=3D5,
+		dx=3D0,dy=3D32,border=3D5,clipborder=3D5
+	},
+default =3D {
+		material=3D&quot;ui_window&quot;,size=3D64,x=3D32,y=3D0,
+		cx1=3D5,cy1=3D5,cx2=3D22,cy2=3D22,cx3=3D5,cy3=3D5,
+		dx=3D0,dy=3D32,border=3D5,clipborder=3D5
+	},
+}
+glGuiMakerStyleSet[&quot;ray&quot;] =3D {
+default =3D {
+		material=3D&quot;ui_ray_border&quot;,size=3D32,x=3D0,y=3D0,
+		cx1=3D12,cy1=3D12,cx2=3D8,cy2=3D8,cx3=3D12,cy3=3D12,
+		dx=3D0,dy=3D0,border=3D12,clipborder=3D2
+	},
+window =3D {
+		material=3D&quot;ui_ray_window&quot;,size=3D128,x=3D0,y=3D0,
+		cx1=3D18,cy1=3D28,cx2=3D104,cy2=3D86,cx3=3D6,cy3=3D14,
+		dx=3D0,dy=3D0,
+		border_l=3D18,border_r=3D6,border_t=3D28,border_b=3D14,
+		clipborder_l=3D7,clipborder_r=3D7,clipborder_t=3D29,clipborder_b=3D15
+	},
+button =3D {
+		material=3D&quot;ui_ray_button&quot;,size=3D128,x=3D0,y=3D0,
+		cx1=3D8,cy1=3D8,cx2=3D112,cy2=3D9,cx3=3D8,cy3=3D8,
+		dx=3D0,dy=3D32,border=3D8,
+		clipborder_l=3D8,clipborder_r=3D5,
+		clipborder_t=3D3,clipborder_b=3D3
+	},
+}
+
+--###############################
 --###        FUNCTIONS        ###
 --###############################
 =

 --- called from c right before Main() for every commandline argument
 gCommandLineArguments =3D {}
-function CommandLineArgument (i,s) gCommandLineArguments[i] =3D s end
+gCommandLineSwitches =3D {}
+function CommandLineArgument (i,s) gCommandLineArguments[i] =3D s gCommand=
LineSwitches[s] =3D i end
 =

 -- checks if iris has found the uo directory and displays an error box if =
not
 function CheckUODir ()
@@ -174,7 +232,8 @@
 	=

 	LoadingProfile(&quot;initializing Ogre&quot;,true)
 	gPreOgreTime =3D gLoadingProfileLastTime
-	if (not InitOgre()) then Exit() end
+	if (not InitOgre(&quot;Iris2&quot;)) then Exit() end
+	SetCursorBaseOffset(0,0)
 =

 	-- set global shadow settings
 	if (gEnableShadows) then
@@ -199,6 +258,7 @@
 	SetLoadingBackground()
 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
 =

+	NotifyListener(&quot;Hook_PreLoad&quot;)
 	PreLoad()
 =

 	gCurrentRenderer:PreInit()
@@ -244,9 +304,12 @@
 =

 -- called every frame, after all timer-steppers, see Step() in lib.time.lua
 function MainStep (curticks)
+	gSecondsSinceLastFrame =3D (curticks - gMyTicks) / 1000.0
 	gMyTicks =3D curticks
 	UpdateStats(curticks)
 	StepTimer(curticks)
+	StepFadeLines()
+	gui.StepMoveDialog()
 	--TestGuiSystem2_Step()
 =

 	NetStep()
@@ -266,7 +329,11 @@
 =

 	StepDebugMenu()
 	gui.Step()
-
+	InputStep() -- generate mouse_left_drag_* and mouse_left_click_single eve=
nts =

+	GUIStep() -- generate mouse_enter, mouse_leave events (might adjust curso=
r -&gt; before CursorStep)
+	CursorStep()
+
+	NotifyListener(&quot;Hook_MainStep&quot;)
 	NotifyListener( &quot;EveryFrame&quot; )
 	=

 	Client_RenderOneFrame()

Modified: trunk/data/lua/net.cursor.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.cursor.lua (original)
+++ trunk/data/lua/net.cursor.lua Sun Sep  2 16:20:30 2007
@@ -27,10 +27,7 @@
 	local isFirst =3D not gui.cursorGfx2D
 	if (not gui.cursorGfx2D) then
 		gui.cursorGfx2D =3D GetCursorGfx2D()
-		gui.cursorGfx2D:InitCCPO()
-		gui.cursorGfx2D:SetAlignment(kGfx2DAlign_Left,kGfx2DAlign_Top)
-		=

-	=

+		=

 		-- init dragicon holder
 		if (true) then
 			gui.cursorGfx2D_DragIcon =3D CreateGfx2D()

Modified: trunk/data/lua/net.popup.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.popup.lua (original)
+++ trunk/data/lua/net.popup.lua Sun Sep  2 16:20:30 2007
@@ -22,7 +22,7 @@
 	--- if there is already one open, close it
 	if gPopupMenu ~=3D nil then gPopupMenu:Close() end
 =

-	gPopupMenuSavedPosX,gPopupMenuSavedPosY =3D PollInput() -- TODO : maybe s=
ave mousepos at the time of contextrequest ?
+	gPopupMenuSavedPosX,gPopupMenuSavedPosY =3D GetMousePos() -- TODO : maybe=
 save mousepos at the time of contextrequest ?
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Generic_Command)
 	out:PushNetUint16(hex2num(&quot;0x09&quot;)) -- packet size

Modified: trunk/data/lua/net.sound.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.sound.lua (original)
+++ trunk/data/lua/net.sound.lua Sun Sep  2 16:20:30 2007
@@ -10,7 +10,7 @@
 	local y =3D input:PopNetUint16()
 	local z =3D input:PopNetUint16()
 	printdebug(&quot;sound&quot;,sprintf(&quot;NET: kPacket_Sound: effect: %i singular: %i x=
:<i> %i y: %i z: %i\n&quot;,effect,singular,x,y,z))
</I>-	SoundPlayEffect(x,y,z * 0.1,effect)
+	SoundPlayEffect_UO(x,y,z * 0.1,effect)
 end
 =

 -- ProtocolRecv_Play_Midi

Modified: trunk/data/lua/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.uodragdrop.lua (original)
+++ trunk/data/lua/net.uodragdrop.lua Sun Sep  2 16:20:30 2007
@@ -65,7 +65,7 @@
 	offx =3D offx or (-w / 2)
 	offy =3D offy or (-h / 2)
 	=

-	--local iMouseX,iMouseY =3D PollInput()
+	--local iMouseX,iMouseY =3D GetMousePos()
 	--local offx =3D widget.gfx:GetDerivedLeft() - iMouseX =

 	--local offy =3D widget.gfx:GetDerivedTop() - iMouseY
 	--local mat =3D GetGumpMat(gumpid)
@@ -81,7 +81,7 @@
 	local iArtID =3D item.artid + hex2num(&quot;0x4000&quot;)
 	local mat =3D GetArtMat(iArtID,item.hue)
 	local w,h =3D GetArtSize(iArtID)
-	local iMouseX,iMouseY =3D PollInput()
+	local iMouseX,iMouseY =3D GetMousePos()
 	local offx =3D widget.gfx:GetDerivedLeft() - iMouseX =

 	local offy =3D widget.gfx:GetDerivedTop() - iMouseY
 	=

@@ -117,14 +117,14 @@
 	gDragDrop.h =3D h
 	gDragDrop.offx =3D offx
 	gDragDrop.offy =3D offy
-	gDragDrop.iMouseX,gDragDrop.iMouseY =3D PollInput()
+	gDragDrop.iMouseX,gDragDrop.iMouseY =3D GetMousePos()
 	gDragDrop.started =3D false
 end
 =

 function StepUODragDrop () =

 	-- start dragdrop if the mouse is dragged for a minimum distance
 	if (gDragDrop and (not gDragDrop.started)) then =

-		local iMouseX,iMouseY =3D PollInput()
+		local iMouseX,iMouseY =3D GetMousePos()
 		local dx =3D gDragDrop.iMouseX - iMouseX
 		local dy =3D gDragDrop.iMouseY - iMouseY
 		local sqdist =3D dx*dx + dy*dy
@@ -167,7 +167,7 @@
 	-- TODO better amount handling
 	local amount =3D gDragDrop.item.amount
 	-- take only half the amount if shift is pressed
-	if gbAltDown and amount then amount =3D math.floor(amount / 2) end
+	if gKeyPressed[key_lalt] and amount then amount =3D math.floor(amount / 2=
) end
 	=

 	Send_Take_Object(gDragDrop.item.serial,amount)
 	gui.bMouseBlocked =3D true
@@ -218,7 +218,7 @@
 	=

 	if (dialog_under_mouse) then
 		if (dialog_under_mouse.rootwidget) then
-			local iMouseX,iMouseY =3D PollInput()
+			local iMouseX,iMouseY =3D GetMousePos()
 			x =3D iMouseX - dialog_under_mouse.rootwidget.gfx:GetDerivedLeft() + gD=
ragDrop.offx
 			y =3D iMouseY - dialog_under_mouse.rootwidget.gfx:GetDerivedTop() + gDr=
agDrop.offy
 		end

Modified: trunk/data/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/lua/net.walk.lua (original)
+++ trunk/data/lua/net.walk.lua Sun Sep  2 16:20:30 2007
@@ -129,14 +129,14 @@
 gFollowMobile =3D 0
 function WalkStep ()
 	-- runnung if shift is pressed
-	gWalk_Running =3D not gbShiftDown
+	gWalk_Running =3D not gKeyPressed[key_lshift]
 	=

 	-- handle keys if not in menu
 	if not gActiveEditText then
-		if gKeyUpDown then WalkForward() end
-		if gKeyDownDown then WalkTurn(4) end
-		if gKeyLeftDown then WalkTurn(-1) end
-		if gKeyRightDown then WalkTurn(1) end
+		if gKeyPressed[key_up]		then WalkForward() end
+		if gKeyPressed[key_down]	then WalkTurn( 4) end
+		if gKeyPressed[key_left]	then WalkTurn(-1) end
+		if gKeyPressed[key_right]	then WalkTurn( 1) end
 	end
 	=

 	-- follow target
@@ -151,7 +151,7 @@
 	=

 	-- right click pressed walk
 	=

-	if gMouseButtonDown_Right and gMouseWalkOnPressed then =

+	if gKeyPressed[key_mouse2] and gMouseWalkOnPressed then =

 		-- walk to the cursor
 		--[[if (gNextAutoWalkCheck &lt; gMyTicks) then
 			SetAutoWalkTarget()
@@ -161,7 +161,7 @@
 		=

 		if (not GetWidgetUnderMouse()) then
 			-- walk into the direction of the cursor
-			local mx, my =3D PollInput()
+			local mx, my =3D GetMousePos()
 			local vw, vh =3D GetViewportSize()
 		=

 			local Phi =3D gCurrentRenderer:TranslateOsiWalkAngle(math.atan2( my-vh/=
2.0, mx-vw/2.0 ) / gfDeg2Rad + 450.0)

Modified: trunk/include/builder.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/builder.h (original)
+++ trunk/include/builder.h Sun Sep  2 16:20:30 2007
@@ -4,15 +4,17 @@
 #include &lt;Ogre.h&gt;
 #include &lt;OgreVector3.h&gt;
 #include &lt;string&gt;
-#include &lt;smartptr.h&gt;
+#include &quot;lugre_smartptr.h&quot;
 #include &quot;data.h&quot;
 =

 class 	lua_State;
 void	LuaRegisterBuilder 	(lua_State *L);
 =

+namespace Lugre {
+	class cOgreUserObjectWrapper;
+};
 =

-class cOgreUserObjectWrapper;
-class cMeshEntity : public cSmartPointable { public:
+class cMeshEntity : public Lugre::cSmartPointable { public:
 	Ogre::Entity*			mpOgreEntity;
 	cOgreUserObjectWrapper* mpUserObject;
 	=

@@ -33,9 +35,11 @@
 class cArtMapLoader;
 class cGumpLoader;
 class cTexMapLoader;
-class cBitMask;
 class cHueLoader;
 =

+namespace Lugre {
+	class cBitMask;
+};
 =

 void	WriteMapImageToFile	(cGroundBlockLoader&amp; oGroundBlockLoader,cRadarCol=
orLoader&amp; radarColors,cStaticBlockLoader* pStaticBlockLoader,const char* sz=
OutPath,const bool bBig);
 Ogre::TexturePtr	GenerateRadarImageRaw (int iPosX, int iPosY, cGroundBlock=
Loader&amp; oGroundBlockLoader, cStaticBlockLoader&amp; oStaticBlockLoader, cRadarC=
olorLoader&amp; oRadarColorLoader, const char* szMatName);

Modified: trunk/include/data.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data.h (original)
+++ trunk/include/data.h Sun Sep  2 16:20:30 2007
@@ -13,7 +13,7 @@
 #include &lt;iostream&gt;
 #include &lt;fstream&gt;
 #include &lt;stdexcept&gt;
-#include &quot;smartptr.h&quot;
+#include &quot;lugre_smartptr.h&quot;
 =

 /// ids below this are for ground-tiletypes, above this are for static-til=
etypes, 0x00004000 =3D 32*512
 #define TILETYPE_STATIC_ID_START 0x00004000
@@ -33,6 +33,9 @@
 // GCC packed attribute
 #define STRUCT_PACKED	__attribute__ ((packed))
 #endif
+
+
+using namespace Lugre;
 =

 class FileNotFoundException : public std::runtime_error { public:
 	FileNotFoundException(const std::string&amp; sFilePath) : std::runtime_error(=
&quot;FileNotFoundException : &quot;+sFilePath) { }
@@ -213,7 +216,7 @@
 // ***** ***** ***** ***** ***** cUniFontFileLoader
 =

 	/// loads a complete uo unifont, =

-	class cUniFontFileLoader : public cFullFileLoader, public cSmartPointable=
 { public :
+	class cUniFontFileLoader : public cFullFileLoader, public Lugre::cSmartPo=
intable { public :
 		cUniFontFileLoader				(const char* szFile);
 		// returns the number of letters in the file
 		const int GetLetterNumbers();
@@ -290,7 +293,7 @@
 	};
 =

 	/// abstract base class
-	class cGroundBlockLoader : public cSmartPointable { public :
+	class cGroundBlockLoader : public Lugre::cSmartPointable { public :
 		int				miMapW;
 		int				miMapH;
 		cGroundBlockLoader						(const int iMapH);
@@ -354,7 +357,7 @@
 	};
 	=

 	/// abstract base class
-	class cStaticBlockLoader : public cSmartPointable { public :
+	class cStaticBlockLoader : public Lugre::cSmartPointable { public :
 		int				miMapW;
 		int				miMapH;
 		cStaticBlockLoader						(const int iMapH);
@@ -405,7 +408,7 @@
 	=

 	=

 	/// abstract base class
-	class cTileTypeLoader : public cSmartPointable { public :
+	class cTileTypeLoader : public Lugre::cSmartPointable { public :
 		virtual	cGroundTileType*	GetGroundTileType	(const int iID) =3D 0; ///&lt; r=
esult of Get is only valid until next Get call
 		virtual	cStaticTileType*	GetStaticTileType	(const int iID) =3D 0; ///&lt; r=
esult of Get is only valid until next Get call
 		virtual	int					GetEndID			() =3D 0; ///&lt; the returned id is not valid, =
some ids right before it might also be not valid
@@ -423,7 +426,7 @@
 =

 // ***** ***** ***** ***** ***** AnimData
 =

-	class cAnimDataLoader : public cSmartPointable, public cFullFileLoader { =
public :
+	class cAnimDataLoader : public Lugre::cSmartPointable, public cFullFileLo=
ader { public :
 		RawAnimData*		mpLastAnimData;		=

 		cAnimDataLoader							(const char* szFile);
 		RawAnimData*		GetAnimDataType		(const int iID);
@@ -434,7 +437,7 @@
 	=

 	/// holds a color for each tiletype to be presented on a radar or map lik=
e display
 	/// reads entire file on construction, changes raw data so that alpha bit=
 is set to opaque, so Ogre::PF_A1R5G5B5 can be used directly
-	class cRadarColorLoader : public cSmartPointable, public cFullFileLoader =
{ public:
+	class cRadarColorLoader : public Lugre::cSmartPointable, public cFullFile=
Loader { public:
 		cRadarColorLoader	(const char* szFile);
 		inline short	GetCol16	(const int iID) { return (iID &lt; 0 || iID &gt;=3D miFu=
llFileSize/sizeof(short)) ? 0 : ((short*)mpFullFileBuffer)[iID]; } 	///&lt; fo=
r Ogre::PF_A1R5G5B5
 	};
@@ -453,7 +456,7 @@
 	};
 	=

 	/// loads complete hue into one big buffer, usually around 300k, used for=
 high-speed loading of the entire hue buffer
-	class cHueLoader : public cSmartPointable, public cFullFileLoader { publi=
c :
+	class cHueLoader : public Lugre::cSmartPointable, public cFullFileLoader =
{ public :
 		cHue		mLastHue;
 		cHueLoader		(const char* szDataFile);
 		int		GetMaxHueID		();
@@ -586,7 +589,7 @@
 	};
 	=

 	/// abstract base class
-	class cTexMapLoader : public cSmartPointable { public :
+	class cTexMapLoader : public Lugre::cSmartPointable { public :
 		virtual	cTexMap*	GetTexMap	(const int iID) =3D 0; ///&lt; result of Get is =
only valid until next Get call
 	};
 	=

@@ -687,7 +690,7 @@
 	};
 	=

 	/// abstract base class
-	class cArtMapLoader : public cSmartPointable { public :
+	class cArtMapLoader : public Lugre::cSmartPointable { public :
 		virtual	cArtMap*	GetArtMap	(const int iID) =3D 0; ///&lt; result of Get is =
only valid until next Get call
 		virtual unsigned int	GetCount	() =3D 0;	///&lt; number of artmaps
 	};
@@ -710,7 +713,7 @@
 // ***** ***** ***** ***** ***** multi loader
 =

 	/// abstract base class
-	class cMultiLoader : public cSmartPointable { public :
+	class cMultiLoader : public Lugre::cSmartPointable { public :
 		virtual	unsigned int	CountMultiParts	(const int iID) =3D 0; ///&lt; number =
of parts the multi iID has
 		virtual	RawMultiPart*	GetMultiParts	(const int iID) =3D 0; ///&lt; points t=
o the startpart of the multi iID, from this CountMultiParts(iID) parts valid
 	};
@@ -766,7 +769,7 @@
 	};
 	=

 	/// abstract base class
-	class cGumpLoader : public cSmartPointable { public :
+	class cGumpLoader : public Lugre::cSmartPointable { public :
 		virtual	cGump*	GetGump	(const int iID) =3D 0; ///&lt; result of Get is only=
 valid until next Get call
 	};
 	=

@@ -799,7 +802,7 @@
 	};
 	=

 	/// abstract base class
-	class cSoundLoader : public cSmartPointable { public :
+	class cSoundLoader : public Lugre::cSmartPointable { public :
 		virtual	cSound*	GetSound	(const int iID) =3D 0; ///&lt; result of Get is on=
ly valid until next Get call
 	};
 	=

@@ -918,7 +921,7 @@
 	};
 	=

 	/// abstract base class
-	class cAnimLoader : public cSmartPointable { public :
+	class cAnimLoader : public Lugre::cSmartPointable { public :
 		int mHighDetailed;
 		int mLowDetailed;
 		cAnimLoader (const int iHighDetailed, const int iLowDetailed) {};
@@ -958,7 +961,7 @@
 	};
 	=

 	/// abstract base class
-	class cLightLoader : public cSmartPointable { public :
+	class cLightLoader : public Lugre::cSmartPointable { public :
 		virtual	cLight*		GetLight	(const int iID) =3D 0; ///&lt; result of Get is o=
nly valid until next Get call
 	};
 	=


Modified: trunk/include/grannyloader_i2.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/grannyloader_i2.h (original)
+++ trunk/include/grannyloader_i2.h Sun Sep  2 16:20:30 2007
@@ -1,14 +1,14 @@
 #ifndef GRANNYLOADER_I2_H
 #define GRANNYLOADER_I2_H
 =

-#include &quot;robstring1.2.h&quot;
-#include &quot;smartptr.h&quot;
+#include &quot;lugre_robstring.h&quot;
+#include &quot;lugre_smartptr.h&quot;
 #include &quot;grannyparser.h&quot;
 #include &lt;vector&gt;
 #include &lt;string&gt;
 =

 /// walks granny file to extract the data in a useful form
-class cGrannyLoader_i2 : public cGrannyVisitor, public cSmartPointable { p=
ublic:
+class cGrannyLoader_i2 : public cGrannyVisitor, public Lugre::cSmartPointa=
ble { public:
 	cGranny		mGranny;
 	=

 	class cSubMesh { public:

Modified: trunk/include/grannyparser.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/grannyparser.h (original)
+++ trunk/include/grannyparser.h Sun Sep  2 16:20:30 2007
@@ -1,7 +1,7 @@
 #ifndef GRANNYLOADER_H
 #define GRANNYLOADER_H
 =

-#include &quot;smartptr.h&quot;
+#include &quot;lugre_smartptr.h&quot;
 #include &lt;stdexcept&gt;
 #include &lt;string&gt;
 #include &lt;map&gt;
@@ -22,7 +22,7 @@
 =

 #define GRANNY_CHUNKTYPE_MAGIC 0xCA5E0000
 =

-
+using namespace Lugre;
 =

 class GrannyLoadException : public std::runtime_error { public:
 	GrannyLoadException(const std::string&amp; sMsg) : std::runtime_error(&quot;Granny=
LoadException : &quot;+sMsg) { }
@@ -197,7 +197,7 @@
 =

 =

 /// buffers a granny file, can be traversed using a custom cGrannyVisitor =
for the ParseGranny method
-class cGranny : public cSmartPointable { public:
+class cGranny : public Lugre::cSmartPointable { public:
 	char*		mpBuf;
 	int 		miBufSize;
 	std::string	msFilePath;

Modified: trunk/include/legacydata.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/legacydata.h (original)
+++ trunk/include/legacydata.h Sun Sep  2 16:20:30 2007
@@ -1,7 +1,7 @@
 #ifndef LEGACYDATALOADER_H
 #define LEGACYDATALOADER_H
 #include &lt;OgreVector3.h&gt;
-#include &quot;smartptr.h&quot;
+#include &quot;lugre_smartptr.h&quot;
 =

 class cArtMapLoader;
 namespace Ogre {
@@ -16,7 +16,7 @@
 /// use ogre model format and .material files instead
 =

 /// abstract base class to hide the ugly details
-class cLegacyModelAndTextureLoader : public cSmartPointable { public : =

+class cLegacyModelAndTextureLoader : public Lugre::cSmartPointable { publi=
c : =

 	static cLegacyModelAndTextureLoader*	CreateLegacyModelAndTextureLoader(co=
nst char* szFile);
 	=

 	virtual bool		HasMesh				(const int iID) =3D 0; ///&lt; check for existence =
without loading

Modified: trunk/include/ogremanualloader.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/ogremanualloader.h (original)
+++ trunk/include/ogremanualloader.h Sun Sep  2 16:20:30 2007
@@ -1,9 +1,7 @@
 #ifndef _OGREMANUALLOADER_H_
 #define _OGREMANUALLOADER_H_
 =

-#include &quot;prefix.h&quot;
-
-#include &quot;smartptr.h&quot;
+#include &quot;lugre_smartptr.h&quot;
 #include &lt;Ogre.h&gt;
 #include &quot;data.h&quot;
 =

@@ -11,7 +9,7 @@
 class lua_State;
 =

 /// manual resource loader for creating art materials on the fly
-class cManualArtMaterialLoader : public Ogre::ManualResourceLoader, public=
 cSmartPointable {
+class cManualArtMaterialLoader : public Ogre::ManualResourceLoader, public=
 Lugre::cSmartPointable {
 public:
 	cManualArtMaterialLoader (const char *format, const char *material_base, =
cArtMapLoader *pArtMapLoader,bool bPixelExact,bool bInvertY,bool bInvertX);
 	virtual ~cManualArtMaterialLoader ();

Modified: trunk/include/radar.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/radar.h (original)
+++ trunk/include/radar.h Sun Sep  2 16:20:30 2007
@@ -5,7 +5,7 @@
 #include &lt;map&gt;
 #include &lt;utility&gt;
 =

-class dRadar : public cSmartPointable { =

+class dRadar : public Lugre::cSmartPointable { =

 private :
 	cSpriteManager* mSpriteManager;
 =


Modified: trunk/include/spritemanager.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/spritemanager.h (original)
+++ trunk/include/spritemanager.h Sun Sep  2 16:20:30 2007
@@ -1,8 +1,8 @@
 #ifndef _SPRITEMANAGER_H_
 #define _SPRITEMANAGER_H_
 =

-#include &quot;smartptr.h&quot;
-#include &quot;robrenderable.h&quot;
+#include &quot;lugre_smartptr.h&quot;
+#include &quot;lugre_robrenderable.h&quot;
 =

 #include &lt;Ogre.h&gt;
 #include &lt;OgreRenderQueueListener.h&gt;
@@ -15,11 +15,13 @@
 class cSpriteQueue;
 class lua_State;
 =

+using namespace Lugre;
+
 struct Normal {
 	double x, y, z;
 };
 =

-class cBaseSprite : public cSmartPointable {
+class cBaseSprite : public Lugre::cSmartPointable {
 	protected :
 		cSpriteQueue* mSpriteQueue;
 		int mPrio[6];
@@ -295,7 +297,7 @@
 		virtual void Execute( double ViewPortWidthHalf, double ViewPortHeightHal=
f, double xOffset, double yOffset );
 };
 =

-class cSpriteQueue : public cSmartPointable {
+class cSpriteQueue : public Lugre::cSmartPointable {
 	private :
 		cSpriteManager* mSpriteManager;
 		std::list&lt;cBaseSprite*&gt; mSpriteList;
@@ -337,7 +339,7 @@
 		void RemoveSprite( cBaseSprite* Sprite );
 };
 =

-class cSpriteManager : public Ogre::RenderQueueListener, public cSmartPoin=
table {
+class cSpriteManager : public Ogre::RenderQueueListener, public Lugre::cSm=
artPointable {
 	private :
 		std::map&lt; int, cSpriteQueue*&gt; mSpriteQueues;
 		=


Modified: trunk/src/builder.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/builder.cpp (original)
+++ trunk/src/builder.cpp Sun Sep  2 16:20:30 2007
@@ -1,15 +1,18 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;builder.h&quot;
 #include &quot;data.h&quot;
-#include &quot;ogrewrapper.h&quot;
-#include &quot;scripting.h&quot;
-#include &quot;bitmask.h&quot;
-#include &quot;robstring1.2.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
+#include &quot;lugre_scripting.h&quot;
+#include &quot;lugre_bitmask.h&quot;
+#include &quot;lugre_robstring.h&quot;
 #include &lt;Ogre.h&gt;
 #include &lt;OgreFont.h&gt;
 #include &lt;OgreFontManager.h&gt;
 #include &lt;OgreBitwise.h&gt;
 #include &lt;map&gt;
+
+
+using namespace Lugre;
 =

 /// color format conversion from Ogre::PF_A1R5G5B5 to Ogre::PF_A8R8G8B8
 /// maps [0x00,0x1f] to [0x00,0xff] for rgb

Modified: trunk/src/builder_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/builder_L.cpp (original)
+++ trunk/src/builder_L.cpp Sun Sep  2 16:20:30 2007
@@ -1,10 +1,10 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;data.h&quot;
-#include &quot;scripting.h&quot;
-#include &quot;luabind.h&quot;
+#include &quot;lugre_scripting.h&quot;
+#include &quot;lugre_luabind.h&quot;
 #include &quot;builder.h&quot;
-#include &quot;ogrewrapper.h&quot;
-#include &quot;input.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
+#include &quot;lugre_input.h&quot;
 #include &lt;Ogre.h&gt;
 =

 extern &quot;C&quot; {
@@ -12,6 +12,9 @@
 	#include &quot;lauxlib.h&quot;
 	#include &quot;lualib.h&quot;
 }
+
+
+using namespace Lugre;
 =

 =

 cMeshEntity::cMeshEntity(const char* szMeshName) : mpOgreEntity(0), mpUser=
Object(0) {

Modified: trunk/src/data.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data.cpp (original)
+++ trunk/src/data.cpp Sun Sep  2 16:20:30 2007
@@ -1,4 +1,4 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;data.h&quot;
 #include &lt;stdio.h&gt;
 #include &quot;tinyxml.h&quot;
@@ -7,7 +7,10 @@
 #include &lt;fstream&gt;
 #include &lt;Ogre.h&gt;
 #include &lt;OgreCodec.h&gt;
-#include &quot;robstring1.2.h&quot;
+#include &quot;lugre_robstring.h&quot;
+
+
+using namespace Lugre;
 =

 =

 /*

Modified: trunk/src/data_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data_L.cpp (original)
+++ trunk/src/data_L.cpp Sun Sep  2 16:20:30 2007
@@ -1,11 +1,11 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;data.h&quot;
-#include &quot;scripting.h&quot;
-#include &quot;luabind.h&quot;
-#include &quot;ogrewrapper.h&quot;
+#include &quot;lugre_scripting.h&quot;
+#include &quot;lugre_luabind.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
 #include &quot;builder.h&quot;
-#include &quot;bitmask.h&quot;
-#include &quot;sound.h&quot;
+#include &quot;lugre_bitmask.h&quot;
+#include &quot;lugre_sound.h&quot;
 #include &lt;string&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;map&gt;
@@ -15,6 +15,9 @@
 	#include &quot;lauxlib.h&quot;
 	#include &quot;lualib.h&quot;
 }
+
+
+using namespace Lugre;
 =

 class cGroundBlockLoader_L : public cLuaBind&lt;cGroundBlockLoader&gt; { public:
 	// implementation of cLuaBind

Modified: trunk/src/granny_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/granny_L.cpp (original)
+++ trunk/src/granny_L.cpp Sun Sep  2 16:20:30 2007
@@ -1,10 +1,10 @@
-#include &quot;prefix.h&quot;
-#include &quot;luabind.h&quot;
+#include &quot;lugre_prefix.h&quot;
+#include &quot;lugre_luabind.h&quot;
 #include &quot;grannyparser.h&quot;
 #include &quot;grannyloader_i2.h&quot;
 #include &quot;grannyogreloader.h&quot;
-#include &quot;ogrewrapper.h&quot;
-#include &quot;smartptr.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
+#include &quot;lugre_smartptr.h&quot;
 #include &lt;Ogre.h&gt;
 =

 extern &quot;C&quot; {
@@ -12,6 +12,9 @@
 	#include &quot;lauxlib.h&quot;
 	#include &quot;lualib.h&quot;
 }
+
+
+using namespace Lugre;
 =

 =

 =


Modified: trunk/src/grannydump.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/grannydump.cpp (original)
+++ trunk/src/grannydump.cpp Sun Sep  2 16:20:30 2007
@@ -1,7 +1,10 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &lt;stdio.h&gt;
 #include &quot;grannyparser.h&quot;
 #include &quot;grannyloader_i2.h&quot;
+
+
+using namespace Lugre;
 =

 /// utility for debugging, prints the granny into a (somewhat) human reada=
ble form
 /// also useful as an example for how to implement a visitor

Modified: trunk/src/grannyloader_i2.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/grannyloader_i2.cpp (original)
+++ trunk/src/grannyloader_i2.cpp Sun Sep  2 16:20:30 2007
@@ -1,5 +1,8 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;grannyloader_i2.h&quot;
+
+
+using namespace Lugre;
 =

 =

 cGrannyLoader_i2::cGrannyLoader_i2	(const char* szFilePath) : =


Modified: trunk/src/grannyogreloader.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/grannyogreloader.cpp (original)
+++ trunk/src/grannyogreloader.cpp Sun Sep  2 16:20:30 2007
@@ -1,8 +1,8 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;grannyparser.h&quot;
 #include &quot;grannyloader_i2.h&quot;
 #include &quot;grannyogreloader.h&quot;
-#include &quot;fifo.h&quot;
+#include &quot;lugre_fifo.h&quot;
 #undef min
 #undef max
 #include &lt;Ogre.h&gt;
@@ -10,7 +10,10 @@
 #include &lt;algorithm&gt;
 #include &lt;vector&gt;
 #include &lt;map&gt;
-#include &quot;scripting.h&quot;
+#include &quot;lugre_scripting.h&quot;
+
+
+using namespace Lugre;
 =

 //void myassert( bool cond, const char* szmessage ) { if (!cond) { printf(=
 &quot;assert: %s\n&quot;, szmessage ); exit( 0 ); } }
 =


Modified: trunk/src/grannyparser.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/grannyparser.cpp (original)
+++ trunk/src/grannyparser.cpp Sun Sep  2 16:20:30 2007
@@ -1,12 +1,15 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &lt;stdio.h&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;iostream&gt;
 #include &lt;algorithm&gt;
 #include &lt;functional&gt;
 #include &lt;fstream&gt;
-#include &quot;robstring1.2.h&quot;
+#include &quot;lugre_robstring.h&quot;
 #include &quot;grannyparser.h&quot;
+
+
+using namespace Lugre;
 =

 =

 // ***** ***** ***** ***** ***** cGrannyParent

Modified: trunk/src/legacydata.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/legacydata.cpp (original)
+++ trunk/src/legacydata.cpp Sun Sep  2 16:20:30 2007
@@ -1,8 +1,11 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;legacydata.h&quot;
 #include &quot;builder.h&quot;
 #include &quot;pathsearch.h&quot;
 #include &quot;data.h&quot;
+
+
+using namespace Lugre;
 =

 =

 #define COLOR_KEY_TOLERANCE_OLDIRIS1	1000
@@ -34,9 +37,9 @@
 #include &lt;vector&gt;
 #include &lt;stdexcept&gt;
 =

-#include &quot;robstring1.2.h&quot;
-#include &quot;ogrewrapper.h&quot;
-#include &quot;scripting.h&quot;
+#include &quot;lugre_robstring.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
+#include &quot;lugre_scripting.h&quot;
 #include &lt;Ogre.h&gt;
 #include &lt;OgreFreeImageCodec.h&gt;
 #include &lt;OgrePrerequisites.h&gt;

Modified: trunk/src/main.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/main.cpp (original)
+++ trunk/src/main.cpp Sun Sep  2 16:20:30 2007
@@ -1,207 +1,49 @@
-#include &quot;prefix.h&quot;
-#include &quot;Ogre.h&quot;
-
-#include &quot;shell.h&quot;
-#include &quot;game.h&quot;
-
-#include &lt;time.h&gt;
-#include &lt;signal.h&gt; // seems to be crossplatform
-
-
-void DisplayErrorMessage	(const char* szMsg);
-void MySignalHandler		(int a);
-void MyCrash				(const char* szMessage);
-
-#if OGRE_PLATFORM =3D=3D OGRE_PLATFORM_WIN32
+#include &quot;lugre_prefix.h&quot;
+#include &quot;lugre_robstring.h&quot;
+#include &quot;lugre_main.h&quot;
+#ifdef WIN32
 #define WIN32_LEAN_AND_MEAN
 #include &quot;windows.h&quot;
-
-#define WIN32_CONSOLE_APP
-
-/*
-#include &lt;ctype.h&gt;
-#include &lt;iostream&gt;
-#include &quot;OgreException.h&quot;
-*/
-
-#include &lt;stdio.h&gt;
-#include &lt;fcntl.h&gt;
-#include &lt;io.h&gt;
-#include &lt;iostream&gt;
-#include &lt;string&gt;
-#include &lt;vector&gt;
-#include &lt;stdexcept&gt;
-
-#ifndef WIN32_CONSOLE_APP
-void showWin32Console()
-{ PROFILE
-	static const WORD MAX_CONSOLE_LINES =3D 500;
-	int hConHandle;
-	long lStdHandle;
-	CONSOLE_SCREEN_BUFFER_INFO coninfo;
-	FILE *fp;
-	// allocate a console for this app
-	AllocConsole();
-	// set the screen buffer to be big enough to let us scroll text
-	GetConsoleScreenBufferInfo(GetStdHandle(STD_OUTPUT_HANDLE), &amp;coninfo);
-	coninfo.dwSize.Y =3D MAX_CONSOLE_LINES;
-	SetConsoleScreenBufferSize(GetStdHandle(STD_OUTPUT_HANDLE),
-	coninfo.dwSize);
-	// redirect unbuffered STDOUT to the console
-	lStdHandle =3D (long)GetStdHandle(STD_OUTPUT_HANDLE);
-	hConHandle =3D _open_osfhandle(lStdHandle, _O_TEXT);
-	fp =3D _fdopen( hConHandle, &quot;w&quot; );
-	*stdout =3D *fp;
-	setvbuf( stdout, NULL, _IONBF, 0 );
-	// redirect unbuffered STDIN to the console
-	lStdHandle =3D (long)GetStdHandle(STD_INPUT_HANDLE);
-	hConHandle =3D _open_osfhandle(lStdHandle, _O_TEXT);
-	fp =3D _fdopen( hConHandle, &quot;r&quot; );
-	*stdin =3D *fp;
-	setvbuf( stdin, NULL, _IONBF, 0 );
-	// redirect unbuffered STDERR to the console
-	lStdHandle =3D (long)GetStdHandle(STD_ERROR_HANDLE);
-	hConHandle =3D _open_osfhandle(lStdHandle, _O_TEXT);
-	fp =3D _fdopen( hConHandle, &quot;w&quot; );
-	*stderr =3D *fp;
-	setvbuf( stderr, NULL, _IONBF, 0 );
-	// make cout, wcout, cin, wcin, wcerr, cerr, wclog and clog
-	// point to console as well
-	std::ios::sync_with_stdio();
-}
 #endif
 =

+#define PATH_MAIN_LUA		LUGRE_PATH(&quot;data/lua/main.lua&quot;)
+#define PATH_LUGRE_LUA		LUGRE_PATH(&quot;lugre/lua&quot;)
 =

-#ifdef WIN32_CONSOLE_APP
-int main(int argc, char* argv[])
+using namespace Lugre;
+
+void	Iris_RegisterLuaPlugin	();
+
+// #define USE_WINMAIN
+
+#ifdef USE_WINMAIN
+INT WINAPI	WinMain		(HINSTANCE hInst, HINSTANCE hPrevInstance, LPSTR strCm=
dLine,int nCmdShow) { // nCmdShow : show state of window
 #else
-INT WINAPI WinMain( HINSTANCE hInst, HINSTANCE hPrevInstance, LPSTR strCmd=
Line,int nCmdShow)
+int			main		(int argc, char* argv[]) {
 #endif
-{ PROFILE
-    //int nCmdShow 	// show state of window
-	#ifndef WIN32_CONSOLE_APP
-
-    //generate posix like argc/argv
-	const char* szCommandLineWithProgrammName =3D GetCommandLine();
-    printf(&quot;parsing cmdline: %s\n&quot;,GetCommandLine());
-	std::vector&lt;std::string&gt; myCmdLineParams;
-	const char* szCmdLineSep =3D &quot; \t&quot;;
-	for (const char* r=3DszCommandLineWithProgrammName;*r;) {
-		int len =3D strcspn(r,szCmdLineSep);
-		myCmdLineParams.push_back(std::string(r,len));
-		r +=3D len;
-		r +=3D strspn(r,szCmdLineSep);
-	}
-
-	int i;
-    int argc =3D myCmdLineParams.size();
-    char **argv =3D (char**)malloc(argc * sizeof(char*));
-	for (i=3D0;i&lt;argc;++i) argv[i] =3D strdup(myCmdLineParams[i].c_str());
-	//for (i=3D0;i&lt;argc;++i) printf(&quot;cmdline %d =3D %s\n&quot;,i,argv[i]);
-
-	if (true || std::string(strCmdLine).find(&quot;-c&quot;) !=3D -1) { // always enabl=
ed until we have fully functional error output without console
-		#ifdef SET_TERM_HANDLER
-		SET_TERM_HANDLER;
-		#endif
-		showWin32Console();
-	}
-	#endif
-
-#else
-int main(int argc, char *argv[])
-{ PROFILE
-#endif
-
-	// see <A HREF="http://msdn.microsoft.com/library/default.asp?url=3D/library/en-us=">http://msdn.microsoft.com/library/default.asp?url=3D/library/en-us=</A>
/vclib/html/_crt_signal.asp for details
-	signal(SIGSEGV,MySignalHandler); // seems to be cross platform
-
-    try {
-        cShell&amp; shell =3D cShell::GetSingleton();
-
-        shell.Init(argc,argv);
-
-		cGame::GetSingleton().Run(argc,argv);
-		=

-        shell.DeInit();
-
-    } catch( Ogre::Exception&amp; e ) {
-		printf(&quot;ogre::exception\n&quot;);
-		printf(&quot; %s\n&quot;,e.getFullDescription().c_str());
-		MyCrash((std::string(&quot;Ogre::exception occurred, see console\n&quot;) + e.getF=
ullDescription()).c_str());
-    } catch( std::exception&amp; e ) {
-		printf(&quot;std::exception\n&quot;);
-		printf(&quot; %s\n&quot;,e.what());
-		MyCrash((std::string(&quot;std::exception occurred, see console\n&quot;) + e.what(=
)).c_str());
-    } catch(...) {
-		printf(&quot;unknown exception\n&quot;);
-		MyCrash(&quot;unknown exception occurred\n&quot;);
-    }
-
-#ifndef WIN32_CONSOLE_APP
-#if OGRE_PLATFORM =3D=3D OGRE_PLATFORM_WIN32
-    FreeConsole();
-#endif
-#endif
-
-    return 0;
-}
-
-
-
-void DisplayNotice (const char* szMsg) {
-	printf(&quot;NOTICE : %s\n&quot;,szMsg);
-	#ifdef WIN32
-		// MessageBox requires user32.lib in linker settings for libraries
-		MessageBox( NULL,szMsg, &quot;Notice&quot;, MB_OK | MB_ICONERROR | MB_TASKMODAL);
-	#endif
-}
-
-void DisplayErrorMessage (const char* szMsg) {
-	printf(&quot;ERROR : %s\n&quot;,szMsg);
-	#ifdef WIN32
-		// MessageBox requires user32.lib in linker settings for libraries
-		MessageBox( NULL,szMsg, &quot;Error!&quot;, MB_OK | MB_ICONERROR | MB_TASKMODAL);
-	#endif
-}
-
-/// defined in scripting.cpp
-void	PrintLuaStackTrace		();
-void	PrintLuaStackTrace		(const char *filename);
-
-/// called on segfault
-void MySignalHandler		(int a) {
-	// print on screen
-	MyCrash(&quot;SegFault Detected&quot;);
-}
 	=

-void MyCrash		(const char* szMessage) {
-	PROFILE_PRINT_STACKTRACE
-	PrintLuaStackTrace();
-	=

-	const char *filename =3D &quot;stacktrace.log&quot;;
-	// print to file
-	{
-		// time
-		struct tm *ptr;
-		time_t tm;
-		tm =3D time(NULL);
-		ptr =3D localtime(&amp;tm);
-		FILE *f =3D fopen(filename,&quot;a&quot;);
-		if(f){
-			fprintf(f,&quot;\n\n:: %s\n%s\n&quot;,asctime(ptr),szMessage);
-			fclose(f);
-		}
-	}
-	PROFILE_PRINT_STACKTRACE_TOFILE(filename)
-	PrintLuaStackTrace(filename);
-	=

-	std::string s(szMessage);
-	s +=3D &quot;\n&quot;;
+	std::string s;
 	s +=3D &quot;If this error remains after running the updater and you think thi=
s is a bug\n&quot;;
 	s +=3D &quot;please check the BugTracker at www.iris2.de\n&quot;;
 	s +=3D &quot;and report it if it is not already known.\n&quot;;
 	s +=3D &quot;Please also append the logfile in bin/stacktrace.log to your bugr=
eport.&quot;;
-	DisplayErrorMessage(s.c_str());
-		=

-	abort();
+	Lugre_SetCrashText(s.c_str());
+	=

+	// create a unix-like commandline and show console in win
+	#ifdef USE_WINMAIN
+	int	argc =3D 0;
+	char **argv =3D Lugre_ParseWinCommandLine(argc);
+	Lugre_ShowWin32Console();
+	#endif
+	=

+	// register plugins
+	=

+	Iris_RegisterLuaPlugin();
+	=

+	// start mainloop
+	=

+	Lugre_Run(argc,argv,PATH_MAIN_LUA,PATH_LUGRE_LUA,&quot;bin/&quot;);
+	=

+	return 0;
 }
+
+

Modified: trunk/src/ogremanualloader.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/ogremanualloader.cpp (original)
+++ trunk/src/ogremanualloader.cpp Sun Sep  2 16:20:30 2007
@@ -1,9 +1,12 @@
+#include &quot;lugre_prefix.h&quot;
 #include &quot;ogremanualloader.h&quot;
 =

-#include &quot;ogrewrapper.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
 #include &quot;data.h&quot;
 #include &quot;builder.h&quot;
-#include &quot;robstring1.2.h&quot;
+#include &quot;lugre_robstring.h&quot;
+
+using namespace Lugre;
 =

 cManualArtMaterialLoader::cManualArtMaterialLoader (const char *format, co=
nst char *material_base, cArtMapLoader *pArtMapLoader,bool bPixelExact,bool=
 bInvertY,bool bInvertX) : =

 	mpArtMapLoader(pArtMapLoader), mbPixelExact(bPixelExact), mbInvertY(bInve=
rtY), mbInvertX(bInvertX), msFormat(format), msMaterialBase(material_base) =
{ PROFILE

Modified: trunk/src/ogremanualloader_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/ogremanualloader_L.cpp (original)
+++ trunk/src/ogremanualloader_L.cpp Sun Sep  2 16:20:30 2007
@@ -1,12 +1,14 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;ogremanualloader.h&quot;
-#include &quot;luabind.h&quot;
+#include &quot;lugre_luabind.h&quot;
 =

 extern &quot;C&quot; {
 	#include &quot;lua.h&quot;
 	#include &quot;lauxlib.h&quot;
 	#include &quot;lualib.h&quot;
-}
+}
+
+using namespace Lugre;
 =

 class cManualArtMaterialLoader_L : public cLuaBind&lt;cManualArtMaterialLoade=
r&gt; { public:
 	// implementation of cLuaBind

Modified: trunk/src/pathsearch.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/pathsearch.cpp (original)
+++ trunk/src/pathsearch.cpp Sun Sep  2 16:20:30 2007
@@ -1,6 +1,6 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;pathsearch.h&quot;
-#include &quot;robstring1.2.h&quot;
+#include &quot;lugre_robstring.h&quot;
 =

 #include &lt;map&gt;
 #include &lt;vector&gt;
@@ -16,6 +16,9 @@
 	// this is the linux code
 	#include &lt;dirent.h&gt;
 #endif
+
+using namespace Lugre;
+
 std::map&lt;std::string,std::vector&lt;std::string&gt;* &gt; gpDirCache_Dirs;
 std::map&lt;std::string,std::vector&lt;std::string&gt;* &gt; gpDirCache_Files;
 =


Modified: trunk/src/radar.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/radar.cpp (original)
+++ trunk/src/radar.cpp Sun Sep  2 16:20:30 2007
@@ -1,12 +1,15 @@
+#include &quot;lugre_prefix.h&quot;
 #include &quot;radar.h&quot;
 #include &quot;builder.h&quot;
 #include &quot;spritemanager.h&quot;
-#include &quot;ogrewrapper.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
 #include &lt;math.h&gt;
 #include &lt;algorithm&gt;
 =

 #include &lt;Ogre.h&gt;
 #include &lt;OgreRenderQueueListener.h&gt;
+
+using namespace Lugre;
 =

 dRadar::dRadar( cGroundBlockLoader* oGroundBlockLoader, cStaticBlockLoader=
* oStaticBlockLoader,	cRadarColorLoader* oRadarColorLoader ) {
 	mGroundBlockLoader =3D oGroundBlockLoader;

Modified: trunk/src/radar_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/radar_L.cpp (original)
+++ trunk/src/radar_L.cpp Sun Sep  2 16:20:30 2007
@@ -1,12 +1,14 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;data.h&quot;
-#include &quot;scripting.h&quot;
-#include &quot;luabind.h&quot;
-#include &quot;ogrewrapper.h&quot;
+#include &quot;lugre_scripting.h&quot;
+#include &quot;lugre_luabind.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
 #include &quot;radar.h&quot;
 #include &lt;string&gt;
 #include &lt;stdlib.h&gt;
 #include &lt;map&gt;
+
+using namespace Lugre;
 =

 extern &quot;C&quot; {
 	#include &quot;lua.h&quot;

Modified: trunk/src/spritemanager.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/spritemanager.cpp (original)
+++ trunk/src/spritemanager.cpp Sun Sep  2 16:20:30 2007
@@ -1,9 +1,12 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;spritemanager.h&quot;
-#include &quot;ogrewrapper.h&quot;
-#include &quot;shell.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
+#include &quot;lugre_shell.h&quot;
 #include &lt;Ogre.h&gt;
 #include &lt;math.h&gt;
+
+
+using namespace Lugre;
 =

 void cBaseSprite::SetPrio( int i, int Prio ) { PROFILE
 	if (i &lt; 6 &amp;&amp; mPrio[i] !=3D Prio ) {		=


Modified: trunk/src/spritemanager_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/spritemanager_L.cpp (original)
+++ trunk/src/spritemanager_L.cpp Sun Sep  2 16:20:30 2007
@@ -1,7 +1,7 @@
-#include &quot;prefix.h&quot;
-#include &quot;luabind.h&quot;
+#include &quot;lugre_prefix.h&quot;
+#include &quot;lugre_luabind.h&quot;
 #include &quot;spritemanager.h&quot;
-#include &quot;ogrewrapper.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
 #include &lt;Ogre.h&gt;
 =

 extern &quot;C&quot; {
@@ -11,6 +11,8 @@
 }
 =

 using namespace Ogre;
+
+using namespace Lugre;
 =

 class lua_State;
 =


Modified: trunk/src/terrain.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/terrain.cpp (original)
+++ trunk/src/terrain.cpp Sun Sep  2 16:20:30 2007
@@ -1,15 +1,17 @@
-#include &quot;prefix.h&quot;
+#include &quot;lugre_prefix.h&quot;
 #include &quot;terrain.h&quot;
 #include &quot;data.h&quot;
-#include &quot;ogrewrapper.h&quot;
-#include &quot;meshshape.h&quot; // for TerrainRayIntersect
-#include &quot;scripting.h&quot;
-#include &quot;fifo.h&quot;
+#include &quot;lugre_ogrewrapper.h&quot;
+#include &quot;lugre_meshshape.h&quot; // for TerrainRayIntersect
+#include &quot;lugre_scripting.h&quot;
+#include &quot;lugre_fifo.h&quot;
 #include &quot;data.h&quot;
 #include &lt;Ogre.h&gt;
 #include &lt;map&gt;
 =

 #define ANTI_XMIRROR
+
+using namespace Lugre;
 =

 using std::min;
 using std::max;

Modified: trunk/start.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/start.sh (original)
+++ trunk/start.sh Sun Sep  2 16:20:30 2007
@@ -1,4 +1,5 @@
 #!/bin/bash
 pushd bin
-../src/irisogre
+#../src/irisogre
+../iris
 popd


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000189.html">[Iris-commit] [IRIS] r1374 - in /trunk: include/huffman.h src/huffman.cpp src/scripting.iris.cpp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#188">[ date ]</a>
              <a href="thread.html#188">[ thread ]</a>
              <a href="subject.html#188">[ subject ]</a>
              <a href="author.html#188">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
