From no-reply at zwischenwelt.org  Thu Mar  5 19:30:49 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 05 Mar 2009 18:30:49 -0000
Subject: [Iris-commit] [IRIS] r2941 - in /trunk: lua/gui/gui.helper.lua
 lua/lib.buff.lua lua/lib.devtool.lua plugins/itemcounter.lua
Message-ID: <20090305183049.BA7341C18873@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar  5 19:30:49 2009
New Revision: 2941

Log:
added some checks for global gNoOgre var for starting with null renderer

Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.buff.lua
    trunk/lua/lib.devtool.lua
    trunk/plugins/itemcounter.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Thu Mar  5 19:30:49 2009
@@ -47,6 +47,7 @@
 gMemStats_NextUpdate =3D 0
 function DisplayMemoryUsage (memoryusage)
 	if (gHideMemoryUsage) then return end
+	if (gNoOgre) then return end
 	if (gMyTicks > gMemStats_NextUpdate) then
 		gMemStats_NextUpdate =3D gMyTicks + 1000
 		=


Modified: trunk/lua/lib.buff.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.buff.lua (original)
+++ trunk/lua/lib.buff.lua Thu Mar  5 19:30:49 2009
@@ -103,6 +103,7 @@
 =

 function Buffs_RebuildList() =

 	-- init dialog if needed
+	if (gNoRender) then return end
 	if (not gBuffDialog) then =

 		--~ BuffTestExportGumps() =

 		gBuffDialog =3D guimaker.MyCreateDialog() =


Modified: trunk/lua/lib.devtool.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.devtool.lua (original)
+++ trunk/lua/lib.devtool.lua Thu Mar  5 19:30:49 2009
@@ -152,7 +152,7 @@
 	for k,v in pairs(arr) do =

 		table.insert(rows,{ =

 			{type=3D"Label",		text=3Dv},
-			{type=3D"Label",		text=3Dsprintf(" %6.2fMB\n",OgreMemoryUsage(v)/1024/1=
024)}, })
+			{type=3D"Label",		text=3Dsprintf(" %6.2fMB\n",(gNoOgre and 0 or OgreMem=
oryUsage(v))/1024/1024)}, })
 	end
 =

 	table.insert(rows,{ =


Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Thu Mar  5 19:30:49 2009
@@ -82,6 +82,7 @@
 =

 function ItemCounterUpdate ()
 	if (not gInGameStarted) then return end
+	if (not gNoOgre) then return end
 	gItemCounterNeedsUpdate =3D false
 	--~ print("itemcounter update")
 	=




From no-reply at zwischenwelt.org  Sat Mar  7 00:58:00 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 06 Mar 2009 23:58:00 -0000
Subject: [Iris-commit] [IRIS] r2942 - /trunk/lua/main.lua
Message-ID: <20090306235800.557B71C18879@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Mar  7 00:57:59 2009
New Revision: 2942

Log:
added Hook_CommandLine

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Mar  7 00:57:59 2009
@@ -363,6 +363,7 @@
 	print("Lua version : "..luaversion)
 	print("Ogre platform : "..OGRE_PLATFORM)
 	=

+	NotifyListener("Hook_CommandLine")
 	HandleCommandLine()
 	=

 	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end



From no-reply at zwischenwelt.org  Sat Mar  7 00:59:08 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 06 Mar 2009 23:59:08 -0000
Subject: [Iris-commit] [IRIS] r2943 - /trunk/bin/iris2.exe
Message-ID: <20090306235908.B9A891C18879@zwischenwelt.org>

Author: sience
Date: Sat Mar  7 00:59:08 2009
New Revision: 2943

Log:
new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Mon Mar  9 00:20:24 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 08 Mar 2009 23:20:24 -0000
Subject: [Iris-commit] [IRIS] r2944 - in /trunk/lua: gui/gui.paperdoll.lua
 lib.mainmenu.lua lib.offlinemode.lua lib.tilefreewalk.lua lib.walking3.lua
 main.lua
Message-ID: <20090308232024.EAD591C1887B@zwischenwelt.org>

Author: sience
Date: Mon Mar  9 00:20:24 2009
New Revision: 2944

Log:
-patch from rabban added (offlinemode papderdoll)
-offlinemode moved to lib.offlinemode.lua
-obsolete functions removed
-codecleaning

Added:
    trunk/lua/lib.offlinemode.lua
Modified:
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.tilefreewalk.lua
    trunk/lua/lib.walking3.lua
    trunk/lua/main.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Mon Mar  9 00:20:24 2009
@@ -461,14 +461,21 @@
 function TogglePlayerPaperdoll ()
 	local playermobile =3D GetPlayerMobile()
 =

+	-- Check if there is a mobile to display
+	if (not playermobile) then
+		-- No mobile to display so provide at least a menu to quit
+		OpenQuit()
+		return
+	end
+	=

 	if (playermobile.serial and gPaperdolls[playermobile.serial]) then
 		gPaperdolls[playermobile.serial]:Close()
-	elseif (playermobile) then
+	else
 		local paperdoll =3D {}
 		paperdoll.serial=3D playermobile.serial
 		paperdoll.name	=3D playermobile.name
 		paperdoll.flag	=3D 0
-			=

+		=

 		HandleOpenPaperdoll(paperdoll)
 	end
 end

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Mon Mar  9 00:20:24 2009
@@ -6,6 +6,8 @@
 dofile(libpath .. "lib.mainmenu.charlist.lua")
 dofile(libpath .. "lib.mainmenu.charcreate.lua")
 =

+dofile(libpath .. "lib.offlinemode.lua")
+dofile(libpath .. "lib.debugmenu.lua")
 =

 =

 function StartMainMenu	() =

@@ -74,6 +76,18 @@
 	end -- connect to shard
 end
 =

+-- ***** ***** ***** ***** ***** Shardfilter
+
+function LoadShardfilter (filterfilepath)
+	if (filterfilepath) then
+		if (file_exists(gMainWorkingDir..filterfilepath) ) then
+			print("Load custom shard-specific Filter: "..gMainWorkingDir..filterfil=
epath)
+			dofile(gMainWorkingDir..filterfilepath)
+		else
+			print("Shard-specific Filter not found: "..gMainWorkingDir..filterfilep=
ath)
+		end
+	end
+end
 =

 -- ***** ***** ***** ***** ***** actions and events
 =

@@ -242,75 +256,3 @@
 	end
 end
 function MainMenu_Special_Exit			() MainMenuStopAllMenus() Terminate() end
-
--- ***** ***** ***** ***** ***** offline mode
-
--- postxt is a string for the position, e.g. 5260,1333  , can be nil
-function StartOfflineMode (postxt)
-	print("##################################")
-	print("StartOfflineMode",postxt)		=

-	MainMenuStopAllMenus() =

-	=

-	if (gCommandLineSwitches["-som"]) then =

-		local confname =3D gCommandLineArguments[gCommandLineSwitches["-som"]+1]
-		print("StartOfflineMode config",confname)
-		gMaps =3D gMaps or {}
-		for k,v in pairs((gShardList[confname] or {}).gMaps or {}) do print("gMa=
ps["..k.."] override") gMaps[k] =3D v end
-	end
-	if (gCommandLineSwitches["-so"]) then =

-		gOfflineModeMapIndex =3D tonumber(gCommandLineArguments[gCommandLineSwit=
ches["-so"]+2]) or gOfflineModeMapIndex
-	end
-	MapChangeRequest(gOfflineModeMapIndex or 1)
-	=

-	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-
-	gStartGameWithoutNetwork =3D true
-	MultiTexTerrain_NotifyMapChange()
-	=

-	--~ local x,y,z =3D -183,203,0
-	local x,y,z =3D -1483,1527,2 -- osi-britannia
-	=

-	--if (gGroundBlockLoader) then x,y,z =3D -gGroundBlockLoader:GetMapW()*8/=
2,gGroundBlockLoader:GetMapH()*8/2,0 end
-	if (gOfflineModeCamStart) then x,y,z =3D unpack(gOfflineModeCamStart) end
-	=

-	if (postxt) then
-		local t1,t2,t3 =3D unpack(strsplit(",",postxt))
-		x,y,z =3D tonumber(t1) and -tonumber(t1) or x, tonumber(t2) or y, tonumb=
er(t3) or z
-		print("StartOfflineMode ",x,y,z,t1,t2,t3)
-	end
-		=

-	-- set z position to terrainheight at starting location
-	local tt,zz =3D GetGroundAtAbsPos(-x,y)
-	if zz then
-		--~ print("#",x,y,tt,z,zz) =

-		z =3D zz
-	end
-	=

-	=

-	gCurrentRenderer:InitLocalCam(x,y,z)
-
-	-- Binds key and Inits all InGame-Data
-	StartInGame() -- otherwise handled by the serverpacket (kPacket_Login_Com=
plete)
-
-
-	gCurrentRenderer:SetOfflineStartPos(x,y,z)
-
-	-- offline : tilefree walk teleport
-	BindDown("f6",function () gCurrentRenderer:OfflineTeleportToMouse() end)
-	=

-	-- Unbind some keys only for offline mode (rest is the same as InGame)
-	UnBindArr({"u","q","e","tab","r","t","k","j","b","p","g","h","y"})
-end
-
--- ***** ***** ***** ***** ***** Shardfilter
-
-function LoadShardfilter	(filterfilepath)
-	if (filterfilepath) then
-		if (file_exists(gMainWorkingDir..filterfilepath) ) then
-			print("Load custom shard-specific Filter: "..gMainWorkingDir..filterfil=
epath)
-			dofile(gMainWorkingDir..filterfilepath)
-		else
-			print("Shard-specific Filter not found: "..gMainWorkingDir..filterfilep=
ath)
-		end
-	end
-end

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Mon Mar  9 00:20:24 2009
@@ -638,26 +638,6 @@
 -- qw,qx,qy,qz =3D gTileFreeWalk:GetOrientation()
 function gTileFreeWalk:GetOrientation ()	return Quaternion.getRotation(0,-=
1,0,self:GetViewDir()) end
 =

-function gTileFreeWalk:UpdateOfflineBody (x,y,z, qw,qx,qy,qz, bMoving,bTur=
ning,bWarMode,bRunFlag)
-	if (not gTileFreeTestBodyGfx) then =

-		local mobile =3D kTileFreeTestMobile
-		gTileFreeTestBodyGfx =3D CreateBodyGfx()
-		gTileFreeTestBodyGfx:MarkForUpdate(mobile.artid,mobile.hue,mobile.conten=
t)
-		gTileFreeTestBodyGfx:Update()
-	end
-	gTileFreeTestBodyGfx:SetState(bMoving,bTurning,bWarMode,bRunFlag)
-	gTileFreeTestBodyGfx.modelgfx:SetPosition(x,y,z)
-	gTileFreeTestBodyGfx.modelgfx:SetOrientation(qw,qx,qy,qz)
-	=

-	-- handle offline blend out
-	gCurrentRenderer:BlendOutLayersAbovePlayer()
-	gPlayerXLoc,gPlayerYLoc,gPlayerZLoc =3D Renderer3D:LocalToUOPos(x,y,z * 1=
0)
-	=

-	gPlayerXLoc =3D math.floor(gPlayerXLoc)
-	gPlayerYLoc =3D math.floor(gPlayerYLoc)
-	gPlayerZLoc =3D math.floor(gPlayerZLoc)
-end
-
 -- fRequestedSpeed is the speed requested by the mousepos/keyboard, might =
not be reached, e.g. when walking against a wall
 function gTileFreeWalk:Impl_StepPlayer (fRequestedSpeed,bRunRequested)
 =

@@ -669,18 +649,23 @@
 	local x,y,z =3D self:GetPos_ClientSide()
 	local qw,qx,qy,qz =3D self:GetOrientation()
 	=

-	-- apply to body
-	if (gStartGameWithoutNetwork) then -- offline mode, show test model
-		gTileFreeWalk:UpdateOfflineBody(x,y,z, qw,qx,qy,qz, bMoving,bTurning,bWa=
rMode,bRunFlag)
-	else -- online mode, set mobile pos
-		local mobile =3D GetPlayerMobile()
-		if (mobile) then =

-			Renderer3D:UpdateMobilePos(mobile,x+0.5,y-0.5,z,qw,qx,qy,qz)
-			------ --- TODO : SetState(bMoving,bTurning,bWarMode,bRunFlag)
+	local mobile =3D GetPlayerMobile()
+	if (mobile) then =

+		Renderer3D:UpdateMobilePos(mobile,x+0.5,y-0.5,z,qw,qx,qy,qz)
+		------ --- TODO : SetState(bMoving,bTurning,bWarMode,bRunFlag)
+		=

+		bWarMode 	=3D TestBit(mobile.flag,kMobileFlag_WarMode) -- combat
+		--~ bRunFlag 	=3D TestBit(mobile.dir,kWalkFlag_Run)
+		if (mobile.bodygfx) then mobile.bodygfx:SetState(bMoving,bTurning,bWarMo=
de,bRunFlag) end
+		=

+		if (gStartGameWithoutNetwork) then
+			-- Do the following if offline.  These things are done elsewhere if onl=
ine.
+			gCurrentRenderer:BlendOutLayersAbovePlayer()
 			=

-			bWarMode 	=3D TestBit(mobile.flag,kMobileFlag_WarMode) -- combat
-			--~ bRunFlag 	=3D TestBit(mobile.dir,kWalkFlag_Run)
-			if (mobile.bodygfx) then mobile.bodygfx:SetState(bMoving,bTurning,bWarM=
ode,bRunFlag) end
+			gPlayerXLoc,gPlayerYLoc,gPlayerZLoc =3D Renderer3D:LocalToUOPos(x,y,z *=
 10)
+			gPlayerXLoc =3D math.floor(gPlayerXLoc)
+			gPlayerYLoc =3D math.floor(gPlayerYLoc)
+			gPlayerZLoc =3D math.floor(gPlayerZLoc)
 		end
 	end
 end
@@ -705,14 +690,14 @@
 -- feedback for thirdpersoncam
 function gTileFreeWalk:GetExactLocalPos	() return self:GetPos_ClientSide()=
 end
 =

-
-
+--[[
 -- 27.09.2007 : the code that triggers this event has been deactivated, so=
 this should no longer be neccessary
 RegisterListener("Hook_RecenterWorld",function (difx,dify)
 	print("ERROR, TileFreeWalk : Hook_RecenterWorld not yet implemented")
 	-- todo : move all positons...
 	Crash()
 end)
+]]--
 =

 -- ##### ##### ##### ##### ##### pathpoints
 =


Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Mon Mar  9 00:20:24 2009
@@ -34,7 +34,6 @@
 	return bMoveIsOk and newZ or nil
 end
 =

-
 RegisterListener("Hook_SetPlayerPos",function () W3TestUpdateGfx2() end)
 RegisterListener("Hook_StartInGame"	,function () W3TestInit() end)
 =

@@ -55,13 +54,14 @@
 	--~ print("W3TestUpdateGfx2",gPlayerXLoc,gPlayerYLoc,gPlayerZLoc)
 	W3TestUpdateGfx()
 end
+
 function W3TestUpdateGfx ()
 	local x,y,z =3D Renderer3D:UOPosToLocal(gW3Test.xloc,gW3Test.yloc,gW3Test=
.zloc*0.1) =

 	local qw,qx,qy,qz =3D Dir2Quaternion(gW3Test.dir)
 	local bMoving,bTurning,bWarMode,bRunFlag =3D false,false,false,false
-	gTileFreeWalk:UpdateOfflineBody(x-0.5,y+0.5,z, qw,qx,qy,qz, bMoving,bTurn=
ing,bWarMode,bRunFlag)
 	gTileFreeWalk:SetPos_ClientSide(x-0.5,y+0.5,z)
 end
+
 function W3TestInit ()
 	if (not gDisableTileFreeWalk) then return end
 	--~ print("W3TestInit")
@@ -93,14 +93,9 @@
 		end)
 	end
 end
-	=

-
-
-
 =

 -- old : Movable runuo:ImplFlag.Movable , probably true for dynamic, false=
 for static    (door? probably for ghosts)
 function W3_ItemIsMovable		(item)		return not item.bIsStatic end
-
 =

 -- handles clientside and serverside multis (no difference for us, just th=
e way they are loaded)
 -- calls fun(item,param)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Mar  9 00:20:24 2009
@@ -73,7 +73,6 @@
 dofile(libpath .. "lib.loading.lua")
 dofile(libpath .. "lib.cursor.lua")
 dofile(libpath .. "lib.mainmenu.lua")
-dofile(libpath .. "lib.debugmenu.lua")
 dofile(libpath .. "lib.diff.lua")
 dofile(libpath .. "lib.deffileparser.lua")
 dofile(libpath .. "lib.fallback.lua")



From no-reply at zwischenwelt.org  Mon Mar  9 20:28:21 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 09 Mar 2009 19:28:21 -0000
Subject: [Iris-commit] [IRIS] r2945 - in /tools/updater: updater.sln
 updater.vcproj updater_vs7.vcproj updater_vs8.sln updater_vs8.vcproj
 updater_vs9.sln updater_vs9.vcproj vc7.vcproj
Message-ID: <20090309192821.A44B31C1887A@zwischenwelt.org>

Author: sience
Date: Mon Mar  9 20:28:21 2009
New Revision: 2945

Log:
-visual studio 9 (2008) project files added

Added:
    tools/updater/updater_vs7.vcproj
      - copied unchanged from r2944, tools/updater/vc7.vcproj
    tools/updater/updater_vs8.sln
      - copied, changed from r2944, tools/updater/updater.sln
    tools/updater/updater_vs8.vcproj
      - copied unchanged from r2944, tools/updater/updater.vcproj
    tools/updater/updater_vs9.sln
    tools/updater/updater_vs9.vcproj
Removed:
    tools/updater/updater.sln
    tools/updater/updater.vcproj
    tools/updater/vc7.vcproj



From no-reply at zwischenwelt.org  Mon Mar  9 20:33:25 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 09 Mar 2009 19:33:25 -0000
Subject: [Iris-commit] [IRIS] r2946 - /trunk/bin/updater.exe
Message-ID: <20090309193326.02A261C1887A@zwischenwelt.org>

Author: sience
Date: Mon Mar  9 20:33:25 2009
New Revision: 2946

Log:
-updater compiled with visual studio 9 (2008) <- this needs to install the =
newest MSVC++ 2008 SP1 Redist. (x86)  (http://www.microsoft.com/downloads/d=
etails.aspx?familyid=3DA5C84275-3B97-4AB7-A40D-3802B2AF5FC2&displaylang=3De=
n )

Modified:
    trunk/bin/updater.exe

Modified: trunk/bin/updater.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Mon Mar  9 21:06:28 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 09 Mar 2009 20:06:28 -0000
Subject: [Iris-commit] [IRIS] r2947 - in /tools/installer: ./ svnclient/
	svnclient/Data/
Message-ID: <20090309200629.076731C1887A@zwischenwelt.org>

Author: sience
Date: Mon Mar  9 21:06:28 2009
New Revision: 2947

Log:
-svnclient added
-installer script updated
-checkout.bat added

Added:
    tools/installer/checkout.bat
    tools/installer/svnclient/
    tools/installer/svnclient/Data/
    tools/installer/svnclient/intl3_svn.dll   (with props)
    tools/installer/svnclient/libapr.dll   (with props)
    tools/installer/svnclient/libapriconv.dll   (with props)
    tools/installer/svnclient/libaprutil.dll   (with props)
    tools/installer/svnclient/libdb44.dll   (with props)
    tools/installer/svnclient/libeay32.dll   (with props)
    tools/installer/svnclient/ssleay32.dll   (with props)
    tools/installer/svnclient/svn.exe   (with props)
Modified:
    tools/installer/Iris_Setup.iss

Modified: tools/installer/Iris_Setup.iss
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- tools/installer/Iris_Setup.iss (original)
+++ tools/installer/Iris_Setup.iss Mon Mar  9 21:06:28 2009
@@ -9,7 +9,7 @@
 #define UpdaterExeName "updater.exe"
 #define UpdaterExeName2 "emergency_update.bat"
 #define AppUrlName "iris2.url"
-#define BuildNumber "build 2365"
+#define BuildNumber "build 2938"
 #define DataDir "svnclient\Data\"
 =

 [Setup]
@@ -63,7 +63,9 @@
 =

 [Run]
 Filename: {app}\bin\{#UpdaterExeName}; WorkingDir: {app}\bin\; Flags: post=
install; Description: {cm:ConfigureIris}
-Filename: {app}\vcredist_x86.exe; WorkingDir: {app}; StatusMsg: Installing=
 Visual C++ 8 SP1 Runtime
+;Installing "Microsoft Visual C++ 2005 Redistributable Package" for skincr=
after
+Filename: {app}\vcredist_x86.exe; Parameters: "/q:a /c:""install /l /q""";=
 WorkingDir: {tmp}; Flags: skipifdoesntexist; StatusMsg: "Checking for and =
installing ""Microsoft Visual C++ 2008 Redistributable Package"" if needed,=
 This can take several minutes..."
+;Filename: {app}\vcredist_x86.exe; WorkingDir: {app}; StatusMsg: Installin=
g Visual C++ 8 SP1 Runtime
 ; maybe with Option vcredist_x86.exe /Q
 ; Flags: runhidden
 ;Filename: {app}\{#AppExeName}; Description: {cm:LaunchProgram,{#AppName}}=
; Flags: nowait postinstall skipifsilent



From no-reply at zwischenwelt.org  Mon Mar  9 21:07:32 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 09 Mar 2009 20:07:32 -0000
Subject: [Iris-commit] [IRIS] r2948 - /tools/installer/svnclient/Data/
Message-ID: <20090309200732.6849A1C1887A@zwischenwelt.org>

Author: sience
Date: Mon Mar  9 21:07:31 2009
New Revision: 2948

Log:
-removed <- needs to be created manually

Removed:
    tools/installer/svnclient/Data/



From no-reply at zwischenwelt.org  Mon Mar  9 21:10:19 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 09 Mar 2009 20:10:19 -0000
Subject: [Iris-commit] [IRIS] r2949 - /tools/installer/svnclient/
Message-ID: <20090309201019.A666D1C1887A@zwischenwelt.org>

Author: sience
Date: Mon Mar  9 21:10:19 2009
New Revision: 2949

Log:
-svnclient removed again (does not work when checking out with this client =
- svn conflict)

Removed:
    tools/installer/svnclient/



From no-reply at zwischenwelt.org  Tue Mar 10 02:10:39 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Mar 2009 01:10:39 -0000
Subject: [Iris-commit] [IRIS] r2950 - /branches/stable_release/
Message-ID: <20090310011040.3EBC51C1887A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 10 02:10:39 2009
New Revision: 2950

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Tue Mar 10 02:10:40 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Mar 2009 01:10:40 -0000
Subject: [Iris-commit] [IRIS] r2951 - /branches/stable_release/
Message-ID: <20090310011040.BF76D1C1887B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 10 02:10:40 2009
New Revision: 2951

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r2950, trunk/



From no-reply at zwischenwelt.org  Tue Mar 10 02:10:41 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 10 Mar 2009 01:10:41 -0000
Subject: [Iris-commit] [IRIS] r2952 - /branches/stable_release/
Message-ID: <20090310011041.35E641C1887E@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 10 02:10:40 2009
New Revision: 2952

Log:
lugre -r699 svn://zwischenwelt.org/lugre/trunk/lugre

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Wed Mar 11 22:20:51 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 11 Mar 2009 21:20:51 -0000
Subject: [Iris-commit] [IRIS] r2953 - /trunk/plugins/itemcounter.lua
Message-ID: <20090311212051.356611C1887E@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Mar 11 22:20:50 2009
New Revision: 2953

Log:
bugfix : itemcounter was accidentally deactivated

Modified:
    trunk/plugins/itemcounter.lua

Modified: trunk/plugins/itemcounter.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/itemcounter.lua (original)
+++ trunk/plugins/itemcounter.lua Wed Mar 11 22:20:50 2009
@@ -82,7 +82,7 @@
 =

 function ItemCounterUpdate ()
 	if (not gInGameStarted) then return end
-	if (not gNoOgre) then return end
+	if (gNoOgre) then return end
 	gItemCounterNeedsUpdate =3D false
 	--~ print("itemcounter update")
 	=




From no-reply at zwischenwelt.org  Thu Mar 12 20:18:10 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 12 Mar 2009 19:18:10 -0000
Subject: [Iris-commit] [IRIS] r2954 - /trunk/lua/lib.mainmenu.accountlist.lua
Message-ID: <20090312191810.5755F1C1887B@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar 12 20:18:09 2009
New Revision: 2954

Log:
mainmenu : added labels for which field is username and which is password

Modified:
    trunk/lua/lib.mainmenu.accountlist.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Thu Mar 12 20:18:09 2009
@@ -16,6 +16,8 @@
 									local pass =3D gMainMenuDialog_AccountList:GetEditText("i_pass")
 									MainMenu_SendLogin(user,pass) =

 								end
+	table.insert(rows,{		{"Username"},{"Password"},
+						})
 	table.insert(rows,{		{type=3D"EditText",w=3D128,h=3D16,text=3D"",controln=
ame=3D"i_user",nextcontrolname=3D"i_pass"},
 							{type=3D"EditText",w=3D 64,h=3D16,text=3D"",controlname=3D"i_pass",=
nextcontrolname=3D"i_pass1",onReturn=3Dfun_login_manual,bPassWordStyle=3Dtr=
ue},
 							{">",fun_login_manual},



From no-reply at zwischenwelt.org  Sat Mar 14 02:25:34 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 14 Mar 2009 01:25:34 -0000
Subject: [Iris-commit] [IRIS] r2957 - /tools/installer/Iris_Setup.iss
Message-ID: <20090314020008.855901C18053@zwischenwelt.org>

Author: sience
Date: Sat Mar 14 02:25:33 2009
New Revision: 2957

Log:
-installer script updated

Modified:
    tools/installer/Iris_Setup.iss

Modified: tools/installer/Iris_Setup.iss
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- tools/installer/Iris_Setup.iss (original)
+++ tools/installer/Iris_Setup.iss Sat Mar 14 02:25:33 2009
@@ -9,7 +9,7 @@
 #define UpdaterExeName "updater.exe"
 #define UpdaterExeName2 "emergency_update.bat"
 #define AppUrlName "iris2.url"
-#define BuildNumber "build 2938"
+#define BuildNumber "build 2952"
 #define DataDir "svnclient\Data\"
 =

 [Setup]



From no-reply at zwischenwelt.org  Sat Mar 14 02:24:52 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 14 Mar 2009 01:24:52 -0000
Subject: [Iris-commit] [IRIS] r2956 - in /trunk/lua:
 lib.mainmenu.accountlist.lua lib.mainmenu.background.lua
 lib.mainmenu.charcreate.lua lib.mainmenu.charlist.lua lib.mainmenu.lua
 lib.mainmenu.old.lua lib.mainmenu.shardlist.lua lib.shardlist.lua
Message-ID: <20090314020007.D5B8A1524034@zwischenwelt.org>

Author: sience
Date: Sat Mar 14 02:24:51 2009
New Revision: 2956

Log:
-lib.mainmenu.old.lua moved to tools/attic
-small menu bugfix if connect fails
-some prints disabled
-some obsolete things removed

Removed:
    trunk/lua/lib.mainmenu.old.lua
Modified:
    trunk/lua/lib.mainmenu.accountlist.lua
    trunk/lua/lib.mainmenu.background.lua
    trunk/lua/lib.mainmenu.charcreate.lua
    trunk/lua/lib.mainmenu.charlist.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.mainmenu.shardlist.lua
    trunk/lua/lib.shardlist.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Sat Mar 14 02:24:51 2009
@@ -1,90 +1,90 @@
-
-function MainMenu_AccountList_Start ()
-	print("################################")
-	print("MainMenu_AccountList_Start")
-	MainMenuStopAllMenus()
-	gRememberPassword =3D gRegistrySlow:Get("gRememberPassword")
-	=

-	-- clear auto-login if returning to this menu from somewhere else
-	gAutoLoginCharID =3D nil
-	gAutoLoginCharName =3D nil
-	=

-	local rows =3D {}
-	-- manual input
-	local fun_login_manual =3D function () =

-									local user =3D gMainMenuDialog_AccountList:GetEditText("i_user")
-									local pass =3D gMainMenuDialog_AccountList:GetEditText("i_pass")
-									MainMenu_SendLogin(user,pass) =

-								end
-	table.insert(rows,{		{"Username"},{"Password"},
-						})
-	table.insert(rows,{		{type=3D"EditText",w=3D128,h=3D16,text=3D"",controln=
ame=3D"i_user",nextcontrolname=3D"i_pass"},
-							{type=3D"EditText",w=3D 64,h=3D16,text=3D"",controlname=3D"i_pass",=
nextcontrolname=3D"i_pass1",onReturn=3Dfun_login_manual,bPassWordStyle=3Dtr=
ue},
-							{">",fun_login_manual},
-						})
-	=

-	-- saved charlists
-	local lastpassedit
-	local charlists =3D SortedArrayFromAssocTable(ShardMemoryGetList("charlis=
t") or {},function (a,b) return a.gLoginname < b.gLoginname end)
-	charlists =3D FilterArray(charlists,function (charlist) return	charlist.g=
LoginServerIP		=3D=3D gLoginServerIP and =

-																	charlist.gLoginServerPort	=3D=3D gLoginServerPort end)
-	for charlist_idx,charlist in pairs(charlists) do
-		-- list chars in slotorder
-		local mychars =3D {}
-		for i=3D0,20 do if (charlist[i]) then table.insert(mychars,{id=3Di,name=
=3Dcharlist[i]}) else break end end
-		--~ table.sort(mychars,function (a,b) return a.name < b.name end) -- sor=
t by name
-		table.sort(mychars,function (a,b) return a.id < b.id end) -- sort by cha=
rslot, same as in original client charlist
-		=

-		local user =3D charlist.gLoginname or "???"
-		local pass =3D MainMenu_GetStoredPassword(gLoginServerIP,gLoginServerPor=
t,user)
-		=

-		-- one line per non-empty char-slot
-		local bHadFirstChar =3D false
-		local ctrlname_pass =3D "i_pass"..charlist_idx
-		local ctrlname_passnext =3D "i_pass"..(charlist_idx + 1)
-		local fun_mylogin =3D function () MainMenu_SendLogin(user,gMainMenuDialo=
g_AccountList:GetEditText(ctrlname_pass)) end
-		lastpassedit =3D {type=3D"EditText",w=3D64,h=3D16,text=3D(pass or ""),on=
Return=3Dfun_mylogin,controlname=3Dctrlname_pass,nextcontrolname=3Dctrlname=
_passnext,bPassWordStyle=3Dtrue}
-		local baserow =3D {	{user},
-							lastpassedit,
-							{">",fun_mylogin},
-						}
-		for k,char in ipairs(mychars) do =

-			if (char.name ~=3D "") then
-				local buttontext =3D "#"..k..":"..char.name
-				local fun_char =3D function () MainMenu_SendLoginAndChar(user,gMainMen=
uDialog_AccountList:GetEditText(ctrlname_pass),char.id,char.name) end
-				=

-				local myrow =3D bHadFirstChar and {{""},{""},{""}} or baserow
-				bHadFirstChar =3D true
-				=

-				table.insert(myrow,{char.name,fun_char})
-				table.insert(myrow,{"3D",function () gCurrentRenderer =3D Renderer3D f=
un_char() end})
-				table.insert(myrow,{"2D",function () gCurrentRenderer =3D Renderer2D f=
un_char() end})
-				table.insert(rows,myrow)
-			end
-		end
-		-- if it was a fresh account with no chars yet, or charlist is unknown, =
list the login anyway
-		if (not bHadFirstChar) then table.insert(rows,baserow) end
-	end
-	if (lastpassedit) then lastpassedit.nextcontrolname =3D "i_user" end
-	=

-	local fun_getpwsign =3D function () return gRememberPassword and "X" or "=
 " end
-	local fun_pw =3D function (widget) =

-		gRememberPassword =3D not gRememberPassword
-		gRegistrySlow:Set("gRememberPassword",gRememberPassword)
-		widget.AutoScaledButton_text.gfx:SetText(fun_getpwsign())
-		print("save pw",widget,gRememberPassword)
-	end
-	table.insert(rows,{{"Back",MainMenu_AccountList_Back},{"  save PW"},{fun_=
getpwsign(),fun_pw}})
-	gMainMenuDialog_AccountList =3D MainMenu_MakeTableDlg(rows)
-end
-
-function MainMenu_AccountList_Back ()
-	MainMenuResetNetwork()
-	MainMenu_ShardList_Start()
-end
-function MainMenu_AccountList_Stop ()
-	if (gMainMenuDialog_AccountList) then =

-		gMainMenuDialog_AccountList:Destroy() =

-		gMainMenuDialog_AccountList =3D nil
-	end
-end
+
+function MainMenu_AccountList_Start ()
+--  print("################################")
+--  print("MainMenu_AccountList_Start")
+    MainMenuStopAllMenus()
+    gRememberPassword =3D gRegistrySlow:Get("gRememberPassword")
+    =

+    -- clear auto-login if returning to this menu from somewhere else
+    gAutoLoginCharID =3D nil
+    gAutoLoginCharName =3D nil
+    =

+    local rows =3D {}
+    -- manual input
+    local fun_login_manual =3D function () =

+                                    local user =3D gMainMenuDialog_Account=
List:GetEditText("i_user")
+                                    local pass =3D gMainMenuDialog_Account=
List:GetEditText("i_pass")
+                                    MainMenu_SendLogin(user,pass) =

+                                end
+    table.insert(rows,{     {"Username"},{"Password"},
+                        })
+    table.insert(rows,{     {type=3D"EditText",w=3D128,h=3D16,text=3D"",co=
ntrolname=3D"i_user",nextcontrolname=3D"i_pass"},
+                            {type=3D"EditText",w=3D 64,h=3D16,text=3D"",co=
ntrolname=3D"i_pass",nextcontrolname=3D"i_pass1",onReturn=3Dfun_login_manua=
l,bPassWordStyle=3Dtrue},
+                            {">",fun_login_manual},
+                        })
+    =

+    -- saved charlists
+    local lastpassedit
+    local charlists =3D SortedArrayFromAssocTable(ShardMemoryGetList("char=
list") or {},function (a,b) return a.gLoginname < b.gLoginname end)
+    charlists =3D FilterArray(charlists,function (charlist) return    char=
list.gLoginServerIP     =3D=3D gLoginServerIP and =

+                                                                    charli=
st.gLoginServerPort   =3D=3D gLoginServerPort end)
+    for charlist_idx,charlist in pairs(charlists) do
+        -- list chars in slotorder
+        local mychars =3D {}
+        for i=3D0,20 do if (charlist[i]) then table.insert(mychars,{id=3Di=
,name=3Dcharlist[i]}) else break end end
+        --~ table.sort(mychars,function (a,b) return a.name < b.name end) =
-- sort by name
+        table.sort(mychars,function (a,b) return a.id < b.id end) -- sort =
by charslot, same as in original client charlist
+        =

+        local user =3D charlist.gLoginname or "???"
+        local pass =3D MainMenu_GetStoredPassword(gLoginServerIP,gLoginSer=
verPort,user)
+        =

+        -- one line per non-empty char-slot
+        local bHadFirstChar =3D false
+        local ctrlname_pass =3D "i_pass"..charlist_idx
+        local ctrlname_passnext =3D "i_pass"..(charlist_idx + 1)
+        local fun_mylogin =3D function () MainMenu_SendLogin(user,gMainMen=
uDialog_AccountList:GetEditText(ctrlname_pass)) end
+        lastpassedit =3D {type=3D"EditText",w=3D64,h=3D16,text=3D(pass or =
""),onReturn=3Dfun_mylogin,controlname=3Dctrlname_pass,nextcontrolname=3Dct=
rlname_passnext,bPassWordStyle=3Dtrue}
+        local baserow =3D {   {user},
+                            lastpassedit,
+                            {">",fun_mylogin},
+                        }
+        for k,char in ipairs(mychars) do =

+            if (char.name ~=3D "") then
+                local buttontext =3D "#"..k..":"..char.name
+                local fun_char =3D function () MainMenu_SendLoginAndChar(u=
ser,gMainMenuDialog_AccountList:GetEditText(ctrlname_pass),char.id,char.nam=
e) end
+                =

+                local myrow =3D bHadFirstChar and {{""},{""},{""}} or base=
row
+                bHadFirstChar =3D true
+                =

+                table.insert(myrow,{char.name,fun_char})
+                table.insert(myrow,{"3D",function () gCurrentRenderer =3D =
Renderer3D fun_char() end})
+                table.insert(myrow,{"2D",function () gCurrentRenderer =3D =
Renderer2D fun_char() end})
+                table.insert(rows,myrow)
+            end
+        end
+        -- if it was a fresh account with no chars yet, or charlist is unk=
nown, list the login anyway
+        if (not bHadFirstChar) then table.insert(rows,baserow) end
+    end
+    if (lastpassedit) then lastpassedit.nextcontrolname =3D "i_user" end
+    =

+    local fun_getpwsign =3D function () return gRememberPassword and "X" o=
r " " end
+    local fun_pw =3D function (widget) =

+        gRememberPassword =3D not gRememberPassword
+        gRegistrySlow:Set("gRememberPassword",gRememberPassword)
+        widget.AutoScaledButton_text.gfx:SetText(fun_getpwsign())
+--      print("save pw",widget,gRememberPassword)
+    end
+    table.insert(rows,{{"Back",MainMenu_AccountList_Back},{"  save PW"},{f=
un_getpwsign(),fun_pw}})
+    gMainMenuDialog_AccountList =3D MainMenu_MakeTableDlg(rows)
+end
+
+function MainMenu_AccountList_Back ()
+    MainMenuResetNetwork()
+    MainMenu_ShardList_Start()
+end
+function MainMenu_AccountList_Stop ()
+    if (gMainMenuDialog_AccountList) then =

+        gMainMenuDialog_AccountList:Destroy() =

+        gMainMenuDialog_AccountList =3D nil
+    end
+end

Modified: trunk/lua/lib.mainmenu.background.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.background.lua (original)
+++ trunk/lua/lib.mainmenu.background.lua Sat Mar 14 02:24:51 2009
@@ -1,41 +1,23 @@
-
-RegisterListener("Hook_StartInGame",function () MainMenu_Background_Stop()=
 end)
-
-function MainMenu_Background_Start ()
-	if (gNoRender) then return end
-	local vp =3D GetMainViewport()
-	local w =3D vp:GetActualWidth()
-	local h =3D vp:GetActualHeight()
-	local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPlainT=
extureGUIMat("menu_bg.jpg"), 1024, 768)
-	if (gMenuBgImage) then gMenuBgImage:Destroy() end
-	gMenuBgImage =3D GetDesktopWidget():CreateChild("Image",{gfxparam_init=3D=
gfxparam_init})
-	gMenuBgImage:SetPos(0,0)
-	gMenuBgImage:SetSize(w,h)
-	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-	=

-	-- start menu sound
-	SoundPlayMusicById(8)
-end
-
-function MainMenu_Background_Stop ()
-	DestroyIfAlive(gMenuBgImage)
-	gMenuBgImage =3D nil
-end
-
---[[
--- old, wasn't used anymore
-local function SetMainMenuCam (roth,rotv)
-	local cam =3D GetMainCam()
-	cam:SetFOVy(gfDeg2Rad*45)
-	cam:SetNearClipDistance(0.5) -- old : 1
-	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
-	cam:SetProjectionType(kCamera_PT_PERSPECTIVE) -- perspective
-	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
-	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

-	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
-	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
-	=

-	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
-	GetMainCam():SetRot(w,x,y,z)	=

-end
-]]--
+
+RegisterListener("Hook_StartInGame",function () MainMenu_Background_Stop()=
 end)
+
+function MainMenu_Background_Start ()
+    if (gNoRender) then return end
+    local vp =3D GetMainViewport()
+    local w =3D vp:GetActualWidth()
+    local h =3D vp:GetActualHeight()
+    local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPla=
inTextureGUIMat("menu_bg.jpg"), 1024, 768)
+    if (gMenuBgImage) then gMenuBgImage:Destroy() end
+    gMenuBgImage =3D GetDesktopWidget():CreateChild("Image",{gfxparam_init=
=3Dgfxparam_init})
+    gMenuBgImage:SetPos(0,0)
+    gMenuBgImage:SetSize(w,h)
+    if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
+    =

+    -- start menu sound
+    SoundPlayMusicById(8)
+end
+
+function MainMenu_Background_Stop ()
+    DestroyIfAlive(gMenuBgImage)
+    gMenuBgImage =3D nil
+end

Modified: trunk/lua/lib.mainmenu.charcreate.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.charcreate.lua (original)
+++ trunk/lua/lib.mainmenu.charcreate.lua Sat Mar 14 02:24:51 2009
@@ -1,281 +1,281 @@
--- kPacket_CharacterCreation -- 0x00
-function MainMenu_CharCreate_Start ()
-	local forbiddenskills =3D {	gCharCreateSkillIDs["Stealth"],
-								gCharCreateSkillIDs["Remove Trap"],
-								gCharCreateSkillIDs["Spellweaving"], } -- can't choose from those =
at charcreate
-	=

-	print("########################")
-	print("MainMenu_CharCreate_Start",freeslot)
-	MainMenuStopAllMenus()
-
-	gCharCreateData =3D {}
-	gCharCreateDataEnums =3D {}
-	=

-	local skilllist =3D {}
-	for skillid,name in pairs(glSkillNames) do =

-		if (not in_array(skillid-1,forbiddenskills)) then =

-			table.insert(skilllist,{id=3Dskillid-1,name=3Dname})
-		end
-	end
-	skilllist =3D SortedArrayFromAssocTable(skilllist,function (a,b) return a=
.name < b.name end)
-	=

-	local sexlist =3D {	{id=3D0,name=3D"Human/Male"},
-						{id=3D1,name=3D"Human/Female"},
-						{id=3D2,name=3D"Elf/Male"},
-						{id=3D3,name=3D"Elf/Female"},
-						}
-	gCharCreateDataEnums["sex"] =3D sexlist
-		=

-	local rows =3D {}
-	table.insert(rows,{{"Create character"}})
-	table.insert(rows,{{"Name:"},			{""},	{type=3D"EditText",w=3D128,h=3D16,t=
ext=3D"",controlname=3D"name"}})
-	table.insert(rows,{{"Race/Gender:"},	{""},	{sexlist[1].name,function (w) =
MainMenu_CharCreate_Choose(w) end,controlname=3D"sex"}})
-	=

-	=

-	-- lock stats
-	gCharCreateStatLock =3D {}
-	function MyCheck (valfield) return {" ",function (widget) =

-		gCharCreateStatLock[valfield] =3D not gCharCreateStatLock[valfield]
-		widget.AutoScaledButton_text.gfx:SetText(gCharCreateStatLock[valfield] a=
nd "L" or "")
-		end} end
-		=

-	-- generic value add/sub
-	function MyAddNumCtrl (valfield,rules,row) =

-		table.insert(row,{"-10",function () MyModValue(valfield,rules,-10) end})
-		table.insert(row,{"-1",	function () MyModValue(valfield,rules,-1) end})
-		table.insert(row,{"+1",	function () MyModValue(valfield,rules, 1) end})
-		table.insert(row,{"+10",function () MyModValue(valfield,rules, 10) end})
-		return row =

-	end
-	function MyModValue (valfield,rules,wantedadd) =

-		local curval =3D gCharCreateData[valfield]
-		local newval =3D math.max(rules.min,math.min(rules.max,curval+wantedadd))
-		wantedadd =3D newval - curval
-		if (wantedadd =3D=3D 0) then return end
-		=

-		local realadd =3D 0
-		for k,other in pairs(rules.fields) do =

-			if (other ~=3D valfield and (not gCharCreateStatLock[other])) then
-				local otherold =3D gCharCreateData[other]
-				local othernew =3D math.max(rules.min,math.min(rules.max,otherold - wa=
ntedadd))
-				MainMenu_CharCreate_SetValue(other,othernew)
-				local diff =3D othernew - otherold -- if i want to add, this is negati=
ve
-				realadd =3D realadd - diff
-				wantedadd =3D wantedadd + diff
-			end
-		end
-		if (realadd =3D=3D 0) then return end
-		=

-		gCharCreateData.prof =3D 0
-		MainMenu_CharCreate_SetValue(valfield,curval + realadd)
-	end
-	=

-	-- 3 stats
-	local rules =3D {min=3D10,max=3D60,sum=3D80,fields=3D{"str","dex","int"}}
-	gCharCreateData.str =3D 60
-	gCharCreateData.dex =3D 10
-	gCharCreateData.int =3D 10
-	local valfield=3D"str" table.insert(rows,MyAddNumCtrl(valfield,rules,{{"S=
tr:"},{""..gCharCreateData[valfield],controlname=3Dvalfield},{""},MyCheck(v=
alfield)}))
-	local valfield=3D"dex" table.insert(rows,MyAddNumCtrl(valfield,rules,{{"D=
ex:"},{""..gCharCreateData[valfield],controlname=3Dvalfield},{""},MyCheck(v=
alfield)}))
-	local valfield=3D"int" table.insert(rows,MyAddNumCtrl(valfield,rules,{{"I=
nt:"},{""..gCharCreateData[valfield],controlname=3Dvalfield},{""},MyCheck(v=
alfield)}))
-	=

-	-- 3 skills
-	local rules =3D {min=3D0,max=3D50,sum=3D100,fields=3D{"skill1value","skil=
l2value","skill3value"}}
-	gCharCreateData.skill1value =3D 50
-	gCharCreateData.skill2value =3D 50
-	gCharCreateData.skill3value =3D 0
-	for i =3D 1,3 do =

-		local valfield1 =3D "skill"..i
-		local valfield2 =3D "skill"..i.."value"
-		gCharCreateDataEnums[valfield1] =3D skilllist
-		table.insert(rows,MyAddNumCtrl(valfield2,rules,{	{"Skill"..i..":"},
-							{""..gCharCreateData[valfield2],controlname=3Dvalfield2},
-							{"---",function (w) gCharCreateData.prof =3D 0 MainMenu_CharCreate_=
Choose(w,2) end,controlname=3Dvalfield1},
-							MyCheck(valfield2),
-						}))
-	end
-	=

-	--[[
-	-- stats : min=3D10,max=3D60,sum=3D80
-	-- skill : min=3D0,max=3D50,sum=3D100
-	newChar.Hue =3D newChar.Race.ClipSkinHue( args.Hue & 0x3FFF ) | 0x8000;
-	if( race.ValidateHair( newChar, args.HairID ) )
-	newChar.HairHue =3D race.ClipHairHue( args.HairHue & 0x3FFF );
-	if( race.ValidateFacialHair( newChar, args.BeardID ) )
-	newChar.FacialHairHue =3D race.ClipHairHue( args.BeardHue & 0x3FFF );
-			int hue =3D Utility.ClipDyedHue( shirtHue & 0x3FFF );
-			int hue =3D Utility.ClipDyedHue( pantsHue & 0x3FFF );
-			=

-			public static int ClipDyedHue( int hue ) {
-				if ( hue < 2 ) return 2;
-				else if ( hue > 1001 ) return 1001;
-				else return hue;
-			}
-			=

-			public override bool human:ValidateHair( bool female, int itemID ) {
-				if( itemID =3D=3D 0 ) return true;
-				if( (female && itemID =3D=3D 0x2048) || (!female && itemID =3D=3D 0x20=
46 ) ) return false;	//Buns & Receeding Hair
-				if( itemID >=3D 0x203B && itemID <=3D 0x203D ) return true;
-				if( itemID >=3D 0x2044 && itemID <=3D 0x204A ) return true;
-				return false;
-			}
-			public override bool elf:ValidateHair( bool female, int itemID )
-			{
-				if( itemID =3D=3D 0 ) return true;
-				if( (female && (itemID =3D=3D 0x2FCD || itemID =3D=3D 0x2FBF)) || (!fe=
male && (itemID =3D=3D 0x2FCC || itemID =3D=3D 0x2FD0)) ) return false;
-				if( itemID >=3D 0x2FBF && itemID <=3D 0x2FC2 ) return true;
-				if( itemID >=3D 0x2FCC && itemID <=3D 0x2FD1 ) return true;
-				return false;
-			}
-			public override bool human:ValidateFacialHair( bool female, int itemID =
) {
-				if( itemID =3D=3D 0 ) return true;
-				if( female ) return false;
-				if( itemID >=3D 0x203E && itemID <=3D 0x2041 ) return true;
-				if( itemID >=3D 0x204B && itemID <=3D 0x204D ) return true;
-				return false;
-			}
-			public override bool elf:ValidateFacialHair( bool female, int itemID ) {
-				return (itemID =3D=3D 0);
-			}
-			=

-		public override int human:ClipHairHue( int hue )
-		{
-			if( hue < 1102 ) return 1102;
-			else if( hue > 1149 ) return 1149;
-			else return hue;
-		}
-		public override int elf:ClipHairHue( int hue )
-		{
-				{
-					0x034, 0x035, 0x036, 0x037, 0x038, 0x039, 0x058, 0x08E,
-					0x08F, 0x090, 0x091, 0x092, 0x101, 0x159, 0x15A, 0x15B,
-					0x15C, 0x15D, 0x15E, 0x128, 0x12F, 0x1BD, 0x1E4, 0x1F3,
-					0x207, 0x211, 0x239, 0x251, 0x26C, 0x2C3, 0x2C9, 0x31D,
-					0x31E, 0x31F, 0x320, 0x321, 0x322, 0x323, 0x324, 0x325,
-					0x326, 0x369, 0x386, 0x387, 0x388, 0x389, 0x38A, 0x59D,
-					0x6B8, 0x725, 0x853
-				}
-			for( int i =3D 0; i < m_HairHues.Length; i++ )
-				if( m_HairHues[i] =3D=3D hue )
-					return hue;
-			return m_HairHues[0];
-		}
-	]]--
-	=

-	--[[
-	table.insert(rows,{{"SkinColor:"},			{""},	{"",function (w) MainMenu_Char=
Create_ChooseColor(w) end,controlname=3D"skinColor"}})
-	table.insert(rows,{{"HairColor:"},			{""},	{"",function (w) MainMenu_Char=
Create_ChooseColor(w) end,controlname=3D"hairColor"}})
-	table.insert(rows,{{"BeardColor:"},			{""},	{"",function (w) MainMenu_Cha=
rCreate_ChooseColor(w) end,controlname=3D"facialHairColor"}})
-	table.insert(rows,{{"ShirtColor:"},			{""},	{"",function (w) MainMenu_Cha=
rCreate_ChooseColor(w) end,controlname=3D"shirtColor"}})
-	table.insert(rows,{{"PantsColor:"},			{""},	{"",function (w) MainMenu_Cha=
rCreate_ChooseColor(w) end,controlname=3D"pantsColor"}})
-	=

-	local hairlist =3D {"none"}
-	local beardlist =3D {"none"}
-	local citylist =3D {"none"}
-	=

-	table.insert(rows,{{"Hair:"},				{""},	{hairlist[1],function (w) MainMenu=
_CharCreate_Choose(w) end,controlname=3D"hairStyle"}})
-	table.insert(rows,{{"Beard:"},				{""},	{hairlist[1],function (w) MainMen=
u_CharCreate_Choose(w) end,controlname=3D"facialHair"}})
-	-- uogamers: 0=3Dyew,1=3Dminoc,2=3Dbrit,3=3Dmoonglow,4=3Dtrinsik,5=3DMagi=
ncia,6=3Djhelom,7=3Dscara,8=3Dvesper,9=3Docclo
-	]]--
-	=

-	-- starting city
-	local citylist =3D SortedArrayFromAssocTable(gCities,function (a,b) retur=
n a.i < b.i end)
-	for k,city in pairs(citylist) do citylist[k] =3D {id=3Dcity.index,name=3D=
city.name..":"..city.tavern} end
-	local valfield =3D "location"
-	gCharCreateDataEnums[valfield] =3D citylist
-	table.insert(rows,{{"Location:"},			{""},	{citylist[1].name,function (w) =
MainMenu_CharCreate_Choose(w) end,controlname=3Dvalfield}})
-	=

-	=

-	table.insert(rows,{{"Create Char",MainMenu_CharCreate_Submit}})
-	table.insert(rows,{{""}})
-	local templates =3D GetCharCreationTemplates() -- see lib.charcreate.lua =
: uo/Prof.txt =

-	local validtemplates =3D {"Samurai", "Ninja", "Paladin","Necromancer", "W=
arrior","Mage","Blacksmith"}
-	for k2,template in pairs(templates) do
-		print("chartemplate",template.Name,in_array(template.Name,validtemplates=
))
-		if (in_array(template.Name,validtemplates)) then
-			table.insert(rows,{{""},{""},{"Template:"..template.Name,function () =

-					for k,v in pairs(CharCreateTemplateMod_GetValues(template)) do MainMe=
nu_CharCreate_SetValue(k,v) end
-				end}})
-		end
-	end
-	table.insert(rows,{{""}})
-	table.insert(rows,{{"Back",MainMenu_CharCreate_Back}})
-	gMainMenuDialog_CharCreate =3D MainMenu_MakeTableDlg(rows) =

-end
-
-
--- utils
-
-function MainMenu_CharCreate_SetValue (valfield,value)
-	gCharCreateData[valfield] =3D value
-	local widget =3D gMainMenuDialog_CharCreate.controls[valfield]
-	local enum =3D gCharCreateDataEnums[valfield]
-	print("MainMenu_CharCreate_SetValue",valfield,value,enum,widget)
-	if (not widget) then return end
-	if (enum) then =

-		-- chooser button
-		for k,v in pairs(gCharCreateDataEnums[valfield]) do
-			if (v.id =3D=3D value) then
-				widget.AutoScaledButton_text.gfx:SetText(v.name)
-			end
-		end
-	else =

-		-- text
-		widget.gfx:SetText(""..value)
-	end
-end
-
-function MainMenu_CharCreate_Choose (widget,cols)
-	MainMenu_CharCreate_Choose_Stop()
-	local rows =3D {}
-	local lastrow
-	local valfield =3D widget.controlname
-	cols =3D cols or 1
-	for k,v in pairs(gCharCreateDataEnums[valfield]) do =

-		local item =3D {v.name,function ()
-					print("MainMenu_CharCreate_Choose",v.id,v.name)
-					MainMenu_CharCreate_SetValue(valfield,v.id)
-					MainMenu_CharCreate_Choose_Stop()
-					end}
-		if (math.mod(k-1,cols) =3D=3D 0) then
-			lastrow =3D {item}
-			table.insert(rows,lastrow)
-		else
-			table.insert(lastrow,item)
-		end
-	end
-	table.insert(rows,{{"Cancel",MainMenu_CharCreate_Choose_Stop}})
-	gMainMenuDialog_CharCreate_Choose =3D MainMenu_MakeTableDlg(rows,300,10) =

-end
-function MainMenu_CharCreate_Choose_Stop ()
-	if (gMainMenuDialog_CharCreate_Choose) then =

-		gMainMenuDialog_CharCreate_Choose:Destroy() =

-		gMainMenuDialog_CharCreate_Choose =3D nil
-	end
-end
-
--- rest =

-
-function MainMenu_CharCreate_Back ()
-	MainMenu_CharList_Start()
-end
- =

-function MainMenu_CharCreate_Stop () =

-	if (gMainMenuDialog_CharCreate) then =

-		gMainMenuDialog_CharCreate:Destroy() =

-		gMainMenuDialog_CharCreate =3D nil
-	end
-end
-
-function MainMenu_CharCreate_Submit ()
-	-- TODO
-	print("##########################")
-	print("MainMenu_CharCreate_Submit")
-	gCharCreateData.slot =3D MainMenu_CharCreate_GetFreeSlot()
-	gCharCreateData.name =3D gMainMenuDialog_CharCreate:GetEditText("name")
-	for k,v in pairs(gCharCreateData) do print(k,v) end
-	local chardata =3D CreateSampleCharData()
-	for k,v in pairs(gCharCreateData) do chardata[k] =3D v end
-	Send_CharCreate(chardata)
-	MainMenu_CharCreate_Stop()
-end
+-- kPacket_CharacterCreation -- 0x00
+function MainMenu_CharCreate_Start ()
+    local forbiddenskills =3D {   gCharCreateSkillIDs["Stealth"],
+                                gCharCreateSkillIDs["Remove Trap"],
+                                gCharCreateSkillIDs["Spellweaving"], } -- =
can't choose from those at charcreate
+    =

+--  print("########################")
+--  print("MainMenu_CharCreate_Start",freeslot)
+    MainMenuStopAllMenus()
+
+    gCharCreateData =3D {}
+    gCharCreateDataEnums =3D {}
+    =

+    local skilllist =3D {}
+    for skillid,name in pairs(glSkillNames) do =

+        if (not in_array(skillid-1,forbiddenskills)) then =

+            table.insert(skilllist,{id=3Dskillid-1,name=3Dname})
+        end
+    end
+    skilllist =3D SortedArrayFromAssocTable(skilllist,function (a,b) retur=
n a.name < b.name end)
+    =

+    local sexlist =3D {   {id=3D0,name=3D"Human/Male"},
+                        {id=3D1,name=3D"Human/Female"},
+                        {id=3D2,name=3D"Elf/Male"},
+                        {id=3D3,name=3D"Elf/Female"},
+                        }
+    gCharCreateDataEnums["sex"] =3D sexlist
+        =

+    local rows =3D {}
+    table.insert(rows,{{"Create character"}})
+    table.insert(rows,{{"Name:"},           {""},   {type=3D"EditText",w=
=3D128,h=3D16,text=3D"",controlname=3D"name"}})
+    table.insert(rows,{{"Race/Gender:"},    {""},   {sexlist[1].name,funct=
ion (w) MainMenu_CharCreate_Choose(w) end,controlname=3D"sex"}})
+    =

+    =

+    -- lock stats
+    gCharCreateStatLock =3D {}
+    function MyCheck (valfield) return {" ",function (widget) =

+        gCharCreateStatLock[valfield] =3D not gCharCreateStatLock[valfield]
+        widget.AutoScaledButton_text.gfx:SetText(gCharCreateStatLock[valfi=
eld] and "L" or "")
+        end} end
+        =

+    -- generic value add/sub
+    function MyAddNumCtrl (valfield,rules,row) =

+        table.insert(row,{"-10",function () MyModValue(valfield,rules,-10)=
 end})
+        table.insert(row,{"-1", function () MyModValue(valfield,rules,-1) =
end})
+        table.insert(row,{"+1", function () MyModValue(valfield,rules, 1) =
end})
+        table.insert(row,{"+10",function () MyModValue(valfield,rules, 10)=
 end})
+        return row =

+    end
+    function MyModValue (valfield,rules,wantedadd) =

+        local curval =3D gCharCreateData[valfield]
+        local newval =3D math.max(rules.min,math.min(rules.max,curval+want=
edadd))
+        wantedadd =3D newval - curval
+        if (wantedadd =3D=3D 0) then return end
+        =

+        local realadd =3D 0
+        for k,other in pairs(rules.fields) do =

+            if (other ~=3D valfield and (not gCharCreateStatLock[other])) =
then
+                local otherold =3D gCharCreateData[other]
+                local othernew =3D math.max(rules.min,math.min(rules.max,o=
therold - wantedadd))
+                MainMenu_CharCreate_SetValue(other,othernew)
+                local diff =3D othernew - otherold -- if i want to add, th=
is is negative
+                realadd =3D realadd - diff
+                wantedadd =3D wantedadd + diff
+            end
+        end
+        if (realadd =3D=3D 0) then return end
+        =

+        gCharCreateData.prof =3D 0
+        MainMenu_CharCreate_SetValue(valfield,curval + realadd)
+    end
+    =

+    -- 3 stats
+    local rules =3D {min=3D10,max=3D60,sum=3D80,fields=3D{"str","dex","int=
"}}
+    gCharCreateData.str =3D 60
+    gCharCreateData.dex =3D 10
+    gCharCreateData.int =3D 10
+    local valfield=3D"str" table.insert(rows,MyAddNumCtrl(valfield,rules,{=
{"Str:"},{""..gCharCreateData[valfield],controlname=3Dvalfield},{""},MyChec=
k(valfield)}))
+    local valfield=3D"dex" table.insert(rows,MyAddNumCtrl(valfield,rules,{=
{"Dex:"},{""..gCharCreateData[valfield],controlname=3Dvalfield},{""},MyChec=
k(valfield)}))
+    local valfield=3D"int" table.insert(rows,MyAddNumCtrl(valfield,rules,{=
{"Int:"},{""..gCharCreateData[valfield],controlname=3Dvalfield},{""},MyChec=
k(valfield)}))
+    =

+    -- 3 skills
+    local rules =3D {min=3D0,max=3D50,sum=3D100,fields=3D{"skill1value","s=
kill2value","skill3value"}}
+    gCharCreateData.skill1value =3D 50
+    gCharCreateData.skill2value =3D 50
+    gCharCreateData.skill3value =3D 0
+    for i =3D 1,3 do =

+        local valfield1 =3D "skill"..i
+        local valfield2 =3D "skill"..i.."value"
+        gCharCreateDataEnums[valfield1] =3D skilllist
+        table.insert(rows,MyAddNumCtrl(valfield2,rules,{    {"Skill"..i.."=
:"},
+                            {""..gCharCreateData[valfield2],controlname=3D=
valfield2},
+                            {"---",function (w) gCharCreateData.prof =3D 0=
 MainMenu_CharCreate_Choose(w,2) end,controlname=3Dvalfield1},
+                            MyCheck(valfield2),
+                        }))
+    end
+    =

+    --[[
+    -- stats : min=3D10,max=3D60,sum=3D80
+    -- skill : min=3D0,max=3D50,sum=3D100
+    newChar.Hue =3D newChar.Race.ClipSkinHue( args.Hue & 0x3FFF ) | 0x8000;
+    if( race.ValidateHair( newChar, args.HairID ) )
+    newChar.HairHue =3D race.ClipHairHue( args.HairHue & 0x3FFF );
+    if( race.ValidateFacialHair( newChar, args.BeardID ) )
+    newChar.FacialHairHue =3D race.ClipHairHue( args.BeardHue & 0x3FFF );
+            int hue =3D Utility.ClipDyedHue( shirtHue & 0x3FFF );
+            int hue =3D Utility.ClipDyedHue( pantsHue & 0x3FFF );
+            =

+            public static int ClipDyedHue( int hue ) {
+                if ( hue < 2 ) return 2;
+                else if ( hue > 1001 ) return 1001;
+                else return hue;
+            }
+            =

+            public override bool human:ValidateHair( bool female, int item=
ID ) {
+                if( itemID =3D=3D 0 ) return true;
+                if( (female && itemID =3D=3D 0x2048) || (!female && itemID=
 =3D=3D 0x2046 ) ) return false;  //Buns & Receeding Hair
+                if( itemID >=3D 0x203B && itemID <=3D 0x203D ) return true;
+                if( itemID >=3D 0x2044 && itemID <=3D 0x204A ) return true;
+                return false;
+            }
+            public override bool elf:ValidateHair( bool female, int itemID=
 )
+            {
+                if( itemID =3D=3D 0 ) return true;
+                if( (female && (itemID =3D=3D 0x2FCD || itemID =3D=3D 0x2F=
BF)) || (!female && (itemID =3D=3D 0x2FCC || itemID =3D=3D 0x2FD0)) ) retur=
n false;
+                if( itemID >=3D 0x2FBF && itemID <=3D 0x2FC2 ) return true;
+                if( itemID >=3D 0x2FCC && itemID <=3D 0x2FD1 ) return true;
+                return false;
+            }
+            public override bool human:ValidateFacialHair( bool female, in=
t itemID ) {
+                if( itemID =3D=3D 0 ) return true;
+                if( female ) return false;
+                if( itemID >=3D 0x203E && itemID <=3D 0x2041 ) return true;
+                if( itemID >=3D 0x204B && itemID <=3D 0x204D ) return true;
+                return false;
+            }
+            public override bool elf:ValidateFacialHair( bool female, int =
itemID ) {
+                return (itemID =3D=3D 0);
+            }
+            =

+        public override int human:ClipHairHue( int hue )
+        {
+            if( hue < 1102 ) return 1102;
+            else if( hue > 1149 ) return 1149;
+            else return hue;
+        }
+        public override int elf:ClipHairHue( int hue )
+        {
+                {
+                    0x034, 0x035, 0x036, 0x037, 0x038, 0x039, 0x058, 0x08E,
+                    0x08F, 0x090, 0x091, 0x092, 0x101, 0x159, 0x15A, 0x15B,
+                    0x15C, 0x15D, 0x15E, 0x128, 0x12F, 0x1BD, 0x1E4, 0x1F3,
+                    0x207, 0x211, 0x239, 0x251, 0x26C, 0x2C3, 0x2C9, 0x31D,
+                    0x31E, 0x31F, 0x320, 0x321, 0x322, 0x323, 0x324, 0x325,
+                    0x326, 0x369, 0x386, 0x387, 0x388, 0x389, 0x38A, 0x59D,
+                    0x6B8, 0x725, 0x853
+                }
+            for( int i =3D 0; i < m_HairHues.Length; i++ )
+                if( m_HairHues[i] =3D=3D hue )
+                    return hue;
+            return m_HairHues[0];
+        }
+    ]]--
+    =

+    --[[
+    table.insert(rows,{{"SkinColor:"},          {""},   {"",function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D"skinColor"}})
+    table.insert(rows,{{"HairColor:"},          {""},   {"",function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D"hairColor"}})
+    table.insert(rows,{{"BeardColor:"},         {""},   {"",function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D"facialHairColor"}})
+    table.insert(rows,{{"ShirtColor:"},         {""},   {"",function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D"shirtColor"}})
+    table.insert(rows,{{"PantsColor:"},         {""},   {"",function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D"pantsColor"}})
+    =

+    local hairlist =3D {"none"}
+    local beardlist =3D {"none"}
+    local citylist =3D {"none"}
+    =

+    table.insert(rows,{{"Hair:"},               {""},   {hairlist[1],funct=
ion (w) MainMenu_CharCreate_Choose(w) end,controlname=3D"hairStyle"}})
+    table.insert(rows,{{"Beard:"},              {""},   {hairlist[1],funct=
ion (w) MainMenu_CharCreate_Choose(w) end,controlname=3D"facialHair"}})
+    -- uogamers: 0=3Dyew,1=3Dminoc,2=3Dbrit,3=3Dmoonglow,4=3Dtrinsik,5=3DM=
agincia,6=3Djhelom,7=3Dscara,8=3Dvesper,9=3Docclo
+    ]]--
+    =

+    -- starting city
+    local citylist =3D SortedArrayFromAssocTable(gCities,function (a,b) re=
turn a.i < b.i end)
+    for k,city in pairs(citylist) do citylist[k] =3D {id=3Dcity.index,name=
=3Dcity.name..":"..city.tavern} end
+    local valfield =3D "location"
+    gCharCreateDataEnums[valfield] =3D citylist
+    table.insert(rows,{{"Location:"},           {""},   {citylist[1].name,=
function (w) MainMenu_CharCreate_Choose(w) end,controlname=3Dvalfield}})
+    =

+    =

+    table.insert(rows,{{"Create Char",MainMenu_CharCreate_Submit}})
+    table.insert(rows,{{""}})
+    local templates =3D GetCharCreationTemplates() -- see lib.charcreate.l=
ua : uo/Prof.txt =

+    local validtemplates =3D {"Samurai", "Ninja", "Paladin","Necromancer",=
 "Warrior","Mage","Blacksmith"}
+    for k2,template in pairs(templates) do
+--      print("chartemplate",template.Name,in_array(template.Name,validtem=
plates))
+        if (in_array(template.Name,validtemplates)) then
+            table.insert(rows,{{""},{""},{"Template:"..template.Name,funct=
ion () =

+                    for k,v in pairs(CharCreateTemplateMod_GetValues(templ=
ate)) do MainMenu_CharCreate_SetValue(k,v) end
+                end}})
+        end
+    end
+    table.insert(rows,{{""}})
+    table.insert(rows,{{"Back",MainMenu_CharCreate_Back}})
+    gMainMenuDialog_CharCreate =3D MainMenu_MakeTableDlg(rows) =

+end
+
+
+-- utils
+
+function MainMenu_CharCreate_SetValue (valfield,value)
+    gCharCreateData[valfield] =3D value
+    local widget =3D gMainMenuDialog_CharCreate.controls[valfield]
+    local enum =3D gCharCreateDataEnums[valfield]
+--  print("MainMenu_CharCreate_SetValue",valfield,value,enum,widget)
+    if (not widget) then return end
+    if (enum) then =

+        -- chooser button
+        for k,v in pairs(gCharCreateDataEnums[valfield]) do
+            if (v.id =3D=3D value) then
+                widget.AutoScaledButton_text.gfx:SetText(v.name)
+            end
+        end
+    else =

+        -- text
+        widget.gfx:SetText(""..value)
+    end
+end
+
+function MainMenu_CharCreate_Choose (widget,cols)
+    MainMenu_CharCreate_Choose_Stop()
+    local rows =3D {}
+    local lastrow
+    local valfield =3D widget.controlname
+    cols =3D cols or 1
+    for k,v in pairs(gCharCreateDataEnums[valfield]) do =

+        local item =3D {v.name,function ()
+--                  print("MainMenu_CharCreate_Choose",v.id,v.name)
+                    MainMenu_CharCreate_SetValue(valfield,v.id)
+                    MainMenu_CharCreate_Choose_Stop()
+                    end}
+        if (math.mod(k-1,cols) =3D=3D 0) then
+            lastrow =3D {item}
+            table.insert(rows,lastrow)
+        else
+            table.insert(lastrow,item)
+        end
+    end
+    table.insert(rows,{{"Cancel",MainMenu_CharCreate_Choose_Stop}})
+    gMainMenuDialog_CharCreate_Choose =3D MainMenu_MakeTableDlg(rows,300,1=
0) =

+end
+function MainMenu_CharCreate_Choose_Stop ()
+    if (gMainMenuDialog_CharCreate_Choose) then =

+        gMainMenuDialog_CharCreate_Choose:Destroy() =

+        gMainMenuDialog_CharCreate_Choose =3D nil
+    end
+end
+
+-- rest =

+
+function MainMenu_CharCreate_Back ()
+    MainMenu_CharList_Start()
+end
+ =

+function MainMenu_CharCreate_Stop () =

+    if (gMainMenuDialog_CharCreate) then =

+        gMainMenuDialog_CharCreate:Destroy() =

+        gMainMenuDialog_CharCreate =3D nil
+    end
+end
+
+function MainMenu_CharCreate_Submit ()
+    -- TODO
+--  print("##########################")
+--  print("MainMenu_CharCreate_Submit")
+    gCharCreateData.slot =3D MainMenu_CharCreate_GetFreeSlot()
+    gCharCreateData.name =3D gMainMenuDialog_CharCreate:GetEditText("name")
+    for k,v in pairs(gCharCreateData) do print(k,v) end
+    local chardata =3D CreateSampleCharData()
+    for k,v in pairs(gCharCreateData) do chardata[k] =3D v end
+    Send_CharCreate(chardata)
+    MainMenu_CharCreate_Stop()
+end

Modified: trunk/lua/lib.mainmenu.charlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.charlist.lua (original)
+++ trunk/lua/lib.mainmenu.charlist.lua Sat Mar 14 02:24:51 2009
@@ -1,132 +1,132 @@
-
--- for k,char in ipairs(mychars) do  char.id,char.name
-function MainMenu_GetSortedCharlist (charlist)
-	charlist =3D charlist or gShardCharlist
-	local mychars =3D {}
-	for i=3D0,20 do if (charlist.chars[i]) then table.insert(mychars,{id=3Di,=
name=3Dcharlist.chars[i].name}) else break end end
-	--~ table.sort(mychars,function (a,b) return a.name < b.name end) -- sort=
 by name
-	table.sort(mychars,function (a,b) return a.id < b.id end) -- sort by char=
slot, same as in original client charlist
-	return mychars
-end
-function MainMenu_CharCreate_GetFreeSlot ()
-	local mychars =3D MainMenu_GetSortedCharlist()
-	for k,char in ipairs(mychars) do if (char.name =3D=3D "") then return cha=
r.id end end
-end
- =

-function MainMenu_CharList_Start () =

-	print("########################")
-	print("MainMenu_CharList_Start")
-	MainMenuStopAllMenus()
-	=

-	local rows =3D {}
-	=

-	local mychars =3D MainMenu_GetSortedCharlist()
-	=

-	local bFreeSlotAvailable =3D false
-	local bAllSlotsEmpty =3D true
-	for k,char in ipairs(mychars) do
-		print("charlist:",k,char,char.name)
-		=

-		if (char.name =3D=3D "") then =

-			bFreeSlotAvailable =3D true
-		else
-			bAllSlotsEmpty =3D false
-			=

-			local fun_char =3D function () MainMenu_SendSelectChar(char.id) end =

-			table.insert(rows,{	{char.name,fun_char},
-								{"3D",function () gCurrentRenderer =3D Renderer3D fun_char() end},
-								{"2D",function () gCurrentRenderer =3D Renderer2D fun_char() end}
-								})
-		end
-		--~ Send_Character_Select(char.id,gGameServerAccount)
-		--~ gSelectedCharName =3D char.name
-	end
-	=

-	if (bFreeSlotAvailable) then table.insert(rows,{{"Create New Character",M=
ainMenu_CharCreate_Start}}) end
-	if (not bAllSlotsEmpty) then table.insert(rows,{{"Delete Character",MainM=
enu_CharDelete_Start}}) end
-	table.insert(rows,{{"Back",MainMenu_AccountList_Back}})
-	gMainMenuDialog_CharList =3D MainMenu_MakeTableDlg(rows) =

-end
-
-
--- char delete
-
-function MainMenu_CharDelete_Start ()
-	local rows =3D {}
-	table.insert(rows,{{"Delete Character:"}})
-	table.insert(rows,{{"(NOT YET IMPLEMENTED)"}})
-	for k,char in ipairs(MainMenu_GetSortedCharlist()) do
-		if (char.name ~=3D "") then
-			local fun_char =3D function () MainMenu_DeleteChar(char.id,char.name) M=
ainMenu_CharDelete_Stop() end
-			table.insert(rows,{	{char.name,fun_char}, })
-		end
-	end
-	table.insert(rows,{{""}})
-	table.insert(rows,{{"Cancel",MainMenu_CharDelete_Stop}})
-	-- TODO : not yet implemented
-	-- send delete request, handle failure 0x85, handle charlist update  0x86
-	MainMenu_CharDelete_Stop()
-	gMainMenuDialog_CharDelete =3D MainMenu_MakeTableDlg(rows) =

-end
-
-function MainMenu_CharDelete_Stop ()
-	if (gMainMenuDialog_CharDelete) then =

-		gMainMenuDialog_CharDelete:Destroy()
-		gMainMenuDialog_CharDelete =3D nil
-	end
-end
-
-function MainMenu_DeleteChar (slot,name)
-	print("MainMenu_DeleteChar : TODO : delete char",slot,name)
-	-- todo : if implemented, remove (NOT YET IMPLEMENTED) in MainMenu_CharDe=
lete_Start
-end
-
---[[
-chardelete-request + success :
-	18:49:03.3879: Client -> Server 0x83 (Length: 39)	kPacket_Account_Delete_=
Character
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.........
-	0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G..l.
-	0020   00 00 01 0A 00 02 0F                               .......
-
-
-	18:49:03.4681: Server -> Client 0x86 (Length: 304)	kPacket_All_Characters=
 (not kPacket_Character_List 0xA9)
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   86 01 30 05 47 68 6F 6E  69 6E 00 00 00 00 00 00   ..0.Ghonin......
-	rest zeroes...
-	=

-chardelete-request + fail :
-	18:38:01.3192: Client -> Server 0x83 (Length: 39)
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.........
-	0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G..l.
-	0020   00 00 00 0A 00 02 0F                               .......
-	=

-	18:38:03.9330: Server -> Client 0x85 (Length: 2)	kPacket_Delete_Character=
_Failed
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   85 03                                              ..
-
-	18:38:03.9330: Server -> Client 0x86 (Length: 304)	kPacket_All_Characters=
 (not kPacket_Character_List 0xA9)
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   86 01 30 05 42 6F 6D 62  00 00 00 00 00 00 00 00   ..0.Bomb........
-	rest zeroes...
-]]--
-
--- acc list =

-
-function MainMenu_CharList_Back ()
-	MainMenuResetNetwork()
-	MainMenu_AccountList_Start()
-end
-
-function MainMenu_CharList_Stop () =

-	if (gMainMenuDialog_CharList) then =

-		gMainMenuDialog_CharList:Destroy() =

-		gMainMenuDialog_CharList =3D nil
-	end
-end
+
+-- for k,char in ipairs(mychars) do  char.id,char.name
+function MainMenu_GetSortedCharlist (charlist)
+    charlist =3D charlist or gShardCharlist
+    local mychars =3D {}
+    for i=3D0,20 do if (charlist.chars[i]) then table.insert(mychars,{id=
=3Di,name=3Dcharlist.chars[i].name}) else break end end
+    --~ table.sort(mychars,function (a,b) return a.name < b.name end) -- s=
ort by name
+    table.sort(mychars,function (a,b) return a.id < b.id end) -- sort by c=
harslot, same as in original client charlist
+    return mychars
+end
+function MainMenu_CharCreate_GetFreeSlot ()
+    local mychars =3D MainMenu_GetSortedCharlist()
+    for k,char in ipairs(mychars) do if (char.name =3D=3D "") then return =
char.id end end
+end
+ =

+function MainMenu_CharList_Start () =

+--  print("########################")
+--  print("MainMenu_CharList_Start")
+    MainMenuStopAllMenus()
+    =

+    local rows =3D {}
+    =

+    local mychars =3D MainMenu_GetSortedCharlist()
+    =

+    local bFreeSlotAvailable =3D false
+    local bAllSlotsEmpty =3D true
+    for k,char in ipairs(mychars) do
+--      print("charlist:",k,char,char.name)
+        =

+        if (char.name =3D=3D "") then =

+            bFreeSlotAvailable =3D true
+        else
+            bAllSlotsEmpty =3D false
+            =

+            local fun_char =3D function () MainMenu_SendSelectChar(char.id=
) end =

+            table.insert(rows,{ {char.name,fun_char},
+                                {"3D",function () gCurrentRenderer =3D Ren=
derer3D fun_char() end},
+                                {"2D",function () gCurrentRenderer =3D Ren=
derer2D fun_char() end}
+                                })
+        end
+        --~ Send_Character_Select(char.id,gGameServerAccount)
+        --~ gSelectedCharName =3D char.name
+    end
+    =

+    if (bFreeSlotAvailable) then table.insert(rows,{{"Create New Character=
",MainMenu_CharCreate_Start}}) end
+    if (not bAllSlotsEmpty) then table.insert(rows,{{"Delete Character",Ma=
inMenu_CharDelete_Start}}) end
+    table.insert(rows,{{"Back",MainMenu_AccountList_Back}})
+    gMainMenuDialog_CharList =3D MainMenu_MakeTableDlg(rows) =

+end
+
+
+-- char delete
+
+function MainMenu_CharDelete_Start ()
+    local rows =3D {}
+    table.insert(rows,{{"Delete Character:"}})
+    table.insert(rows,{{"(NOT YET IMPLEMENTED)"}})
+    for k,char in ipairs(MainMenu_GetSortedCharlist()) do
+        if (char.name ~=3D "") then
+            local fun_char =3D function () MainMenu_DeleteChar(char.id,cha=
r.name) MainMenu_CharDelete_Stop() end
+            table.insert(rows,{ {char.name,fun_char}, })
+        end
+    end
+    table.insert(rows,{{""}})
+    table.insert(rows,{{"Cancel",MainMenu_CharDelete_Stop}})
+    -- TODO : not yet implemented
+    -- send delete request, handle failure 0x85, handle charlist update  0=
x86
+    MainMenu_CharDelete_Stop()
+    gMainMenuDialog_CharDelete =3D MainMenu_MakeTableDlg(rows) =

+end
+
+function MainMenu_CharDelete_Stop ()
+    if (gMainMenuDialog_CharDelete) then =

+        gMainMenuDialog_CharDelete:Destroy()
+        gMainMenuDialog_CharDelete =3D nil
+    end
+end
+
+function MainMenu_DeleteChar (slot,name)
+    print("MainMenu_DeleteChar : TODO : delete char",slot,name)
+    -- todo : if implemented, remove (NOT YET IMPLEMENTED) in MainMenu_Cha=
rDelete_Start
+end
+
+--[[
+chardelete-request + success :
+    18:49:03.3879: Client -> Server 0x83 (Length: 39)   kPacket_Account_De=
lete_Character
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.....=
....
+    0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G=
..l.
+    0020   00 00 01 0A 00 02 0F                               .......
+
+
+    18:49:03.4681: Server -> Client 0x86 (Length: 304)  kPacket_All_Charac=
ters (not kPacket_Character_List 0xA9)
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   86 01 30 05 47 68 6F 6E  69 6E 00 00 00 00 00 00   ..0.Ghonin..=
....
+    rest zeroes...
+    =

+chardelete-request + fail :
+    18:38:01.3192: Client -> Server 0x83 (Length: 39)
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.....=
....
+    0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G=
..l.
+    0020   00 00 00 0A 00 02 0F                               .......
+    =

+    18:38:03.9330: Server -> Client 0x85 (Length: 2)    kPacket_Delete_Cha=
racter_Failed
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   85 03                                              ..
+
+    18:38:03.9330: Server -> Client 0x86 (Length: 304)  kPacket_All_Charac=
ters (not kPacket_Character_List 0xA9)
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   86 01 30 05 42 6F 6D 62  00 00 00 00 00 00 00 00   ..0.Bomb....=
....
+    rest zeroes...
+]]--
+
+-- acc list =

+
+function MainMenu_CharList_Back ()
+    MainMenuResetNetwork()
+    MainMenu_AccountList_Start()
+end
+
+function MainMenu_CharList_Stop () =

+    if (gMainMenuDialog_CharList) then =

+        gMainMenuDialog_CharList:Destroy() =

+        gMainMenuDialog_CharList =3D nil
+    end
+end

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sat Mar 14 02:24:51 2009
@@ -1,258 +1,258 @@
--- handles the menu before starting the game
-
-dofile(libpath .. "lib.mainmenu.background.lua")
-dofile(libpath .. "lib.mainmenu.shardlist.lua")
-dofile(libpath .. "lib.mainmenu.accountlist.lua")
-dofile(libpath .. "lib.mainmenu.charlist.lua")
-dofile(libpath .. "lib.mainmenu.charcreate.lua")
-
-dofile(libpath .. "lib.offlinemode.lua")
-dofile(libpath .. "lib.debugmenu.lua")
-
-
-function StartMainMenu	() =

-	SetUOCursor(0)
-	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-	ChatLine_Init()	=

-	if (MainMenuCommandLine()) then return end
-	MainMenu_Background_Start()
-	MainMenu_ShardList_Start()
-end
-function StepMainMenu	() end
-
-function MainMenuStopAllMenus	() =

-	MainMenu_ShardList_Stop()
-	MainMenu_AccountList_Stop()
-	MainMenu_ServerList_Stop()
-	MainMenu_CharList_Stop()
-	MainMenu_CharCreate_Stop()
-end
-
-function MainMenuResetNetwork () =

-	NetDisconnect()
-	gHuffmanDecode =3D false
-end
-
-
-
--- ***** ***** ***** ***** ***** commandline
-
-function MainMenuCommandLine ()
-	for shardname,shard in pairs(gShardList) do shard.gShardName =3D shardnam=
e end
-	if (gTestNoMainMenu) then return end
-	if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end -- =
journaltest
-	if (gCommandLineSwitches["-jt"]) then ToggleJournal() return true end -- =
journaltest
-	if (gCommandLineSwitches["-mt"]) then ToggleMacroList() return true end -=
- macrolist-test
-	if (gCommandLineSwitches["-so"]) then StartOfflineMode(gCommandLineArgume=
nts[gCommandLineSwitches["-so"]+1]) return true end -- start in offline mode
-	if (gCommandLineSwitches["-sd"]) then StartDebugMenu() return true end --=
 start in debug mode
-	if (gCommandLineSwitches["-co"]) then =

-		local name =3D gCommandLineArguments[gCommandLineSwitches["-co"]+1]
-		local shard =3D gShardList[name]
-		if (shard) then =

-			gAutoLoginCharName =3D gCommandLineArguments[gCommandLineSwitches["-co"=
]+2]
-			=

-			-- if charname specified, and shard hasn't full login already, search k=
nown charlists and passwords
-			if (gAutoLoginCharName and (((shard.gLoginname or "") =3D=3D "") or ((s=
hard.gPassword or "") =3D=3D ""))) then =

-				print("autologin...searching for charname:",gAutoLoginCharName)
-				local charlists =3D FilterTable(ShardMemoryGetList("charlist"),functio=
n (charlist) return	=

-																	charlist.gLoginServerIP		=3D=3D shard.gLoginServerIP and =

-																	charlist.gLoginServerPort	=3D=3D shard.gLoginServerPort e=
nd)
-				for k,charlist in pairs(charlists) do =

-					for i=3D0,20 do =

-						--~ print("..",charlist[i])
-						if (not charlist[i]) then break end
-						if (string.lower(charlist[i]) =3D=3D string.lower(gAutoLoginCharName=
)) then
-							gAutoLoginCharName =3D charlist[i]
-							gLoginname =3D charlist.gLoginname
-							gPassword =3D MainMenu_GetStoredPassword(shard.gLoginServerIP,shard=
.gLoginServerPort,gLoginname)
-							print("found",gAutoLoginCharName,gLoginname)
-						end
-					end
-				end
-			end
-			MainMenu_SelectShard(shard)
-			return true
-		end
-	end -- connect to shard
-end
-
--- ***** ***** ***** ***** ***** Shardfilter
-
-function LoadShardfilter (filterfilepath)
-	if (filterfilepath) then
-		if (file_exists(gMainWorkingDir..filterfilepath) ) then
-			print("Load custom shard-specific Filter: "..gMainWorkingDir..filterfil=
epath)
-			dofile(gMainWorkingDir..filterfilepath)
-		else
-			print("Shard-specific Filter not found: "..gMainWorkingDir..filterfilep=
ath)
-		end
-	end
-end
-
--- ***** ***** ***** ***** ***** actions and events
-
-function MainMenu_SelectShard (shard)
-	print("MainMenu_SelectShard",shard,shard.gShardName)
-	MainMenuStopAllMenus()
-	=

-	LoadShardfilter(shard.gCustomArtFilterFilePath) -- todo : revert on error=
 or back-button ?
-	=

-	-- load global config from shard
-	for k,v in pairs(shard) do _G[k] =3D v end
-	=

-	if (shard.gStartGameWithoutNetwork =3D=3D true) then
-		StartOfflineMode()
-	elseif(shard.gStartInDebugMode =3D=3D true) then
-		StartDebugMenu()
-	else
-		if (gLoginname and gLoginname ~=3D "" and gPassword and gPassword ~=3D "=
") then MainMenu_SendLogin(gLoginname,gPassword) return end
-		MainMenu_AccountList_Start()
-	end
-end
-
--- answered by MainMenuShowServerList
-function MainMenu_SendLogin (user,pass)
-	print("##################################")
-	print("MainMenu_SendLogin",user)
-	MainMenuStopAllMenus()
-	GuiAddChatLine("connecting to shard Login-Server on "..gLoginServerIP..":=
"..gLoginServerPort.." with user "..user)
-
-	-- init net
-	gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServerS=
eed)
-	if (not gNet_State) then =

-		local text =3D "connecting to shard on "..gLoginServerIP..":"..gLoginSer=
verPort.." FAILED !"
-		GuiAddChatLine(text)
-		PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
-		MainMenu_AccountList_Start()
-		return
-	end
-	=

-	Send_Account_Login_Request(user,pass) -- 0x80 kPacket_Account_Login_Reque=
st
-end
-
-function MainMenu_SendLoginAndChar (user,pass,charid,charname)
-	print("##################################")
-	print("MainMenu_SendLoginAndChar",user,charid,charname)
-	gAutoLoginCharID =3D charid
-	gAutoLoginCharName =3D charname
-	MainMenu_SendLogin(user,pass)
-end	=

-
-function MainMenu_GetStoredPassword(host,port,user)
-	-- stored passwords
-	local pass =3D GetStoredPassword(host,port,user)
-	if (pass and pass ~=3D "") then return pass end
-	-- shard configs
-	for k,shard in pairs(gShardList) do =

-		if (shard.gLoginname =3D=3D user and
-			shard.gLoginServerIP =3D=3D host and
-			shard.gLoginServerPort =3D=3D port and
-			shard.gPassword and shard.gPassword ~=3D "") then return shard.gPasswor=
d end
-	end
-end
-
-function MainMenuLoginRejected	(msg)
-	print("##################################")
-	print("MainMenuLoginRejected")
-	MainMenuResetNetwork()
-	MainMenu_AccountList_Start()
-	PlainMessageBox(msg)
-end
-	=

-function MainMenuShowServerList	(serverlist)	=

-	print("##################################")
-	print("MainMenuShowServerList")
-	MainMenuStopAllMenus()
-	=

-	-- if there is only once choice, select it immediately
-	if (countarr(serverlist.servers) =3D=3D 1) then
-		local k,v =3D next(serverlist.servers)
-		MainMenu_SendServer(v.index)
-		return
-	end
-	=

-	-- show serverlist
-	local rows =3D {}
-	for k,v in pairs(serverlist.servers) do
-		local label =3D sprintf("Choose server [%d]%s full=3D%d tz=3D%d ip=3D%s"=
,v.index,v.name,v.full,v.tz,NtoA(v.ip))
-		table.insert(rows,{{label,function () MainMenu_SendServer(v.index) end}})
-	end
-	gMainMenuDialog_ServerList =3D MainMenu_MakeTableDlg(rows)
-end
-
-function MainMenu_ServerList_Stop ()
-	if (gMainMenuDialog_ServerList) then =

-		gMainMenuDialog_ServerList:Destroy() =

-		gMainMenuDialog_ServerList =3D nil
-	end
-end
-
--- answered by MainMenuShowCharList
-function MainMenu_SendServer (iServerID)
-	print("##################################")
-	print("MainMenu_SendServer",iServerID)
-	gSelectedShardName =3D gSubServerNamesByID[iServerID]
-	print("############# + + ++ +++ + +++ + +MainMenu_SendServer",iServerID,g=
SelectedShardName)
-	GuiAddChatLine("connecting to shard Game-Server "..(gSelectedShardName or=
 "???").." on "..gLoginServerIP..":"..gLoginServerPort.." with user "..gLog=
inname)
-	=

-	MainMenuStopAllMenus()
-	Send_GameServer_Select(iServerID or 0) -- 0xA0 kPacket_Server_Select =

-	-- answered by kPacket_Server_Redirect 0x8C, =

-	-- which calls Send_GameServer_PostLogin kPacket_Post_Login 0x91 =

-	-- answered by kPacket_Features 0xB9 and kPacket_Character_List 0xA9 whic=
h calls MainMenuShowCharList
-end
-
-function MainMenu_SendSelectChar	(charid)
-	print("##################################")
-	print("MainMenu_SendSelectChar",charid)		=

-	MainMenuStopAllMenus() =

-	PreLoadAfterManualRenderSwitch()
-	Send_Character_Select(charid,gGameServerAccount) -- 0x5D
-end
-		=

-function MainMenuShowCharList	(charlist)		=

-	print("##################################")
-	print("MainMenuShowCharList")	=

-	MainMenuStopAllMenus() =

-	=

-	gPingActive =3D true
-	gNextPingTime =3D 0
-	gShardCharlist =3D charlist
-	=

-	-- login by charslot id
-	if (gAutoLoginCharID) then MainMenu_SendSelectChar(gAutoLoginCharID) retu=
rn end
-	=

-	-- login by name (commandline)
-	if (gAutoLoginCharName) then =

-		for k,v in pairs(charlist.chars) do
-			if (v.name ~=3D "" and (v.name =3D=3D gAutoLoginCharName or tonumber(gA=
utoLoginCharName) =3D=3D k + 1)) then =

-				local iCharNum =3D k
-				MainMenu_SendSelectChar(iCharNum)
-				gSelectedCharName =3D v.name
-				return
-			end
-		end
-	end
-	=

-	MainMenu_CharList_Start()
-end
-
--- ***** ***** ***** ***** ***** MakeTableDlg for common styling
-
-function MainMenu_MakeTableDlg		(rows,x,y)
-	return guimaker.MakeTableDlg(rows,x or 10,y or 10,false,true,gGuiDefaultS=
tyleSet,"window") =

-end
- =

--- ***** ***** ***** ***** ***** specials
-
-function MainMenu_Special_OfflineMode	() MainMenu_SelectShard({gStartGameW=
ithoutNetwork =3D true}) end
-function MainMenu_Special_DebugMode		() MainMenu_SelectShard({gStartInDebu=
gMode =3D true}) end
-function MainMenu_Special_GfxConfig		()
-	MainMenuStopAllMenus()
-	if (Client_ShowOgreConfig()) then
-		DisplayNotice("please restart iris2 for the changes to take effekt")
-		Exit() -- Terminate()  -- terminate softly is not enough, no frame can b=
e drawn since ogre::root has to be killed for fullscreen switch
-		-- todo : reinit ogre here ? might loose already loaded textures =3D(
-	end
-end
-function MainMenu_Special_Exit			() MainMenuStopAllMenus() Terminate() end
+-- handles the menu before starting the game
+
+dofile(libpath .. "lib.mainmenu.background.lua")
+dofile(libpath .. "lib.mainmenu.shardlist.lua")
+dofile(libpath .. "lib.mainmenu.accountlist.lua")
+dofile(libpath .. "lib.mainmenu.charlist.lua")
+dofile(libpath .. "lib.mainmenu.charcreate.lua")
+
+dofile(libpath .. "lib.offlinemode.lua")
+dofile(libpath .. "lib.debugmenu.lua")
+
+
+function StartMainMenu  () =

+    SetUOCursor(0)
+    if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
+    ChatLine_Init() =

+    if (MainMenuCommandLine()) then return end
+    MainMenu_Background_Start()
+    MainMenu_ShardList_Start()
+end
+function StepMainMenu   () end
+
+function MainMenuStopAllMenus   () =

+    MainMenu_ShardList_Stop()
+    MainMenu_AccountList_Stop()
+    MainMenu_ServerList_Stop()
+    MainMenu_CharList_Stop()
+    MainMenu_CharCreate_Stop()
+end
+
+function MainMenuResetNetwork () =

+    NetDisconnect()
+    gHuffmanDecode =3D false
+end
+
+
+
+-- ***** ***** ***** ***** ***** commandline
+
+function MainMenuCommandLine ()
+    for shardname,shard in pairs(gShardList) do shard.gShardName =3D shard=
name end
+    if (gTestNoMainMenu) then return end
+    if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end =
-- journaltest
+    if (gCommandLineSwitches["-jt"]) then ToggleJournal() return true end =
-- journaltest
+    if (gCommandLineSwitches["-mt"]) then ToggleMacroList() return true en=
d -- macrolist-test
+    if (gCommandLineSwitches["-so"]) then StartOfflineMode(gCommandLineArg=
uments[gCommandLineSwitches["-so"]+1]) return true end -- start in offline =
mode
+    if (gCommandLineSwitches["-sd"]) then StartDebugMenu() return true end=
 -- start in debug mode
+    if (gCommandLineSwitches["-co"]) then =

+        local name =3D gCommandLineArguments[gCommandLineSwitches["-co"]+1]
+        local shard =3D gShardList[name]
+        if (shard) then =

+            gAutoLoginCharName =3D gCommandLineArguments[gCommandLineSwitc=
hes["-co"]+2]
+            =

+            -- if charname specified, and shard hasn't full login already,=
 search known charlists and passwords
+            if (gAutoLoginCharName and (((shard.gLoginname or "") =3D=3D "=
") or ((shard.gPassword or "") =3D=3D ""))) then =

+--              print("autologin...searching for charname:",gAutoLoginChar=
Name)
+                local charlists =3D FilterTable(ShardMemoryGetList("charli=
st"),function (charlist) return =

+                                                                    charli=
st.gLoginServerIP     =3D=3D shard.gLoginServerIP and =

+                                                                    charli=
st.gLoginServerPort   =3D=3D shard.gLoginServerPort end)
+                for k,charlist in pairs(charlists) do =

+                    for i=3D0,20 do =

+                        --~ print("..",charlist[i])
+                        if (not charlist[i]) then break end
+                        if (string.lower(charlist[i]) =3D=3D string.lower(=
gAutoLoginCharName)) then
+                            gAutoLoginCharName =3D charlist[i]
+                            gLoginname =3D charlist.gLoginname
+                            gPassword =3D MainMenu_GetStoredPassword(shard=
.gLoginServerIP,shard.gLoginServerPort,gLoginname)
+--                          print("found",gAutoLoginCharName,gLoginname)
+                        end
+                    end
+                end
+            end
+            MainMenu_SelectShard(shard)
+            return true
+        end
+    end -- connect to shard
+end
+
+-- ***** ***** ***** ***** ***** Shardfilter
+
+function LoadShardfilter (filterfilepath)
+    if (filterfilepath) then
+        if (file_exists(gMainWorkingDir..filterfilepath) ) then
+            print("Load custom shard-specific Filter: "..gMainWorkingDir..=
filterfilepath)
+            dofile(gMainWorkingDir..filterfilepath)
+        else
+            print("Shard-specific Filter not found: "..gMainWorkingDir..fi=
lterfilepath)
+        end
+    end
+end
+
+-- ***** ***** ***** ***** ***** actions and events
+
+function MainMenu_SelectShard (shard)
+--  print("MainMenu_SelectShard",shard,shard.gShardName)
+    MainMenuStopAllMenus()
+    =

+    LoadShardfilter(shard.gCustomArtFilterFilePath) -- todo : revert on er=
ror or back-button ?
+    =

+    -- load global config from shard
+    for k,v in pairs(shard) do _G[k] =3D v end
+    =

+    if (shard.gStartGameWithoutNetwork =3D=3D true) then
+        StartOfflineMode()
+    elseif(shard.gStartInDebugMode =3D=3D true) then
+        StartDebugMenu()
+    else
+        if (gLoginname and gLoginname ~=3D "" and gPassword and gPassword =
~=3D "") then MainMenu_SendLogin(gLoginname,gPassword) return end
+        MainMenu_AccountList_Start()
+    end
+end
+
+-- answered by MainMenuShowServerList
+function MainMenu_SendLogin (user,pass)
+--  print("##################################")
+--  print("MainMenu_SendLogin",user)
+    MainMenuStopAllMenus()
+    GuiAddChatLine("connecting to shard Login-Server on "..gLoginServerIP.=
.":"..gLoginServerPort.." with user "..user)
+
+    -- init net
+    gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServ=
erSeed)
+    if (not gNet_State) then =

+        local text =3D "connecting to shard on "..gLoginServerIP..":"..gLo=
ginServerPort.." FAILED !"
+        GuiAddChatLine(text)
+        PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
+        MainMenu_ShardList_Start()
+        return
+    end
+    =

+    Send_Account_Login_Request(user,pass) -- 0x80 kPacket_Account_Login_Re=
quest
+end
+
+function MainMenu_SendLoginAndChar (user,pass,charid,charname)
+--  print("##################################")
+--  print("MainMenu_SendLoginAndChar",user,charid,charname)
+    gAutoLoginCharID =3D charid
+    gAutoLoginCharName =3D charname
+    MainMenu_SendLogin(user,pass)
+end =

+
+function MainMenu_GetStoredPassword(host,port,user)
+    -- stored passwords
+    local pass =3D GetStoredPassword(host,port,user)
+    if (pass and pass ~=3D "") then return pass end
+    -- shard configs
+    for k,shard in pairs(gShardList) do =

+        if (shard.gLoginname =3D=3D user and
+            shard.gLoginServerIP =3D=3D host and
+            shard.gLoginServerPort =3D=3D port and
+            shard.gPassword and shard.gPassword ~=3D "") then return shard=
.gPassword end
+    end
+end
+
+function MainMenuLoginRejected  (msg)
+--  print("##################################")
+--  print("MainMenuLoginRejected")
+    MainMenuResetNetwork()
+    MainMenu_AccountList_Start()
+    PlainMessageBox(msg)
+end
+    =

+function MainMenuShowServerList (serverlist)    =

+--  print("##################################")
+--  print("MainMenuShowServerList")
+    MainMenuStopAllMenus()
+    =

+    -- if there is only once choice, select it immediately
+    if (countarr(serverlist.servers) =3D=3D 1) then
+        local k,v =3D next(serverlist.servers)
+        MainMenu_SendServer(v.index)
+        return
+    end
+    =

+    -- show serverlist
+    local rows =3D {}
+    for k,v in pairs(serverlist.servers) do
+        local label =3D sprintf("Choose server [%d]%s full=3D%d tz=3D%d ip=
=3D%s",v.index,v.name,v.full,v.tz,NtoA(v.ip))
+        table.insert(rows,{{label,function () MainMenu_SendServer(v.index)=
 end}})
+    end
+    gMainMenuDialog_ServerList =3D MainMenu_MakeTableDlg(rows)
+end
+
+function MainMenu_ServerList_Stop ()
+    if (gMainMenuDialog_ServerList) then =

+        gMainMenuDialog_ServerList:Destroy() =

+        gMainMenuDialog_ServerList =3D nil
+    end
+end
+
+-- answered by MainMenuShowCharList
+function MainMenu_SendServer (iServerID)
+--  print("##################################")
+--  print("MainMenu_SendServer",iServerID)
+    gSelectedShardName =3D gSubServerNamesByID[iServerID]
+--  print("############# + + ++ +++ + +++ + +MainMenu_SendServer",iServerI=
D,gSelectedShardName)
+    GuiAddChatLine("connecting to shard Game-Server "..(gSelectedShardName=
 or "???").." on "..gLoginServerIP..":"..gLoginServerPort.." with user "..g=
Loginname)
+    =

+    MainMenuStopAllMenus()
+    Send_GameServer_Select(iServerID or 0) -- 0xA0 kPacket_Server_Select =

+    -- answered by kPacket_Server_Redirect 0x8C, =

+    -- which calls Send_GameServer_PostLogin kPacket_Post_Login 0x91 =

+    -- answered by kPacket_Features 0xB9 and kPacket_Character_List 0xA9 w=
hich calls MainMenuShowCharList
+end
+
+function MainMenu_SendSelectChar    (charid)
+--  print("##################################")
+--  print("MainMenu_SendSelectChar",charid)     =

+    MainMenuStopAllMenus() =

+    PreLoadAfterManualRenderSwitch()
+    Send_Character_Select(charid,gGameServerAccount) -- 0x5D
+end
+        =

+function MainMenuShowCharList   (charlist)      =

+--  print("##################################")
+--  print("MainMenuShowCharList")   =

+    MainMenuStopAllMenus() =

+    =

+    gPingActive =3D true
+    gNextPingTime =3D 0
+    gShardCharlist =3D charlist
+    =

+    -- login by charslot id
+    if (gAutoLoginCharID) then MainMenu_SendSelectChar(gAutoLoginCharID) r=
eturn end
+    =

+    -- login by name (commandline)
+    if (gAutoLoginCharName) then =

+        for k,v in pairs(charlist.chars) do
+            if (v.name ~=3D "" and (v.name =3D=3D gAutoLoginCharName or to=
number(gAutoLoginCharName) =3D=3D k + 1)) then =

+                local iCharNum =3D k
+                MainMenu_SendSelectChar(iCharNum)
+                gSelectedCharName =3D v.name
+                return
+            end
+        end
+    end
+    =

+    MainMenu_CharList_Start()
+end
+
+-- ***** ***** ***** ***** ***** MakeTableDlg for common styling
+
+function MainMenu_MakeTableDlg      (rows,x,y)
+    return guimaker.MakeTableDlg(rows,x or 10,y or 10,false,true,gGuiDefau=
ltStyleSet,"window") =

+end
+ =

+-- ***** ***** ***** ***** ***** specials
+
+function MainMenu_Special_OfflineMode   () MainMenu_SelectShard({gStartGam=
eWithoutNetwork =3D true}) end
+function MainMenu_Special_DebugMode     () MainMenu_SelectShard({gStartInD=
ebugMode =3D true}) end
+function MainMenu_Special_GfxConfig     ()
+    MainMenuStopAllMenus()
+    if (Client_ShowOgreConfig()) then
+        DisplayNotice("please restart iris2 for the changes to take effekt=
")
+        Exit() -- Terminate()  -- terminate softly is not enough, no frame=
 can be drawn since ogre::root has to be killed for fullscreen switch
+        -- todo : reinit ogre here ? might loose already loaded textures =
=3D(
+    end
+end
+function MainMenu_Special_Exit          () MainMenuStopAllMenus() Terminat=
e() end

Modified: trunk/lua/lib.mainmenu.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.shardlist.lua (original)
+++ trunk/lua/lib.mainmenu.shardlist.lua Sat Mar 14 02:24:51 2009
@@ -1,110 +1,110 @@
-
-function MainMenu_ShardList_Start () =

-	print("########################")
-	print("MainMenu_ShardList_Start")
-	MainMenuStopAllMenus()
-	=

-	-- clear login if returning to this menu from somewhere else
-	gLoginname =3D nil =

-	gPassword =3D nil =

-	gAutoLoginCharID =3D nil
-	gAutoLoginCharName =3D nil
-	=

-	-- prepare shardlist
-	for shardname,shard in pairs(gShardList) do shard.gShardName =3D shardnam=
e end
-	-- sort alphabetically
-	local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a,b)=
 return a.gShardName < b.gShardName end)
-	=

-	local rows =3D {}
-	=

-	-- shards
-	for k,shard in pairs(myshardlist) do
-		local buttonname =3D shard.gShardName
-		if (shard.gLoginname and shard.gLoginname ~=3D "") then buttonname =3D b=
uttonname .. ":" .. shard.gLoginname end
-		table.insert(rows,{{buttonname,function () MainMenu_SelectShard(shard) e=
nd}})
-	end
-	=

-	-- options
-	table.insert(rows,{{""}}) -- spacer
-	table.insert(rows,{{"Add Shard",		MainMenu_Special_ShardAdd}})
-	table.insert(rows,{{"Remove Shard",		MainMenu_Special_ShardRemove}})
-	table.insert(rows,{{"Offline Mode",		MainMenu_Special_OfflineMode}})
-	table.insert(rows,{{"Debug Mode",		MainMenu_Special_DebugMode}})
-	table.insert(rows,{{"Graphic Options",	MainMenu_Special_GfxConfig}})
-	table.insert(rows,{{"Iris Forum",		function () OpenBrowser("http://iris2.=
de/forums/") end}})
-	table.insert(rows,{{"Exit",				MainMenu_Special_Exit}})
-	=

-	gMainMenuDialog_ShardList =3D MainMenu_MakeTableDlg(rows) =

-end
-
-function MainMenu_ShardList_Stop () =

-	if (gMainMenuDialog_ShardList) then =

-		gMainMenuDialog_ShardList:Destroy() =

-		gMainMenuDialog_ShardList =3D nil
-	end
-end
-
-
--- ***** ***** ***** ***** ***** edit shard list
-
-function MainMenu_Special_ShardAdd		() =

-	local rows =3D {}
-	table.insert(rows,{{"Add Shard"}})
-	table.insert(rows,{	{"Name:"},{type=3D"EditText",	w=3D300,h=3D16,text=3D"=
",controlname=3D"i_name"}})
-	table.insert(rows,{	{"Host:"},{type=3D"EditText",	w=3D300,h=3D16,text=3D"=
",controlname=3D"i_host"},
-						{"Port:"},{type=3D"EditText",	w=3D64,h=3D16,text=3D"",controlname=3D=
"i_port"}})
-	=

-	=

-	table.insert(rows,{{"Cancel",MainMenu_Special_ShardAdd_Stop},{"Ok",functi=
on ()
-			local shardname	=3D 			gMainMenuDialog_ShardAdd:GetEditText("i_name")
-			local host		=3D 			gMainMenuDialog_ShardAdd:GetEditText("i_host")
-			local port		=3D tonumber(	gMainMenuDialog_ShardAdd:GetEditText("i_port"=
))
-			local shard =3D {
-				gLoginServerIP	=3Dhost,
-				gLoginServerPort=3Dport,
-				gLoginname=3D"",
-				gPassword=3D"",
-				}
-			gShardList[shardname] =3D shard
-			=

-			-- write xml file  (TODO : overwrite warning ?)
-			local filepath =3D GetShardConfigFilePath(shardname)
-			print("writing shard to file",shardname,host,port,filepath)
-			SimpleXMLSave(filepath,shard)
-			shard.gShardName =3D shardname
-		=

-			MainMenu_ShardList_Start()
-			MainMenu_Special_ShardAdd_Stop()
-		end}})
-	=

-	MainMenu_Special_ShardAdd_Stop()
-	gMainMenuDialog_ShardAdd =3D MainMenu_MakeTableDlg(rows,200,10)
-end
-function MainMenu_Special_ShardAdd_Stop	() =

-	if (gMainMenuDialog_ShardAdd) then gMainMenuDialog_ShardAdd:Destroy() gMa=
inMenuDialog_ShardAdd =3D nil end =

-end
-
-function MainMenu_Special_ShardRemove	()
-	local rows =3D {}
-	table.insert(rows,{{"Remove Shard"}})
-	local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a,b)=
 return a.gShardName < b.gShardName end)	=

-	for k,shard in pairs(myshardlist) do table.insert(rows,{{shard.gShardName=
 or "???",function () =

-			gShardList[shard.gShardName] =3D nil
-			=

-			-- remove xml file
-			local filepath =3D GetShardConfigFilePath(shard.gShardName)
-			local res,msg =3D os.remove(filepath)
-			print("remove shard file",filepath,res,msg)
-			=

-			MainMenu_ShardList_Start()
-			MainMenu_Special_ShardRemove_Stop()
-		end}}) end
-	table.insert(rows,{{""}})
-	table.insert(rows,{{"Cancel",MainMenu_Special_ShardRemove_Stop}})
-	MainMenu_Special_ShardRemove_Stop()
-	gMainMenuDialog_ShardRemove =3D MainMenu_MakeTableDlg(rows,200,10)
-end
-function MainMenu_Special_ShardRemove_Stop	() =

-	if (gMainMenuDialog_ShardRemove) then gMainMenuDialog_ShardRemove:Destroy=
() gMainMenuDialog_ShardRemove =3D nil end =

-end
-
+
+function MainMenu_ShardList_Start () =

+--  print("########################")
+--  print("MainMenu_ShardList_Start")
+    MainMenuStopAllMenus()
+    =

+    -- clear login if returning to this menu from somewhere else
+    gLoginname =3D nil =

+    gPassword =3D nil =

+    gAutoLoginCharID =3D nil
+    gAutoLoginCharName =3D nil
+    =

+    -- prepare shardlist
+    for shardname,shard in pairs(gShardList) do shard.gShardName =3D shard=
name end
+    -- sort alphabetically
+    local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a=
,b) return a.gShardName < b.gShardName end)
+    =

+    local rows =3D {}
+    =

+    -- shards
+    for k,shard in pairs(myshardlist) do
+        local buttonname =3D shard.gShardName
+        if (shard.gLoginname and shard.gLoginname ~=3D "") then buttonname=
 =3D buttonname .. ":" .. shard.gLoginname end
+        table.insert(rows,{{buttonname,function () MainMenu_SelectShard(sh=
ard) end}})
+    end
+    =

+    -- options
+    table.insert(rows,{{""}}) -- spacer
+    table.insert(rows,{{"Add Shard",        MainMenu_Special_ShardAdd}})
+    table.insert(rows,{{"Remove Shard",     MainMenu_Special_ShardRemove}})
+    table.insert(rows,{{"Offline Mode",     MainMenu_Special_OfflineMode}})
+    table.insert(rows,{{"Debug Mode",       MainMenu_Special_DebugMode}})
+    table.insert(rows,{{"Graphic Options",  MainMenu_Special_GfxConfig}})
+    table.insert(rows,{{"Iris Forum",       function () OpenBrowser("http:=
//iris2.de/forums/") end}})
+    table.insert(rows,{{"Exit",             MainMenu_Special_Exit}})
+    =

+    gMainMenuDialog_ShardList =3D MainMenu_MakeTableDlg(rows) =

+end
+
+function MainMenu_ShardList_Stop () =

+    if (gMainMenuDialog_ShardList) then =

+        gMainMenuDialog_ShardList:Destroy() =

+        gMainMenuDialog_ShardList =3D nil
+    end
+end
+
+
+-- ***** ***** ***** ***** ***** edit shard list
+
+function MainMenu_Special_ShardAdd      () =

+    local rows =3D {}
+    table.insert(rows,{{"Add Shard"}})
+    table.insert(rows,{ {"Name:"},{type=3D"EditText", w=3D300,h=3D16,text=
=3D"",controlname=3D"i_name"}})
+    table.insert(rows,{ {"Host:"},{type=3D"EditText", w=3D300,h=3D16,text=
=3D"",controlname=3D"i_host"},
+                        {"Port:"},{type=3D"EditText", w=3D64,h=3D16,text=
=3D"",controlname=3D"i_port"}})
+    =

+    =

+    table.insert(rows,{{"Cancel",MainMenu_Special_ShardAdd_Stop},{"Ok",fun=
ction ()
+            local shardname =3D           gMainMenuDialog_ShardAdd:GetEdit=
Text("i_name")
+            local host      =3D           gMainMenuDialog_ShardAdd:GetEdit=
Text("i_host")
+            local port      =3D tonumber( gMainMenuDialog_ShardAdd:GetEdit=
Text("i_port"))
+            local shard =3D {
+                gLoginServerIP  =3Dhost,
+                gLoginServerPort=3Dport,
+                gLoginname=3D"",
+                gPassword=3D"",
+                }
+            gShardList[shardname] =3D shard
+            =

+            -- write xml file  (TODO : overwrite warning ?)
+            local filepath =3D GetShardConfigFilePath(shardname)
+--          print("writing shard to file",shardname,host,port,filepath)
+            SimpleXMLSave(filepath,shard)
+            shard.gShardName =3D shardname
+        =

+            MainMenu_ShardList_Start()
+            MainMenu_Special_ShardAdd_Stop()
+        end}})
+    =

+    MainMenu_Special_ShardAdd_Stop()
+    gMainMenuDialog_ShardAdd =3D MainMenu_MakeTableDlg(rows,200,10)
+end
+function MainMenu_Special_ShardAdd_Stop () =

+    if (gMainMenuDialog_ShardAdd) then gMainMenuDialog_ShardAdd:Destroy() =
gMainMenuDialog_ShardAdd =3D nil end =

+end
+
+function MainMenu_Special_ShardRemove   ()
+    local rows =3D {}
+    table.insert(rows,{{"Remove Shard"}})
+    local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a=
,b) return a.gShardName < b.gShardName end) =

+    for k,shard in pairs(myshardlist) do table.insert(rows,{{shard.gShardN=
ame or "???",function () =

+            gShardList[shard.gShardName] =3D nil
+            =

+            -- remove xml file
+            local filepath =3D GetShardConfigFilePath(shard.gShardName)
+            local res,msg =3D os.remove(filepath)
+--          print("remove shard file",filepath,res,msg)
+            =

+            MainMenu_ShardList_Start()
+            MainMenu_Special_ShardRemove_Stop()
+        end}}) end
+    table.insert(rows,{{""}})
+    table.insert(rows,{{"Cancel",MainMenu_Special_ShardRemove_Stop}})
+    MainMenu_Special_ShardRemove_Stop()
+    gMainMenuDialog_ShardRemove =3D MainMenu_MakeTableDlg(rows,200,10)
+end
+function MainMenu_Special_ShardRemove_Stop  () =

+    if (gMainMenuDialog_ShardRemove) then gMainMenuDialog_ShardRemove:Dest=
roy() gMainMenuDialog_ShardRemove =3D nil end =

+end
+

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Sat Mar 14 02:24:51 2009
@@ -1,154 +1,136 @@
-
--- paths
-
-function GetConfigDirPath				() return gMainWorkingDir.."config/" end
-function GetShardListDirPath			() return GetConfigDirPath().."shards/" end
-function GetShardMemoryFilePath			() return GetConfigDirPath().."shardmemo=
ry.xml" end
-function GetCharFilePath				() return GetConfigDirPath().."chars/"..table.=
concat({gLoginServerIP,gLoginServerPort,ShardListFileNamePartEncode(gLoginn=
ame),giGameServerID,gCharID},".")..".xml" end
-function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..ShardListFileNamePartEncode(shardname)..".xml" end
-
-function ShardListFileNamePartEncode	(x) return string.gsub(x,"[^0-9a-zA-Z=
_%-%(%) ]",".") end
-
--- notes
-
-function InitShardList () =

-	LoadStoredPasswords()
-	LoadShardMemory()
-	LoadShardList()
-	--~ for shardname,shard in pairs(gShardList) do
-		--~ local filepath =3D GetShardConfigFilePath(shardname)
-		--~ print("InitShardList",shardname,shard,filepath)
-		--~ SimpleXMLSave(filepath,shard)
-	--~ end
-	--~ SimpleXML_Test()
-	--~ os.exit(0)
-end
-
-
-
-
--- ***** ***** ***** ***** ***** chars
-
-
-RegisterListener("Hook_Packet_Character_List",function (charlist) =

-	local plaincharlist =3D {serverid=3DgiGameServerID}
-	for k,v in pairs(charlist.chars) do plaincharlist[k] =3D v.name end
-	plaincharlist.gLoginServerIP =3D gLoginServerIP
-	plaincharlist.gLoginServerPort =3D gLoginServerPort
-	plaincharlist.gLoginname =3D gLoginname
-	plaincharlist.giGameServerID =3D giGameServerID
-	ShardMemorySet("charlist",table.concat({gLoginServerIP,gLoginServerPort,S=
hardListFileNamePartEncode(gLoginname),giGameServerID},":"),plaincharlist)
-end)
-
-RegisterListener("Hook_Player_Full_equip",function (mobiledata,equipmentda=
ta) =

-	if (gShardListPlayerEquipAlreadySaved) then return end
-	gShardListPlayerEquipAlreadySaved =3D true
-	ShardListSavePlayerMobile()
-	RegisterIntervalStepper(30*1000,ShardListSavePlayerMobile) =

-end)
-
-RegisterListener("Hook_Player_Skills",function (skills) =

-	if (gShardListPlayerSkillAlreadySaved) then return end
-	gShardListPlayerSkillAlreadySaved =3D true
-	ShardListSavePlayerMobile()
-end)
-
--- stores body,equip,mount       todo : skills, but change too often for x=
ml
-function ShardListSavePlayerMobile ()
-	local mobile =3D GetPlayerMobile()
-	print("###ShardListSavePlayerMobile",mobile,gPlayerSkills)
-	if (not mobile) then return end
-	if (not gPlayerSkills) then return end
-	local charname =3D gCharName
-	=

-	--[[
-	-- calc and check has, no need to save if nothing changed
-	local hash =3D {mobile.artid,mobile.hue}
-	for k,layer in pairs(gLayerType) do =

-		local item =3D mobile:GetEquipmentAtLayer(layer) =

-		if (item) then table.insert(hash,item.serial) end
-	end
-	for skillid,skill in pairs(gPlayerSkills) do table.insert(hash,skill.base=
_value) end
-	hash =3D table.concat(hash,"#")
-	if (hash =3D=3D gShardListSavePlayerMobile_LastHash) then return end
-	gShardListSavePlayerMobile_LastHash =3D hash
-	print("saving data...",hash)
-	]]--
-	=

-	-- save the data
-	local data =3D {	charname=3Dcharname, artid=3Dmobile.artid, hue=3Dmobile.=
hue, xloc=3Dmobile.xloc, yloc=3Dmobile.yloc, zloc=3Dmobile.zloc, map=3DgMap=
Index, equip=3D{},skills=3D{} }
-	for k,layer in pairs(gLayerType) do =

-		local item =3D mobile:GetEquipmentAtLayer(layer) =

-		if (item) then data.equip[layer] =3D {artid=3Ditem.artid,hue=3Ditem.hue}=
 end
-	end
-	for skillid,skill in pairs(gPlayerSkills) do =

-		data.skills[skillid] =3D {value=3Dskill.value,base_value=3Dskill.base_va=
lue,lockstate=3Dskill.lockstate,name=3DglSkillNames[skillid]} =

-	end
-	data.time =3D os.time()
-	data.timetext =3D os.date("%d %b %Y %H:%M",data.time) -- 10 Feb 2009 16:1=
4       %H:%M:%S
-	SimpleXMLSave(GetCharFilePath(),data)
-end
-
--- ***** ***** ***** ***** ***** shard list =

-
-function LoadShardList () =

-	local path_folder =3D GetShardListDirPath()
-	local arr_files =3D dirlist(path_folder,false,true)
-	for k,filename in pairs(arr_files) do
-		local ext =3D string.lower(string.sub(filename,-4))
-		local shardname =3D string.sub(filename,1,-5)
-		local filepath =3D path_folder .. filename
-		print("LoadShardList",shardname,filepath,ext) =

-		if (ext =3D=3D ".xml") then =

-			gShardList[shardname] =3D SimpleXMLLoad(filepath)
-		end
-	end
-end
- =

--- ***** ***** ***** ***** ***** shard memory =

-
-function LoadShardMemory	() gShardMemory =3D	SimpleXMLLoad(GetShardMemoryF=
ilePath()) or {} end
-function SaveShardMemory	()					SimpleXMLSave(GetShardMemoryFilePath(),gSh=
ardMemory) end
-
-function ShardMemoryGetList	(listname) return gShardMemory[listname] end
-function ShardMemoryGet		(listname,key) =

-	local list =3D gShardMemory[listname]
-	return list and list[key]
-end
-function ShardMemorySet		(listname,key,value)
-	local list =3D gShardMemory[listname]
-	if (not list) then list =3D {} gShardMemory[listname] =3D list end
-	list[key] =3D value
-	SaveShardMemory()
-	print("ShardMemorySet",listname,key)
-end
-
--- ***** ***** ***** ***** ***** stored passwords
-
--- store password when login succeeds
-RegisterListener("Hook_Packet_Server_List",function ()
-	if (not gRememberPassword) then return end
-	SetStoredPassword(gLoginServerIP,gLoginServerPort,gLoginname,gPassword)
-end)
-gStoredPasswords =3D {}
-function GetStoredPasswordsFilePath () return GetConfigDirPath().."passwor=
ds.xml" end
-function SaveStoredPasswords () 					SimpleXMLSave(GetStoredPasswordsFileP=
ath(),gStoredPasswords) end
-function LoadStoredPasswords () gStoredPasswords =3D	SimpleXMLLoad(GetStor=
edPasswordsFilePath()) or {} end
-
-function GetStoredPassword			(host,port,username) return gStoredPasswords[=
host..":"..port..":"..username] end
-function SetStoredPassword			(host,port,username,password) gStoredPassword=
s[host..":"..port..":"..username] =3D password SaveStoredPasswords() end
-function ClearStoredPassword		(host,port,username) gStoredPasswords[host..=
":"..port..":"..username] =3D nil SaveStoredPasswords() end
-function ClearAllStoredPasswords	() gStoredPasswords =3D {} SaveStoredPass=
words() end
-
-function TestStoredPasswords ()
-	local host,port =3D "example.org",2593
-	local user1 =3D "weirdguy"
-	local user2 =3D "somedude"
-	LoadStoredPasswords()
-	--~ SetStoredPassword(host,port,user1,"secret1234")
-	--~ SetStoredPassword(host,port,user2,"secret5555")
-	print(user1,GetStoredPassword(host,port,user1)) --~ weirdguy        secre=
t1234
-	print(user2,GetStoredPassword(host,port,user2)) --~ somedude        secre=
t5555
-	os.exit(0)
-end
-
+
+-- paths
+
+function GetConfigDirPath               () return gMainWorkingDir.."config=
/" end
+function GetShardListDirPath            () return GetConfigDirPath().."sha=
rds/" end
+function GetShardMemoryFilePath         () return GetConfigDirPath().."sha=
rdmemory.xml" end
+function GetCharFilePath                () return GetConfigDirPath().."cha=
rs/"..table.concat({gLoginServerIP,gLoginServerPort,ShardListFileNamePartEn=
code(gLoginname),giGameServerID,gCharID},".")..".xml" end
+function GetShardConfigFilePath         (shardname) return GetShardListDir=
Path()..ShardListFileNamePartEncode(shardname)..".xml" end
+
+function ShardListFileNamePartEncode    (x) return string.gsub(x,"[^0-9a-z=
A-Z_%-%(%) ]",".") end
+
+-- notes
+
+function InitShardList () =

+    LoadStoredPasswords()
+    LoadShardMemory()
+    LoadShardList()
+    --~ for shardname,shard in pairs(gShardList) do
+        --~ local filepath =3D GetShardConfigFilePath(shardname)
+        --~ print("InitShardList",shardname,shard,filepath)
+        --~ SimpleXMLSave(filepath,shard)
+    --~ end
+    --~ SimpleXML_Test()
+    --~ os.exit(0)
+end
+
+-- ***** ***** ***** ***** ***** chars
+
+RegisterListener("Hook_Packet_Character_List",function (charlist) =

+    local plaincharlist =3D {serverid=3DgiGameServerID}
+    for k,v in pairs(charlist.chars) do plaincharlist[k] =3D v.name end
+    plaincharlist.gLoginServerIP =3D gLoginServerIP
+    plaincharlist.gLoginServerPort =3D gLoginServerPort
+    plaincharlist.gLoginname =3D gLoginname
+    plaincharlist.giGameServerID =3D giGameServerID
+    ShardMemorySet("charlist",table.concat({gLoginServerIP,gLoginServerPor=
t,ShardListFileNamePartEncode(gLoginname),giGameServerID},":"),plaincharlis=
t)
+end)
+
+RegisterListener("Hook_Player_Full_equip",function (mobiledata,equipmentda=
ta) =

+    if (gShardListPlayerEquipAlreadySaved) then return end
+    gShardListPlayerEquipAlreadySaved =3D true
+    ShardListSavePlayerMobile()
+    RegisterIntervalStepper(30*1000,ShardListSavePlayerMobile) =

+end)
+
+RegisterListener("Hook_Player_Skills",function (skills) =

+    if (gShardListPlayerSkillAlreadySaved) then return end
+    gShardListPlayerSkillAlreadySaved =3D true
+    ShardListSavePlayerMobile()
+end)
+
+-- stores body,equip,mount       todo : skills, but change too often for x=
ml
+function ShardListSavePlayerMobile ()
+    local mobile =3D GetPlayerMobile()
+    print("###ShardListSavePlayerMobile",mobile,gPlayerSkills)
+    if (not mobile) then return end
+    if (not gPlayerSkills) then return end
+    local charname =3D gCharName
+    =

+    --[[
+    -- calc and check has, no need to save if nothing changed
+    local hash =3D {mobile.artid,mobile.hue}
+    for k,layer in pairs(gLayerType) do =

+        local item =3D mobile:GetEquipmentAtLayer(layer) =

+        if (item) then table.insert(hash,item.serial) end
+    end
+    for skillid,skill in pairs(gPlayerSkills) do table.insert(hash,skill.b=
ase_value) end
+    hash =3D table.concat(hash,"#")
+    if (hash =3D=3D gShardListSavePlayerMobile_LastHash) then return end
+    gShardListSavePlayerMobile_LastHash =3D hash
+    print("saving data...",hash)
+    ]]--
+    =

+    -- save the data
+    local data =3D {  charname=3Dcharname, artid=3Dmobile.artid, hue=3Dmob=
ile.hue, xloc=3Dmobile.xloc, yloc=3Dmobile.yloc, zloc=3Dmobile.zloc, map=3D=
gMapIndex, equip=3D{},skills=3D{} }
+    for k,layer in pairs(gLayerType) do =

+        local item =3D mobile:GetEquipmentAtLayer(layer) =

+        if (item) then data.equip[layer] =3D {artid=3Ditem.artid,hue=3Dite=
m.hue} end
+    end
+    for skillid,skill in pairs(gPlayerSkills) do =

+        data.skills[skillid] =3D {value=3Dskill.value,base_value=3Dskill.b=
ase_value,lockstate=3Dskill.lockstate,name=3DglSkillNames[skillid]} =

+    end
+    data.time =3D os.time()
+    data.timetext =3D os.date("%d %b %Y %H:%M",data.time) -- 10 Feb 2009 1=
6:14       %H:%M:%S
+    SimpleXMLSave(GetCharFilePath(),data)
+end
+
+-- ***** ***** ***** ***** ***** shard list =

+
+function LoadShardList () =

+    local path_folder =3D GetShardListDirPath()
+    local arr_files =3D dirlist(path_folder,false,true)
+    for k,filename in pairs(arr_files) do
+        local ext =3D string.lower(string.sub(filename,-4))
+        local shardname =3D string.sub(filename,1,-5)
+        local filepath =3D path_folder .. filename
+        print("LoadShardList",shardname,filepath,ext) =

+        if (ext =3D=3D ".xml") then =

+            gShardList[shardname] =3D SimpleXMLLoad(filepath)
+        end
+    end
+end
+ =

+-- ***** ***** ***** ***** ***** shard memory =

+
+function LoadShardMemory    () gShardMemory =3D   SimpleXMLLoad(GetShardMe=
moryFilePath()) or {} end
+function SaveShardMemory    ()                  SimpleXMLSave(GetShardMemo=
ryFilePath(),gShardMemory) end
+
+function ShardMemoryGetList (listname) return gShardMemory[listname] end
+function ShardMemoryGet     (listname,key) =

+    local list =3D gShardMemory[listname]
+    return list and list[key]
+end
+function ShardMemorySet     (listname,key,value)
+    local list =3D gShardMemory[listname]
+    if (not list) then list =3D {} gShardMemory[listname] =3D list end
+    list[key] =3D value
+    SaveShardMemory()
+end
+
+-- ***** ***** ***** ***** ***** stored passwords
+
+-- store password when login succeeds
+RegisterListener("Hook_Packet_Server_List",function ()
+    if (not gRememberPassword) then return end
+    SetStoredPassword(gLoginServerIP,gLoginServerPort,gLoginname,gPassword)
+end)
+gStoredPasswords =3D {}
+function GetStoredPasswordsFilePath () return GetConfigDirPath().."passwor=
ds.xml" end
+function SaveStoredPasswords ()                     SimpleXMLSave(GetStore=
dPasswordsFilePath(),gStoredPasswords) end
+function LoadStoredPasswords () gStoredPasswords =3D  SimpleXMLLoad(GetSto=
redPasswordsFilePath()) or {} end
+
+function GetStoredPassword          (host,port,username) return gStoredPas=
swords[host..":"..port..":"..username] end
+function SetStoredPassword          (host,port,username,password) gStoredP=
asswords[host..":"..port..":"..username] =3D password SaveStoredPasswords()=
 end
+function ClearStoredPassword        (host,port,username) gStoredPasswords[=
host..":"..port..":"..username] =3D nil SaveStoredPasswords() end
+function ClearAllStoredPasswords    () gStoredPasswords =3D {} SaveStoredP=
asswords() end



From no-reply at zwischenwelt.org  Sat Mar 14 02:25:58 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 14 Mar 2009 01:25:58 -0000
Subject: [Iris-commit] [IRIS] r2958 - /tools/archiv/lib.mainmenu.old.lua
Message-ID: <20090314020008.AD53A1524032@zwischenwelt.org>

Author: sience
Date: Sat Mar 14 02:25:58 2009
New Revision: 2958

Log:
old menu added

Added:
    tools/archiv/lib.mainmenu.old.lua



From no-reply at zwischenwelt.org  Sat Mar 14 04:35:41 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 14 Mar 2009 03:35:41 -0000
Subject: [Iris-commit] [IRIS] r2959 - in /trunk/lua: lib.2d.effect.lua
 lib.3d.cam.lua lib.3d.dynamic.lua lib.3d.map.lua lib.3d.mousepick.lua
 lib.bodygfx.lua lib.mainmenu.background.lua lib.mainmenu.lua
 lib.shardlist.lua
Message-ID: <20090314033541.A9F1A1524032@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Mar 14 04:35:40 2009
New Revision: 2959

Log:
restored some comments that were deleted by r2955

Modified:
    trunk/lua/lib.2d.effect.lua
    trunk/lua/lib.3d.cam.lua
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.bodygfx.lua
    trunk/lua/lib.mainmenu.background.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.shardlist.lua

Modified: trunk/lua/lib.2d.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.effect.lua (original)
+++ trunk/lua/lib.2d.effect.lua Sat Mar 14 04:35:40 2009
@@ -3,6 +3,11 @@
 Renderer2D.kMovingEffectZAdd =3D 15
 =

     --[[
+	kEffectType_FromSourceToDest =3D 0
+	kEffectType_LightningStrikeAtSource =3D 1
+	kEffectType_StayAtCurrentPosition =3D 2
+	kEffectType_FollowSource =3D 3
+
     see also Renderer3D:AddLightningEffect -- effect.effect_type =3D=3D kE=
ffectType_LightningStrikeAtSource
     see also Renderer3D:AddParticleEffect
     see also Renderer3D:AddHuedMeshEffect  effect.huedeffect  effect.itemi=
d effect.hue
@@ -97,6 +102,12 @@
     local xloc2,yloc2,zloc2 =3D effectdata.target_locx,effectdata.target_l=
ocy,effectdata.target_locz
     local iTileTypeID       =3D effectdata.itemid
     local iHue              =3D effectdata.hue
+	--~ local arttype =3D GetStaticTileType(iTileTypeID)
+	--~ print("Renderer2D:UpdateEffectGfx A",iTileTypeID,arttype and SmartDum=
p(arttype))
+	--~ if (not arttype) then return end
+	--~ print("Renderer2D:UpdateEffectGfx B",xloc,yloc,zloc,effectdata.itemid=
,arttype,arttype and arttype.miAnimID)
+	--~ if (not arttype) then return end
+	--~ local iModelID		=3D arttype.miAnimID
 =

     if (iTileTypeID =3D=3D 0 and effectdata.effect_type =3D=3D kEffectType=
_LightningStrikeAtSource) then
         iTileTypeID =3D 0x3967 -- couldn't find out how lightning effect i=
s supposed to work, so we use paralyse field for now
@@ -111,6 +122,11 @@
         effect.nextstept =3D effect.startt + iFrameInterval * (iFrame + 1)
         iFrame =3D iFrame % o.miCount
         iTileTypeID =3D iTileTypeBaseID + (o.miFrames[iFrame] or 0)
+		-- o.miFrames,o.miUnknown,o.miCount,o.miFrameInterval,o.miFrameStart
+		--~ print("Renderer2D:UpdateEffectGfx info",o.miUnknown,o.miCount,o.miFr=
ameInterval,o.miFrameStart)
+		--~ flamestrike =3D Renderer2D:UpdateEffectGfx info 0       30      1   =
    0
+
+		--~ for k,v in pairs(o.miFrames) do print(">",k,v) end
     end
 =

     local spriteblock =3D effect.gfx2d
@@ -121,6 +137,7 @@
         spriteblock:Clear()
     end
 =

+	--~ if ((not arttype) or arttype.miAnimID =3D=3D 0) then
     local tx,ty,tz,fIndexRel =3D 0,0,0,0
     local sorttx =3D xloc-floor(xloc/8)*8
     local sortty =3D yloc-floor(yloc/8)*8
@@ -139,6 +156,11 @@
     end
     =

     spriteblock:SetPosition(x,y,z)
+	--~ end
+	=

+	=

+	=

+	=

 =

     --[[
     local tx,ty,tz,iIndex,fIndexRel =3D 0,0,0,0
@@ -167,6 +189,7 @@
 =

 -- kPacket_Hued_FX 0xC0
 function Renderer2D:AddEffect (effectdata) =

+	--~ print("Renderer2D:AddEffect",SmartDump(effectdata))
     local t =3D Client_GetTicks()
     if (effectdata.effect_type =3D=3D kEffectType_FromSourceToDest and eff=
ectdata.duration =3D=3D 0) then
         effectdata.duration =3D 10

Modified: trunk/lua/lib.3d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.cam.lua (original)
+++ trunk/lua/lib.3d.cam.lua Sat Mar 14 04:35:40 2009
@@ -355,3 +355,12 @@
     =

     return ax, -iCamOverLocX, iCamOverLocY
 end
+
+--[[
+	GetMainCam():SetPos(x,y,z)
+	GetMainCam():SetRot(w,x,y,z)
+		q(angle,axis)	Quaternion.fromAngleAxis(ang,x,y,z)    =

+		q*v				Quaternion.ApplyToVector (x,y,z,qw,qx,qy,qz)
+		q*q				Quaternion.Mul (aw,ax,ay,az,bw,bx,by,bz) =

+]]--
+

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Sat Mar 14 04:35:40 2009
@@ -201,6 +201,28 @@
     if self.map3d_spawners and self.map3d_spawners.water then =

         self.map3d_spawners.water:AddDynamic(dynamic)
     end
+
+	--~ -- block position
+	--~ local bx =3D math.floor(dynamic.xloc / Renderer3D.gFastBatchDynamicsB=
lockSize)
+	--~ local by =3D math.floor(dynamic.yloc / Renderer3D.gFastBatchDynamicsB=
lockSize)
+	--~ =

+	--~ -- block empty? create a new entry
+	--~ if not Array2DGet(Renderer3D.gFastBatchDynamicsMap, bx,by) then
+		--~ Array2DSet(Renderer3D.gFastBatchDynamicsMap, bx,by, {mbUpdateNeeded=
=3Dtrue, miCount=3D0,mlDynamic=3D{}})
+	--~ end
+	--~ =

+	--~ local e =3D Array2DGet(Renderer3D.gFastBatchDynamicsMap, bx,by)
+	--~ -- add dynamic if not available
+	--~ if not e.mlDynamic[dynamic.serial] then
+		--~ -- print("ADD",bx,by,dynamic.serial)
+		--~ e.miCount =3D e.miCount + 1
+		--~ e.mlDynamic[dynamic.serial] =3D dynamic
+	--~ end
+--~ =

+	--~ e.mbUpdateNeeded =3D true
+	--~ Renderer3D.gFastBatchDynamicsUpdateNeeded =3D true
+	--~ =

+	--~ -- Renderer3D:ShowDynamicMapStats()
 end
 =

 function Renderer3D:RemoveDynamicFromMap    (dynamic)
@@ -210,6 +232,23 @@
     if self.map3d_spawners and self.map3d_spawners.water then =

         self.map3d_spawners.water:RemoveDynamic(dynamic)
     end
+
+	--~ Array2DForAll(Renderer3D.gFastBatchDynamicsMap, function(e,bx,by)
+		--~ -- remove dynamic if available
+		--~ if e.mlDynamic[dynamic.serial] then
+			--~ -- print("REMOVE",bx,by,dynamic.serial)
+			--~ e.mbUpdateNeeded =3D true
+			--~ e.miCount =3D e.miCount - 1
+			--~ e.mlDynamic[dynamic.serial] =3D nil
+			--~ Renderer3D.gFastBatchDynamicsUpdateNeeded =3D true
+		--~ end
+		--~ =

+		--~ -- remove block entry
+		--~ if e.miCount =3D=3D 0 then
+			--~ if e.mFastBatch then e.mFastBatch:Destroy() end
+			--~ Array2DSet(Renderer3D.gFastBatchDynamicsMap, bx,by, nil)
+		--~ end
+	--~ end)
 end
 =

 -- rebuilds the graphic of the dynamics
@@ -240,6 +279,15 @@
     if self.map3d_spawners and self.map3d_spawners.multis then =

         self.map3d_spawners.multis:RemoveMulti(multi)
     end
+
+	--[[
+	if multi.mbBuildRunning then
+		multi.mbCancelBuildAndDestroy =3D true
+	elseif multi.staticGeometry then =

+		multi.staticGeometry:Destroy() =

+		multi.staticGeometry =3D nil
+	end
+	]]--
 end
 =

 -- multi / house =

@@ -326,7 +374,8 @@
             item.gfx =3D CreateRootGfx3D()
             item.gfx:SetMesh(item.meshname)
             item.gfx:SetOrientation(GetStaticMeshOrientation(item.artid))
---            item.gfx:SetNormaliseNormals(true)
+			--~ mirroring now baked into meshes for shader compatibility -- item.gf=
x:SetScale(-1,1,1)		-- (-1) thats because xmirror bug and wrong mirrored me=
shes
+			item.gfx:SetNormaliseNormals(true)
             item.gfx:SetCastShadows(gDynamicsCastShadows)
             -- primary color hueing
             if gHueLoader and item.hue > 0 then
@@ -585,4 +634,10 @@
     end
 =

     -- RemoveDynamicFromMap(dynamic) is handled by on destroy listener ( R=
egisterListener("Dynamic_Destroy" )
-end
+
+	--[[ handled by on destroy listener
+	if gFastBatchDynamics then =

+		Renderer3D:RemoveDynamicFromMap	(dynamic)
+	end
+	]]--
+end

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Sat Mar 14 04:35:40 2009
@@ -184,6 +184,11 @@
             end
         end
         =

+		-- update dynamics =

+		--~ for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dyn=
amic)) then self:UpdateDynamicVisibility(dynamic) end end
+		=

+		--~ self:UpdateDynamicDisplayRange()
+		=

         -- update mobiles
         for k,mobile in pairs(GetMobileList()) do self:UpdateMobileVisibil=
ity(mobile) end
     end
@@ -204,3 +209,12 @@
 end
 =

 function Renderer3D:ClearMapCache () end
+
+
+--[[
+function Renderer3D:UpdateStaticVisibility	(entity) =

+	if (entity and entity.gfx and entity.gfx.billboard) then
+		entity.gfx.billboard:SetVisible(self:IsZLayerVisible(entity.zloc))
+	end
+end
+]]--

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Sat Mar 14 04:35:40 2009
@@ -204,6 +204,69 @@
         gCustomQuadInfoWritten =3D true
         print("mousepick info numgfx=3D",numgfx,"numcustomquads=3D",numcus=
tomquads," (each has its own scenenode)")
     end
+	--[[
+	for chunky,row in pairs(self.gMapChunks) do
+		for chunkx,chunk in pairs(row) do
+			if (not chunk.bIsDead) then
+				-- terrain
+				if (gGroundBlockLoader and self.gbBlendOutTerrainVisible) then
+					local iBlockUO_X =3D chunk.miX * self.ROBMAP_CHUNK_SIZE
+					local iBlockUO_Y =3D chunk.miY * self.ROBMAP_CHUNK_SIZE
+													=

+					if (chunk.pStaticGeometryTerrain) then -- old terrain : static-geom
+						local x,y =3D self:UOPosToLocal(iBlockUO_X*8,iBlockUO_Y*8)
+						bHit,fHitDist =3D chunk.pTerrainEntity:RayPick(rx,ry,rz,rvx,rvy,rvz,=
x,y,0)
+					elseif (chunk.terrain_multitex_gfx) then -- new terrain multitex
+						local gfx =3D chunk.terrain_multitex_gfx
+						local d =3D kMultiTexTerrainChunkSize
+						local bx,by =3D gfx.bx,gfx.by
+						local tx,ty
+
+						bHit,fHitDist,tx,ty =3D TerrainMultiTex_RayPick(gGroundBlockLoader,g=
fx.bx,gfx.by,d,d,0.1, rx-gfx.x,ry-gfx.y,rz-gfx.z, rvx,rvy,rvz)
+						if (bHit) then
+							if (tx >=3D 8) then bx =3D bx + 1   tx =3D tx - 8 end
+							if (ty >=3D 8) then by =3D by + 1   ty =3D ty - 8 end
+						end
+					else
+						if (chunk.terraingfx) then -- old terrain : meshentities
+							bHit,fHitDist =3D chunk.terraingfx:RayPick(rx,ry,rz,rvx,rvy,rvz)
+						else
+							bHit =3D false
+						end
+					end
+					=

+					if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePickF=
oundDist)) then
+						self.gMousePickFoundDist =3D fHitDist
+						gMousePickFoundHit =3D {}
+						gMousePickFoundHit.hittype =3D kMousePickHitType_Terrain
+						gMousePickFoundHit.chunk =3D chunk
+						=

+						local x,y =3D Renderer3D:LocalToUOPos(rx + fHitDist * rvx, ry + fHit=
Dist * rvy)
+						x,y =3D math.floor(x),math.floor(y)
+						local iTileType,iZLoc =3D GetAbsTile(x,y) =

+						local bx =3D math.floor((x - iBlockUO_X)/8)
+						local by =3D math.floor((y - iBlockUO_Y)/8)
+						local origin_abs_x =3D self.giMapOriginX * self.ROBMAP_CHUNK_SIZE
+						local origin_abs_y =3D self.giMapOriginY * self.ROBMAP_CHUNK_SIZE
+						local originoffx =3D 8.0*(iBlockUO_X-origin_abs_x)
+						local originoffy =3D 8.0*(iBlockUO_Y-origin_abs_y)
+						=

+						gMousePickFoundHit.tiletype =3D iTileType
+						gMousePickFoundHit.minz =3D iZLoc*0.1 =

+						gMousePickFoundHit.maxz =3D iZLoc*0.1
+						gMousePickFoundHit.x =3D x
+						gMousePickFoundHit.y =3D y
+						gMousePickFoundHit.tx =3D math.mod(x,8)
+						gMousePickFoundHit.ty =3D math.mod(y,8)
+						gMousePickFoundHit.iBlockX =3D iBlockUO_X+bx
+						gMousePickFoundHit.iBlockY =3D iBlockUO_Y+by
+						gMousePickFoundHit.blockorigin_x =3D originoffx+bx*8
+						gMousePickFoundHit.blockorigin_y =3D originoffy+by*8
+					end
+				end
+			end
+	end end
+	]]--
     =

     -- dynamics
     for k,dynamic in pairs(GetDynamicList()) do

Modified: trunk/lua/lib.bodygfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bodygfx.lua (original)
+++ trunk/lua/lib.bodygfx.lua Sat Mar 14 04:35:40 2009
@@ -273,7 +273,7 @@
 		local myscalez =3D forcescalez or modelinfo.scalez * gGrannyScaleFactor
 		if (myscalex ~=3D 1 or myscaley ~=3D 1 or myscalez ~=3D 1) then
 			partgfx:SetScale(myscalex,myscaley,myscalez)
---			partgfx:SetNormaliseNormals(true)
+			partgfx:SetNormaliseNormals(true)
 		end
 	end
 	return partgfx

Modified: trunk/lua/lib.mainmenu.background.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.background.lua (original)
+++ trunk/lua/lib.mainmenu.background.lua Sat Mar 14 04:35:40 2009
@@ -21,3 +21,21 @@
     DestroyIfAlive(gMenuBgImage)
     gMenuBgImage =3D nil
 end
+
+--[[
+-- old, wasn't used anymore
+local function SetMainMenuCam (roth,rotv)
+	local cam =3D GetMainCam()
+	cam:SetFOVy(gfDeg2Rad*45)
+	cam:SetNearClipDistance(0.5) -- old : 1
+	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
+	cam:SetProjectionType(kCamera_PT_PERSPECTIVE) -- perspective
+	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
+	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

+	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
+	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
+	=

+	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
+	GetMainCam():SetRot(w,x,y,z)	=

+end
+]]--

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sat Mar 14 04:35:40 2009
@@ -65,7 +65,7 @@
                             gAutoLoginCharName =3D charlist[i]
                             gLoginname =3D charlist.gLoginname
                             gPassword =3D MainMenu_GetStoredPassword(shard=
.gLoginServerIP,shard.gLoginServerPort,gLoginname)
---                          print("found",gAutoLoginCharName,gLoginname)
+                          	print("found",gAutoLoginCharName,gLoginname)
                         end
                     end
                 end

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Sat Mar 14 04:35:40 2009
@@ -134,3 +134,16 @@
 function SetStoredPassword          (host,port,username,password) gStoredP=
asswords[host..":"..port..":"..username] =3D password SaveStoredPasswords()=
 end
 function ClearStoredPassword        (host,port,username) gStoredPasswords[=
host..":"..port..":"..username] =3D nil SaveStoredPasswords() end
 function ClearAllStoredPasswords    () gStoredPasswords =3D {} SaveStoredP=
asswords() end
+
+function TestStoredPasswords ()
+	local host,port =3D "example.org",2593
+	local user1 =3D "weirdguy"
+	local user2 =3D "somedude"
+	LoadStoredPasswords()
+	--~ SetStoredPassword(host,port,user1,"secret1234")
+	--~ SetStoredPassword(host,port,user2,"secret5555")
+	print(user1,GetStoredPassword(host,port,user1)) --~ weirdguy        secre=
t1234
+	print(user2,GetStoredPassword(host,port,user2)) --~ somedude        secre=
t5555
+	os.exit(0)
+end
+



From no-reply at zwischenwelt.org  Sun Mar 15 19:15:23 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 15 Mar 2009 18:15:23 -0000
Subject: [Iris-commit] [IRIS] r2961 - /tools/installer/Iris_Setup.iss
Message-ID: <20090315181523.38C261C18877@zwischenwelt.org>

Author: sience
Date: Sun Mar 15 19:15:22 2009
New Revision: 2961

Log:
-installer script updated

Modified:
    tools/installer/Iris_Setup.iss

Modified: tools/installer/Iris_Setup.iss
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- tools/installer/Iris_Setup.iss (original)
+++ tools/installer/Iris_Setup.iss Sun Mar 15 19:15:22 2009
@@ -22,7 +22,7 @@
 DefaultDirName=3D{pf}\{#AppName2}
 DefaultGroupName=3D{#AppName2}
 LicenseFile=3D{#DataDir}\COPYING
-InfoBeforeFile=3D{#DataDir}\README
+InfoBeforeFile=3D{#DataDir}\README.txt
 OutputDir=3DOutput
 OutputBaseFilename=3D{#AppName}_Setup
 Compression=3Dlzma/normal



From no-reply at zwischenwelt.org  Mon Mar 16 03:13:23 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 16 Mar 2009 02:13:23 -0000
Subject: [Iris-commit] [IRIS] r2962 - in /trunk/lua: gui/gui.trade.lua
 lib.book.lua lib.corpse.lua lib.debugmenu.lua
Message-ID: <20090316021323.88D221C18879@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Mar 16 03:13:22 2009
New Revision: 2962

Log:
small shop change for use in macroing, small restore

Modified:
    trunk/lua/gui/gui.trade.lua
    trunk/lua/lib.book.lua
    trunk/lua/lib.corpse.lua
    trunk/lua/lib.debugmenu.lua

Modified: trunk/lua/gui/gui.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.trade.lua (original)
+++ trunk/lua/gui/gui.trade.lua Mon Mar 16 03:13:22 2009
@@ -191,6 +191,7 @@
 	end end
 =

 	-- update total price
+	shop.totalprice =3D totalprice
 	dialog.total.gfx:SetText(totalprice)
 end
 =

@@ -214,6 +215,7 @@
 -- used for both buy and sell  npc-shop
 function OpenShopDialog (shop) =

 	-- create shop dialog
+	gLastShop =3D shop
 	local dialog_list	=3D guimaker.MakeSortedDialog()
 	local dialog_bill	=3D guimaker.MakeSortedDialog()
 	dialog_list.uoShop	=3D shop

Modified: trunk/lua/lib.book.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.book.lua (original)
+++ trunk/lua/lib.book.lua Mon Mar 16 03:13:22 2009
@@ -3,6 +3,11 @@
         uo books (network packets and dialog)
 ]]--
 =

+--~ packet  typeid=3D0xd4,size=3D32,typename=3DkPacket_Book_Info
+--~ packet  typeid=3D0x66,size=3D89,typename=3DkPacket_Book_Contents
+
+--~ PacketHandlers.Register( 0xD4,  0, true, new OnPacketReceive( HeaderCh=
ange ) );
+--~ PacketHandlers.Register( 0x66,  0, true, new OnPacketReceive( ContentC=
hange ) );
 --~ PacketHandlers.Register( 0x93, 99, true, new OnPacketReceive( OldHeade=
rChange ) );
 =

 --[[

Modified: trunk/lua/lib.corpse.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.corpse.lua (original)
+++ trunk/lua/lib.corpse.lua Mon Mar 16 03:13:22 2009
@@ -14,6 +14,9 @@
 end
 =

 -- SiENcE: kann das entfernt werden?
+-- ghouly : no, please don't remove, those are all interesting things to s=
earch for when working with corpses and death-detection
+-- for example hitpoint bars don't understand when the target dies current=
ly,  being removed does not equal death, for example when the target runs o=
ut of the screen.
+-- we do not yet have a correct death detection for mobs other than self y=
et, and these notes are relevant for implementing that.
 --[[
 kPacket_Equipped_MOB
     ./net.mobile.lua:192:   print("tag corpse")

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Mon Mar 16 03:13:22 2009
@@ -449,6 +449,7 @@
 --------------------------------------------------------------------------
     {artid=3D hex2num("5") , content=3D{}},     --birds_eagle
     {artid=3D hex2num("39") , content=3D{}},    --mongbats_mongbat
+	{artid=3D hex2num("105") , content=3D{}},	--dragons_wyrm_ancient
 =

     -- llamas_llama_pack - broken (crash) -> mapped to id: 220 (grannyfilt=
er)
     {artid=3D 292 , content=3D{}},
@@ -474,6 +475,7 @@
     {artid=3D hex2num("0xD2") , content=3D{}}, =

     {artid=3D hex2num("0xDA") , content=3D{}}, =

     {artid=3D hex2num("0xDB") , content=3D{}}, =

+	{artid=3D	hex2num("0xD5") , content=3D{}}, =

     {artid=3D hex2num("0x90") , content=3D{}}, =

     {artid=3D hex2num("0x74") , content=3D{}},  -- 116 broken
     {artid=3D hex2num("0xB2") , content=3D{}},  -- 178 broken
@@ -481,7 +483,11 @@
     {artid=3D hex2num("0xB3") , content=3D{}},  -- 179 broken
     {artid=3D hex2num("0xBB") , content=3D{}}, =

     {artid=3D hex2num("0xBC") , content=3D{}}, =

+	{artid=3D	hex2num("0x317") , content=3D{}}, -- brokenanim
+	{artid=3D	hex2num("0x31A") , content=3D{}}, -- brokenanim
+	{artid=3D	hex2num("0x31F") , content=3D{}}, -- brokenanim
     {artid=3D hex2num("0xBE") , content=3D{}},  -- 190 broken
+	{artid=3D hex2num("0x11C") , content=3D{}}, -- 284 anim broken, scale bro=
ken..
     {artid=3D hex2num("0xFB") , content=3D{}}, =

 =

     {artid=3D400,hue=3D33780, content=3D{[4]=3D{artid=3D5422,hue=3D1728,an=
imid=3D430},[26]=3D{artid=3D3701,hue=3D0,animid=3D422},[16]=3D{artid=3D8269=
,hue=3D1147,animid=3D906},[27]=3D{artid=3D3701,hue=3D0,animid=3D422},[17]=
=3D{artid=3D8059,hue=3D1652,animid=3D913},[11]=3D{artid=3D8252,hue=3D1147,a=
nimid=3D701},[12]=3D{artid=3D5435,hue=3D0,animid=3D466},[21]=3D{artid=3D370=
1,hue=3D0,animid=3D422},}},
@@ -507,6 +513,56 @@
     {artid=3D401, content=3D({{artid=3D5899,animid=3D477},{artid=3D5422,an=
imid=3D430},{artid=3D5399,animid=3D434},{artid=3D5435,animid=3D466},{artid=
=3D8251,animid=3D700},{artid=3D3701,animid=3D422},})},
     {artid=3D400, content=3D({{artid=3D5905,animid=3D476},{artid=3D5422,an=
imid=3D430},{artid=3D7933,animid=3D435},{artid=3D5909,animid=3D406},{artid=
=3D5441,animid=3D490},{artid=3D3701,animid=3D422},{artid=3D8251,animid=3D70=
0},})},
     {artid=3D400, content=3D({{artid=3D5899,animid=3D477},{artid=3D5422,an=
imid=3D430},{artid=3D7933,animid=3D435},{artid=3D8266,animid=3D903},{artid=
=3D3701,animid=3D422},})},
+	=

+	-- meshes only crash when using vertex-shader
+	{artid=3D040, content=3D{}},
+	{artid=3D	hex2num("0x76") , content=3D{}},
+	{artid=3D	hex2num("0x77") , content=3D{}}, =

+	{artid=3D	hex2num("0x78") , content=3D{}},
+	{artid=3D	hex2num("0x79") , content=3D{}}, =

+	{artid=3D	hex2num("0x3C") , content=3D{}}, =

+	{artid=3D	hex2num("0xC8") , content=3D{}}, =

+	{artid=3D hex2num("0x123") , content=3D{}},
+	{artid=3D199, content=3D{}},
+	{artid=3D225, content=3D{}}, -- timberwolf
+	{artid=3D256, content=3D{}},
+	{artid=3D	hex2num("0x319") , content=3D{}},
+	{artid=3D400,hue=3D33780, content=3D{
+		{artid=3Dhex2num("0x3EA2"),layer=3DkLayer_Mount},
+		[4]=3D{artid=3D5422,hue=3D1728,animid=3D430},[26]=3D{artid=3D3701,hue=3D=
0,animid=3D422},
+		[16]=3D{artid=3D8269,hue=3D1147,animid=3D906},[27]=3D{artid=3D3701,hue=
=3D0,animid=3D422},
+		[17]=3D{artid=3D8059,hue=3D1652,animid=3D913},[11]=3D{artid=3D8252,hue=
=3D1147,animid=3D701},
+		[21]=3D{artid=3D3701,hue=3D0,animid=3D422},}},   =

+	{artid=3D401, content=3D({{artid=3Dhex2num("0x3EA2"),layer=3DkLayer_Mount=
},{artid=3D5899,animid=3D477},{artid=3D5422,animid=3D430},{artid=3D5399,ani=
mid=3D434},{artid=3D5435,animid=3D466},{artid=3D8251,animid=3D700},{artid=
=3D3701,animid=3D422},})},
+	{artid=3D400, content=3D({{artid=3Dhex2num("0x3EA2"),layer=3DkLayer_Mount=
},{artid=3D5899,animid=3D477},{artid=3D5422,animid=3D430},{artid=3D5399,ani=
mid=3D434},{artid=3D5435,animid=3D466},{artid=3D8251,animid=3D700},{artid=
=3D3701,animid=3D422},})},
+
+	{artid=3D2011, content=3D{{animid=3D2002}}}, -- 02:feet 11:ulegs
+	{artid=3D1466, content=3D{}}, -- flimmer, need culling? (fixed)
+	{artid=3D1700, content=3D{}}, -- hair, texcoords or normals broken ? (fix=
ed)
+	{artid=3D500, content=3D{}}, -- lantern, texcoords broken ?! (fixed)
+	{artid=3D468, content=3D{}}, -- cape, texcoords broken ? culling? (fixed)
+	{artid=3D1468, content=3D{}}, -- cape, texcoords broken ? culling? (fixed)
+	{artid=3D490, content=3D{}}, -- sash, texcoords broken ? culling? (fixed)
+	{artid=3D1490, content=3D{}},  -- sash, texcoords broken ? culling? (fixe=
d)
+
+	{artid=3D1924, content=3D{{animid=3D3012}}},
+	{artid=3D3604, content=3D{{animid=3D3012}}},
+	{artid=3D1925, content=3D{{animid=3D3012}}},
+	{artid=3D3605, content=3D{{animid=3D3012}}},
+
+	{artid=3D3006, content=3D{}}, -- female lower legs, sience was having pro=
blem with them, 2 submeshes !
+	{artid=3D2013, content=3D{}},
+	{artid=3D2009, content=3D{}},
+	{artid=3D2012, content=3D{}},
+	{artid=3D3013, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
+	{artid=3D3009, content=3D{}},
+	{artid=3D3012, content=3D{}},
 ]]--
 }
 =

@@ -826,7 +882,7 @@
         end end end)
     Bind("f5", function (state) if (not gActiveEditText) then if (state > =
0) then =

         DebugMenuChangeParam1( 4096)
-        MyStartParticleDebugMode(1)
+		MyReloadParticleDebugMode()
         end end end)
     Bind("f6", function (state) if (not gActiveEditText) then if (state > =
0) then =

         if (gCurDebugMode =3D=3D kDebugMode_Static) then ShowDebugMenuArtL=
ist(0,kDebugMode_Static) end
@@ -1239,6 +1295,7 @@
 function MyParticleDebugMode_Next() MyParticleDebugMode_SetIndex(gMyDebugP=
articles_CurIndex + 1) end -- f3
 =

 function MyReloadParticleDebugMode ()  -- bound to f5
+	if (not gParticleDebugModeStarted) then MyStartParticleDebugMode() end
     if (gMyParticleDebugGfx) then gMyParticleDebugGfx:Destroy() gMyParticl=
eDebugGfx =3D nil end
     if (not gMyDebugParticles_CurName) then return end
     ReloadParticleTemplate(gMyDebugParticles_CurName,gMyDebugParticles_Cur=
Path)



From no-reply at zwischenwelt.org  Mon Mar 16 15:53:07 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 16 Mar 2009 14:53:07 -0000
Subject: [Iris-commit] [IRIS] r2963 - in /trunk/lua:
 lib.mainmenu.accountlist.lua lib.shardlist.lua lib.uoids.lua
Message-ID: <20090316145307.B3E8F1C18877@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Mar 16 15:53:03 2009
New Revision: 2963

Log:
mainmenu:accountlist : shows time since last login and top7 char skills

Modified:
    trunk/lua/lib.mainmenu.accountlist.lua
    trunk/lua/lib.shardlist.lua
    trunk/lua/lib.uoids.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Mon Mar 16 15:53:03 2009
@@ -55,10 +55,30 @@
                 =

                 local myrow =3D bHadFirstChar and {{""},{""},{""}} or base=
row
                 bHadFirstChar =3D true
+				=

+				local chardata =3D SimpleXMLLoad(GetCharFilePath(user,char.id))
+				local charinfo =3D ""
+				if (chardata) then
+					local timediff =3D os.time() - (chardata.time or 0)
+					charinfo =3D charinfo .. floor(timediff/3600/24).."d."
+					=

+					-- glSkillNamesShort
+					=

+					local valname =3D {[1200]=3D"leg",[1100]=3D"elder",[1000]=3D"gm"}
+					local arr =3D {}
+					for k,skill in pairs(chardata.skills) do skill.id =3D k end
+					local skills2 =3D SortedArrayFromAssocTable(chardata.skills,function =
(a,b) return a.value > b.value end)
+					for k,skill in ipairs(skills2) do =

+						table.insert(arr,glSkillNamesShort[skill.id]..":"..(valname[skill.va=
lue] or (skill.value/10)))
+						if (k >=3D 7) then break end
+					end
+					charinfo =3D charinfo .. table.concat(arr,",")
+				end
                 =

                 table.insert(myrow,{char.name,fun_char})
                 table.insert(myrow,{"3D",function () gCurrentRenderer =3D =
Renderer3D fun_char() end})
                 table.insert(myrow,{"2D",function () gCurrentRenderer =3D =
Renderer2D fun_char() end})
+                table.insert(myrow,{charinfo})
                 table.insert(rows,myrow)
             end
         end

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Mon Mar 16 15:53:03 2009
@@ -4,7 +4,7 @@
 function GetConfigDirPath               () return gMainWorkingDir.."config=
/" end
 function GetShardListDirPath            () return GetConfigDirPath().."sha=
rds/" end
 function GetShardMemoryFilePath         () return GetConfigDirPath().."sha=
rdmemory.xml" end
-function GetCharFilePath                () return GetConfigDirPath().."cha=
rs/"..table.concat({gLoginServerIP,gLoginServerPort,ShardListFileNamePartEn=
code(gLoginname),giGameServerID,gCharID},".")..".xml" end
+function GetCharFilePath                (loginname,charid) return GetConfi=
gDirPath().."chars/"..table.concat({gLoginServerIP,gLoginServerPort,ShardLi=
stFileNamePartEncode(loginname or gLoginname),(giGameServerID or 0),(charid=
 or gCharID or 0)},".")..".xml" end
 function GetShardConfigFilePath         (shardname) return GetShardListDir=
Path()..ShardListFileNamePartEncode(shardname)..".xml" end
 =

 function ShardListFileNamePartEncode    (x) return string.gsub(x,"[^0-9a-z=
A-Z_%-%(%) ]",".") end

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Mon Mar 16 15:53:03 2009
@@ -410,6 +410,68 @@
 	[52]	=3D "Chivalry",
 	[53]	=3D "Bushido",
 	[54]	=3D "Ninjitsu",
+	[55]	=3D "Spellweaving"	-- ? correct?
+}
+
+
+-- for mainmenu.accountlist infos
+glSkillNamesShort =3D {	=

+	[1] 	=3D "Alch",
+	[2]		=3D "Ana",
+	[3]		=3D "AniLore",
+	[4]		=3D "ItemId", -- (Appraise)
+	[5]		=3D "ArmsLore",
+	[6]		=3D "Parry", -- (Battle Defense)
+	[7]		=3D "Beg",
+	[8]		=3D "BSmith",
+	[9]		=3D "Fletch",
+	[10]	=3D "Peace", -- (Calming)
+	[11]	=3D "Camp",
+	[12]	=3D "Carp",
+	[13]	=3D "Carto",
+	[14]	=3D "Cook",
+	[15]	=3D "Detect",
+	[16]	=3D "Disco",
+	[17]	=3D "EvalInt",
+	[18]	=3D "Heal",
+	[19]	=3D "Fish",
+	[20]	=3D "Forensic",
+	[21]	=3D "Herd",
+	[22]	=3D "Hide",
+	[23]	=3D "Provo",
+	[24]	=3D "Inscri",
+	[25]	=3D "Lockpick",
+	[26]	=3D "Mage",
+	[27]	=3D "SpellRes", -- Magic Resistance
+	[28]	=3D "Tac",
+	[29]	=3D "Snoop",
+	[30]	=3D "Musi",
+	[31]	=3D "Pois",
+	[32]	=3D "Arch",
+	[33]	=3D "Spirit",
+	[34]	=3D "Steal",
+	[35]	=3D "Tailor",
+	[36]	=3D "Taming",
+	[37]	=3D "TasteId",
+	[38]	=3D "Tinker",
+	[39]	=3D "Track",
+	[40]	=3D "Vet",
+	[41]	=3D "Sword",
+	[42]	=3D "Mace",
+	[43]	=3D "Fence",
+	[44]	=3D "Wrestl",
+	[45]	=3D "Lumber",
+	[46]	=3D "Mining",
+	[47]	=3D "Medi",
+	[48]	=3D "Stealth",
+	[49]	=3D "Disarm",
+	[50]	=3D "Necro",
+
+	--new since UO:SE & UO:ML
+	[51]	=3D "Focus",
+	[52]	=3D "Chiv",
+	[53]	=3D "Bush",
+	[54]	=3D "Ninj",
 	[55]	=3D "Spellweaving"	-- ? correct?
 }
 =




From no-reply at zwischenwelt.org  Tue Mar 17 02:15:52 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 17 Mar 2009 01:15:52 -0000
Subject: [Iris-commit] [IRIS] r2964 - /trunk/lua/lib.mainmenu.accountlist.lua
Message-ID: <20090317020006.D10451C18885@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 17 02:15:50 2009
New Revision: 2964

Log:
accountlist fix if first char in list was deleted

Modified:
    trunk/lua/lib.mainmenu.accountlist.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Tue Mar 17 02:15:50 2009
@@ -31,7 +31,7 @@
     for charlist_idx,charlist in pairs(charlists) do
         -- list chars in slotorder
         local mychars =3D {}
-        for i=3D0,20 do if (charlist[i]) then table.insert(mychars,{id=3Di=
,name=3Dcharlist[i]}) else break end end
+        for i=3D0,20 do if (charlist[i]) then table.insert(mychars,{id=3Di=
,name=3Dcharlist[i]}) end end
         --~ table.sort(mychars,function (a,b) return a.name < b.name end) =
-- sort by name
         table.sort(mychars,function (a,b) return a.id < b.id end) -- sort =
by charslot, same as in original client charlist
         =

@@ -83,7 +83,7 @@
             end
         end
         -- if it was a fresh account with no chars yet, or charlist is unk=
nown, list the login anyway
-        if (not bHadFirstChar) then table.insert(rows,baserow) end
+        --~ if (not bHadFirstChar) then table.insert(rows,baserow) end
     end
     if (lastpassedit) then lastpassedit.nextcontrolname =3D "i_user" end
     =




From no-reply at zwischenwelt.org  Fri Mar 20 00:47:32 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 19 Mar 2009 23:47:32 -0000
Subject: [Iris-commit] [IRIS] r2965 - /trunk/lua/lib.mainmenu.lua
Message-ID: <20090319234732.85B6E1C18877@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Mar 20 00:47:32 2009
New Revision: 2965

Log:
small bugfix for commandline login option

Modified:
    trunk/lua/lib.mainmenu.lua

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Fri Mar 20 00:47:32 2009
@@ -59,9 +59,7 @@
                                                                     charli=
st.gLoginServerPort   =3D=3D shard.gLoginServerPort end)
                 for k,charlist in pairs(charlists) do =

                     for i=3D0,20 do =

-                        --~ print("..",charlist[i])
-                        if (not charlist[i]) then break end
-                        if (string.lower(charlist[i]) =3D=3D string.lower(=
gAutoLoginCharName)) then
+                        if (charlist[i] and string.lower(charlist[i]) =3D=
=3D string.lower(gAutoLoginCharName)) then
                             gAutoLoginCharName =3D charlist[i]
                             gLoginname =3D charlist.gLoginname
                             gPassword =3D MainMenu_GetStoredPassword(shard=
.gLoginServerIP,shard.gLoginServerPort,gLoginname)



From no-reply at zwischenwelt.org  Sun Mar 22 16:59:41 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 22 Mar 2009 15:59:41 -0000
Subject: [Iris-commit] [IRIS] r2966 - in /trunk/data/models:
 materials/textures.material models/textures_skipped_in_atlas.txt
 textures/tex_cedars_firneedle.png
Message-ID: <20090322155941.E491B1C1888A@zwischenwelt.org>

Author: sience
Date: Sun Mar 22 16:59:41 2009
New Revision: 2966

Log:
-obsolete tex_cedars_firneedle.png removed (we have already a new cedar tre=
e with texture)

Removed:
    trunk/data/models/textures/tex_cedars_firneedle.png
Modified:
    trunk/data/models/materials/textures.material
    trunk/data/models/models/textures_skipped_in_atlas.txt

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Sun Mar 22 16:59:41 2009
@@ -5924,23 +5924,6 @@
 	}
 }
 =

-material cedars : tex_base_alpha
-{
-	technique
-	{
-		pass
-		{
-			alpha_rejection greater_equal 55
-			alpha_to_coverage on
-
-			texture_unit
-			{
-				texture tex_cedars_firneedle.png
-			}
-		}
-	}
-}
-
 material palm01_bark : tex_base
 {
 	technique

Modified: trunk/data/models/models/textures_skipped_in_atlas.txt
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/models/textures_skipped_in_atlas.txt (original)
+++ trunk/data/models/models/textures_skipped_in_atlas.txt Sun Mar 22 16:59=
:41 2009
@@ -1,6 +1,5 @@
 tex_grass
 tex_fernleaf
-tex_cedars_firneedle
 tex_403
 tex_409
 tex_549



From no-reply at zwischenwelt.org  Mon Mar 23 03:34:42 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 23 Mar 2009 02:34:42 -0000
Subject: [Iris-commit] [IRIS] r2967 - in /trunk/lua: config_declarations.lua
 lib.3d.map.lua lib.3d.renderer.lua
Message-ID: <20090323023443.2B7F41C18879@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Mar 23 03:34:42 2009
New Revision: 2967

Log:
support for mapareas with different skybox/fog options, e.g. dungeonarea in=
 fellu/trammel

Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.renderer.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Mon Mar 23 03:34:42 2009
@@ -366,6 +366,16 @@
 gMusicConfigFile=3D "Config.txt"
 gMusicPath		=3D "Music/Digital/"
 =

+local myTrammelFelluMapAreas =3D {
+		{	minx=3D5120,maxx=3D7168, -- dungeons, black skybox, dark fog
+			miny=3D0,maxy=3D2300,
+			fog_r =3D 0,
+			fog_g =3D 0,
+			fog_b =3D 0,
+			skybox =3D nil,
+		},
+	}
+
 gDefaultMaps =3D {}
 gDefaultMaps[0] =3D {
 	name =3D "Felucca",
@@ -377,7 +387,8 @@
 	fog_b =3D 166,
 	mapfilename		=3D "map0.mul",
 	staidxfilename	=3D "staidx0.mul",
-	staticfilename	=3D "statics0.mul"
+	staticfilename	=3D "statics0.mul",
+	mapareas =3D myTrammelFelluMapAreas,
 =

 	-- only relevant for pre 6.0.0 server
 --	,sta_diff_lookup=3D "stadifl0.mul",
@@ -396,7 +407,8 @@
 	fog_b =3D 166,
 	mapfilename		=3D "map1.mul",
 	staidxfilename	=3D "staidx1.mul",
-	staticfilename	=3D "statics1.mul"
+	staticfilename	=3D "statics1.mul",
+	mapareas =3D myTrammelFelluMapAreas,
 =

 	-- only relevant for pre 6.0.0 server
 --	,sta_diff_lookup=3D "stadifl1.mul",

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Mon Mar 23 03:34:42 2009
@@ -120,11 +120,39 @@
     return -x,y,z
 end
 =

+-- check if player entered or left a special map area, e.g. a dungeon. can=
 be used to change things like skybox/lighting
+function Renderer3D:MapAreaCheck (x,y)
+	local bx =3D floor(x/8)
+	local by =3D floor(y/8)
+	if (gLastMapAreaBlockX =3D=3D bx and
+		gLastMapAreaBlockY =3D=3D by) then return end
+	gLastMapAreaBlockX =3D bx
+	gLastMapAreaBlockY =3D by
+	local areas =3D gMaps[gMapIndex].mapareas
+	if (not areas) then return end
+	local activearea
+	for k,area in pairs(areas) do =

+		if (x >=3D area.minx and =

+			y >=3D area.miny and
+			x <=3D area.maxx and =

+			y <=3D area.maxy) then =

+			activearea =3D area
+		end
+	end
+	print("Renderer3D:MapAreaCheck",x,y,activearea)
+	if (gLastMapArea =3D=3D activearea) then return end
+	gLastMapArea =3D activearea
+	self:SetMapAreaEnv(activearea or gMaps[gMapIndex])
+end
+
 -- TODO: blend out mounts
 function Renderer3D:BlendOutLayersAbovePlayer ()
     local x,y,z =3D GetPlayerPos()
-    =

     if (not z) then return end
+	=

+	-- BlendOutLayersAbovePlayer always called when pos is updated, so we'll =
just add the area check here for now
+	self:MapAreaCheck(x,y)
+    =

     =

     --[[
     osi =3D wenn dach min 18z h=C3=AF=C2=BF=C2=BDher als char, dann alles =
von zdach aufw=C3=AF=C2=BF=C2=BDrts ausblenden

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Mon Mar 23 03:34:42 2009
@@ -199,6 +199,18 @@
         gCaelumSystem:Shutdown(true)
         gCaelumSystem =3D nil
     end
+end
+
+function Renderer3D:SetMapAreaEnv (env)
+	if (gUseCaelumSkysystem) then return end
+	Client_SetSkybox(env.skybox) =

+	if (gUseDistanceFog) then =

+		local fogColorRed           =3D env.fog_r =

+		local fogColorGreen         =3D env.fog_g =

+		local fogColorBlue          =3D env.fog_b
+		local radius =3D cMapBlock_3D_Terrain.iLoadRadius
+		Client_SetFog(3, fogColorRed/255, fogColorGreen/255, fogColorBlue/255, 1=
.0, 0, 3*radius, 3*radius+gFogValue) =

+	end
 end
 =

 function Renderer3D:SetMapEnvironment (bUnderGround)
@@ -284,15 +296,7 @@
         rotate(gCaelumSystem:GetCaelumCameraNode(), w,x,y,z)
     else
         -- black background when underground =

-        Client_SetSkybox(gMaps[gMapIndex].skybox) =

-
-        if (gUseDistanceFog) then =

-            local fogColorRed           =3D gMaps[gMapIndex].fog_r =

-            local fogColorGreen         =3D gMaps[gMapIndex].fog_g =

-            local fogColorBlue          =3D gMaps[gMapIndex].fog_b
-            local radius =3D cMapBlock_3D_Terrain.iLoadRadius
-            Client_SetFog(3, fogColorRed/255, fogColorGreen/255, fogColorB=
lue/255, 1.0, 0, 3*radius, 3*radius+gFogValue) =

-        end =

+		self:SetMapAreaEnv(gMaps[gMapIndex])
     end
 end
 =




From no-reply at zwischenwelt.org  Tue Mar 24 00:29:00 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 23 Mar 2009 23:29:00 -0000
Subject: [Iris-commit] [IRIS] r2968 - in /trunk/lua: gui/gui.helper.lua
	lib.uoam.lua
Message-ID: <20090323232900.669611C18813@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 24 00:28:59 2009
New Revision: 2968

Log:
uoam chat support

Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.uoam.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Tue Mar 24 00:28:59 2009
@@ -153,6 +153,10 @@
 		end
 	elseif string.sub(curtext, 1, 1) =3D=3D "/" then
 		Send_PartyChat(string.sub(curtext, 2))
+	elseif string.sub(curtext, 1, 3) =3D=3D "-- " then
+		UOAM_SendChat(string.sub(curtext, 4))
+	elseif string.sub(curtext, 1, 2) =3D=3D "--" then
+		UOAM_SendChat(string.sub(curtext, 3))
 	else =

 	=

 		if (gUnicodeTextEntryRequest) then =


Modified: trunk/lua/lib.uoam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoam.lua (original)
+++ trunk/lua/lib.uoam.lua Tue Mar 24 00:28:59 2009
@@ -1,5 +1,7 @@
 -- see also uoamhub : http://max.kellermann.name/projects/uoamhub/
 =

+gUOAMChatColor =3D {0,1,1,1}
+			=

 gUOAMSequenceNumber =3D 1
 gUOAMChunkPrintToggle =3D false
 =

@@ -44,6 +46,7 @@
 0x00, 0x00, 0x00, 0x00 }
 =

 =

+
 gNextUOAMStepT =3D 0
 gUOAMToggle =3D false
 gUOAMOtherPositions =3D {}
@@ -103,8 +106,7 @@
 	end
 	=

 	--~ print("uoam-recv",FIFOHexDump(gUOAMRecvFIFO))
-	UOAM_RecvPositions(gUOAMRecvFIFO)
-	gUOAMRecvFIFO:Clear()
+	UOAM_RecvData(gUOAMRecvFIFO)
 	if (gEnableUOAMDebug) then print("uoamstep",xloc,yloc,MapGetMapIndex(),gU=
OAMConnection:IsConnected()) end
 	gUOAMToggle =3D not gUOAMToggle =

 	UOAM_SendPosUpdate(gUOAMName,gUOAMPass,gUOAMToggle and 0x02 or 0x01,facet=
byte,xloc,yloc)
@@ -153,36 +155,96 @@
 end
 =

 =

-function UOAM_RecvPositions (fifo)
-	if (fifo:Size() < 36) then return end
-	if (fifo:PeekNetUint8(0) ~=3D 0x05) then return end
-	if (fifo:PeekNetUint8(2) ~=3D 0x02) then return end
-	if (fifo:PeekNetUint8(3) ~=3D 0x03) then return end
-	if (fifo:PeekNetUint8(4) ~=3D 0x10) then return end
-	local num1 =3D fifo:PeekNetUint8(24)
-	local num2 =3D fifo:PeekNetUint8(32)
-	fifo:PopRaw(36)
-	gUOAMOtherPositions =3D {}
-	for i =3D 1,num1 do =

-		if (fifo:Size() >=3D 92) then
-			local name =3D fifo:PopFilledString(64)
-			local a =3D fifo:PopUint32()
-			local b =3D fifo:PopUint32()
-			local c =3D fifo:PopUint32()
-			local d =3D fifo:PopUint8()
-			local e =3D fifo:PopUint8()
-			local f =3D fifo:PopUint8()
-			local facetbyte =3D fifo:PopUint8()
-			local x =3D fifo:PopUint32()
-			local y =3D fifo:PopUint32()
-			local z =3D fifo:PopUint32()
-			if (gEnableUOAMDebug) then print("uoam:recv:",a,b,c,d,e,f,facetbyte,x,y=
,z,name) end
-			if (name ~=3D gUOAMName) then =

-				gUOAMOtherPositions[name] =3D {xloc=3Dx,yloc=3Dy,bIsOnSameFacet=3DUOAM=
_GetMyFacetByte() =3D=3D facetbyte}
-			end
-		end =

+
+gUOAM_RecvPacketFifo =3D CreateFIFO()
+function UOAM_RecvData (fifo)
+	local packetfifo =3D gUOAM_RecvPacketFifo
+	repeat
+		if (fifo:Size() < 36) then return end
+		if (fifo:PeekNetUint8(0) ~=3D 0x05 or
+			fifo:PeekNetUint8(3) ~=3D 0x03 or
+			fifo:PeekNetUint8(4) ~=3D 0x10) then =

+			-- protocol broken
+			print("############!!!!!!!!!!!!!!!!!!!!!uoam protocol broken, resetting=
. last dump before :")
+			print(FIFOHexDump(fifo))
+			fifo:Clear()
+			return
+		end
+		=

+		local len1 =3D fifo:PeekNetUint8(8)
+		local len2 =3D fifo:PeekNetUint8(9)
+		local len =3D len1 + 256 * len2
+		if (fifo:Size() < len) then return end -- incomplete packet
+		=

+		packetfifo:Clear()
+		packetfifo:PushFIFOPartRaw(fifo,0,len)
+		fifo:PopRaw(len)
+		UOAM_RecvData_OnePacket(packetfifo,len)
+		if (packetfifo:Size() > 0) then
+			--~ print("uoam:left unused data:",packetfifo:Size())
+			--~ print(FIFOHexDump(packetfifo))
+		end
+	until false
+end
+	=

+function UOAM_RecvData_OnePacket (fifo,len)
+	local packetheadercode =3D fifo:PeekNetUint8(2) -- should be 0x02, except=
 in first packet
+	local msgtype =3D fifo:PeekNetUint8(20)
+	=

+	--~ print("\n#############")
+	--~ print("UOAM_RecvData_OnePacket",packetheadercode,msgtype,len)
+	=

+	if (msgtype =3D=3D 0x00) then -- pos
+		local num1 =3D fifo:PeekNetUint8(24)
+		local num2 =3D fifo:PeekNetUint8(32)
+		fifo:PopRaw(36)
+		gUOAMOtherPositions =3D {}
+		for i =3D 1,num1 do =

+			if (fifo:Size() >=3D 92) then
+				local name =3D fifo:PopFilledString(64)
+				local a =3D fifo:PopUint32()
+				local b =3D fifo:PopUint32()
+				local c =3D fifo:PopUint32()
+				local d =3D fifo:PopUint8()
+				local e =3D fifo:PopUint8()
+				local f =3D fifo:PopUint8()
+				local facetbyte =3D fifo:PopUint8()
+				local x =3D fifo:PopUint32()
+				local y =3D fifo:PopUint32()
+				local z =3D fifo:PopUint32()
+				if (gEnableUOAMDebug) then print("uoam:recv:",a,b,c,d,e,f,facetbyte,x,=
y,z,name) end
+				if (name ~=3D gUOAMName) then =

+					gUOAMOtherPositions[name] =3D {xloc=3Dx,yloc=3Dy,bIsOnSameFacet=3DUOA=
M_GetMyFacetByte() =3D=3D facetbyte}
+				end
+			end =

+		end
+		NotifyListener("Hook_UOAM_PosUpdate")
+	elseif (msgtype =3D=3D 0x01) then -- chat
+		if (len <=3D 44) then return end -- other packet?
+		--~ print("UOAM_RecvData_OnePacket:chat",packetheadercode,msgtype,len)
+		--~ print(FIFOHexDump(fifo))
+		=

+		local namelen =3D fifo:PeekNetUint8(40) -- includes zero, so -1 for text=
len
+		fifo:PopRaw(44)
+		local name =3D fifo:PopFilledString(namelen)
+		fifo:PopRaw(1) -- zero term
+		=

+		-- weird shit, this took a while to find out... also needed during sendi=
ng
+		local padlength =3D 3 - math.mod(namelen,4)
+		fifo:PopRaw(padlength)
+	=

+		--~ print("name",namelen,name,"padlen=3D",padlength)
+		--~ print(FIFOHexDump(fifo))
+	=

+		local textlen =3D fifo:PopUint8()
+		fifo:PopRaw(11)
+		local text =3D fifo:PopFilledString(fifo:Size())
+		--~ print("text",textlen,text)
+		print("uoam:chat",name,text)
+		GuiAddChatLine("["..name.."]: "..text,gUOAMChatColor)
+	else
+		print("UOAM:unknown message type",msgtype)
 	end
-	NotifyListener("Hook_UOAM_PosUpdate")
 end
 =

 function UOAM_SendHandShake ()
@@ -192,6 +254,12 @@
 function UOAM_SendPosUpdate (...)
 	UOAM_PushPosUpdate(gUOAMSendFIFO,...)
 	--~ print(FIFOHexDump(gUOAMSendFIFO))
+	UOAM_TrafficStep()
+	UOAM_PushChatPoll(gUOAMSendFIFO,...)
+	UOAM_TrafficStep()
+end
+function UOAM_SendChat (text)
+	UOAM_PushChat(gUOAMSendFIFO,gUOAMName,gUOAMPass,text)
 	UOAM_TrafficStep()
 end
 =

@@ -236,12 +304,9 @@
 end
 =

 -- handles sequence increment automatically
-function UOAM_PushPosUpdate (fifo,...)
-	UOAM_PushPosUpdateEx(fifo,gUOAMSequenceNumber,...)
+function UOAM_PushPosUpdate (fifo,uname,upass,i22,facet,x,y)
+	local seqnum =3D gUOAMSequenceNumber
 	gUOAMSequenceNumber =3D gUOAMSequenceNumber + 1
-end
-
-function UOAM_PushPosUpdateEx (fifo,seqnum,uname,upass,i22,facet,x,y)
 	local bytes =3D gUOAMPacketTemplate_PosUpdate
 	OverwriteByteArrayPart(bytes,13,UOAM_Long2ByteArray(seqnum))
 	OverwriteByteArrayPart(bytes,23,{i22})
@@ -251,6 +316,141 @@
 	OverwriteByteArrayPart(bytes,129,UOAM_Long2ByteArray(x))
 	OverwriteByteArrayPart(bytes,133,UOAM_Long2ByteArray(y))
 	FIFOPushByteArray(fifo,bytes)
+end
+
+
+gUOAMPacketTemplate_ChatPoll =3D {
+												0x05  ,0x00   ,0x00  ,0x03  ,0x10  ,0x00  ,0x00  ,0x00  ,0x46 =
 ,0x00
+	 ,0x00  ,0x00  ,0x0c  ,0x06  ,0x00  ,0x00  ,0x2e  ,0x00   ,0x00  ,0x00  ,=
0x01  ,0x00  ,0x01  ,0x00  ,0x61  ,0x61
+	 ,0x6f  ,0x61  ,0x61  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00   ,0x00  ,0x00  ,=
0x00  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00
+	 ,0x00  ,0x00  ,0x0a  ,0x00  ,0x02  ,0x0f  ,0x00  ,0x00   ,0x02  ,0x00  ,=
0x06  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00
+	 ,0x00  ,0x00  ,0x06  ,0x00  ,0x00  ,0x00 =

+}
+
+
+
+function UOAM_PushChatPoll (fifo,uname,upass)
+	local seqnum =3D gUOAMSequenceNumber
+	gUOAMSequenceNumber =3D gUOAMSequenceNumber + 1
+	local bytes =3D gUOAMPacketTemplate_ChatPoll
+	local chatname =3D StrMaxLen(uname,54)
+	local namelen =3D string.len(chatname)
+	=

+	-- poll chat : if (data[20] =3D=3D 0x01 && data[22] =3D=3D 0x01) {
+	=

+	OverwriteByteArrayPart(bytes, 9,{65 + namelen}) -- total packet length
+	OverwriteByteArrayPart(bytes,13,UOAM_Long2ByteArray(seqnum))
+	OverwriteByteArrayPart(bytes,23,{i22})
+	OverwriteByteArrayPart(bytes,25,StringToByteArrayZeroTerm(StrMaxLen(upass=
,19)))
+	OverwriteByteArrayPart(bytes,60,{namelen+1})
+	FIFOPushByteArray(fifo,bytes)
+	FIFOPushByteArray(fifo,StringToByteArrayZeroTerm(chatname))
+end
+
+
+
+
+-- font and color or so for chat...
+function UOAM_PushChatInit (fifo,uname,upass) =

+	local seqnum =3D gUOAMSequenceNumber
+	gUOAMSequenceNumber =3D gUOAMSequenceNumber + 1
+	local chatname =3D StrMaxLen(uname,54)
+	local namelen =3D string.len(chatname)
+	=

+	local bytes =3D { 							0x05  ,0x00   ,0x00  ,0x03  ,0x10  ,0x00  ,0x00 =
 ,0x00  ,0x9c  ,0x00   =

+	 ,0x00  ,0x00  ,0x03  ,0x00  ,0x00  ,0x00  ,0x84  ,0x00   ,0x00  ,0x00  ,=
0x01  ,0x00  ,0x00  ,0x00  ,0x61  ,0x61   =

+	 ,0x61  ,0x61  ,0x61  ,0x61  ,0x61  ,0x61  ,0x61  ,0x61   ,0x61  ,0x61  ,=
0x61  ,0x61  ,0x61  ,0x61  ,0x00  ,0x00   =

+	 ,0x00  ,0x00  ,0x0a  ,0x00  ,0x02  ,0x0f  ,0x00  ,0x00   ,0x00  ,0x00  ,=
0x03  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00   =

+	 ,0x02  ,0x00  ,0x06  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00   ,0x00  ,0x00  ,=
0x06  ,0x00  ,0x00  ,0x00  }
+	 =

+	local bytes2 =3D { 0x05  ,0x00   ,0x00  ,0x03  ,0x10  ,0x00  ,0x00  ,0x00=
  ,0x9c  ,0x00   =

+	 ,0x00  ,0x00  ,0x03  ,0x00  ,0x00  ,0x00  ,0x84  ,0x00   ,0x00  ,0x00  ,=
0x01  ,0x00  ,0x00  ,0x00  ,0x61  ,0x61   =

+	 ,0x61  ,0x61  ,0x61  ,0x61  ,0x61  ,0x61  ,0x61  ,0x61   ,0x61  ,0x61  ,=
0x61  ,0x61  ,0x61  ,0x61  ,0x00  ,0x00   =

+	 ,0x00  ,0x00  ,0x0a  ,0x00  ,0x02  ,0x0f  ,0x00  ,0x00   ,0x00  ,0x00  ,=
0x03  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00   =

+	 ,0x02  ,0x00  ,0x06  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00   ,0x00  ,0x00  ,=
0x06  ,0x00  ,0x00  ,0x00  }
+	OverwriteByteArrayPart(bytes, 9,{#bytes + (namelen + 1) + #bytes2}) -- to=
tal packet length
+	OverwriteByteArrayPart(bytes,13,UOAM_Long2ByteArray(seqnum))
+	OverwriteByteArrayPart(bytes,25,StringToByteArrayZeroTerm(StrMaxLen(upass=
,19)))
+	OverwriteByteArrayPart(bytes,61,{namelen+1})
+	OverwriteByteArrayPart(bytes,69,{namelen+1})
+	FIFOPushByteArray(fifo,bytes)
+	FIFOPushByteArray(fifo,StringToByteArrayZeroTerm(chatname))
+	FIFOPushByteArray(fifo,bytes2)
+	=

+	-- pos 72 : start of name
+	=

+	--~ 00 00 2e!00 00 00 04 00  02 00 2e!00 00 00
+	--[[
+	chat font : =

+	0030                    05 00  00 03 10 00 00 00 9c 00   .D.].... ........
+	0040  00 00 03 00 00 00 84 00  00 00 01 00 00 00 61 61   ........ ......aa
+	0050  61 61 61 61 61 61 61 61  61 61 61 61 61 61 00 00   aaaaaaaa aaaaaa..
+	0060  00 00 0a 00 02 0f 00 00  00 00 03!00 00 00 00 00   ........ ........
+	0070  02 00 06 00 00 00 00 00  00 00 06 00 00 00 67 68   ........ ......gh
+	0080  6f 6e 33 00 										 on3.
+					  02 00 40 00  00 00 04 00 02 00 40 00       .. at . ...... at .
+	0090  00 00 ff ff ff 00 f6 ff  ff ff 00 00 00 00 00 00   ........ ........
+	00a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ........ ........
+	00b0  00 00 43 6f 6d 69 63 20  53 61 6e 73 20 4d 53 00   ..Comic  Sans MS.
+	00c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00   ........ ........
+	00d0  00 00                                              ..   =

+	]]--
+end
+
+
+function UOAM_PushChat (fifo,uname,upass,text)
+	if (not gUOAMChatInitSent) then gUOAMChatInitSent =3D true UOAM_PushChatI=
nit(fifo,uname,upass) end
+	local seqnum =3D gUOAMSequenceNumber
+	gUOAMSequenceNumber =3D gUOAMSequenceNumber + 1
+	--~ print("UOAM_PushChat",uname,upass,text)
+	local textlen =3D string.len(text)
+	local chatname =3D StrMaxLen(uname,54)
+	local namelen =3D string.len(chatname)
+	=

+	=

+	local padlength =3D 3 - math.mod(namelen,4) -- don't delete, orginal clie=
nt won't show chat if not padded like this
+	=

+	-- (data[52] =3D=3D 0x01 || data[52] =3D=3D 0x03))
+            --~ (data[52] =3D=3D 0x01 || data[52] =3D=3D 0x03))
+            --~ enqueue_chat(client->domain, data + 52, length - 52);
+	=

+	local bytes =3D {
+													0x05  ,0x00   ,0x00  ,0x03  ,0x10  ,0x00  ,0x00  ,0x00  ,0x68=
  ,0x00   =

+		 ,0x00  ,0x00  ,0xf5  ,0x0c  ,0x00  ,0x00  ,0x50  ,0x00   ,0x00  ,0x00  =
,0x01  ,0x00  ,0x00  ,0x00  ,0x61  ,0x61   =

+		 ,0x61  ,0x61  ,0x61  ,0x00  ,0x61  ,0x61  ,0x61  ,0x61   ,0x61  ,0x61  =
,0x61  ,0x61  ,0x61  ,0x61  ,0x00  ,0x00   =

+		 ,0x00  ,0x00  ,0x0a  ,0x00  ,0x02  ,0x0f  ,0x00  ,0x00   ,0x00  ,0x00  =
,0x01  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00   =

+		 ,0x02  ,0x00  ,0x05  ,0x00  ,0x00  ,0x00  ,0x00  ,0x00   ,0x00  ,0x00  =
,0x05  ,0x00  ,0x00  ,0x00  }
+	-- username zeroterm + padding here
+	local bytes2 =3D {																					 	  =

+							   0x0c  ,0x00   ,0x00  ,0x00  ,0x04  ,0x00  ,0x02  ,0x00  ,0x0c  ,=
0x00   =

+		 ,0x00  ,0x00  ,      =

+	}
+	-- text zeroterm here
+	=

+	local len =3D #bytes + (namelen+1) + padlength + #bytes2 + (textlen+1)
+	local len2 =3D floor(len/256)
+	local len1 =3D len - len2*256
+	--~ print("sending chat, len=3D",len)
+	OverwriteByteArrayPart(bytes, 9,{len1}) -- total packet length
+	OverwriteByteArrayPart(bytes,10,{len2}) -- total packet length
+	OverwriteByteArrayPart(bytes,13,UOAM_Long2ByteArray(seqnum))
+	--~ OverwriteByteArrayPart(bytes,17,{})
+	OverwriteByteArrayPart(bytes,25,StringToByteArrayZeroTerm(StrMaxLen(upass=
,19)))
+	OverwriteByteArrayPart(bytes,61,{namelen+1})
+	OverwriteByteArrayPart(bytes,69,{namelen+1})
+	=

+	FIFOPushByteArray(fifo,bytes) =

+	FIFOPushByteArray(fifo,StringToByteArrayZeroTerm(chatname)) =

+	=

+	--~ print("chatname,namelen,padlength",chatname,namelen,padlength)
+	if (padlength >=3D 1) then fifo:PushNetUint8(0x00) end
+	if (padlength >=3D 2) then fifo:PushNetUint8(0x02) end
+	if (padlength >=3D 3) then fifo:PushNetUint8(0x00) end
+	=

+	OverwriteByteArrayPart(bytes2, 1,{textlen+1})
+	OverwriteByteArrayPart(bytes2, 9,{textlen+1})
+	FIFOPushByteArray(fifo,bytes2) =

+	FIFOPushByteArray(fifo,StringToByteArrayZeroTerm(text)) =

 end
 =

 function UOAM_ArrayStartsWith (arr1,arr2,arr2first)
@@ -297,3 +497,4 @@
 	--~ dofile(libpath .. "../uoam_sample2.lua")
 	dofile(libpath .. "../uoam_sample3.lua")
 end
+



From no-reply at zwischenwelt.org  Thu Mar 26 01:01:30 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 26 Mar 2009 00:01:30 -0000
Subject: [Iris-commit] [IRIS] r2970 - /trunk/bin/D3DX9_38.dll
Message-ID: <20090326000131.164B91C18818@zwischenwelt.org>

Author: sience
Date: Thu Mar 26 01:01:30 2009
New Revision: 2970

Log:
-D3DX9_38.dll added (so users dont's have to update directx)

Added:
    trunk/bin/D3DX9_38.dll   (with props)



From no-reply at zwischenwelt.org  Thu Mar 26 02:09:24 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 26 Mar 2009 01:09:24 -0000
Subject: [Iris-commit] [IRIS] r2971 - in /trunk/bin:
 Microsoft.VC90.CRT.manifest msvcp90.dll msvcr90.dll updater.exe
Message-ID: <20090326010924.64DEF1C18813@zwischenwelt.org>

Author: sience
Date: Thu Mar 26 02:09:23 2009
New Revision: 2971

Log:
-updater.exe updated and compiled wholy with VC9 (before it has a dependenc=
y to VC8 - my bad)
-VC9 dependencys added (iris2 should now run without any visual studio runt=
imes)

Added:
    trunk/bin/Microsoft.VC90.CRT.manifest
    trunk/bin/msvcp90.dll   (with props)
    trunk/bin/msvcr90.dll   (with props)
Modified:
    trunk/bin/updater.exe

Modified: trunk/bin/updater.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Thu Mar 26 20:48:31 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 26 Mar 2009 19:48:31 -0000
Subject: [Iris-commit] [IRIS] r2972 - /trunk/lua/lib.mainmenu.background.lua
Message-ID: <20090326194831.F2A671C18817@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar 26 20:48:31 2009
New Revision: 2972

Log:
restored SetMainMenuCam code-comment (again)

Modified:
    trunk/lua/lib.mainmenu.background.lua

Modified: trunk/lua/lib.mainmenu.background.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.background.lua (original)
+++ trunk/lua/lib.mainmenu.background.lua Thu Mar 26 20:48:31 2009
@@ -25,3 +25,21 @@
     DestroyIfAlive(gMenuBgImage)
     gMenuBgImage =3D nil
 end
+
+--[[
+-- old, wasn't used anymore
+local function SetMainMenuCam (roth,rotv)
+	local cam =3D GetMainCam()
+	cam:SetFOVy(gfDeg2Rad*45)
+	cam:SetNearClipDistance(0.5) -- old : 1
+	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
+	cam:SetProjectionType(kCamera_PT_PERSPECTIVE) -- perspective
+	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
+	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

+	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
+	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
+	=

+	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
+	GetMainCam():SetRot(w,x,y,z)	=

+end
+]]--



From no-reply at zwischenwelt.org  Thu Mar 26 23:51:44 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 26 Mar 2009 22:51:44 -0000
Subject: [Iris-commit] [IRIS] r2973 - /branches/stable_release/
Message-ID: <20090326225144.DFFB11C18816@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar 26 23:51:43 2009
New Revision: 2973

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Thu Mar 26 23:51:45 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 26 Mar 2009 22:51:45 -0000
Subject: [Iris-commit] [IRIS] r2974 - /branches/stable_release/
Message-ID: <20090326225146.0C3031C18817@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar 26 23:51:45 2009
New Revision: 2974

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r2973, trunk/



From no-reply at zwischenwelt.org  Thu Mar 26 23:51:47 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 26 Mar 2009 22:51:47 -0000
Subject: [Iris-commit] [IRIS] r2975 - /branches/stable_release/
Message-ID: <20090326225148.0B7AA1C18818@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Mar 26 23:51:46 2009
New Revision: 2975

Log:
lugre -r700 svn://zwischenwelt.org/lugre/trunk/lugre

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Fri Mar 27 22:10:46 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 27 Mar 2009 21:10:46 -0000
Subject: [Iris-commit] [IRIS] r2976 - in /trunk/lua: gui/gui.helper.lua
 lib.3d.map.lua lib.3d.renderer.lua lib.3d.walksmooth.lua
 lib.mapblock.scheduler.lua lib.mapblock.spawner.lua
Message-ID: <20090327211049.83CB91C18813@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Mar 27 22:10:45 2009
New Revision: 2976

Log:
maparea check after login ( custom skybox + fogcolor ) , small debug utils

Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.3d.walksmooth.lua
    trunk/lua/lib.mapblock.scheduler.lua
    trunk/lua/lib.mapblock.spawner.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Fri Mar 27 22:10:45 2009
@@ -89,7 +89,7 @@
 			end
 		end
 					=

-		local text =3D sprintf("%5.1ffps %dt %db gfx | OGRE:%s | LUA:%s | cpu/(c=
pu+gpu):%d%% | %i j %i/%i l",
+		local text =3D sprintf("%5.1ffps %dt %db gfx | OGRE:%s | LUA:%s | cpu/(c=
pu+gpu):%d%% | job:%d | blockload:%d/%d",
 			fps, t, b, =

 			DisplayMemoryUsageFormatHelper(memoryusage),
 			DisplayMemoryUsageFormatHelper(mem_dyn), =


Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Fri Mar 27 22:10:45 2009
@@ -121,7 +121,9 @@
 end
 =

 -- check if player entered or left a special map area, e.g. a dungeon. can=
 be used to change things like skybox/lighting
-function Renderer3D:MapAreaCheck (x,y)
+function Renderer3D:MapAreaCheck ()
+    local x,y,z =3D GetPlayerPos()
+    if (not z) then return end
 	local bx =3D floor(x/8)
 	local by =3D floor(y/8)
 	if (gLastMapAreaBlockX =3D=3D bx and
@@ -129,14 +131,15 @@
 	gLastMapAreaBlockX =3D bx
 	gLastMapAreaBlockY =3D by
 	local areas =3D gMaps[gMapIndex].mapareas
-	if (not areas) then return end
-	local activearea
-	for k,area in pairs(areas) do =

-		if (x >=3D area.minx and =

-			y >=3D area.miny and
-			x <=3D area.maxx and =

-			y <=3D area.maxy) then =

-			activearea =3D area
+	local activearea =3D false -- shouldn't be nil so we at least get an init=
ial set
+	if (areas) then
+		for k,area in pairs(areas) do =

+			if (x >=3D area.minx and =

+				y >=3D area.miny and
+				x <=3D area.maxx and =

+				y <=3D area.maxy) then =

+				activearea =3D area
+			end
 		end
 	end
 	print("Renderer3D:MapAreaCheck",x,y,activearea)
@@ -151,7 +154,7 @@
     if (not z) then return end
 	=

 	-- BlendOutLayersAbovePlayer always called when pos is updated, so we'll =
just add the area check here for now
-	self:MapAreaCheck(x,y)
+	self:MapAreaCheck()
     =

     =

     --[[

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Fri Mar 27 22:10:45 2009
@@ -86,6 +86,8 @@
     -- SiENcE: not needed anymore? bring up and assertion failure (it seem=
s without, everything is correct)
     for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynam=
ic)) then self:AddDynamicItem(dynamic) end end
     for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile)=
 end
+	=

+	self:BlendOutLayersAbovePlayer()
 end
 =

 function Renderer3D:StopWorld ()
@@ -296,7 +298,7 @@
         rotate(gCaelumSystem:GetCaelumCameraNode(), w,x,y,z)
     else
         -- black background when underground =

-		self:SetMapAreaEnv(gMaps[gMapIndex])
+		self:MapAreaCheck()
     end
 end
 =


Modified: trunk/lua/lib.3d.walksmooth.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.walksmooth.lua (original)
+++ trunk/lua/lib.3d.walksmooth.lua Fri Mar 27 22:10:45 2009
@@ -103,6 +103,7 @@
     if (not playermobile) then return end
     gTileFreeWalk:NotifyPlayerMobileTeleport(playermobile)
     self:WalkSmoothReset(playermobile)
+	self:BlendOutLayersAbovePlayer()
 end
 =

 -- used when teleported

Modified: trunk/lua/lib.mapblock.scheduler.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.scheduler.lua (original)
+++ trunk/lua/lib.mapblock.scheduler.lua Fri Mar 27 22:10:45 2009
@@ -13,7 +13,10 @@
 	self.kAllowedTicksPerFrame =3D self.kGoodTicksBetweenFrames
 end
 =

-function cScheduler:AddProcess		(process) table.insert(self.pProcessList,p=
rocess) end
+function cScheduler:AddProcess		(process) =

+	if (gDebugJobOrigin) then process.source =3D process.source or GetOneLine=
BackTrace(2) end
+	table.insert(self.pProcessList,process) =

+end
 function cScheduler:RemoveProcess	(process)
 	local pos =3D self:_FindProcessPos(process)
 	if (pos) then table.remove(self.pProcessList,pos) end
@@ -45,6 +48,17 @@
 	end =

 	=

 	giShowLoading =3D countarr(active_blocks)
+	if (gDebugJobOrigin and giShowLoading > 20) then =

+		print("cScheduler:Step : MANY BLOCKS",giShowLoading) =

+		local top =3D {}
+		for k,process in pairs(active_blocks) do =

+			local source =3D process.source or "???"
+			top[source] =3D (top[source] or 0) + 1
+		end
+		for k,v in pairs(top) do top[k] =3D {name=3Dk,v=3Dv} end
+		local top =3D SortedArrayFromAssocTable(top,function (a,b) return a.v < =
b.v end)
+		for k,v in pairs(top) do print(" ",v.v,v.name) end
+	end
 	=

 	-- sort by priority
 	table.sort(active_blocks,self.CmpProcess)

Modified: trunk/lua/lib.mapblock.spawner.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.spawner.lua (original)
+++ trunk/lua/lib.mapblock.spawner.lua Fri Mar 27 22:10:45 2009
@@ -81,10 +81,22 @@
 	for block,v in pairs(self.pMapBlocks) do if (block.bx =3D=3D bx and block=
.by =3D=3D by) then return block end end =

 end
 =

+function GetOneLineBackTrace (l)
+	local res =3D {}
+	l =3D (l or 1) + 1
+	repeat =

+		local i =3D debug.getinfo(l,"Sl")
+		if (not i ) then break end
+		table.insert(res,i.source..":"..i.currentline)
+		l =3D l + 1
+	until l > 5
+	return table.concat(res," ")
+end
+
 function cMapBlockSpawner:CreateMapBlock	(bx,by)
 	--~ print("cMapBlockSpawner:CreateMapBlock",bx,by)
 	local block =3D CreateClassInstance(self.pBlockClass, bx,by)
-	=

+	if (gDebugJobOrigin) then block.source =3D GetOneLineBackTrace(2) end
 	self.pMapBlocks[block] =3D true =

 	self.pScheduler:AddProcess(block)
 	return block



From no-reply at zwischenwelt.org  Tue Mar 31 18:27:48 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 31 Mar 2009 16:27:48 -0000
Subject: [Iris-commit] [IRIS] r2977 - in /trunk/lua: lib.desktop.lua
	net/net.object.lua
Message-ID: <20090331162748.5D6D21C18816@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 31 18:27:47 2009
New Revision: 2977

Log:
disabled desktop-system:opening of containers on login, opened too many, an=
d doubleclicking more than one causes you-must-wait message anyway

Modified:
    trunk/lua/lib.desktop.lua
    trunk/lua/net/net.object.lua

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Mar 31 18:27:47 2009
@@ -132,7 +132,9 @@
 -- container
 -- ------------------------------------------------------------------------
 gDesktopElementFactory.container =3D {
-    open =3D function(x,y,param) OpenContainer(param,x,y) end, =

+    open =3D function(x,y,param) =

+			-- OpenContainer(param,x,y)   disabled for now, doubleclicking more tha=
n one causes "you must wait" anyway
+		end, =

     checkpos =3D function(e, widget) =

         local serial =3D (widget.uoContainer and widget.uoContainer.serial=
) or 0
         if e.param =3D=3D serial then e.x,e.y =3D widget:GetPos() return t=
rue end

Modified: trunk/lua/net/net.object.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.object.lua (original)
+++ trunk/lua/net/net.object.lua Tue Mar 31 18:27:47 2009
@@ -2,7 +2,7 @@
 -- see also lib.packet.lua and lib.protocol.lua
 =

 function Send_DoubleClick (iSerial)
-	print("Send_DoubleClick",sprintf("0x%08x",iSerial))
+	print("Send_DoubleClick",sprintf("0x%08x",iSerial),GetOneLineBackTrace(2))
 	printdebug("net",sprintf("NET: Send_DoubleClick: 0x%08x\n",iSerial))
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Double_Click)



From no-reply at zwischenwelt.org  Tue Mar 31 19:14:20 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 31 Mar 2009 17:14:20 -0000
Subject: [Iris-commit] [IRIS] r2978 - /trunk/lua/lib.protocol.lua
Message-ID: <20090331171421.0FA2E1C18816@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 31 19:14:20 2009
New Revision: 2978

Log:
packetlogging format changed to razor-packetlog-format for easier comparison

Modified:
    trunk/lua/lib.protocol.lua

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Tue Mar 31 19:14:20 2009
@@ -92,29 +92,46 @@
 function LogPacket (fifo,len,direction) =

 	if (not gLogPackets or not (len > 0)) then return end
 	local cmd =3D fifo:PeekNetUint8(0)
-	local info =3D sprintf("Packet [%02x], Length: %d, Type: %s\n",cmd,len,di=
rection or "unknown")
-	local rowlen =3D 16
-	local s =3D ""
-	for i =3D 1,len do
-		if (i =3D=3D 1) then
-			info =3D info .. sprintf("%02x ",cmd)
-			if cmd >=3D 32 and cmd <=3D 126 then s =3D s .. sprintf("%c",cmd) else =
s =3D s .. "." end
-		else
-			info =3D info .. sprintf("%02x ",fifo:PeekNetUint8(i-1))
-			if fifo:PeekNetUint8(i-1) >=3D 32 and fifo:PeekNetUint8(i-1) <=3D 126 t=
hen s =3D s .. sprintf("%c",fifo:PeekNetUint8(i-1)) else s =3D s .. "." end
+
+	local dirother =3D (direction =3D=3D "Client") and "Server" or "Client"
+	local subtime =3D Client_GetTicks()
+	local info =3D sprintf("%s.%d: %s -> %s 0x%02X (Length: %d)\n",os.date("%=
H:%M:%S"),subtime,direction,dirother,cmd,len)
+	-- 17:55:14.5486: Client -> Server 0x80 (Length: 62)
+	info =3D info.."        0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F\n"
+	info =3D info.."       -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --\n"
+	=

+	local hexdump =3D ""
+	local ascidump =3D ""
+	local bytesperline =3D 16
+	local lastbyte =3D 0
+	local linepos =3D 0
+	for i =3D 0,len-1 do =

+		local c =3D fifo:PeekNetUint8(i)
+		if (math.mod(i,bytesperline) =3D=3D 8) then hexdump =3D hexdump .. " " e=
nd
+		hexdump =3D hexdump .. sprintf("%02X ",c)
+		=

+		local a =3D (c >=3D 32 and c < 127) and sprintf("%c",c) or "."
+		ascidump =3D ascidump .. a
+		if (math.mod(i + 1,bytesperline) =3D=3D 0) then
+			info =3D info..sprintf("%04X   ",linepos)..hexdump.."  "..ascidump.."\n"
+			linepos =3D linepos + bytesperline
+			hexdump =3D ""
+			ascidump =3D ""
 		end
-		if (math.mod(i,rowlen) =3D=3D 0) then =

-			info =3D info .. "\t".. s .."\n" =

-			s =3D ""
+		lastbyte =3D i
+	end
+	if (string.len(hexdump) > 0) then =

+		for i =3D math.mod(lastbyte,bytesperline) + 2 , bytesperline do
+			if (math.mod(i,bytesperline) =3D=3D 8) then hexdump =3D hexdump .. " " =
end
+			hexdump =3D hexdump .. "   "
 		end
+		info =3D info..sprintf("%04X   ",linepos)..hexdump.."  "..ascidump.."\n"
 	end
-	info =3D info .. "\t".. s .."\n\n"
-
+	info =3D info.."\n\n"
+	=

 	if (gPacketLogInit) then
 		gPacketLogInit =3D false
-		info =3D "####################\n\n" .. info
-		info =3D "## NEW GAME START ##\n" .. info
-		info =3D "####################\n" .. info
+		info =3D ">>>>>>>>>> Logging started "..os.date("%d.%m.%Y %H:%M:%S").." =
(iris) <<<<<<<<<<\n\n" .. info
 	end
 	=

 	local file =3D io.open("packets.txt","a")



From no-reply at zwischenwelt.org  Tue Mar 31 23:04:16 2009
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 31 Mar 2009 21:04:16 -0000
Subject: [Iris-commit] [IRIS] r2979 - in /trunk/lua: lib.protocol.lua
	net/net.login.lua
Message-ID: <20090331210416.D2CFD1C18816@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Mar 31 23:04:16 2009
New Revision: 2979

Log:
iris packetlog : added packetnames. updated prelogin unknown data

Modified:
    trunk/lua/lib.protocol.lua
    trunk/lua/net/net.login.lua

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Tue Mar 31 23:04:16 2009
@@ -95,7 +95,8 @@
 =

 	local dirother =3D (direction =3D=3D "Client") and "Server" or "Client"
 	local subtime =3D Client_GetTicks()
-	local info =3D sprintf("%s.%d: %s -> %s 0x%02X (Length: %d)\n",os.date("%=
H:%M:%S"),subtime,direction,dirother,cmd,len)
+	local name =3D gPacketTypeId2Name[cmd] or "???"
+	local info =3D sprintf("%s.%d: %s -> %s 0x%02X (Length: %d, name=3D%s)\n"=
,os.date("%H:%M:%S"),subtime,direction,dirother,cmd,len,name)
 	-- 17:55:14.5486: Client -> Server 0x80 (Length: 62)
 	info =3D info.."        0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F\n"
 	info =3D info.."       -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --\n"

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Tue Mar 31 23:04:16 2009
@@ -351,6 +351,21 @@
 =

 -- Send Packets -----------------------------------------------------------
 =

+function UOLoginPushFilledStringAddByte (fifo,str,filllen,addbyte)
+	-- original seem to place addbyte=3D0x74 after the first 0 byte in the st=
ring.. (hybrid check?)
+	local namefifo =3D CreateFIFO()
+	namefifo:PushFilledString(str,filllen)
+	local bWaitForFirstZero =3D true
+	local bNextZeroReplaced =3D false
+	for i =3D 0,namefifo:Size()-1 do =

+		local c =3D namefifo:PeekNetUint8(i)
+		if (c =3D=3D 0 and bNextZeroReplaced) then c =3D addbyte bNextZeroReplac=
ed =3D false end
+		if (c =3D=3D 0 and bWaitForFirstZero) then bWaitForFirstZero =3D false b=
NextZeroReplaced =3D true end
+		fifo:PushNetUint8(c)
+	end
+	namefifo:Destroy()
+end
+
 -- send login server request 0x80
 -- answered by 0xA8 kPacket_Server_List which calls MainMenuShowServerList
 function Send_Account_Login_Request	(sName,sPassword,iSeed) -- 0x80
@@ -361,7 +376,9 @@
 	printdebug("login",sprintf("NET: Account_Login_Request: Name: %s Password=
: %s\n",gPWReplace or sName,gPWReplace or sPassword))
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Account_Login_Request) -- 0x80
-	out:PushFilledString(sName,30)
+	=

+	=

+	UOLoginPushFilledStringAddByte(out,sName,30,0x74)
 	out:PushFilledString(sPassword,30)
 	out:PushNetUint8(iSeed or hex2num("0x5D"))
 	out:SendPacket()
@@ -389,7 +406,7 @@
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Post_Login) -- 0x91
 	out:PushNetUint32(iAccount)
-	out:PushFilledString(sName,30)
+	UOLoginPushFilledStringAddByte(out,sName,30,0x74)
 	out:PushFilledString(sPassword,30)
 	out:SendPacket()
 end
@@ -480,10 +497,30 @@
 	=

 			=

 													--  4 : 41
-	--~ out:PushNetUint32(hex2num("0x0000001F"))	-- RunUO uses this unknown f=
lags (maybe for map 3,4 support) (pre.08.02.2008)
-	out:PushNetUint32(hex2num("0x0000003F"))		-- 6.0.9.2 RunUO uses this unkn=
own flags (maybe for map 3,4 support) (08.02.2008:ghoul:packetlog from razo=
r login has 0x3f here)
+	--~ out:PushNetUint32(0x0000001F)	-- RunUO uses this unknown flags (maybe=
 for map 3,4 support) (pre.08.02.2008)
+	out:PushNetUint32(0x0000003F)		-- 6.0.9.2 RunUO uses this unknown flags (=
maybe for map 3,4 support) (08.02.2008:ghoul:packetlog from razor login has=
 0x3f here)
 	-- razor : int flags =3D pvSrc.ReadInt32();
 	=

+	=

+	-- new : 31.03.2009
+	out:PushNetUint8(0x00)
+	out:PushNetUint8(0x00)
+	out:PushNetUint8(0x00)
+	out:PushNetUint32(0x01000000)
+	=

+	-- addr0x30
+	out:PushNetUint32(0x34000000) -- was 0x30000000  before?
+	out:PushNetUint32(0x00000000)
+	out:PushNetUint32(0x00000000)
+	out:PushNetUint32(0x00000000)
+	=

+	-- addr0x40
+	out:PushNetUint32(0x00000000)
+	out:PushNetUint32(0x000A0002)
+	out:PushNetUint8(0x0F)
+	=

+	=

+	--[[ old :31.03.2009
 	out:PushFilledString("",6)					--  6 : 47 -- obsolete for RunUO
 	--~ out:PushNetUint16(hex2num("0x004B"))		--  2 : 49 -- obsolete for RunU=
O - 0x4A (2D_V.5.0.8.2_ML) 0x4B (2D_V.5.0.9.1_ML) (pre.08.02.2008)
 	out:PushNetUint16(hex2num("0x0030"))		--  2 : 49 -- obsolete for RunUO - =
6.0.9.2 (08.02.2008:ghoul:packetlog from razor login has 0x30 here)
@@ -493,6 +530,7 @@
 	--~ int charSlot =3D pvSrc.ReadInt32();
 	=

 	out:PushNetUint32(hex2num("0xC0A83016"))	--  4 : 73 --TODO: check: iAccou=
nt or GameServerIP
+	]]--
 	out:SendPacket()
 end
 =




