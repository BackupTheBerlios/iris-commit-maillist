From no-reply at zwischenwelt.org  Wed Oct  1 00:28:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 30 Sep 2008 22:28:08 -0000
Subject: [Iris-commit] [IRIS] r2481 - in /trunk/lua: gui/gui.spellbook.lua
 net/net.other.lua obj/obj.container.lua
Message-ID: <20080930230013.DD85B1C1801A@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct  1 00:28:04 2008
New Revision: 2481

Log:
spellbook fix

Modified:
    trunk/lua/gui/gui.spellbook.lua
    trunk/lua/net/net.other.lua
    trunk/lua/obj/obj.container.lua

Modified: trunk/lua/gui/gui.spellbook.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.spellbook.lua (original)
+++ trunk/lua/gui/gui.spellbook.lua Wed Oct  1 00:28:04 2008
@@ -69,7 +69,7 @@
 function Open_Spellbook(spellbookdata)
 	local serial =3D spellbookdata.serial
 	local spellbook =3D gSpellbooks[serial]
-	if (gSpellbooks[serial]) then =

+	if (spellbook) then =

 		for k,v in pairs(spellbookdata) do spellbook[k] =3D v end
 	else
 		spellbook =3D spellbookdata
@@ -81,6 +81,7 @@
 		for i=3D1,8 do spellbook.matrix[i] =3D 0 end
 	end
 	--~ print("Open_Spellbook",SmartDump(spellbook.matrix))
+	print("Open_Spellbook",spellbook.scrolloffset,spellbook.itemid)
 	Update_Spellbook(serial)
 end
 =

@@ -107,7 +108,7 @@
 		-- check and get invisible spellbook container with spellbook items (scr=
olls)
 		local container =3D GetOrCreateContainer(spellbook.serial)
 		spellbook.matrix =3D Convert_Spellbookcontainer(spellbook.matrix,contain=
er)
-		spellbook.itemid =3D MageSpellbook
+		spellbook.itemid =3D spellbook.itemid or MageSpellbook
 	end
 =

 	--base( Core.AOS ? 0x22C5 : 0xEFA )  - if AoS take Runebook otherwise Spe=
llbook

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Wed Oct  1 00:28:04 2008
@@ -290,6 +290,7 @@
 	-- matix 0xff030000
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_NewSpellbook) then -- 0x1B
 		local spellbook =3D {}
+		spellbook.old=3Dfalse
 		spellbook.matrix =3D {}
 		spellbook.unknown =3D input:PopNetUint16()
 		spellbook.serial =3D input:PopNetUint32()
@@ -303,6 +304,7 @@
 		spellbook.matrix[6] =3D input:PopNetUint8()
 		spellbook.matrix[7] =3D input:PopNetUint8()
 		spellbook.matrix[8] =3D input:PopNetUint8()
+		print("kPacket_Generic_SubCommand_NewSpellbook",spellbook.scrolloffset,s=
pellbook.unknown,spellbook.serial,spellbook.itemid)
 		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_NewSpellbook s=
erial=3D0x%08x itemId=3D0x%04x offset=3D0x%04x\n",
 								spellbook.serial, spellbook.itemid, spellbook.scrolloffset))
 		Open_Spellbook(spellbook)

Modified: trunk/lua/obj/obj.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.container.lua (original)
+++ trunk/lua/obj/obj.container.lua Wed Oct  1 00:28:04 2008
@@ -89,8 +89,8 @@
 		spellbook.serial =3D containerdata.serial
 		spellbook.itemid =3D containerdata.gumpid
 		-- container with spell is already created (invisible)
+		printf("NET: Old_Spellbook: serial=3D0x%08x itemId=3D0x%04x offset=3D0x%=
04x\n",spellbook.serial or 0, spellbook.itemid or 0, spellbook.scrolloffset=
 or 0)
 		Open_Spellbook(spellbook)
-		printf("NET: Old_Spellbook: serial=3D0x%08x itemId=3D0x%04x offset=3D0x%=
04x\n",spellbook.serial or 0, spellbook.itemid or 0, spellbook.scrolloffset=
 or 0)
 		return =

 	end
 	=




From no-reply at zwischenwelt.org  Wed Oct  1 00:56:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 30 Sep 2008 22:56:44 -0000
Subject: [Iris-commit] [IRIS] r2482 - /trunk/lua/gui/gui.skill.lua
Message-ID: <20080930230014.2A2C01524032@zwischenwelt.org>

Author: hagish
Date: Wed Oct  1 00:56:39 2008
New Revision: 2482

Log:
improved skill dialog (different orders)

Modified:
    trunk/lua/gui/gui.skill.lua

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Wed Oct  1 00:56:39 2008
@@ -17,7 +17,8 @@
 	 "{ button 255 61 2084 2084 1 0 1 skillscrollup }" ..
 	 "{ button 255 291 2085 2085 1 0 2 skillscrolldown }" ..
 	 "{ button 139 4 2093 2093 1 0 3 skillclose }" ..
-	 "{ button 259 76 2088 2088 1 0 4 skillscroll }"
+	 "{ button 259 76 2088 2088 1 0 4 skillscroll }" ..
+	 "{ button 50 10 0x28DC 0x28DC 1 0 5 skillsort }"
 skillGump.textline =3D {
 }
 skillGump.functions =3D {
@@ -39,7 +40,43 @@
  [4]	=3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget) end
 		  end,
+ -- update skill sorting order
+ [5]	=3D function (widget,mousebutton)
+			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() widget.dial=
og:NextOrder() end
+		  end,
 }
+
+giNumberOfVisibleSkills =3D 12
+
+-- -------------- compare functions for skill order ------
+function SkillComp_Name	(a,b)
+	return a.name < b.name
+end
+
+function SkillComp_Value	(a,b)
+	local va =3D gPlayerSkills[a.skillid].value
+	local vb =3D gPlayerSkills[b.skillid].value
+	if va ~=3D vb then =

+		return va > vb =

+	else
+		return SkillComp_Name	(a,b)
+	end
+end
+
+function SkillComp_SkillId	(a,b)
+	return a.skillid < b.skillid
+end
+
+function SkillComp_Active	(a,b)
+	return glSkillActive[a.skillid] > glSkillActive[b.skillid]
+end
+
+function SkillComp_LockState	(a,b)
+	return gPlayerSkills[a.skillid].lockstate < gPlayerSkills[b.skillid].lock=
state =

+end
+
+glSkillCompList =3D {SkillComp_Value, SkillComp_Name, SkillComp_SkillId, S=
killComp_Active, SkillComp_LockState}
+---------------------------------------------------------------
 =

 -- Created 11.03.2008 15:41:19, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
@@ -245,10 +282,6 @@
 	NotifyListener("Hook_CreateQuickWeaponAbility",d,x,y,weaponabilityid)
 	return d
 end
-
-
-
-
 =

 =

 =

@@ -336,6 +369,26 @@
 			dialog:ScrollToIndex(dialog.miScrollPosition + d)
 		end
 		=

+		-- order table
+		dialog.Order =3D function (dialog, comp)
+			table.sort(dialog.lSkill, comp or SkillComp_Value)
+			local i =3D 0
+			for k,v in pairs(dialog.lSkill) do
+				v.index =3D i
+				i =3D i + 1
+			end
+		end
+		=

+		dialog.NextOrder =3D function (dialog)
+			local len =3D #glSkillCompList
+			local index =3D (dialog.current_order_function_index or 0) + 1
+			dialog:Order(glSkillCompList[math.fmod(index - 1, len) + 1])
+			dialog.current_order_function_index =3D index
+			dialog:ScrollToIndex(0)
+			dialog:ScrollToIndex(1)
+			dialog:ScrollToIndex(0)
+		end
+		=

 		-- scroll the skilllist that index is at the top most position
 		dialog.ScrollToIndex =3D function (dialog, index)
 			if index ~=3D dialog.miScrollPosition then
@@ -345,7 +398,7 @@
 				-- startposition
 				local x,y =3D 40,80
 				-- number of visible skills
-				local h =3D 10
+				local h =3D giNumberOfVisibleSkills
 =

 				-- scroll limit
 				local maxindex =3D table.getn(dialog.lSkill) - h
@@ -408,8 +461,13 @@
 				skill.button_use_drag =3D nil
 				skill.skillid =3D k
 				skill.name =3D name
+				=

+				local sname =3D name				=

+				if string.len(sname) > 17 then
+					sname =3D string.sub(sname,0,17)..".." =

+				end
 								=

-				skill.text =3D guimaker.MakeText (curparent, x, y, name, gFontDefs["Gu=
mp"].size, gFontDefs["Gump"].col, gFontDefs["Gump"].name)
+				skill.text =3D guimaker.MakeText (curparent, x, y, sname, gFontDefs["G=
ump"].size, gFontDefs["Gump"].col, gFontDefs["Gump"].name)
 				--[[
 				skill.text.onMouseDown 		=3D function (widget,mousebutton)
 					if (mousebutton =3D=3D 1) then =

@@ -473,6 +531,11 @@
 			end
 		end
 =

+		-- order the list with previous comp function
+		if dialog.current_order_function_index and glSkillCompList[dialog.curren=
t_order_function_index] then
+			dialog:Order(glSkillCompList[dialog.current_order_function_index])
+		end
+		=

 		-- scroll to last position if available
 		if gSkillDialog_LastPositionScrollIndex then =

 			dialog:ScrollToIndex(gSkillDialog_LastPositionScrollIndex)
@@ -483,5 +546,7 @@
 		-- resize limits
 		dialog.resize_min_total_x,dialog.resize_min_total_y =3D -100,-66
 		dialog.resize_max_total_x,dialog.resize_max_total_y =3D 334,212
-	end
-end
+		=

+		dialog:NextOrder()
+	end
+end



From no-reply at zwischenwelt.org  Wed Oct  1 02:11:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 01 Oct 2008 00:11:14 -0000
Subject: [Iris-commit] [IRIS] r2483 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.mobile.lua lib.2d.renderer.lua lib.2d.spriteblock.lua
Message-ID: <20081001001114.A5B2D1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct  1 02:11:13 2008
New Revision: 2483

Log:
2d : fixed mobile positions and sort order

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.2d.spriteblock.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Wed Oct  1 02:11:13 2008
@@ -30,7 +30,7 @@
 		local sortty =3D yloc-floor(yloc/8)*8
 		local sorttz =3D zloc
 		local fIndexRel =3D k / totalpartnum
-		local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Calc=
SortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel)+1,item)
+		local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Calc=
SortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
 		sprite.xloc =3D xloc -- mousepicking
 		sprite.yloc =3D yloc
 		sprite.zloc =3D zloc
@@ -62,7 +62,7 @@
 		local sorttz =3D zloc
 		local iTileTypeID	=3D item.artid
 		local iHue			=3D item.hue
-		spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,CalcSortBonus(iTileTy=
peID,sorttx,sortty,sorttz,fIndexRel)+1,item)
+		spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,CalcSortBonus(iTileTy=
peID,sorttx,sortty,sorttz,fIndexRel,1),item)
 		spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
 		local x,y,z =3D gCurrentRenderer:UOPosToLocal(xloc,yloc,zloc*kRenderer2D=
_ZScale)
 		spriteblock:SetPosition(x,y,z)

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Wed Oct  1 02:11:13 2008
@@ -7,30 +7,39 @@
 	if (not gfx) then
 		local spriteblock =3D cUOSpriteBlock:New()
 		mobile.gfx2d =3D spriteblock
-		local xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
-		local tx,ty,tz,fIndexRel =3D 0,0,0,0
-		local sorttx =3D 0 -- xloc-floor(xloc/8)*8
-		local sortty =3D 0 -- yloc-floor(yloc/8)*8
-		local sorttz =3D zloc
-		local iTileTypeID	=3D nil
-		local iHue			=3D BitwiseAND(mobile.hue,0x7fff) -- 0x03F4 : human skin hu=
e (0x83F4=3D33780, but 0x8* is partial hue and turned out all gray here)
-		local iModelID,iAnimID,iFrame =3D mobile.artid,0,0 -- 401,0
-		local pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame=
,iHue)
-		if (pAtlasPiece) then
-			local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(iTileTy=
peID,sorttx,sortty,sorttz,fIndexRel)+1,mobile,pAtlasPiece)
-			sprite.uoanim_ModelID	=3D iModelID
-			sprite.uoanim_AnimID	=3D iAnimID
-			sprite.uoanim_Frame		=3D iFrame
-			sprite.hue =3D iHue
-		else
-			print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,iA=
nimID,iFrame,iHue)
-		end
-		spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
 	end
+	self:UpdateMobileGfx(mobile)
+end =

+
+
+function Renderer2D:UpdateMobileGfx				(mobile) =

+	local spriteblock =3D mobile.gfx2d
+	if (not spriteblock) then return end
+	spriteblock:Clear()
+
+	local xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
+	local tx,ty,tz,fIndexRel =3D 0,0,0,0
+	local sorttx =3D xloc-floor(xloc/8)*8
+	local sortty =3D yloc-floor(yloc/8)*8
+	local sorttz =3D zloc
+	local iTileTypeID	=3D nil
+	local iHue			=3D BitwiseAND(mobile.hue,0x7fff) -- 0x03F4 : human skin hue=
 (0x83F4=3D33780, but 0x8* is partial hue and turned out all gray here)
+	local iModelID,iAnimID,iFrame =3D mobile.artid,20,0 -- 401,0
+	local pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,=
iHue)
+	if (pAtlasPiece) then
+		local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(iTileTyp=
eID,sorttx,sortty,sorttz,fIndexRel,4),mobile,pAtlasPiece)
+		sprite.uoanim_ModelID	=3D iModelID
+		sprite.uoanim_AnimID	=3D iAnimID
+		sprite.uoanim_Frame		=3D iFrame
+		sprite.hue =3D iHue
+	else
+		print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,iAn=
imID,iFrame,iHue)
+	end
+	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
 	=

 	local x,y,z =3D self:UOPosToLocal(mobile.xloc,mobile.yloc,mobile.zloc*kRe=
nderer2D_ZScale)
 	mobile.gfx2d:SetPosition(x,y,z)
-end =

+end
 =

 function Renderer2D:DestroyMobileGfx			(mobile) if (mobile.gfx2d) then mob=
ile.gfx2d:Destroy() mobile.gfx2d =3D nil end end
 =


Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Wed Oct  1 02:11:13 2008
@@ -14,7 +14,7 @@
 kRenderer2D_Inv44		=3D 1/44
 kRenderer2D_Sin45		=3D 0.5*kSq2 -- sin(45)
 kRenderer2D_ZScale		=3D 4 * kRenderer2D_Inv44 / kRenderer2D_Sin45 -- zloc=
=3D1 means 4 pixels 0.12856486930664
-kRenderer2D_XPixelScale	=3D kRenderer2D_Inv44 * 0.5 =

+kRenderer2D_XPixelScale	=3D kRenderer2D_Inv44 =

 kRenderer2D_YPixelScale	=3D kRenderer2D_Inv44 / kRenderer2D_Sin45
 =

 dofile(libpath .. "lib.2d.cam.lua")

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Wed Oct  1 02:11:13 2008
@@ -20,9 +20,12 @@
 	if (self.rootgfx) then self.rootgfx:SetPosition(x,y,z) end
 end
 =

-function cUOSpriteBlock:Destroy ()
+function cUOSpriteBlock:Destroy () self:Clear() end
+
+function cUOSpriteBlock:Clear ()
 	if (self.pGroupGfx) then for k,v in pairs(self.pGroupGfx) do v:Destroy() =
end self.pGroupGfx =3D {} end
 	if (self.rootgfx) then self.rootgfx:Destroy() self.rootgfx =3D nil end
+	self.pSpritesByAtlas =3D {}
 end
 =

 function TileOffsetToPixelOffset (tx,ty)
@@ -86,14 +89,15 @@
 	return founddist,foundsprite
 end
 =

-function CalcSortBonus (artid,tx,ty,zloc,fIndexRel)
+function CalcSortBonus (artid,tx,ty,zloc,fIndexRel,bonusadd)
+
 	--~ prio1 =3D zloc + iSortBonus2D				iSortBonus2D in {2,3,4,6} (+1 for dy=
namic)
 	--~ prio2 =3D miHeight						in [0,100]
 	--~ prio3 =3D (hue>0) and 1007 or 7
 	--~ prio4 =3D fIndexRel						in [0,1]
 	--~ prio5 =3D tx								in [0,7]
 	local pTileType =3D artid and GetStaticTileType(artid)
-	return		0.05*(	1.000 * (zloc + (pTileType and pTileType.iSortBonus2D or 0=
)) + -- zloc + =

+	return		0.05*(	1.000 * (zloc + (pTileType and pTileType.iSortBonus2D or 0=
) + (bonusadd or 0)) + -- zloc + =

 						1.000 * ((pTileType and pTileType.miHeight or 0)/100) +
 						0.005 * (fIndexRel) +
 						0.005 * (tx / 8) )
@@ -149,14 +153,32 @@
 	x =3D x +   -1 * sortadd - movedown  =

 	y =3D y +    1 * sortadd + movedown
 	z =3D z + kSq2 * sortadd
-	local xa =3D pw * kRenderer2D_XPixelScale
-	local za =3D ph * kRenderer2D_YPixelScale			=

+	local xa =3D 0.5 * pw * kRenderer2D_XPixelScale
+	local za =3D       ph * kRenderer2D_YPixelScale			=

 	=

 	-- TODO : mobs ?
 	-- local iCenterX =3D pAtlasPiece.iCenterX or half?
 	--~ local pix2coord =3D zoom * 1 / 44
 	--~ local x =3D -1 + ( iCenterY +iCenterX)*pix2coord -- iCenterX<0=3Drigh=
t iCenterY<0=3Ddown
 	--~ local y =3D  1 + (-iCenterY +iCenterX)*pix2coord
+	if (pAtlasPiece.iCenterX) then
+		print("2dmobcenter",pw,ph,pAtlasPiece.iCenterX,pAtlasPiece.iCenterY)
+		=

+		local xo =3D (-pw/2 + pAtlasPiece.iCenterX) * kRenderer2D_XPixelScale
+		local yo =3D (22    + pAtlasPiece.iCenterY) * kRenderer2D_YPixelScale
+		=

+		--~ 2dmobcenter     26      60      13      -4		human
+		--~ xo =3D -1 * kRenderer2D_XPixelScale	--	26/2=3D13 13	-> -1
+		--~ yo =3D 19 * kRenderer2D_YPixelScale   -- 	60/2=3D30 -4	-> 19
+		=

+		--~ 2dmobcenter     36      12      12      2		ratte
+		--~ xo =3D -7 * kRenderer2D_XPixelScale 	 	--	36/2=3D18 13	-> -7
+		--~ yo =3D 25 * kRenderer2D_YPixelScale    	-- 	12/2=3D 6 -4	-> 25   6
+
+		x =3D x + xo
+		y =3D y + xo
+		z =3D z + yo
+	end
 	=

 	local sprite =3D {
 		x =3D x,



From no-reply at zwischenwelt.org  Wed Oct  1 03:48:04 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 01 Oct 2008 01:48:04 -0000
Subject: [Iris-commit] [IRIS] r2484 - in /trunk/lua: lib.2d.mobile.lua
 lib.2d.spriteblock.lua lib.uoanim.lua
Message-ID: <20081001014804.BC8AA1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct  1 03:48:03 2008
New Revision: 2484

Log:
2d : a few hacks to display robes

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Wed Oct  1 03:48:03 2008
@@ -12,30 +12,101 @@
 end =

 =

 =

+
+function My2DMobileDebug (a)
+	local playermobile =3D GetPlayerMobile()
+	gMy2DMobileDebug =3D (gMy2DMobileDebug or 766) + a
+	playermobile.artid =3D gMy2DMobileDebug
+	print("My2DMobileDebug",gMy2DMobileDebug)
+	Renderer2D:UpdateMobile(playermobile)
+end
+
+function My2DMobileDebug2 (a)
+	gMy2DMobileDebugAnim =3D (gMy2DMobileDebugAnim or 0) + a
+	print("gMy2DMobileDebugAnim",gMy2DMobileDebugAnim)
+	Renderer2D:UpdateMobile(GetPlayerMobile())
+end
+
+--[[
+iModelID : 13 =3D evortex
+iModelID : 50 =3D skeleton
+iModelID : 51 =3D slime
+iModelID : 200 =3D horse
+iModelID : 204 =3D horse
+iModelID : 226 =3D horse
+iModelID : 228 =3D horse
+iModelID : 210 =3D ostard
+iModelID : 218 =3D ostard
+iModelID : 219 =3D ostard
+iModelID : 220 =3D lama
+
+iModelID : 409 =3D hat
+iModelID : 430 =3D shorts
+iModelID : 431 =3D trousers
+
+iModelID : 469 =3D finerobe
+iModelID : 574 =3D bladespirit
+iModelID : 970 =3D deathshroud
+iModelID : 987 =3D gmrobe
+iModelID : 991 =3D britain-mage-robe
+
+]]--
+
+function Renderer2D:GetMobileMountModelAndHue				(mobile) =

+	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
+	if (mount) then =

+		--~ print("GetMobileMountModelAndHue:mount",mount.artid,mount.hue)  -- 1=
6050 -- horse/mule
+		return 200,mount.hue =

+	end =

+end
+
+function Renderer2D:GetMobileModelEquipPartAndHue				(mobile,layer,overrid=
e) =

+	local part	=3D mobile:GetEquipmentAtLayer(kLayer_TorsoOuter)
+	if (part) then =

+		--~ print("GetMobileModelAndHue:robe",robe.artid,robe.hue) =

+		return override or part.artid,part.hue  -- 10114 -- tokuno robe
+	end
+end
+
 function Renderer2D:UpdateMobileGfx				(mobile) =

 	local spriteblock =3D mobile.gfx2d
 	if (not spriteblock) then return end
 	spriteblock:Clear()
 =

 	local xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
-	local tx,ty,tz,fIndexRel =3D 0,0,0,0
+	local tx,ty,tz,iIndex,fIndexRel =3D 0,0,0,0
 	local sorttx =3D xloc-floor(xloc/8)*8
 	local sortty =3D yloc-floor(yloc/8)*8
 	local sorttz =3D zloc
-	local iTileTypeID	=3D nil
-	local iHue			=3D BitwiseAND(mobile.hue,0x7fff) -- 0x03F4 : human skin hue=
 (0x83F4=3D33780, but 0x8* is partial hue and turned out all gray here)
-	local iModelID,iAnimID,iFrame =3D mobile.artid,20,0 -- 401,0
-	local pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,=
iHue)
-	if (pAtlasPiece) then
-		local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(iTileTyp=
eID,sorttx,sortty,sorttz,fIndexRel,4),mobile,pAtlasPiece)
-		sprite.uoanim_ModelID	=3D iModelID
-		sprite.uoanim_AnimID	=3D iAnimID
-		sprite.uoanim_Frame		=3D iFrame
-		sprite.hue =3D iHue
-	else
-		print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,iAn=
imID,iFrame,iHue)
+	local parts =3D {}
+	local iDirAdd =3D 1
+	=

+	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
+	table.insert(parts,{self:GetMobileMountModelAndHue(mobile)})
+	table.insert(parts,{mobile.artid,mobile.hue})
+	table.insert(parts,{self:GetMobileModelEquipPartAndHue(mobile,kLayer_Tors=
oOuter,469)})
+	=

+	for k,v in pairs(parts) do =

+		local iModelID,iHue =3D unpack(v)
+		if iModelID then
+			iIndex =3D iIndex + 1 =

+			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
+			iHue			=3D BitwiseAND(iHue,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
+			local iAnimID =3D gMy2DMobileDebugAnim or Anim_GetIdleAnim(iModelID,mou=
nt) + 1
+			local iFrame =3D ((gMy2DDebugFrame or 0) / 5) % 5
+			local pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFram=
e,iHue)
+			if (pAtlasPiece) then
+				local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(nil,so=
rttx,sortty,sorttz,fIndexRel,4),mobile,pAtlasPiece)
+				sprite.uoanim_ModelID	=3D iModelID
+				sprite.uoanim_AnimID	=3D iAnimID
+				sprite.uoanim_Frame		=3D iFrame
+				sprite.hue =3D iHue
+			else
+				print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,i=
AnimID,iFrame,iHue)
+			end
+		end
 	end
-	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
+	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,false)
 	=

 	local x,y,z =3D self:UOPosToLocal(mobile.xloc,mobile.yloc,mobile.zloc*kRe=
nderer2D_ZScale)
 	mobile.gfx2d:SetPosition(x,y,z)
@@ -51,6 +122,8 @@
 function Renderer2D:MobileStartServerSideAnim	(animdata) end
 =

 function Renderer2D:MobileTestStep()
+	--~ gMy2DDebugFrame =3D (gMy2DDebugFrame or 0) + 1
+	--~ Renderer2D:UpdateMobileGfx(GetPlayerMobile())
 	if true then return end
 	=

 	--~ local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =


Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Wed Oct  1 03:48:03 2008
@@ -90,7 +90,6 @@
 end
 =

 function CalcSortBonus (artid,tx,ty,zloc,fIndexRel,bonusadd)
-
 	--~ prio1 =3D zloc + iSortBonus2D				iSortBonus2D in {2,3,4,6} (+1 for dy=
namic)
 	--~ prio2 =3D miHeight						in [0,100]
 	--~ prio3 =3D (hue>0) and 1007 or 7
@@ -162,7 +161,7 @@
 	--~ local x =3D -1 + ( iCenterY +iCenterX)*pix2coord -- iCenterX<0=3Drigh=
t iCenterY<0=3Ddown
 	--~ local y =3D  1 + (-iCenterY +iCenterX)*pix2coord
 	if (pAtlasPiece.iCenterX) then
-		print("2dmobcenter",pw,ph,pAtlasPiece.iCenterX,pAtlasPiece.iCenterY)
+		--~ print("2dmobcenter",pw,ph,pAtlasPiece.iCenterX,pAtlasPiece.iCenterY)
 		=

 		local xo =3D (-pw/2 + pAtlasPiece.iCenterX) * kRenderer2D_XPixelScale
 		local yo =3D (22    + pAtlasPiece.iCenterY) * kRenderer2D_YPixelScale

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Wed Oct  1 03:48:03 2008
@@ -4,7 +4,6 @@
 -- TODO : http://svn.berlios.de/viewcvs/wolfpack/trunk/client/  =

 =

 gAnimAtlasCache =3D {}
-kAnimID_Human_Idle =3D 20 =

 kAnimIDRangeLen_HighDetailed	=3D 200  -- mHighDetailed
 kAnimIDRangeLen_LowDetailed		=3D 200  -- mLowDetailed
 =

@@ -69,8 +68,26 @@
 =

 =

 =

+function Anim_GetIdleAnim (iModelID,bHasMount)
+	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return 0 end -=
- 2+5*2=3Drat ?
+	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return 0 end -- 2+5*2=3Drat ?
+	return bHasMount and 125 or 20  -- Human
+	--~ return 20 -- Human
+end	=

+
+function Anim_GetModelCategory (iModelID)
+	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return 1 end
+	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return 2 end
+	return 3
+end
+function Anim_GetModelCategorySize (iModelCat)
+	if (iModelCat =3D=3D 1) then return 110 end
+	if (iModelCat =3D=3D 2) then return 65 end
+	return 175
+end
+
 -- iID is probably bodyid, and animid the animation ? ported from varans c=
ode
-function Anim_GetRealID (iModelID,iAnimID) =

+function Anim_GetRealID (iModelID,iAnimID)
 	if (iModelID < kAnimIDRangeLen_HighDetailed) then return iAnimID + iModel=
ID*110 end
 	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
) then
 		return iAnimID + kAnimIDRangeLen_HighDetailed*110 + (iModelID-kAnimIDRan=
geLen_HighDetailed)*65
@@ -178,7 +195,6 @@
 	=

 	=

 ]]--
-
 =

 --[[
 -- iAnimID : 0-4=3Dwalk down,down-left,left,up-left,up
@@ -204,13 +220,13 @@
 -- iAnimID : 100- gethit/flinch/pain
 -- iAnimID : 105- die backwards
 -- iAnimID : 110- die forwards
--- iAnimID : 115- mount-walk-horse
--- iAnimID : 120- mount-walk-ostard
--- iAnimID : 125- mount-idle-ostard
--- iAnimID : 130- mount-attack-swing?-ostard
--- iAnimID : 135- mount-attack-bow-ostard
--- iAnimID : 140- mount-attack-crossbow-ostard
--- iAnimID : 145- mount-attack-bash?-ostard
+-- iAnimID : 115- mount-wal
+-- iAnimID : 120- mount-run
+-- iAnimID : 125- mount-idle
+-- iAnimID : 130- mount-attack-swing?
+-- iAnimID : 135- mount-attack-bow
+-- iAnimID : 140- mount-attack-crossbow
+-- iAnimID : 145- mount-attack-bash?
 -- iAnimID : 150- attack-stab?
 -- iAnimID : 155- attack-punch?
 -- iAnimID : 160- bow



From no-reply at zwischenwelt.org  Wed Oct  1 04:20:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 01 Oct 2008 02:20:19 -0000
Subject: [Iris-commit] [IRIS] r2485 - in /trunk/lua: lib.2d.mobile.lua
 lib.2d.spriteblock.lua net.walk.lua
Message-ID: <20081001022019.9F6E21524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct  1 04:20:17 2008
New Revision: 2485

Log:
spriteblock : xmirror option added. mobile : graphic turns to direction of =
mobile

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/net.walk.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Wed Oct  1 04:20:17 2008
@@ -79,7 +79,17 @@
 	local sortty =3D yloc-floor(yloc/8)*8
 	local sorttz =3D zloc
 	local parts =3D {}
-	local iDirAdd =3D 1
+	local iMobileDir =3D DirWrap(mobile.dir)
+	local iDirAdd,bMirrorX =3D 0,false
+	print()
+	if (iMobileDir =3D=3D 3) then iDirAdd =3D 0 end
+	if (iMobileDir =3D=3D 4) then iDirAdd =3D 1 end
+	if (iMobileDir =3D=3D 5) then iDirAdd =3D 2 end
+	if (iMobileDir =3D=3D 6) then iDirAdd =3D 3 end
+	if (iMobileDir =3D=3D 7) then iDirAdd =3D 4 end
+	if (iMobileDir =3D=3D 0) then iDirAdd =3D 3 bMirrorX =3D true end
+	if (iMobileDir =3D=3D 1) then iDirAdd =3D 2 bMirrorX =3D true end
+	if (iMobileDir =3D=3D 2) then iDirAdd =3D 1 bMirrorX =3D true end
 	=

 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
 	table.insert(parts,{self:GetMobileMountModelAndHue(mobile)})
@@ -92,17 +102,21 @@
 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
 			iHue			=3D BitwiseAND(iHue,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
-			local iAnimID =3D gMy2DMobileDebugAnim or Anim_GetIdleAnim(iModelID,mou=
nt) + 1
+			local iAnimID =3D gMy2DMobileDebugAnim or Anim_GetIdleAnim(iModelID,mou=
nt) + iDirAdd
 			local iFrame =3D ((gMy2DDebugFrame or 0) / 5) % 5
-			local pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFram=
e,iHue)
+			local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFram=
e,iHue)
+			if (not pAtlasPiece) then
+				print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,i=
AnimID,iFrame,iHue)
+				iModelID,iAnimID,iFrame =3D 13,0,0 -- replace unknown by standard mode=
l (13=3Devortex)
+				pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,iHu=
e)
+			end
 			if (pAtlasPiece) then
 				local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(nil,so=
rttx,sortty,sorttz,fIndexRel,4),mobile,pAtlasPiece)
+				sprite.bMirrorX =3D bMirrorX
 				sprite.uoanim_ModelID	=3D iModelID
 				sprite.uoanim_AnimID	=3D iAnimID
 				sprite.uoanim_Frame		=3D iFrame
 				sprite.hue =3D iHue
-			else
-				print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,i=
AnimID,iFrame,iHue)
 			end
 		end
 	end
@@ -122,6 +136,8 @@
 function Renderer2D:MobileStartServerSideAnim	(animdata) end
 =

 function Renderer2D:MobileTestStep()
+	--~ local playermobile =3D GetPlayerMobile()
+	--~ print("playermobile.dir",playermobile and DirWrap(playermobile.dir)) =

 	--~ gMy2DDebugFrame =3D (gMy2DDebugFrame or 0) + 1
 	--~ Renderer2D:UpdateMobileGfx(GetPlayerMobile())
 	if true then return end

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Wed Oct  1 04:20:17 2008
@@ -244,6 +244,7 @@
 				local v0 		=3D sprite.v0
 				local u1 		=3D sprite.u1
 				local v1 		=3D sprite.v1
+				if (sprite.bMirrorX) then u0,u1 =3D u1,u0 end
 				gfx:RenderableVertex(x-xa,y-xa,z  	, u1,v1)
 				gfx:RenderableVertex(x+xa,y+xa,z  	, u0,v1)
 				gfx:RenderableVertex(x-xa,y-xa,z+za	, u1,v0)

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Wed Oct  1 04:20:17 2008
@@ -128,7 +128,6 @@
 -- clientside collision check, returns true if passable
 function WalkStep_CanWalkInDir	(iDir) =

 	iDir =3D DirWrap(iDir)
-	if (iDir ~=3D gPlayerDir) then return true end
 	return GetNearestGroundLevel(gPlayerXLoc,gPlayerYLoc,gPlayerZLoc,iDir) ~=
=3D nil
 end
 =




From no-reply at zwischenwelt.org  Wed Oct  1 13:00:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 01 Oct 2008 11:00:59 -0000
Subject: [Iris-commit] [IRIS] r2486 - in /trunk/lua: config_declarations.lua
 lib.bodygfx.lua lib.buff.lua lib.bugreport.lua lib.keybinds.lua
 lib.loading.lua lib.macrolist.lua lib.tilefreewalk.lua net.walk.lua
 obj/obj.mobile.lua
Message-ID: <20081001110059.D29091C1867C@zwischenwelt.org>

Author: hagish
Date: Wed Oct  1 13:00:55 2008
New Revision: 2486

Log:
*arg -> ... changes
*removed debug output
*new macro functions: MacroRead_SkillValue MacroRead_BuffActive

Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/lib.bodygfx.lua
    trunk/lua/lib.buff.lua
    trunk/lua/lib.bugreport.lua
    trunk/lua/lib.keybinds.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.tilefreewalk.lua
    trunk/lua/net.walk.lua
    trunk/lua/obj/obj.mobile.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Wed Oct  1 13:00:55 2008
@@ -490,8 +490,6 @@
 		--~ print("ForAllNames",n,v)
 	end)
 =

-print("shadow",gShadowTechnique,gStaticsCastShadows)
-
 -- register listener to keep the global scope up to date
 gConfig:RegisterListener(function(n,v)
 		_G[n] =3D v

Modified: trunk/lua/lib.bodygfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bodygfx.lua (original)
+++ trunk/lua/lib.bodygfx.lua Wed Oct  1 13:00:55 2008
@@ -15,7 +15,7 @@
 function CreateBodyGfx (...)
 	local res =3D {}
 	ArrayOverwrite(res,gBodyGfxPrototype)
-	res:Init(unpack(arg))
+	res:Init(...)
 	return res
 end
 =


Modified: trunk/lua/lib.buff.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.buff.lua (original)
+++ trunk/lua/lib.buff.lua Wed Oct  1 13:00:55 2008
@@ -75,7 +75,6 @@
 gBuffs =3D {}
 =

 function SetBuffActive (buffid,bIsActive) =

-	print("SetBuffActive",buffid,bIsActive)
 	gBuffs[buffid] =3D bIsActive
 end
 =


Modified: trunk/lua/lib.bugreport.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.bugreport.lua (original)
+++ trunk/lua/lib.bugreport.lua Wed Oct  1 13:00:55 2008
@@ -43,7 +43,7 @@
 	if (gBugReportIgnoreErrors) then return end
 	gBugReportIgnoreErrors =3D true -- don't call again
 	=

-	local report =3D arrdump(arg)
+	local report =3D arrdump({...})
 	=

 	=

 	-- write to file

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Wed Oct  1 13:00:55 2008
@@ -85,7 +85,7 @@
 	=

 	-------------------------------------------------------------------------=
----------
 =

-	if (true) then
+	if (false) then
 		Bind("f7",		function (state) if (not gActiveEditText) then if (state > 0=
) then
 			if (gAmbientLight.r < 1.0) then
 				gAmbientLight.r=3DgAmbientLight.r+0.1
@@ -122,24 +122,25 @@
 			end
 		 end end end)
 	=

-		--~ Bind("f2",		function (state) if (not gActiveEditText) then if (state=
 > 0) then
-			--~ local mobile =3D GetPlayerMobile()
-			--~ if mobile then
-				--~ local effect =3D {}
-				--~ effect.current_locx =3D mobile.xloc
-				--~ effect.current_locy =3D mobile.yloc
-				--~ effect.current_locz =3D mobile.zloc
-		--~ =

-				--~ effect.target_locx =3D mobile.xloc + 10
-				--~ effect.target_locy =3D mobile.yloc + 1
-				--~ effect.target_locz =3D mobile.zloc + 2
-					--~ =

-				--~ effect.speed =3D 5
-				--~ effect.duration =3D 5
-					--~ =

-				--~ effect.itemid =3D 119--hex2num("0x376A")
-				--~ gCurrentRenderer:AddEffect(effect)
-			--~ end
-		--~ end end end)
+		Bind("f2",		function (state) if (not gActiveEditText) then if (state > 0=
) then
+			local x,y,z =3D MacroRead_GetPlayerPosition()
+			local effect =3D {}
+			effect.current_locx =3D x
+			effect.current_locy =3D y
+			effect.current_locz =3D z
+	=

+			effect.target_locx =3D x + 10
+			effect.target_locy =3D y + 1
+			effect.target_locz =3D z + 2
+				=

+			effect.speed =3D 5
+			effect.duration =3D 5
+			=

+			effect.effect_type =3D kEffectType_FromSourceToDest
+				=

+			effect.itemid =3D MagicArrow
+
+			gCurrentRenderer:AddEffect(effect)
+		end end end)
 	end
 end

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Wed Oct  1 13:00:55 2008
@@ -152,7 +152,7 @@
 		if (gDebugTileTypeLoaderGetStaticTileType) then -- slowdown : only done =
when activated explicitly via config
 			gTileTypeLoader._GetStaticTileType =3D gTileTypeLoader.GetStaticTileType
 			gTileTypeLoader.GetStaticTileType =3D function (...)
-				local arr =3D { gTileTypeLoader._GetStaticTileType(unpack(arg)) }
+				local arr =3D { gTileTypeLoader._GetStaticTileType(...) }
 				if (not arr[1]) then =

 					print("GetStaticTileType failed", arg[2],_TRACEBACK())
 				end

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Wed Oct  1 13:00:55 2008
@@ -34,6 +34,24 @@
 -- GetPlayerMobile
 function MacroRead_PlayerStat			(statname) return MacroReadAux_MobileStat(=
GetPlayerMobile(),statname,"MacroRead_PlayerStat") end
 function MacroRead_TargetStat			(statname) return MacroReadAux_MobileStat(=
GetMobile(giSelectedMobile),statname,"MacroRead_TargetStat") end
+
+function MacroRead_SkillValue			(skillname)
+	for skillid,name in pairs(glSkillNames) do
+		if skillname =3D=3D name then
+			return gPlayerSkills[skillid].value * 0.1 or 0
+		end
+	end
+	return 0
+end
+
+function MacroRead_BuffActive			(buffname)
+	for id,v in pairs(gBuffIcons) do
+		if buffname =3D=3D v.name then
+			return gBuffs[id] or false
+		end
+	end
+	return false
+end
 =

 function MacroCmd_Say					(text)	if (gInGameStarted) then SendChat(text) e=
nd end
 function MacroCmd_NextCamMode			()		gCurrentRenderer:ChangeCamMode() end
@@ -430,8 +448,8 @@
 =

 =

 =

-function MacroGoto(x,y)
-	SetAutoWalkTo(x,y)
+function MacroGoto(x,y,slow)
+	SetAutoWalkTo(x,y,slow)
 	while gWalkPathToGo do
 		job.wait(500)
 	end

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Wed Oct  1 13:00:55 2008
@@ -193,7 +193,7 @@
 				fRequestedSpeed =3D  self:GetClientSideSpeed(self.movedirx,self.movedi=
ry,0)
 				local maxspeed =3D fRequestedSpeed * gSecondsSinceLastFrame
 				if (bSlowWalk) then maxspeed =3D maxspeed * 0.5 end -- TODO : bSlowWal=
k-speed
-				bRunRequested =3D not bSlowWalk
+				bRunRequested =3D not (bSlowWalk or gWalkPathToGoSlow)
 				bMoved =3D true
 				=

 				maxspeed =3D math.min(maxspeed, len)
@@ -550,7 +550,7 @@
 	return true -- TODO : check if fastwalkstack non empty
 end
 =

-function WalkLog2 (...) if (gKeyPressed[key_f]) then print("walklog2",unpa=
ck(arg)) end end
+function WalkLog2 (...) if (gKeyPressed[key_f]) then print("walklog2",...)=
 end end
 =

 function gTileFreeWalk:Impl_WalkRequestStep (bRunRequested)
 	if gTileFreeWalkDiagonalOptimization then
@@ -880,6 +880,8 @@
 	mymarker.gfx_dir:SetPosition(x+dx,y+dy,z+dz)
 end
 =

-function SetAutoWalkTo (x, y)
+function SetAutoWalkTo (x, y, slow)
+	slow =3D slow or false
 	gWalkPathToGo =3D {{x=3Dx,y=3Dy,z=3D0}}
-end
+	gWalkPathToGoSlow =3D slow
+end

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Wed Oct  1 13:00:55 2008
@@ -63,8 +63,8 @@
 	if (not gEnableWalkLog) then return end
 	local tdiff =3D gLastLogTime and (gMyTicks-gLastLogTime) or 0
 	local prefix =3D sprintf("WalkLog t=3D%5d k=3D%2d r=3D%2d",tdiff,FastWalk=
_CountKeys(),countarr(gWalkRequests))
-	print(prefix,unpack(arg)) =

-	--~ GuiAddChatLine(prefix..arrdump(arg))
+	print(prefix,...) =

+	--~ GuiAddChatLine(prefix..arrdump({...}))
 	gLastLogTime =3D gMyTicks
 end
 =

@@ -252,6 +252,7 @@
 	WalkLog("ResetWalkQueue start")
 	gNextWalkSequenceNumber =3D 0
 	gWalkRequests =3D {}
+	gWalkPathToGo =3D nil
 	WalkLog("ResetWalkQueue end")
 end
 =


Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Wed Oct  1 13:00:55 2008
@@ -54,7 +54,7 @@
 			local mymethod_impl =3D method_impl
 			_G["Mobile_"..method_name] =3D function (mobile_or_serial,...)
 				local mobile =3D GetMobile(mobile_or_serial)
-				if (mobile) then return mymethod_impl(mobile,unpack(arg)) end
+				if (mobile) then return mymethod_impl(mobile,...) end
 			end
 		end
 	end



From no-reply at zwischenwelt.org  Wed Oct  1 18:26:05 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 01 Oct 2008 16:26:05 -0000
Subject: [Iris-commit] [IRIS] r2487 - in /trunk/lua: lib.2d.mobile.lua
 lib.loading.lua lib.uoanim.lua
Message-ID: <20081001170014.CE28F1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct  1 18:26:04 2008
New Revision: 2487

Log:
2danim : lots of notes regarding SE animations, split animloader to array t=
o support anim2.mul-anim5.mul, preparing to add parsers for Bodyconv.def,Bo=
dy.def

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Wed Oct  1 18:26:04 2008
@@ -50,6 +50,44 @@
 iModelID : 987 =3D gmrobe
 iModelID : 991 =3D britain-mage-robe
 =

+crane 0xcc=3D204 in anim4
+warning, Renderer2D:UpdateMobile load uoanim failed     254     0       0 =
      0
+GetStaticTileType(10084)        {miUnknown3=3D0,miHue=3D0,miQuality=3D0,mi=
AnimID=3D0,bBackGround=3Dfalse,iSortBonus2D=3D6,iCalcHeight=3D0,miFlags=3D1=
6384=3D0x4000,miWeight=3D0,miQuantity=3D0,msName=3D"crane",bSurface=3Dfalse=
,miUnknown=3D0,miHeight=3D0,miUnknown1=3D0,bBridge=3Dfalse,miUnknown2=3D0,}
+		10084 =3D 0x2764  =

+		10084-254=3D9830
+
+
+iModelID : 13 =3D evortex  in anim1
+warning, Renderer2D:UpdateMobile load uoanim failed     164     3       0 =
      0
+>1      164     0       0
+>2      {miFlags=3D16464=3D0x4050,miWeight=3D-1,miQuantity=3D0,msName=3D"l=
og wall",  }
+>3      {miFlags=3D0x10002040,miWeight=3D-1,miQuantity=3D0,msName=3D"bark =
roofing",}  GetStaticTileType(mobile.artid+9830)
+
+
+deathwatch beetle =3D 3 in anim4:
+warning, Renderer2D:UpdateMobile load uoanim failed     242     3       0 =
      0       242
+
+runebeetle =3D 4 in anim4
+warning, Renderer2D:UpdateMobile load uoanim failed     244     3       0 =
      0       244
+gargoyle:artid=3D4
+
+Bodyconv.def =

+# <Object> <LBR version (anim2)> <AoS version (anim3)> <AoW version (anim4=
)><Mondain version (anim5)>		=

+242	-1	-1	3	-1 			deathwatch beetle
+244	-1	-1	4	-1			runebeetle
+
+Body.def =

+# <ORIG BODY> {<NEW BODY>} <NEW HUE>
+warning, Renderer2D:UpdateMobile load uoanim failed     164     3       0 =
      0       164       energy vortex
+164 {13} 20     energy vortex
+
+
+Body.def =

+warning, Renderer2D:UpdateMobile load uoanim failed     776     21      0 =
      0       776
+776 {39} 2120          -- 39:mongbat gfx
+776	44	-1	-1	-1	 	horde minion in anim2
+
+142 {42, 44, 45} 32875      anim2:44=3Dhorde-minion  anim1:42=3Dratman
 ]]--
 =

 function Renderer2D:GetMobileMountModelAndHue				(mobile) =

@@ -81,7 +119,6 @@
 	local parts =3D {}
 	local iMobileDir =3D DirWrap(mobile.dir)
 	local iDirAdd,bMirrorX =3D 0,false
-	print()
 	if (iMobileDir =3D=3D 3) then iDirAdd =3D 0 end
 	if (iMobileDir =3D=3D 4) then iDirAdd =3D 1 end
 	if (iMobileDir =3D=3D 5) then iDirAdd =3D 2 end
@@ -106,7 +143,12 @@
 			local iFrame =3D ((gMy2DDebugFrame or 0) / 5) % 5
 			local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFram=
e,iHue)
 			if (not pAtlasPiece) then
-				print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,i=
AnimID,iFrame,iHue)
+				print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,i=
AnimID,iFrame,iHue,mobile.artid)
+				--~ print(">1",mobile.artid,mobile.flag,mobile.hue)
+				--~ print(">2",SmartDump(GetStaticTileType(mobile.artid)))
+				--~ print(">3",SmartDump(GetStaticTileType(mobile.artid+9830)))
+				--~ local info =3D GetAnimDataInfo(iModelID)
+				--~ print("GetAnimDataInfo()",SmartDump(info))
 				iModelID,iAnimID,iFrame =3D 13,0,0 -- replace unknown by standard mode=
l (13=3Devortex)
 				pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,iHu=
e)
 			end

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Wed Oct  1 18:26:04 2008
@@ -187,7 +187,13 @@
 function Load_Anim () =

 	if (gAnimLoaderType) then
 		LoadingProfile("init AnimLoader")
-		gAnimLoader =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath( Ad=
dfilepath(gAnimidxFile) ),CorrectPath( Addfilepath(gAnimFile) ))		=

+		gAnimLoader =3D {}
+		-- old : gAnimFile,gAnimidxFile =

+		gAnimLoader[1] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim.idx") ),CorrectPath( Addfilepath("anim.mul") ))		=

+		gAnimLoader[2] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim2.idx") ),CorrectPath( Addfilepath("anim2.mul") ))		=

+		gAnimLoader[3] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim3.idx") ),CorrectPath( Addfilepath("anim3.mul") ))		=

+		gAnimLoader[4] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim4.idx") ),CorrectPath( Addfilepath("anim4.mul") ))		=

+		gAnimLoader[5] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim5.idx") ),CorrectPath( Addfilepath("anim5.mul") ))		=

 	end
 	if (gAnimDataLoaderType) then
 		LoadingProfile("init AnimDataLoader")

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Wed Oct  1 18:26:04 2008
@@ -1,5 +1,30 @@
 -- 2d char anim graphics
 -- loads the 2d anim-art, not specific to 2d renderer, might also be used =
in 3d mode for fallbacks
+
+--[[
+http://www.runuo.com/forums/server-support-windows/55184-custom-artwork-ho=
w.html
+http://varan.uodev.de/ Mulpatcher.zip
+http://www.runuo.com/forums/server-support-windows/64140-animinfo-mul-corr=
upt-muopatch.html
+
+gAnimLoader   mHighDetailed   mLowDetailed  : 200,200,
+
+2.0K animinfo.mul	apparently unused, only filled with 		04 02  bytes
+1.1M animdata.mul	gAnimdataFile		gAnimDataLoader	 GetAnimDataInfo():	int8 =
miFrames[64],miUnknown,miCount,miFrameInterval,miFrameStart;
+1.8M anim.idx		gAnimidxFile		gAnimLoader
+186M anim.mul		gAnimFile			gAnimLoader
+264K anim2.idx
+132M anim2.mul
+1.5M anim3.idx
+ 25M anim3.mul
+993K anim4.idx
+ 58M anim4.mul
+930K anim5.idx
+ 42M anim5.mul
+ =

+ =

+     iCurrentId =3D (iBaseId + GetAnimDataInfo(iBaseId).miFrames[ iCurrent=
Frame ])
+]]--
+
 =

 -- TODO : http://svn.berlios.de/viewcvs/wolfpack/trunk/client/  =

 =

@@ -106,21 +131,28 @@
 end
 =

 --- returns pImage,iWidth,iHeight,iCenterX,iCenterY,iFrames
-function ExportAnimFrameToImage (iRealID,iFrame,iHue)
+function ExportAnimFrameToImage (iRealID,iFrame,iHue,iLoaderIndex)
 	local pImage =3D CreateImage()
-	local bSuccess,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D gAnimLoader:E=
xportToImage(pImage,iRealID,iFrame,gHueLoader,iHue)
+	local bSuccess,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D gAnimLoader[i=
LoaderIndex or 1]:ExportToImage(pImage,iRealID,iFrame,gHueLoader,iHue)
 	if (not bSuccess) then pImage:Destroy() return end
 	return pImage,iWidth,iHeight,iCenterX,iCenterY,iFrames
 end
 =

 gAnimFrameBitMaskCache =3D {}
-function GetAnimFrameBitMask (iRealID,iFrame)
-	local n =3D iRealID..","..iFrame
+function GetAnimFrameBitMask (iRealID,iFrame,iLoaderIndex)
+	iLoaderIndex =3D iLoaderIndex or 1
+	local n =3D iRealID..","..iFrame..","..iLoaderIndex
 	local o =3D gAnimFrameBitMaskCache[n]
 	if (o ~=3D nil) then return o end
-	o =3D gAnimLoader:CreateBitMask(iRealID,iFrame)
+	o =3D gAnimLoader[iLoaderIndex]:CreateBitMask(iRealID,iFrame)
 	gAnimFrameBitMaskCache[n] =3D o
 	return o
+end
+
+-- returns iNewModelID,iLoaderIndex
+function UOAnimTranslateBodyID (iOrigModelID)
+	-- TODO : Bodyconv.def,Body.def =

+	return iOrigModelID,1
 end
 =

 function UOAnimCheckBitMask (iModelID,iAnimID,iFrame,px,py)
@@ -136,27 +168,6 @@
 TODO : rewrite  cAnim::Decode  :  to not use 2^n width	 and to extract mor=
e than one frame ?
 	Decode(short* &pBuffer, const int iFrame, _T& filter, short* ColorTable,b=
ool bTexSize=3Dtrue)  -- use bTexSize=3Dfalse here
 =

-gAnimLoader   mHighDetailed   mLowDetailed  : 200,200,
-gAnimDataLoader
-
-config.lua.dist
-	gAnimLoader		gAnimidxFile	=3D "anim.idx"
-					gAnimFile		=3D "anim.mul"
-	gAnimDataLoader	gAnimdataFile	=3D "animdata.mul"
-	=

-
-264K anim2.idx
-132M anim2.mul
-1.5M anim3.idx
- 25M anim3.mul
-993K anim4.idx
- 58M anim4.mul
-930K anim5.idx
- 42M anim5.mul
-1.1M animdata.mul
-1.8M anim.idx
-2.0K animinfo.mul
-186M anim.mul
 =

 	=

 =

@@ -194,6 +205,23 @@
 	}  STRUCT_PACKED;
 	=

 	=

+	if (false and (not gMobileBla)) then
+		gMobileBla =3D true
+		for i =3D 0,0x40000 do
+			local iModelID =3D i
+			local iAnimID =3D 2
+			local iFrame =3D 0
+			local iHue =3D 0
+			local iRealID =3D Anim_GetRealID(iModelID,iAnimID)
+			local img,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrameT=
oImage(iRealID,iFrame,iHue)
+			if (img) then
+				print("exportanim",iModelID)
+				--~ img:SaveAsFile(sprintf("../anim5/0x%04x_%d.png",iModelID,iModelID))
+				img:Destroy()
+			end
+		end	=

+		os.exit(0)
+	end
 ]]--
 =

 --[[



From no-reply at zwischenwelt.org  Wed Oct  1 22:01:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 01 Oct 2008 20:01:55 -0000
Subject: [Iris-commit] [IRIS] r2488 - in /trunk/lua: lib.2d.mobile.lua
 lib.2d.spriteblock.lua lib.loading.lua lib.uoanim.lua
Message-ID: <20081001200157.A1FB11C18042@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct  1 22:01:49 2008
New Revision: 2488

Log:
2d : loader for Body.def and Bodyconv.def, also used by mobile gfx now : sa=
murai empire equip and creatures are drawn correctly. fixed positioning for=
 x-mirrored mobile-parts

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Wed Oct  1 22:01:49 2008
@@ -1,5 +1,5 @@
 -- mobiles (animals,players,monsters,npcs..)
--- TODO : bMirrorX !
+-- TODO : Equipconv.def ?
 =

 -- main updater, create, position ...
 function Renderer2D:UpdateMobile				(mobile) =

@@ -27,68 +27,6 @@
 	Renderer2D:UpdateMobile(GetPlayerMobile())
 end
 =

---[[
-iModelID : 13 =3D evortex
-iModelID : 50 =3D skeleton
-iModelID : 51 =3D slime
-iModelID : 200 =3D horse
-iModelID : 204 =3D horse
-iModelID : 226 =3D horse
-iModelID : 228 =3D horse
-iModelID : 210 =3D ostard
-iModelID : 218 =3D ostard
-iModelID : 219 =3D ostard
-iModelID : 220 =3D lama
-
-iModelID : 409 =3D hat
-iModelID : 430 =3D shorts
-iModelID : 431 =3D trousers
-
-iModelID : 469 =3D finerobe
-iModelID : 574 =3D bladespirit
-iModelID : 970 =3D deathshroud
-iModelID : 987 =3D gmrobe
-iModelID : 991 =3D britain-mage-robe
-
-crane 0xcc=3D204 in anim4
-warning, Renderer2D:UpdateMobile load uoanim failed     254     0       0 =
      0
-GetStaticTileType(10084)        {miUnknown3=3D0,miHue=3D0,miQuality=3D0,mi=
AnimID=3D0,bBackGround=3Dfalse,iSortBonus2D=3D6,iCalcHeight=3D0,miFlags=3D1=
6384=3D0x4000,miWeight=3D0,miQuantity=3D0,msName=3D"crane",bSurface=3Dfalse=
,miUnknown=3D0,miHeight=3D0,miUnknown1=3D0,bBridge=3Dfalse,miUnknown2=3D0,}
-		10084 =3D 0x2764  =

-		10084-254=3D9830
-
-
-iModelID : 13 =3D evortex  in anim1
-warning, Renderer2D:UpdateMobile load uoanim failed     164     3       0 =
      0
->1      164     0       0
->2      {miFlags=3D16464=3D0x4050,miWeight=3D-1,miQuantity=3D0,msName=3D"l=
og wall",  }
->3      {miFlags=3D0x10002040,miWeight=3D-1,miQuantity=3D0,msName=3D"bark =
roofing",}  GetStaticTileType(mobile.artid+9830)
-
-
-deathwatch beetle =3D 3 in anim4:
-warning, Renderer2D:UpdateMobile load uoanim failed     242     3       0 =
      0       242
-
-runebeetle =3D 4 in anim4
-warning, Renderer2D:UpdateMobile load uoanim failed     244     3       0 =
      0       244
-gargoyle:artid=3D4
-
-Bodyconv.def =

-# <Object> <LBR version (anim2)> <AoS version (anim3)> <AoW version (anim4=
)><Mondain version (anim5)>		=

-242	-1	-1	3	-1 			deathwatch beetle
-244	-1	-1	4	-1			runebeetle
-
-Body.def =

-# <ORIG BODY> {<NEW BODY>} <NEW HUE>
-warning, Renderer2D:UpdateMobile load uoanim failed     164     3       0 =
      0       164       energy vortex
-164 {13} 20     energy vortex
-
-
-Body.def =

-warning, Renderer2D:UpdateMobile load uoanim failed     776     21      0 =
      0       776
-776 {39} 2120          -- 39:mongbat gfx
-776	44	-1	-1	-1	 	horde minion in anim2
-
-142 {42, 44, 45} 32875      anim2:44=3Dhorde-minion  anim1:42=3Dratman
-]]--
 =

 function Renderer2D:GetMobileMountModelAndHue				(mobile) =

 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
@@ -130,34 +68,52 @@
 	=

 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
 	table.insert(parts,{self:GetMobileMountModelAndHue(mobile)})
-	table.insert(parts,{mobile.artid,mobile.hue})
-	table.insert(parts,{self:GetMobileModelEquipPartAndHue(mobile,kLayer_Tors=
oOuter,469)})
+	table.insert(parts,{mobile.artid,mobile.hue,13}) -- fallback=3D13=3Devort=
ex
+	if (mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) then -- only huma=
ns have equip
+		for index,layer in pairs(gLayerOrder) do =

+			local item =3D GetMobileEquipmentItem(mobile,layer)
+			if (item) then =

+				local t =3D GetStaticTileType(item.artid)
+				local iFallBack
+				if (layer =3D=3D kLayer_TorsoOuter) then iFallBack =3D 469 end -- stan=
dard robe
+				if (t and t.miAnimID and t.miAnimID > 0) then table.insert(parts,{t.mi=
AnimID,item.hue,iFallBack}) end
+			end
+		end
+		=

+		--~ table.insert(parts,{self:GetMobileModelEquipPartAndHue(mobile,kLayer=
_TorsoOuter,469)})
+	end
 	=

 	for k,v in pairs(parts) do =

-		local iModelID,iHue =3D unpack(v)
+		local iModelID,iHue,iFallBack =3D unpack(v)
 		if iModelID then
+			local iLoaderIndex =3D 1
+			iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
+		=

 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
 			iHue			=3D BitwiseAND(iHue,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
 			local iAnimID =3D gMy2DMobileDebugAnim or Anim_GetIdleAnim(iModelID,mou=
nt) + iDirAdd
 			local iFrame =3D ((gMy2DDebugFrame or 0) / 5) % 5
-			local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFram=
e,iHue)
+			local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFram=
e,iHue,iLoaderIndex)
 			if (not pAtlasPiece) then
-				print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,i=
AnimID,iFrame,iHue,mobile.artid)
 				--~ print(">1",mobile.artid,mobile.flag,mobile.hue)
 				--~ print(">2",SmartDump(GetStaticTileType(mobile.artid)))
 				--~ print(">3",SmartDump(GetStaticTileType(mobile.artid+9830)))
 				--~ local info =3D GetAnimDataInfo(iModelID)
 				--~ print("GetAnimDataInfo()",SmartDump(info))
-				iModelID,iAnimID,iFrame =3D 13,0,0 -- replace unknown by standard mode=
l (13=3Devortex)
-				pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,iHu=
e)
+				if (iFallBack) then
+					print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,=
iAnimID,iFrame,iHue,mobile.artid)
+					iModelID =3D iFallBack -- replace unknown by standard model (13=3Devo=
rtex)
+					pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,iH=
ue,iLoaderIndex)
+				end
 			end
 			if (pAtlasPiece) then
-				local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(nil,so=
rttx,sortty,sorttz,fIndexRel,4),mobile,pAtlasPiece)
+				local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(nil,so=
rttx,sortty,sorttz,fIndexRel,4),mobile,pAtlasPiece,bMirrorX)
 				sprite.bMirrorX =3D bMirrorX
-				sprite.uoanim_ModelID	=3D iModelID
-				sprite.uoanim_AnimID	=3D iAnimID
-				sprite.uoanim_Frame		=3D iFrame
+				sprite.uoanim_ModelID		=3D iModelID
+				sprite.uoanim_AnimID		=3D iAnimID
+				sprite.uoanim_Frame			=3D iFrame
+				sprite.uoanim_LoaderIndex	=3D iLoaderIndex
 				sprite.hue =3D iHue
 			end
 		end

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Wed Oct  1 22:01:49 2008
@@ -78,7 +78,7 @@
 				--~ print("cUOSpriteBlock:RayPick hit",sprite.artid,sprite.uoanim_Mode=
lID,px,py)
 				if (
 					(sprite.artid and ArtCheckBitMask(sprite.artid+0x4000,px,py)) or
-					(sprite.uoanim_ModelID and UOAnimCheckBitMask(sprite.uoanim_ModelID,s=
prite.uoanim_AnimID,sprite.uoanim_Frame,px,py)) =

+					(sprite.uoanim_ModelID and UOAnimCheckBitMask(sprite.uoanim_ModelID,s=
prite.uoanim_AnimID,sprite.uoanim_Frame,sprite.uoanim_LoaderIndex,px,py)) =

 					) then
 						founddist =3D dist
 						foundsprite =3D sprite
@@ -139,7 +139,7 @@
 end
 	=

 -- pAtlasPiece=3D{atlas=3D?,origw=3D?,origh=3D?,u0=3D?,v0=3D?,u1=3D?,v1=3D=
?}
-function cUOSpriteBlock:AddSpriteEx (tx,ty,zloc,sortbonus,data,pAtlasPiece)
+function cUOSpriteBlock:AddSpriteEx (tx,ty,zloc,sortbonus,data,pAtlasPiece=
,bMirrorX)
 	local atlas =3D pAtlasPiece.atlas
 	local group =3D self.pSpritesByAtlas[atlas]
 	if (not group) then group =3D {} self.pSpritesByAtlas[atlas] =3D group end
@@ -163,7 +163,12 @@
 	if (pAtlasPiece.iCenterX) then
 		--~ print("2dmobcenter",pw,ph,pAtlasPiece.iCenterX,pAtlasPiece.iCenterY)
 		=

-		local xo =3D (-pw/2 + pAtlasPiece.iCenterX) * kRenderer2D_XPixelScale
+		local xo
+		if (bMirrorX) then
+			xo =3D ( - (-pw/2 + pAtlasPiece.iCenterX)) * kRenderer2D_XPixelScale
+		else
+			xo =3D (-pw/2 + pAtlasPiece.iCenterX) * kRenderer2D_XPixelScale
+		end
 		local yo =3D (22    + pAtlasPiece.iCenterY) * kRenderer2D_YPixelScale
 		=

 		--~ 2dmobcenter     26      60      13      -4		human

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Wed Oct  1 22:01:49 2008
@@ -185,6 +185,9 @@
 end
 =

 function Load_Anim () =

+	LoadBodyDef(		CorrectPath( Addfilepath("Body.def") ))
+	LoadBodyConfDef(	CorrectPath( Addfilepath("Bodyconv.def") ))
+	LoadEquipConvDef(	CorrectPath( Addfilepath("Equipconv.def") ))
 	if (gAnimLoaderType) then
 		LoadingProfile("init AnimLoader")
 		gAnimLoader =3D {}

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Wed Oct  1 22:01:49 2008
@@ -25,6 +25,122 @@
      iCurrentId =3D (iBaseId + GetAnimDataInfo(iBaseId).miFrames[ iCurrent=
Frame ])
 ]]--
 =

+--[[
+iModelID : 13 =3D evortex
+iModelID : 50 =3D skeleton
+iModelID : 51 =3D slime
+iModelID : 200 =3D horse
+iModelID : 204 =3D horse
+iModelID : 226 =3D horse
+iModelID : 228 =3D horse
+iModelID : 210 =3D ostard
+iModelID : 218 =3D ostard
+iModelID : 219 =3D ostard
+iModelID : 220 =3D lama
+
+iModelID : 409 =3D hat
+iModelID : 430 =3D shorts
+iModelID : 431 =3D trousers
+
+iModelID : 469 =3D finerobe
+iModelID : 574 =3D bladespirit
+iModelID : 970 =3D deathshroud
+iModelID : 987 =3D gmrobe
+iModelID : 991 =3D britain-mage-robe
+
+crane 0xcc=3D204 in anim4
+warning, Renderer2D:UpdateMobile load uoanim failed     254     0       0 =
      0
+GetStaticTileType(10084)        {miUnknown3=3D0,miHue=3D0,miQuality=3D0,mi=
AnimID=3D0,bBackGround=3Dfalse,iSortBonus2D=3D6,iCalcHeight=3D0,miFlags=3D1=
6384=3D0x4000,miWeight=3D0,miQuantity=3D0,msName=3D"crane",bSurface=3Dfalse=
,miUnknown=3D0,miHeight=3D0,miUnknown1=3D0,bBridge=3Dfalse,miUnknown2=3D0,}
+		10084 =3D 0x2764  =

+		10084-254=3D9830
+
+
+iModelID : 13 =3D evortex  in anim1
+warning, Renderer2D:UpdateMobile load uoanim failed     164     3       0 =
      0
+>1      164     0       0
+>2      {miFlags=3D16464=3D0x4050,miWeight=3D-1,miQuantity=3D0,msName=3D"l=
og wall",  }
+>3      {miFlags=3D0x10002040,miWeight=3D-1,miQuantity=3D0,msName=3D"bark =
roofing",}  GetStaticTileType(mobile.artid+9830)
+
+
+deathwatch beetle =3D 3 in anim4:
+warning, Renderer2D:UpdateMobile load uoanim failed     242     3       0 =
      0       242
+
+runebeetle =3D 4 in anim4
+warning, Renderer2D:UpdateMobile load uoanim failed     244     3       0 =
      0       244
+gargoyle:artid=3D4
+
+Bodyconv.def =

+# <Object> <LBR version (anim2)> <AoS version (anim3)> <AoW version (anim4=
)><Mondain version (anim5)>		=

+242	-1	-1	3	-1 			deathwatch beetle
+244	-1	-1	4	-1			runebeetle
+
+Body.def =

+# <ORIG BODY> {<NEW BODY>} <NEW HUE>
+warning, Renderer2D:UpdateMobile load uoanim failed     164     3       0 =
      0       164       energy vortex
+164 {13} 20     energy vortex
+
+
+Body.def =

+warning, Renderer2D:UpdateMobile load uoanim failed     776     21      0 =
      0       776
+776 {39} 2120          -- 39:mongbat gfx
+776	44	-1	-1	-1	 	horde minion in anim2
+
+142 {42, 44, 45} 32875      anim2:44=3Dhorde-minion  anim1:42=3Dratman
+]]--
+
+gBodyDef =3D {}
+gBodyConfDef =3D {}
+gEquipConvDef =3D {}
+
+-- loads Body.def
+function LoadBodyDef (filename)
+	gBodyDef =3D {}
+	if file_exists(filename) then
+		for line in io.lines(filename) do
+			-- # Format is: <ORIG BODY> {<NEW BODY>} <NEW HUE>
+			-- 142 {42, 44, 45} 32875      anim2:44=3Dhorde-minion  anim1:42=3Dratm=
an      =

+			-- multiple <NEW BODY> entries : maybe in the higher anim files? (anim2=
.mul - anim5.mul)?
+			local s1,s2, bodyid,newbodylist,newhue =3D string.find(line,"([%-%d]+)%=
s+%{([^%}]+)%}%s+([%-%d]+)")
+			if (s1) then =

+				newbodylist =3D explode("%s*,%s*",newbodylist)
+				for k,v in pairs(newbodylist) do newbodylist[k] =3D tonumber(v) end
+				gBodyDef[tonumber(bodyid)] =3D {newbodylist,tonumber(newhue)}
+			end
+		end
+	else
+		print("LoadBodyDef error, file not found",filename)
+	end
+end
+
+-- loads Bodyconv.def
+function LoadBodyConfDef (filename)
+	gBodyConfDef =3D {}
+	if file_exists(filename) then
+		for line in io.lines(filename) do
+			-- # <Object> <LBR version (anim2)> <AoS version (anim3)> <AoW version =
(anim4)><Mondain version (anim5)>	=

+			-- 157	1	-1	-1	-1
+			local s1,s2, bodyid,anim2,anim3,anim4,anim5 =3D string.find(line,"([%-%=
d]+)%s+([%-%d]+)%s+([%-%d]+)%s+([%-%d]+)%s+([%-%d]+)")
+			if (s1) then gBodyConfDef[tonumber(bodyid)] =3D {tonumber(anim2),tonumb=
er(anim3),tonumber(anim4),tonumber(anim5)} end
+		end
+	else
+		print("LoadBodyConfDef error, file not found",filename)
+	end
+end
+
+-- loads Equipconv.def
+function LoadEquipConvDef (filename)
+	gEquipConvDef =3D {}
+	if file_exists(filename) then
+		for line in io.lines(filename) do
+			-- #  #bodyType	#equipmentID	#convertToID	#GumpIDToUse	#hue	=

+			-- 401	538	986	0	0			# female chain substitution	=

+			-- mainly female and elven stuff, probably not needed
+		end
+	else
+		print("LoadEquipConvDef error, file not found",filename)
+	end
+end
+
 =

 -- TODO : http://svn.berlios.de/viewcvs/wolfpack/trunk/client/  =

 =

@@ -46,14 +162,15 @@
 =

 =

 -- returns atlaspiece
-function Anim2DAtlas_LoadAtlasPiece (iModelID,iAnimID,iFrame,iHue)
-	local n =3D iModelID..","..iAnimID..","..iFrame..","..iHue
+function Anim2DAtlas_LoadAtlasPiece (iModelID,iAnimID,iFrame,iHue,iLoaderI=
ndex)
+	iLoaderIndex =3D iLoaderIndex or 1
+	local n =3D iModelID..","..iAnimID..","..iFrame..","..iHue..","..iLoaderI=
ndex
 	local o =3D gAnimAtlasCache[n]
 	if (o ~=3D nil) then return o end
 	=

 	-- load frame image
 	local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

-	local img,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrameToI=
mage(iRealID,iFrame,iHue)
+	local img,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrameToI=
mage(iRealID,iFrame,iHue,iLoaderIndex)
 	if (not img) then print("Anim2DAtlas_Load : dead anim ",iModelID,iAnimID,=
iFrame,iHue) end
 	if (not img) then gAnimAtlasCache[n] =3D false return end
 		=

@@ -149,15 +266,24 @@
 	return o
 end
 =

--- returns iNewModelID,iLoaderIndex
-function UOAnimTranslateBodyID (iOrigModelID)
-	-- TODO : Bodyconv.def,Body.def =

-	return iOrigModelID,1
-end
-
-function UOAnimCheckBitMask (iModelID,iAnimID,iFrame,px,py)
+-- returns iNewModelID,iNewHue,iLoaderIndex
+function UOAnimTranslateBodyID (iOrigModelID,iOrigHue)
+	local bodyConfDef =3D gBodyConfDef[iOrigModelID] -- gBodyConfDef[bodyid] =
=3D {anim2,anim3,anim4,anim5}
+	if (bodyConfDef) then
+		for k =3D 4,1,-1 do if (bodyConfDef[k] > 0) then return bodyConfDef[k],i=
OrigHue,k+1 end end
+	end
+	local bodyDef =3D gBodyDef[iOrigModelID] -- gBodyDef[bodyid] =3D {newbody=
list,newhue}
+	if (bodyDef) then =

+		local newbodylist,newhue =3D unpack(bodyDef)
+		-- todo : not only first entry in newbodylist ?
+		return newbodylist[1],newhue,1 =

+	end
+	return iOrigModelID,iOrigHue,1
+end
+
+function UOAnimCheckBitMask (iModelID,iAnimID,iFrame,iLoaderIndex,px,py)
 	local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

-	local bitmask =3D GetAnimFrameBitMask(iRealID,iFrame)
+	local bitmask =3D GetAnimFrameBitMask(iRealID,iFrame,iLoaderIndex)
 	if (not bitmask) then return true end -- no bitmask -> always hit
 	return bitmask:TestBit(floor(px),floor(py))
 end



From no-reply at zwischenwelt.org  Thu Oct  2 14:21:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 12:21:32 -0000
Subject: [Iris-commit] [IRIS] r2489 - /trunk/lua/lib.2d.mobile.lua
Message-ID: <20081002122132.C00931C1865D@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 14:21:31 2008
New Revision: 2489

Log:
2d : mount gfx improved

Modified:
    trunk/lua/lib.2d.mobile.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Thu Oct  2 14:21:31 2008
@@ -67,7 +67,9 @@
 	if (iMobileDir =3D=3D 2) then iDirAdd =3D 1 bMirrorX =3D true end
 	=

 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
-	table.insert(parts,{self:GetMobileMountModelAndHue(mobile)})
+	--~ table.insert(parts,{self:GetMobileMountModelAndHue(mobile)}) -- kLaye=
r_Mount
+	if (mount) then table.insert(parts,{gMountTranslate[mount.artid],mount.hu=
e,gStandardHorse}) end
+	=

 	table.insert(parts,{mobile.artid,mobile.hue,13}) -- fallback=3D13=3Devort=
ex
 	if (mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) then -- only huma=
ns have equip
 		for index,layer in pairs(gLayerOrder) do =

@@ -79,8 +81,6 @@
 				if (t and t.miAnimID and t.miAnimID > 0) then table.insert(parts,{t.mi=
AnimID,item.hue,iFallBack}) end
 			end
 		end
-		=

-		--~ table.insert(parts,{self:GetMobileModelEquipPartAndHue(mobile,kLayer=
_TorsoOuter,469)})
 	end
 	=

 	for k,v in pairs(parts) do =




From no-reply at zwischenwelt.org  Thu Oct  2 14:28:01 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 12:28:01 -0000
Subject: [Iris-commit] [IRIS] r2490 - /trunk/lua/lib.2d.mobile.lua
Message-ID: <20081002122801.A3D6E1C18667@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 14:28:01 2008
New Revision: 2490

Log:
2d mount fix

Modified:
    trunk/lua/lib.2d.mobile.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Thu Oct  2 14:28:01 2008
@@ -68,7 +68,7 @@
 	=

 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
 	--~ table.insert(parts,{self:GetMobileMountModelAndHue(mobile)}) -- kLaye=
r_Mount
-	if (mount) then table.insert(parts,{gMountTranslate[mount.artid],mount.hu=
e,gStandardHorse}) end
+	if (mount) then table.insert(parts,{gMountTranslate2D[mount.artid],mount.=
hue,gStandardHorse}) end
 	=

 	table.insert(parts,{mobile.artid,mobile.hue,13}) -- fallback=3D13=3Devort=
ex
 	if (mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) then -- only huma=
ns have equip



From no-reply at zwischenwelt.org  Thu Oct  2 14:33:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 12:33:29 -0000
Subject: [Iris-commit] [IRIS] r2491 - in /trunk: lua/gui/gui.trade.lua
 lua/lib.uoanim.lua plugins/hudenemylist.lua
Message-ID: <20081002123329.37D921C1865D@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 14:33:28 2008
New Revision: 2491

Log:
applied uoanim translation for hudlist

Modified:
    trunk/lua/gui/gui.trade.lua
    trunk/lua/lib.uoanim.lua
    trunk/plugins/hudenemylist.lua

Modified: trunk/lua/gui/gui.trade.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.trade.lua (original)
+++ trunk/lua/gui/gui.trade.lua Thu Oct  2 14:33:28 2008
@@ -85,7 +85,7 @@
 			local itemmodel
 			if good.itemartid < 1000 then
 				-- anim image
-				local sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1 =
=3D Anim2DAtlas_Load(good.itemartid,2,0,0)
+				local sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1 =
=3D Anim2DAtlas_TranslateAndLoad(good.itemartid,2,0,0)
 				if sMatName then
 					-- reduce size of too big images
 					if iWidth > 40 then

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Thu Oct  2 14:33:28 2008
@@ -148,11 +148,18 @@
 kAnimIDRangeLen_HighDetailed	=3D 200  -- mHighDetailed
 kAnimIDRangeLen_LowDetailed		=3D 200  -- mLowDetailed
 =

+
+function Anim2DAtlas_TranslateAndLoad (iModelID,iAnimID,iFrame,iHue) =

+	local iLoaderIndex =3D 1
+	iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
+	return Anim2DAtlas_Load(iModelID,iAnimID,iFrame,iHue,iLoaderIndex) =

+end
+
 -- todo : humans : one atlas with complete equipment, will need alpha-blit=
 for images ?
 -- todo : mobile : load anim only on demand, e.g. only load walk anim when=
 the mobile actually walks
 -- returns sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1
-function Anim2DAtlas_Load (iModelID,iAnimID,iFrame,iHue) =

-	local o =3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,iHue)
+function Anim2DAtlas_Load (iModelID,iAnimID,iFrame,iHue,iLoaderIndex) =

+	local o =3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,iHue,iLoad=
erIndex)
 	if (o) then =

 		local basematerial =3D "renderer2dbillboard"
 		local matname =3D o.atlas.atlasgroup:LoadAtlasMat(o.atlas,basematerial)

Modified: trunk/plugins/hudenemylist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/hudenemylist.lua (original)
+++ trunk/plugins/hudenemylist.lua Thu Oct  2 14:33:28 2008
@@ -391,7 +391,7 @@
 		local image =3D gTypenameToIcon[typename]
 		if not image then image =3D "sd_pd_unknown.png" end
 		=

-		local sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1 =3D =
Anim2DAtlas_Load(typename,2,0,0)
+		local sMatName,iWidth,iHeight,iCenterX,iCenterY,iFrames,u0,v0,u1,v1 =3D =
Anim2DAtlas_TranslateAndLoad(typename,2,0,0)
 		local image_info =3D {sMatName,u0,v0,u1,v1}
 		=

 		block =3D Plugin_HudEnemylist_MakeBlock(typename,index,image_info,{})



From no-reply at zwischenwelt.org  Thu Oct  2 16:14:00 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 14:14:00 -0000
Subject: [Iris-commit] [IRIS] r2492 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.map.lua lib.2d.renderer.lua lib.2d.spriteblock.lua lib.3d.map.lua
 lib.blendout.lua main.lua
Message-ID: <20081002141400.671761524030@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 16:14:00 2008
New Revision: 2492

Log:
2d : blendout code generalized and used for 2d mulits and dynamics

Added:
    trunk/lua/lib.blendout.lua
Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Thu Oct  2 16:14:00 2008
@@ -7,20 +7,41 @@
 function Renderer2D:AddCorpseItem					(item) =

 	print("TODO:Renderer2D:AddCorpseItem")
 end
-function Renderer2D:AddMultiItem					(item) =

+
+function Renderer2D:UpdateDynamicBlendOut			(item,minzloc,maxzloc) =

+	if item.artid >=3D gMulti_ID then =

+		-- multi
+		self:UpdateMultiItemGfx(item)
+	else
+		local iBlendOutMinZ,iBlendOutMaxZ =3D self:BlendoutGetVisibleRange()
+		local zloc =3D item.zloc
+		local bVisible =3D zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ
+		if (item.gfx2d) then item.gfx2d:SetVisible(bVisible) end
+	end
+end
+
+function Renderer2D:UpdateMultiItemGfx				(item) =

 	gDebugLastMultiItem =3D item
 	local multi =3D item.multi
 	if (not multi) then print("Renderer2D:AddMultiItem error:no multi data") =
return end
 	=

 	-- create spriteblock
-	local spriteblock =3D cUOSpriteBlock:New()
-	item.gfx2d =3D spriteblock
+	local spriteblock =3D item.gfx2d
+	if (not spriteblock) then
+		spriteblock =3D cUOSpriteBlock:New()
+		item.gfx2d =3D spriteblock
+	else
+		spriteblock:Clear()
+	end
 	=

 	-- add multi parts
 	local totalpartnum =3D #multi.lparts
 	local itemxloc =3D item.xloc
 	local itemyloc =3D item.yloc
 	local itemzloc =3D item.zloc
+	=

+	local iBlendOutMinZ,iBlendOutMaxZ =3D self:BlendoutGetVisibleRange()
+		=

 	for k,part in pairs(multi.lparts) do
 		local iTileTypeID,xloc,yloc,zloc,iHue =3D unpack(part) -- see Multi_AddP=
artHelper
 		local tx =3D xloc-itemxloc
@@ -30,10 +51,12 @@
 		local sortty =3D yloc-floor(yloc/8)*8
 		local sorttz =3D zloc
 		local fIndexRel =3D k / totalpartnum
-		local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Calc=
SortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
-		sprite.xloc =3D xloc -- mousepicking
-		sprite.yloc =3D yloc
-		sprite.zloc =3D zloc
+		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ) then
+			local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Cal=
cSortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
+			sprite.xloc =3D xloc -- mousepicking
+			sprite.yloc =3D yloc
+			sprite.zloc =3D zloc
+		end
 	end
 	spriteblock:Build(Renderer2D.kSpriteBaseMaterial)
 	local x,y,z =3D gCurrentRenderer:UOPosToLocal(itemxloc,itemyloc,itemzloc*=
kRenderer2D_ZScale)
@@ -48,7 +71,7 @@
 		print("ERROR: artid missing!!!!\n")
 	elseif item.artid >=3D gMulti_ID then =

 		-- multi
-		self:AddMultiItem(item)
+		self:UpdateMultiItemGfx(item)
 	else
 		local spriteblock =3D cUOSpriteBlock:New()
 		item.gfx2d =3D spriteblock

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Thu Oct  2 16:14:00 2008
@@ -45,6 +45,39 @@
 	end
 end
 =

+function Renderer2D:BlendOutLayersAbovePlayer	()
+	local x,y,z =3D GetPlayerPos()
+	if (not z or not gStaticBlockLoader or not gGroundBlockLoader) then retur=
n end
+	=

+	local myLayer =3D nil
+	local bTerrainVisible =3D true
+	=

+	--~ if (self:CamModeAllowsBlendout()) then ... end   -- don't blend out i=
n freecam ?
+	myLayer,bTerrainVisible =3D CalcBlendOutZ()
+	=

+	=

+	-- only update if changed
+	if (self.giBlendOutCurZ ~=3D myLayer or self.gbBlendOutTerrainVisible ~=
=3D bTerrainVisible) then
+		self.giBlendOutCurZ =3D myLayer
+		--~ print("Renderer2D:BlendOutLayersAbovePlayer",myLayer,bTerrainVisible)
+		=

+		local a,b =3D self:BlendoutGetVisibleRange()
+		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
)) then self:UpdateDynamicBlendOut(dynamic,a,b) end end
+	end
+	--[[
+	gCurrentRenderer:BlendoutGetVisibleRange()
+	mapblock:SetDisplayRange
+	Renderer2D:BlendOutLayersAbovePlayer
+	]]--
+end
+
+-- returns fMinZ,fMaxZ
+function Renderer2D:BlendoutGetVisibleRange ()
+	local fMinZ =3D -1000
+	local fMaxZ =3D (self.giBlendOutCurZ or 1000) -- inclusive
+	return fMinZ,fMaxZ
+end
+
 function Renderer2D:MapStep		()
 	self:MobileTestStep()
 	=


Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Thu Oct  2 16:14:00 2008
@@ -179,7 +179,6 @@
 function Renderer2D:NotifyHPChange				(mobile, value) end
 function Renderer2D:NotifyManaChange			(mobile, value) end
 function Renderer2D:NotifyPlayerTeleported		() end
-function Renderer2D:BlendOutLayersAbovePlayer	() end
 function Renderer2D:ClearMapCache				() self:MapClear() end
 =

 function Renderer2D:TerrainRayIntersect_Hit		(...) end -- ??? might not be=
 needed

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Thu Oct  2 16:14:00 2008
@@ -11,6 +11,12 @@
 	self.pTileTypeAtlasMats =3D {} -- self.pTileTypeAtlasMats[iTileTypeID][iH=
ue] =3D pAtlasPiece (see ArtAtlasLoadAndLock)
 	self.pGroupGfx =3D {}
 	self.pSpritesByAtlas =3D {}
+	self.bVisible =3D true
+end
+
+function cUOSpriteBlock:SetVisible (bVisible) =

+	self.bVisible =3D bVisible
+	if (self.rootgfx) then self.rootgfx:SetVisible(bVisible) end
 end
 =

 function cUOSpriteBlock:SetPosition (x,y,z) =

@@ -23,7 +29,13 @@
 function cUOSpriteBlock:Destroy () self:Clear() end
 =

 function cUOSpriteBlock:Clear ()
-	if (self.pGroupGfx) then for k,v in pairs(self.pGroupGfx) do v:Destroy() =
end self.pGroupGfx =3D {} end
+	if (self.pGroupGfx) then =

+		for k,v in pairs(self.pGroupGfx) do =

+			if (v =3D=3D self.rootgfx) then self.rootgfx =3D nil end
+			v:Destroy() =

+		end =

+		self.pGroupGfx =3D {} =

+	end
 	if (self.rootgfx) then self.rootgfx:Destroy() self.rootgfx =3D nil end
 	self.pSpritesByAtlas =3D {}
 end
@@ -42,6 +54,7 @@
 -- returns dist,sprite   if hit, or nil if not hit.    sprite=3D{artid=3D?=
,hue=3D?,data=3D?} (see AddArtSprite)
 function cUOSpriteBlock:RayPick (rx,ry,rz, rvx,rvy,rvz)
 	if (not self.bBuilt) then return end
+	if (not self.bVisible) then return end
 	rx =3D rx - self.x
 	ry =3D ry - self.y
 	rz =3D rz - self.z
@@ -261,6 +274,7 @@
 			gfx:RenderableEnd()
 		end
 	end
+	self:SetVisible(self.bVisible)
 	self.bBuilt =3D true
 end
 =


Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Thu Oct  2 16:14:00 2008
@@ -6,7 +6,6 @@
 Renderer3D.giMapOriginX =3D 0
 Renderer3D.giMapOriginY =3D 0
 Renderer3D.ROBMAP_CHUNK_SIZE =3D 2
-Renderer3D.giBlendOutPlayerHeight =3D 18	--eriminator: es galt grob, alles=
 was 18z =C3=AF=C2=BF=C2=BDberm char war wurd ausgebledent
 Renderer3D.giBlendOutCurZ =3D nil
 =

 Renderer3D.kGoodFPS =3D 25
@@ -96,69 +95,13 @@
 	ich  hab f=C3=AF=C2=BF=C2=BDr iris h=C3=AF=C2=BF=C2=BDher gebaut als norm=
al uo etagen vorsah, bei osi war 20die h=C3=AF=C2=BF=C2=BDhe f=C3=AF=C2=BF=
=C2=BDr ne wand, =

 	]]--
 	=

-	local playerheadpos =3D z + self.giBlendOutPlayerHeight
 =

 	local myLayer =3D nil
-	local playerIsInside =3D false
 	local bTerrainVisible =3D true
-	local zloc_roof =3D nil -- becomes the minimum of the statics above the p=
layer
 	=

 	-- only blend out if not in first person mode or in freecam
 	if (Renderer3D:CamModeAllowsBlendout()) then =

-		=

-		-- check ground
-		local iPlayerGroundTileType,iPlayerGroundZLoc =3D GetAbsTile(x,y) =

-		if (iPlayerGroundZLoc and iPlayerGroundZLoc >=3D playerheadpos) then pla=
yerIsInside =3D true bTerrainVisible =3D false end
-		=

-		-- check statics
-		if (not playerIsInside) then
-			local l =3D MapGetStatics(x,y)
-			=

-			for k,v in pairs(l) do
-				if v.zloc >=3D playerheadpos then
-					playerIsInside =3D true =

-					if ((not zloc_roof) or (zloc_roof > v.zloc)) then zloc_roof =3D v.zlo=
c end
-				end
-			end
-		end
-
-		-- check multis
-		if (not playerIsInside) then
-			local iTileTypeID,iX,iY,iZ,iHue
-			local multi
-			for k,v in pairs(gMultis) do
-				multi =3D k
-				if multi.lparts then
-					for k,v in pairs(multi.lparts) do
-						iTileTypeID,iX,iY,iZ,iHue =3D unpack(v)
-						if	iX =3D=3D x and iY =3D=3D y  and iZ >=3D playerheadpos then
-							playerIsInside =3D true
-							if ((not zloc_roof) or (zloc_roof > iZ)) then zloc_roof =3D iZ end
-						end
-					end
-				end
-			end
-		end
-
-		-- check dynamics to detect dynamic houseroofs and other stuff above the=
 head
-		if (not playerIsInside) then
-			local iZ
-			for k,dynamic in pairs(GetDynamicsAtPosition(x,y)) do
-				if (dynamic.zloc >=3D playerheadpos) then
-					playerIsInside =3D true
-					iZ =3D dynamic.zloc
-					if ((not zloc_roof) or (zloc_roof > iZ)) then zloc_roof =3D iZ end
-				end
-			end
-		end
-
-		-- blend out layers above player head if inside
-		--~ if (playerIsInside) then myLayer =3D zloc_roof or playerheadpos end
-		if (playerIsInside) then =

-			myLayer =3D playerheadpos =

-			--~ if (zloc_roof) then myLayer =3D zloc_roof - 1 end
-		end
-		--~ print("blendout",playerIsInside,playerheadpos,zloc_roof)
+		myLayer,bTerrainVisible =3D CalcBlendOutZ()
 	end
 	=

 	-- a bit of tolerance to avoid rebatching all the time for uneven floors =
... not needed anymore with fastbatch blendout
@@ -220,7 +163,7 @@
 =

 --[[
 function Renderer3D:LayerToZ(zlayer)
-	--~ return zlayer * Renderer3D.giBlendOutPlayerHeight
+	--~ return zlayer * kBlendOutPlayerHeight
 	return zlayer
 end
 =

@@ -231,7 +174,7 @@
 end
 =

 function Renderer3D:ZToLayer(zloc)
-	--~ return math.floor(zloc / Renderer3D.giBlendOutPlayerHeight)
+	--~ return math.floor(zloc / kBlendOutPlayerHeight)
 	return math.floor(zloc)
 end
 ]]--

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct  2 16:14:00 2008
@@ -86,6 +86,7 @@
 dofile(libpath .. "lib.uoutils.lua")
 dofile(libpath .. "lib.desktop.lua")
 dofile(libpath .. "lib.uoanim.lua")
+dofile(libpath .. "lib.blendout.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")



From no-reply at zwischenwelt.org  Thu Oct  2 16:41:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 14:41:58 -0000
Subject: [Iris-commit] [IRIS] r2493 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.map.lua lib.2d.spriteblock.lua lib.mapblock.2d.statics.lua
Message-ID: <20081002144159.01CD41524030@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 16:41:58 2008
New Revision: 2493

Log:
small changes

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.mapblock.2d.statics.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Thu Oct  2 16:41:58 2008
@@ -8,12 +8,11 @@
 	print("TODO:Renderer2D:AddCorpseItem")
 end
 =

-function Renderer2D:UpdateDynamicBlendOut			(item,minzloc,maxzloc) =

+function Renderer2D:UpdateDynamicBlendOut			(item,iBlendOutMinZ,iBlendOutM=
axZ) =

 	if item.artid >=3D gMulti_ID then =

 		-- multi
 		self:UpdateMultiItemGfx(item)
 	else
-		local iBlendOutMinZ,iBlendOutMaxZ =3D self:BlendoutGetVisibleRange()
 		local zloc =3D item.zloc
 		local bVisible =3D zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ
 		if (item.gfx2d) then item.gfx2d:SetVisible(bVisible) end

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Thu Oct  2 16:41:58 2008
@@ -63,6 +63,17 @@
 		=

 		local a,b =3D self:BlendoutGetVisibleRange()
 		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
)) then self:UpdateDynamicBlendOut(dynamic,a,b) end end
+		=

+		--~ if self.map2d_spawners then
+			--~ for k,v in pairs(self.map2d_spawners) do
+				--~ v:ForAllBlocks(function(block)
+					--~ if block.SetDisplayRange then
+						--~ block:SetDisplayRange(a,b)
+					--~ end
+				--~ end)
+			--~ end
+		--~ end
+		=

 	end
 	--[[
 	gCurrentRenderer:BlendoutGetVisibleRange()

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Thu Oct  2 16:41:58 2008
@@ -28,7 +28,7 @@
 =

 function cUOSpriteBlock:Destroy () self:Clear() end
 =

-function cUOSpriteBlock:Clear ()
+function cUOSpriteBlock:ClearGfx ()
 	if (self.pGroupGfx) then =

 		for k,v in pairs(self.pGroupGfx) do =

 			if (v =3D=3D self.rootgfx) then self.rootgfx =3D nil end
@@ -37,6 +37,9 @@
 		self.pGroupGfx =3D {} =

 	end
 	if (self.rootgfx) then self.rootgfx:Destroy() self.rootgfx =3D nil end
+end
+function cUOSpriteBlock:Clear ()
+	self:ClearGfx()
 	self.pSpritesByAtlas =3D {}
 end
 =

@@ -220,10 +223,10 @@
 	if (atlas.atlasgroup) then return atlas.atlasgroup:LoadAtlasMat(atlas,bas=
emat) end
 end
 =

--- bUseRootGfx : default false, can be set to true if there is only one sp=
rite
-function cUOSpriteBlock:Build 	(basemat,bUseRootGfx)
-	if (self.pGroupGfx) then for k,v in pairs(self.pGroupGfx) do v:Destroy() =
end self.pGroupGfx =3D {} end
-	if (not self.rootgfx) then self.rootgfx =3D CreateRootGfx3D() end
+-- bUseRootGfxForFirst : default false, can be set to true if there is onl=
y one sprite
+function cUOSpriteBlock:Build 	(basemat,bUseRootGfxForFirst)
+	self:ClearGfx()
+	self.rootgfx =3D CreateRootGfx3D()
 	-- for 3d statics
 	-- statics : create gfx
 	-- -so 1420,1550
@@ -237,9 +240,9 @@
 			-- TODO : sort by z for blendout upper floors
 			local spritecount =3D #group
 			local gfx
-			if (bUseRootGfx) then
+			if (bUseRootGfxForFirst) then
+				bUseRootGfxForFirst =3D false
 				gfx =3D self.rootgfx
-				bUseRootGfx =3D false
 			else
 				gfx =3D self.rootgfx:CreateChild()
 				table.insert(self.pGroupGfx,gfx)

Modified: trunk/lua/lib.mapblock.2d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.2d.statics.lua (original)
+++ trunk/lua/lib.mapblock.2d.statics.lua Thu Oct  2 16:41:58 2008
@@ -3,7 +3,7 @@
 cMapBlock_2D_Statics.iLoadRadius	=3D 4 -- in iBlockSize-blocks
 =

 function cMapBlock_2D_Statics:ClearDetail ()
-	if (self.spriteblock) then self.spriteblock:Destroy() self.spriteblock =
=3D nil end
+	if (self.spriteblock) then self.spriteblock:Destroy() self.spriteblock =
=3D nil self.bMyDetailLoaded =3D false end
 end
 =

 -- returns dist,sprite   if hit, or nil if not hit.    sprite=3D{artid=3D?=
,hue=3D?,static=3D?}
@@ -34,4 +34,5 @@
 	spriteblock:Build(Renderer2D.kSpriteBaseMaterial)
 	local x,y,z =3D gCurrentRenderer:UOPosToLocal(self.bx*8,self.by*8,0)
 	spriteblock:SetPosition(x,y,z)
+	self.bMyDetailLoaded =3D true
 end



From no-reply at zwischenwelt.org  Thu Oct  2 17:09:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 15:09:14 -0000
Subject: [Iris-commit] [IRIS] r2494 - in /trunk/lua: lib.2d.map.lua
	lib.mapblock.2d.statics.lua
Message-ID: <20081002160009.5CC171C1865D@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 17:09:13 2008
New Revision: 2494

Log:
2d : blendout upper floors for static houses

Modified:
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.mapblock.2d.statics.lua

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Thu Oct  2 17:09:13 2008
@@ -59,21 +59,17 @@
 	-- only update if changed
 	if (self.giBlendOutCurZ ~=3D myLayer or self.gbBlendOutTerrainVisible ~=
=3D bTerrainVisible) then
 		self.giBlendOutCurZ =3D myLayer
-		--~ print("Renderer2D:BlendOutLayersAbovePlayer",myLayer,bTerrainVisible)
+		print("Renderer2D:BlendOutLayersAbovePlayer",myLayer,bTerrainVisible)
+		=

+		if (self.gbBlendOutTerrainVisible ~=3D bTerrainVisible) then
+			self.gbBlendOutTerrainVisible =3D bTerrainVisible
+			--~ self.map2d_spawners.terrain:ForAllBlocks(function(block) block:Upda=
teBlendOutVisibility() end)
+		end
 		=

 		local a,b =3D self:BlendoutGetVisibleRange()
 		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
)) then self:UpdateDynamicBlendOut(dynamic,a,b) end end
 		=

-		--~ if self.map2d_spawners then
-			--~ for k,v in pairs(self.map2d_spawners) do
-				--~ v:ForAllBlocks(function(block)
-					--~ if block.SetDisplayRange then
-						--~ block:SetDisplayRange(a,b)
-					--~ end
-				--~ end)
-			--~ end
-		--~ end
-		=

+		self.map2d_spawners.statics:ForAllBlocks(function(block) block:RebuildFo=
rBlendout() end)
 	end
 	--[[
 	gCurrentRenderer:BlendoutGetVisibleRange()

Modified: trunk/lua/lib.mapblock.2d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.2d.statics.lua (original)
+++ trunk/lua/lib.mapblock.2d.statics.lua Thu Oct  2 17:09:13 2008
@@ -12,7 +12,34 @@
 	return self.spriteblock:RayPick(rx,ry,rz, rvx,rvy,rvz) =

 end
 =

+function cMapBlock_2D_Statics:RebuildForBlendout ()
+	if (not self.bMyDetailLoaded) then return end
+	=

+	local iBlendOutMinZ,iBlendOutMaxZ =3D gCurrentRenderer:BlendoutGetVisible=
Range()
+	if (self.iBlendOutMinZ =3D=3D iBlendOutMinZ and
+		self.iBlendOutMaxZ =3D=3D iBlendOutMaxZ) then return end -- no change
+	print("cMapBlock_2D_Statics:RebuildForBlendout",iBlendOutMinZ,iBlendOutMa=
xZ)
+	self.iBlendOutMinZ =3D iBlendOutMinZ
+	self.iBlendOutMaxZ =3D iBlendOutMaxZ
+	=

+	self:ClearDetail()
+	self.statics =3D MapGetBlockStatics(self.bx,self.by)
+	local spriteblock =3D cUOSpriteBlock:New()
+	self.spriteblock =3D spriteblock
+	for i,static in pairs(self.statics) do =

+		if (static.zloc >=3D iBlendOutMinZ and static.zloc <=3D iBlendOutMaxZ) t=
hen spriteblock:AddStatic(static) end
+	end
+	spriteblock:Build(Renderer2D.kSpriteBaseMaterial)
+	local x,y,z =3D gCurrentRenderer:UOPosToLocal(self.bx*8,self.by*8,0)
+	spriteblock:SetPosition(x,y,z)
+	self.bMyDetailLoaded =3D true
+end
+
 function cMapBlock_2D_Statics:WorkStep_LoadDetail ()
+	local iBlendOutMinZ,iBlendOutMaxZ =3D gCurrentRenderer:BlendoutGetVisible=
Range()
+	self.iBlendOutMinZ =3D iBlendOutMinZ
+	self.iBlendOutMaxZ =3D iBlendOutMaxZ
+		=

 	self:ClearDetail()
 	=

 	-- statics : load infos from file
@@ -25,7 +52,7 @@
 	=

 	-- preload statics
 	for i,static in pairs(self.statics) do =

-		spriteblock:AddStatic(static)
+		if (static.zloc >=3D iBlendOutMinZ and static.zloc <=3D iBlendOutMaxZ) t=
hen spriteblock:AddStatic(static) end
 		self:YieldIfOverTime()
 	end
 	=

@@ -35,4 +62,5 @@
 	local x,y,z =3D gCurrentRenderer:UOPosToLocal(self.bx*8,self.by*8,0)
 	spriteblock:SetPosition(x,y,z)
 	self.bMyDetailLoaded =3D true
+	self:RebuildForBlendout()
 end



From no-reply at zwischenwelt.org  Thu Oct  2 22:28:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 20:28:35 -0000
Subject: [Iris-commit] [IRIS] r2495 - /trunk/bin/iris2.exe
Message-ID: <20081002210004.1787D1524036@zwischenwelt.org>

Author: sience
Date: Thu Oct  2 22:28:34 2008
New Revision: 2495

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Thu Oct  2 23:18:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 21:18:54 -0000
Subject: [Iris-commit] [IRIS] r2496 - in /trunk: include/data_anim.h
 lua/lib.2d.mobile.lua lua/lib.2d.spriteblock.lua
 lua/lib.mapblock.2d.statics.lua lua/lib.uoanim.lua src/data_anim_L.cpp
Message-ID: <20081002211854.87F7B1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 23:18:53 2008
New Revision: 2496

Log:
fixed/secured 2d anim loader, added getframecount, generalized 2dmobile-add=
sprite a bit and added part of it to 2d-spriteblock, will soon be used for =
corpses and effect-anims as well,  extended uoanim lua code a bit

Modified:
    trunk/include/data_anim.h
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.mapblock.2d.statics.lua
    trunk/lua/lib.uoanim.lua
    trunk/src/data_anim_L.cpp

Modified: trunk/include/data_anim.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_anim.h (original)
+++ trunk/include/data_anim.h Thu Oct  2 23:18:53 2008
@@ -25,32 +25,54 @@
 			mCenterY =3D 0;
 			mFrames =3D 0;
 		}
-		int	GetWidth () { return mWidth; }
-		int	GetHeight () { return mHeight; }
-		int GetTexWidth () { return mTexWidth; }
-		int GetTexHeight () { return mTexHeight; }
-		int GetCenterX () { return mCenterX; }
-		int GetCenterY () { return mCenterY; }
-		int GetFrames() { return mFrames; }
+		int	GetWidth		() { return mWidth; } 		///< only valid after Decode!
+		int	GetHeight		() { return mHeight; } 		///< only valid after Decode!
+		int GetTexWidth		() { return mTexWidth; } 	///< only valid after Decode!
+		int GetTexHeight	() { return mTexHeight; } 	///< only valid after Decode!
+		int GetCenterX		() { return mCenterX; } 	///< only valid after Decode!
+		int GetCenterY		() { return mCenterY; } 	///< only valid after Decode!
+		=

+		inline bool	CheckReadAdress (const char* p,const int iNeededSize,const c=
har* szContext) {
+			if (!mpRawIndex || p < mpRawData || p + iNeededSize > mpRawData + mpRaw=
Index->miLength) {
+				printf("cAnim::CheckReadAdress(offset=3D%d,neededsize=3D%d,context=3D'=
%s') failed datalen=3D%d miID=3D%d\n",
+					(int)(p-mpRawData),(int)iNeededSize,szContext,
+					(int)(mpRawIndex ? mpRawIndex->miLength : 0),(int)miID);
+				return false;
+			}
+			return true;
+		}
+		=

+		// accesses data, also valid before decode
+		int GetFrames() { =

+			const char*	pMyRawData =3D mpRawData;
+			pMyRawData +=3D 512;
+			if (!CheckReadAdress(pMyRawData,4,"GetFrames")) return 0;
+			mFrames =3D *(uint32 *)pMyRawData;
+			return mFrames; =

+		}
+		=

 		=

 		/// allocates and returns a 16-bit buffer in the pBuffer param, backgrou=
nd/transparency =3D 0
 		/// bTexSize : if true, output size will be 2^n
 		template <class _T> bool Decode(short* &pBuffer, const int iFrame, _T& f=
ilter, short* ColorTable,bool bTexSize=3Dtrue) { PROFILE
+			if (!mpRawData) return false;
+			if (!mpRawIndex) return false;
 			const char*	pMyRawData =3D mpRawData;
 			uint16* Palette =3D (uint16 *)pMyRawData;
 			pMyRawData +=3D 512;
 =

+			=

+			if (!CheckReadAdress(pMyRawData,4,"Decode:mFrames")) return false;
 			mFrames =3D *(uint32 *)pMyRawData;
 			pMyRawData +=3D 4;
+			if (iFrame >=3D mFrames) return false;
 =

+			if (!CheckReadAdress(pMyRawData,4*(iFrame+1),"Decode:LookupList-base"))=
 return false;
 			uint32* LookupList =3D (uint32 *)pMyRawData;
 			=

-			if (iFrame >=3D mFrames) {
-				return false;
-			}
-
 			pMyRawData +=3D LookupList[ iFrame ] - 4;
 =

+			if (!CheckReadAdress(pMyRawData,2*4,"Decode:looked-up-frame")) return f=
alse;
 			mCenterX =3D *(int16 *)pMyRawData;
 			pMyRawData +=3D 2;
 			mCenterY =3D *(int16 *)pMyRawData;
@@ -79,6 +101,7 @@
 			int		iBufferSize =3D 2*mTexWidth*mTexHeight;
 			memset( pBuffer, 0, iBufferSize );
 =

+			CheckReadAdress(pMyRawData,4,"Decode:FrameHead");
 			uint32 Header =3D *(uint32 *)pMyRawData;
 			pMyRawData +=3D 4;
 =

@@ -98,6 +121,7 @@
 				int16 PX =3D xOffset + mCenterX;
 				int16 PY =3D yOffset + mCenterY + mHeight;
 =

+				if (!CheckReadAdress(pMyRawData,xRun,"Decode:FrameRun")) break;
 				unsigned char* RunPixels =3D (unsigned char*)pMyRawData;
 				pMyRawData +=3D xRun;
 =

@@ -108,6 +132,7 @@
 					}
 				}
 =

+				if (!CheckReadAdress(pMyRawData,4,"Decode:FrameHead2")) break;
 				Header =3D *(uint32 *)pMyRawData;
 				pMyRawData +=3D 4;
 			}

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Thu Oct  2 23:18:53 2008
@@ -15,7 +15,7 @@
 =

 function My2DMobileDebug (a)
 	local playermobile =3D GetPlayerMobile()
-	gMy2DMobileDebug =3D (gMy2DMobileDebug or 766) + a
+	gMy2DMobileDebug =3D (gMy2DMobileDebug or 200) + a
 	playermobile.artid =3D gMy2DMobileDebug
 	print("My2DMobileDebug",gMy2DMobileDebug)
 	Renderer2D:UpdateMobile(playermobile)
@@ -55,16 +55,7 @@
 	local sortty =3D yloc-floor(yloc/8)*8
 	local sorttz =3D zloc
 	local parts =3D {}
-	local iMobileDir =3D DirWrap(mobile.dir)
-	local iDirAdd,bMirrorX =3D 0,false
-	if (iMobileDir =3D=3D 3) then iDirAdd =3D 0 end
-	if (iMobileDir =3D=3D 4) then iDirAdd =3D 1 end
-	if (iMobileDir =3D=3D 5) then iDirAdd =3D 2 end
-	if (iMobileDir =3D=3D 6) then iDirAdd =3D 3 end
-	if (iMobileDir =3D=3D 7) then iDirAdd =3D 4 end
-	if (iMobileDir =3D=3D 0) then iDirAdd =3D 3 bMirrorX =3D true end
-	if (iMobileDir =3D=3D 1) then iDirAdd =3D 2 bMirrorX =3D true end
-	if (iMobileDir =3D=3D 2) then iDirAdd =3D 1 bMirrorX =3D true end
+	local iDirAdd,bMirrorX =3D GetAnimDirAdd(DirWrap(mobile.dir))
 	=

 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
 	--~ table.insert(parts,{self:GetMobileMountModelAndHue(mobile)}) -- kLaye=
r_Mount
@@ -76,46 +67,27 @@
 			local item =3D GetMobileEquipmentItem(mobile,layer)
 			if (item) then =

 				local t =3D GetStaticTileType(item.artid)
-				local iFallBack
-				if (layer =3D=3D kLayer_TorsoOuter) then iFallBack =3D 469 end -- stan=
dard robe
-				if (t and t.miAnimID and t.miAnimID > 0) then table.insert(parts,{t.mi=
AnimID,item.hue,iFallBack}) end
+				local iFallBackModel
+				if (layer =3D=3D kLayer_TorsoOuter) then iFallBackModel =3D 469 end --=
 standard robe
+				if (t and t.miAnimID and t.miAnimID > 0) then table.insert(parts,{t.mi=
AnimID,item.hue,iFallBackModel}) end
 			end
 		end
 	end
 	=

 	for k,v in pairs(parts) do =

-		local iModelID,iHue,iFallBack =3D unpack(v)
-		if iModelID then
+		local iModelID,iHue,iFallBackModel =3D unpack(v)
+		if iModelID then =

 			local iLoaderIndex =3D 1
 			iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
-		=

 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
-			iHue			=3D BitwiseAND(iHue,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
+			=

 			local iAnimID =3D gMy2DMobileDebugAnim or Anim_GetIdleAnim(iModelID,mou=
nt) + iDirAdd
-			local iFrame =3D ((gMy2DDebugFrame or 0) / 5) % 5
-			local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFram=
e,iHue,iLoaderIndex)
-			if (not pAtlasPiece) then
-				--~ print(">1",mobile.artid,mobile.flag,mobile.hue)
-				--~ print(">2",SmartDump(GetStaticTileType(mobile.artid)))
-				--~ print(">3",SmartDump(GetStaticTileType(mobile.artid+9830)))
-				--~ local info =3D GetAnimDataInfo(iModelID)
-				--~ print("GetAnimDataInfo()",SmartDump(info))
-				if (iFallBack) then
-					print("warning, Renderer2D:UpdateMobile load uoanim failed",iModelID,=
iAnimID,iFrame,iHue,mobile.artid)
-					iModelID =3D iFallBack -- replace unknown by standard model (13=3Devo=
rtex)
-					pAtlasPiece	=3D Anim2DAtlas_LoadAtlasPiece(iModelID,iAnimID,iFrame,iH=
ue,iLoaderIndex)
-				end
-			end
-			if (pAtlasPiece) then
-				local sprite =3D spriteblock:AddSpriteEx(tx,ty,tz,CalcSortBonus(nil,so=
rttx,sortty,sorttz,fIndexRel,4),mobile,pAtlasPiece,bMirrorX)
-				sprite.bMirrorX =3D bMirrorX
-				sprite.uoanim_ModelID		=3D iModelID
-				sprite.uoanim_AnimID		=3D iAnimID
-				sprite.uoanim_Frame			=3D iFrame
-				sprite.uoanim_LoaderIndex	=3D iLoaderIndex
-				sprite.hue =3D iHue
-			end
+			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID),iLoaderIndex) or 1000
+			if (iFrameCount < 1) then iFrameCount =3D 1 end
+			local iFrame =3D floor((gMy2DDebugFrame or 0) / 15) % iFrameCount
+			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del)
+			spriteblock:AddAnim(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackModel,=
iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,sortt=
z,fIndexRel,4),mobile) =

 		end
 	end
 	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,false)
@@ -134,9 +106,9 @@
 function Renderer2D:MobileStartServerSideAnim	(animdata) end
 =

 function Renderer2D:MobileTestStep()
-	--~ local playermobile =3D GetPlayerMobile()
+	local playermobile =3D GetPlayerMobile()
 	--~ print("playermobile.dir",playermobile and DirWrap(playermobile.dir)) =

-	--~ gMy2DDebugFrame =3D (gMy2DDebugFrame or 0) + 1
+	--~ gMy2DDebugFrame =3D floor(gMy2DDebugFrame or 0) + 1
 	--~ Renderer2D:UpdateMobileGfx(GetPlayerMobile())
 	if true then return end
 	=


Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Thu Oct  2 23:18:53 2008
@@ -128,6 +128,45 @@
 	self:AddArtSprite(tx,ty,zloc,artid,static.hue,CalcSortBonus(artid,tx,ty,z=
loc,static.fBlockIndexRel),static)
 end
 =

+-- local iDirAdd,bMirrorX =3D GetAnimDirAdd(iDir)
+function GetAnimDirAdd (iDir)
+	if (iDir =3D=3D 3) then return 0,false end
+	if (iDir =3D=3D 4) then return 1,false end
+	if (iDir =3D=3D 5) then return 2,false end
+	if (iDir =3D=3D 6) then return 3,false end
+	if (iDir =3D=3D 7) then return 4,false end
+	if (iDir =3D=3D 0) then return 3,true end
+	if (iDir =3D=3D 1) then return 2,true end
+	if (iDir =3D=3D 2) then return 1,true end
+	return 0,false
+end
+
+function cUOSpriteBlock:AddAnim (tx,ty,tz,iTranslatedModelID,iHue,iLoaderI=
ndex,iFallBackModel,iFallBackAnim,iAnimID,iFrame,bMirrorX,sortbonus,data)
+	iHue =3D BitwiseAND(iHue or 0,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
+	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnim=
ID,iFrame,iHue,iLoaderIndex)
+	if (not pAtlasPiece) then
+		if (iFallBackModel) then
+			gMobile2DWarned =3D gMobile2DWarned or {}
+			local n =3D iTranslatedModelID..","..iAnimID
+			if (not gMobile2DWarned[n]) then gMobile2DWarned[n] =3D true
+				print("warning, Renderer2D:UpdateMobile load uoanim failed",iTranslate=
dModelID,iAnimID,iFrame,iHue,data.artid)
+			end
+			iTranslatedModelID	=3D iFallBackModel -- replace unknown by standard mo=
del (13=3Devortex)
+			iAnimID				=3D iFallBackAnim
+			pAtlasPiece			=3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnimID=
,iFrame,iHue,iLoaderIndex)
+		end
+	end
+	if (pAtlasPiece) then
+		local sprite =3D self:AddSpriteEx(tx,ty,tz,sortbonus,data,pAtlasPiece,bM=
irrorX)
+		sprite.bMirrorX =3D bMirrorX
+		sprite.uoanim_ModelID		=3D iTranslatedModelID
+		sprite.uoanim_AnimID		=3D iAnimID
+		sprite.uoanim_Frame			=3D iFrame
+		sprite.uoanim_LoaderIndex	=3D iLoaderIndex
+		sprite.hue =3D iHue
+		return sprite
+	end
+end
 =

 -- load textures to atlas, artid-hue
 function cUOSpriteBlock:AddArtSprite (tx,ty,zloc,artid,hue,sortbonus,data)

Modified: trunk/lua/lib.mapblock.2d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.2d.statics.lua (original)
+++ trunk/lua/lib.mapblock.2d.statics.lua Thu Oct  2 23:18:53 2008
@@ -18,7 +18,7 @@
 	local iBlendOutMinZ,iBlendOutMaxZ =3D gCurrentRenderer:BlendoutGetVisible=
Range()
 	if (self.iBlendOutMinZ =3D=3D iBlendOutMinZ and
 		self.iBlendOutMaxZ =3D=3D iBlendOutMaxZ) then return end -- no change
-	print("cMapBlock_2D_Statics:RebuildForBlendout",iBlendOutMinZ,iBlendOutMa=
xZ)
+	--~ print("cMapBlock_2D_Statics:RebuildForBlendout",iBlendOutMinZ,iBlendO=
utMaxZ)
 	self.iBlendOutMinZ =3D iBlendOutMinZ
 	self.iBlendOutMaxZ =3D iBlendOutMaxZ
 	=


Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Thu Oct  2 23:18:53 2008
@@ -22,7 +22,48 @@
  42M anim5.mul
  =

  =

+ corpseanim    model     anim     framecount
+ corpseanim    400     105     x		diebackwards
+ corpseanim    400     110     x		dieforward
+ corpseanim		1       10      x		diebackwards
+ corpseanim		1       15      x		dieforward
      iCurrentId =3D (iBaseId + GetAnimDataInfo(iBaseId).miFrames[ iCurrent=
Frame ])
+	 =

+200 	 0	walk
+200 	 5	run
+200 	10	idle
+200 	15	eat(horse)? die?
+200 	20	idleanim?(horse:nodge-head)
+200 	25	attack1
+200 	30	attack2
+200 	35	gethit?
+200 	40	dieside?
+200 	45	gethit?cast?
+200 	50	gethit?cast?
+200 	55	idlenaim?
+200 	60	dieside?
+
+2		 0	walk
+2		 5	idle
+2		10	dieback
+2		15	dieforward
+2		20	attack
+2		25	attack2
+2		30	attack3
+2		35	?
+2		40	?
+2		45	?
+2		50	gethit
+2		55	pickupitem
+2		60	?
+2		65	?
+2		70	?
+2		75	idlenaim?
+2		80	idlenaim?
+2		85	idlenaim?
+2		90	eat/idlenaim?
+
+
 ]]--
 =

 --[[
@@ -167,6 +208,16 @@
 	end =

 end
 =

+gAnimFrameCountCache =3D {}
+function Anim2D_GetFrameCount (iRealID,iLoaderIndex)
+	local n =3D iRealID..","..iLoaderIndex
+	local o =3D gAnimFrameCountCache[n] =

+	if (o ~=3D nil) then return o end
+	local o =3D gAnimLoader[iLoaderIndex or 1]:GetNumberOfFrames(iRealID)
+	gAnimFrameCountCache[n] =3D o or false
+	return o
+end
+
 =

 -- returns atlaspiece
 function Anim2DAtlas_LoadAtlasPiece (iModelID,iAnimID,iFrame,iHue,iLoaderI=
ndex)
@@ -177,8 +228,10 @@
 	=

 	-- load frame image
 	local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

+	--~ local iFrameCount =3D Anim2D_GetFrameCount(iRealID,iLoaderIndex)
+	--~ iFrame =3D iFrame % iFrameCount
 	local img,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrameToI=
mage(iRealID,iFrame,iHue,iLoaderIndex)
-	if (not img) then print("Anim2DAtlas_Load : dead anim ",iModelID,iAnimID,=
iFrame,iHue) end
+	--~ if (not img) then print("Anim2DAtlas_Load : dead anim ",iModelID,iAni=
mID,iFrame,iHue) end
 	if (not img) then gAnimAtlasCache[n] =3D false return end
 		=

 	-- add to atlas
@@ -218,11 +271,16 @@
 =

 =

 function Anim_GetIdleAnim (iModelID,bHasMount)
-	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return 0 end -=
- 2+5*2=3Drat ?
-	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return 0 end -- 2+5*2=3Drat ?
+	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return 10 end
+	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return  5 end
 	return bHasMount and 125 or 20  -- Human
 	--~ return 20 -- Human
-end	=

+end
+function Anim_GetCorpseAnim (iModelID)
+	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return bForwar=
d and 15 or 10 end
+	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return 40 end -- 60?
+	return bForward and 110 or 105 -- human
+end
 =

 function Anim_GetModelCategory (iModelID)
 	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return 1 end
@@ -392,6 +450,6 @@
 -- iAnimID : 155- attack-punch?
 -- iAnimID : 160- bow
 -- iAnimID : 165- salute
--- iAnimID : 170- cough
+-- iAnimID : 170- cough/eat/drinkpot?
 ]]--
 =


Modified: trunk/src/data_anim_L.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data_anim_L.cpp (original)
+++ trunk/src/data_anim_L.cpp Thu Oct  2 23:18:53 2008
@@ -65,6 +65,7 @@
 			REGISTER_METHOD(CreateBitMask);
 			REGISTER_METHOD(GetAnimType);
 			REGISTER_METHOD(ExportToImage);
+			REGISTER_METHOD(GetNumberOfFrames);
 			#undef REGISTER_METHOD
 		}
 =

@@ -88,6 +89,15 @@
 			return cLuaBind<cBitMask>::CreateUData(L,pTarget);
 		}
 		=

+		/// returns iFrameNum on success
+		/// int		GetNumberOfFrames	(iRealID)
+		static int	GetNumberOfFrames	(lua_State *L) { PROFILE =

+			int			iRealID			=3D luaL_checkint(L,2);
+			cAnim *anim =3D checkudata_alive(L)->GetAnim( iRealID );
+			if (!anim) return 0;
+			lua_pushnumber(L,anim->GetFrames());
+			return 1;
+		}
 		=

 		/// return true on success
 		/// loads an anim frame into a Ogre::Image (lua wrapper : cImage)



From no-reply at zwischenwelt.org  Thu Oct  2 23:33:51 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 02 Oct 2008 21:33:51 -0000
Subject: [Iris-commit] [IRIS] r2497 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.mobile.lua lib.uoanim.lua
Message-ID: <20081002213351.6CC071C181B8@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct  2 23:33:50 2008
New Revision: 2497

Log:
2d corpses

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Thu Oct  2 23:33:50 2008
@@ -4,8 +4,49 @@
 	if (item.gfx2d) then item.gfx2d:Destroy() item.gfx2d =3D nil end
 	ArtAtlasUnLock(item)
 end
-function Renderer2D:AddCorpseItem					(item) =

+function Renderer2D:UpdateCorpseItemGfx				(item) =

 	print("TODO:Renderer2D:AddCorpseItem")
+	=

+	local spriteblock =3D item.gfx2d
+	if (not spriteblock) then =

+		spriteblock =3D cUOSpriteBlock:New()
+		item.gfx2d =3D spriteblock =

+	else	=

+		spriteblock:Clear()
+	end
+
+	local xloc,yloc,zloc =3D item.xloc,item.yloc,item.zloc
+	local tx,ty,tz,iIndex,fIndexRel =3D 0,0,0,0
+	local sorttx =3D xloc-floor(xloc/8)*8
+	local sortty =3D yloc-floor(yloc/8)*8
+	local sorttz =3D zloc
+	local parts =3D {}
+	item.corpsedir =3D item.corpsedir or math.random(0,7)
+	local iDirAdd,bMirrorX =3D GetAnimDirAdd(DirWrap(item.corpsedir))  -- som=
e param ? last known dir ?
+	=

+	local bodyid =3D item.amount
+	table.insert(parts,{bodyid,item.hue,13}) -- fallback=3D13=3Devortex
+	=

+	for k,v in pairs(parts) do =

+		local iModelID,iHue,iFallBackModel =3D unpack(v)
+		if iModelID then =

+			local iLoaderIndex =3D 1
+			iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
+			iIndex =3D iIndex + 1 =

+			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
+			=

+			local iAnimID =3D Anim_GetCorpseAnim(iModelID,mount) + iDirAdd
+			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID),iLoaderIndex) or 1000
+			if (iFrameCount < 1) then iFrameCount =3D 1 end
+			local iFrame =3D iFrameCount - 1
+			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del)
+			spriteblock:AddAnim(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackModel,=
iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,sortt=
z,fIndexRel,4),item) =

+		end
+	end
+	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,false)
+	=

+	local x,y,z =3D self:UOPosToLocal(item.xloc,item.yloc,item.zloc*kRenderer=
2D_ZScale)
+	item.gfx2d:SetPosition(x,y,z)
 end
 =

 function Renderer2D:UpdateDynamicBlendOut			(item,iBlendOutMinZ,iBlendOutM=
axZ) =

@@ -65,7 +106,7 @@
 function Renderer2D:AddDynamicItem					(item) =

 	if (item.artid_base =3D=3D kCorpseDynamicArtID) then
 		-- corpse
-		self:AddCorpseItem(item)
+		self:UpdateCorpseItemGfx(item)
 	elseif not item.artid then
 		print("ERROR: artid missing!!!!\n")
 	elseif item.artid >=3D gMulti_ID then =


Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Thu Oct  2 23:33:50 2008
@@ -15,7 +15,7 @@
 =

 function My2DMobileDebug (a)
 	local playermobile =3D GetPlayerMobile()
-	gMy2DMobileDebug =3D (gMy2DMobileDebug or 200) + a
+	gMy2DMobileDebug =3D (gMy2DMobileDebug or 220) + a
 	playermobile.artid =3D gMy2DMobileDebug
 	print("My2DMobileDebug",gMy2DMobileDebug)
 	Renderer2D:UpdateMobile(playermobile)

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Thu Oct  2 23:33:50 2008
@@ -271,8 +271,8 @@
 =

 =

 function Anim_GetIdleAnim (iModelID,bHasMount)
-	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return 10 end
-	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return  5 end
+	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return  5 end
+	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return 10 end
 	return bHasMount and 125 or 20  -- Human
 	--~ return 20 -- Human
 end



From no-reply at zwischenwelt.org  Fri Oct  3 02:36:33 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 00:36:33 -0000
Subject: [Iris-commit] [IRIS] r2498 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.effect.lua lib.2d.mobile.lua lib.2d.renderer.lua
 lib.2d.spriteblock.lua lib.uoanim.lua
Message-ID: <20081003003633.7DD7F1C18259@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 02:36:32 2008
New Revision: 2498

Log:
2d effects start to work (flamestrike)

Added:
    trunk/lua/lib.2d.effect.lua
Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Fri Oct  3 02:36:32 2008
@@ -40,7 +40,7 @@
 			if (iFrameCount < 1) then iFrameCount =3D 1 end
 			local iFrame =3D iFrameCount - 1
 			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del)
-			spriteblock:AddAnim(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackModel,=
iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,sortt=
z,fIndexRel,4),item) =

+			spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackM=
odel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,=
sorttz,fIndexRel,4),item) =

 		end
 	end
 	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,false)

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Fri Oct  3 02:36:32 2008
@@ -82,12 +82,12 @@
 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
 			=

-			local iAnimID =3D gMy2DMobileDebugAnim or Anim_GetIdleAnim(iModelID,mou=
nt) + iDirAdd
+			local iAnimID =3D gMy2DMobileDebugAnim or ( Anim_GetIdleAnim(iModelID,m=
ount) + iDirAdd )
 			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID),iLoaderIndex) or 1000
 			if (iFrameCount < 1) then iFrameCount =3D 1 end
 			local iFrame =3D floor((gMy2DDebugFrame or 0) / 15) % iFrameCount
 			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del)
-			spriteblock:AddAnim(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackModel,=
iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,sortt=
z,fIndexRel,4),mobile) =

+			spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackM=
odel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,=
sorttz,fIndexRel,4),mobile) =

 		end
 	end
 	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,false)

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Oct  3 02:36:32 2008
@@ -23,6 +23,7 @@
 dofile(libpath .. "lib.2d.mobile.lua")
 dofile(libpath .. "lib.2d.dynamic.lua")
 dofile(libpath .. "lib.2d.spriteblock.lua")
+dofile(libpath .. "lib.2d.effect.lua")
 =

 function Renderer2D:FirstInit ()
 	if (self.bFirstInitDone) then return end
@@ -80,6 +81,7 @@
 function Renderer2D:MainStep ()
 	self:CamStep()
 	self:MobileAnimStep()
+	self:EffectAnimStep()
 	=

 	local uodir,pixeldist =3D Get2DMouseDirAndDist()
 	=

@@ -133,7 +135,6 @@
  =

 =

 =

-function Renderer2D:AddEffect						(effectdata) end
 function Renderer2D:CamKeyDown						(key) end
 function Renderer2D:CamKeyUp						(key) end
 =


Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Fri Oct  3 02:36:32 2008
@@ -141,7 +141,21 @@
 	return 0,false
 end
 =

-function cUOSpriteBlock:AddAnim (tx,ty,tz,iTranslatedModelID,iHue,iLoaderI=
ndex,iFallBackModel,iFallBackAnim,iAnimID,iFrame,bMirrorX,sortbonus,data)
+function cUOSpriteBlock:AddAnim (tx,ty,tz,iRealID,iHue,iLoaderIndex,iFrame=
,bMirrorX,sortbonus,data)
+	iHue =3D BitwiseAND(iHue or 0,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
+	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPieceEx(iRealID,iFrame,iHue,iL=
oaderIndex)
+	print("cUOSpriteBlock:AddAnim",iRealID,iFrame,iHue,iLoaderIndex,pAtlasPie=
ce)
+--~ cUOSpriteBlock:AddAnim  14089   999     0       1       nil
+
+	if (pAtlasPiece) then
+		local sprite =3D self:AddSpriteEx(tx,ty,tz,sortbonus,data,pAtlasPiece,bM=
irrorX)
+		sprite.bMirrorX =3D bMirrorX
+		sprite.hue =3D iHue
+		return sprite
+	end
+end
+	=

+function cUOSpriteBlock:AddAnimModel (tx,ty,tz,iTranslatedModelID,iHue,iLo=
aderIndex,iFallBackModel,iFallBackAnim,iAnimID,iFrame,bMirrorX,sortbonus,da=
ta)
 	iHue =3D BitwiseAND(iHue or 0,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
 	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnim=
ID,iFrame,iHue,iLoaderIndex)
 	if (not pAtlasPiece) then
@@ -149,7 +163,7 @@
 			gMobile2DWarned =3D gMobile2DWarned or {}
 			local n =3D iTranslatedModelID..","..iAnimID
 			if (not gMobile2DWarned[n]) then gMobile2DWarned[n] =3D true
-				print("warning, Renderer2D:UpdateMobile load uoanim failed",iTranslate=
dModelID,iAnimID,iFrame,iHue,data.artid)
+				print("warning, cUOSpriteBlock:AddAnim load uoanim failed",iTranslated=
ModelID,iAnimID,iFrame,iHue)
 			end
 			iTranslatedModelID	=3D iFallBackModel -- replace unknown by standard mo=
del (13=3Devortex)
 			iAnimID				=3D iFallBackAnim

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Fri Oct  3 02:36:32 2008
@@ -221,13 +221,16 @@
 =

 -- returns atlaspiece
 function Anim2DAtlas_LoadAtlasPiece (iModelID,iAnimID,iFrame,iHue,iLoaderI=
ndex)
+	return Anim2DAtlas_LoadAtlasPieceEx(Anim_GetRealID(iModelID,iAnimID),iFra=
me,iHue,iLoaderIndex)
+end
+
+function Anim2DAtlas_LoadAtlasPieceEx (iRealID,iFrame,iHue,iLoaderIndex)
 	iLoaderIndex =3D iLoaderIndex or 1
-	local n =3D iModelID..","..iAnimID..","..iFrame..","..iHue..","..iLoaderI=
ndex
+	local n =3D iRealID..","..iFrame..","..iHue..","..iLoaderIndex
 	local o =3D gAnimAtlasCache[n]
 	if (o ~=3D nil) then return o end
 	=

 	-- load frame image
-	local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

 	--~ local iFrameCount =3D Anim2D_GetFrameCount(iRealID,iLoaderIndex)
 	--~ iFrame =3D iFrame % iFrameCount
 	local img,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrameToI=
mage(iRealID,iFrame,iHue,iLoaderIndex)



From no-reply at zwischenwelt.org  Fri Oct  3 03:39:39 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 01:39:39 -0000
Subject: [Iris-commit] [IRIS] r2499 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.effect.lua net/net.effect.lua
Message-ID: <20081003013940.175751C181F7@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 03:39:37 2008
New Revision: 2499

Log:
particle anim

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.effect.lua
    trunk/lua/net/net.effect.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Fri Oct  3 03:39:37 2008
@@ -5,8 +5,6 @@
 	ArtAtlasUnLock(item)
 end
 function Renderer2D:UpdateCorpseItemGfx				(item) =

-	print("TODO:Renderer2D:AddCorpseItem")
-	=

 	local spriteblock =3D item.gfx2d
 	if (not spriteblock) then =

 		spriteblock =3D cUOSpriteBlock:New()

Modified: trunk/lua/lib.2d.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.effect.lua (original)
+++ trunk/lua/lib.2d.effect.lua Fri Oct  3 03:39:37 2008
@@ -47,18 +47,44 @@
 	self.gEffectList[effect] =3D nil =

 end
 =

+-- magic arrow ... gfx should be turned ??
+-- kEffectType_FromSourceToDest
+--~ kPacket_Hued_FX {explodes=3D1,rendermode=3D0,duration=3D0,target_locz=
=3D0,effect_type=3D0,current_locz=3D0,speed=3D5,
+	-- current_locy=3D3578=3D0x0dfa,hue=3D0,huedeffect=3Dtrue,unkown=3D0,targ=
et_locx=3D1129=3D0x0469,current_locx=3D1125=3D0x0465,
+	-- targetserial=3D0x00051a5f,sourceserial=3D0x000dba5b,target_locy=3D3572=
=3D0x0df4,itemid=3D14052=3D0x36e4,fixeddirection=3D0,}
+--~ Renderer2D:UpdateEffectGfx A    14052   {miUnknown3=3D0,miHue=3D0,miQu=
ality=3D15=3D0x0f,miAnimID=3D0,bBackGround=3Dfalse,
+	-- iSortBonus2D=3D6,iCalcHeight=3D0,miFlags=3D0x01000000,miWeight=3D-1,mi=
Quantity=3D0,msName=3D"small fireball",bSurface=3Dfalse,
+	-- miUnknown=3D0,miHeight=3D0,miUnknown1=3D0,bBridge=3Dfalse,miUnknown2=
=3D0,}
+--~ Renderer2D:UpdateEffectGfx B    1125    3578    0       14052   table:=
 0xb322fd0        0
+
+-- flamestrike   kEffectType_FollowSource
+--~ kPacket_Hued_FX {explodes=3D0,rendermode=3D0,duration=3D30=3D0x1e,targ=
et_locz=3D0,effect_type=3D3,current_locz=3D0,
+	-- speed=3D10=3D0x0a,current_locy=3D3569=3D0x0df1,hue=3D0,huedeffect=3Dtr=
ue,unkown=3D0,
+	-- target_locx=3D1126=3D0x0466,current_locx=3D1126=3D0x0466,targetserial=
=3D0,sourceserial=3D0x00051a5f,
+	-- target_locy=3D3569=3D0x0df1,itemid=3D14089=3D0x3709,fixeddirection=3D1=
,}
+--~ Renderer2D:UpdateEffectGfx A    14089   {miUnknown3=3D0,miHue=3D0,miQu=
ality=3D30=3D0x1e,miAnimID=3D0,
+	-- bBackGround=3Dfalse,iSortBonus2D=3D6,iCalcHeight=3D0,miFlags=3D0x01800=
000,miWeight=3D-1,miQuantity=3D0,
+	-- msName=3D"fire column",bSurface=3Dfalse,miUnknown=3D0,miHeight=3D0,miU=
nknown1=3D0,bBridge=3Dfalse,miUnknown2=3D0,}
+--~ Renderer2D:UpdateEffectGfx B    1126    3569    0       14089   table:=
 0xaac2418        0
+
+
+
+k2DEffectTimeScale =3D 50
+
 function Renderer2D:UpdateEffectGfx (effect,t) =

 	if (t < effect.nextstept) then return end
-	if (t >=3D effect.endt) then self:DestroyEffect(effect) return end
+	local effectdata		=3D effect.effectdata
+	if (effectdata.duration > 0 and effect.endt > 0 and t >=3D effect.endt) t=
hen self:DestroyEffect(effect) return end
 =

-	local effectdata		=3D effect.effectdata
+	=

 	local xloc,yloc,zloc	=3D effectdata.current_locx,effectdata.current_locy,=
effectdata.current_locz
+	local xloc2,yloc2,zloc2	=3D effectdata.target_locx,effectdata.target_locy=
,effectdata.target_locz
 	local iTileTypeID		=3D effectdata.itemid
 	local iHue				=3D effectdata.hue
 	local arttype =3D GetStaticTileType(iTileTypeID)
 	--~ print("Renderer2D:UpdateEffectGfx A",iTileTypeID,arttype and SmartDum=
p(arttype))
 	if (not arttype) then return end
-	--~ print("Renderer2D:UpdateEffectGfx",xloc,yloc,zloc,effectdata.itemid,a=
rttype,arttype and arttype.miAnimID)
+	--~ print("Renderer2D:UpdateEffectGfx B",xloc,yloc,zloc,effectdata.itemid=
,arttype,arttype and arttype.miAnimID)
 	--~ if (not arttype) then return end
 	--~ local iModelID		=3D arttype.miAnimID
 	=

@@ -66,7 +92,7 @@
 	local o =3D animinfo
 	local iTileTypeBaseID	=3D iTileTypeID
 	if (o) then =

-		local iFrameInterval =3D o.miFrameInterval * 100 -- orig is in 10ths of =
seconds
+		local iFrameInterval =3D o.miFrameInterval * k2DEffectTimeScale -- orig =
is in 10ths of seconds
 		local iFrame =3D min(floor((t - effect.startt) / iFrameInterval),o.miCou=
nt)
 		effect.nextstept =3D effect.startt + iFrameInterval * (iFrame + 1)
 		iTileTypeID =3D iTileTypeBaseID + (o.miFrames[iFrame] or 0)
@@ -96,8 +122,20 @@
 		spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,CalcSortBonus(iTileTy=
peID,sorttx,sortty,sorttz,fIndexRel,1),item)
 		spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
 		local x,y,z =3D gCurrentRenderer:UOPosToLocal(xloc,yloc,zloc*kRenderer2D=
_ZScale)
+		local x2,y2,z2 =3D gCurrentRenderer:UOPosToLocal(xloc2,yloc2,zloc2*kRend=
erer2D_ZScale)
+		=

+		=

+		if (effectdata.effect_type =3D=3D kEffectType_FromSourceToDest) then
+			local dur =3D effect.dur
+			local f =3D (dur > 0) and (( t - effect.startt ) / dur) or 0
+			local fi =3D 1-f
+			x,y,z =3D fi*x+f*x2,fi*y+f*y2,fi*z+f*z
+			effect.nextstept =3D 0
+		end
+		=

 		spriteblock:SetPosition(x,y,z)
 	end
+	=

 	=

 	=

 	=

@@ -130,7 +168,11 @@
 -- kPacket_Hued_FX 0xC0
 function Renderer2D:AddEffect (effectdata) =

 	local t =3D Client_GetTicks()
-	local effect =3D { startt=3Dt, endt=3Dt+effectdata.duration * 100, nextst=
ept=3D0, effectdata=3Deffectdata }
+	if (effectdata.effect_type =3D=3D kEffectType_FromSourceToDest and effect=
data.duration =3D=3D 0) then
+		effectdata.duration =3D 10
+	end
+	local dur =3D effectdata.duration * k2DEffectTimeScale
+	local effect =3D { startt=3Dt, endt=3Dt+dur, dur=3Ddur, nextstept=3D0, ef=
fectdata=3Deffectdata }
 	self.gEffectList[effect] =3D true
 	self:UpdateEffectGfx(effect,effect.startt)
 end

Modified: trunk/lua/net/net.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.effect.lua (original)
+++ trunk/lua/net/net.effect.lua Fri Oct  3 03:39:37 2008
@@ -35,9 +35,9 @@
 			effect.itemid, effect.current_locx, effect.current_locy, effect.current=
_locz,
 			effect.target_locx, effect.target_locy, effect.target_locz, gEffectType=
s[effect.effect_type]) )
 	=

+	print("kPacket_Hued_FX",SmartDump(effect))
 	if (gParticleEffectSystem) then gCurrentRenderer:AddEffect( effect ) end
 	=

-	print("kPacket_Hued_FX",SmartDump(effect))
 	gEffectCounter =3D gEffectCounter or {}
 	gEffectCounter[effect.sourceserial] =3D gEffectCounter[effect.sourceseria=
l] or {}
 	gEffectCounter[effect.sourceserial][effect.itemid] =3D (gEffectCounter[ef=
fect.sourceserial][effect.itemid] or 0) + 1



From no-reply at zwischenwelt.org  Fri Oct  3 04:29:00 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 02:29:00 -0000
Subject: [Iris-commit] [IRIS] r2500 - in /trunk/lua: lib.2d.effect.lua
	net/net.effect.lua
Message-ID: <20081003022900.C513E1C181F7@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 04:29:00 2008
New Revision: 2500

Log:
effect bugfix : negative zloc

Modified:
    trunk/lua/lib.2d.effect.lua
    trunk/lua/net/net.effect.lua

Modified: trunk/lua/lib.2d.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.effect.lua (original)
+++ trunk/lua/lib.2d.effect.lua Fri Oct  3 04:29:00 2008
@@ -67,6 +67,11 @@
 	-- msName=3D"fire column",bSurface=3Dfalse,miUnknown=3D0,miHeight=3D0,miU=
nknown1=3D0,bBridge=3Dfalse,miUnknown2=3D0,}
 --~ Renderer2D:UpdateEffectGfx B    1126    3569    0       14089   table:=
 0xaac2418        0
 =

+-- firefield
+--~ kPacket_Hued_FX {explodes=3D0,rendermode=3D0,duration=3D10=3D0x0a,targ=
et_locz=3D166=3D0xa6,effect_type=3D2,current_locz=3D166=3D0xa6,speed=3D9=3D=
0x09,current_locy=3D158=3D0x9e,hue=3D0,huedeffect=3Dtrue,unkown=3D0,target_=
locx=3D1741=3D0x06cd,current_locx=3D1741=3D0x06cd,targetserial=3D0,sourcese=
rial=3D0,target_locy=3D158=3D0x9e,itemid=3D14186=3D0x376a,fixeddirection=3D=
1,}
+--~ kPacket_Hued_FX {explodes=3D0,rendermode=3D0,duration=3D10=3D0x0a,targ=
et_locz=3D166=3D0xa6,effect_type=3D2,current_locz=3D166=3D0xa6,speed=3D9=3D=
0x09,current_locy=3D158=3D0x9e,hue=3D0,huedeffect=3Dtrue,unkown=3D0,target_=
locx=3D1741=3D0x06cd,current_locx=3D1741=3D0x06cd,targetserial=3D0,sourcese=
rial=3D0,target_locy=3D158=3D0x9e,itemid=3D14186=3D0x376a,fixeddirection=3D=
1,}
+--~ Renderer2D:UpdateEffectGfx A    14186   {miUnknown3=3D0,miHue=3D0,miQu=
ality=3D14=3D0x0e,miAnimID=3D0,bBackGround=3Dfalse,iSortBonus2D=3D6,iCalcHe=
ight=3D0,miFlags=3D0x01000000,miWeight=3D-1,miQuantity=3D0,msName=3D"sparkl=
e",bSurface=3Dfalse,miUnknown=3D0,miHeight=3D0,miUnknown1=3D0,bBridge=3Dfal=
se,miUnknown2=3D0,}
+--~ Renderer2D:UpdateEffectGfx B    1741    158     166     14186   table:=
 0xbb8b838        0
 =

 =

 k2DEffectTimeScale =3D 50
@@ -93,8 +98,9 @@
 	local iTileTypeBaseID	=3D iTileTypeID
 	if (o) then =

 		local iFrameInterval =3D o.miFrameInterval * k2DEffectTimeScale -- orig =
is in 10ths of seconds
-		local iFrame =3D min(floor((t - effect.startt) / iFrameInterval),o.miCou=
nt)
+		local iFrame =3D floor((t - effect.startt) / iFrameInterval),o.miCount
 		effect.nextstept =3D effect.startt + iFrameInterval * (iFrame + 1)
+		iFrame =3D iFrame % o.miCount
 		iTileTypeID =3D iTileTypeBaseID + (o.miFrames[iFrame] or 0)
 		-- o.miFrames,o.miUnknown,o.miCount,o.miFrameInterval,o.miFrameStart
 		--~ print("Renderer2D:UpdateEffectGfx info",o.miUnknown,o.miCount,o.miFr=
ameInterval,o.miFrameStart)
@@ -167,6 +173,7 @@
 =

 -- kPacket_Hued_FX 0xC0
 function Renderer2D:AddEffect (effectdata) =

+	--~ print("Renderer2D:AddEffect",SmartDump(effectdata))
 	local t =3D Client_GetTicks()
 	if (effectdata.effect_type =3D=3D kEffectType_FromSourceToDest and effect=
data.duration =3D=3D 0) then
 		effectdata.duration =3D 10

Modified: trunk/lua/net/net.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.effect.lua (original)
+++ trunk/lua/net/net.effect.lua Fri Oct  3 04:29:00 2008
@@ -16,11 +16,11 @@
 	=

 	effect.current_locx =3D input:PopNetUint16()
 	effect.current_locy =3D input:PopNetUint16()
-	effect.current_locz =3D input:PopNetUint8()
+	effect.current_locz =3D input:PopNetInt8()
 	=

 	effect.target_locx =3D input:PopNetUint16()
 	effect.target_locy =3D input:PopNetUint16()
-	effect.target_locz =3D input:PopNetUint8()
+	effect.target_locz =3D input:PopNetInt8()
 =

 	effect.speed =3D input:PopNetUint8()	-- animation speed?
 	effect.duration =3D input:PopNetUint8()
@@ -35,7 +35,7 @@
 			effect.itemid, effect.current_locx, effect.current_locy, effect.current=
_locz,
 			effect.target_locx, effect.target_locy, effect.target_locz, gEffectType=
s[effect.effect_type]) )
 	=

-	print("kPacket_Hued_FX",SmartDump(effect))
+	--~ print("kPacket_Hued_FX",SmartDump(effect))
 	if (gParticleEffectSystem) then gCurrentRenderer:AddEffect( effect ) end
 	=

 	gEffectCounter =3D gEffectCounter or {}



From no-reply at zwischenwelt.org  Fri Oct  3 04:37:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 02:37:03 -0000
Subject: [Iris-commit] [IRIS] r2501 - /trunk/lua/lib.2d.dynamic.lua
Message-ID: <20081003023703.78AE51C18678@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 04:37:03 2008
New Revision: 2501

Log:
2d : dynamics are not yet animated, but i added a little hack to make paral=
yze field somehwat visible : using the middle of the animation

Modified:
    trunk/lua/lib.2d.dynamic.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Fri Oct  3 04:37:03 2008
@@ -111,22 +111,32 @@
 		-- multi
 		self:UpdateMultiItemGfx(item)
 	else
-		local spriteblock =3D cUOSpriteBlock:New()
-		item.gfx2d =3D spriteblock
-		=

-		local xloc =3D item.xloc
-		local yloc =3D item.yloc
-		local zloc =3D item.zloc
-		local tx,ty,tz,fIndexRel =3D 0,0,0,0
-		local sorttx =3D xloc-floor(xloc/8)*8
-		local sortty =3D yloc-floor(yloc/8)*8
-		local sorttz =3D zloc
 		local iTileTypeID	=3D item.artid
-		local iHue			=3D item.hue
-		spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,CalcSortBonus(iTileTy=
peID,sorttx,sortty,sorttz,fIndexRel,1),item)
-		spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
-		local x,y,z =3D gCurrentRenderer:UOPosToLocal(xloc,yloc,zloc*kRenderer2D=
_ZScale)
-		spriteblock:SetPosition(x,y,z)
+		if (iTileTypeID > 1) then -- 1 =3D=3D nodraw =

+			local spriteblock =3D cUOSpriteBlock:New()
+			item.gfx2d =3D spriteblock
+			=

+			=

+			local animinfo =3D GetAnimDataInfo(iTileTypeID)
+			if (animinfo) then
+				if (animinfo.miCount > 1) then
+					iTileTypeID =3D iTileTypeID + (animinfo.miFrames[floor(animinfo.miCou=
nt/2)] or 0)
+				end
+			end
+			=

+			local xloc =3D item.xloc
+			local yloc =3D item.yloc
+			local zloc =3D item.zloc
+			local tx,ty,tz,fIndexRel =3D 0,0,0,0
+			local sorttx =3D xloc-floor(xloc/8)*8
+			local sortty =3D yloc-floor(yloc/8)*8
+			local sorttz =3D zloc
+			local iHue			=3D item.hue
+			spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,CalcSortBonus(iTileT=
ypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
+			spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
+			local x,y,z =3D gCurrentRenderer:UOPosToLocal(xloc,yloc,zloc*kRenderer2=
D_ZScale)
+			spriteblock:SetPosition(x,y,z)
+		end
 	end
 end
 =




From no-reply at zwischenwelt.org  Fri Oct  3 05:01:07 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 03:01:07 -0000
Subject: [Iris-commit] [IRIS] r2502 - in /trunk/lua: lib.2d.effect.lua
	lib.2d.renderer.lua
Message-ID: <20081003040014.84A181C18042@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 05:01:04 2008
New Revision: 2502

Log:
effects moving with mobs

Modified:
    trunk/lua/lib.2d.effect.lua
    trunk/lua/lib.2d.renderer.lua

Modified: trunk/lua/lib.2d.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.effect.lua (original)
+++ trunk/lua/lib.2d.effect.lua Fri Oct  3 05:01:04 2008
@@ -73,31 +73,53 @@
 --~ Renderer2D:UpdateEffectGfx A    14186   {miUnknown3=3D0,miHue=3D0,miQu=
ality=3D14=3D0x0e,miAnimID=3D0,bBackGround=3Dfalse,iSortBonus2D=3D6,iCalcHe=
ight=3D0,miFlags=3D0x01000000,miWeight=3D-1,miQuantity=3D0,msName=3D"sparkl=
e",bSurface=3Dfalse,miUnknown=3D0,miHeight=3D0,miUnknown1=3D0,bBridge=3Dfal=
se,miUnknown2=3D0,}
 --~ Renderer2D:UpdateEffectGfx B    1741    158     166     14186   table:=
 0xbb8b838        0
 =

+-- lightning =

+--~ Renderer2D:AddEffect    {explodes=3D0,rendermode=3D0,duration=3D0,targ=
et_locz=3D7,effect_type=3D1,current_locz=3D7,speed=3D0,current_locy=3D2437=
=3D0x0985,hue=3D0,
+	--huedeffect=3Dtrue,unkown=3D0,target_locx=3D1827=3D0x0723,current_locx=
=3D1827=3D0x0723,targetserial=3D0,
+		-- sourceserial=3D0x000dba5b,target_locy=3D2437=3D0x0985,itemid=3D0,fixe=
ddirection=3D0,}
+--~ Renderer2D:UpdateEffectGfx A    0       {miUnknown3=3D0,miHue=3D0,miQu=
ality=3D0,miAnimID=3D0,bBackGround=3Dfalse,
+	--iSortBonus2D=3D6,iCalcHeight=3D0,miFlags=3D0,miWeight=3D0,miQuantity=3D=
0,msName=3D"MissingName",bSurface=3Dfalse,miUnknown=3D0,miHeight=3D0,
+		--miUnknown1=3D0,bBridge=3Dfalse,miUnknown2=3D0,}
+--~ Renderer2D:UpdateEffectGfx B    1827    2437    7       0       table:=
 0xb154fe8        0
+
 =

 k2DEffectTimeScale =3D 50
 =

 function Renderer2D:UpdateEffectGfx (effect,t) =

 	if (t < effect.nextstept) then return end
 	local effectdata		=3D effect.effectdata
-	if (effectdata.duration > 0 and effect.endt > 0 and t >=3D effect.endt) t=
hen self:DestroyEffect(effect) return end
-
+	if (t >=3D effect.endt) then self:DestroyEffect(effect) return end
+
+	=

+	local mob_source =3D GetMobile(effectdata.sourceserial)
+	if mob_source then effectdata.current_locx,effectdata.current_locy,effect=
data.current_locz =3D mob_source.xloc,mob_source.yloc,mob_source.zloc end
+	local mob_target =3D GetMobile(effectdata.targetserial)
+	if mob_target then effectdata.target_locx,effectdata.target_locy,effectda=
ta.target_locz =3D mob_target.xloc,mob_target.yloc,mob_target.zloc end
 	=

 	local xloc,yloc,zloc	=3D effectdata.current_locx,effectdata.current_locy,=
effectdata.current_locz
 	local xloc2,yloc2,zloc2	=3D effectdata.target_locx,effectdata.target_locy=
,effectdata.target_locz
+	=

+	=

+	=

+	=

 	local iTileTypeID		=3D effectdata.itemid
 	local iHue				=3D effectdata.hue
-	local arttype =3D GetStaticTileType(iTileTypeID)
+	--~ local arttype =3D GetStaticTileType(iTileTypeID)
 	--~ print("Renderer2D:UpdateEffectGfx A",iTileTypeID,arttype and SmartDum=
p(arttype))
-	if (not arttype) then return end
+	--~ if (not arttype) then return end
 	--~ print("Renderer2D:UpdateEffectGfx B",xloc,yloc,zloc,effectdata.itemid=
,arttype,arttype and arttype.miAnimID)
 	--~ if (not arttype) then return end
 	--~ local iModelID		=3D arttype.miAnimID
+	=

+	if (iTileTypeID =3D=3D 0 and effectdata.effect_type =3D=3D kEffectType_Li=
ghtningStrikeAtSource) then
+		iTileTypeID =3D 0x3967 -- couldn't find out how lightning effect is supp=
osed to work, so we use paralyse field for now
+	end
 	=

 	local animinfo =3D GetAnimDataInfo(iTileTypeID)
 	local o =3D animinfo
 	local iTileTypeBaseID	=3D iTileTypeID
 	if (o) then =

-		local iFrameInterval =3D o.miFrameInterval * k2DEffectTimeScale -- orig =
is in 10ths of seconds
+		local iFrameInterval =3D o.miFrameInterval * k2DEffectTimeScale / (effec=
tdata.fastspeed or 1)-- orig is in 10ths of seconds
 		local iFrame =3D floor((t - effect.startt) / iFrameInterval),o.miCount
 		effect.nextstept =3D effect.startt + iFrameInterval * (iFrame + 1)
 		iFrame =3D iFrame % o.miCount
@@ -120,7 +142,7 @@
 	end
 	=

 	=

-	if (arttype.miAnimID =3D=3D 0) then
+	--~ if ((not arttype) or arttype.miAnimID =3D=3D 0) then
 		local tx,ty,tz,fIndexRel =3D 0,0,0,0
 		local sorttx =3D xloc-floor(xloc/8)*8
 		local sortty =3D yloc-floor(yloc/8)*8
@@ -140,7 +162,7 @@
 		end
 		=

 		spriteblock:SetPosition(x,y,z)
-	end
+	--~ end
 	=

 	=

 	=

@@ -178,6 +200,10 @@
 	if (effectdata.effect_type =3D=3D kEffectType_FromSourceToDest and effect=
data.duration =3D=3D 0) then
 		effectdata.duration =3D 10
 	end
+	if (effectdata.effect_type =3D=3D kEffectType_LightningStrikeAtSource and=
 effectdata.duration =3D=3D 0) then
+		effectdata.duration =3D 10
+		effectdata.fastspeed =3D 2
+	end
 	local dur =3D effectdata.duration * k2DEffectTimeScale
 	local effect =3D { startt=3Dt, endt=3Dt+dur, dur=3Ddur, nextstept=3D0, ef=
fectdata=3Deffectdata }
 	self.gEffectList[effect] =3D true

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Oct  3 05:01:04 2008
@@ -81,7 +81,6 @@
 function Renderer2D:MainStep ()
 	self:CamStep()
 	self:MobileAnimStep()
-	self:EffectAnimStep()
 	=

 	local uodir,pixeldist =3D Get2DMouseDirAndDist()
 	=

@@ -127,6 +126,7 @@
 		if (dx ~=3D 0 or dy ~=3D 0) then self:SetCamPos(xloc+dx,yloc+dy) end
 	end
 =

+	self:EffectAnimStep() -- should be after player pos is updated, for effec=
ts moving with player
 	self:MapStep()
 end
 =




From no-reply at zwischenwelt.org  Fri Oct  3 19:22:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 17:22:28 -0000
Subject: [Iris-commit] [IRIS] r2503 - in /trunk/lua: lib.2d.cam.lua
 lib.2d.effect.lua lib.2d.hudfx.lua lib.2d.renderer.lua net/net.mobile.lua
 widgets/widget.uotext.lua
Message-ID: <20081003172228.9067E1C1877C@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 19:22:28 2008
New Revision: 2503

Log:
2d : moving particles : height corrected, 2d : damage numbers popping up

Added:
    trunk/lua/lib.2d.hudfx.lua
Modified:
    trunk/lua/lib.2d.cam.lua
    trunk/lua/lib.2d.effect.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/widgets/widget.uotext.lua

Modified: trunk/lua/lib.2d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.cam.lua (original)
+++ trunk/lua/lib.2d.cam.lua Fri Oct  3 19:22:28 2008
@@ -101,7 +101,7 @@
 	self.fCamPosZLoc =3D zloc or 0
 	local px,py,pz =3D Quaternion.ApplyToVector(0,0,self.fCamDist,unpack(self=
.qCamRot))
 	local x,y,z =3D self:UOPosToLocal(xloc,yloc,zloc or 0)
-	GetMainCam():SetPos(px+x,py+y,pz+z*0.1)
+	GetMainCam():SetPos(px+x,py+y,pz+z*kRenderer2D_ZScale)
 end
 =

 function Renderer2D:CamStep						() =


Modified: trunk/lua/lib.2d.effect.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.effect.lua (original)
+++ trunk/lua/lib.2d.effect.lua Fri Oct  3 19:22:28 2008
@@ -1,4 +1,6 @@
 Renderer2D.gEffectList =3D {}
+
+Renderer2D.kMovingEffectZAdd =3D 15
 =

 	--[[
 	kEffectType_FromSourceToDest =3D 0
@@ -157,7 +159,7 @@
 			local dur =3D effect.dur
 			local f =3D (dur > 0) and (( t - effect.startt ) / dur) or 0
 			local fi =3D 1-f
-			x,y,z =3D fi*x+f*x2,fi*y+f*y2,fi*z+f*z
+			x,y,z =3D fi*x+f*x2,fi*y+f*y2,fi*z+f*z + self.kMovingEffectZAdd*kRender=
er2D_ZScale
 			effect.nextstept =3D 0
 		end
 		=


Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Oct  3 19:22:28 2008
@@ -24,6 +24,7 @@
 dofile(libpath .. "lib.2d.dynamic.lua")
 dofile(libpath .. "lib.2d.spriteblock.lua")
 dofile(libpath .. "lib.2d.effect.lua")
+dofile(libpath .. "lib.2d.hudfx.lua")
 =

 function Renderer2D:FirstInit ()
 	if (self.bFirstInitDone) then return end
@@ -128,12 +129,8 @@
 =

 	self:EffectAnimStep() -- should be after player pos is updated, for effec=
ts moving with player
 	self:MapStep()
+	self:HUDFX_MainStep()
 end
-
- =

- =

- =

-
 =

 function Renderer2D:CamKeyDown						(key) end
 function Renderer2D:CamKeyUp						(key) end
@@ -176,7 +173,6 @@
 function Renderer2D:SelectMobile				() end
 function Renderer2D:DeselectMobile				() end
 function Renderer2D:UpdateTrackingArrow			(...) end -- tracking skill, not=
 yet implemented
-function Renderer2D:NotifyDamage				(olddamage_serial,olddamage_amount) end
 function Renderer2D:NotifyHPChange				(mobile, value) end
 function Renderer2D:NotifyManaChange			(mobile, value) end
 function Renderer2D:NotifyPlayerTeleported		() end

Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Fri Oct  3 19:22:28 2008
@@ -322,16 +322,16 @@
 		for mobileserial,arr in pairs(gAnimCounter or {}) do
 			for m_animation,count in pairs(arr) do
 				if (mobileserial ~=3D GetPlayerSerial() and m_animation =3D=3D 0x00000=
014) then hits =3D hits + count end
-				printf("anim mob=3D0x%08x(%s) anim=3D0x%08x count=3D%d\n",mobileserial=
,(mobileserial =3D=3D GetPlayerSerial()) and "self" or "other",m_animation,=
count)
+				--~ printf("anim mob=3D0x%08x(%s) anim=3D0x%08x count=3D%d\n",mobilese=
rial,(mobileserial =3D=3D GetPlayerSerial()) and "self" or "other",m_animat=
ion,count)
 			end
 		end
 		for mobileserial,arr in pairs(gEffectCounter or {}) do
 			for effectid,count in pairs(arr) do
 				if (mobileserial ~=3D GetPlayerSerial() and effectid =3D=3D 0x37b9) th=
en blockedhits =3D blockedhits + count end
-				printf("effect mob=3D0x%08x(%s) effectid=3D0x%08x count=3D%d\n",mobile=
serial,(mobileserial =3D=3D GetPlayerSerial()) and "self" or "other",effect=
id,count)
-			end
-		end
-		printf("#### swings:%d hits:%d blockedhits:%d timesincelast=3D%d\n",swin=
gs,hits,blockedhits,timesincelast)
+				--~ printf("effect mob=3D0x%08x(%s) effectid=3D0x%08x count=3D%d\n",mo=
bileserial,(mobileserial =3D=3D GetPlayerSerial()) and "self" or "other",ef=
fectid,count)
+			end
+		end
+		--~ printf("#### swings:%d hits:%d blockedhits:%d timesincelast=3D%d\n",=
swings,hits,blockedhits,timesincelast)
 	end
 	=

 	gSwingCounter =3D gSwingCounter or {}

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Fri Oct  3 19:22:28 2008
@@ -22,9 +22,11 @@
 	if (params.scrollbar) then params.default_black =3D false end -- when scr=
ollbar is on, default to white (probably on dark background?)
 	if (not params.crop) then params.autowrap_w =3D params.width end
 	local bParseHTML =3D params.html
+	local text =3D params.text
+	params.text =3D nil
 	gWidgetPrototype.Text.Init(self,parentwidget,params)
 	self:SetIgnoreBBoxHit(true)
-	self:SetUOHtml(params.textline_id and textlines[params.textline_id] or (g=
ClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_cliloc"),bParse=
HTML)
+	self:SetUOHtml(text or (params.textline_id and textlines[params.textline_=
id]) or (gClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_clilo=
c"),bParseHTML)
 	--~ self:SetPos(params.x,params.y)
 	local xoff,yoff =3D -1,-2
 	self:SetPos(params.x+xoff,params.y+yoff)



From no-reply at zwischenwelt.org  Fri Oct  3 23:26:05 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 21:26:05 -0000
Subject: [Iris-commit] [IRIS] r2504 - in /trunk/lua: lib.2d.hudfx.lua
	lib.2d.mobile.lua net.walk.lua
Message-ID: <20081003212605.7EB411C1877C@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 23:26:05 2008
New Revision: 2504

Log:
2d : fixed vampform and ghost mobile gfx,  improved walkcode to avoid reque=
st pileup

Modified:
    trunk/lua/lib.2d.hudfx.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/net.walk.lua

Modified: trunk/lua/lib.2d.hudfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.hudfx.lua (original)
+++ trunk/lua/lib.2d.hudfx.lua Fri Oct  3 23:26:05 2008
@@ -44,9 +44,11 @@
 	if (hudfx.mob and hudfx.gfx) then
 		local mobile =3D hudfx.mob
 		local px,py =3D self:UOPosToPixelPos(mobile.xloc,mobile.yloc,mobile.zloc=
+hudfx.zadd)
-		local dur =3D hudfx.dur
-		local ft =3D min(dur,t - hudfx.startt) / dur
-		hudfx.gfx:SetPos(px,py - sqrt(ft)*hudfx.riseh)
+		if (px) then =

+			local dur =3D hudfx.dur
+			local ft =3D min(dur,t - hudfx.startt) / dur
+			hudfx.gfx:SetPos(px,py - sqrt(ft)*hudfx.riseh)
+		end
 	end
 end
 =


Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Fri Oct  3 23:26:05 2008
@@ -61,11 +61,14 @@
 	--~ table.insert(parts,{self:GetMobileMountModelAndHue(mobile)}) -- kLaye=
r_Mount
 	if (mount) then table.insert(parts,{gMountTranslate2D[mount.artid],mount.=
hue,gStandardHorse}) end
 	=

-	table.insert(parts,{mobile.artid,mobile.hue,13}) -- fallback=3D13=3Devort=
ex
-	if (mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401) then -- only huma=
ns have equip
+	if (mobile.artid ~=3D 402 and
+		mobile.artid ~=3D 403) then table.insert(parts,{mobile.artid,mobile.hue,=
13}) end -- fallback=3D13=3Devortex  402=3Dghost
+	--~ print("######### mobart",mobile.artid)
+	if (Anim_GetModelCategory(mobile.artid) =3D=3D 3) then -- only humans hav=
e equip
 		for index,layer in pairs(gLayerOrder) do =

 			local item =3D GetMobileEquipmentItem(mobile,layer)
 			if (item) then =

+				--~ print("######### equip",layer,item.artid)
 				local t =3D GetStaticTileType(item.artid)
 				local iFallBackModel
 				if (layer =3D=3D kLayer_TorsoOuter) then iFallBackModel =3D 469 end --=
 standard robe

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Fri Oct  3 23:26:05 2008
@@ -87,7 +87,6 @@
 function FastWalk_CountKeys	()			return table.getn(gFastwalkStack) end
 =

 =

-
 -- returns x,y,z :  absolute tilepos =3D blockpos*8 + reltilepos[0-7]   z =
as int (not multiplied by 0.1 yet)
 function GetPlayerPos () return gPlayerXLoc,gPlayerYLoc,gPlayerZLoc end
 function GetPlayerDir () return gPlayerDir end
@@ -161,10 +160,16 @@
 									(	bRunFlag and gWalkTimeout_RunningSpeed		or gWalkTimeout_MovingS=
peed)
 end
 =

+-- returns false if the walk queue is full and the next request should wait
+function WalkQueueOkForNextSend ()
+	return countarr(gWalkRequests) <=3D 1
+end
+	=

 -- internal, don't call directly, no check for walkable, only checks for t=
ime
 function ExecWalkRequestIfPossible	(iDir,bRunFlag)
 	if (not Walk_RequestTimeOk()) then return end
 	if (not FastWalk_Ok()) then return end
+	if ((not gFastWalkKeysUsed) and (not WalkQueueOkForNextSend())) then retu=
rn end
 	iDir =3D DirWrap(iDir)
 	local iFullDir =3D BitwiseOR(iDir,bRunFlag and kWalkFlag_Run or 0) -- inc=
ludes runflag
 	=




From no-reply at zwischenwelt.org  Fri Oct  3 23:43:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 21:43:42 -0000
Subject: [Iris-commit] [IRIS] r2505 - in /trunk/lua: lib.3d.mousepick.lua
 lib.mapblock.3d.multis.lua net/net.multi.lua
Message-ID: <20081003214343.0B6621C1876C@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct  3 23:43:41 2008
New Revision: 2505

Log:
3d : fixed multi mousepicking when blending out upper floors

Modified:
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.mapblock.3d.multis.lua
    trunk/lua/net/net.multi.lua

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Fri Oct  3 23:43:41 2008
@@ -44,17 +44,19 @@
 	-- multi mousepicking
 	for k,v in pairs(gMultis) do
 		for kk,vv in pairs(k.lparts) do
-			if vv.mousepick then
-				bHit,fHitDist =3D vv.mousepick.meshbuffer:RayPick(rx,ry,rz,rvx,rvy,rvz,
-					vv.mousepick.x,vv.mousepick.y,vv.mousepick.z,
-					vv.mousepick.qw,vv.mousepick.qx,vv.mousepick.qy,vv.mousepick.qz,
-					vv.mousepick.sx,vv.mousepick.sy,vv.mousepick.sz)
+			local iTileTypeID,xloc,yloc,zloc,iHue =3D unpack(vv) -- see Multi_AddPa=
rtHelper
+			local mousepickdata =3D vv.multi_mousepick -- see cMapBlock_3D_Multis:W=
orkStep_LoadDetail
+			if mousepickdata and self:IsZLayerVisible(zloc) then  =

+				bHit,fHitDist =3D mousepickdata.meshbuffer:RayPick(rx,ry,rz,rvx,rvy,rv=
z,
+					mousepickdata.x,mousepickdata.y,mousepickdata.z,
+					mousepickdata.qw,mousepickdata.qx,mousepickdata.qy,mousepickdata.qz,
+					mousepickdata.sx,mousepickdata.sy,mousepickdata.sz)
 =

 				if (bHit and ((not gMousePickFoundHit) or fHitDist < self.gMousePickFo=
undDist)) then
 					self.gMousePickFoundDist =3D fHitDist
 					gMousePickFoundHit =3D {}
 					gMousePickFoundHit.hittype =3D kMousePickHitType_Static
-					gMousePickFoundHit.entity =3D vv.mousepick
+					gMousePickFoundHit.entity =3D mousepickdata
 					--entity has to have the following properties: hue, x, y, z, iTileTyp=
eID
 				end
 			end

Modified: trunk/lua/lib.mapblock.3d.multis.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.multis.lua (original)
+++ trunk/lua/lib.mapblock.3d.multis.lua Fri Oct  3 23:43:41 2008
@@ -70,7 +70,7 @@
 				iBlockX =3D math.floor(x/8), iBlockY =3D math.floor(y/8),
 			}
 		=

-			v.mousepick =3D mousepick
+			v.multi_mousepick =3D mousepick
 		end
 =

 		self:YieldIfOverTime()		=


Modified: trunk/lua/net/net.multi.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.multi.lua (original)
+++ trunk/lua/net/net.multi.lua Fri Oct  3 23:43:41 2008
@@ -408,7 +408,7 @@
 				iBlockX =3D math.floor(x/8), iBlockY =3D math.floor(y/8),
 			}
 			=

-			v.mousepick =3D mousepick
+			v.multi_mousepick =3D mousepick
 		end
 	end
 =




From no-reply at zwischenwelt.org  Sat Oct  4 00:39:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 22:39:59 -0000
Subject: [Iris-commit] [IRIS] r2506 - /trunk/lua/lib.macrolist.lua
Message-ID: <20081003223959.5B7911C1876C@zwischenwelt.org>

Author: hagish
Date: Sat Oct  4 00:39:58 2008
New Revision: 2506

Log:
macro command to display timeout: Macro_ShowTimeout (x,y,w,h,text,color,tim=
eout)

Modified:
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Oct  4 00:39:58 2008
@@ -594,3 +594,32 @@
 function MacroGetSerialUnderMouse	()
 	return GetMouseHitSerial(true)
 end
+
+
+-- color is #000000 format, timeout in ms
+function Macro_ShowTimeout (x,y,w,h,text,color,timeout)
+	if timeout > 0 then
+		local params =3D {
+			gfxparam_bar =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureG=
UIMat("ray_border.png"),32,32, 0,0, 0,0, 1,30,1, 1,30,1, 32,32, 1,1, false,=
 false),
+			gfxparam_background =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainT=
extureGUIMat("ray_border_black.png"),32,32, 0,0, 0,0, 1,30,1, 1,30,1, 32,32=
, 1,1, false, false),
+		}
+		=

+		local progress =3D GetDesktopWidget():CreateChild("Bar",params)
+		progress:SetLeftTop(x,y)
+		progress:SetSize(w,h)
+		progress:SetProgress(0)
+		progress:CreateContentChild("UOText",{text=3D"<BASEFONT COLOR=3D"..color=
..">"..text.."</BASEFONT>",x=3D5,y=3D-2,width=3Dw,height=3Dh,background=3D0=
,scrollbar=3D0,bold=3Dfalse,crop=3Dfalse,html=3Dtrue})
+		=

+		local startt =3D Client_GetTicks()
+		=

+		job.create(function()
+			local p =3D 0
+			repeat
+				p =3D Clamp((Client_GetTicks() - startt) / timeout, 0, 1)
+				progress:SetProgress(p)
+				job.wait(10)
+			until p =3D=3D 1
+			progress:Destroy()
+		end)
+	end
+end



From no-reply at zwischenwelt.org  Sat Oct  4 01:57:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 03 Oct 2008 23:57:25 -0000
Subject: [Iris-commit] [IRIS] r2507 - in /trunk/lua: config_declarations.lua
 lib.2d.renderer.lua lib.3d.renderer.lua lib.keybinds.lua
 lib.null.renderer.lua lib.renderer.lua main.lua
Message-ID: <20081004000004.2C5771C1876C@zwischenwelt.org>

Author: hagish
Date: Sat Oct  4 01:57:24 2008
New Revision: 2507

Log:
first version of null renderer

Added:
    trunk/lua/lib.null.renderer.lua
Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.keybinds.lua
    trunk/lua/lib.renderer.lua
    trunk/lua/main.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sat Oct  4 01:57:24 2008
@@ -496,5 +496,3 @@
 		--~ ConfigSetGlobal(n,v)
 		--~ print("RegisterListener",n,v)
 	end)
-
-gCurrentRenderer =3D Renderer3D	-- Renderer2D

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Sat Oct  4 01:57:24 2008
@@ -6,6 +6,8 @@
 -- RegisterListener("Hook_Bla",function (param) end)
 =

 Renderer2D =3D {}
+
+gRendererList[ "Renderer2D" ] =3D Renderer2D
 =

 Renderer2D.kSpriteBaseMaterial =3D "renderer2dbillboard"
 kSq2					=3D math.sqrt(2)

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Sat Oct  4 01:57:24 2008
@@ -16,7 +16,7 @@
 dofile(libpath .. "lib.3d.multispawner.lua")
 dofile(libpath .. "lib.3d.waterspawner.lua")
 =

-gRendererList[ "Renderer3d" ] =3D Renderer3D
+gRendererList[ "Renderer3D" ] =3D Renderer3D
 =

 -- static Factor to rise the Z-Level for statics+dynamics
 Renderer3D.gZ_Factor =3D 0.01 --0.0090

Modified: trunk/lua/lib.keybinds.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.keybinds.lua (original)
+++ trunk/lua/lib.keybinds.lua Sat Oct  4 01:57:24 2008
@@ -11,21 +11,21 @@
 		end
 	end)
 	=

-	Bind("f7", function (state) =

-		if (state > 0) then
-			local playermobile =3D GetPlayerMobile()
-			local x,y,z =3D playermobile.xloc,playermobile.yloc,playermobile.zloc
-			=

-			for k,dynamic in pairs(GetDynamicList()) do
-				if (DynamicIsInWorld(dynamic)) then
-					local d =3D dist2(x,y,dynamic.xloc,dynamic.yloc)
-					if (d < 5) then
-						print("TELESEARCH",d,dynamic.artid,dynamic.artid_base,GetMeshName(dy=
namic.artid),GetStaticTileTypeName(dynamic.artid))
-					end
-				end
-			end
-		end
-	end)
+	--~ Bind("f7", function (state) =

+		--~ if (state > 0) then
+			--~ local playermobile =3D GetPlayerMobile()
+			--~ local x,y,z =3D playermobile.xloc,playermobile.yloc,playermobile.zl=
oc
+			--~ =

+			--~ for k,dynamic in pairs(GetDynamicList()) do
+				--~ if (DynamicIsInWorld(dynamic)) then
+					--~ local d =3D dist2(x,y,dynamic.xloc,dynamic.yloc)
+					--~ if (d < 5) then
+						--~ print("TELESEARCH",d,dynamic.artid,dynamic.artid_base,GetMeshNam=
e(dynamic.artid),GetStaticTileTypeName(dynamic.artid))
+					--~ end
+				--~ end
+			--~ end
+		--~ end
+	--~ end)
 	=

 	Bind("f12", function (state) if (state > 0) then
 		if gKeyPressed[key_lshift] then

Modified: trunk/lua/lib.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.renderer.lua (original)
+++ trunk/lua/lib.renderer.lua Sat Oct  4 01:57:24 2008
@@ -8,7 +8,26 @@
 end
 =

 function ActivateNextRenderer ()
-	ActivateRenderer((gCurrentRenderer =3D=3D Renderer3D) and Renderer2D or R=
enderer3D)
+	-- search for the next renderer
+	local takenext =3D false
+	for k,v in pairs(gRendererList) do
+		if takenext then
+			gCurrentRenderer =3D v
+			ActivateRenderer(gCurrentRenderer)
+			return
+		end
+		=

+		if v =3D=3D gCurrentRenderer then
+			takenext =3D true
+		end
+	end
+	=

+	-- no next found so take the first one
+	for k,v in pairs(gRendererList) do
+		gCurrentRenderer =3D v
+		ActivateRenderer(gCurrentRenderer)
+		return
+	end
 end
 =

 function ActivateRenderer (newrenderer)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Oct  4 01:57:24 2008
@@ -39,6 +39,7 @@
 =

 dofile(libpath .. "lib.3d.renderer.lua")
 dofile(libpath .. "lib.2d.renderer.lua")
+dofile(libpath .. "lib.null.renderer.lua")
 =

 dofile(libpath .. "lib.renderer.lua")
 dofile(libpath .. "lib.uoids.lua")
@@ -291,6 +292,8 @@
 	HandleCommandLine()
 	=

 	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end
+
+	gCurrentRenderer =3D Renderer3D
 	if (gCommandLineSwitches["-2d"]) then gCurrentRenderer =3D Renderer2D end
 	if (gCommandLineSwitches["-3d"]) then gCurrentRenderer =3D Renderer3D end
 	=




From no-reply at zwischenwelt.org  Sat Oct  4 03:21:52 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 04 Oct 2008 01:21:52 -0000
Subject: [Iris-commit] [IRIS] r2508 - in /trunk: data/ lua/ lua/net/
Message-ID: <20081004020008.5CC141C1877B@zwischenwelt.org>

Author: hagish
Date: Sat Oct  4 03:21:51 2008
New Revision: 2508

Log:
switching renderer during runtime starts to work -> ctrl+r

Modified:
    trunk/data/mymacros.lua.dist
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.3d.mobile.lua
    trunk/lua/lib.3d.multispawner.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.mapblock.scheduler.lua
    trunk/lua/lib.mapblock.spawner.lua
    trunk/lua/lib.null.renderer.lua
    trunk/lua/lib.renderer.lua
    trunk/lua/lib.terrain.multitex.lua
    trunk/lua/lib.tilefreewalk.lua
    trunk/lua/main.lua
    trunk/lua/net/net.login.lua

Modified: trunk/data/mymacros.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/mymacros.lua.dist (original)
+++ trunk/data/mymacros.lua.dist Sat Oct  4 03:21:51 2008
@@ -56,7 +56,7 @@
 SetMacro("q",			function() MacroCmd_SelectNearestMobile() end)
 SetMacro("e",			function() MacroCmd_SelectNextMobile() end)
 --SetMacro("space",		function() MacroCmd_AttackSelectedMobile() end) -- cu=
rrently broken
---SetMacro("z",			function() MacroCmd_ActivateNextRenderer() end) -- curre=
ntly broken
+SetMacro("ctrl+r",			function() MacroCmd_ActivateNextRenderer() end)
 =

 SetMacro("ctrl+f1",		function() MacroCmd_ItemSlot_Set(1) end)
 SetMacro("ctrl+f2",		function() MacroCmd_ItemSlot_Set(2) end)

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Sat Oct  4 03:21:51 2008
@@ -32,6 +32,16 @@
 cMapBlock_2D_Terrain.kLOD_Rough			=3D kMapLoad_2D_Terrain_Rough
 cMapBlock_2D_Statics.kLOD_Detail		=3D kMapLoad_2D_Statics_Detail
 cMapBlock_2D_Statics.kLOD_Rough			=3D kMapLoad_2D_Statics_Rough
+
+function Renderer2D:DeInitMap	()
+	for k,v in pairs(self.map2d_spawners) do
+		v:Destroy()
+	end
+	self.map2d_spawners =3D nil
+	self.map2d_scheduler:Destroy()
+	self.map2d_scheduler =3D nil
+	self.bMapLoadSystemInitialized =3D false
+end
 =

 function Renderer2D:InitMap	()
 	if (not self.bMapLoadSystemInitialized) then
@@ -87,7 +97,6 @@
 =

 function Renderer2D:MapStep		()
 	self:MobileTestStep()
-	=

 	local t =3D Client_GetTicks()
 	local x,y,z =3D self:GetCamPos()
 	for k,spawner in pairs(self.map2d_spawners) do spawner:Step(t,x,y,z) end

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Sat Oct  4 03:21:51 2008
@@ -32,20 +32,22 @@
 	if (self.bFirstInitDone) then return end
 	self.bFirstInitDone =3D true
 	RegisterListener("Hook_MainWindowResized",function () Renderer2D.gbNeedCo=
rrectAspectRatio =3D true end)
-	MultiTexTerrainInit()
-	self:InitMap()	=

 end
 =

 function Renderer2D:Init ()
 	self:FirstInit()
+	MultiTexTerrainInit()
+	self:InitMap()
 	self.gbActive =3D true
+	=

+	self:StartWorld()
 end
 =

 function Renderer2D:DeInit ()
-	-- todo: MultiTexTerrainInit() deinit ?!?
-	=

+	MultiTexTerrainDeInit()
 	-- if 2d is stopped, stop also World
 	self:StopWorld()
+	self:DeInitMap()	=

 	self.gbActive =3D false
 end
 =

@@ -54,7 +56,7 @@
 	-- for 2D/3D renderer switching
 	self:CamInit()
 	=

-	Client_ClearLights()  -- this has to be verified, this couses a seg fault=
 with caelum (sience)
+	Client_ClearLights()  -- this has to be verified, this causes a seg fault=
 with caelum (sience)
 	-- initialize Worldlight
 	SetupWorldLight_Default()
 	=

@@ -62,8 +64,8 @@
 	self:SetMapEnvironment()
 =

 	-- switch renderer : create all object visuals
-	--	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynam=
ic)) then self:AddDynamicItem(dynamic) end end
-	--	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile)=
 end
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
+	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
 end
 =

 function Renderer2D:StopWorld ()

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Sat Oct  4 03:21:51 2008
@@ -44,6 +44,16 @@
 cMapBlock_3D_Water.kLOD_Rough			=3D kMapLoad_3D_Water_Rough
 cMapBlock_3D_Multis.kLOD_Detail			=3D kMapLoad_3D_Multis_Detail
 cMapBlock_3D_Multis.kLOD_Rough			=3D kMapLoad_3D_Multis_Rough
+
+function Renderer3D:DeInitMap	()
+	for k,v in pairs(self.map3d_spawners) do
+		v:Destroy()
+	end
+	self.map3d_spawners =3D nil
+	self.map3d_scheduler:Destroy()
+	self.map3d_scheduler =3D nil
+	self.bMapLoadSystemInitialized =3D false
+end
 =

 function Renderer3D:InitMap	()
 	if (not self.bMapLoadSystemInitialized) then

Modified: trunk/lua/lib.3d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mobile.lua (original)
+++ trunk/lua/lib.3d.mobile.lua Sat Oct  4 03:21:51 2008
@@ -268,7 +268,7 @@
 	if (mobile.bar) 		then mobile.bar:SetPosition(		x-0.5,y+0.5,z + 2.0) end
 	if (mobile.nametext) 	then mobile.nametext:SetPosition(	x-0.5,y+0.5,z + 2=
.0) end
 	=

-	mobile.gfx:SetPosition(x,y,z)
+	if mobile.gfx then mobile.gfx:SetPosition(x,y,z) end
 end
 =

 -- called every frame from mainloop : MobileAnimStep

Modified: trunk/lua/lib.3d.multispawner.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.multispawner.lua (original)
+++ trunk/lua/lib.3d.multispawner.lua Sat Oct  4 03:21:51 2008
@@ -83,3 +83,9 @@
 		self.lMulti[serial] =3D nil
 	end
 end
+
+function cMultiSpawner:Destroy	()
+	for k,multi in pairs(self.lMulti) do
+		self:RemoveMulti(k)
+	end
+end

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Sat Oct  4 03:21:51 2008
@@ -30,23 +30,33 @@
 	self.bFirstInitDone =3D true
 	-- load texture atlas
 	LoadTexAtlas()
-	MultiTexTerrainInit()
 	RegisterListener("Hook_MainWindowResized",function () Renderer3D.gbNeedCo=
rrectAspectRatio =3D true end)
-	self:InitMap()
 end
 =

 function Renderer3D:Init ()
 	self:FirstInit()
+	=

+	MultiTexTerrainInit()
+	=

+	self:InitMap()
+	self:StartWorld()
+	=

+	gTileFreeWalk:Init()
+		=

 	self.gbActive =3D true
 end
 =

 function Renderer3D:DeInit ()
 	--print("deactivating Renderer3D")
 	-- todo: LoadTexAtlas()  deinit ?!?
-	-- todo: MultiTexTerrainInit() deinit ?!?
-	=

+	MultiTexTerrainDeInit()
+	=

+	gTileFreeWalk:DeInit()
+
 	-- if 3d is stopped, stop also World
-	self:StopWorld ()
+	self:StopWorld()
+	self:DeInitMap()
+		=

 	self.gbActive =3D false
 end
 =

@@ -68,9 +78,9 @@
 	print(gShadowTechnique)
 	self:SetupShadows(gShadowTechnique)
 =

--- sience: not needed anymore? bring up and assertion failure (it seems wi=
thout, everything is correct)
-	--	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynam=
ic)) then self:AddDynamicItem(dynamic) end end
-	--	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile)=
 end
+	-- sience: not needed anymore? bring up and assertion failure (it seems w=
ithout, everything is correct)
+	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:AddDynamicItem(dynamic) end end
+	for k,mobile in pairs(GetMobileList()) do self:CreateMobileGfx(mobile) end
 end
 =

 function Renderer3D:StopWorld ()
@@ -80,12 +90,6 @@
 	Client_ClearLights()
 	self:ClearMapCache()
 	self:DeleteMapEnvironment()
-	-- DeInit Caelum here (doesn't seem to work)
-	if (gCaelumSystem) then
-		print("deinit caelum")
-		gCaelumSystem:Shutdown(true)
-		gCaelumSystem =3D nil
-	end
 end
 =

 function Renderer3D:SetOfflineStartPos (x,y,z)
@@ -162,6 +166,15 @@
 	--print("TranslateOsiWalkAngle",-x,camangdeg)
 	--return -x + camangdeg - 3*45
 	return x - camangdeg + 5*45
+end
+
+function Renderer3D:DeleteMapEnvironment ()
+	-- DeInit Caelum here (doesn't seem to work)
+	if (gCaelumSystem) then
+		print("deinit caelum")
+		gCaelumSystem:Shutdown(true)
+		gCaelumSystem =3D nil
+	end
 end
 =

 function Renderer3D:SetMapEnvironment (bUnderGround)

Modified: trunk/lua/lib.mapblock.scheduler.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.scheduler.lua (original)
+++ trunk/lua/lib.mapblock.scheduler.lua Sat Oct  4 03:21:51 2008
@@ -52,3 +52,9 @@
 =

 -- true when the first is less than the second       (NOT less-equal)
 function cScheduler.CmpProcess	(a,b) return a.prio < b.prio end
+
+function cScheduler:Destroy ()
+	for k,v in pairs(self.pProcessList) do
+		self:RemoveProcess(v)
+	end
+end

Modified: trunk/lua/lib.mapblock.spawner.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.spawner.lua (original)
+++ trunk/lua/lib.mapblock.spawner.lua Sat Oct  4 03:21:51 2008
@@ -80,3 +80,5 @@
 	for block,v in pairs(self.pMapBlocks) do self:DestroyMapBlock(block) end
 	self.pMapBlocks =3D {}
 end
+
+function cMapBlockSpawner:Destroy () self:Clear() end

Modified: trunk/lua/lib.null.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.null.renderer.lua (original)
+++ trunk/lua/lib.null.renderer.lua Sat Oct  4 03:21:51 2008
@@ -2,53 +2,61 @@
 =

 gRendererList[ "RendererNull" ] =3D RendererNull
 =

-function RendererNull:DeInit () end
+function RendererNull_Print(...) print("<NULL>",...) end
+function RendererNull_PrintOften(...) --[[ print("<NULL>",...) ]] end
+
+function RendererNull:DeInit () RendererNull_Print("DeInit") end
 function RendererNull:Init () =

+	RendererNull_Print("Init") =

 	self.fCamPosXLoc =3D 0
 	self.fCamPosYLoc =3D 0
 	self.fCamPosZLoc =3D 0
 end
 =

-function RendererNull:SetMapEnvironment () end
+function RendererNull:SetMapEnvironment () RendererNull_Print("SetMapEnvir=
onment") end
 =

-function RendererNull:MousePick_ShowHits () end
+function RendererNull:MousePick_ShowHits () RendererNull_Print("MousePick_=
ShowHits") end
 =

-function RendererNull:UpdateMobileModel () end
-function RendererNull:UpdateMobile () end
-function RendererNull:NotifyPlayerTeleported () end
-function RendererNull:StartWorld () end
-function RendererNull:UpdateMapEnvironment (hour,minute,second) end
+function RendererNull:UpdateMobileModel (mobile) RendererNull_Print("Updat=
eMobileModel",mobile) end
+function RendererNull:UpdateMobile (mobile) RendererNull_Print("UpdateMobi=
le",mobile) end
+function RendererNull:NotifyPlayerTeleported () RendererNull_Print("Notify=
PlayerTeleported") end
+--~ function RendererNull:StartWorld () RendererNull_Print("StartWorld") e=
nd
+function RendererNull:UpdateMapEnvironment (hour,minute,second) RendererNu=
ll_Print("UpdateMapEnvironment",hour,minute,second) end
 =

-function RendererNull:AddDynamicItem (item) end
-function RendererNull:RemoveDynamicItem (item) end
-function RendererNull:UpdateDynamicItemPos (item) end
-function RendererNull:MainStep () end
-function RendererNull:MobileStartServerSideAnim (animdata) end
-function RendererNull:MousePick_Scene () end
-function RendererNull:CamChangeZoom (f) end
+function RendererNull:AddDynamicItem (item) RendererNull_Print("AddDynamic=
Item",item) end
+function RendererNull:RemoveDynamicItem (item) RendererNull_Print("RemoveD=
ynamicItem",item) end
+function RendererNull:UpdateDynamicItemPos (item) RendererNull_Print("Upda=
teDynamicItemPos",item) end
+function RendererNull:MainStep () RendererNull_PrintOften("MainStep") end
+function RendererNull:MobileStartServerSideAnim (animdata) RendererNull_Pr=
int("MobileStartServerSideAnim",animdata) end
+function RendererNull:MousePick_Scene () RendererNull_Print("MousePick_Sce=
ne") end
+function RendererNull:CamChangeZoom (f) RendererNull_Print("CamChangeZoom"=
,f) end
 =

-function RendererNull:DestroyMobileGfx (mobile) end
-function RendererNull:SelectMobile (serial) end
-function RendererNull:DeselectMobile () end
+function RendererNull:DestroyMobileGfx (mobile) RendererNull_Print("Destro=
yMobileGfx",mobile) end
+function RendererNull:SelectMobile (serial) RendererNull_Print("SelectMobi=
le",serial) end
+function RendererNull:DeselectMobile () RendererNull_Print("DeselectMobile=
") end
 =

-function RendererNull:DestroyMousePickItemBySerial (serial) end
+function RendererNull:DestroyMousePickItemBySerial (serial) RendererNull_P=
rint("DestroyMousePickItemBySerial",serial) end
 =

 -- sets the global sunlight level, intensity=3D0 -> dark, intensity=3D1 ->=
 bright
-function RendererNull:SetSunLight (intensity) end
+function RendererNull:SetSunLight (intensity) RendererNull_Print("SetSunLi=
ght",intensity) end
 -- sets the personal light level, intensity=3D0 -> dark, intensity=3D1 -> =
bright
-function RendererNull:SetPersonalLight (mobile, intensity) end
+function RendererNull:SetPersonalLight (mobile, intensity) RendererNull_Pr=
int("SetPersonalLight",mobile, intensity) end
 =

-function RendererNull:CamKeyDown (key) end
-function RendererNull:CamKeyUp (key) end
+function RendererNull:CamKeyDown (key) RendererNull_Print("CamKeyDown",key=
) end
+function RendererNull:CamKeyUp (key) RendererNull_Print("CamKeyUp",key) end
 =

 -- returns ax,xloc,yloc  (ax =3D angle, constant for iso cam)
 function RendererNull:GetCompassInfo				() =

 	local ax =3D (180+45)*gfDeg2Rad
 	local xloc,yloc =3D self:GetCamPos()
+	RendererNull_PrintOften("GetCompassInfo",ax,xloc,yloc)
 	return ax,xloc,yloc
 end
 =

 -- returns xloc,yloc in uo coords
-function RendererNull:GetCamPos () return self.fCamPosXLoc, self.fCamPosYL=
oc, self.fCamPosZLoc end
+function RendererNull:GetCamPos () =

+	RendererNull_PrintOften("GetCamPos") =

+	return self.fCamPosXLoc, self.fCamPosYLoc, self.fCamPosZLoc =

+end
 =

-function RendererNull:BlendOutLayersAbovePlayer () end
+function RendererNull:BlendOutLayersAbovePlayer () RendererNull_Print("Ble=
ndOutLayersAbovePlayer") end

Modified: trunk/lua/lib.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.renderer.lua (original)
+++ trunk/lua/lib.renderer.lua Sat Oct  4 03:21:51 2008
@@ -12,8 +12,7 @@
 	local takenext =3D false
 	for k,v in pairs(gRendererList) do
 		if takenext then
-			gCurrentRenderer =3D v
-			ActivateRenderer(gCurrentRenderer)
+			ActivateRenderer(v)
 			return
 		end
 		=

@@ -24,15 +23,14 @@
 	=

 	-- no next found so take the first one
 	for k,v in pairs(gRendererList) do
-		gCurrentRenderer =3D v
-		ActivateRenderer(gCurrentRenderer)
+		ActivateRenderer(v)
 		return
 	end
 end
 =

 function ActivateRenderer (newrenderer)
 	if (gCurrentRenderer =3D=3D newrenderer) then return end
-	printf("########## gCurrentRenderer:DeInit\n")
+	printf("########## gCurrentRenderer:DeInit : %s\n",GetRendererName(gCurre=
ntRenderer))
 	gCurrentRenderer:DeInit()
 	gCurrentRenderer =3D newrenderer
 	printf("########## activating renderer : %s\n",GetRendererName(gCurrentRe=
nderer))

Modified: trunk/lua/lib.terrain.multitex.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.terrain.multitex.lua (original)
+++ trunk/lua/lib.terrain.multitex.lua Sat Oct  4 03:21:51 2008
@@ -115,6 +115,11 @@
 	return unpack(coords)
 end
 =

+function MultiTexTerrainDeInit ()
+	if (not gMultiTexTerrainInitDone) then return end
+	-- todo: currently this just does nothing
+end
+
 function MultiTexTerrainInit ()
 	if (not gEnableMultiTexTerrain) then return end
 	if (gMultiTexTerrainInitDone) then return end

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Sat Oct  4 03:21:51 2008
@@ -69,6 +69,11 @@
 =

 -- ##### ##### ##### ##### ##### init
 =

+
+function gTileFreeWalk:DeInit ()
+	-- TODO
+	self.mbActive =3D false
+end
 =

 function gTileFreeWalk:Init ()
 	if (gCurrentRenderer ~=3D Renderer3D) then return end
@@ -84,10 +89,14 @@
 	self.pos_lastrequested =3D {0,0,0}
 	self:SetPos_All(self:LocalToUOPos(0,0,0))
 	=

+	self.mbActive =3D true
+	=

 	if (true) then
 		self.sDebugMarkerMeshName_Big	=3D MakeSphereMesh(11,11,0.2,0.2,0.2)
 		self.sDebugMarkerMeshName_Dir	=3D MakeSphereMesh(11,11,0.1,0.1,0.1)
 	end
+
+	gTileFreeWalk:OnStartInGame()
 end
 =

 function gTileFreeWalk:OnStartInGame ()
@@ -98,11 +107,11 @@
 		--~ self:SetPos_All(self:LocalToUOPos(-1482.5,1527.5, 2.0))  -- osi-brit=
annia  -- set in startofflinemode in lib.mainmenu.lua
 		--~ self:SetPos_All(self:LocalToUOPos(-1482.5,1527.5, 2.0))  -- osi-brit=
annia  -- set in startofflinemode in lib.mainmenu.lua
 	end
-	RegisterStepper(function () gTileFreeWalk:Step() end) =

-end
-
-RegisterListener("Hook_StartInGame",function () gTileFreeWalk:OnStartInGam=
e() end)
-RegisterListener("Hook_PreLoad",function () gTileFreeWalk:Init() end)
+	RegisterStepper(function () if not self.mbActive then return true else gT=
ileFreeWalk:Step() end end) =

+end
+
+--~ RegisterListener("Hook_StartInGame",function () gTileFreeWalk:OnStartI=
nGame() end)
+--~ RegisterListener("Hook_PreLoad",function () gTileFreeWalk:Init() end)
 =

 =

 -- ##### ##### ##### ##### ##### step

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Oct  4 03:21:51 2008
@@ -343,8 +343,6 @@
 	InvokeExporters()
 =

 	MainMenuFinishedPreLoading()
-
-	gCurrentRenderer:Init()
 	=

 	-- set fadelines font
 	gFadeLinesFont =3D gFontDefs["Chat"].name
@@ -372,7 +370,8 @@
 	print("##################################")
 	print("######      START INGAME     #####")
 	print("##################################")
-	gCurrentRenderer:StartWorld()
+
+	gCurrentRenderer:Init()
 =

 	ExecuteMapChangeIfNeeded()
 =


Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Sat Oct  4 03:21:51 2008
@@ -252,6 +252,8 @@
 	Send_ClientLanguage(gLanguage or "ENU")
 	Send_UnknownCommand()
 	Send_UnknownSE()
+
+	StartInGame()
 	=

 	-- TODO : HintStartPosition(mobiledata.xloc, mobiledata.yloc, mobiledata.=
zloc) hint for campos ?
 	UpdatePlayerBodySerial(mobiledata.serial)
@@ -268,7 +270,7 @@
 	GuiAddChatLine("NET: Login_Complete with id: " .. id) =

 =

 	--Start World
-	StartInGame()
+	--~ StartInGame()
 end
 =

 -- Loginserver Login rejected - Errorcode returned



From no-reply at zwischenwelt.org  Sat Oct  4 14:41:01 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 04 Oct 2008 12:41:01 -0000
Subject: [Iris-commit] [IRIS] r2509 -
	/trunk/data/base/ui/ray_border_black.png
Message-ID: <20081004124101.B6B491C18678@zwischenwelt.org>

Author: hagish
Date: Sat Oct  4 14:41:00 2008
New Revision: 2509

Log:
forgot to add image

Added:
    trunk/data/base/ui/ray_border_black.png   (with props)



From no-reply at zwischenwelt.org  Sat Oct  4 19:33:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 04 Oct 2008 17:33:34 -0000
Subject: [Iris-commit] [IRIS] r2510 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.map.lua lib.2d.mousepick.lua lib.2d.renderer.lua
Message-ID: <20081004180006.D61B51C1865A@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct  4 19:33:34 2008
New Revision: 2510

Log:
2d : dynamic-batching, blockwise

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.2d.renderer.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Sat Oct  4 19:33:34 2008
@@ -1,51 +1,143 @@
 -- dynamics (items,doors,...)
+Renderer2D.gDynamicBlocks =3D {}
+Renderer2D.gDynamicBlockDirtyList =3D {}
+
+function Renderer2D:AddDynamicItem					(item) =

+	if item.artid >=3D gMulti_ID then =

+		-- multi
+		self:UpdateMultiItemGfx(item)
+	elseif (item.artid_base =3D=3D kCorpseDynamicArtID or (item.artid and ite=
m.artid > 1)) then -- 1 =3D=3D nodraw =

+		local block =3D self:GetOrCreateDynamicBlockAndMarkAsDirty(floor(item.xl=
oc/8),floor(item.xloc/8))
+		block.bDynamics[item] =3D true
+		item.block2d =3D block
+	elseif not item.artid then
+		print("ERROR: artid missing!!!!\n")
+	end
+end
+
 =

 function Renderer2D:RemoveDynamicItem				(item) =

 	if (item.gfx2d) then item.gfx2d:Destroy() item.gfx2d =3D nil end
+	if (item.block2d) then
+		local block =3D item.block2d
+		block.bDynamics[item] =3D nil
+		self:DynamicBlockMarkAsDirty(block)
+	end
 	ArtAtlasUnLock(item)
 end
-function Renderer2D:UpdateCorpseItemGfx				(item) =

-	local spriteblock =3D item.gfx2d
+
+
+function Renderer2D:Dynamics_MainStep			() =

+	local bHadDirty =3D false
+	for block,v in pairs(self.gDynamicBlockDirtyList) do bHadDirty =3D true s=
elf:DynamicBlockRebuild(block) end
+	if (bHadDirty) then self.gDynamicBlockDirtyList =3D {} end
+end
+
+function Renderer2D:DynamicBlockRebuild (block)
+	local bxloc =3D block.bx * 8
+	local byloc =3D block.by * 8
+	local bzloc =3D 0
+	local itemcount =3D countarr(block.bDynamics)
+	local myindex =3D 0
+	local spriteblock =3D block.gfx2d
+	local iBlendOutMinZ,iBlendOutMaxZ =3D self:BlendoutGetVisibleRange()
+	=

+	-- erase block if empty
+	if (itemcount =3D=3D 0) then
+		if (spriteblock) then spriteblock:Destroy() end
+		self.gDynamicBlocks[block.n] =3D nil
+		return
+	end
+	=

+	-- prepare gfx
 	if (not spriteblock) then =

 		spriteblock =3D cUOSpriteBlock:New()
-		item.gfx2d =3D spriteblock =

+		block.gfx2d =3D spriteblock =

 	else	=

 		spriteblock:Clear()
 	end
-
-	local xloc,yloc,zloc =3D item.xloc,item.yloc,item.zloc
-	local tx,ty,tz,iIndex,fIndexRel =3D 0,0,0,0
-	local sorttx =3D xloc-floor(xloc/8)*8
-	local sortty =3D yloc-floor(yloc/8)*8
-	local sorttz =3D zloc
-	local parts =3D {}
-	item.corpsedir =3D item.corpsedir or math.random(0,7)
-	local iDirAdd,bMirrorX =3D GetAnimDirAdd(DirWrap(item.corpsedir))  -- som=
e param ? last known dir ?
-	=

-	local bodyid =3D item.amount
-	table.insert(parts,{bodyid,item.hue,13}) -- fallback=3D13=3Devortex
-	=

-	for k,v in pairs(parts) do =

-		local iModelID,iHue,iFallBackModel =3D unpack(v)
-		if iModelID then =

-			local iLoaderIndex =3D 1
-			iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
-			iIndex =3D iIndex + 1 =

-			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
-			=

-			local iAnimID =3D Anim_GetCorpseAnim(iModelID,mount) + iDirAdd
-			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID),iLoaderIndex) or 1000
-			if (iFrameCount < 1) then iFrameCount =3D 1 end
-			local iFrame =3D iFrameCount - 1
-			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del)
-			spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackM=
odel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,=
sorttz,fIndexRel,4),item) =

+	=

+	-- iterate over items
+	for item,v in pairs(block.bDynamics) do
+		local xloc,yloc,zloc =3D item.xloc,item.yloc,item.zloc
+		local tx,ty,tz,fIndexRel =3D xloc-bxloc,yloc-byloc,zloc-bzloc,myindex/it=
emcount
+		myindex =3D myindex + 1
+		local sorttx =3D xloc-bxloc
+		local sortty =3D yloc-byloc
+		local sorttz =3D zloc
+		local bVisible =3D (not (zloc and iBlendOutMinZ and iBlendOutMaxZ)) or (=
zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ)
+		=

+	=

+		if (bVisible) then
+			-- corpse
+			if (item.artid_base =3D=3D kCorpseDynamicArtID) then
+				local parts =3D {}
+				item.corpsedir =3D item.corpsedir or math.random(0,7)
+				local iDirAdd,bMirrorX =3D GetAnimDirAdd(DirWrap(item.corpsedir))  -- =
some param ? last known dir ?
+				=

+				local bodyid =3D item.amount
+				table.insert(parts,{bodyid,item.hue,13}) -- fallback=3D13=3Devortex
+				-- TODO : later : add clothing&equip for human corpses ?
+				=

+				for k,v in pairs(parts) do =

+					local iModelID,iHue,iFallBackModel =3D unpack(v)
+					if iModelID then =

+						local iLoaderIndex =3D 1
+						iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
+						--~ iIndex =3D iIndex + 1 =

+						--~ fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffe=
r flicker
+						=

+						local iAnimID =3D Anim_GetCorpseAnim(iModelID,mount) + iDirAdd
+						local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,i=
AnimID),iLoaderIndex) or 1000
+						if (iFrameCount < 1) then iFrameCount =3D 1 end
+						local iFrame =3D iFrameCount - 1
+						local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBac=
kModel)
+						spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBa=
ckModel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sort=
ty,sorttz,fIndexRel,4),item) =

+					end
+				end
+			else -- regular item
+				local iTileTypeID	=3D item.artid
+				=

+				local animinfo =3D GetAnimDataInfo(iTileTypeID)
+				if (animinfo) then
+					if (animinfo.miCount > 1) then
+						iTileTypeID =3D iTileTypeID + (animinfo.miFrames[floor(animinfo.miCo=
unt/2)] or 0)
+					end
+				end
+				=

+				local iHue	=3D item.hue
+				spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,CalcSortBonus(iTile=
TypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
+			end
 		end
 	end
-	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,false)
-	=

-	local x,y,z =3D self:UOPosToLocal(item.xloc,item.yloc,item.zloc*kRenderer=
2D_ZScale)
-	item.gfx2d:SetPosition(x,y,z)
-end
+
+	-- build block
+	spriteblock:Build(Renderer2D.kSpriteBaseMaterial)
+	local x,y,z =3D self:UOPosToLocal(bxloc,byloc,bzloc*kRenderer2D_ZScale)
+	spriteblock:SetPosition(x,y,z)
+end
+
+function Renderer2D:DynamicBlockMarkAsDirty (block)
+	self.gDynamicBlockDirtyList[block] =3D true
+end
+
+function Renderer2D:GetOrCreateDynamicBlockAndMarkAsDirty (bx,by)
+	local n =3D bx..","..by
+	local b =3D self.gDynamicBlocks[n]
+	if (not b) then b =3D { bx=3Dbx,by=3Dby,n=3Dn,bDynamics=3D{} } self.gDyna=
micBlocks[n] =3D b end -- todo : throw old blocks out of cache here ?
+	self:DynamicBlockMarkAsDirty(b) =

+	return b
+end =

+
+function Renderer2D:Dynamics_UpdateBlendOut()
+	for k,dynamic in pairs(GetDynamicList()) do =

+		if (DynamicIsInWorld(dynamic)) then self:UpdateDynamicBlendOut(dynamic,a=
,b) end =

+	end
+	for k,block in pairs(self.gDynamicBlocks) do self.gDynamicBlockDirtyList[=
block] =3D true end
+end
+
+
+
 =

 function Renderer2D:UpdateDynamicBlendOut			(item,iBlendOutMinZ,iBlendOutM=
axZ) =

 	if item.artid >=3D gMulti_ID then =

@@ -53,7 +145,7 @@
 		self:UpdateMultiItemGfx(item)
 	else
 		local zloc =3D item.zloc
-		local bVisible =3D zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ
+		local bVisible =3D (not (zloc and iBlendOutMinZ and iBlendOutMaxZ)) or (=
zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ)
 		if (item.gfx2d) then item.gfx2d:SetVisible(bVisible) end
 	end
 end
@@ -101,45 +193,7 @@
 	spriteblock:SetPosition(x,y,z)
 end
 =

-function Renderer2D:AddDynamicItem					(item) =

-	if (item.artid_base =3D=3D kCorpseDynamicArtID) then
-		-- corpse
-		self:UpdateCorpseItemGfx(item)
-	elseif not item.artid then
-		print("ERROR: artid missing!!!!\n")
-	elseif item.artid >=3D gMulti_ID then =

-		-- multi
-		self:UpdateMultiItemGfx(item)
-	else
-		local iTileTypeID	=3D item.artid
-		if (iTileTypeID > 1) then -- 1 =3D=3D nodraw =

-			local spriteblock =3D cUOSpriteBlock:New()
-			item.gfx2d =3D spriteblock
-			=

-			=

-			local animinfo =3D GetAnimDataInfo(iTileTypeID)
-			if (animinfo) then
-				if (animinfo.miCount > 1) then
-					iTileTypeID =3D iTileTypeID + (animinfo.miFrames[floor(animinfo.miCou=
nt/2)] or 0)
-				end
-			end
-			=

-			local xloc =3D item.xloc
-			local yloc =3D item.yloc
-			local zloc =3D item.zloc
-			local tx,ty,tz,fIndexRel =3D 0,0,0,0
-			local sorttx =3D xloc-floor(xloc/8)*8
-			local sortty =3D yloc-floor(yloc/8)*8
-			local sorttz =3D zloc
-			local iHue			=3D item.hue
-			spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,CalcSortBonus(iTileT=
ypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
-			spriteblock:Build(Renderer2D.kSpriteBaseMaterial,true)
-			local x,y,z =3D gCurrentRenderer:UOPosToLocal(xloc,yloc,zloc*kRenderer2=
D_ZScale)
-			spriteblock:SetPosition(x,y,z)
-		end
-	end
-end
-
+-- unused for 2d
 function Renderer2D:UpdateDynamicItemPos			(item)
 	if (not Renderer2D.bDebugWarnUpdateDynamicItemPos) then
 		Renderer2D.bDebugWarnUpdateDynamicItemPos =3D true

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Sat Oct  4 19:33:34 2008
@@ -77,7 +77,7 @@
 		end
 		=

 		local a,b =3D self:BlendoutGetVisibleRange()
-		for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic=
)) then self:UpdateDynamicBlendOut(dynamic,a,b) end end
+		self:Dynamics_UpdateBlendOut()
 		=

 		self.map2d_spawners.statics:ForAllBlocks(function(block) block:RebuildFo=
rBlendout() end)
 	end

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Sat Oct  4 19:33:34 2008
@@ -140,6 +140,16 @@
 			end
 		end
 	end
+	for k,block in pairs(self.gDynamicBlocks) do
+		local spriteblock =3D block.gfx2d
+		if (spriteblock) then =

+			local dist,sprite =3D spriteblock:RayPick(rx,ry,rz, rvx,rvy,rvz) =

+			if (dist and ((not founddist) or dist < founddist)) then
+				founddist =3D dist
+				foundsprite =3D sprite
+			end
+		end
+	end
 	return founddist,foundsprite -- item=3Dfoundsprite.data
 end
 =


Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Sat Oct  4 19:33:34 2008
@@ -134,6 +134,7 @@
 	self:EffectAnimStep() -- should be after player pos is updated, for effec=
ts moving with player
 	self:MapStep()
 	self:HUDFX_MainStep()
+	self:Dynamics_MainStep()
 end
 =

 function Renderer2D:CamKeyDown						(key) end



From no-reply at zwischenwelt.org  Sat Oct  4 22:32:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 04 Oct 2008 20:32:28 -0000
Subject: [Iris-commit] [IRIS] r2511 - in /trunk: lua/ lua/net/ lua/widgets/
	plugins/
Message-ID: <20081004203228.F14031C186AB@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct  4 22:32:28 2008
New Revision: 2511

Log:
2d tooltips, text is ok, but no background yet

Added:
    trunk/lua/lib.uotooltip.lua
    trunk/lua/widgets/widget.uotooltip.lua
Modified:
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/main.lua
    trunk/lua/net/net.multi.lua
    trunk/lua/widgets/widget.uocontaineritem.lua
    trunk/lua/widgets/widget.uotext.lua
    trunk/plugins/hudenemylist.lua

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Sat Oct  4 22:32:28 2008
@@ -1,3 +1,22 @@
+
+Renderer2D.gNextMousePickStep =3D 0
+Renderer2D.gMousePickStepInterval =3D 400
+Renderer2D.gUOToolTipOverride =3D true
+
+-- not every frame, but regularly
+function Renderer2D:MousePickStep		()
+	local t =3D Client_GetTicks()
+	if (self.gNextMousePickStep > t) then return end
+	self.gNextMousePickStep =3D t + self.gMousePickStepInterval
+	=

+	local serial
+	if (not gKeyPressed[key_mouse_right]) then
+		serial =3D GetMouseHitSerial(true) -- executes mousepick
+		if (serial =3D=3D 0) then serial =3D nil end
+	end
+	=

+	SetUOToolTipAtMouse(serial)
+end
 =

 function Renderer2D:MousePick_Scene () =

 	-- raypick
@@ -89,7 +108,6 @@
 end
 =

 =

-function Renderer2D:MousePickStep		() end -- obsolete, don't do mousepicki=
ng every frame
 =

 =

 function Renderer2D:DestroyMousePickItemBySerial (serial)

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Sat Oct  4 22:32:28 2008
@@ -135,6 +135,7 @@
 	self:MapStep()
 	self:HUDFX_MainStep()
 	self:Dynamics_MainStep()
+	self:MousePickStep()
 end
 =

 function Renderer2D:CamKeyDown						(key) end

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Sat Oct  4 22:32:28 2008
@@ -21,6 +21,7 @@
 	Renderer3D.gMousePickFoundHit_ExactX =3D false
 	=

 	local widget =3D MousePick_GUI()
+	gMousePickFoundHitWidget =3D widget
 	=

 	-- 3d mousepicking, only if no widget hit
 	if (not widget) then gCurrentRenderer:MousePick_Scene() end
@@ -62,6 +63,15 @@
 			gMousePickFoundHit =3D {}
 			gMousePickFoundHit.hittype =3D kMousePickHitType_Container
 			gMousePickFoundHit.container =3D widget.dialog.uoContainer
+			gMousePickFoundHit.is2DHit =3D true
+		elseif widget.mobile then
+			local mobile =3D widget.mobile
+			gMousePickFoundHit =3D {}
+			gMousePickFoundHit.hittype =3D kMousePickHitType_Mobile
+			gMousePickFoundHit.mobile =3D mobile
+			gMousePickFoundHit.hit_xloc =3D mobile.xloc
+			gMousePickFoundHit.hit_yloc =3D mobile.yloc
+			gMousePickFoundHit.hit_zloc =3D mobile.zloc
 			gMousePickFoundHit.is2DHit =3D true
 		end
 	end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Oct  4 22:32:28 2008
@@ -87,6 +87,7 @@
 dofile(libpath .. "lib.uoutils.lua")
 dofile(libpath .. "lib.desktop.lua")
 dofile(libpath .. "lib.uoanim.lua")
+dofile(libpath .. "lib.uotooltip.lua")
 dofile(libpath .. "lib.blendout.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")

Modified: trunk/lua/net/net.multi.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.multi.lua (original)
+++ trunk/lua/net/net.multi.lua Sat Oct  4 22:32:28 2008
@@ -286,7 +286,7 @@
 end
 =

 function UpdateMultiData (item)
-	local iTileTypeID,iX,iY,iZ,iFlags
+	if item.artid < gMulti_ID then return end
 	local iHue =3D 0
 	local multi =3D {}
 	multi.lparts =3D {}

Modified: trunk/lua/widgets/widget.uocontaineritem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uocontaineritem.lua (original)
+++ trunk/lua/widgets/widget.uocontaineritem.lua Sat Oct  4 22:32:28 2008
@@ -59,6 +59,7 @@
 function gWidgetPrototype.UOContainerItemWidget:on_mouse_right_down	() end
 =

 function gWidgetPrototype.UOContainerItemWidget:on_simple_tooltip	()
+	if (gCurrentRenderer.gUOToolTipOverride) then return end -- if this is tr=
ue, then the rendererer handles tooltips
 	local tooltiptext =3D AosToolTip_GetText(self.item.serial) or ""
 	return (tooltiptext .. " \n ") or "?" -- add newline, workaround for tool=
tip sizecalc bug
 end

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Sat Oct  4 22:32:28 2008
@@ -12,7 +12,7 @@
 =

 RegisterWidgetClass("UOText","Text")
 =

--- param : x,y,width,height,cliloc_id/textline_id,background=3D0/1=3Dtrans=
parent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse,crop=3Dfalse,html=3Dfa=
lse
+-- param : x,y,width,height,text/cliloc_id/textline_id,background=3D0/1=3D=
transparent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse,crop=3Dfalse,html=
=3Dfalse
 -- bold=3Doutlined_font: false for xmfhtmlgump,htmlgump, true for croppedt=
ext, example : runebook gump : kGumpSample_RuneBook
 -- crop : disables autowrap
 -- html : parse uo html like <BASEFONT> <BIG>....

Modified: trunk/plugins/hudenemylist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/hudenemylist.lua (original)
+++ trunk/plugins/hudenemylist.lua Sat Oct  4 22:32:28 2008
@@ -101,8 +101,10 @@
 	bar.widget_bg.tooltip_offx =3D kUOToolTippOffX -- Both defined at
 	bar.widget_bg.tooltip_offy =3D kUOToolTippOffY -- obj.container.lua
 	bar.widget_bg.stylesetname =3D gGuiDefaultStyleSet
+	bar.widget_bg.mobile =3D body -- for mousepick
 	bar.widget_bg.on_simple_tooltip =3D function (widget) =

-		return (body.name) or "?" =

+		if (gCurrentRenderer.gUOToolTipOverride) then return end -- if this is t=
rue, then the rendererer handles tooltips
+		return AosToolTip_GetText(body.serial) or body.name or "?" =

 	end =

 	-- Ende Tooltip Mod
 =




From no-reply at zwischenwelt.org  Sat Oct  4 23:22:48 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 04 Oct 2008 21:22:48 -0000
Subject: [Iris-commit] [IRIS] r2512 - /trunk/lua/widgets/widget.uotooltip.lua
Message-ID: <20081004212248.788B21C186AB@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct  4 23:22:48 2008
New Revision: 2512

Log:
2d : tooltip background

Modified:
    trunk/lua/widgets/widget.uotooltip.lua

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Sat Oct  4 23:22:48 2008
@@ -6,26 +6,46 @@
 =

 -- params =3D {serial=3Dserial,x=3DiMouseX,y=3DiMouseY}
 function gWidgetPrototype.UOToolTip:Init (parentwidget, params)
-	self.rendergroup2d =3D CreateRenderGroup2D(parentwidget:CastToRenderGroup=
2D())
-	self:SetRenderGroup2D(self.rendergroup2d)
-	self:AddToDestroyList(self.rendergroup2d)
+	self.params	=3D params
+	params.gfxparam_init		=3D params.gfxparam_init	or	MakeSpritePanelParam_Bo=
rderPartMatrix(GetPlainTextureGUIMat("sience_border.png")
+																,320,320, 0,0, 0,0, 12,12, 8,8, 12,12, 32,32, 1,1, false, =
false)
+	params.margin_left			=3D params.margin_left	or	4
+	params.margin_top			=3D params.margin_top		or	4
+	params.margin_right			=3D params.margin_right	or	4
+	params.margin_bottom		=3D params.margin_bottom	or	4
+	=

+	local bVertexBufferDynamic,bVertexCol =3D false,true
+	local spritepanel =3D CreateSpritePanel(parentwidget:CastToRenderGroup2D(=
),params.gfxparam_init,bVertexBufferDynamic,bVertexCol)
+	self:SetRenderGroup2D(spritepanel:CastToRenderGroup2D())
+	self:AddToDestroyList(spritepanel) -- don't add spritelist here, will be =
destroyed in spritepanel destructor
+	self.spritepanel =3D spritepanel
+	self.params =3D params
 	self:SetIgnoreBBoxHit(true)
 	self:SetIgnoreChildHits(true)
 	=

-	self.params	=3D params
-	--~ self.border =3D self:CreateChild("Border",{
-			--~ gfxparam_init		=3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTe=
xtureGUIMat("sience_border.png")
-											--~ ,320,320, 0,0, 0,0, 12,12, 8,8, 12,12, 32,32, 1,1, false, f=
alse),
-			--~ margin_left			=3D 4,
-			--~ margin_top			=3D 4,
-			--~ margin_right		=3D 4,
-			--~ margin_bottom		=3D 4,
-		--~ })
-	self.text =3D self:CreateChild("UOText",{x=3D0,y=3D0,text=3D"???",bold=3D=
true}) -- ,html=3Dtrue,hue=3Dhue
-	-- param : ,background=3D0/1=3Dtransparent?,scrollbar=3D0/1=3Ddisplayed,h=
ue,bold=3Dfalse,crop=3Dfalse,html=3Dfalse
+	self.text =3D self:CreateChild("UOText",{x=3D0,y=3D0,text=3D"???",html=3D=
true,bold=3Dtrue})
 =

 	self:SetPos(params.x,params.y)
 	self:RefreshText()
+end
+
+
+-- TODO : see also SetSizeFromContentBounds : needed for text, e.g. in wid=
get.uotooltip.lua
+-- content bounds specified manually, content container not used
+function gWidgetPrototype.UOToolTip:AdjustToContentBounds (l,t,r,b) =

+	local params =3D self.params
+	local gfxparams =3D params.gfxparam_init
+	local borderl	=3D params.margin_left	or 0
+	local bordert	=3D params.margin_top		or 0
+	local borderr	=3D params.margin_right	or 0
+	local borderb	=3D params.margin_bottom	or 0
+	print("UOToolTip:AdjustToContentBounds",l,t,r,b,borderl,bordert,borderr,b=
orderb)
+	gfxparams.xoff =3D l-borderl
+	gfxparams.yoff =3D t-bordert
+	local w,h =3D r-l,b-t
+	gfxparams.w =3D borderl+w+borderr
+	gfxparams.h =3D bordert+h+borderb
+	self.spritepanel:Update(gfxparams)
 end
 =

 function gWidgetPrototype.UOToolTip:RefreshText ()
@@ -43,9 +63,16 @@
 	end
 	if (not tooltiptext) then tooltiptext =3D "???" end
 	self.text:SetUOHtml(tooltiptext,true)
+	local w,h =3D self.text:GetSize()
+	local vw,vh =3D GetViewportSize()
+	local x,y =3D self:GetDerivedPos()
+	local tx,ty =3D max(0-x,min(vw-w-x,-floor(0.5*w))),max(0-y,min(vh-h-y,0))
+	self.text:SetPos(tx,ty) -- center text horizontally
+	local l,t,r,b =3D self.text:GetRelBounds()
+	self:AdjustToContentBounds(l+tx,t+ty,r+tx,b+ty)
 end
 =

-function gWidgetPrototype.UOToolTip:GetDialog	() return self end -- overri=
de, normaly parent:GetDialog(), so this ends recursion
+function gWidgetPrototype.UOToolTip:GetDialog			() return self end -- over=
ride, normaly parent:GetDialog(), so this ends recursion
 =

 function gWidgetPrototype.UOToolTip:on_mouse_left_down	() self:Close() end=
 -- probably not needed as mouse is ignored
 function gWidgetPrototype.UOToolTip:on_mouse_right_down	() self:Close() en=
d -- probably not needed as mouse is ignored



From no-reply at zwischenwelt.org  Sun Oct  5 02:59:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 05 Oct 2008 00:59:55 -0000
Subject: [Iris-commit] [IRIS] r2513 - in /trunk/lua: gui/gui.paperdoll.lua
 lib.macrolist.lua lib.uoids.lua widgets/widget.uobutton.lua
 widgets/widget.uopaperdollitem.lua widgets/widget.uotext.lua
 widgets/widget.uotooltip.lua
Message-ID: <20081005005955.C953D1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct  5 02:59:54 2008
New Revision: 2513

Log:
paperdoll dialog ported to new guisys

Added:
    trunk/lua/widgets/widget.uopaperdollitem.lua
Modified:
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/widgets/widget.uobutton.lua
    trunk/lua/widgets/widget.uotext.lua
    trunk/lua/widgets/widget.uotooltip.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Sun Oct  5 02:59:54 2008
@@ -8,6 +8,7 @@
 -- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local playerPaperdoll =3D {}
+playerPaperdoll.bSupportsGuiSys2 =3D true
 playerPaperdoll.dialogId =3D 1000001
 playerPaperdoll.x =3D 120
 playerPaperdoll.y =3D 100
@@ -74,17 +75,8 @@
  -- peace
  [7]	=3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 1) then
-				if (IsWarModeActive()) then
-					Send_CombatMode(gWarmode_Combat)
-					widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
-					widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
-					widget.mat_over 	=3D GetGumpMat(hex2num("0x7EA"))
-				else
-					Send_CombatMode(gWarmode_Normal)
-					widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E5"))
-					widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E6"))
-					widget.mat_over 	=3D GetGumpMat(hex2num("0x7E7"))
-				end
+				Send_CombatMode(IsWarModeActive() and gWarmode_Normal or gWarmode_Comb=
at)
+				UpdatePaperdollWarPeaceButton()
 			end
 		  end,
  -- status
@@ -152,15 +144,22 @@
 kClientSideGump_Paperdoll_Other	=3D npcPaperdoll -- paperdoll of someone e=
lse, no buttons
 =

 =

--- base body gump ids
-local kGumpBaseId_Male	=3D 50000
-local kGumpBaseId_Female=3D 60000
 =

 -- initial body positon in gump
 local BodyWidget_x	=3D 9
 local BodyWidget_y	=3D 19
 =

 gPaperdolls =3D {}
+
+function UpdatePaperdollWarPeaceButton(widget)
+	if (widget) then
+		if (IsWarModeActive()) then
+			widget:SetButtonGumpIDs(0x7E8,0x7E9,0x7EA) -- normal,pressed,over
+		else
+			widget:SetButtonGumpIDs(0x7E5,0x7E6,0x7E7) -- normal,pressed,over
+		end
+	end
+end
 =

 local function GetPaperdollBodyAndBaseID (bodyid)
 	local bodygumpid =3D nil
@@ -232,29 +231,48 @@
 	return bodygumpid,base_id
 end
 =

+-- base_id =3D kGumpBaseId_Female or kGumpBaseId_Male
+function GetPaperdollItemGumpID (artid,base_id)
+	local t =3D GetStaticTileType(artid)
+	if (not t) then return end
+	local animid =3D t.miAnimID
+	local gumpid =3D animid + base_id
+	if ((not PreLoadGump(gumpid)) and base_id =3D=3D kGumpBaseId_Female) then=
 gumpid =3D animid+kGumpBaseId_Male end -- fallback to male
+	if (GetPaperdollLayerFromTileType(artid) =3D=3D kLayer_Backpack) then gum=
pid =3D animid+kGumpBaseId_Male end -- no female backpack
+	return gumpid
+end
+
 -- Don't call this directly, use RebuildPaperdoll() instead (need to rebui=
ld completely on change because of layerorder)
 -- item fields : serial artid layer hue (=3D-1 if not set)
 local function CreatePaperdollItemWidget(layer, paperdoll, item, base_id, =
blockedlayers)
 	local dialog =3D paperdoll.dialog
-	local animid =3D nil
-	local typename =3D ""
-	if (gTileTypeLoader) then
-		local t =3D GetStaticTileType(item.artid)
-		if (t and t.miAnimID) then animid =3D t.miAnimID end
-		if (t) then typename =3D t.msName end
-	end
-
-	if (not animid) then
-		print("WARNING : CreatePaperdollItemWidget : unknown animid -> forced Cr=
ash")
-		Crash()
-		-- TODO : dummy gfx ?
-	end
-
+
+	if (paperdoll.bSupportsGuiSys2) then =

+		--~ print("TODO : CreatePaperdollItemWidget") =

+		if (not blockedlayers[layer]) then
+			item.widget =3D dialog:CreateChild("UOPaperdollItemWidget",{paperdoll=
=3Dpaperdoll,item=3Ditem,base_id=3Dbase_id,x=3DBodyWidget_x,y=3DBodyWidget_=
y})
+		end
+		local side =3D gLayerOrderPositionAndArtOverwrite[layer]
+		if side then
+			local x,y =3D unpack(side)
+			item.widget2 =3D dialog:CreateChild("UOPaperdollItemWidget",{paperdoll=
=3Dpaperdoll,item=3Ditem,base_id=3Dbase_id,x=3Dx,y=3Dy,useart=3Dtrue,onside=
bar=3Dtrue})
+		end
+		=

+		return =

+	end
+	=

+	-- from here on : code for old-guisystem paperdoll
+	=

 	-- Fallback to female
-	local gumpid =3D animid + base_id
-	if (GetGumpMat(gumpid) =3D=3D "" and base_id =3D=3D kGumpBaseId_Female) t=
hen gumpid =3D animid+kGumpBaseId_Male end -- fallback to male
-	if (item.layer =3D=3D kLayer_Backpack) then gumpid =3D animid+kGumpBaseId=
_Male end -- no female backpack ;)
-
+	local gumpid =3D GetPaperdollItemGumpID(item.artid) =

+	=

+	if (not gumpid) then
+		print("WARNING : CreatePaperdollItemWidget : unknown gump",item.artid)
+		return
+		-- TODO : dummy gfx type for each layer ?
+	end
+	=

+	=

 	=

 	if (not blockedlayers[layer]) then
 		item.widget =3D MakeBorderGumpPart(dialog.rootwidget, gumpid, BodyWidget=
_x, BodyWidget_y, 0, 0, 0, item.hue)
@@ -352,38 +370,22 @@
 		dialog.uoPaperdoll =3D paperdoll
 =

 		-- overwrite the onMouseDown function from gumpparser
-		dialog.onMouseDown =3D function (widget,mousebutton)
-			if (mousebutton =3D=3D 2) then ClosePaperdoll(paperdoll) end
-			if (mousebutton =3D=3D 1) then widget.dialog:BringToFront() gui.StartMo=
veDialog(widget.dialog.rootwidget) end
-		end
+		dialog.SendClose =3D function (widget,returnvalue) ClosePaperdoll(paperd=
oll) end
 	end
 =

 	-- visually change the Peace/Warmode Button when opening the Paperdoll wh=
en in combat mode
-	if (IsWarModeActive()) then
-		local widget =3D dialog.controls["btnpeace"]
-		if (widget) then
-			widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E8"))
-			widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E9"))
-			widget.mat_over 	=3D GetGumpMat(hex2num("0x7EA"))
-			widget.gfx:SetMaterial(widget.mat_normal)
-		end
-	else
-		local widget =3D dialog.controls["btnpeace"]
-		if (widget) then
-			widget.mat_normal 	=3D GetGumpMat(hex2num("0x7E5"))
-			widget.mat_pressed 	=3D GetGumpMat(hex2num("0x7E6"))
-			widget.mat_over 	=3D GetGumpMat(hex2num("0x7E7"))
-			widget.gfx:SetMaterial(widget.mat_normal)
-		end
-	end
+	local widget =3D dialog.controls["btnpeace"]
+	UpdatePaperdollWarPeaceButton(widget)
 =

 	-- update paperdoll name and color
-	local r,g,b =3D GetNotorietyColor(paperdoll.mobile and paperdoll.mobile.n=
otoriety or 0)
-	dialog.controls["paperdollname"].gfx:SetCharHeight(gFontDefs["Gump"].size=
 + 2)
-	dialog.controls["paperdollname"].gfx:SetColour( {r,g,b,1.0} )
-	dialog.controls["paperdollname"].gfx:SetFont(gFontDefs["Gump"].name)
-	dialog.controls["paperdollname"].gfx:SetText(paperdoll.name)
-
+	--~ local r,g,b =3D GetNotorietyColor(paperdoll.mobile and paperdoll.mobi=
le.notoriety or 0)
+	--~ dialog.controls["paperdollname"].gfx:SetCharHeight(gFontDefs["Gump"].=
size + 2)
+	--~ dialog.controls["paperdollname"].gfx:SetColour( {r,g,b,1.0} )
+	--~ dialog.controls["paperdollname"].gfx:SetFont(gFontDefs["Gump"].name)
+	--~ dialog.controls["paperdollname"].gfx:SetText(paperdoll.name)
+	local name =3D paperdoll.name
+	dialog.controls["paperdollname"]:SetText(name)
+	=

 	-- remove old item widgets
 	DestroyPaperdollItemWidgets(paperdoll)
 =

@@ -396,11 +398,11 @@
 		if (dialog.bodywidget) then dialog.bodywidget:Destroy()  dialog.bodywidg=
et =3D nil end
 		=

 		local skinhue =3D mobile.hue
-		if (skinhue >=3D hex2num("0x8000")) then skinhue =3D skinhue - hex2num("=
0x8000") end
+		if (skinhue >=3D 0x8000) then skinhue =3D skinhue - 0x8000 end
 		=

 		-- create bodywidget
 		if (bodygumpid) then
-			dialog.bodywidget =3D MakeBorderGumpPart(dialog.rootwidget, bodygumpid,=
 BodyWidget_x, BodyWidget_y, 0, 0, 0, skinhue)
+			dialog.bodywidget =3D dialog:CreateChild("UOImage",{gump_id=3Dbodygumpi=
d,x=3DBodyWidget_x,y=3DBodyWidget_y,hue=3Dskinhue})
 		else =

 			--print("Open_Paperdoll : unknown bodyid ",bodyid,sprintf("0x%04x",body=
id))
 			-- TODO : fallback/default bodyid ?
@@ -414,6 +416,17 @@
 			end
 		end
 		=

+		paperdoll.bSupportsGuiSys2 =3D true
+		-- preload / bulkload to atlas
+		for index,layer in pairs(gLayerOrder) do =

+			local k =3D gLayerTypeName[layer]
+			local item =3D GetMobileEquipmentItem(mobile,layer)
+			if (item) then =

+				local gumpid =3D GetPaperdollItemGumpID(item.artid,base_id)
+				if (gumpid) then PreLoadGump(gumpid) end
+				if gLayerOrderPositionAndArtOverwrite[layer] then PreLoadArt(item.arti=
d + 0x4000) end
+			end
+		end
 		-- create item widgets
 		for index,layer in pairs(gLayerOrder) do =

 			local k =3D gLayerTypeName[layer]

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Oct  5 02:59:54 2008
@@ -298,6 +298,7 @@
 	local success,errormsg_or_result =3D lugrepcall(macrofun)
 	if (not success) then
 		local myErrorText =3D "ERROR executing MACRO for keycombo "..name.." :\n=
"..tostring(errormsg_or_result)
+		print(myErrorText)
 		PlainMessageBox(myErrorText,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
 	end
 end

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sun Oct  5 02:59:54 2008
@@ -14,6 +14,10 @@
 	for k,v in pairs(arr) do newarr[tonumber(k,16)] =3D tonumber(v,16) end  -=
- hex2num("0x123") is preferred to tonumber(123,16), it is better readable
 	return newarr
 end
+
+-- base body gump ids
+kGumpBaseId_Male	=3D 50000
+kGumpBaseId_Female	=3D 60000
 =

 gMaxHueValue =3D 2999 -- hues.mul has only 2999 values
 gMaxArtValue =3D hex2num("0xbfff")

Modified: trunk/lua/widgets/widget.uobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uobutton.lua (original)
+++ trunk/lua/widgets/widget.uobutton.lua Sun Oct  5 02:59:54 2008
@@ -12,12 +12,19 @@
 	self:SetIgnoreBBoxHit(true)
 	=

 	self.params			=3D params
-	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_normal})
-	self.gfx_pressed	=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dpa=
rams.gump_id_pressed})
+	self:SetButtonGumpIDs(params.gump_id_normal,params.gump_id_pressed)
 	if (params.art_id) then
 		self.gfx_icon =3D self:CreateChild("UOImage",{x=3Dparams.art_x,y=3Dparam=
s.art_y,art_id=3Dparams.art_id,hue=3Dparams.hue})
 	end
 	self:SetPos(params.x,params.y)
+	self:UpdateGfx()
+end
+
+function gWidgetPrototype.UOButton:SetButtonGumpIDs		(gump_id_normal,gump_=
id_pressed,gump_id_over) =

+	if (self.gfx_normal) then self.gfx_normal:Destroy() end
+	if (self.gfx_pressed) then self.gfx_pressed:Destroy() end
+	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dgu=
mp_id_normal})
+	self.gfx_pressed	=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dgu=
mp_id_pressed})
 	self:UpdateGfx()
 end
 =


Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Sun Oct  5 02:59:54 2008
@@ -39,6 +39,8 @@
 	local w,h =3D params.width,params.height
 	if (w) then local l,t,r,b =3D self:GetRelBounds() self:SetClip(l,t,l+w,t+=
h) end
 end
+
+function gWidgetPrototype.UOText:SetText (text) self:SetUOHtml(text,false)=
 end
 =

 -- TODO : uohtml might be an array of ints for unicode (textline) instead =
of text (no html then)
 -- see also HtmlParser in lib.gumpparser.lua

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Sun Oct  5 02:59:54 2008
@@ -39,7 +39,6 @@
 	local bordert	=3D params.margin_top		or 0
 	local borderr	=3D params.margin_right	or 0
 	local borderb	=3D params.margin_bottom	or 0
-	print("UOToolTip:AdjustToContentBounds",l,t,r,b,borderl,bordert,borderr,b=
orderb)
 	gfxparams.xoff =3D l-borderl
 	gfxparams.yoff =3D t-bordert
 	local w,h =3D r-l,b-t
@@ -62,6 +61,7 @@
 		end
 	end
 	if (not tooltiptext) then tooltiptext =3D "???" end
+	--~ print("tooltiptext",tooltiptext)
 	self.text:SetUOHtml(tooltiptext,true)
 	local w,h =3D self.text:GetSize()
 	local vw,vh =3D GetViewportSize()



From no-reply at zwischenwelt.org  Sun Oct  5 16:20:20 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 05 Oct 2008 14:20:20 -0000
Subject: [Iris-commit] [IRIS] r2514 - /trunk/lua/widgets/widget.uotooltip.lua
Message-ID: <20081005142020.CA92B1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct  5 16:20:20 2008
New Revision: 2514

Log:
tooltip coloring

Modified:
    trunk/lua/widgets/widget.uotooltip.lua

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Sun Oct  5 16:20:20 2008
@@ -47,6 +47,19 @@
 	self.spritepanel:Update(gfxparams)
 end
 =

+-- returns r,g,b  in [0;1]
+function GetRedYellowGreen (f)
+	return 1 - max(0,min(1, f*2 - 1)),max(0,min(1,f*2)),0
+end
+
+function ToolTipColDura (duracur,duramax) =

+	duracur =3D tonumber(duracur)
+	duramax =3D tonumber(duramax)
+	local f =3D (duramax>0) and (duracur/duramax) or 0
+	local r,g,b =3D GetRedYellowGreen(f)
+	return sprintf("durability <BASEFONT COLOR=3D#%02X%02X%02X>%d / %d (%d%%)=
</BASEFONT>",r*255,g*255,b*255,duracur,duramax,f*100)
+end
+
 function gWidgetPrototype.UOToolTip:RefreshText ()
 	local serial =3D self.params.serial
 	local tooltiptext =3D AosToolTip_GetText(serial)
@@ -61,7 +74,16 @@
 		end
 	end
 	if (not tooltiptext) then tooltiptext =3D "???" end
-	--~ print("tooltiptext",tooltiptext)
+	=

+	tooltiptext =3D "<BASEFONT COLOR=3D#FFFF00>"..string.gsub(tooltiptext,"\n=
","</BASEFONT>\n",1)
+	tooltiptext =3D string.gsub(tooltiptext,"<b>Insured</b>","<b><BASEFONT CO=
LOR=3D#00FF00>Insured</BASEFONT></b>")
+	tooltiptext =3D string.gsub(tooltiptext,"durability (%d+) / (%d+)",ToolTi=
pColDura)
+	=

+	=

+
+	=

+	=

+	print("tooltiptext",tooltiptext)
 	self.text:SetUOHtml(tooltiptext,true)
 	local w,h =3D self.text:GetSize()
 	local vw,vh =3D GetViewportSize()



From no-reply at zwischenwelt.org  Sun Oct  5 20:56:40 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 05 Oct 2008 18:56:40 -0000
Subject: [Iris-commit] [IRIS] r2515 - in /trunk/lua: gui/gui.skill.lua
 gui/gui.spellbook.lua lib.desktop.lua lib.uotooltip.lua
 widgets/widget.uotooltip.lua widgets/widget.widget.uoquickcasticon.lua
Message-ID: <20081005190009.B26951C18654@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct  5 20:56:40 2008
New Revision: 2515

Log:
new tooltips for quickcast icons

Added:
    trunk/lua/widgets/widget.widget.uoquickcasticon.lua
Modified:
    trunk/lua/gui/gui.skill.lua
    trunk/lua/gui/gui.spellbook.lua
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.uotooltip.lua
    trunk/lua/widgets/widget.uotooltip.lua

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Sun Oct  5 20:56:40 2008
@@ -81,6 +81,7 @@
 -- Created 11.03.2008 15:41:19, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local quickskillGump =3D {}
+gQuickskillGump =3D quickskillGump
 quickskillGump.dialogId =3D 5000002
 quickskillGump.x =3D 0
 quickskillGump.y =3D 0
@@ -136,98 +137,20 @@
 	end
 end
 =

--- list of numbers assigned to quickcast functions
-glQuickCastHotkeys =3D {}
-
-glQuickCastDialog =3D {}
--- creates a quickcast button at the given position
-function CreateQuickCastButton (x,y,name,fun,gumpbuttonartid)
-	if x < 0 then x =3D 0 end
-	if y < 0 then y =3D 0 end
-	=

-	local dialog =3D nil
-	=

-	-- layout
-	if gumpbuttonartid then
-		-- gump button
-		dialog =3D guimaker.MakeSortedDialog()
-		dialog.rootwidget.gfx:SetPos(x,y)
-		local spellicon =3D MakeBorderGumpPart(dialog.rootwidget, gumpbuttonarti=
d, 0,0, nil,nil)
-		spellicon.mbIgnoreMouseOver =3D false
-
-		-- focus keybinding
-		spellicon.on_mouse_enter =3D function() SetFocusWidget(spellicon) end
-		spellicon.on_mouse_leave =3D function() ClearFocusWidget() end
-		spellicon.on_focus_keydown =3D function(widget,key,char)
-			if =

-				(gKeyPressed[key_lcontrol] or gKeyPressed[key_rcontrol]) and =

-				(key ~=3D key_lcontrol and key ~=3D key_rcontrol) =

-			then
-				BindDown(GetKeyName(key),fun)
-				-- print("KeyDown",char,key,GetKeyName(key))
-				return true
-			end
-		end
-		=

-
-		-- tooltip
-		spellicon.tooltip_offx =3D kUOToolTippOffX -- Both defined at
-		spellicon.tooltip_offy =3D kUOToolTippOffY -- obj.container.lua
-		spellicon.stylesetname =3D gGuiDefaultStyleSet
-		spellicon.on_simple_tooltip =3D function (widget) =

-			return (name) or "?" =

-		end =

-	else
-		-- simple text button
-		quickskillGump.x=3Dx
-		quickskillGump.y=3Dy
-
-		dialog =3D GumpParser( quickskillGump, true )
-
-		if string.len(name) > 10 then
-			name =3D string.sub(name,0,10)..".." =

-		end
-		=

-		local text =3D guimaker.MakeText(dialog.rootwidget, 20, 5, name, gFontDe=
fs["Gump"].size, gFontDefs["Gump"].col, gFontDefs["Gump"].name)
-	end
-	=

-	-- functionality
-	=

-	-- overrride dialog close function from gumpparser
-	dialog.Close =3D function (dialog)
-		NotifyListener("Hook_CloseQuickCastButton",dialog)
-		glQuickCastDialog[dialog] =3D nil
-		dialog:Destroy()
-	end
-	-- overwrite the onMouseDown function from gumpparser
-	dialog.onMouseDown =3D function (widget,mousebutton)
-		if (mousebutton =3D=3D 2) then widget.dialog:Close() end
-		if (mousebutton =3D=3D 1) then =

-			widget.dialog:BringToFront() =

-			gui.StartMoveDialog(widget.dialog.rootwidget) =

-		end
-	end
-	dialog.on_mouse_left_click_double =3D function (widget) fun() end
-
-	table.insert(glQuickCastDialog,dialog)
-
-	dialog:BringToFront()
-
-	return dialog
-end
 =

 function CreateQuickCastButtonSkill(x,y,skillid)
-	for k,v in pairs(glQuickCastDialog) do
-		if v and v.skillid and v.skillid =3D=3D skillid then
-			if v and v.rootwidget and v.rootwidget.gfx and v.rootwidget.gfx:IsAlive=
() then
+	for dialog,v in pairs(glQuickCastDialog) do
+       if dialog and dialog.skillid and dialog.skillid =3D=3D skillid then
+			if dialog and dialog.rootwidget and dialog.rootwidget.gfx and dialog.ro=
otwidget.gfx:IsAlive() then
+			--~ if dialog and dialog:IsAlive() then
 				-- reuse existing one
-				v.rootwidget.gfx:SetPos(x,y)
+				dialog.rootwidget.gfx:SetPos(x,y)
 				return
 			else
 				-- there is a broken one left, so close it
-				if v:IsAlive() then v:Close() end
-				if v:IsAlive() then v:Destroy() end
-				glQuickCastDialog[k] =3D nil
+				if dialog:IsAlive() then dialog:Close() end
+				if dialog:IsAlive() then dialog:Destroy() end
+				glQuickCastDialog[dialog] =3D nil
 			end
 		end
 	end
@@ -250,17 +173,16 @@
 =

 =

 function CreateQuickCastButtonWeaponability(x,y,weaponabilityid)
-	for k,v in pairs(glQuickCastDialog) do
-		if v and v.weaponabilityid and v.weaponabilityid =3D=3D weaponabilityid =
then
-			if v and v.rootwidget and v.rootwidget.gfx and v.rootwidget.gfx:IsAlive=
() then
+	for dialog,v in pairs(glQuickCastDialog) do
+		if dialog and dialog.weaponabilityid and dialog.weaponabilityid =3D=3D w=
eaponabilityid then
+			if dialog and dialog:IsAlive() then
 				-- reuse existing one
-				v.rootwidget.gfx:SetPos(x,y)
+				dialog:SetPos(x,y)
 				return
 			else
 				-- there is a broken one left, so close it
-				if v:IsAlive() then v:Close() end
-				if v:IsAlive() then v:Destroy() end
-				glQuickCastDialog[k] =3D nil
+				if dialog:IsAlive() then v:Destroy() end
+				glQuickCastDialog[dialog] =3D nil
 			end
 		end
 	end

Modified: trunk/lua/gui/gui.spellbook.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.spellbook.lua (original)
+++ trunk/lua/gui/gui.spellbook.lua Sun Oct  5 20:56:40 2008
@@ -35,17 +35,16 @@
 function CreateQuickCastButtonSpell(x,y,spellid,spelliconid)
 --	if true then return end
 =

-	for k,v in pairs(glQuickCastDialog) do
-		if v and v.spellid and v.spellid =3D=3D spellid then
-			if v and v.rootwidget and v.rootwidget.gfx and v.rootwidget.gfx:IsAlive=
() then
+	for dialog,v in pairs(glQuickCastDialog) do
+		if dialog and dialog.spellid and dialog.spellid =3D=3D spellid then
+			if dialog and dialog:IsAlive() then
 				-- reuse existing one
-				v.rootwidget.gfx:SetPos(x,y)
+				dialog:SetPos(x,y)
 				return
 			else
 				-- there is a broken one left, so close it
-				if v:IsAlive() then v:Close() end
-				if v:IsAlive() then v:Destroy() end
-				glQuickCastDialog[k] =3D nil
+				if dialog:IsAlive() then dialog:Destroy() end
+				glQuickCastDialog[dialog] =3D nil
 			end
 		end
 	end

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Sun Oct  5 20:56:40 2008
@@ -31,7 +31,7 @@
 	checkpos =3D function(e, widget) =

 		local d =3D widget.dialog
 		if d and d.weaponabilityid and d.weaponabilityid =3D=3D e.param then
-			e.x,e.y =3D widget.gfx:GetPos() =

+			e.x,e.y =3D widget:GetPos() =

 			return true
 		end
 	end,
@@ -54,7 +54,7 @@
 	checkpos =3D function(e, widget) =

 		local d =3D widget.dialog
 		if d and d.spellid and d.spellid =3D=3D e.param then
-			e.x,e.y =3D widget.gfx:GetPos() =

+			e.x,e.y =3D widget:GetPos() =

 			return true
 		end
 	end,

Modified: trunk/lua/lib.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uotooltip.lua (original)
+++ trunk/lua/lib.uotooltip.lua Sun Oct  5 20:56:40 2008
@@ -3,7 +3,7 @@
 =

 function SetUOToolTipAtMouse (serial)
 	if (gUOToolTipSerial =3D=3D serial) then return end
-	if (gUOToolTipDialog) then gUOToolTipDialog:Destroy() gUOToolTipDialog =
=3D nil end
+	CloseOldUOToolTip()
 	gUOToolTipSerial =3D serial
 	if (not serial) then return end
 	=

@@ -13,3 +13,14 @@
 	local iMouseX,iMouseY =3D GetMousePos()
 	gUOToolTipDialog =3D gRootWidget.tooltip:CreateChild("UOToolTip",{serial=
=3Dserial,x=3DiMouseX,y=3DiMouseY+32})
 end
+
+function CloseOldUOToolTip ()
+	if (gUOToolTipDialog) then gUOToolTipDialog:Destroy() gUOToolTipDialog =
=3D nil end
+	gUOToolTipSerial =3D nil
+end
+
+function StartUOToolTipAtMouse_Text (text)
+	CloseOldUOToolTip()
+	local iMouseX,iMouseY =3D GetMousePos()
+	gUOToolTipDialog =3D gRootWidget.tooltip:CreateChild("UOToolTip",{text=3D=
text,x=3DiMouseX,y=3DiMouseY+32})
+end

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Sun Oct  5 20:56:40 2008
@@ -4,7 +4,7 @@
 =

 RegisterWidgetClass("UOToolTip")
 =

--- params =3D {serial=3Dserial,x=3DiMouseX,y=3DiMouseY}
+-- params =3D {serial=3Dserial/nil,text=3Dtext/nil,x=3DiMouseX,y=3DiMouseY}
 function gWidgetPrototype.UOToolTip:Init (parentwidget, params)
 	self.params	=3D params
 	params.gfxparam_init		=3D params.gfxparam_init	or	MakeSpritePanelParam_Bo=
rderPartMatrix(GetPlainTextureGUIMat("sience_border.png")
@@ -61,16 +61,19 @@
 end
 =

 function gWidgetPrototype.UOToolTip:RefreshText ()
+	local tooltiptext =3D self.params.text
 	local serial =3D self.params.serial
-	local tooltiptext =3D AosToolTip_GetText(serial)
-	if (not tooltiptext) then
-		local mobile =3D GetMobile(serial)
-		if (mobile) then =

-			tooltiptext =3D mobile.name =

-		else
-			local item =3D GetDynamic(serial)
-			local artid =3D item and item.artid
-			if (artid) then tooltiptext =3D GetStaticTileTypeName(artid) end
+	if (serial) then =

+		tooltiptext =3D AosToolTip_GetText(serial)
+		if (not tooltiptext) then
+			local mobile =3D GetMobile(serial)
+			if (mobile) then =

+				tooltiptext =3D mobile.name =

+			else
+				local item =3D GetDynamic(serial)
+				local artid =3D item and item.artid
+				if (artid) then tooltiptext =3D GetStaticTileTypeName(artid) end
+			end
 		end
 	end
 	if (not tooltiptext) then tooltiptext =3D "???" end
@@ -79,11 +82,7 @@
 	tooltiptext =3D string.gsub(tooltiptext,"<b>Insured</b>","<b><BASEFONT CO=
LOR=3D#00FF00>Insured</BASEFONT></b>")
 	tooltiptext =3D string.gsub(tooltiptext,"durability (%d+) / (%d+)",ToolTi=
pColDura)
 	=

-	=

-
-	=

-	=

-	print("tooltiptext",tooltiptext)
+	--~ print("tooltiptext",tooltiptext)
 	self.text:SetUOHtml(tooltiptext,true)
 	local w,h =3D self.text:GetSize()
 	local vw,vh =3D GetViewportSize()



From no-reply at zwischenwelt.org  Sun Oct  5 21:11:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 05 Oct 2008 19:11:38 -0000
Subject: [Iris-commit] [IRIS] r2516 - in /trunk/lua: lib.loading.lua
	lib.mainmenu.lua
Message-ID: <20081005191139.1FA1C1524030@zwischenwelt.org>

Author: hagish
Date: Sun Oct  5 21:11:38 2008
New Revision: 2516

Log:
moved gDefaultMaps handling into LoadMap

Modified:
    trunk/lua/lib.loading.lua
    trunk/lua/lib.mainmenu.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Sun Oct  5 21:11:38 2008
@@ -367,6 +367,12 @@
 	MapClearCache()
 	print("gMapIndex",gMapIndex)
 =

+	-- fallback to default maps because wrong map is better that client crash
+	if gMaps =3D=3D nil or gMaps[index] =3D=3D nil then
+		gMaps =3D gMaps or {}
+		gMaps[index] =3D gDefaultMaps[index]
+	end
+	=

 	if (not gInitialMapLoaded) then LoadingProfile("load MapInfo") end
 	if (gMaps[index] =3D=3D nil) then print("Map"..index..".mul not found. Pl=
ease look into your UO directory to verify this.") Crash() end
 =


Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sun Oct  5 21:11:38 2008
@@ -89,9 +89,6 @@
 =

 -- postxt is a string for the position, e.g. 5260,1333  , can be nil
 local function StartOfflineMode (postxt)
-	-- reset to default maps
-	gMaps =3D {}	ArrayOverwrite(gMaps,gDefaultMaps)
-	=

 	if (gOfflineModeMapIndex) then MapChangeRequest(gOfflineModeMapIndex) end
 	=

 	gDialog_IrisLogo:SetVisible(false)
@@ -334,9 +331,6 @@
 end
 =

 function StartMainMenu ()
-	-- reset to default maps
-	gMaps =3D {}	ArrayOverwrite(gMaps,gDefaultMaps)
-
 	if (gTestNoMainMenu) then return end
 	if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end -- =
journaltest
 	if (gCommandLineSwitches["-jt"]) then ToggleJournal() return end -- journ=
altest



From no-reply at zwischenwelt.org  Sun Oct  5 21:27:43 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 05 Oct 2008 19:27:43 -0000
Subject: [Iris-commit] [IRIS] r2517 - /trunk/lua/gui/gui.paperdoll.lua
Message-ID: <20081005192743.56A1E1C1877B@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct  5 21:27:42 2008
New Revision: 2517

Log:
fixed npc paperdoll

Modified:
    trunk/lua/gui/gui.paperdoll.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Sun Oct  5 21:27:42 2008
@@ -117,6 +117,7 @@
 -- Created 08.03.2008 12:25:56, with GumpStudio & Iris2 Lua Export Plugin
 -- Exported Iris2 GumpExporter ver 1.0.
 local npcPaperdoll =3D {}
+npcPaperdoll.bSupportsGuiSys2 =3D true
 npcPaperdoll.dialogId =3D 1000002
 npcPaperdoll.x =3D 120
 npcPaperdoll.y =3D 100



From no-reply at zwischenwelt.org  Mon Oct  6 12:25:50 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 10:25:50 -0000
Subject: [Iris-commit] [IRIS] r2518 - in /trunk/lua: gui/gui.popup.lua
 lib.mousepick.lua net/net.other.lua
Message-ID: <20081006102550.910EB1C1877B@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct  6 12:25:48 2008
New Revision: 2518

Log:
fixed popup and added size check to kPacket_Generic_SubCommand_CloseGeneric=
Gump

Modified:
    trunk/lua/gui/gui.popup.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/net/net.other.lua

Modified: trunk/lua/gui/gui.popup.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.popup.lua (original)
+++ trunk/lua/gui/gui.popup.lua Mon Oct  6 12:25:48 2008
@@ -40,7 +40,7 @@
 --- close global unique popup, for left-click-close-popup
 function ClosePopUpMenu (widget)
 	--- close popup if no widget selected or other than this popup
-	if gPopupMenu and (widget =3D=3D nil or gPopupMenu.dialog ~=3D widget.dia=
log) then =

+	if gPopupMenu then --  and (widget =3D=3D nil or gPopupMenu.dialog ~=3D w=
idget.dialog) =

 		gPopupMenu:Close() =

 	end
 end

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Mon Oct  6 12:25:48 2008
@@ -27,9 +27,6 @@
 	if (not widget) then gCurrentRenderer:MousePick_Scene() end
 	=

 	gCurrentRenderer:MousePick_ShowHits()
-	=

-	-- close context/popup menu if currently open, widget is the currently cl=
icked widget, to ignore close in context menu
-	ClosePopUpMenu(widget)
 end
 =

 =

@@ -103,6 +100,7 @@
 =

 function IrisDoubleClick ()
 	MainMousePick()
+	ClosePopUpMenu()
 	local iSerial =3D GetMouseHitSerial()
 	if gKeyPressed[key_lcontrol] then
 		-- open status window if control pressed and mobile targeted
@@ -139,6 +137,7 @@
 gbMouseLastLeftDownWasTargetPositionX =3D 0
 gbMouseLastLeftDownWasTargetPositionY =3D 0
 function IrisLeftClickDown ()
+	ClosePopUpMenu()
 	gbMouseLastLeftDownWasTarget =3D false
 	gbMouseLastLeftDownWasTargetPositionX, gbMouseLastLeftDownWasTargetPositi=
onY =3D GetMousePos()
 	=

@@ -150,6 +149,7 @@
 end
 =

 function IrisSingleClick ()
+	ClosePopUpMenu()
 	if (gTestNoClick) then return end
 =

 	local x, y =3D GetMousePos()

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Mon Oct  6 12:25:48 2008
@@ -165,7 +165,7 @@
 	--BYTE[4] buttonId // response buttonID for packet 0xB1
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_CloseGenericGump) then -- 0x=
04
 		local dialogId =3D input:PopNetUint32()
-		local buttonId =3D input:PopNetUint32()
+		local buttonId =3D (size >=3D 5+4+4) and input:PopNetUint32() or 0
 		local playermobile =3D GetPlayerMobile()
 		CloseServerSideGump(playermobile.serial,dialogId,buttonId)
 		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_CloseGenericGu=
mp (0xbf sub=3D0x04)"))



From no-reply at zwischenwelt.org  Mon Oct  6 13:02:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 11:02:25 -0000
Subject: [Iris-commit] [IRIS] r2520 - /branches/stable_release/
Message-ID: <20081006120009.777D41C187D4@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct  6 13:02:16 2008
New Revision: 2520

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r2519, trunk/



From no-reply at zwischenwelt.org  Mon Oct  6 13:02:10 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 11:02:10 -0000
Subject: [Iris-commit] [IRIS] r2519 - /branches/stable_release/
Message-ID: <20081006120009.352CE1C187D0@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct  6 13:02:03 2008
New Revision: 2519

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Mon Oct  6 13:29:56 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 11:29:56 -0000
Subject: [Iris-commit] [IRIS] r2522 - /branches/stable_release/
Message-ID: <20081006120014.BDFE51C18259@zwischenwelt.org>

Author: root
Date: Mon Oct  6 13:29:53 2008
New Revision: 2522

Log:
lugre svn://zwischenwelt.org/lugre/trunk/lugre

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Mon Oct  6 13:30:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 11:30:54 -0000
Subject: [Iris-commit] [IRIS] r2525 - /branches/stable_release/
Message-ID: <20081006120015.59EA71C18020@zwischenwelt.org>

Author: root
Date: Mon Oct  6 13:30:54 2008
New Revision: 2525

Log:
lugre -r569 svn://zwischenwelt.org/lugre/trunk/lugre

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Mon Oct  6 13:28:45 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 11:28:45 -0000
Subject: [Iris-commit] [IRIS] r2521 - /branches/stable_release/
Message-ID: <20081006120010.B210B1C186AC@zwischenwelt.org>

Author: root
Date: Mon Oct  6 13:28:45 2008
New Revision: 2521

Log:
test

Modified:
    branches/stable_release/   (props changed)



From no-reply at zwischenwelt.org  Mon Oct  6 13:30:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 11:30:53 -0000
Subject: [Iris-commit] [IRIS] r2523 - /branches/stable_release/
Message-ID: <20081006120014.EE5151C186AC@zwischenwelt.org>

Author: root
Date: Mon Oct  6 13:30:53 2008
New Revision: 2523

Log:
removing stable for trunk -> stable update

Removed:
    branches/stable_release/



From no-reply at zwischenwelt.org  Mon Oct  6 13:30:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 11:30:54 -0000
Subject: [Iris-commit] [IRIS] r2524 - /branches/stable_release/
Message-ID: <20081006120015.294451C18789@zwischenwelt.org>

Author: root
Date: Mon Oct  6 13:30:54 2008
New Revision: 2524

Log:
copying trunk to stable

Added:
    branches/stable_release/
      - copied from r2523, trunk/



From no-reply at zwischenwelt.org  Tue Oct  7 00:33:27 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 06 Oct 2008 22:33:27 -0000
Subject: [Iris-commit] [IRIS] r2526 - in /trunk/lua: filter/filter.art.lua
 lib.mapblock.3d.statics.lua
Message-ID: <20081006230032.03A4C1C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct  7 00:33:27 2008
New Revision: 2526

Log:
added filter for skipping statics while on ground, suggested by mrr

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.mapblock.3d.statics.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Tue Oct  7 00:33:27 2008
@@ -38,6 +38,11 @@
 	else
 		return 0,0,0
 	end
+end
+
+gFilterSkipStatic =3D {}
+function FilterSkipStatic (iTileTypeID)
+	return gFilterSkipStatic[iTileTypeID] ~=3D nil
 end
 =

 -- checks if the given tiletype is a water tile

Modified: trunk/lua/lib.mapblock.3d.statics.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.statics.lua (original)
+++ trunk/lua/lib.mapblock.3d.statics.lua Tue Oct  7 00:33:27 2008
@@ -63,7 +63,7 @@
 			for k,s in pairs(l) do =

 				iTileTypeID,iX,iY,iZ,iHue =3D s.artid, s.tx, s.ty, s.zloc, s.hue
 				=

-				if not FilterIsStaticWater(iTileTypeID) and iTileTypeID and iX and iY =
and iZ then =

+				if (not FilterIsStaticWater(iTileTypeID)) and iTileTypeID and iX and i=
Y and iZ and (not FilterSkipStatic(iTileTypeID)) then =

 					-- uo tile pos
 					local xloc,yloc =3D (iBlockUO_X+x)*8+iX,(iBlockUO_Y+y)*8+iY
 					if =




From no-reply at zwischenwelt.org  Tue Oct  7 15:16:47 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 07 Oct 2008 13:16:47 -0000
Subject: [Iris-commit] [IRIS] r2527 -
	/trunk/lua/widgets/widget.widget.uoquickcasticon.lua
Message-ID: <20081007131647.AEB041C18451@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct  7 15:16:47 2008
New Revision: 2527

Log:
3d : quickcast-tooltips close now

Modified:
    trunk/lua/widgets/widget.widget.uoquickcasticon.lua

Modified: trunk/lua/widgets/widget.widget.uoquickcasticon.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.widget.uoquickcasticon.lua (original)
+++ trunk/lua/widgets/widget.widget.uoquickcasticon.lua Tue Oct  7 15:16:47=
 2008
@@ -83,7 +83,7 @@
 	glQuickCastDialog[self] =3D nil
 end
 =

-function gWidgetPrototype.UOQuickCastIcon:on_mouse_leave ()	end
+function gWidgetPrototype.UOQuickCastIcon:on_mouse_leave ()	CloseOldUOTool=
Tip() end
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_enter () StartUOToolTip=
AtMouse_Text(self.params.name) end
 =

 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_click_double	() se=
lf.params.fun() end



From no-reply at zwischenwelt.org  Tue Oct  7 21:43:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 07 Oct 2008 19:43:34 -0000
Subject: [Iris-commit] [IRIS] r2528 - /trunk/bin/iris2.exe
Message-ID: <20081007194334.57A471C185B2@zwischenwelt.org>

Author: sience
Date: Tue Oct  7 21:43:33 2008
New Revision: 2528

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Tue Oct  7 21:50:13 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 07 Oct 2008 19:50:13 -0000
Subject: [Iris-commit] [IRIS] r2529 - in /trunk: cb/THIS_IS_OBSOLETE
 lua/main.lua vc7/THIS_IS_OBSOLETE vc9/THIS_IS_OBSOLETE
Message-ID: <20081007195013.7080B1C1869B@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct  7 21:50:11 2008
New Revision: 2529

Log:
2d renderer choosable via config now (was overwritten in main.lua), marked =
obsolete projectfiles

Added:
    trunk/cb/THIS_IS_OBSOLETE
    trunk/vc7/THIS_IS_OBSOLETE
    trunk/vc9/THIS_IS_OBSOLETE
Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Oct  7 21:50:11 2008
@@ -294,7 +294,7 @@
 	=

 	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end
 =

-	gCurrentRenderer =3D Renderer3D
+	gCurrentRenderer =3D gCurrentRenderer or Renderer3D
 	if (gCommandLineSwitches["-2d"]) then gCurrentRenderer =3D Renderer2D end
 	if (gCommandLineSwitches["-3d"]) then gCurrentRenderer =3D Renderer3D end
 	=




From no-reply at zwischenwelt.org  Sat Oct 11 00:20:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 10 Oct 2008 22:20:36 -0000
Subject: [Iris-commit] [IRIS] r2530 - in /trunk: lua/ lua/gui/ lua/net/
	lua/widgets/ plugins/
Message-ID: <20081010222039.A415A1C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 00:20:34 2008
New Revision: 2530

Log:
new tooltip widgets used for 3d as well, auto-request tooltips for objects =
if the server hasn't sent them

Modified:
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.uotooltip.lua
    trunk/lua/net/net.packethandlers.lua
    trunk/lua/widgets/widget.uocontaineritem.lua
    trunk/lua/widgets/widget.uopaperdollitem.lua
    trunk/lua/widgets/widget.widget.uoquickcasticon.lua
    trunk/plugins/hudenemylist.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Sat Oct 11 00:20:34 2008
@@ -423,6 +423,7 @@
 			local k =3D gLayerTypeName[layer]
 			local item =3D GetMobileEquipmentItem(mobile,layer)
 			if (item) then =

+				AosToolTip_GetText(item.serial)
 				local gumpid =3D GetPaperdollItemGumpID(item.artid,base_id)
 				if (gumpid) then PreLoadGump(gumpid) end
 				if gLayerOrderPositionAndArtOverwrite[layer] then PreLoadArt(item.arti=
d + 0x4000) end

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Sat Oct 11 00:20:34 2008
@@ -15,7 +15,7 @@
 		if (serial =3D=3D 0) then serial =3D nil end
 	end
 	=

-	SetUOToolTipAtMouse(serial)
+	StartUOToolTipAtMouse_Serial(serial)
 end
 =

 function Renderer2D:MousePick_Scene () =


Modified: trunk/lua/lib.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uotooltip.lua (original)
+++ trunk/lua/lib.uotooltip.lua Sat Oct 11 00:20:34 2008
@@ -1,7 +1,7 @@
 gUOToolTipSerial =3D nil
 gUOToolTipDialog =3D nil
 =

-function SetUOToolTipAtMouse (serial)
+function StartUOToolTipAtMouse_Serial (serial)
 	if (gUOToolTipSerial =3D=3D serial) then return end
 	CloseOldUOToolTip()
 	gUOToolTipSerial =3D serial
@@ -12,10 +12,14 @@
 	=

 	local iMouseX,iMouseY =3D GetMousePos()
 	gUOToolTipDialog =3D gRootWidget.tooltip:CreateChild("UOToolTip",{serial=
=3Dserial,x=3DiMouseX,y=3DiMouseY+32})
+	return gUOToolTipDialog
 end
 =

 function CloseOldUOToolTip ()
-	if (gUOToolTipDialog) then gUOToolTipDialog:Destroy() gUOToolTipDialog =
=3D nil end
+	if (gUOToolTipDialog) then =

+		if (gUOToolTipDialog:IsAlive()) then gUOToolTipDialog:Destroy() end
+		gUOToolTipDialog =3D nil =

+	end
 	gUOToolTipSerial =3D nil
 end
 =

@@ -23,4 +27,118 @@
 	CloseOldUOToolTip()
 	local iMouseX,iMouseY =3D GetMousePos()
 	gUOToolTipDialog =3D gRootWidget.tooltip:CreateChild("UOToolTip",{text=3D=
text,x=3DiMouseX,y=3DiMouseY+32})
+	return gUOToolTipDialog
 end
+
+
+
+
+
+
+
+-- if clilochash is wrong, request new megacliloc tooltip from server
+-- used in function gPacketHandler.kPacket_AOSObjProp()  &  gPacketHandler=
.kPacket_Generic_Command()
+function Send_ToolTipRequest(objserial)
+	gAosToolTipRequested[objserial] =3D true =

+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Generic_Command)
+	out:PushNetUint16(hex2num("0x0009"))
+	out:PushNetUint16(hex2num("0x0010"))
+	out:PushNetUint32(objserial)
+	out:SendPacket()
+end
+
+--Client -> Server: 0xD6 (AOSToolTip), frequ: 1, len: 0x07
+--word	- Packet Size
+--loop	- Item Info; count =3D (Packet Size-3)/4
+--dword	- Serial
+--endloop	- Item Info
+function Send_AosToolTipRequest(objserial)
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Mega_Cliloc)
+	out:PushNetUint16(hex2num("0x0007"))
+	out:PushNetUint32(objserial)
+	out:SendPacket()
+end
+
+gAosToolTipHash =3D {}
+gAosToolTipText =3D {}
+gAosToolTipRequested =3D {}
+function AosToolTip_GetHash (serial) return gAosToolTipHash[serial] end
+function AosToolTip_GetText (serial) =

+	local tip =3D gAosToolTipText[serial]
+	if (tip) then return tip end
+	if (gAosToolTipRequested[serial]) then return end -- already requested
+	Send_ToolTipRequest(serial) -- tooltip might be available next time
+end
+function AosToolTip_SetHash (serial,hash) gAosToolTipHash[serial] =3D hash=
 end
+function AosToolTip_SetText (serial,text) gAosToolTipText[serial] =3D text=
 end
+
+-- Newer packet as of late 2004.
+-- Is now used on OSI to handle the Revision of Tooltips instead of the or=
iginal 0xBF methods it appears.
+-- server sends these automatically when a new object appears, doesn't hav=
e to be requested
+function gPacketHandler.kPacket_AOSObjProp()	--0xDC (9 bytes)
+	local input =3D GetRecvFIFO()
+	local id =3D input:PopNetUint8()
+	local objserial =3D input:PopNetUint32()			--Item/Mob-Serial
+	local objrevision_hash =3D input:PopNetUint32()
+	printdebug("net",sprintf("NET: AOSObjProp objserial=3D0x%08x objrevision_=
hash=3D0x%08x\n",objserial,objrevision_hash))
+	if (AosToolTip_GetHash(objserial) ~=3D objrevision_hash) then
+		AosToolTip_SetHash(objserial,objrevision_hash)
+		-- print("Send_ToolTipRequest",objserial,objrevision_hash)
+		Send_ToolTipRequest(objserial)
+	end
+end
+
+-- Mega Cliloc - server sends new Clilocs - just add them to the Cliloc
+-- TODO : this cliloc additions might be local to a specific mobile, e.g. =
vendor or container...
+function gPacketHandler.kPacket_Mega_Cliloc()	--0xD6
+	local input			=3D GetRecvFIFO()
+	local id			=3D input:PopNetUint8()
+	local size			=3D input:PopNetUint16()
+	local unknown1		=3D input:PopNetUint16()	--0x0001 or 0x4000 !?
+	local serial		=3D input:PopNetUint32()	--Serial of item/creature
+	local unknown2		=3D input:PopNetUint16()	--0x0000 !?
+	local unknown3		=3D input:PopNetUint32()	--another serial? hash? weird fl=
ags ? position ? 0x030c0ca3
+		-- unknown3 in old iris code : obj/character->SetAOSTooltipID(listID);
+	=

+	local totaltext =3D ""
+	local bFirst =3D true
+	=

+	while true do =

+		local cliloc_id =3D input:PopNetUint32()
+		if (cliloc_id =3D=3D 0x00000000) then break end
+		local cliloctext =3D gClilocLoader and gClilocLoader:Get(cliloc_id) or ""
+		=

+		local number_of_unicode_chars =3D input:PopNetUint16() / 2
+		local text =3D ""
+		local totalparamtext =3D ""
+		local debugtxt =3D ""
+		local params =3D {}
+		for i =3D 1,number_of_unicode_chars do  -- read unicode text and split b=
y 0x09 =3D tab
+			local head =3D input:PopUint8()
+			local data =3D input:PopUint8()
+			local c =3D ((head~=3D0) and string.char(head) or "?")
+			if (head =3D=3D 9 and data =3D=3D 0) then -- delimiter =3D tab=3D0x09
+				table.insert(params,text)
+				text =3D ""
+			else
+				text =3D text..c
+			end
+			totalparamtext =3D totalparamtext..c
+			debugtxt =3D debugtxt.."("..head..","..data..":"..c..")"
+		end
+		table.insert(params,text)
+		=

+		local text =3D string.gsub(ParameterizedClilocText(cliloc_id,params),"<b=
r>","\n")
+		=

+		if (bFirst) then bFirst =3D false else totaltext =3D totaltext.."\n" end
+		totaltext =3D totaltext..text
+		--~ printf("NET: Mega_Cliloc LINE : text=3D'%s' clilocbase=3D'%s' totalp=
aramtext=3D'%s' debug=3D%s\n",text,cliloctext,totalparamtext,debugtxt)
+	end
+	printdebug("net", sprintf("NET: Mega_Cliloc : serial=3D%d u3=3D%d text=3D=
'%s'\n",serial,unknown3,totaltext) )
+	AosToolTip_SetText(serial,totaltext)
+end
+
+
+

Modified: trunk/lua/net/net.packethandlers.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.packethandlers.lua (original)
+++ trunk/lua/net/net.packethandlers.lua Sat Oct 11 00:20:34 2008
@@ -32,100 +32,3 @@
 	NotifyWarmode(flag)
 end
 =

--- if clilochash is wrong, request new megacliloc tooltip from server
--- used in function gPacketHandler.kPacket_AOSObjProp()  &  gPacketHandler=
.kPacket_Generic_Command()
-function Send_ToolTipRequest(objserial)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(hex2num("0x0009"))
-	out:PushNetUint16(hex2num("0x0010"))
-	out:PushNetUint32(objserial)
-	out:SendPacket()
-end
-
---Client -> Server: 0xD6 (AOSToolTip), frequ: 1, len: 0x07
---word	- Packet Size
---loop	- Item Info; count =3D (Packet Size-3)/4
---dword	- Serial
---endloop	- Item Info
-function Send_AosToolTipRequest(objserial)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Mega_Cliloc)
-	out:PushNetUint16(hex2num("0x0007"))
-	out:PushNetUint32(objserial)
-	out:SendPacket()
-end
-
-gAosToolTipHash =3D {}
-gAosToolTipText =3D {}
-function AosToolTip_GetHash (serial) return gAosToolTipHash[serial] end
-function AosToolTip_GetText (serial) return gAosToolTipText[serial] end
-function AosToolTip_SetHash (serial,hash) gAosToolTipHash[serial] =3D hash=
 end
-function AosToolTip_SetText (serial,text) gAosToolTipText[serial] =3D text=
 end
-
--- Newer packet as of late 2004.
--- Is now used on OSI to handle the Revision of Tooltips instead of the or=
iginal 0xBF methods it appears.
--- server sends these automatically when a new object appears, doesn't hav=
e to be requested
-function gPacketHandler.kPacket_AOSObjProp()	--0xDC (9 bytes)
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local objserial =3D input:PopNetUint32()			--Item/Mob-Serial
-	local objrevision_hash =3D input:PopNetUint32()
-	printdebug("net",sprintf("NET: AOSObjProp objserial=3D0x%08x objrevision_=
hash=3D0x%08x\n",objserial,objrevision_hash))
-	if (AosToolTip_GetHash(objserial) ~=3D objrevision_hash) then
-		AosToolTip_SetHash(objserial,objrevision_hash)
-		-- print("Send_ToolTipRequest",objserial,objrevision_hash)
-		Send_ToolTipRequest(objserial)
-	end
-end
-
--- Mega Cliloc - server sends new Clilocs - just add them to the Cliloc
--- TODO : this cliloc additions might be local to a specific mobile, e.g. =
vendor or container...
-function gPacketHandler.kPacket_Mega_Cliloc()	--0xD6
-	local input			=3D GetRecvFIFO()
-	local id			=3D input:PopNetUint8()
-	local size			=3D input:PopNetUint16()
-	local unknown1		=3D input:PopNetUint16()	--0x0001 or 0x4000 !?
-	local serial		=3D input:PopNetUint32()	--Serial of item/creature
-	local unknown2		=3D input:PopNetUint16()	--0x0000 !?
-	local unknown3		=3D input:PopNetUint32()	--another serial? hash? weird fl=
ags ? position ? 0x030c0ca3
-		-- unknown3 in old iris code : obj/character->SetAOSTooltipID(listID);
-	=

-	local totaltext =3D ""
-	local bFirst =3D true
-	=

-	while true do =

-		local cliloc_id =3D input:PopNetUint32()
-		if (cliloc_id =3D=3D hex2num("0x00000000")) then break end
-		local cliloctext =3D gClilocLoader and gClilocLoader:Get(cliloc_id) or ""
-		=

-		local number_of_unicode_chars =3D input:PopNetUint16() / 2
-		local text =3D ""
-		local totalparamtext =3D ""
-		local debugtxt =3D ""
-		local params =3D {}
-		for i =3D 1,number_of_unicode_chars do  -- read unicode text and split b=
y 0x09 =3D tab
-			local head =3D input:PopUint8()
-			local data =3D input:PopUint8()
-			local c =3D ((head~=3D0) and string.char(head) or "?")
-			if (head =3D=3D 9 and data =3D=3D 0) then -- delimiter =3D tab=3D0x09
-				table.insert(params,text)
-				text =3D ""
-			else
-				text =3D text..c
-			end
-			totalparamtext =3D totalparamtext..c
-			debugtxt =3D debugtxt.."("..head..","..data..":"..c..")"
-		end
-		table.insert(params,text)
-		=

-		local text =3D string.gsub(ParameterizedClilocText(cliloc_id,params),"<b=
r>","\n")
-		=

-		if (bFirst) then bFirst =3D false else totaltext =3D totaltext.."\n" end
-		totaltext =3D totaltext..text
-		--~ printf("NET: Mega_Cliloc LINE : text=3D'%s' clilocbase=3D'%s' totalp=
aramtext=3D'%s' debug=3D%s\n",text,cliloctext,totalparamtext,debugtxt)
-	end
-	printdebug("net", sprintf("NET: Mega_Cliloc : serial=3D%d u3=3D%d text=3D=
'%s'\n",serial,unknown3,totaltext) )
-	AosToolTip_SetText(serial,totaltext)
-end
-

Modified: trunk/lua/widgets/widget.uocontaineritem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uocontaineritem.lua (original)
+++ trunk/lua/widgets/widget.uocontaineritem.lua Sat Oct 11 00:20:34 2008
@@ -58,8 +58,5 @@
 function gWidgetPrototype.UOContainerItemWidget:on_mouse_left_down	() end
 function gWidgetPrototype.UOContainerItemWidget:on_mouse_right_down	() end
 =

-function gWidgetPrototype.UOContainerItemWidget:on_simple_tooltip	()
-	if (gCurrentRenderer.gUOToolTipOverride) then return end -- if this is tr=
ue, then the rendererer handles tooltips
-	local tooltiptext =3D AosToolTip_GetText(self.item.serial) or ""
-	return (tooltiptext .. " \n ") or "?" -- add newline, workaround for tool=
tip sizecalc bug
-end
+function gWidgetPrototype.UOContainerItemWidget:on_tooltip	() return Start=
UOToolTipAtMouse_Serial(self.item.serial) end
+

Modified: trunk/lua/widgets/widget.uopaperdollitem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uopaperdollitem.lua (original)
+++ trunk/lua/widgets/widget.uopaperdollitem.lua Sat Oct 11 00:20:34 2008
@@ -58,8 +58,4 @@
 function gWidgetPrototype.UOPaperdollItemWidget:on_mouse_left_down	() end
 function gWidgetPrototype.UOPaperdollItemWidget:on_mouse_right_down	() end
 =

-function gWidgetPrototype.UOPaperdollItemWidget:on_simple_tooltip	()
-	if (gCurrentRenderer.gUOToolTipOverride) then return end -- if this is tr=
ue, then the rendererer handles tooltips
-	local tooltiptext =3D AosToolTip_GetText(self.item.serial) or ""
-	return (tooltiptext .. " \n ") or "?" -- add newline, workaround for tool=
tip sizecalc bug
-end
+function gWidgetPrototype.UOPaperdollItemWidget:on_tooltip	() return Start=
UOToolTipAtMouse_Serial(self.item.serial) end

Modified: trunk/lua/widgets/widget.widget.uoquickcasticon.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.widget.uoquickcasticon.lua (original)
+++ trunk/lua/widgets/widget.widget.uoquickcasticon.lua Sat Oct 11 00:20:34=
 2008
@@ -83,17 +83,11 @@
 	glQuickCastDialog[self] =3D nil
 end
 =

-function gWidgetPrototype.UOQuickCastIcon:on_mouse_leave ()	CloseOldUOTool=
Tip() end
-function gWidgetPrototype.UOQuickCastIcon:on_mouse_enter () StartUOToolTip=
AtMouse_Text(self.params.name) end
-
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_click_double	() se=
lf.params.fun() end
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_down			() self:Bri=
ngToFront() self:StartMouseMove() end
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_right_down			() self:De=
stroy() end
 =

-function gWidgetPrototype.UOQuickCastIcon:on_simple_tooltip	() StartUOTool=
TipAtMouse_Text() end
-function gWidgetPrototype.UOQuickCastIcon:on_simple_tooltip	()
-	--~ return self.params.name or "???"
-end
+function gWidgetPrototype.UOQuickCastIcon:on_tooltip	() return StartUOTool=
TipAtMouse_Text(self.params.name) end
 =

 --[[ =

 TODO : keybinding when in focus :  (port me to new gui system)

Modified: trunk/plugins/hudenemylist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/hudenemylist.lua (original)
+++ trunk/plugins/hudenemylist.lua Sat Oct 11 00:20:34 2008
@@ -102,10 +102,8 @@
 	bar.widget_bg.tooltip_offy =3D kUOToolTippOffY -- obj.container.lua
 	bar.widget_bg.stylesetname =3D gGuiDefaultStyleSet
 	bar.widget_bg.mobile =3D body -- for mousepick
-	bar.widget_bg.on_simple_tooltip =3D function (widget) =

-		if (gCurrentRenderer.gUOToolTipOverride) then return end -- if this is t=
rue, then the rendererer handles tooltips
-		return AosToolTip_GetText(body.serial) or body.name or "?" =

-	end =

+	=

+	bar.widget_bg.on_tooltip =3D function (self) return StartUOToolTipAtMouse=
_Serial(body.serial) end
 	-- Ende Tooltip Mod
 =

 	local matname =3D GetPlainTextureMat("bar07.png",true)



From no-reply at zwischenwelt.org  Sat Oct 11 00:22:51 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 10 Oct 2008 22:22:51 -0000
Subject: [Iris-commit] [IRIS] r2531 - /trunk/lua/lib.2d.renderer.lua
Message-ID: <20081010222251.C1C1D1C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 00:22:51 2008
New Revision: 2531

Log:
2d : prevent righclick-closegump-walk

Modified:
    trunk/lua/lib.2d.renderer.lua

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Sat Oct 11 00:22:51 2008
@@ -92,7 +92,7 @@
 	local xloc,yloc,zloc =3D GetPlayerPos()
 	local bOfflineMode =3D xloc =3D=3D nil
 	if (not bOfflineMode) then
-		if (gKeyPressed[key_mouse_right]) then =

+		if (gKeyPressed[key_mouse_right] and (not gLastMouseDownWidget)) then =

 			local bRunFlag =3D pixeldist > 200
 			bRunFlag =3D true
 			--~ print("Get2DMouseDirAndDist",uodir,pixeldist)



From no-reply at zwischenwelt.org  Sat Oct 11 00:23:48 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 10 Oct 2008 22:23:48 -0000
Subject: [Iris-commit] [IRIS] r2532 - in /trunk/lua: lib.3d.cam.lua
 lib.null.renderer.lua lib.renderer.lua
Message-ID: <20081010222348.B24D81C18495@zwischenwelt.org>

Author: hagish
Date: Sat Oct 11 00:23:45 2008
New Revision: 2532

Log:
improved switching renderer during runtime (ogre14 works ok)

Modified:
    trunk/lua/lib.3d.cam.lua
    trunk/lua/lib.null.renderer.lua
    trunk/lua/lib.renderer.lua

Modified: trunk/lua/lib.3d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.cam.lua (original)
+++ trunk/lua/lib.3d.cam.lua Sat Oct 11 00:23:45 2008
@@ -37,6 +37,11 @@
 	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
 	cam:SetProjectionType(kCamera_PT_PERSPECTIVE) -- perspective
 	self.gbCamRotChanged =3D true
+
+	local vp =3D GetMainViewport()
+	local viewport_w =3D vp:GetActualWidth()
+	local viewport_h =3D vp:GetActualHeight()
+	cam:SetAspectRatio( viewport_w / viewport_h )
 end	=

 =

 =


Modified: trunk/lua/lib.null.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.null.renderer.lua (original)
+++ trunk/lua/lib.null.renderer.lua Sat Oct 11 00:23:45 2008
@@ -60,3 +60,6 @@
 end
 =

 function RendererNull:BlendOutLayersAbovePlayer () RendererNull_Print("Ble=
ndOutLayersAbovePlayer") end
+
+function RendererNull:NotifyHPChange				(mobile, value) end
+function RendererNull:NotifyManaChange			(mobile, value) end

Modified: trunk/lua/lib.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.renderer.lua (original)
+++ trunk/lua/lib.renderer.lua Sat Oct 11 00:23:45 2008
@@ -37,6 +37,7 @@
 	printf("########## gCurrentRenderer:Init\n")
 	gCurrentRenderer:Init()
 	printf("########## change renderer successful\n")
+	Send_Movement_Resync_Request()
 end
 =

 -- called from c



From no-reply at zwischenwelt.org  Sat Oct 11 00:51:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 10 Oct 2008 22:51:08 -0000
Subject: [Iris-commit] [IRIS] r2533 - /trunk/lua/widgets/widget.uotext.lua
Message-ID: <20081010225108.2F45E1C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 00:51:07 2008
New Revision: 2533

Log:
uotext position rounded, does this fix direct3d font render bug?

Modified:
    trunk/lua/widgets/widget.uotext.lua

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Sat Oct 11 00:51:07 2008
@@ -29,7 +29,7 @@
 	self:SetUOHtml(text or (params.textline_id and textlines[params.textline_=
id]) or (gClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_clilo=
c"),bParseHTML)
 	--~ self:SetPos(params.x,params.y)
 	local xoff,yoff =3D -1,-2
-	self:SetPos(params.x+xoff,params.y+yoff)
+	self:SetPos(floor(params.x+xoff),floor(params.y+yoff))
 	=

 	-- clip
 	-- { checkertrans 30 81 290 162 }



From no-reply at zwischenwelt.org  Sat Oct 11 01:40:21 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 10 Oct 2008 23:40:21 -0000
Subject: [Iris-commit] [IRIS] r2534 - in /trunk/lua: lib.2d.renderer.lua
	lib.2d.spriteblock.lua
Message-ID: <20081010234021.6214D1C186A4@zwischenwelt.org>

Author: hagish
Date: Sat Oct 11 01:40:20 2008
New Revision: 2534

Log:
bugfix: render change does not kill 2d dynamics

Modified:
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.2d.spriteblock.lua

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Sat Oct 11 01:40:20 2008
@@ -72,6 +72,8 @@
 	for k,dynamic in pairs(GetDynamicList()) do if (DynamicIsInWorld(dynamic)=
) then self:RemoveDynamicItem(dynamic) end end
 	for k,mobile in pairs(GetMobileList()) do self:DestroyMobileGfx(mobile) e=
nd
 	Client_ClearLights()
+	-- to handle dirty dynamic blocks
+	self:MainStep()
 end
 =

 -- local uodir,pixeldist =3D Get2DMouseDirAndDist()

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sat Oct 11 01:40:20 2008
@@ -50,7 +50,7 @@
 =

 function ArtCheckBitMask(artid,px,py)
 	local bitmask =3D GetArtBitMask(artid)
-	if (not bitmask) then return true end -- no bitmask -> always hit
+	if (not bitmask or not bitmask:IsAlive()) then return true end -- no bitm=
ask -> always hit
 	return bitmask:TestBit(floor(px),floor(py))
 end
 =




From no-reply at zwischenwelt.org  Sat Oct 11 02:02:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 00:02:06 -0000
Subject: [Iris-commit] [IRIS] r2535 - in /trunk/lua: lib.protocol.lua
 main.lua net/net.uodragdrop.lua
Message-ID: <20081011000206.F3CC71C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 02:02:02 2008
New Revision: 2535

Log:
ClientVersionIsPost6017 warnings added

Modified:
    trunk/lua/lib.protocol.lua
    trunk/lua/main.lua
    trunk/lua/net/net.uodragdrop.lua

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Sat Oct 11 02:02:02 2008
@@ -5,6 +5,12 @@
 =

 -- register packet handlers
 gPacketHandler =3D {}
+
+
+function ClientVersionIsPost6017	() return ClientVersionIsPost(6017) end -=
- see http://iris2.de/index.php/Clientversion_6.0.1.7_and_later
+function GetClientVersionAsNumber	() return tonumber((string.gsub(gClientV=
ersion,"%D",""))) end -- gClientVersion =3D "6.0.1.6"
+function ClientVersionIsPost		(version) return GetClientVersionAsNumber() =
>=3D version end
+
 =

 -- changed NecroPacketData - (0x0B oldsize=3D"0x010A" , damage packet)
 -- packet sizes from necrotoolz.sourceforge.net/kairpacketguide/index.html=
 (0 means dynamic) contains all sizes from 0x00 to 0xDB

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Oct 11 02:02:02 2008
@@ -285,7 +285,12 @@
 end
 =

 --- main function, when it returns, the program ends
-function Main ()	=

+function Main ()
+	if (ClientVersionIsPost6017()) then =

+		local errmsg =3D "FATAL, gClientVersion >=3D 6.0.1.7 not supported yet (=
protocol changes), cur version =3D "..tostring(GetClientVersionAsNumber())
+		-- see http://iris2.de/index.php/Clientversion_6.0.1.7_and_later
+		FatalErrorMessage(errmsg)
+	end
 	TestUOAM()
 	local luaversion =3D string.sub(_VERSION, 5, 7)
 	print("Lua version : "..luaversion)

Modified: trunk/lua/net/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.uodragdrop.lua (original)
+++ trunk/lua/net/net.uodragdrop.lua Sat Oct 11 02:02:02 2008
@@ -29,6 +29,7 @@
 	out:PushNetUint16(x)
 	out:PushNetUint16(y)
 	out:PushInt8(z) -- SIGNED !!
+	if (ClientVersionIsPost6017()) then out:PushInt8(0) end
 	out:PushNetUint32(containerid)
 	out:SendPacket()
 end



From no-reply at zwischenwelt.org  Sat Oct 11 02:08:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 00:08:53 -0000
Subject: [Iris-commit] [IRIS] r2536 - /trunk/lua/lib.uodragdrop.lua
Message-ID: <20081011000853.EB9701C18495@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 02:08:53 2008
New Revision: 2536

Log:
hack to allow dropping items onto dynamic floor tiles (vetus-mundus yardwan=
d tool)

Modified:
    trunk/lua/lib.uodragdrop.lua

Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Sat Oct 11 02:08:53 2008
@@ -437,6 +437,18 @@
 	elseif (gMousePickFoundHit) then
 		x,y,z =3D GetMouseHitTileCoords()
 		local iSerial =3D GetMouseHitSerial()
+		=

+		-- uo-hack : don't send drop-container on dynamic floor tiles (yard wand=
 tool on vm), to allow puttin items on the floor (flags=3D0x201)
+		if (iSerial and iSerial ~=3D 0) then =

+			local dynamic =3D GetDynamic(iSerial)
+			if (dynamic) then
+				local flags =3D GetStaticTileTypeFlags(dynamic.artid)
+				if (flags and TestBit(flags,kTileDataFlag_Surface)) then   --  or kTil=
eDataFlag_Background ?
+					iSerial =3D nil
+				end
+			end
+		end
+		=

 		if (iSerial and iSerial ~=3D 0) then =

 			-- drop on mobile,dynamic etc =

 			printdebug("dragdrop","MouseUpUODragDrop: drop on worlobject : ",item.s=
erial,item.amount,x,y,z,iSerial)



From no-reply at zwischenwelt.org  Sat Oct 11 03:30:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 01:30:36 -0000
Subject: [Iris-commit] [IRIS] r2537 - in /trunk: data/config.lua.dist
 lua/lib.macrolist.lua lua/lib.plugin.lua lua/lib.spellbooks.lua
 lua/net/net.other.lua plugins/hudenemylist.lua plugins/lib.spellbar.lua
Message-ID: <20081011013037.530941C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 03:30:36 2008
New Revision: 2537

Log:
started spellbar plugin code (currently only rises text for spellstart and =
fizzle...) , a few spell utils and hooks

Added:
    trunk/plugins/lib.spellbar.lua
Modified:
    trunk/data/config.lua.dist
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.plugin.lua
    trunk/lua/lib.spellbooks.lua
    trunk/lua/net/net.other.lua
    trunk/plugins/hudenemylist.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Sat Oct 11 03:30:36 2008
@@ -488,3 +488,6 @@
 gShowHealthBarOverEveryMobile =3D false
 gEnableWalkLog =3D false
 gUseWalk3 =3D true
+
+-- gDisabledPlugins.hudenemylist =3D true
+

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Oct 11 03:30:36 2008
@@ -28,8 +28,6 @@
 gMacroReadMobileStats.maxStamina	=3D true
 gMacroReadMobileStats.curWeight		=3D true
 gMacroReadMobileStats.maxWeight		=3D true
-
-gMacroSpellsByName =3D nil
 =

 -- GetPlayerMobile
 function MacroRead_PlayerStat			(statname) return MacroReadAux_MobileStat(=
GetPlayerMobile(),statname,"MacroRead_PlayerStat") end
@@ -182,20 +180,8 @@
 =

 function MacroCmd_Spell					(spellname)
 	if (not gInGameStarted) then return end
-	if (not gMacroSpellsByName) then
-		gMacroSpellsByName =3D {}
-		for spellbookid,spellbookdata in pairs(gSpellBooks) do
-			local startindex =3D spellbookdata.startindex
-			for circle,spelllist in pairs(spellbookdata.spells) do
-				local spellnumber =3D table.getn(spelllist)
-				for spellindex,myspellname in pairs(spelllist) do =

-					gMacroSpellsByName[myspellname] =3D spellindex+(circle-1)*spellnumber=
 + startindex
-				end
-			end
-		end
-	end
-	local spellid =3D gMacroSpellsByName[spellname]
-	if (not spellid) then return MacroErrorNameMismatch("MacroCmd_Spell",spel=
lname,gMacroSpellsByName) end
+	local spellid =3D GetSpellIDByName(spellname)
+	if (not spellid) then return MacroErrorNameMismatch("MacroCmd_Spell",spel=
lname,gSpellIDByName) end
 	Send_Spell(spellid)
 end
 =


Modified: trunk/lua/lib.plugin.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.plugin.lua (original)
+++ trunk/lua/lib.plugin.lua Sat Oct 11 03:30:36 2008
@@ -8,4 +8,6 @@
 	NotifyListener("Hook_HUDStep")
 ]]--
 =

+gDisabledPlugins =3D {}
+
 function LoadPlugins_Iris () LoadPlugins(gMainPluginDir) end

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sat Oct 11 03:30:36 2008
@@ -257,6 +257,25 @@
 	ignore_available_flags =3D true
 }
 =

+function GetSpellIDByName(spellname) return gSpellIDByName[spellname] end
+function GetSpellNameByID(spellid) return gSpellNameByID[spellid] end
+
+gSpellIDByName =3D {}
+gSpellNameByID =3D {}
+for spellbookid,spellbookdata in pairs(gSpellBooks) do
+	local startindex =3D spellbookdata.startindex
+	for circle,spelllist in pairs(spellbookdata.spells) do
+		local spellnumber =3D table.getn(spelllist)
+		for spellindex,myspellname in pairs(spelllist) do
+			local spellid =3D spellindex+(circle-1)*spellnumber + startindex
+			gSpellIDByName[myspellname] =3D spellid
+			gSpellNameByID[spellid] =3D myspellname
+		end
+	end
+end
+
+		=

+
 --[[
 	{"Focus Attack",	10,30,"Increases both your damage and the percentage cha=
nce for \"hit\" properties on your weapon for one attack"},
 	{"Death Strike",	30,85,"After receiving a Death Strike, if the opponent m=
oves more than five steps or five seconds elapses, they will suffer direct =
damage determined by the attacker's ninjitsu."},

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sat Oct 11 03:30:36 2008
@@ -502,6 +502,7 @@
 	local mobilespeaker=3DGetMobile(mobile_serial)
 	if (mobilespeaker) then mobilespeaker:DisplayTextOverHead(string.gsub(tex=
t_message,"<br>","\n"),Uo16Color2Rgb(text_color)) end
 	-- TODO : text_item ?!?
+	NotifyListener("Hook_Packet_Text",mobile_serial,plaintext)
 end
 =

 =

@@ -656,6 +657,7 @@
 	end
 	=

 	NotifyListener("Hook_Text",text_charname,plaintext)
+	NotifyListener("Hook_Packet_Localized_Text",text_item_serial,plaintext,te=
xt_messagenum)
 	=

 	-- print("###",text_item_serial,text_item_model,text_type,text_color,text=
_charname,text_params,text_terminator)
 end
@@ -1007,6 +1009,7 @@
 		print("no spellid defined")
 		return
 	end
+	NotifyListener("Hook_SendSpell",spellid,expansionflag)
 --	printf("NET: Send_SpellSelected : spellid=3D%d\n",spellid)
 	if (spellid < 10) then
 		local out =3D GetSendFIFO()

Modified: trunk/plugins/hudenemylist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/hudenemylist.lua (original)
+++ trunk/plugins/hudenemylist.lua Sat Oct 11 03:30:36 2008
@@ -3,6 +3,7 @@
 -- its possible to target an entry with the uo target cursor
 -- rightclick open the mobile health bar
 =

+if (not gDisabledPlugins.hudenemylist) then =

 =

 -- position of the enemylist block (icon position)
 kPlugin_HudEnemylist_X =3D -170	-- from the right border
@@ -521,4 +522,4 @@
 	Plugin_HudEnemylist_RemoveBodyFromBlocks(obj) =

 end)
 =

-
+end



From no-reply at zwischenwelt.org  Sat Oct 11 03:36:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 01:36:14 -0000
Subject: [Iris-commit] [IRIS] r2538 - /trunk/plugins/lib.spellbar.lua
Message-ID: <20081011013614.C1B8C1C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 03:36:11 2008
New Revision: 2538

Log:
spellbar : added no mana

Modified:
    trunk/plugins/lib.spellbar.lua

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 11 03:36:11 2008
@@ -19,6 +19,8 @@
 kSpellBar_Msg_AlreadyCasting	=3D 502642 -- You are already casting a spell.
 kSpellBar_Msg_Fizzle			=3D 502632 -- The spell fizzles.
 kSpellBar_Msg_Disturbed			=3D 500641 -- Your concentration is disturbed, t=
hus ruining thy spell.
+kSpellBar_Msg_NoMana			=3D 502625 -- Insufficient mana for this spell.
+
 =

 RegisterListener("Hook_Packet_Text",			function (serial,plaintext) =

 	--~ print("Hook_Packet_Text",serial,plaintext) =

@@ -28,7 +30,8 @@
 	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),"already casting",huered) end
 	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"fizzle",huered) end
 	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),"disturbed",huered) end
-	--~ print("Hook_Packet_Localized_Text",serial,plaintext,text_messagenum) =

+	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"no mana",huered) end
+	print("Hook_Packet_Localized_Text",serial,plaintext,text_messagenum) =

 end)
 =

 =




From no-reply at zwischenwelt.org  Sat Oct 11 03:41:57 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 01:41:57 -0000
Subject: [Iris-commit] [IRIS] r2539 - /trunk/lua/lib.2d.spriteblock.lua
Message-ID: <20081011014157.BACE21C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 03:41:57 2008
New Revision: 2539

Log:
2d : mobile fallback fixed for loaderidx > 1

Modified:
    trunk/lua/lib.2d.spriteblock.lua

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sat Oct 11 03:41:57 2008
@@ -163,10 +163,11 @@
 			gMobile2DWarned =3D gMobile2DWarned or {}
 			local n =3D iTranslatedModelID..","..iAnimID
 			if (not gMobile2DWarned[n]) then gMobile2DWarned[n] =3D true
-				print("warning, cUOSpriteBlock:AddAnim load uoanim failed",iTranslated=
ModelID,iAnimID,iFrame,iHue)
+				print("warning, cUOSpriteBlock:AddAnim load uoanim failed",iTranslated=
ModelID,iAnimID,iFrame,iHue,"fallback",iFallBackModel,iFallBackAnim)
 			end
 			iTranslatedModelID	=3D iFallBackModel -- replace unknown by standard mo=
del (13=3Devortex)
-			iAnimID				=3D iFallBackAnim
+			iAnimID				=3D iFallBackAnim =

+			iLoaderIndex 		=3D 1
 			pAtlasPiece			=3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnimID=
,iFrame,iHue,iLoaderIndex)
 		end
 	end



From no-reply at zwischenwelt.org  Sat Oct 11 04:00:47 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 02:00:47 -0000
Subject: [Iris-commit] [IRIS] r2540 - /trunk/lua/net/net.aoscommand.lua
Message-ID: <20081011020047.D68521C186A4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 04:00:47 2008
New Revision: 2540

Log:
added comment for ending ability message from runuo

Modified:
    trunk/lua/net/net.aoscommand.lua

Modified: trunk/lua/net/net.aoscommand.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.aoscommand.lua (original)
+++ trunk/lua/net/net.aoscommand.lua Sat Oct 11 04:00:47 2008
@@ -1,6 +1,7 @@
 -- combatskills/weaponskills =

 -- http://uo.stratics.com/content/arms-armor/specialmoves.php
 -- http://uo.stratics.com/content/arms-armor/special_moves_chart.shtml
+-- runuo : WeaponAbility.cs:319: ClearCurrentAbility : send ClearWeaponAbi=
lity.Instance 0xBF 0x21
 =

 kPacket_AOS_Command_WeaponAbilityRequest	=3D hex2num("0x19")	-- Client -> =
Server message
 kPacket_AOS_Command_GuildGumpRequest		=3D hex2num("0x28")	-- Client -> Ser=
ver message



From no-reply at zwischenwelt.org  Sat Oct 11 04:13:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 02:13:55 -0000
Subject: [Iris-commit] [IRIS] r2541 - in /trunk/lua: lib.2d.mobile.lua
	lib.uoanim.lua
Message-ID: <20081011021355.EBD111C18495@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 04:13:55 2008
New Revision: 2541

Log:
changed UOAnimTranslateBodyID to fix patchwork skeletton (necro summon) a b=
it (309)

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Sat Oct 11 04:13:55 2008
@@ -81,7 +81,9 @@
 		local iModelID,iHue,iFallBackModel =3D unpack(v)
 		if iModelID then =

 			local iLoaderIndex =3D 1
+			local iOldModelID =3D iModelID
 			iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
+			if (iOldModelID =3D=3D 309) then print("UOAnimTranslateBodyID translate=
d to ",iOldModelID,iModelID,iHue,iLoaderIndex) end
 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
 			=


Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Sat Oct 11 04:13:55 2008
@@ -336,17 +336,18 @@
 =

 -- returns iNewModelID,iNewHue,iLoaderIndex
 function UOAnimTranslateBodyID (iOrigModelID,iOrigHue)
-	local bodyConfDef =3D gBodyConfDef[iOrigModelID] -- gBodyConfDef[bodyid] =
=3D {anim2,anim3,anim4,anim5}
-	if (bodyConfDef) then
-		for k =3D 4,1,-1 do if (bodyConfDef[k] > 0) then return bodyConfDef[k],i=
OrigHue,k+1 end end
-	end
-	local bodyDef =3D gBodyDef[iOrigModelID] -- gBodyDef[bodyid] =3D {newbody=
list,newhue}
+	local iModelID,iHue,iLoaderIndex =3D iOrigModelID,iOrigHue,1
+	local bodyDef =3D gBodyDef[iModelID] -- gBodyDef[bodyid] =3D {newbodylist=
,newhue}
 	if (bodyDef) then =

 		local newbodylist,newhue =3D unpack(bodyDef)
 		-- todo : not only first entry in newbodylist ?
-		return newbodylist[1],newhue,1 =

-	end
-	return iOrigModelID,iOrigHue,1
+		iModelID,iHue =3D newbodylist[1],newhue -- newbodylist[iLoaderIndex] ?
+	end
+	local bodyConfDef =3D gBodyConfDef[iModelID] -- gBodyConfDef[bodyid] =3D =
{anim2,anim3,anim4,anim5}
+	if (bodyConfDef) then
+		for k =3D 4,1,-1 do if (bodyConfDef[k] > 0) then iModelID,iHue,iLoaderIn=
dex =3D bodyConfDef[k],iHue,k+1 end end
+	end
+	return iModelID,iHue,iLoaderIndex
 end
 =

 function UOAnimCheckBitMask (iModelID,iAnimID,iFrame,iLoaderIndex,px,py)



From no-reply at zwischenwelt.org  Sat Oct 11 04:15:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 02:15:55 -0000
Subject: [Iris-commit] [IRIS] r2542 - in /trunk/lua: lib.uoids.lua
 net/net.other.lua widgets/widget.widget.uoquickcasticon.lua
Message-ID: <20081011021556.498F01C186A4@zwischenwelt.org>

Author: hagish
Date: Sat Oct 11 04:15:55 2008
New Revision: 2542

Log:
improved quick cast icons of weapon abilities -> colorchange

Modified:
    trunk/lua/lib.uoids.lua
    trunk/lua/net/net.other.lua
    trunk/lua/widgets/widget.widget.uoquickcasticon.lua

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sat Oct 11 04:15:55 2008
@@ -441,35 +441,35 @@
 -- weapon abilities (name + gumpicons)
 -- id id packet id that should be send
 glWeaponAbilities =3D {
-	[1] =3D {name=3D"ARMOR_IGNORE",gumpicon=3D0x51FF+1},
-	[2] =3D {name=3D"BLEED_ATTACK",gumpicon=3D0x51FF+2},
-	[3] =3D {name=3D"CONCUSSION_BLOW",gumpicon=3D0x51FF+3},
-	[4] =3D {name=3D"CRUSHING_BLOW",gumpicon=3D0x51FF+4},
-	[5] =3D {name=3D"DISARM",gumpicon=3D0x51FF+5},
-	[6] =3D {name=3D"DISMOUNT",gumpicon=3D0x51FF+6},
-	[7] =3D {name=3D"DOUBLESTRIKE",gumpicon=3D0x51FF+7},
-	[8] =3D {name=3D"INFECTING",gumpicon=3D0x51FF+8},
-	[9] =3D {name=3D"MORTALSTRIKE",gumpicon=3D0x51FF+9},
-	[10] =3D {name=3D"MOVING_SHOT",gumpicon=3D0x51FF+10},
-	[11] =3D {name=3D"PARALYZING_BLOW",gumpicon=3D0x51FF+11},
-	[12] =3D {name=3D"SHADOWSTRIKE",gumpicon=3D0x51FF+12},
-	[13] =3D {name=3D"WHIRLWIND_STRIKE",gumpicon=3D0x51FF+13},
-	[14] =3D {name=3D"RIDINGSWIPE",gumpicon=3D0x51FF+14},
-	[15] =3D {name=3D"FRENZIEDWHIRLWIND",gumpicon=3D0x51FF+15},
-	[16] =3D {name=3D"BLOCK",gumpicon=3D0x51FF+16},
-	[17] =3D {name=3D"DEFENSEMASTERY",gumpicon=3D0x51FF+17},
-	[18] =3D {name=3D"NERVESTRIKE",gumpicon=3D0x51FF+18},
-	[19] =3D {name=3D"TALONSTRIKE",gumpicon=3D0x51FF+19},
-	[20] =3D {name=3D"FEINT",gumpicon=3D0x51FF+20},
-	[21] =3D {name=3D"DUALWIELD",gumpicon=3D0x51FF+21},
-	[22] =3D {name=3D"DOUBLESHOT",gumpicon=3D0x51FF+22},
-	[23] =3D {name=3D"ARMORPIERCE",gumpicon=3D0x51FF+23},
-	[24] =3D {name=3D"BLADEWEAVE",gumpicon=3D0x51FF+24},
-	[25] =3D {name=3D"FORCE_ARROW",gumpicon=3D0x51FF+25},
-	[26] =3D {name=3D"LIGHTNING_ARROW",gumpicon=3D0x51FF+26},
-	[27] =3D {name=3D"PSYCHIC_ATTACK",gumpicon=3D0x51FF+27},
-	[28] =3D {name=3D"SERPENT_ARROW",gumpicon=3D0x51FF+28},
-	[29] =3D {name=3D"FORCE_OF_NATURE",gumpicon=3D0x51FF+29},
+	[1] =3D {name=3D"Armor Ignore",gumpicon=3D0x51FF+1},
+	[2] =3D {name=3D"Bleed Attack",gumpicon=3D0x51FF+2},
+	[3] =3D {name=3D"Concussion Blow",gumpicon=3D0x51FF+3},
+	[4] =3D {name=3D"Crushing Blow",gumpicon=3D0x51FF+4},
+	[5] =3D {name=3D"Disarm",gumpicon=3D0x51FF+5},
+	[6] =3D {name=3D"Dismount",gumpicon=3D0x51FF+6},
+	[7] =3D {name=3D"Doublestrike",gumpicon=3D0x51FF+7},
+	[8] =3D {name=3D"Infecting",gumpicon=3D0x51FF+8},
+	[9] =3D {name=3D"Mortalstrike",gumpicon=3D0x51FF+9},
+	[10] =3D {name=3D"Moving Shot",gumpicon=3D0x51FF+10},
+	[11] =3D {name=3D"Paralyzing Blow",gumpicon=3D0x51FF+11},
+	[12] =3D {name=3D"Shadow Strike",gumpicon=3D0x51FF+12},
+	[13] =3D {name=3D"Whirlwind Strike",gumpicon=3D0x51FF+13},
+	[14] =3D {name=3D"Ridingwipe",gumpicon=3D0x51FF+14},
+	[15] =3D {name=3D"Frenziedwhirlwind",gumpicon=3D0x51FF+15},
+	[16] =3D {name=3D"Block",gumpicon=3D0x51FF+16},
+	[17] =3D {name=3D"Defensemastery",gumpicon=3D0x51FF+17},
+	[18] =3D {name=3D"Nervestrike",gumpicon=3D0x51FF+18},
+	[19] =3D {name=3D"Talonstrike",gumpicon=3D0x51FF+19},
+	[20] =3D {name=3D"Feint",gumpicon=3D0x51FF+20},
+	[21] =3D {name=3D"Dualwield",gumpicon=3D0x51FF+21},
+	[22] =3D {name=3D"Doubleshot",gumpicon=3D0x51FF+22},
+	[23] =3D {name=3D"Armorpierce",gumpicon=3D0x51FF+23},
+	[24] =3D {name=3D"Bladeweave",gumpicon=3D0x51FF+24},
+	[25] =3D {name=3D"Force Arrow",gumpicon=3D0x51FF+25},
+	[26] =3D {name=3D"Lightning Arrow",gumpicon=3D0x51FF+26},
+	[27] =3D {name=3D"Psychic Attack",gumpicon=3D0x51FF+27},
+	[28] =3D {name=3D"Serpent Arrow",gumpicon=3D0x51FF+28},
+	[29] =3D {name=3D"Force Of Nature",gumpicon=3D0x51FF+29},
 }
 =

 -- weapons and they assigned weaponabilities

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sat Oct 11 04:15:55 2008
@@ -322,6 +322,7 @@
 	-- Subcommand 0x21: (AOS) Ability icon confirm.
 	-- Note: no data, just (bf 00 05 21) =

 	if (subcmd =3D=3D kPacket_Generic_SubCommand_Ability_Icon) then	-- 0x21
+		NotifyListener("Hook_Deactivate_Ability")
 		print("ABILITY","kPacket_Generic_SubCommand_Ability_Icon")
 	end
 =


Modified: trunk/lua/widgets/widget.widget.uoquickcasticon.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.widget.uoquickcasticon.lua (original)
+++ trunk/lua/widgets/widget.widget.uoquickcasticon.lua Sat Oct 11 04:15:55=
 2008
@@ -5,6 +5,8 @@
 =

 glQuickCastDialog =3D {}
 =

+gQuickCastClickedHue =3D 32
+gQuickCastNormalHue =3D 0
 =

 -- list of numbers assigned to quickcast functions
 glQuickCastHotkeys =3D {}
@@ -19,6 +21,13 @@
 	-- layout
 	if gumpid then
 		dialog =3D GetDesktopWidget():CreateChild("UOQuickCastIcon",{x=3Dx,y=3Dy=
,fun=3Dfun,name=3Dname,gumpid=3Dgumpid})
+		RegisterListener("Hook_Deactivate_Ability", function() =

+			if dialog and dialog:IsAlive() then =

+				dialog.gfx_main:ChangeParams({hue=3DgQuickCastNormalHue})
+			else
+				return true
+			end
+		end)
 	else
 		-- simple text button
 		local quickskillGump =3D gQuickskillGump
@@ -83,7 +92,10 @@
 	glQuickCastDialog[self] =3D nil
 end
 =

-function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_click_double	() se=
lf.params.fun() end
+function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_click_double	() =

+	self.gfx_main:ChangeParams({hue=3DgQuickCastClickedHue})
+	self.params.fun() =

+end
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_down			() self:Bri=
ngToFront() self:StartMouseMove() end
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_right_down			() self:De=
stroy() end
 =




From no-reply at zwischenwelt.org  Sat Oct 11 04:24:53 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 02:24:53 -0000
Subject: [Iris-commit] [IRIS] r2543 -
	/trunk/lua/widgets/widget.widget.uoquickcasticon.lua
Message-ID: <20081011022453.EA3BB1C18495@zwischenwelt.org>

Author: hagish
Date: Sat Oct 11 04:24:52 2008
New Revision: 2543

Log:
improved quick cast icons of weapon abilities -> colorchange

Modified:
    trunk/lua/widgets/widget.widget.uoquickcasticon.lua

Modified: trunk/lua/widgets/widget.widget.uoquickcasticon.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.widget.uoquickcasticon.lua (original)
+++ trunk/lua/widgets/widget.widget.uoquickcasticon.lua Sat Oct 11 04:24:52=
 2008
@@ -12,7 +12,8 @@
 glQuickCastHotkeys =3D {}
 =

 -- creates a quickcast button at the given position
-function CreateQuickCastButton (x,y,name,fun,gumpid)
+function CreateQuickCastButton (x,y,name,fun,gumpid,changecolor)
+	changecolor =3D changecolor or false
 	if x < 0 then x =3D 0 end
 	if y < 0 then y =3D 0 end
 	=

@@ -21,13 +22,16 @@
 	-- layout
 	if gumpid then
 		dialog =3D GetDesktopWidget():CreateChild("UOQuickCastIcon",{x=3Dx,y=3Dy=
,fun=3Dfun,name=3Dname,gumpid=3Dgumpid})
-		RegisterListener("Hook_Deactivate_Ability", function() =

-			if dialog and dialog:IsAlive() then =

-				dialog.gfx_main:ChangeParams({hue=3DgQuickCastNormalHue})
-			else
-				return true
-			end
-		end)
+		if changecolor then =

+			dialog.changecolor =3D true
+			RegisterListener("Hook_Deactivate_Ability", function() =

+				if dialog and dialog:IsAlive() then =

+					dialog.gfx_main:ChangeParams({hue=3DgQuickCastNormalHue})
+				else
+					return true
+				end
+			end)
+		end
 	else
 		-- simple text button
 		local quickskillGump =3D gQuickskillGump
@@ -93,7 +97,9 @@
 end
 =

 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_click_double	() =

-	self.gfx_main:ChangeParams({hue=3DgQuickCastClickedHue})
+	if self.changecolor then
+		self.gfx_main:ChangeParams({hue=3DgQuickCastClickedHue})
+	end
 	self.params.fun() =

 end
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_down			() self:Bri=
ngToFront() self:StartMouseMove() end



From no-reply at zwischenwelt.org  Sat Oct 11 20:57:07 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 18:57:07 -0000
Subject: [Iris-commit] [IRIS] r2544 - in /trunk: lua/lib.2d.hudfx.lua
 lua/lib.2d.mobile.lua lua/widgets/widget.uotext.lua
 plugins/lib.spellbar.lua
Message-ID: <20081011185707.E2AAC1C187C4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 20:57:06 2008
New Revision: 2544

Log:
uotext : allows non-hue coloring, spellbar uses it

Modified:
    trunk/lua/lib.2d.hudfx.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/widgets/widget.uotext.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.2d.hudfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.hudfx.lua (original)
+++ trunk/lua/lib.2d.hudfx.lua Sat Oct 11 20:57:06 2008
@@ -6,8 +6,8 @@
 -- 52=3Dyellow, 56=3Dgreen-yellow, 62=3Dgreen, =

 -- 67=3Dgreen, 72=3Ddark-green  82=3Dcyan,  86=3Dlblue, =

 -- 90 =3D white-blue?    150=3Dwhite ?  153=3Dyellow =

-Renderer2D.kDamageTextHue_Self =3D 52 -- yellow
-Renderer2D.kDamageTextHue_Other =3D 32 -- red
+Renderer2D.kDamageTextCol_Self =3D {1,1,0} -- yellow
+Renderer2D.kDamageTextCol_Other =3D {1,0,0} -- red
 =

 function Renderer2D:HUDFX_MainStep ()
 	local t =3D Client_GetTicks()
@@ -54,12 +54,12 @@
 =

 function Renderer2D:NotifyDamage( mobile_serial, damage) -- kPacket_Damage=
,0x0b
 	local isOnSelf =3D GetPlayerSerial() =3D=3D mobile_serial
-	local hue =3D isOnSelf and self.kDamageTextHue_Self or self.kDamageTextHu=
e_Other
-	self:HUDFX_AddRisingTextOnMob(GetMobile(mobile_serial),sprintf("%d",damag=
e),hue)
+	local col =3D isOnSelf and self.kDamageTextCol_Self or self.kDamageTextCo=
l_Other
+	self:HUDFX_AddRisingTextOnMob(GetMobile(mobile_serial),sprintf("%d",damag=
e),unpack(col))
 end
 =

 =

-function Renderer2D:HUDFX_AddRisingTextOnMob (mob,text,hue,risetime,riseh)
+function Renderer2D:HUDFX_AddRisingTextOnMob (mob,text,r,g,b,risetime,rise=
h)
 	if (not mob) then return end
 	local hudfx =3D {}
 	hudfx.dur =3D risetime or 1000
@@ -72,7 +72,7 @@
 	hudfx.mob =3D mob
 	hudfx.zadd =3D 10
 	=

-	local gfx =3D gRootWidget.hudfx:CreateChild("UOText",{x=3D0,y=3D0,text=3D=
text,hue=3Dhue,bold=3Dtrue})
+	local gfx =3D gRootWidget.hudfx:CreateChild("UOText",{x=3D0,y=3D0,text=3D=
text,col=3D{r=3Dr,g=3Dg,b=3Db},bold=3Dtrue})
 	=

 	hudfx.gfx =3D gfx
 	Renderer2D.gHUDFXList[hudfx] =3D true

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Sat Oct 11 20:57:06 2008
@@ -83,7 +83,7 @@
 			local iLoaderIndex =3D 1
 			local iOldModelID =3D iModelID
 			iModelID,iHue,iLoaderIndex =3D UOAnimTranslateBodyID(iModelID,iHue)
-			if (iOldModelID =3D=3D 309) then print("UOAnimTranslateBodyID translate=
d to ",iOldModelID,iModelID,iHue,iLoaderIndex) end
+			--~ if (iOldModelID =3D=3D 309) then print("UOAnimTranslateBodyID trans=
lated to ",iOldModelID,iModelID,iHue,iLoaderIndex) end
 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
 			=


Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Sat Oct 11 20:57:06 2008
@@ -12,7 +12,7 @@
 =

 RegisterWidgetClass("UOText","Text")
 =

--- param : x,y,width,height,text/cliloc_id/textline_id,background=3D0/1=3D=
transparent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse,crop=3Dfalse,html=
=3Dfalse
+-- param : x,y,width,height,text/cliloc_id/textline_id,background=3D0/1=3D=
transparent?,scrollbar=3D0/1=3Ddisplayed,hue,bold=3Dfalse,crop=3Dfalse,html=
=3Dfalse,col=3D{r=3D1,g=3D1,b=3D1}
 -- bold=3Doutlined_font: false for xmfhtmlgump,htmlgump, true for croppedt=
ext, example : runebook gump : kGumpSample_RuneBook
 -- crop : disables autowrap
 -- html : parse uo html like <BASEFONT> <BIG>....
@@ -56,6 +56,7 @@
 	local col_black =3D {r=3D0,g=3D0,b=3D0}
 	local col =3D self.params.default_black and col_black or col_white
 	if (self.params.hue) then local r,g,b =3D gHueLoader:GetColor(self.params=
.hue,31) col =3D {r=3Dr,g=3Dg,b=3Db} end
+	if (self.params.col) then col =3D self.params.col end
 	=

 	local glyphlist =3D self.glyphlist
 	local plaintext =3D bIsUniCode and UnicodeToPlainText_KeepLength(uohtml) =
or uohtml

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 11 20:57:06 2008
@@ -8,12 +8,12 @@
 RegisterListener("Hook_SendSpell",function (spellid)
 	local spellname =3D GetSpellNameByID(spellid)
 	print("spellbar:Hook_SendSpell",spellid,spellname)
-	SpellBarRiseTextOnMob(GetPlayerSerial(),spellname,150) -- 150=3Dwhite?
+	SpellBarRiseTextOnMob(GetPlayerSerial(),spellname,1,1,1) =

 end)
 =

-function SpellBarRiseTextOnMob (serial,text,hue)
+function SpellBarRiseTextOnMob (serial,text,r,g,b)
 	if (gCurrentRenderer ~=3D Renderer2D) then return end
-	Renderer2D:HUDFX_AddRisingTextOnMob(GetMobile(serial),text,hue) -- see 2d=
.hudfx.lua
+	Renderer2D:HUDFX_AddRisingTextOnMob(GetMobile(serial),text,r,g,b) -- see =
2d.hudfx.lua
 end
 =

 kSpellBar_Msg_AlreadyCasting	=3D 502642 -- You are already casting a spell.
@@ -26,12 +26,12 @@
 	--~ print("Hook_Packet_Text",serial,plaintext) =

 end)
 RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum) =

-	local huered =3D 32 -- red
-	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),"already casting",huered) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"fizzle",huered) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),"disturbed",huered) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"no mana",huered) end
-	print("Hook_Packet_Localized_Text",serial,plaintext,text_messagenum) =

+	local r,g,b =3D 1,0,0 -- red
+	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),"already casting",r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"fizzle",r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),"disturbed",r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"no mana",r,g,b) end
+	--~ print("Hook_Packet_Localized_Text",serial,plaintext,text_messagenum) =

 end)
 =

 =




From no-reply at zwischenwelt.org  Sat Oct 11 21:31:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 19:31:34 -0000
Subject: [Iris-commit] [IRIS] r2545 - in /trunk: lua/obj/obj.mobile.lua
	plugins/lib.spellbar.lua
Message-ID: <20081011193134.9E7211C187C4@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 21:31:34 2008
New Revision: 2545

Log:
optimized mobile equipchange a bit, called less often now

Modified:
    trunk/lua/obj/obj.mobile.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Sat Oct 11 21:31:34 2008
@@ -107,11 +107,12 @@
 -- ##### ##### ##### ##### ##### updates
 =

 =

-function gMobilePrototype:UpdateContent () self:Update() end
+function gMobilePrototype:UpdateContent () self.bEquipmentChanged =3D true=
 self:Update() end
 =

 -- updates mobile status, and the position of the graphical representation=
 and other things
 function gMobilePrototype:Update (mobiledata,equipmentdata)
 	if (self.bDestructionInProgress) then return end -- avoid updates during =
destruction
+	if (self.bEquipmentUpdateInProgress) then return end -- update triggered =
by
 	=

 	if (mobiledata) then for k,v in pairs(mobiledata) do self[k] =3D v end end
 	self:UpdateFlags()
@@ -141,11 +142,13 @@
 	=

 	-- full equipment overwrite
 	if (equipmentdata) then
+		self.bEquipmentUpdateInProgress =3D true -- prevent self:Update during e=
quipment update...
 		self:DestroyContent() -- destroy old equipment items
 =

 		for layer,dynamicdata in pairs(equipmentdata) do
 			CreateOrUpdateDynamic(dynamicdata,self)
 		end
+		self.bEquipmentUpdateInProgress =3D false
 	end
 	=

 	local bIsPlayer =3D self.serial =3D=3D gPlayerBodySerial
@@ -153,7 +156,9 @@
 	-- if something related to equipment might have changed =

 	-- this can also have happened if equipmentdata=3Dnil, e.g. when an equip=
ment item was destroyed directly
 	-- maybe only in UpdateContent and/or if equipmentdata is set ?
-	if (true) then
+	if (self.bEquipmentChanged) then
+		self.bEquipmentChanged =3D false
+		NotifyListener("Hook_MobileEquipmentChanged",self)
 		if (bIsPlayer) then PlayerBackpackItemUpdated() end
 		local paperdoll =3D gPaperdolls[self.serial]
 		if (paperdoll) then RebuildPaperdoll(paperdoll) end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 11 21:31:34 2008
@@ -2,9 +2,18 @@
 =

 if (not gDisabledPlugins.spellbar) then =

 =

+
+RegisterListener("Hook_MobileEquipmentChanged",function (mobile)
+	if (not IsPlayerMobile(mobile)) then return end
+	print("spellbar : Hook_MobileEquipmentChanged")
+	=

+	=

+end)
+	=

 RegisterListener("Hook_HUDStep",function ()
 	=

 end)
+
 RegisterListener("Hook_SendSpell",function (spellid)
 	local spellname =3D GetSpellNameByID(spellid)
 	print("spellbar:Hook_SendSpell",spellid,spellname)



From no-reply at zwischenwelt.org  Sat Oct 11 22:02:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 20:02:19 -0000
Subject: [Iris-commit] [IRIS] r2546 - in /trunk: lua/lib.2d.mousepick.lua
 lua/lib.uotooltip.lua plugins/lib.spellbar.lua
Message-ID: <20081011210004.AEB571C187B7@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 22:02:19 2008
New Revision: 2546

Log:
improved tooltip hashing

Modified:
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.uotooltip.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Sat Oct 11 22:02:19 2008
@@ -19,6 +19,8 @@
 end
 =

 function Renderer2D:MousePick_Scene () =

+	if (not self.map2d_spawners) then return end -- not yet initialised
+	=

 	-- raypick
 	local founddist =

 	local rx,ry,rz, rvx,rvy,rvz =3D GetMouseRay()

Modified: trunk/lua/lib.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uotooltip.lua (original)
+++ trunk/lua/lib.uotooltip.lua Sat Oct 11 22:02:19 2008
@@ -1,5 +1,7 @@
 gUOToolTipSerial =3D nil
 gUOToolTipDialog =3D nil
+
+kToolTipHashMask =3D 0x3fffFFFF
 =

 function StartUOToolTipAtMouse_Serial (serial)
 	if (gUOToolTipSerial =3D=3D serial) then return end
@@ -82,10 +84,11 @@
 	local id =3D input:PopNetUint8()
 	local objserial =3D input:PopNetUint32()			--Item/Mob-Serial
 	local objrevision_hash =3D input:PopNetUint32()
-	printdebug("net",sprintf("NET: AOSObjProp objserial=3D0x%08x objrevision_=
hash=3D0x%08x\n",objserial,objrevision_hash))
-	if (AosToolTip_GetHash(objserial) ~=3D objrevision_hash) then
-		AosToolTip_SetHash(objserial,objrevision_hash)
-		-- print("Send_ToolTipRequest",objserial,objrevision_hash)
+	local hash =3D BitwiseAND(objrevision_hash,kToolTipHashMask)
+	printdebug("net",sprintf("NET: AOSObjProp objserial=3D0x%08x hash=3D0x%08=
x\n",objserial,hash))
+	if (AosToolTip_GetHash(objserial) ~=3D hash) then
+		AosToolTip_SetHash(objserial,hash)
+		-- print("Send_ToolTipRequest",objserial,hash)
 		Send_ToolTipRequest(objserial)
 	end
 end
@@ -93,14 +96,15 @@
 -- Mega Cliloc - server sends new Clilocs - just add them to the Cliloc
 -- TODO : this cliloc additions might be local to a specific mobile, e.g. =
vendor or container...
 function gPacketHandler.kPacket_Mega_Cliloc()	--0xD6
-	local input			=3D GetRecvFIFO()
-	local id			=3D input:PopNetUint8()
-	local size			=3D input:PopNetUint16()
-	local unknown1		=3D input:PopNetUint16()	--0x0001 or 0x4000 !?
-	local serial		=3D input:PopNetUint32()	--Serial of item/creature
-	local unknown2		=3D input:PopNetUint16()	--0x0000 !?
-	local unknown3		=3D input:PopNetUint32()	--another serial? hash? weird fl=
ags ? position ? 0x030c0ca3
-		-- unknown3 in old iris code : obj/character->SetAOSTooltipID(listID);
+	local input				=3D GetRecvFIFO()
+	local id				=3D input:PopNetUint8()
+	local size				=3D input:PopNetUint16()
+	local unknown1			=3D input:PopNetUint16()	--0x0001 or 0x4000 !?
+	local serial			=3D input:PopNetUint32()	--Serial of item/creature
+	local unknown2			=3D input:PopNetUint16()	--0x0000 !?
+	local objrevision_hash	=3D input:PopNetUint32()	--another serial? hash? w=
eird flags ? position ? 0x030c0ca3
+	local hash =3D BitwiseAND(objrevision_hash,kToolTipHashMask) =

+		-- objrevision_hash in old iris code : obj/character->SetAOSTooltipID(li=
stID);
 	=

 	local totaltext =3D ""
 	local bFirst =3D true
@@ -136,7 +140,9 @@
 		totaltext =3D totaltext..text
 		--~ printf("NET: Mega_Cliloc LINE : text=3D'%s' clilocbase=3D'%s' totalp=
aramtext=3D'%s' debug=3D%s\n",text,cliloctext,totalparamtext,debugtxt)
 	end
-	printdebug("net", sprintf("NET: Mega_Cliloc : serial=3D%d u3=3D%d text=3D=
'%s'\n",serial,unknown3,totaltext) )
+	printdebug("net", sprintf("NET: Mega_Cliloc : serial=3D%d u3=3D%d text=3D=
'%s'\n",serial,hash,totaltext) )
+	--~ print("recv-tooltip",hash=3D=3DAosToolTip_GetHash(serial),sprintf("0x=
%08x",hash),sprintf("0x%08x",AosToolTip_GetHash(serial) or 0),SmartDump(unk=
nown2),SmartDump(unknown1))
+	AosToolTip_SetHash(serial,hash)
 	AosToolTip_SetText(serial,totaltext)
 end
 =


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 11 22:02:19 2008
@@ -2,12 +2,21 @@
 =

 if (not gDisabledPlugins.spellbar) then =

 =

+function SpellBarEquipChanged (mobile)
+	print("SpellBarEquipChanged")
+	=

+	for index,layer in pairs(gLayerOrder) do =

+		local item =3D GetMobileEquipmentItem(mobile,layer)
+		if (item) then =

+			local tooltip =3D AosToolTip_GetText(item.serial)
+			--~ if (tooltip) then print("+",tooltip) end
+		end
+	end
+end
 =

 RegisterListener("Hook_MobileEquipmentChanged",function (mobile)
 	if (not IsPlayerMobile(mobile)) then return end
-	print("spellbar : Hook_MobileEquipmentChanged")
-	=

-	=

+	SpellBarEquipChanged(mobile)
 end)
 	=

 RegisterListener("Hook_HUDStep",function ()
@@ -17,6 +26,7 @@
 RegisterListener("Hook_SendSpell",function (spellid)
 	local spellname =3D GetSpellNameByID(spellid)
 	print("spellbar:Hook_SendSpell",spellid,spellname)
+	SpellBarEquipChanged(GetPlayerMobile())
 	SpellBarRiseTextOnMob(GetPlayerSerial(),spellname,1,1,1) =

 end)
 =




From no-reply at zwischenwelt.org  Sat Oct 11 22:03:13 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 20:03:13 -0000
Subject: [Iris-commit] [IRIS] r2547 - /trunk/plugins/lib.spellbar.lua
Message-ID: <20081011210005.C6A041C187B7@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 22:03:09 2008
New Revision: 2547

Log:
improved tooltip hashing

Modified:
    trunk/plugins/lib.spellbar.lua

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 11 22:03:09 2008
@@ -9,7 +9,7 @@
 		local item =3D GetMobileEquipmentItem(mobile,layer)
 		if (item) then =

 			local tooltip =3D AosToolTip_GetText(item.serial)
-			--~ if (tooltip) then print("+",tooltip) end
+			if (tooltip) then print("+",tooltip) end
 		end
 	end
 end



From no-reply at zwischenwelt.org  Sat Oct 11 22:56:01 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 11 Oct 2008 20:56:01 -0000
Subject: [Iris-commit] [IRIS] r2548 - in /trunk: lua/lib.uotooltip.lua
 lua/obj/obj.mobile.lua plugins/lib.spellbar.lua
Message-ID: <20081011210007.288571C187C5@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 11 22:56:01 2008
New Revision: 2548

Log:
tooltip parsing

Modified:
    trunk/lua/lib.uotooltip.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uotooltip.lua (original)
+++ trunk/lua/lib.uotooltip.lua Sat Oct 11 22:56:01 2008
@@ -2,6 +2,27 @@
 gUOToolTipDialog =3D nil
 =

 kToolTipHashMask =3D 0x3fffFFFF
+
+
+gShortProps =3D {}
+gShortProps.fcr		=3D {num=3D"faster cast recovery "}
+gShortProps.fc		=3D {num=3D"faster casting "}
+
+-- returns props=3D{fcr=3D?,fc=3D?,...}
+function ParseProps (tooltip) =

+	local res =3D {}
+	for k,v in pairs(gShortProps) do
+		if (v.num) then
+			local a,b,num =3D string.find(tooltip,v.num.."(%d+)")
+			if (num) then res[k] =3D tonumber(num) end
+		end
+	end
+	return res
+end
+
+
+
+
 =

 function StartUOToolTipAtMouse_Serial (serial)
 	if (gUOToolTipSerial =3D=3D serial) then return end
@@ -141,9 +162,10 @@
 		--~ printf("NET: Mega_Cliloc LINE : text=3D'%s' clilocbase=3D'%s' totalp=
aramtext=3D'%s' debug=3D%s\n",text,cliloctext,totalparamtext,debugtxt)
 	end
 	printdebug("net", sprintf("NET: Mega_Cliloc : serial=3D%d u3=3D%d text=3D=
'%s'\n",serial,hash,totaltext) )
-	--~ print("recv-tooltip",hash=3D=3DAosToolTip_GetHash(serial),sprintf("0x=
%08x",hash),sprintf("0x%08x",AosToolTip_GetHash(serial) or 0),SmartDump(unk=
nown2),SmartDump(unknown1))
+	--~ print("recv-tooltip",SmartDump(serial),hash=3D=3DAosToolTip_GetHash(s=
erial),sprintf("0x%08x",hash),sprintf("0x%08x",AosToolTip_GetHash(serial) o=
r 0),SmartDump(unknown2),SmartDump(unknown1),totaltext and string.len(total=
text))
 	AosToolTip_SetHash(serial,hash)
 	AosToolTip_SetText(serial,totaltext)
+	NotifyListener("Hook_ToolTipUpdate",serial)
 end
 =

 =


Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Sat Oct 11 22:56:01 2008
@@ -109,6 +109,13 @@
 =

 function gMobilePrototype:UpdateContent () self.bEquipmentChanged =3D true=
 self:Update() end
 =

+function gMobilePrototype:RequestEquipToolTips ()
+	for index,layer in pairs(gLayerOrder) do =

+		local item =3D GetMobileEquipmentItem(self,layer)
+		if (item) then AosToolTip_GetText(item.serial) end
+	end
+end
+	=

 -- updates mobile status, and the position of the graphical representation=
 and other things
 function gMobilePrototype:Update (mobiledata,equipmentdata)
 	if (self.bDestructionInProgress) then return end -- avoid updates during =
destruction
@@ -159,13 +166,14 @@
 	if (self.bEquipmentChanged) then
 		self.bEquipmentChanged =3D false
 		NotifyListener("Hook_MobileEquipmentChanged",self)
-		if (bIsPlayer) then PlayerBackpackItemUpdated() end
+		if (bIsPlayer) then PlayerBackpackItemUpdated() self:RequestEquipToolTip=
s() end
 		local paperdoll =3D gPaperdolls[self.serial]
 		if (paperdoll) then RebuildPaperdoll(paperdoll) end
 		=

 		-- TODO : UpdateMobileModel does check for changes, but still a little e=
xpensive, only call if neccessary ?
 		gCurrentRenderer:UpdateMobileModel(self)
 	end
+	=

 =

 	self:NotifyListener("Mobile_Update")
 =


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 11 22:56:01 2008
@@ -1,32 +1,49 @@
 -- displays a spellbar over the head of a char
 =

 if (not gDisabledPlugins.spellbar) then =

+gSpellBarEquipPropCache =3D nil
+gSpellBarEquipmentSerials =3D {}
 =

-function SpellBarEquipChanged (mobile)
-	print("SpellBarEquipChanged")
-	=

+-- returns proparr=3D{fc=3D?,fcr=3D?}
+function GetSpellBarEquipProps ()
+	if (gSpellBarEquipPropCache) then return gSpellBarEquipPropCache end
+	local propsum =3D {}
+	gSpellBarEquipPropCache =3D propsum
+	gSpellBarEquipmentSerials =3D {}
+	local mobile =3D GetPlayerMobile()
 	for index,layer in pairs(gLayerOrder) do =

 		local item =3D GetMobileEquipmentItem(mobile,layer)
 		if (item) then =

+			gSpellBarEquipmentSerials[item.serial] =3D true
 			local tooltip =3D AosToolTip_GetText(item.serial)
-			if (tooltip) then print("+",tooltip) end
+			if (tooltip) then =

+				local props =3D ParseProps(tooltip)
+				if (props.fcr) then propsum.fcr =3D (propsum.fcr or 0) + props.fcr end
+				if (props.fc) then propsum.fc =3D (propsum.fc or 0) + props.fc end
+				--~ print("+",tooltip and string.len(tooltip),gLayerTypeName[layer],to=
oltip) =

+			end
 		end
 	end
+	return gSpellBarEquipPropCache
 end
 =

 RegisterListener("Hook_MobileEquipmentChanged",function (mobile)
 	if (not IsPlayerMobile(mobile)) then return end
-	SpellBarEquipChanged(mobile)
+	gSpellBarEquipPropCache =3D nil
 end)
 	=

+RegisterListener("Hook_ToolTipUpdate",function (serial)
+	if (gSpellBarEquipmentSerials[serial]) then gSpellBarEquipPropCache =3D n=
il end
+end)
+
 RegisterListener("Hook_HUDStep",function ()
 	=

 end)
 =

 RegisterListener("Hook_SendSpell",function (spellid)
 	local spellname =3D GetSpellNameByID(spellid)
-	print("spellbar:Hook_SendSpell",spellid,spellname)
-	SpellBarEquipChanged(GetPlayerMobile())
+	local equipprop =3D GetSpellBarEquipProps()
+	print("spellbar:Hook_SendSpell",spellid,spellname,SmartDump(equipprop))
 	SpellBarRiseTextOnMob(GetPlayerSerial(),spellname,1,1,1) =

 end)
 =




From no-reply at zwischenwelt.org  Sun Oct 12 04:33:37 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 02:33:37 -0000
Subject: [Iris-commit] [IRIS] r2549 - in /trunk: lua/gui/gui.spellbook.lua
 lua/lib.spellbooks.lua plugins/lib.spellbar.lua
Message-ID: <20081012023337.B2C8A1C1879B@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 04:33:36 2008
New Revision: 2549

Log:
spellbook : fixed necro-exorcism spell, prepared spell timecalc

Modified:
    trunk/lua/gui/gui.spellbook.lua
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/gui/gui.spellbook.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.spellbook.lua (original)
+++ trunk/lua/gui/gui.spellbook.lua Sun Oct 12 04:33:36 2008
@@ -176,8 +176,9 @@
 		local circlenumber=3Dtable.getn(gSpellBooks[spellbook.itemid].circles)
 		local available_spells=3D0
 =

+		local spellnumber=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[1])
 		for circle=3D1, circlenumber do
-			local spellnumber=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[cir=
cle])
+			local spellnumber2=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[ci=
rcle])
 =

 			local page =3D pages[pagenumber]
 			if (not(page)) then
@@ -227,7 +228,7 @@
 			-- counter for available spells
 			local spellcounter=3D0
 =

-			for spell=3D1, spellnumber do
+			for spell=3D1, spellnumber2 do
 				-- print("SPELL",gSpellBooks[spellbook.itemid].ignore_available_flags,=
spell,spellnumber,spellbook.matrix[circle],BitwiseSHL(1,spell-1))
 				if (gSpellBooks[spellbook.itemid].ignore_available_flags or TestBit(sp=
ellbook.matrix[circle], BitwiseSHL(1,spell-1))) then
 					-- print("ADD")
@@ -287,10 +288,11 @@
 		-- counter for available spells
 		local spellcounter=3D0
 =

+		local spellnumber=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[1])
 		for circle=3D1, circlenumber do
-			local spellnumber=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[cir=
cle])
+			local spellnumber2=3Dtable.getn(gSpellBooks[spellbook.itemid].spells[ci=
rcle])
 		=

-			for spell=3D1, spellnumber do
+			for spell=3D1, spellnumber2 do
 				if (TestBit(spellbook.matrix[circle], BitwiseSHL(1,spell-1))) then
 					-- increase number of available spells
 					spellcounter=3Dspellcounter+1

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Oct 12 04:33:36 2008
@@ -1,5 +1,7 @@
 -- Spellbook definitions
 -- TODO: update definition needed
+
+kCastDelaySecondsPerTick =3D 0.25  -- RunUO-2.0-SVN/Scripts/Spells/Base/Sp=
ell.cs:639:	public virtual double CastDelaySecondsPerTick { get { return 0.=
25; } }
 =

 gSpellbookExpansion =3D {}
 gSpellbookExpansion["AOS"]	=3D hex2num("0x00")		--Mage, Necromancer and Pa=
ladin spells
@@ -27,7 +29,7 @@
 +       {usegump=3Dfalse,amount=3D18=3D0x12,	=3D16+2,	iContainerSerial=3D0=
x409a8767,artid=3D0,serial=3D0x7fffffee,}  -7981   0
 +       {usegump=3Dfalse,amount=3D20=3D0x14,	=3D16+4,	iContainerSerial=3D0=
x409a8767,artid=3D0,serial=3D0x7fffffec,}  -7981   0
 +       {usegump=3Dfalse,amount=3D22=3D0x16,	=3D16+6,	iContainerSerial=3D0=
x409a8767,artid=3D0,serial=3D0x7fffffea,}  -7981   0
-                                                                    =

+
 +       {usegump=3Dfalse,amount=3D28=3D0x1c,	=3D24+4,	iContainerSerial=3D0=
x409a8767,artid=3D0,serial=3D0x7fffffe4,}  -7981   0
 +       {usegump=3Dfalse,amount=3D29=3D0x1d,	=3D24+5,	iContainerSerial=3D0=
x409a8767,artid=3D0,serial=3D0x7fffffe3,}  -7981   0
 +       {usegump=3Dfalse,amount=3D30=3D0x1e	=3D24+6,	iContainerSerial=3D0x=
409a8767,artid=3D0,serial=3D0x7fffffe2,}  -7981   0
@@ -130,20 +132,26 @@
 	minigumpid	=3Dhex2num("0x2B03"),
 	iconoffset =3D hex2num("0x5000"),
 	startindex  =3Dhex2num("0x64"),
-	circles	=3D{[1]=3D"First Circle",[2]=3D"Second Circle"},
-
-	pages	=3D{ [1]=3D1, [2]=3D1 },
+	--~ circles	=3D{[1]=3D"First Circle",[2]=3D"Second Circle"},
+	circles	=3D{[1]=3D"First Circle",[2]=3D"Second Circle",[3]=3D"Third Circl=
e",[4]=3D"Fourth Circle"},
+
+	--~ pages	=3D{ [1]=3D1, [2]=3D1},
+	pages	=3D{ [1]=3D1, [2]=3D1, [3]=3D2, [4]=3D2 },
 =

 	spells	=3D{
 		[1] =3D { [1] =3D "Animate Dead", [2] =3D "Blood Oath", [3] =3D "Corpse =
Skin", [4] =3D "Curse Weapon", [5] =3D "Evil Omen", [6] =3D "Horrific Beast=
", [7] =3D "Lich Form", [8] =3D "Mind Rot" },
-		[2] =3D { [1] =3D "Pain Spike", [2] =3D "Poison Strike", [3] =3D "Strang=
le", [4] =3D "Summon Familiar", [5] =3D "Vampiric Embrace", [6] =3D "Vengef=
ul Spirit", [7] =3D "Wither", [8] =3D "WraithForm"}
+		[2] =3D { [1] =3D "Pain Spike", [2] =3D "Poison Strike", [3] =3D "Strang=
le", [4] =3D "Summon Familiar", [5] =3D "Vampiric Embrace", [6] =3D "Vengef=
ul Spirit", [7] =3D "Wither", [8] =3D "WraithForm"},
+		[3] =3D { [1] =3D "Exorcism" },
+		[4] =3D { },
 		},
-
+		=

 	reagenz =3D { [1]=3D"Bat Wing", [2]=3D"Grave Dust", [3]=3D"Daemon Blood",=
 [4]=3D"Nox Crystal", [5]=3D"Pig Iron" },
 =

 	spell_reags =3D {
 		[1]	=3D { [1]=3D{[1]=3D2,[2]=3D3}, [2]=3D{[1]=3D3}, [3]=3D{[1]=3D1,[2]=
=3D2}, [4]=3D{[1]=3D5}, [5]=3D{[1]=3D1,[2]=3D4}, [6]=3D{[1]=3D1,[2]=3D3}, [=
7]=3D{[1]=3D2,[2]=3D3,[3]=3D4}, [8]=3D{[1]=3D1,[2]=3D3,[3]=3D5} },
-		[2]	=3D { [1]=3D{[1]=3D2,[2]=3D5}, [2]=3D{[1]=3D4}, [3]=3D{[1]=3D3,[2]=
=3D4}, [4]=3D{[1]=3D1,[2]=3D2,[3]=3D3}, [5]=3D{[1]=3D1,[2]=3D4,[3]=3D5}, [6=
]=3D{[1]=3D1,[2]=3D3,[3]=3D5}, [7]=3D{[1]=3D2,[2]=3D4,[3]=3D5}, [8]=3D{[1]=
=3D4,[2]=3D5} }
+		[2]	=3D { [1]=3D{[1]=3D2,[2]=3D5}, [2]=3D{[1]=3D4}, [3]=3D{[1]=3D3,[2]=
=3D4}, [4]=3D{[1]=3D1,[2]=3D2,[3]=3D3}, [5]=3D{[1]=3D1,[2]=3D4,[3]=3D5}, [6=
]=3D{[1]=3D1,[2]=3D3,[3]=3D5}, [7]=3D{[1]=3D2,[2]=3D4,[3]=3D5}, [8]=3D{[1]=
=3D4,[2]=3D5} },
+		[3]	=3D { [1]=3D{[1]=3D4,[2]=3D2} },
+		[4]	=3D {  },
 	},
 	=

 	ignore_available_flags =3D false
@@ -257,26 +265,158 @@
 	ignore_available_flags =3D true
 }
 =

-function GetSpellIDByName(spellname) return gSpellIDByName[spellname] end
-function GetSpellNameByID(spellid) return gSpellNameByID[spellid] end
+function GetSpellIDByName(spellname)		return gSpellIDByName[spellname] end
+function GetSpellNameByID(spellid)			return gSpellNameByID[spellid] end
+function GetSpellCircleByID(spellid)		return gSpellCircleByID[spellid] end
+function GetSpellBookIDBySpellID(spellid)	return gSpellBookIDBySpellID[spe=
llid] end
+function IsMageSpell(spellid)				return GetSpellBookIDBySpellID(spellid) =
=3D=3D MageSpellbook end
+
+gSpellBookNameByID =3D {}
+gSpellBookNameByID[MageSpellbook			] =3D "Magery"
+gSpellBookNameByID[NecroSpellbook			] =3D "Necromancy"
+gSpellBookNameByID[ChivalrySpellbook		] =3D "Chivalry"
+gSpellBookNameByID[BushidoSpellbook			] =3D "Bushido"
+gSpellBookNameByID[NinjitsuSpellbook		] =3D "Ninjitsu"
+gSpellBookNameByID[SpellweavingSpellbook	] =3D "Spellweaving"
+
 =

 gSpellIDByName =3D {}
 gSpellNameByID =3D {}
+gSpellCircleByID =3D {}
+gSpellBookIDBySpellID =3D {}
 for spellbookid,spellbookdata in pairs(gSpellBooks) do
 	local startindex =3D spellbookdata.startindex
+	local circlestart =3D startindex
 	for circle,spelllist in pairs(spellbookdata.spells) do
-		local spellnumber =3D table.getn(spelllist)
 		for spellindex,myspellname in pairs(spelllist) do
-			local spellid =3D spellindex+(circle-1)*spellnumber + startindex
-			gSpellIDByName[myspellname] =3D spellid
-			gSpellNameByID[spellid] =3D myspellname
+			local spellid					=3D spellindex + circlestart
+			gSpellIDByName[myspellname]		=3D spellid
+			gSpellNameByID[spellid]			=3D myspellname
+			gSpellCircleByID[spellid]		=3D circle
+			gSpellBookIDBySpellID[spellid]	=3D spellbookid
+			--~ local regs =3D spellbookdata.spell_reags[circle][spellindex]
+			--~ local regtxt =3D ""
+			--~ for k,v in pairs(regs) do regtxt =3D regtxt .. tostring(spellbookda=
ta.reagenz[v]) .. "," end
+			--~ print("spell",gSpellBookNameByID[spellbookid],spellid,myspellname,r=
egtxt)
 		end
+		circlestart =3D circlestart + table.getn(spelllist)
 	end
 end
-
+--~ os.exit(0)
+
+
+function GetSpell_CastDelayBase (spellid)
+	local base =3D 3 --~ RunUO-2.0-SVN/Scripts/Spells/Base/Spell.cs:642:	//pu=
blic virtual int CastDelayBase{ get{ return 3; } }
+	if (IsMageSpell(spellid)) then -- RunUO-2.0-SVN/Scripts/Spells/Base/Mager=
ySpell.cs:108:	public override TimeSpan CastDelayBase
+		base =3D (3 + GetSpellCircleByID(spellid)) * kCastDelaySecondsPerTick
+	end
+
+	if (spellid =3D=3D 606) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/NatureFury.cs:15:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 601) then return 0.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/ArcaneCircle.cs:14:		TimeSpan.FromSeconds( 0.5 ); } }
+	if (spellid =3D=3D 602) then return 3.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/GiftOfRenewal.cs:15:		TimeSpan.FromSeconds( 3.0 ); } }
+	if (spellid =3D=3D 607) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/SummonFey.cs:13:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 615) then return 4.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/GiftOfLife.cs:17:			TimeSpan.FromSeconds( 4.0 ); } }
+	if (spellid =3D=3D 614) then return 3.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/WordOfDeath.cs:14:		TimeSpan.FromSeconds( 3.5 ); } }
+	if (spellid =3D=3D 604) then return 1.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/AttuneWeapon.cs:14:		TimeSpan.FromSeconds( 1.0 ); } }  --=
 attunement ?
+	if (spellid =3D=3D 613) then return 3.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/EtherealVoyage.cs:12:		TimeSpan.FromSeconds( 3.5 ); } }
+	if (spellid =3D=3D 611) then return 3.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/EssenceOfWind.cs:14:		TimeSpan.FromSeconds( 3.0 ); } }
+	if (spellid =3D=3D 605) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/Thunderstorm.cs:14:		TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 608) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/SummonFiend.cs:13:		TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 609) then return 2.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/ReaperForm.cs:13:			TimeSpan.FromSeconds( 2.5 ); } }
+	=

+	if (spellid =3D=3D 507) then return 1.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Ninjitsu/ShadowJump.cs:18:				TimeSpan.FromSeconds( 1.0 ); } }
+	if (spellid =3D=3D 508) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Ninjitsu/MirrorImage.cs:52:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 503) then return 1.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Ninjitsu/AnimalForm.cs:34:				TimeSpan.FromSeconds( 1.0 ); } }
+	=

+	if (spellid =3D=3D 404) then return 0.25 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Bushido/CounterAttack.cs:18:			TimeSpan.FromSeconds( 0.25 ); } }
+	if (spellid =3D=3D 403) then return 0.25 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Bushido/Evasion.cs:18:					TimeSpan.FromSeconds( 0.25 ); } }
+	if (spellid =3D=3D 402) then return 0.25 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Bushido/Confidence.cs:17:				TimeSpan.FromSeconds( 0.25 ); } }
+
+	if (spellid =3D=3D 206) then return 0.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/EnemyOfOne.cs:19:				TimeSpan.FromSeconds( 0.5 ); } }
+	if (spellid =3D=3D 208) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/NobleSacrifice.cs:23:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 202) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/CloseWounds.cs:18:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 204) then return 0.25 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/DispelEvil.cs:19:				TimeSpan.FromSeconds( 0.25 ); } }
+	if (spellid =3D=3D 203) then return 0.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/ConsecrateWeapon.cs:17:		TimeSpan.FromSeconds( 0.5 ); } }
+	if (spellid =3D=3D 207) then return 1.75 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/HolyLight.cs:17:				TimeSpan.FromSeconds( 1.75 ); } }
+	if (spellid =3D=3D 201) then return 1.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/CleanseByFire.cs:17:			TimeSpan.FromSeconds( 1.0 ); } }
+	if (spellid =3D=3D 209) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/RemoveCurse.cs:19:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 210) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/SacredJourney.cs:19:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 205) then return 1.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Chivalry/DivineFury.cs:17:				TimeSpan.FromSeconds( 1.0 ); } }
+	=

+	if (spellid =3D=3D 117) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/Exorcism.cs:23:				TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 102) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/BloodOathSpell.cs:18:		TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 115) then return 1.25 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/Wither.cs:20:				TimeSpan.FromSeconds( 1.25 ); } }
+	if (spellid =3D=3D 104) then return 0.75 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/CurseWeapon.cs:18:			TimeSpan.FromSeconds( 0.75 ); } }
+	if (spellid =3D=3D 106) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/HorrificBeast.cs:19:		TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 109) then return 1.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/PainSpike.cs:19:			TimeSpan.FromSeconds( 1.0 ); } }
+	if (spellid =3D=3D 114) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/VengefulSpirit.cs:21:		TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 113) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/VampiricEmbrace.cs:20:		TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 101) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/AnimateDeadSpell.cs:22:		TimeSpan.FromSeconds( 1.5 ); } }
+	=

+	if (spellid =3D=3D 105) then return 0.75 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/EvilOmen.cs:20:				TimeSpan.FromSeconds( 0.75 ); } }
+	if (spellid =3D=3D 103) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/CorpseSkin.cs:19:			TimeSpan.FromSeconds( 1.5 ); } }
+	if (spellid =3D=3D 111) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/Strangle.cs:19:				TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 112) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/SummonFamiliar.cs:22:		TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 116) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/WraithForm.cs:19:			TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 107) then return 2.0  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/LichForm.cs:20:				TimeSpan.FromSeconds( 2.0 ); } }
+	if (spellid =3D=3D 110) then return 1.75 end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/PoisonStrike.cs:18:			TimeSpan.FromSeconds( (Core.ML ? 1.75=
 : 1.5) ); } }
+	if (spellid =3D=3D 108) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Necromancy/MindRot.cs:20:				TimeSpan.FromSeconds( 1.5 ); } }
+
+	=

+	if (spellid =3D=3D 25) then return base-0.25 end	--~ RunUO-2.0-SVN/Script=
s/Spells/Fourth/ArchCure.cs:32:					return base.CastDelayBase - TimeSpan.Fr=
omSeconds( 0.25 ); } }
+												--~ RunUO-2.0-SVN/Scripts/Skills/SpiritSpeak.cs:88:						retur=
n TimeSpan.FromSeconds( 1.0 ); } }
+	return base 								=

+end
+ =

+function GetSpell_CastDelayMinimum (spellid)
+	return 0.25 -- RunUO-2.0-SVN/Scripts/Spells/Base/Spell.cs:640:	public vir=
tual TimeSpan CastDelayMinimum { get { return TimeSpan.FromSeconds( 0.25 );=
 } }
+end
+
+function GetSpell_CastDelayFastScalar (spellid)
+	local spellbookid =3D GetSpellBookIDBySpellID(spellid)
+	if (spellbookid =3D=3D NinjitsuSpellbook	) then return 0 end		--~ RunUO-2=
.0-SVN/Scripts/Spells/Ninjitsu/NinjaSpell.cs:24:			public override double C=
astDelayFastScalar { get { return 0; } }
+	if (spellbookid =3D=3D BushidoSpellbook		) then return 0 end		--~ RunUO-2=
.0-SVN/Scripts/Spells/Bushido/SamuraiSpell.cs:22:		public override double C=
astDelayFastScalar{ get{ return 0; } }
+	if (spellbookid =3D=3D NecroSpellbook		) then return 0 end		--~ RunUO-2.0=
-SVN/Scripts/Spells/Necromancy/NecromancerSpell.cs:18:	public override doub=
le CastDelayFastScalar{ get{ return (Core.SE? base.CastDelayFastScalar : 0)=
; } } // Necromancer spells are not affected by fast cast items, though the=
y are by fast cast recovery
+	--~ RunUO-2.0-SVN/Scripts/Skills/SpiritSpeak.cs:87:					public override d=
ouble CastDelayFastScalar { get { return 0; } }
+	--~ RunUO-2.0-SVN/Scripts/Mobiles/Animals/Mounts/Ethereals.cs:366:	public=
 override double CastDelayFastScalar { get { return 0; } }
+	--~ MageSpellbook
+	--~ ChivalrySpellbook		=

+	--~ SpellweavingSpellbook	=

+	return 1 -- default 1
+end
+
+ =

+function GetSpellCastTime (spellid,fc,bProtectionBuffActive)
+	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
+	--~ TODO : if( EssenceOfWindSpell.IsDebuffed( m_Caster ) ) fc -=3D Essenc=
eOfWindSpell.GetFCMalus( m_Caster );
+	fc =3D min(fc,2)
+	if (bProtectionBuffActive) then fc =3D fc - 2 end
+	local spellcircle =3D GetSpellCircleByID(spellid)
+	return min(GetSpell_CastDelayBase(spellid) - (GetSpell_CastDelayFastScala=
r(spellid) * fc * kCastDelaySecondsPerTick),GetSpell_CastDelayMinimum(spell=
id));
+end
+
+gMagerySpellMana =3D { 4, 6, 9, 11, 14, 20, 40, 50 }
+
+
+--[[
+		public virtual TimeSpan GetCastDelay()
+		{
+			TimeSpan baseDelay =3D CastDelayBase;
+			TimeSpan fcDelay =3D TimeSpan.FromSeconds( -(CastDelayFastScalar * fc *=
 CastDelaySecondsPerTick) );
+			return min(baseDelay + fcDelay,CastDelayMinimum);
+		}
+		public override TimeSpan CastDelayBase return TimeSpan.FromSeconds( (3 +=
 (int)Circle) * CastDelaySecondsPerTick );
 		=

-
---[[
+		=

+	"Clumsy", "Uus Jux",			212,9031,Reagent.Bloodmoss,Reagent.Nightshade
+	"Create Food", "In Mani Ylem",	224,9011,Reagent.Garlic,Reagent.Ginseng,Re=
agent.MandrakeRoot
+	"Feeblemind", "Rel Wis",		212,9031,Reagent.Ginseng,Reagent.Nightshade
+	"Heal", "In Mani",				224,9061,Reagent.Garlic,Reagent.Ginseng,Reagent.Spi=
dersSilk
+	"Magic Arrow", "In Por Ylem",	212,9041,Reagent.SulfurousAsh
+	"Night Sight", "In Lor",		236,9031,Reagent.SulfurousAsh,Reagent.SpidersSi=
lk
+	"Reactive Armor", "Flam Sanct",	236,9011,Reagent.Garlic,Reagent.SpidersSi=
lk,Reagent.SulfurousAsh
+	"Weaken", "Des Mani",			212,9031,Reagent.Garlic,Reagent.Nightshade
+	=

 	{"Focus Attack",	10,30,"Increases both your damage and the percentage cha=
nce for \"hit\" properties on your weapon for one attack"},
 	{"Death Strike",	30,85,"After receiving a Death Strike, if the opponent m=
oves more than five steps or five seconds elapses, they will suffer direct =
damage determined by the attacker's ninjitsu."},
 	{"Animal Form",		10,0,"Allows you to transform into an animal, gaining sp=
ecial bonuses..."},

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 04:33:36 2008
@@ -41,10 +41,12 @@
 end)
 =

 RegisterListener("Hook_SendSpell",function (spellid)
-	local spellname =3D GetSpellNameByID(spellid)
-	local equipprop =3D GetSpellBarEquipProps()
-	print("spellbar:Hook_SendSpell",spellid,spellname,SmartDump(equipprop))
-	SpellBarRiseTextOnMob(GetPlayerSerial(),spellname,1,1,1) =

+	local spellname		=3D GetSpellNameByID(spellid)
+	local spellcircle	=3D GetSpellCircleByID(spellid)
+	local spellbookid	=3D GetSpellBookIDBySpellID(spellid)
+	local equipprop		=3D GetSpellBarEquipProps()
+	print("spellbar:Hook_SendSpell",spellid,spellname,spellcircle,SmartDump(e=
quipprop))
+	SpellBarRiseTextOnMob(GetPlayerSerial(),sprintf("%s(%d,%d)%s",spellname,s=
pellcircle,spellid,IsMageSpell(spellid) and "mage" or ""),1,1,1) =

 end)
 =

 function SpellBarRiseTextOnMob (serial,text,r,g,b)
@@ -52,21 +54,22 @@
 	Renderer2D:HUDFX_AddRisingTextOnMob(GetMobile(serial),text,r,g,b) -- see =
2d.hudfx.lua
 end
 =

-kSpellBar_Msg_AlreadyCasting	=3D 502642 -- You are already casting a spell.
-kSpellBar_Msg_Fizzle			=3D 502632 -- The spell fizzles.
-kSpellBar_Msg_Disturbed			=3D 500641 -- Your concentration is disturbed, t=
hus ruining thy spell.
-kSpellBar_Msg_NoMana			=3D 502625 -- Insufficient mana for this spell.
-
+kSpellBar_Msg_AlreadyCasting	=3D 502642 	-- You are already casting a spel=
l.
+kSpellBar_Msg_Fizzle			=3D 502632	-- The spell fizzles.
+kSpellBar_Msg_Disturbed			=3D 500641 	-- Your concentration is disturbed, =
thus ruining thy spell.
+kSpellBar_Msg_NoMana			=3D 502625 	-- Insufficient mana for this spell.
+kSpellBar_Msg_TooManyFollowers	=3D 1049645	-- You have too many followers =
to summon that creature.       =

 =

 RegisterListener("Hook_Packet_Text",			function (serial,plaintext) =

 	--~ print("Hook_Packet_Text",serial,plaintext) =

 end)
 RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum) =

 	local r,g,b =3D 1,0,0 -- red
-	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),"already casting",r,g,b) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"fizzle",r,g,b) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),"disturbed",r,g,b) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"no mana",r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),"already casting"		,r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"fizzle"					,r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),"disturbed"				,r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"no mana"				,r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_TooManyFollowers	) then SpellBar=
RiseTextOnMob(GetPlayerSerial(),"too many followers"		,r,g,b) end
 	--~ print("Hook_Packet_Localized_Text",serial,plaintext,text_messagenum) =

 end)
 =




From no-reply at zwischenwelt.org  Sun Oct 12 04:47:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 02:47:34 -0000
Subject: [Iris-commit] [IRIS] r2550 - in /trunk: lua/lib.buff.lua
 lua/lib.spellbooks.lua plugins/lib.spellbar.lua
Message-ID: <20081012024735.1B1381C187C4@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 04:47:34 2008
New Revision: 2550

Log:
spelltimecalc starts to work

Modified:
    trunk/lua/lib.buff.lua
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.buff.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.buff.lua (original)
+++ trunk/lua/lib.buff.lua Sun Oct 12 04:47:34 2008
@@ -64,6 +64,11 @@
 gBuffIcons[1046] =3D { iGumpID=3Dhex2num("0x7547"), name=3D"Cunning"					}
 gBuffIcons[1047] =3D { iGumpID=3Dhex2num("0x7567"), name=3D"Strength"					}
 gBuffIcons[1048] =3D { iGumpID=3Dhex2num("0x7542"), name=3D"Bless"					}
+
+
+function IsBuffActive_Protection		() return gBuffs[1029] end
+function IsBuffActive_EssenceOfWind		() return gBuffs[1023] end
+
 =

 kUnknownBuffGumpID =3D hex2num("0x7555") -- (snakes)
 =


Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Oct 12 04:47:34 2008
@@ -308,7 +308,8 @@
 function GetSpell_CastDelayBase (spellid)
 	local base =3D 3 --~ RunUO-2.0-SVN/Scripts/Spells/Base/Spell.cs:642:	//pu=
blic virtual int CastDelayBase{ get{ return 3; } }
 	if (IsMageSpell(spellid)) then -- RunUO-2.0-SVN/Scripts/Spells/Base/Mager=
ySpell.cs:108:	public override TimeSpan CastDelayBase
-		base =3D (3 + GetSpellCircleByID(spellid)) * kCastDelaySecondsPerTick
+		local circle =3D GetSpellCircleByID(spellid)
+		base =3D (3 + circle) * kCastDelaySecondsPerTick
 	end
 =

 	if (spellid =3D=3D 606) then return 1.5  end	--~ RunUO-2.0-SVN/Scripts/Sp=
ells/Spellweaving/NatureFury.cs:15:			TimeSpan.FromSeconds( 1.5 ); } }
@@ -385,14 +386,17 @@
 	return 1 -- default 1
 end
 =

- =

-function GetSpellCastTime (spellid,fc,bProtectionBuffActive)
+-- bProtectionBuffActive : see IsBuffActive_Protection() IsBuffActive_Esse=
nceOfWind()
+function GetSpellCastTime (spellid,fc,bBuffActive_Protection,bBuffActive_E=
ssenceOfWind)
 	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
 	--~ TODO : if( EssenceOfWindSpell.IsDebuffed( m_Caster ) ) fc -=3D Essenc=
eOfWindSpell.GetFCMalus( m_Caster );
 	fc =3D min(fc,2)
-	if (bProtectionBuffActive) then fc =3D fc - 2 end
-	local spellcircle =3D GetSpellCircleByID(spellid)
-	return min(GetSpell_CastDelayBase(spellid) - (GetSpell_CastDelayFastScala=
r(spellid) * fc * kCastDelaySecondsPerTick),GetSpell_CastDelayMinimum(spell=
id));
+	if (bBuffActive_Protection) then fc =3D fc - 2 end
+	local castDelayBase			=3D GetSpell_CastDelayBase(spellid)
+	local castDelayFastScalar	=3D GetSpell_CastDelayFastScalar(spellid)
+	local castDelayMinimum		=3D GetSpell_CastDelayMinimum(spellid)
+	--~ print("GetSpellCastTime",spellid,fc,bBuffActive_Protection,castDelayB=
ase,castDelayFastScalar,castDelayMinimum)
+	return max(castDelayBase - (castDelayFastScalar * fc * kCastDelaySecondsP=
erTick),castDelayMinimum);
 end
 =

 gMagerySpellMana =3D { 4, 6, 9, 11, 14, 20, 40, 50 }

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 04:47:34 2008
@@ -45,7 +45,8 @@
 	local spellcircle	=3D GetSpellCircleByID(spellid)
 	local spellbookid	=3D GetSpellBookIDBySpellID(spellid)
 	local equipprop		=3D GetSpellBarEquipProps()
-	print("spellbar:Hook_SendSpell",spellid,spellname,spellcircle,SmartDump(e=
quipprop))
+	local casttime		=3D GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Pr=
otection(),IsBuffActive_EssenceOfWind())
+	print("spellbar:Hook_SendSpell",spellid,spellname,spellcircle,casttime,Sm=
artDump(equipprop))
 	SpellBarRiseTextOnMob(GetPlayerSerial(),sprintf("%s(%d,%d)%s",spellname,s=
pellcircle,spellid,IsMageSpell(spellid) and "mage" or ""),1,1,1) =

 end)
 =




From no-reply at zwischenwelt.org  Sun Oct 12 05:20:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 03:20:06 -0000
Subject: [Iris-commit] [IRIS] r2551 - in /trunk: lua/lib.spellbooks.lua
	plugins/lib.spellbar.lua
Message-ID: <20081012040010.9614E1C187C5@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 05:20:06 2008
New Revision: 2551

Log:
spellbar casttime calc

Modified:
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Oct 12 05:20:06 2008
@@ -286,10 +286,10 @@
 gSpellBookIDBySpellID =3D {}
 for spellbookid,spellbookdata in pairs(gSpellBooks) do
 	local startindex =3D spellbookdata.startindex
-	local circlestart =3D startindex
+	local circlesize =3D table.getn(spellbookdata.spells[1])
 	for circle,spelllist in pairs(spellbookdata.spells) do
 		for spellindex,myspellname in pairs(spelllist) do
-			local spellid					=3D spellindex + circlestart
+			local spellid					=3D spellindex + startindex + (circle-1)*circlesize
 			gSpellIDByName[myspellname]		=3D spellid
 			gSpellNameByID[spellid]			=3D myspellname
 			gSpellCircleByID[spellid]		=3D circle
@@ -299,7 +299,6 @@
 			--~ for k,v in pairs(regs) do regtxt =3D regtxt .. tostring(spellbookda=
ta.reagenz[v]) .. "," end
 			--~ print("spell",gSpellBookNameByID[spellbookid],spellid,myspellname,r=
egtxt)
 		end
-		circlestart =3D circlestart + table.getn(spelllist)
 	end
 end
 --~ os.exit(0)
@@ -386,6 +385,7 @@
 	return 1 -- default 1
 end
 =

+-- returns time in milliseconds, you should  add about 150 msec latency
 -- bProtectionBuffActive : see IsBuffActive_Protection() IsBuffActive_Esse=
nceOfWind()
 function GetSpellCastTime (spellid,fc,bBuffActive_Protection,bBuffActive_E=
ssenceOfWind)
 	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
@@ -396,7 +396,7 @@
 	local castDelayFastScalar	=3D GetSpell_CastDelayFastScalar(spellid)
 	local castDelayMinimum		=3D GetSpell_CastDelayMinimum(spellid)
 	--~ print("GetSpellCastTime",spellid,fc,bBuffActive_Protection,castDelayB=
ase,castDelayFastScalar,castDelayMinimum)
-	return max(castDelayBase - (castDelayFastScalar * fc * kCastDelaySecondsP=
erTick),castDelayMinimum);
+	return 1000 * max(castDelayBase - (castDelayFastScalar * fc * kCastDelayS=
econdsPerTick),castDelayMinimum);
 end
 =

 gMagerySpellMana =3D { 4, 6, 9, 11, 14, 20, 40, 50 }

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 05:20:06 2008
@@ -3,6 +3,7 @@
 if (not gDisabledPlugins.spellbar) then =

 gSpellBarEquipPropCache =3D nil
 gSpellBarEquipmentSerials =3D {}
+kSpellTimeLatency =3D 150
 =

 -- returns proparr=3D{fc=3D?,fcr=3D?}
 function GetSpellBarEquipProps ()
@@ -40,12 +41,27 @@
 	=

 end)
 =

+RegisterListener("Hook_TargetMode_Start",function () =

+	if (gSpellBarLastSpellSendTime) then
+		local t =3D Client_GetTicks()
+		local dt =3D t-gSpellBarLastSpellSendTime
+		local spellid =3D gSpellBarLastSpellSendID
+		--~ print("spellbar : timediff",dt,"C:"..GetSpellCircleByID(spellid),Get=
SpellNameByID(spellid))
+		--~ local r,g,b =3D 0.5,0.5,0.5
+		--~ SpellBarRiseTextOnMob(GetPlayerSerial(),"t:"..dt,r,g,b)
+		gSpellBarLastSpellSendTime =3D nil
+	end
+end)
+
 RegisterListener("Hook_SendSpell",function (spellid)
+	local t =3D Client_GetTicks()
+	gSpellBarLastSpellSendTime =3D t
+	gSpellBarLastSpellSendID =3D spellid
 	local spellname		=3D GetSpellNameByID(spellid)
 	local spellcircle	=3D GetSpellCircleByID(spellid)
 	local spellbookid	=3D GetSpellBookIDBySpellID(spellid)
 	local equipprop		=3D GetSpellBarEquipProps()
-	local casttime		=3D GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Pr=
otection(),IsBuffActive_EssenceOfWind())
+	local casttime		=3D GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Pr=
otection(),IsBuffActive_EssenceOfWind()) + kSpellTimeLatency
 	print("spellbar:Hook_SendSpell",spellid,spellname,spellcircle,casttime,Sm=
artDump(equipprop))
 	SpellBarRiseTextOnMob(GetPlayerSerial(),sprintf("%s(%d,%d)%s",spellname,s=
pellcircle,spellid,IsMageSpell(spellid) and "mage" or ""),1,1,1) =

 end)



From no-reply at zwischenwelt.org  Sun Oct 12 13:06:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 11:06:29 -0000
Subject: [Iris-commit] [IRIS] r2552 - /trunk/README
Message-ID: <20081012110629.4E2C21C187C4@zwischenwelt.org>

Author: sience
Date: Sun Oct 12 13:06:28 2008
New Revision: 2552

Log:
-fix

Modified:
    trunk/README

Modified: trunk/README
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/README (original)
+++ trunk/README Sun Oct 12 13:06:28 2008
@@ -1,4 +1,4 @@
-Iris2, Copyright (C) 2006 - 2007 Iris Team
+Iris2, Copyright (C) 2006 - 2008 Iris Team
 __________________________________________
 =

 Iris2 is a 3D/2D game client for Online Role Playing Game "Ultima Online" =
(tm)



From no-reply at zwischenwelt.org  Sun Oct 12 14:03:37 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 12:03:37 -0000
Subject: [Iris-commit] [IRIS] r2553 - /trunk/lua/gui/gui.skill.lua
Message-ID: <20081012120337.A24931C181F9@zwischenwelt.org>

Author: hagish
Date: Sun Oct 12 14:03:36 2008
New Revision: 2553

Log:
colored weapon ability icons

Modified:
    trunk/lua/gui/gui.skill.lua

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Sun Oct 12 14:03:36 2008
@@ -198,7 +198,7 @@
 		if mobile and mobile.serial then
 			Send_AOSCommand_WeaponAbility(mobile.serial, weaponabilityid)
 		end
-	end, iconid)
+	end, iconid, true)
 =

 	d.weaponabilityid =3D weaponabilityid
 	NotifyListener("Hook_CreateQuickWeaponAbility",d,x,y,weaponabilityid)



From no-reply at zwischenwelt.org  Sun Oct 12 16:16:46 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 14:16:46 -0000
Subject: [Iris-commit] [IRIS] r2554 - in /trunk: lua/lib.spellbooks.lua
	plugins/lib.spellbar.lua
Message-ID: <20081012141646.B56C51C187C4@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 16:16:46 2008
New Revision: 2554

Log:
spellbar and a few casttime fixes

Modified:
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Oct 12 16:16:46 2008
@@ -387,6 +387,7 @@
 =

 -- returns time in milliseconds, you should  add about 150 msec latency
 -- bProtectionBuffActive : see IsBuffActive_Protection() IsBuffActive_Esse=
nceOfWind()
+-- see also RunUO-2.0-SVN/Scripts/Spells/Base/Spell.cs:647:	public virtual=
 TimeSpan GetCastDelay()
 function GetSpellCastTime (spellid,fc,bBuffActive_Protection,bBuffActive_E=
ssenceOfWind)
 	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
 	--~ TODO : if( EssenceOfWindSpell.IsDebuffed( m_Caster ) ) fc -=3D Essenc=
eOfWindSpell.GetFCMalus( m_Caster );
@@ -395,8 +396,11 @@
 	local castDelayBase			=3D GetSpell_CastDelayBase(spellid)
 	local castDelayFastScalar	=3D GetSpell_CastDelayFastScalar(spellid)
 	local castDelayMinimum		=3D GetSpell_CastDelayMinimum(spellid)
+	local castDelay				=3D 1000 * max(castDelayBase - (castDelayFastScalar * =
fc * kCastDelaySecondsPerTick),castDelayMinimum)
 	--~ print("GetSpellCastTime",spellid,fc,bBuffActive_Protection,castDelayB=
ase,castDelayFastScalar,castDelayMinimum)
-	return 1000 * max(castDelayBase - (castDelayFastScalar * fc * kCastDelayS=
econdsPerTick),castDelayMinimum);
+	if (spellid =3D=3D 33) then return castDelay*3 end -- RunUO-2.0-SVN/Scrip=
ts/Spells/Fifth/BladeSpirits.cs:29:	return TimeSpan.FromTicks( base.GetCast=
Delay().Ticks * ((Core.SE) ? 3 : 5) );
+	if (spellid =3D=3D 40) then return castDelay*5 end -- RunUO-2.0-SVN/Scrip=
ts/Spells/Fifth/SummonCreature.cs:86:	return TimeSpan.FromTicks( base.GetCa=
stDelay().Ticks * 5 );
+	return castDelay
 end
 =

 gMagerySpellMana =3D { 4, 6, 9, 11, 14, 20, 40, 50 }

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 16:16:46 2008
@@ -38,7 +38,7 @@
 end)
 =

 RegisterListener("Hook_HUDStep",function ()
-	=

+	SpellBarStep()
 end)
 =

 RegisterListener("Hook_TargetMode_Start",function () =

@@ -48,8 +48,9 @@
 		local spellid =3D gSpellBarLastSpellSendID
 		--~ print("spellbar : timediff",dt,"C:"..GetSpellCircleByID(spellid),Get=
SpellNameByID(spellid))
 		--~ local r,g,b =3D 0.5,0.5,0.5
-		--~ SpellBarRiseTextOnMob(GetPlayerSerial(),"t:"..dt,r,g,b)
+		--~ SpellBarRiseTextOnMob(GetPlayerSerial(),r,g,b,"t:"..dt)
 		gSpellBarLastSpellSendTime =3D nil
+		SpellBarTargetCursor()
 	end
 end)
 =

@@ -63,10 +64,66 @@
 	local equipprop		=3D GetSpellBarEquipProps()
 	local casttime		=3D GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Pr=
otection(),IsBuffActive_EssenceOfWind()) + kSpellTimeLatency
 	print("spellbar:Hook_SendSpell",spellid,spellname,spellcircle,casttime,Sm=
artDump(equipprop))
-	SpellBarRiseTextOnMob(GetPlayerSerial(),sprintf("%s(%d,%d)%s",spellname,s=
pellcircle,spellid,IsMageSpell(spellid) and "mage" or ""),1,1,1) =

+	SpellBarRiseTextOnMob(GetPlayerSerial(),1,1,1,spellname)
+	SpellBarStart(casttime)	=

+	--~ SpellBarRiseTextOnMob(GetPlayerSerial(),1,1,1,sprintf("%s(%d,%d)%s",s=
pellname,spellcircle,spellid,IsMageSpell(spellid) and "mage" or "")) =

 end)
 =

-function SpellBarRiseTextOnMob (serial,text,r,g,b)
+
+
+function SpellBarEnd ()
+	if (gSpellBarGfx) then gSpellBarGfx:Destroy() gSpellBarGfx =3D nil end
+end
+function SpellBarStart (casttime)
+	if (gCurrentRenderer ~=3D Renderer2D) then return end
+	SpellBarEnd()
+	local t =3D Client_GetTicks()
+	local gfx	=3D gRootWidget.hudfx:CreateChild("Group")
+	gfx.mob		=3D GetPlayerMobile()
+	gfx.zadd	=3D 10 -- above head
+	gfx.startt	=3D t
+	gfx.endt	=3D t + casttime
+	gfx.dur		=3D casttime
+	gfx.maxw	=3D 100
+	gfx.h		=3D 10
+	local w,h	=3D gfx.maxw,gfx.h
+	local paramb =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),w,h, 0,0, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, false, fal=
se)
+	local paramf =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),0,h, 0,0, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, false, fal=
se)
+	local gray	=3D 0.2
+	paramb.r =3D gray
+	paramb.g =3D gray
+	paramb.b =3D gray
+	=

+	gfx.border	=3D gfx:CreateChild("Image",{gfxparam_init=3Dparamb})
+	gfx.fill	=3D gfx:CreateChild("Image",{gfxparam_init=3Dparamf})
+	gSpellBarGfx =3D gfx
+end
+function SpellBarStep ()
+	if (gCurrentRenderer ~=3D Renderer2D) then return end
+	local gfx =3D gSpellBarGfx
+	if (not gfx) then return end
+	=

+	-- position above mob
+	local mobile =3D gfx.mob
+	local px,py =3D gCurrentRenderer:UOPosToPixelPos(mobile.xloc,mobile.yloc,=
mobile.zloc+gfx.zadd)
+	if (px) then gfx:SetPos(px,py) end
+	=

+	-- calc time and width
+	local t =3D Client_GetTicks()
+	local ft =3D (t - gfx.startt) / gfx.dur
+	if (ft > 1) then SpellBarEnd() return end
+	ft =3D max(0,min(1,ft))
+	local w =3D ft * gfx.maxw
+	gfx.fill:SetSize(w,gfx.h)
+end
+function SpellBarInterrupt ()
+	SpellBarEnd()
+end
+function SpellBarTargetCursor ()
+	SpellBarEnd()
+end
+
+function SpellBarRiseTextOnMob (serial,r,g,b,text)
 	if (gCurrentRenderer ~=3D Renderer2D) then return end
 	Renderer2D:HUDFX_AddRisingTextOnMob(GetMobile(serial),text,r,g,b) -- see =
2d.hudfx.lua
 end
@@ -80,16 +137,16 @@
 RegisterListener("Hook_Packet_Text",			function (serial,plaintext) =

 	--~ print("Hook_Packet_Text",serial,plaintext) =

 end)
+
 RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum) =

 	local r,g,b =3D 1,0,0 -- red
-	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),"already casting"		,r,g,b) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"fizzle"					,r,g,b) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),"disturbed"				,r,g,b) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),"no mana"				,r,g,b) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_TooManyFollowers	) then SpellBar=
RiseTextOnMob(GetPlayerSerial(),"too many followers"		,r,g,b) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),r,g,b,"already casting"		) end
+	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),r,g,b,"fizzle"				) SpellBarInterrupt() end
+	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),r,g,b,"disturbed"			) SpellBarInterrupt() end
+	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),r,g,b,"no mana"				) SpellBarInterrupt() end
+	if (text_messagenum =3D=3D kSpellBar_Msg_TooManyFollowers	) then SpellBar=
RiseTextOnMob(GetPlayerSerial(),r,g,b,"too many followers"	) SpellBarInterr=
upt() end
 	--~ print("Hook_Packet_Localized_Text",serial,plaintext,text_messagenum) =

 end)
-
 =

 	=

 --[[



From no-reply at zwischenwelt.org  Sun Oct 12 16:18:17 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 14:18:17 -0000
Subject: [Iris-commit] [IRIS] r2555 - /trunk/plugins/lib.spellbar.lua
Message-ID: <20081012141818.201C91C181F9@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 16:18:17 2008
New Revision: 2555

Log:
spellbar

Modified:
    trunk/plugins/lib.spellbar.lua

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 16:18:17 2008
@@ -95,7 +95,7 @@
 	paramb.b =3D gray
 	=

 	gfx.border	=3D gfx:CreateChild("Image",{gfxparam_init=3Dparamb})
-	gfx.fill	=3D gfx:CreateChild("Image",{gfxparam_init=3Dparamf})
+	gfx.fill	=3D gfx:CreateChild("Image",{gfxparam_init=3Dparamf,bVertexBuffe=
rDynamic=3Dtrue})
 	gSpellBarGfx =3D gfx
 end
 function SpellBarStep ()



From no-reply at zwischenwelt.org  Sun Oct 12 17:04:40 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 15:04:40 -0000
Subject: [Iris-commit] [IRIS] r2556 - in /trunk/lua: filter/filter.art.lua
 lib.2d.spriteblock.lua net/net.world.lua
Message-ID: <20081012150441.09DB21C181F9@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 17:04:40 2008
New Revision: 2556

Log:
removed foilage for desolation season, used season translation in 2d

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/net/net.world.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Sun Oct 12 17:04:40 2008
@@ -377,6 +377,7 @@
 gSeasonStaticTranslators =3D {[0]=3DgStaticTable_Spring,[1]=3Dnil,[2]=3DgS=
taticTable_Fall,[3]=3DgStaticTable_Winter,[4]=3DgStaticTable_Desolation}
 function SeasonalStaticTranslation (iTileTypeID, iSeasonID)
 	local translator =3D gSeasonStaticTranslators[iSeasonID]
+	if (iSeasonID =3D=3D 4 and TestBit(GetStaticTileTypeFlags(iTileTypeID) or=
 0,kTileDataFlag_Foliage)) then return -1 end
 	if (translator) then
 		return translator[iTileTypeID] or iTileTypeID
 	else

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sun Oct 12 17:04:40 2008
@@ -121,7 +121,7 @@
 =

 -- static comes from MapGetBlockStatics(bx,by) : {zloc=3D?,artid=3D?,hue=
=3D?,xloc=3D?,yloc=3D?,tx=3D?,ty=3D?,bx=3D?,by=3D?,bIsStatic=3Dtrue}
 function cUOSpriteBlock:AddStatic (static)
-	local artid =3D static.artid
+	local artid =3D SeasonalStaticTranslation(static.artid, gSeasonSetting)
 	local tx =3D static.tx
 	local ty =3D static.ty
 	local zloc =3D static.zloc

Modified: trunk/lua/net/net.world.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.world.lua (original)
+++ trunk/lua/net/net.world.lua Sun Oct 12 17:04:40 2008
@@ -10,6 +10,7 @@
 	local seasonchange =3D input:PopNetUint8()
 	printdebug("net",sprintf("NET: Game_Season id: %i season: %i seasonchange=
: %i\n",id,season,seasonchange))
 =

+	print("season change",season,gSeasonIDs[season])
 	if (seasonchange =3D=3D 1) then
 		gSeasonSetting =3D season
 	elseif (gSeasonSetting ~=3D season) then



From no-reply at zwischenwelt.org  Sun Oct 12 17:52:47 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 15:52:47 -0000
Subject: [Iris-commit] [IRIS] r2557 - in /trunk/lua: filter/filter.art.lua
	lib.uoids.lua
Message-ID: <20081012155247.C30901C187C4@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 17:52:47 2008
New Revision: 2557

Log:
fixed desolation season translate

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.uoids.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Sun Oct 12 17:52:47 2008
@@ -374,7 +374,6 @@
 ----------------------------------------------------------------------
 =

 -- Seasonal Dynamic & Static Art Translation (run tiles)	-- eventuell (iTi=
leTypeID + 0x4000)
-gSeasonStaticTranslators =3D {[0]=3DgStaticTable_Spring,[1]=3Dnil,[2]=3DgS=
taticTable_Fall,[3]=3DgStaticTable_Winter,[4]=3DgStaticTable_Desolation}
 function SeasonalStaticTranslation (iTileTypeID, iSeasonID)
 	local translator =3D gSeasonStaticTranslators[iSeasonID]
 	if (iSeasonID =3D=3D 4 and TestBit(GetStaticTileTypeFlags(iTileTypeID) or=
 0,kTileDataFlag_Foliage)) then return -1 end
@@ -449,8 +448,83 @@
 ["cff"]=3D-1,
 ["d02"]=3D-1,
 --Foliage multiple tiles
-["d45"]=3D-1
+["d45"]=3D-1,
+
+[0xc37]=3D	0x1bae,
+[0xc38]=3D	0x1bae,
+[0xc45]=3D	0x1b9c,
+[0xc46]=3D	0x1b9d,
+[0xc47]=3D	0x1bae,
+[0xc48]=3D	0x1b9c,
+[0xc49]=3D	0x1b9d,
+[0xc4a]=3D	0x1bae,
+[0xc4b]=3D	0x1bae,
+[0xc4c]=3D	0x1b16,
+[0xc4d]=3D	0x1bae,
+[0xc4e]=3D	0x1b9c,
+[0xc84]=3D	0x1b84,
+[0xc85]=3D	0x1b9c,
+[0xc8b]=3D	0x1b84,
+[0xc8c]=3D	0x1bae,
+[0xc8d]=3D	0x1bae,
+[0xc8e]=3D	0x1b8d,
+[0xc93]=3D	0x1bae,
+[0xc94]=3D	0x1bae,
+[0xc98]=3D	0x1bae,
+[0xc99]=3D	0x1b8d,
+[0xc9e]=3D	0x1182,
+[0xc9f]=3D	0x1bae,
+[0xca0]=3D	0x1bae,
+[0xca1]=3D	0x1bae,
+[0xca2]=3D	0x1bae,
+[0xca3]=3D	0x1bae,
+[0xca4]=3D	0x1bae,
+[0xca7]=3D	0x1b9c,
+[0xcac]=3D	0x1b8d,
+[0xcad]=3D	0x1ae1,
+[0xcae]=3D	0x1b9c,
+[0xcaf]=3D	0x1b9c,
+[0xcb0]=3D	0x1bae,
+[0xcb1]=3D	0x1bae,
+[0xcb2]=3D	0x1bae,
+[0xcb3]=3D	0x1bae,
+[0xcb4]=3D	0x1bae,
+[0xcb5]=3D	0x1b9c,
+[0xcb6]=3D	0x1b9d,
+[0xcb7]=3D	0x1bae,
+[0xcb8]=3D	0x1cea,
+[0xcb9]=3D	0x1b8d,
+[0xcba]=3D	0x1b8d,
+[0xcbb]=3D	0x1b8d,
+[0xcbc]=3D	0x1b8d,
+[0xcbd]=3D	0x1b8d,
+[0xcbe]=3D	0x1b8d,
+[0xcc5]=3D	0x1bae,
+[0xcc7]=3D	0x1b0d,
+[0xce9]=3D	0xed7,
+[0xcea]=3D	0xd3f,
+[0xd0c]=3D	0x1bae,
+[0xd0d]=3D	0x1bae,
+[0xd0e]=3D	0x1bae,
+[0xd0f]=3D	0x1b1c,
+[0xd10]=3D	0x1bae,
+[0xd11]=3D	0x122b,
+[0xd12]=3D	0x1bae,
+[0xd13]=3D	0x1bae,
+[0xd14]=3D	0x122b,
+[0xd15]=3D	0x1b9c,
+[0xd16]=3D	0x1b8d,
+[0xd17]=3D	0x122b,
+[0xd18]=3D	0x1bae,
+[0xd19]=3D	0x1bae,
+[0xd29]=3D	0x1b9c,
+[0xd2b]=3D	0x1b15,
+[0xd2d]=3D	0x1bae,
+[0xd2f]=3D	0x1bae,
+[0x1b7e]=3D	0x1e34,
+
 })
+
 =

 ----------------------------------------------------------------------
 =

@@ -475,6 +549,8 @@
 	11725, 11726, 9256, 9272, =

 }
 =

+-- this line must be executed AFTER the definition of the translation tabl=
es
+gSeasonStaticTranslators =3D {[0]=3DgStaticTable_Spring,[1]=3Dnil,[2]=3DgS=
taticTable_Fall,[3]=3DgStaticTable_Winter,[4]=3DgStaticTable_Desolation}
 =

 function IsGroundPlate	(artid)
 	artid =3D tonumber(artid)

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sun Oct 12 17:52:47 2008
@@ -11,7 +11,7 @@
 =

 function ParseHex2HexArray (arr)
 	local newarr =3D {}
-	for k,v in pairs(arr) do newarr[tonumber(k,16)] =3D tonumber(v,16) end  -=
- hex2num("0x123") is preferred to tonumber(123,16), it is better readable
+	for k,v in pairs(arr) do if (type(k) =3D=3D "string") then newarr[tonumbe=
r(k,16)] =3D tonumber(v,16) else newarr[k]=3Dv end end  -- hex2num("0x123")=
 is preferred to tonumber(123,16), it is better readable
 	return newarr
 end
 =




From no-reply at zwischenwelt.org  Sun Oct 12 19:47:02 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 17:47:02 -0000
Subject: [Iris-commit] [IRIS] r2558 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.mobile.lua lib.2d.spriteblock.lua lib.uoanim.lua
Message-ID: <20081012174702.51CD31C187C4@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 19:47:01 2008
New Revision: 2558

Log:
uoanim : fixed realid calc for anim 3, this fixes a bunch of 2d creature gf=
x, like summoned undeads

Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.spriteblock.lua
    trunk/lua/lib.uoanim.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Sun Oct 12 19:47:01 2008
@@ -87,11 +87,11 @@
 						--~ iIndex =3D iIndex + 1 =

 						--~ fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffe=
r flicker
 						=

-						local iAnimID =3D Anim_GetCorpseAnim(iModelID,mount) + iDirAdd
-						local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,i=
AnimID),iLoaderIndex) or 1000
+						local iAnimID =3D Anim_GetCorpseAnim(iModelID,iLoaderIndex,mount) + =
iDirAdd
+						local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,i=
AnimID,iLoaderIndex),iLoaderIndex) or 1000
 						if (iFrameCount < 1) then iFrameCount =3D 1 end
 						local iFrame =3D iFrameCount - 1
-						local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBac=
kModel)
+						local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBac=
kModel,1)
 						spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBa=
ckModel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sort=
ty,sorttz,fIndexRel,4),item) =

 					end
 				end

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Sun Oct 12 19:47:01 2008
@@ -87,11 +87,11 @@
 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
 			=

-			local iAnimID =3D gMy2DMobileDebugAnim or ( Anim_GetIdleAnim(iModelID,m=
ount) + iDirAdd )
-			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID),iLoaderIndex) or 1000
+			local iAnimID =3D gMy2DMobileDebugAnim or ( Anim_GetIdleAnim(iModelID,i=
LoaderIndex,mount) + iDirAdd )
+			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID,iLoaderIndex),iLoaderIndex) or 1000
 			if (iFrameCount < 1) then iFrameCount =3D 1 end
 			local iFrame =3D floor((gMy2DDebugFrame or 0) / 15) % iFrameCount
-			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del)
+			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del,1)
 			spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackM=
odel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,=
sorttz,fIndexRel,4),mobile) =

 		end
 	end
@@ -117,7 +117,7 @@
 	--~ Renderer2D:UpdateMobileGfx(GetPlayerMobile())
 	if true then return end
 	=

-	--~ local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

+	--~ local iRealID =3D Anim_GetRealID(iModelID,iAnimID,iLoaderIndex) =

 	--~ local o =3D gfx.animinfo   =3D GetAnimDataInfo(iModelID) -- o.miFrame=
s,o.miUnknown,o.miCount,o.miFrameInterval,o.miFrameStart
 	--~ print("animinfo",o.miFrames,o.miUnknown,o.miCount,o.miFrameInterval,o=
.miFrameStart)
 	--animinfo        table: 0x93e5d90        -1      -1      -1      -1

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Sun Oct 12 19:47:01 2008
@@ -154,7 +154,7 @@
 		return sprite
 	end
 end
-	=

+
 function cUOSpriteBlock:AddAnimModel (tx,ty,tz,iTranslatedModelID,iHue,iLo=
aderIndex,iFallBackModel,iFallBackAnim,iAnimID,iFrame,bMirrorX,sortbonus,da=
ta)
 	iHue =3D BitwiseAND(iHue or 0,0x7fff) -- 0x03F4 : human skin hue (0x83F4=
=3D33780, but 0x8* is partial hue and turned out all gray here)
 	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnim=
ID,iFrame,iHue,iLoaderIndex)

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Sun Oct 12 19:47:01 2008
@@ -186,7 +186,7 @@
 -- TODO : http://svn.berlios.de/viewcvs/wolfpack/trunk/client/  =

 =

 gAnimAtlasCache =3D {}
-kAnimIDRangeLen_HighDetailed	=3D 200  -- mHighDetailed
+kAnimIDRangeLen_HighDetailed	=3D 200  -- mHighDetailed    WARNING ! depend=
s on iLoaderIndex, see Anim_GetRealID
 kAnimIDRangeLen_LowDetailed		=3D 200  -- mLowDetailed
 =

 =

@@ -221,7 +221,7 @@
 =

 -- returns atlaspiece
 function Anim2DAtlas_LoadAtlasPiece (iModelID,iAnimID,iFrame,iHue,iLoaderI=
ndex)
-	return Anim2DAtlas_LoadAtlasPieceEx(Anim_GetRealID(iModelID,iAnimID),iFra=
me,iHue,iLoaderIndex)
+	return Anim2DAtlas_LoadAtlasPieceEx(Anim_GetRealID(iModelID,iAnimID,iLoad=
erIndex),iFrame,iHue,iLoaderIndex)
 end
 =

 function Anim2DAtlas_LoadAtlasPieceEx (iRealID,iFrame,iHue,iLoaderIndex)
@@ -233,7 +233,9 @@
 	-- load frame image
 	--~ local iFrameCount =3D Anim2D_GetFrameCount(iRealID,iLoaderIndex)
 	--~ iFrame =3D iFrame % iFrameCount
+	--~ print("Anim2DAtlas_LoadAtlasPieceEx:ExportAnimFrameToImage",iRealID,i=
Frame,iHue,iLoaderIndex)
 	local img,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrameToI=
mage(iRealID,iFrame,iHue,iLoaderIndex)
+	--~ print("Anim2DAtlas_LoadAtlasPieceEx:ExportAnimFrameToImage =3D ",img,=
iWidth,iHeight,iCenterX,iCenterY,iFrames)
 	--~ if (not img) then print("Anim2DAtlas_Load : dead anim ",iModelID,iAni=
mID,iFrame,iHue) end
 	if (not img) then gAnimAtlasCache[n] =3D false return end
 		=

@@ -273,15 +275,17 @@
 =

 =

 =

-function Anim_GetIdleAnim (iModelID,bHasMount)
-	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return  5 end
-	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return 10 end
+function Anim_GetIdleAnim (iModelID,iLoaderIndex,bHasMount)
+	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
+	if (iModelID < high			) then return  5 end
+	if (iModelID < high + low	) then return 10 end
 	return bHasMount and 125 or 20  -- Human
 	--~ return 20 -- Human
 end
-function Anim_GetCorpseAnim (iModelID)
-	if (iModelID < kAnimIDRangeLen_HighDetailed									) then return bForwar=
d and 15 or 10 end
-	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
	) then return 40 end -- 60?
+function Anim_GetCorpseAnim (iModelID,iLoaderIndex)
+	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
+	if (iModelID < high			) then return bForward and 15 or 10 end
+	if (iModelID < high + low	) then return 40 end -- 60?
 	return bForward and 110 or 105 -- human
 end
 =

@@ -296,13 +300,16 @@
 	return 175
 end
 =

+
 -- iID is probably bodyid, and animid the animation ? ported from varans c=
ode
-function Anim_GetRealID (iModelID,iAnimID)
-	if (iModelID < kAnimIDRangeLen_HighDetailed) then return iAnimID + iModel=
ID*110 end
-	if (iModelID < kAnimIDRangeLen_HighDetailed + kAnimIDRangeLen_LowDetailed=
) then
-		return iAnimID + kAnimIDRangeLen_HighDetailed*110 + (iModelID-kAnimIDRan=
geLen_HighDetailed)*65
-	end
-	return iAnimID + kAnimIDRangeLen_HighDetailed*110 + kAnimIDRangeLen_LowDe=
tailed*65 + (iModelID-kAnimIDRangeLen_HighDetailed-kAnimIDRangeLen_LowDetai=
led)*175
+gUOAnimRealIDCatBoundsByLoaderIndex =3D { [1]=3D{200,200}, [2]=3D{200,200}=
, [3]=3D{700,700}, [4]=3D{200,200}, [5]=3D{200,200}}
+function Anim_GetRealID (iModelID,iAnimID,iLoaderIndex)
+	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
+	if (iModelID < high) then return iAnimID + iModelID*110 end
+	if (iModelID < high + low) then
+		return iAnimID + high*110 + (iModelID-high)*65
+	end
+	return iAnimID + high*110 + low*65 + (iModelID-high-low)*175
 end
 =

 gGetAnimDataInfoCache =3D {}
@@ -337,26 +344,36 @@
 -- returns iNewModelID,iNewHue,iLoaderIndex
 function UOAnimTranslateBodyID (iOrigModelID,iOrigHue)
 	local iModelID,iHue,iLoaderIndex =3D iOrigModelID,iOrigHue,1
+	local bodyConfDef =3D gBodyConfDef[iModelID] -- gBodyConfDef[bodyid] =3D =
{anim2,anim3,anim4,anim5}
+	if (bodyConfDef) then
+		for k =3D 4,1,-1 do if (bodyConfDef[k] > 0) then return bodyConfDef[k],i=
Hue,k+1 end end
+	end
 	local bodyDef =3D gBodyDef[iModelID] -- gBodyDef[bodyid] =3D {newbodylist=
,newhue}
 	if (bodyDef) then =

 		local newbodylist,newhue =3D unpack(bodyDef)
 		-- todo : not only first entry in newbodylist ?
 		iModelID,iHue =3D newbodylist[1],newhue -- newbodylist[iLoaderIndex] ?
 	end
-	local bodyConfDef =3D gBodyConfDef[iModelID] -- gBodyConfDef[bodyid] =3D =
{anim2,anim3,anim4,anim5}
-	if (bodyConfDef) then
-		for k =3D 4,1,-1 do if (bodyConfDef[k] > 0) then iModelID,iHue,iLoaderIn=
dex =3D bodyConfDef[k],iHue,k+1 end end
-	end
 	return iModelID,iHue,iLoaderIndex
 end
 =

 function UOAnimCheckBitMask (iModelID,iAnimID,iFrame,iLoaderIndex,px,py)
-	local iRealID =3D Anim_GetRealID(iModelID,iAnimID) =

+	local iRealID =3D Anim_GetRealID(iModelID,iAnimID,iLoaderIndex) =

 	local bitmask =3D GetAnimFrameBitMask(iRealID,iFrame,iLoaderIndex)
 	if (not bitmask) then return true end -- no bitmask -> always hit
 	return bitmask:TestBit(floor(px),floor(py))
 end
 =

+function UOAnimTest ()
+	local iTranslatedModelID =3D 309 -- PatchWorkSkeleton
+	local iAnimID =3D 13
+	local iFrame =3D 0
+	local iHue =3D 0
+	local iLoaderIndex =3D 3
+	local pAtlasPiece =3D Anim2DAtlas_LoadAtlasPiece(iTranslatedModelID,iAnim=
ID,iFrame,iHue,iLoaderIndex)
+	print("UOAnimTestPatchWorkSkeleton",pAtlasPiece)
+	os.exit(0)
+end
 =

 --[[
 =

@@ -407,7 +424,7 @@
 			local iAnimID =3D 2
 			local iFrame =3D 0
 			local iHue =3D 0
-			local iRealID =3D Anim_GetRealID(iModelID,iAnimID)
+			local iRealID =3D Anim_GetRealID(iModelID,iAnimID,iLoaderIndex)
 			local img,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D ExportAnimFrameT=
oImage(iRealID,iFrame,iHue)
 			if (img) then
 				print("exportanim",iModelID)



From no-reply at zwischenwelt.org  Sun Oct 12 20:39:28 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 18:39:28 -0000
Subject: [Iris-commit] [IRIS] r2559 - /trunk/lua/lib.spellbooks.lua
Message-ID: <20081012183932.3FF591C18305@zwischenwelt.org>

Author: sience
Date: Sun Oct 12 20:39:12 2008
New Revision: 2559

Log:
-fix that causes a crash (fc was nil using a protection spell)

Modified:
    trunk/lua/lib.spellbooks.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Oct 12 20:39:12 2008
@@ -391,7 +391,7 @@
 function GetSpellCastTime (spellid,fc,bBuffActive_Protection,bBuffActive_E=
ssenceOfWind)
 	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
 	--~ TODO : if( EssenceOfWindSpell.IsDebuffed( m_Caster ) ) fc -=3D Essenc=
eOfWindSpell.GetFCMalus( m_Caster );
-	fc =3D min(fc,2)
+	fc =3D min(fc or 0,2)
 	if (bBuffActive_Protection) then fc =3D fc - 2 end
 	local castDelayBase			=3D GetSpell_CastDelayBase(spellid)
 	local castDelayFastScalar	=3D GetSpell_CastDelayFastScalar(spellid)



From no-reply at zwischenwelt.org  Sun Oct 12 20:46:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 18:46:11 -0000
Subject: [Iris-commit] [IRIS] r2560 - in /trunk: lua/lib.spellbooks.lua
	plugins/lib.spellbar.lua
Message-ID: <20081012184611.943ED1C187C4@zwischenwelt.org>

Author: sience
Date: Sun Oct 12 20:46:11 2008
New Revision: 2560

Log:
-better fix for the fix committed before

Modified:
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Oct 12 20:46:11 2008
@@ -391,7 +391,7 @@
 function GetSpellCastTime (spellid,fc,bBuffActive_Protection,bBuffActive_E=
ssenceOfWind)
 	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
 	--~ TODO : if( EssenceOfWindSpell.IsDebuffed( m_Caster ) ) fc -=3D Essenc=
eOfWindSpell.GetFCMalus( m_Caster );
-	fc =3D min(fc or 0,2)
+	fc =3D min(fc,2)
 	if (bBuffActive_Protection) then fc =3D fc - 2 end
 	local castDelayBase			=3D GetSpell_CastDelayBase(spellid)
 	local castDelayFastScalar	=3D GetSpell_CastDelayFastScalar(spellid)

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 20:46:11 2008
@@ -19,8 +19,8 @@
 			local tooltip =3D AosToolTip_GetText(item.serial)
 			if (tooltip) then =

 				local props =3D ParseProps(tooltip)
-				if (props.fcr) then propsum.fcr =3D (propsum.fcr or 0) + props.fcr end
-				if (props.fc) then propsum.fc =3D (propsum.fc or 0) + props.fc end
+				if (props.fcr) then propsum.fcr =3D (propsum.fcr or 0) + props.fcr els=
e propsum.fcr =3D 0 end
+				if (props.fc) then propsum.fc =3D (propsum.fc or 0) + props.fc else pr=
opsum.fc =3D 0 end
 				--~ print("+",tooltip and string.len(tooltip),gLayerTypeName[layer],to=
oltip) =

 			end
 		end



From no-reply at zwischenwelt.org  Sun Oct 12 23:34:43 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 21:34:43 -0000
Subject: [Iris-commit] [IRIS] r2562 - in /trunk: lua/lib.spellbooks.lua
	plugins/lib.spellbar.lua
Message-ID: <20081012220009.1403A1C187D0@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 23:34:43 2008
New Revision: 2562

Log:
fixed fast-cast fix from sience... ( the 'else propsum.fc =3D 0'  would era=
se the sum if an item without fastcast bonus is parsed )

Modified:
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Sun Oct 12 23:34:43 2008
@@ -391,7 +391,7 @@
 function GetSpellCastTime (spellid,fc,bBuffActive_Protection,bBuffActive_E=
ssenceOfWind)
 	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
 	--~ TODO : if( EssenceOfWindSpell.IsDebuffed( m_Caster ) ) fc -=3D Essenc=
eOfWindSpell.GetFCMalus( m_Caster );
-	fc =3D min(fc,2)
+	fc =3D min(fc or 0,2)
 	if (bBuffActive_Protection) then fc =3D fc - 2 end
 	local castDelayBase			=3D GetSpell_CastDelayBase(spellid)
 	local castDelayFastScalar	=3D GetSpell_CastDelayFastScalar(spellid)

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 23:34:43 2008
@@ -19,8 +19,8 @@
 			local tooltip =3D AosToolTip_GetText(item.serial)
 			if (tooltip) then =

 				local props =3D ParseProps(tooltip)
-				if (props.fcr) then propsum.fcr =3D (propsum.fcr or 0) + props.fcr els=
e propsum.fcr =3D 0 end
-				if (props.fc) then propsum.fc =3D (propsum.fc or 0) + props.fc else pr=
opsum.fc =3D 0 end
+				if (props.fcr) then propsum.fcr =3D (propsum.fcr or 0) + props.fcr end
+				if (props.fc) then propsum.fc =3D (propsum.fc or 0) + props.fc end
 				--~ print("+",tooltip and string.len(tooltip),gLayerTypeName[layer],to=
oltip) =

 			end
 		end



From no-reply at zwischenwelt.org  Sun Oct 12 23:31:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 12 Oct 2008 21:31:14 -0000
Subject: [Iris-commit] [IRIS] r2561 - in /trunk: data/mymacros.lua.dist
 lua/lib.map.lua lua/lib.walking3.lua lua/net.walk.lua lua/net/net.other.lua
 plugins/lib.spellbar.lua
Message-ID: <20081012220008.C9BA31C18780@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 12 23:31:13 2008
New Revision: 2561

Log:
mymacro default : show quit dialog instead of instant quit on alt-x, felucc=
a : move through mobiles prevented on clientside (original client also does=
n't send network message) if stamina not full, chattext+spelltext rise abov=
e heads

Modified:
    trunk/data/mymacros.lua.dist
    trunk/lua/lib.map.lua
    trunk/lua/lib.walking3.lua
    trunk/lua/net.walk.lua
    trunk/lua/net/net.other.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/data/mymacros.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/mymacros.lua.dist (original)
+++ trunk/data/mymacros.lua.dist Sun Oct 12 23:31:13 2008
@@ -21,7 +21,7 @@
 SetMacro("alt+k",	function() MacroCmd_Open("Skill") end)	-- Open Skills
 SetMacro("alt+j",	function() MacroCmd_Open("Journal") end)	-- Open Journal
 SetMacro("alt+i",	function() MacroCmd_Open("Backpack") end)	-- Open Backpa=
ck
-SetMacro("alt+x",	function() MacroCmd_Quit() end)	-- Quit game
+SetMacro("alt+x",	function() OpenQuit() end)	-- Quit game
 SetMacro("alt+b",	function() MacroCmd_Say("*bow*") end)	-- Bow
 SetMacro("alt+s",	function() MacroCmd_Say("*salute*") end)	-- Salute
 =


Modified: trunk/lua/lib.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.map.lua (original)
+++ trunk/lua/lib.map.lua Sun Oct 12 23:31:13 2008
@@ -32,6 +32,7 @@
 function GetStaticsAtAbsPos (xloc,yloc) return MapGetStatics(xloc,yloc) end
 =

 =

+function MapGetMapIndex		()	return gMapIndex end
 function MapGetWInBlocks	()	return gGroundBlockLoader:GetMapW() end
 function MapGetHInBlocks	()	return gGroundBlockLoader:GetMapH() end
 function MapGetWInTiles		()	return gGroundBlockLoader:GetMapW() * 8 end

Modified: trunk/lua/lib.walking3.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.walking3.lua (original)
+++ trunk/lua/lib.walking3.lua Sun Oct 12 23:31:13 2008
@@ -5,6 +5,7 @@
 =

 kImpassableSurface =3D kTileDataFlag_Impassable + kTileDataFlag_Surface
 =

+gMapsWithMobileMovementBlocking =3D { [0]=3Dtrue } -- on felucca, you need=
 full stamina to shove through other mobiles
 =

 kPersonHeight				=3D 16
 kStepHeight					=3D 2
@@ -20,6 +21,10 @@
 	local bIsAlive =3D true
 	if (playermobile and playermobile.bIsGhost) then bIsAlive =3D false end
 	local mobile =3D {zloc=3DiStartZ,CanSwim=3Dfalse,CantWalk=3Dfalse,Alive=
=3DbIsAlive,Body=3D{BodyID=3Dplayerbodyid},IsDeadBondedPet=3Dfalse}
+	mobile.mapindex			=3D MapGetMapIndex() -- TODO, needed for mobile blockin=
g on felu ? wraith form etc ?
+	mobile.bHasFullStamina	=3D true
+	if (playermobile and playermobile.stats and (playermobile.stats.curStamin=
a or 0) < (playermobile.stats.maxStamina or 0)) then mobile.bHasFullStamina=
 =3D false end
+	=

 	local posx,posy,posz,d =3D xloc,yloc,iStartZ,iDir
 	=

 	local bMoveIsOk,newZ =3D W3_CheckMovement( mobile, posx,posy,posz, d)
@@ -148,6 +153,14 @@
 	return z,avg,top
 end
 =

+function W3_CheckMobileOnPosition (xloc,yloc,zloc)
+	for k,mobile in pairs(GetMobileList()) do
+		if (mobile.xloc =3D=3D xloc and mobile.yloc =3D=3D yloc and mobile.zloc =
>=3D zloc-15 and mobile.zloc <=3D zloc+15) then return true end
+	end
+end =

+function W3_MobileBlockCheckNeeded (mobile) =

+	return mobile.Alive and gMapsWithMobileMovementBlocking[mobile.mapindex] =
and (not mobile.bHasFullStamina)
+end
 =

 --- bMoveIsOk,newZ =3D CheckMovement( Mobile mobile, Point3D loc, Directio=
n d, out int newZ )
 -- see also RunUO1.0/Scripts/Engines/Pathing/Movement.cs : CheckMovement a=
nd Check  and  RunUO1.0/src/Mobile.cs
@@ -163,9 +176,11 @@
 =

 	if ( xForward < 0 or yForward < 0 or xForward >=3D MapGetWInTiles() or yF=
orward >=3D MapGetHInTiles() ) then return false,newZ end
 	=

+	if (W3_MobileBlockCheckNeeded(mobile) and W3_CheckMobileOnPosition(xForwa=
rd,yForward,mobile.zloc)) then return false,newZ end
+	=

 	local checkDiagonals =3D DirIsDiagonal(d)
 =

-	local ignoreMovableImpassables =3D kIgnoreMovableImpassables -- bool
+	local ignoreMovableImpassables =3D kIgnoreMovableImpassables or (not mobi=
le.Alive)  -- bool
 	local reqFlags =3D kImpassableSurface -- TileFlag
 =

 	if ( mobile.CanSwim ) then reqFlags =3D BitwiseOR(reqFlags,kTileDataFlag_=
Wet) end

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Sun Oct 12 23:31:13 2008
@@ -220,7 +220,7 @@
 end
 =

 -- internal, don't call directly
-function SendWalkRequest (iFullDir,iSeqNum,iFastKey) =

+function SendWalkRequest (iFullDir,iSeqNum,iFastKey)  -- 0x02
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Request_Movement)
 	out:PushNetUint8(iFullDir)
@@ -232,7 +232,7 @@
 =

 -- Accept Movement Request and or Resync
 -- TODO : change player notoriety <- check if this is needed
-function gPacketHandler.kPacket_Accept_Movement_Resync_Request()
+function gPacketHandler.kPacket_Accept_Movement_Resync_Request() -- 0x22
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local iSeqNum =3D input:PopNetUint8()

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sun Oct 12 23:31:13 2008
@@ -247,6 +247,7 @@
 	-- States LockInfo	-- bonded status
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_ExtendedStats) then -- 0x19
 		local party_cmd =3D input:PopNetUint8()
+		print("kPacket_Generic_SubCommand_ExtendedStats",party_cmd)
 		if (party_cmd =3D=3D hex2num("0x00")) then
 			local party_serial =3D input:PopNetUint32()
 			local party_value  =3D input:PopNetUint8()
@@ -720,6 +721,8 @@
 	end
 	=

 	NotifyListener("Hook_Text",unitext_name,unitext_message)
+	=

+	NotifyListener("Hook_Packet_Text_Unicode",mobile_serial,unitext_message)
 =

 	-- check if player -> then show text over player head
 	local mobilespeaker=3DGetMobile(mobile_serial)

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 12 23:31:13 2008
@@ -134,10 +134,16 @@
 kSpellBar_Msg_NoMana			=3D 502625 	-- Insufficient mana for this spell.
 kSpellBar_Msg_TooManyFollowers	=3D 1049645	-- You have too many followers =
to summon that creature.       =

 =

-RegisterListener("Hook_Packet_Text",			function (serial,plaintext) =

-	--~ print("Hook_Packet_Text",serial,plaintext) =

-end)
-
+RegisterListener("Hook_Packet_Text_Unicode",	function (serial,plaintext)  =
-- kPacket_Text_Unicode
+	local r,g,b =3D 1,1,0 -- yellow
+	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
+end)
+RegisterListener("Hook_Packet_Text",			function (serial,plaintext)  -- kPa=
cket_Text
+	local r,g,b =3D 1,1,0 -- yellow
+	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
+end)
+
+	--~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_T=
ext_Unicode
 RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum) =

 	local r,g,b =3D 1,0,0 -- red
 	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),r,g,b,"already casting"		) end



From no-reply at zwischenwelt.org  Mon Oct 13 03:05:33 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 13 Oct 2008 01:05:33 -0000
Subject: [Iris-commit] [IRIS] r2563 - in /trunk/lua: filter/filter.art.lua
	lib.2d.spriteblock.lua
Message-ID: <20081013010534.1ECFD1C187C4@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 13 03:05:33 2008
New Revision: 2563

Log:
seasons : skip foliage : only for statics (2d works, 3d would require some =
more adjustments)

Modified:
    trunk/lua/filter/filter.art.lua
    trunk/lua/lib.2d.spriteblock.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Mon Oct 13 03:05:33 2008
@@ -374,9 +374,10 @@
 ----------------------------------------------------------------------
 =

 -- Seasonal Dynamic & Static Art Translation (run tiles)	-- eventuell (iTi=
leTypeID + 0x4000)
-function SeasonalStaticTranslation (iTileTypeID, iSeasonID)
+function SeasonalStaticTranslation (iTileTypeID, iSeasonID, bUseFoliageSki=
p)
 	local translator =3D gSeasonStaticTranslators[iSeasonID]
-	if (iSeasonID =3D=3D 4 and TestBit(GetStaticTileTypeFlags(iTileTypeID) or=
 0,kTileDataFlag_Foliage)) then return -1 end
+	-- foliage : zb. item 0x3e57 und folgende haben foliage an, wobei das abe=
r ein schiffsmast ist und die anderen teile sind auch schiffsteile. (foliag=
e skip nur bei statics?) =

+	if (bUseFoliageSkip and iSeasonID =3D=3D 4 and TestBit(GetStaticTileTypeF=
lags(iTileTypeID) or 0,kTileDataFlag_Foliage)) then return -1 end
 	if (translator) then
 		return translator[iTileTypeID] or iTileTypeID
 	else

Modified: trunk/lua/lib.2d.spriteblock.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.spriteblock.lua (original)
+++ trunk/lua/lib.2d.spriteblock.lua Mon Oct 13 03:05:33 2008
@@ -121,7 +121,7 @@
 =

 -- static comes from MapGetBlockStatics(bx,by) : {zloc=3D?,artid=3D?,hue=
=3D?,xloc=3D?,yloc=3D?,tx=3D?,ty=3D?,bx=3D?,by=3D?,bIsStatic=3Dtrue}
 function cUOSpriteBlock:AddStatic (static)
-	local artid =3D SeasonalStaticTranslation(static.artid, gSeasonSetting)
+	local artid =3D SeasonalStaticTranslation(static.artid, gSeasonSetting,tr=
ue) -- bUseFoliageSkip
 	local tx =3D static.tx
 	local ty =3D static.ty
 	local zloc =3D static.zloc



From no-reply at zwischenwelt.org  Mon Oct 13 17:37:00 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 13 Oct 2008 15:37:00 -0000
Subject: [Iris-commit] [IRIS] r2564 - in /trunk: data/config.lua.dist
	lua/lib.2d.renderer.lua
Message-ID: <20081013153700.439ED1C18667@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 13 17:36:59 2008
New Revision: 2564

Log:
2d : always run as option, default off

Modified:
    trunk/data/config.lua.dist
    trunk/lua/lib.2d.renderer.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Mon Oct 13 17:36:59 2008
@@ -491,3 +491,4 @@
 =

 -- gDisabledPlugins.hudenemylist =3D true
 =

+gAlwaysRun =3D false

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Mon Oct 13 17:36:59 2008
@@ -96,7 +96,7 @@
 	if (not bOfflineMode) then
 		if (gKeyPressed[key_mouse_right] and (not gLastMouseDownWidget)) then =

 			local bRunFlag =3D pixeldist > 200
-			bRunFlag =3D true
+			if (gAlwaysRun) then bRunFlag =3D true end
 			--~ print("Get2DMouseDirAndDist",uodir,pixeldist)
 			WalkStep_WalkInDir(uodir,bRunFlag,true)
 		end



From no-reply at zwischenwelt.org  Mon Oct 13 23:32:15 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 13 Oct 2008 21:32:15 -0000
Subject: [Iris-commit] [IRIS] r2565 - /trunk/lua/main.lua
Message-ID: <20081013213215.67CD11C18667@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 13 23:32:14 2008
New Revision: 2565

Log:
Hook_Terminate at the end of mainloop for graceful terminate (quit-gump or =
close window, not triggered on crash!)

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Oct 13 23:32:14 2008
@@ -368,6 +368,7 @@
 	while (Client_IsAlive()) do =

 		MainStep() =

 	end
+	NotifyListener("Hook_Terminate")
 end
 =

 =




From no-reply at zwischenwelt.org  Tue Oct 14 01:05:47 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 13 Oct 2008 23:05:47 -0000
Subject: [Iris-commit] [IRIS] r2566 - in /trunk/lua: lib.2d.map.lua
	lib.mapblock.2d.terrain.lua
Message-ID: <20081013230548.07B3F1C18667@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 14 01:05:46 2008
New Revision: 2566

Log:
2d : terrain blendout

Modified:
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.mapblock.2d.terrain.lua

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Tue Oct 14 01:05:46 2008
@@ -73,7 +73,7 @@
 		=

 		if (self.gbBlendOutTerrainVisible ~=3D bTerrainVisible) then
 			self.gbBlendOutTerrainVisible =3D bTerrainVisible
-			--~ self.map2d_spawners.terrain:ForAllBlocks(function(block) block:Upda=
teBlendOutVisibility() end)
+			self.map2d_spawners.terrain:ForAllBlocks(function(block) block:UpdateBl=
endOutVisibility() end)
 		end
 		=

 		local a,b =3D self:BlendoutGetVisibleRange()

Modified: trunk/lua/lib.mapblock.2d.terrain.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.2d.terrain.lua (original)
+++ trunk/lua/lib.mapblock.2d.terrain.lua Tue Oct 14 01:05:46 2008
@@ -6,6 +6,10 @@
 =

 function cMapBlock_2D_Terrain:ClearDetail ()
 	if (self.gfx_terrain) then self.gfx_terrain:Destroy() self.gfx_terrain =
=3D nil end
+end
+
+function cMapBlock_2D_Terrain:UpdateBlendOutVisibility ()
+	if (self.gfx_terrain) then self.gfx_terrain:SetVisible(gCurrentRenderer.g=
bBlendOutTerrainVisible) end
 end
 =

 -- returns dist,xloc,yloc   if hit, or nil if not hit.    sprite=3D{artid=
=3D?,hue=3D?,static=3D?}
@@ -22,4 +26,5 @@
 	local bs =3D kMultiTexTerrainChunkSize
 	self:ClearDetail()
 	self.gfx_terrain =3D MakeMultiTexTerrainGfx(self.bx * bs,self.by * bs,kRe=
nderer2D_ZScale)
+	self:UpdateBlendOutVisibility()
 end



From no-reply at zwischenwelt.org  Tue Oct 14 13:16:31 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 11:16:31 -0000
Subject: [Iris-commit] [IRIS] r2567 - in /trunk: data/base/menu_bg.jpg
 lua/gui/gui.helper.lua lua/lib.desktop.lua lua/lib.mainmenu.lua
 lua/lib.mapblock.base.lua lua/lib.mapblock.scheduler.lua
 lua/lib.mapblock.spawner.lua
Message-ID: <20081014120012.CDC6E1C1832E@zwischenwelt.org>

Author: hagish
Date: Tue Oct 14 13:16:31 2008
New Revision: 2567

Log:
*bugfix: quick cast icons do not save their position
*new menu background (should we keep something like this?)
*mapblock spawner handles unfinished blocks and calls them if idle

Added:
    trunk/data/base/menu_bg.jpg   (with props)
Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.mapblock.base.lua
    trunk/lua/lib.mapblock.scheduler.lua
    trunk/lua/lib.mapblock.spawner.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Tue Oct 14 13:16:31 2008
@@ -12,11 +12,12 @@
 	local texname =3D "process-working.png"
 	local x,y =3D 50,50
 	local fps =3D 5
+	local frames =3D w / tilew * h / tileh
 	=

 	-- calculate frame number
 	local f =3D 0
 	if giShowLoading > 0 then
-		f =3D 1 + math.floor(gMyTicks / 1000 * fps)
+		f =3D 1 + math.mod(math.floor(gMyTicks / 1000 * fps), frames-1)
 	end
 	=

 	-- on demand create icon
@@ -39,7 +40,7 @@
 		gMemStats_NextUpdate =3D gMyTicks + 1000
 		local mem_dyn =3D gcinfo()
 		mem_dyn =3D mem_dyn or 0
-		local text =3D sprintf("%5.1ffps %0.1fmb %dt %db OGRE | %0.fmb LUA | %i =
jobs",OgreAvgFPS(),memoryusage / 1024 / 1024, OgreTriangleCount(), OgreBatc=
hCount(), mem_dyn / 1024, job.count())
+		local text =3D sprintf("%5.1ffps %0.1fmb %dt %db OGRE | %0.fmb LUA | %i =
j %i l",OgreAvgFPS(),memoryusage / 1024 / 1024, OgreTriangleCount(), OgreBa=
tchCount(), mem_dyn / 1024, job.count(), giShowLoading)
 		if (not gMemoryUsageField) then
 			local vw,vh =3D GetViewportSize()
 			local w,h =3D 0,12

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Oct 14 13:16:31 2008
@@ -53,7 +53,8 @@
 	open =3D function(x,y,param) CreateQuickCastButtonSpell(x,y,param) end, =

 	checkpos =3D function(e, widget) =

 		local d =3D widget.dialog
-		if d and d.spellid and d.spellid =3D=3D e.param then
+		local id =3D d and d.spellid or widget.spellid
+		if id =3D=3D e.param then
 			e.x,e.y =3D widget:GetPos() =

 			return true
 		end
@@ -76,7 +77,8 @@
 	open =3D function(x,y,param) CreateQuickCastButtonSkill(x,y,param) end, =

 	checkpos =3D function(e, widget) =

 		local d =3D widget.dialog
-		if d and d.skillid and d.skillid =3D=3D e.param then
+		local id =3D d and d.skillid or widget.skillid
+		if id =3D=3D e.param then
 			e.x,e.y =3D widget.gfx:GetPos() =

 			return true
 		end

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Tue Oct 14 13:16:31 2008
@@ -331,6 +331,19 @@
 end
 =

 function StartMainMenu ()
+	local vp =3D GetMainViewport()
+	local w =3D vp:GetActualWidth()
+	local h =3D vp:GetActualHeight()
+	local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPlainT=
extureGUIMat("menu_bg.jpg"), 1024, 768)
+	gMenuBgImage =3D GetDesktopWidget():CreateChild("Image",{gfxparam_init=3D=
gfxparam_init})
+	gMenuBgImage:SetPos(0,0)
+	gMenuBgImage:SetSize(w,h)
+	RegisterListener("Hook_StartInGame"	,function () =

+		DestroyIfAlive(gMenuBgImage)
+		gMenuBgImage =3D nil
+	end)
+	gDialog_IrisLogo:SetVisible(false)
+
 	if (gTestNoMainMenu) then return end
 	if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end -- =
journaltest
 	if (gCommandLineSwitches["-jt"]) then ToggleJournal() return end -- journ=
altest

Modified: trunk/lua/lib.mapblock.base.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.base.lua (original)
+++ trunk/lua/lib.mapblock.base.lua Tue Oct 14 13:16:31 2008
@@ -1,4 +1,6 @@
 -- ***** ***** ***** ***** ***** block baseclass
+-- NOTE: block loading thread should check ShouldBlockTerminate after each=
 yield
+-- to interrupt the current loading process
 =

 cMapBlock =3D CreateClass()
 cMapBlock.kLOD_Detail			=3D nil -- set to something with .prio =3D value
@@ -54,14 +56,26 @@
 	end
 end
 =

+-- internal function for the stepper to stop during building process
+function cMapBlock:ShouldBlockTerminate ()
+	return self.bWorkTerminated
+end
+
+-- the sheduler/spawner use this to check if the block is dead
+-- this is used to keep destroyed but unfinished blocks alive until they
+-- are dead
+function cMapBlock:IsDead ()
+	return (coroutine.status(self.co) =3D=3D "dead")
+end
+
 -- executes coroutine until it terminates, cannot be restarted
+-- if the coroutine is still running the sheduler will resume is later to =
finish the work
+-- but the normal case should be that the thread checks with ShouldBlockTe=
rminate()
+-- and stopps
 function cMapBlock:TerminateWork() =

 	self.bWorkTerminated =3D true
-	for i =3D 1,5 do
-		self:Resume()
-		if (not coroutine.running(self.co)) then return end
-	end
-	print("cMapBlock:TerminateWork warning: work timeout",debug.traceback())
+	self:Resume()
+	self:SetPriority(kSchedulerUnfinishedPriority)
 end
 =

 function cMapBlock:Destroy () self:TerminateWork() self:Clear() end

Modified: trunk/lua/lib.mapblock.scheduler.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.scheduler.lua (original)
+++ trunk/lua/lib.mapblock.scheduler.lua Tue Oct 14 13:16:31 2008
@@ -1,7 +1,8 @@
 -- ***** ***** ***** ***** ***** scheduler
 =

 cScheduler =3D CreateClass()
-kSchedulerIdlePriority =3D 9999
+kSchedulerUnfinishedPriority =3D 9999
+kSchedulerIdlePriority =3D 10000
 =

 function CreateScheduler	() local o =3D CreateClassInstance(cScheduler) re=
turn o end
 =

@@ -30,8 +31,8 @@
 		--~ print("procs",table.getn(self.pProcessList))
 	--~ end
 =

-	local t =3D gMyTicks
-	local t_end =3D t + self.kAllowedTicksPerFrame
+	local t =3D Client_GetTicks()
+	local t_end =3D gMyTicks + self.kAllowedTicksPerFrame
 	=

 	-- shortsteps, re-evaluate prio, release gfx
 	for k,process in ipairs(self.pProcessList) do process:ShortStep(t,x,y,z) =
end =


Modified: trunk/lua/lib.mapblock.spawner.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.spawner.lua (original)
+++ trunk/lua/lib.mapblock.spawner.lua Tue Oct 14 13:16:31 2008
@@ -11,6 +11,7 @@
 	self.iLoadRadius	=3D pBlockClass.iLoadRadius
 	self.pBlockClass	=3D pBlockClass
 	self.pScheduler		=3D pScheduler
+	self.mlUnfinishedBlock =3D {}
 end
 =

 -- calls fun(block) for all blocks
@@ -48,6 +49,15 @@
 		end
 		end
 	end
+	=

+	-- check unfinished jobs and remove them if finished
+	for k,v in pairs(self.mlUnfinishedBlock) do
+		if k:IsDead() then
+			--~ print("REMOVE UNFINISHED JOB")
+			self.pScheduler:RemoveProcess(k)
+			self.mlUnfinishedBlock[k] =3D nil
+		end
+	end
 end
 =

 -- creates new block if needed
@@ -72,7 +82,13 @@
 function cMapBlockSpawner:DestroyMapBlock	(block)
 	block:Destroy()
 	self.pMapBlocks[block] =3D nil
-	self.pScheduler:RemoveProcess(block)
+	=

+	if block:IsDead() then
+		self.pScheduler:RemoveProcess(block)
+	else
+		self.mlUnfinishedBlock[block] =3D true
+		--~ print("UNFINISHED JOB")
+	end
 end
 =

 -- destroy all blocks



From no-reply at zwischenwelt.org  Tue Oct 14 13:59:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 11:59:35 -0000
Subject: [Iris-commit] [IRIS] r2568 - /trunk/lua/gui/gui.chat.lua
Message-ID: <20081014120013.4F3B81C18780@zwischenwelt.org>

Author: hagish
Date: Tue Oct 14 13:59:32 2008
New Revision: 2568

Log:
bugfix: tabs to small in chat tabpane

Modified:
    trunk/lua/gui/gui.chat.lua

Modified: trunk/lua/gui/gui.chat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.chat.lua (original)
+++ trunk/lua/gui/gui.chat.lua Tue Oct 14 13:59:32 2008
@@ -4,8 +4,9 @@
 gGuiChatTabpanePosX =3D 30
 gGuiChatTabpanePosY =3D -250
 =

-gGuiChatTabpaneWidth =3D 600
-gGuiChatTabpaneHeight =3D 200
+-- if tabpane size is smaller than 1 its a percentage of the viewport size
+gGuiChatTabpaneWidth =3D 0.9
+gGuiChatTabpaneHeight =3D 0.28
 =

 gGuiChatIcon =3D nil
 gGuiChatTabpane =3D nil
@@ -18,6 +19,8 @@
 	default =3D ".+",
 	public =3D "<Public>",
 	newbies =3D "<Newbies>",
+	pvp =3D "<PvP>",
+	system =3D "System:",
 }
 =

 gGuiChatChannelContent =3D {}
@@ -77,7 +80,7 @@
 				{text=3Dchannel,textparam=3D{r=3D0,g=3D0,b=3D0},font=3DgGuiChatFont})
 			gGuiChatTabpane:GetTabContentPane(channel):CreateChild("Text",
 				{text=3D"<empty>",textparam=3D{r=3D0,g=3D0,b=3D0},font=3DgGuiChatFont})
-		=

+			print("TAB SIZE CONTENT",gGuiChatTabpane:GetTabContentTab(channel):GetS=
ize())
 			gGuiChatTabpane:UpdateAll()
 		end
 	end
@@ -129,6 +132,14 @@
 	if y < 0 then y =3D vph + y end
 =

 	gGuiChatTabpane =3D GetDesktopWidget():CreateChild("Tabpane",params)
+	=

+	local vp =3D GetMainViewport()
+	local vw =3D vp:GetActualWidth()
+	local vh =3D vp:GetActualHeight()
+	=

+	if gGuiChatTabpaneWidth <=3D 1 then gGuiChatTabpaneWidth =3D vw * gGuiCha=
tTabpaneWidth end
+	if gGuiChatTabpaneHeight <=3D 1 then gGuiChatTabpaneHeight =3D vh * gGuiC=
hatTabpaneHeight end
+	=

 	gGuiChatTabpane:SetSize(gGuiChatTabpaneWidth,gGuiChatTabpaneHeight)
 	gGuiChatTabpane:SetLeftTop(x,y)
 	=




From no-reply at zwischenwelt.org  Tue Oct 14 20:16:52 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 18:16:52 -0000
Subject: [Iris-commit] [IRIS] r2569 - /trunk/lua/net/net.other.lua
Message-ID: <20081014181652.696161C1865A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 14 20:16:51 2008
New Revision: 2569

Log:
added iris-info request and answer packet, for iris-aware servers

Modified:
    trunk/lua/net/net.other.lua

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Tue Oct 14 20:16:51 2008
@@ -36,6 +36,7 @@
 gGenericSubCommands.kPacket_Generic_SubCommand_EnableSESpellIcons	=3D 0x25
 gGenericSubCommands.kPacket_Generic_SubCommand_SpeedMode			=3D 0x26
 gGenericSubCommands.kPacket_Generic_SubCommand_NewRaceGender		=3D 0x2A
+gGenericSubCommands.kPacket_Generic_SubCommand_IrisInfo				=3D 0xA0 -- iri=
s-special, for iris aware servers
 --[[
 -race_gender-packet
 Client -> Server =

@@ -145,7 +146,7 @@
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local subcmd =3D input:PopNetUint16()
-	printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D%s\n=
",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
+	--~ printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D=
%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
 	printdebug("net",sprintf("NET: kPacket_Generic_Command size=3D0x%04x subc=
md=3D0x%04x=3D%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd=
])))
 =

 	-- FastWalkInit : 6 keys (runuo's fifosize 0-255)
@@ -247,7 +248,7 @@
 	-- States LockInfo	-- bonded status
 	if (subcmd =3D=3D kPacket_Generic_SubCommand_ExtendedStats) then -- 0x19
 		local party_cmd =3D input:PopNetUint8()
-		print("kPacket_Generic_SubCommand_ExtendedStats",party_cmd)
+		--~ print("kPacket_Generic_SubCommand_ExtendedStats",party_cmd)
 		if (party_cmd =3D=3D hex2num("0x00")) then
 			local party_serial =3D input:PopNetUint32()
 			local party_value  =3D input:PopNetUint8()
@@ -320,11 +321,11 @@
 		printf("ABILITY\tSE Spell Icons abilityID: 0x%02x active: 0x%02x\n", abi=
lityID, active)
 	end
 =

-	-- Subcommand 0x21: (AOS) Ability icon confirm.
+	-- Subcommand 0x21: (AOS) weapon-Ability icon confirm/end.  see also Send=
_AOSCommand_WeaponAbility
 	-- Note: no data, just (bf 00 05 21) =

 	if (subcmd =3D=3D kPacket_Generic_SubCommand_Ability_Icon) then	-- 0x21
+		EndWeaponAbility()
 		NotifyListener("Hook_Deactivate_Ability")
-		print("ABILITY","kPacket_Generic_SubCommand_Ability_Icon")
 	end
 =

 	-- Receives a CustomHouse Serial & Revision Hash Number
@@ -379,6 +380,11 @@
 		local player_race =3D input:PopNetUint8()
 --		printf("NET: Gender: %s Race: %s\n", gGender[player_gender], gRace[pla=
yer_race])
 	end
+	=

+	-- iris info request, only sent by iris aware servers
+	if (subcmd =3D=3D kPacket_Generic_SubCommand_IrisInfo) then
+		Send_IrisInfo()
+	end
 =

 	-- check if all data was used
 	local used =3D input:GetTotalPopped() - popped_start
@@ -392,6 +398,17 @@
 		printf("WARNING ! kPacket_Generic_Command : subcmd 0x%02x (used=3D%d siz=
e=3D%d) popped to few\n",subcmd,used,size)
 		input:PopRaw(rest)
 	end
+end
+
+
+-- sends iris specific infos to the server, in response to kPacket_Generic=
_SubCommand_IrisInfo
+function Send_IrisInfo()
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Generic_Command)
+	out:PushNetUint16(0x06)
+	out:PushNetUint16(kPacket_Generic_SubCommand_IrisInfo) -- 0x00A0
+	out:PushNetUint8(0x01)
+	out:SendPacket()
 end
 =

 -- Tracking Arrow



From no-reply at zwischenwelt.org  Tue Oct 14 20:45:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 18:45:06 -0000
Subject: [Iris-commit] [IRIS] r2570 - in /trunk: lua/ lua/gui/ lua/net/
 lua/obj/ lua/widgets/ plugins/
Message-ID: <20081014184506.9284D1C1865A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 14 20:45:06 2008
New Revision: 2570

Log:
spellbar : mana cost display, redesigned weaponability code a bit (fixed co=
loring, toggle etc, and weapon abilities for wrestl and shield-issue), disa=
bled a bunch of debug output

Modified:
    trunk/lua/gui/gui.chat.lua
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/gui/gui.skill.lua
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.diff.lua
    trunk/lua/lib.terrain.multitex.lua
    trunk/lua/net/net.aoscommand.lua
    trunk/lua/net/net.world.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/widgets/widget.widget.uoquickcasticon.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/gui/gui.chat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.chat.lua (original)
+++ trunk/lua/gui/gui.chat.lua Tue Oct 14 20:45:06 2008
@@ -80,7 +80,7 @@
 				{text=3Dchannel,textparam=3D{r=3D0,g=3D0,b=3D0},font=3DgGuiChatFont})
 			gGuiChatTabpane:GetTabContentPane(channel):CreateChild("Text",
 				{text=3D"<empty>",textparam=3D{r=3D0,g=3D0,b=3D0},font=3DgGuiChatFont})
-			print("TAB SIZE CONTENT",gGuiChatTabpane:GetTabContentTab(channel):GetS=
ize())
+			--~ print("TAB SIZE CONTENT",gGuiChatTabpane:GetTabContentTab(channel):=
GetSize())
 			gGuiChatTabpane:UpdateAll()
 		end
 	end

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Tue Oct 14 20:45:06 2008
@@ -180,7 +180,6 @@
 =

 -- close already existing dialog with the same id
 function GumpParser_CloseOldDialog	(dialogId,playerid,bClientSideMode)
-	print("TODO:GumpParser_CloseOldDialog")
 	if ((not bClientSideMode) and gServerSideGump[dialogId]) then
 		CloseServerSideGump(playerid, dialogId, 0, bClientSideMode)
 	end

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Tue Oct 14 20:45:06 2008
@@ -91,10 +91,10 @@
  				-- get artid of current equipped weapon
  				local playermobile =3D GetPlayerMobile()
  				local item1 =3D GetMobileEquipmentItem(playermobile,gLayerType.kLayer=
_OneHanded)
- 				local item2 =3D GetMobileEquipmentItem(playermobile,gLayerType.kLayer=
_TwoHanded)
+ 				local item2 =3D GetMobileEquipmentItem(playermobile,gLayerType.kLayer=
_TwoHanded) -- might be shield,lantern...
  				local artid =3D (item1 and item1.artid) or (item2 and item2.artid)
  				--~ print("artid",artid)
- 				local skills =3D glWeaponAbilitiesWeapons[artid]
+ 				local skills =3D glWeaponAbilitiesWeapons[artid] or glWeaponAbilities=
Weapons[0] -- 0:wrestl
  				if skills then
  					local first =3D glWeaponAbilities[skills.first]
  					local second =3D glWeaponAbilities[skills.second]

Modified: trunk/lua/gui/gui.skill.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.skill.lua (original)
+++ trunk/lua/gui/gui.skill.lua Tue Oct 14 20:45:06 2008
@@ -190,15 +190,8 @@
 	local name =3D glWeaponAbilities[weaponabilityid] and glWeaponAbilities[w=
eaponabilityid].name or "?"
 	local iconid =3D glWeaponAbilities[weaponabilityid] and glWeaponAbilities=
[weaponabilityid].gumpicon or 0x5200
 							=

-	local d =3D CreateQuickCastButton(x,y,name,function () =

-		-- quick cast function
-		-- Send_Spell(weaponabilityid,gSpellbookExpansion["AOS"])
-		--~ print("WEAPON ABILITY",name)
-		local mobile =3D GetPlayerMobile()
-		if mobile and mobile.serial then
-			Send_AOSCommand_WeaponAbility(mobile.serial, weaponabilityid)
-		end
-	end, iconid, true)
+	local d =3D CreateQuickCastButton(x,y,name,function () ToggleWeaponAbilit=
y(weaponabilityid) end, iconid)
+	gWeaponAbilityIcons[weaponabilityid] =3D d
 =

 	d.weaponabilityid =3D weaponabilityid
 	NotifyListener("Hook_CreateQuickWeaponAbility",d,x,y,weaponabilityid)

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Tue Oct 14 20:45:06 2008
@@ -69,7 +69,7 @@
 	-- only update if changed
 	if (self.giBlendOutCurZ ~=3D myLayer or self.gbBlendOutTerrainVisible ~=
=3D bTerrainVisible) then
 		self.giBlendOutCurZ =3D myLayer
-		print("Renderer2D:BlendOutLayersAbovePlayer",myLayer,bTerrainVisible)
+		--~ print("Renderer2D:BlendOutLayersAbovePlayer",myLayer,bTerrainVisible)
 		=

 		if (self.gbBlendOutTerrainVisible ~=3D bTerrainVisible) then
 			self.gbBlendOutTerrainVisible =3D bTerrainVisible

Modified: trunk/lua/lib.diff.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.diff.lua (original)
+++ trunk/lua/lib.diff.lua Tue Oct 14 20:45:06 2008
@@ -42,7 +42,7 @@
 function EnableDiff (enablediff)
 	--- at the moment, difffiles are applied in c++ in the loaders at mapload=
ing time
 	for k,v in pairs(enablediff) do
-		print("###### TODO lib.diff.lua : enable diff",k,v.iNumPatchesMap,v.iNum=
PatchesStatic)
+		--~ print("###### TODO lib.diff.lua : enable diff",k,v.iNumPatchesMap,v.=
iNumPatchesStatic)
 	end
 	--(0 =3D Fellucca, 1 =3D Trammel, and 2 =3D Ilshenar)
 	-- use the mapdif* and stadif* files for patching map and statics.

Modified: trunk/lua/lib.terrain.multitex.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.terrain.multitex.lua (original)
+++ trunk/lua/lib.terrain.multitex.lua Tue Oct 14 20:45:06 2008
@@ -357,7 +357,7 @@
 end
 =

 function MultiTexTerrain_NotifyTeleport ()
-	print("MultiTexTerrain_NotifyTeleport")
+	--~ print("MultiTexTerrain_NotifyTeleport")
 end
 =

 =


Modified: trunk/lua/net/net.aoscommand.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.aoscommand.lua (original)
+++ trunk/lua/net/net.aoscommand.lua Tue Oct 14 20:45:06 2008
@@ -6,6 +6,7 @@
 kPacket_AOS_Command_WeaponAbilityRequest	=3D hex2num("0x19")	-- Client -> =
Server message
 kPacket_AOS_Command_GuildGumpRequest		=3D hex2num("0x28")	-- Client -> Ser=
ver message
 kPacket_AOS_Command_QuestGumpRequest		=3D hex2num("0x32")	-- Client -> Ser=
ver message
+
 =

 --[[
 Packet Build: BYTE[1] cmd =

@@ -86,10 +87,45 @@
 end
 =

 =

-
-function Send_AOSCommand_WeaponAbility	(mobile_serial, weaponability)
-	Send_AOSCommand(kPacket_AOS_Command_WeaponAbilityRequest, mobile_serial, =
weaponability)
-end
+gWeaponAbilityIcons =3D {}
+gActiveWeaponAbility =3D nil
+
+-- should only be called by ToggleWeaponAbility
+function Send_AOSCommand_WeaponAbility	(weaponabilityid)
+	local mobile_serial =3D GetPlayerSerial()
+	if (not mobile_serial) then return end
+	print("##### WeaponAbility send",weaponabilityid)
+	Send_AOSCommand(kPacket_AOS_Command_WeaponAbilityRequest, mobile_serial, =
weaponabilityid)
+	gActiveWeaponAbility =3D weaponabilityid
+	UpdateWeaponAbilityIcons()
+end
+
+-- changes or deactivates weapon ability
+function ToggleWeaponAbility (weaponabilityid)
+	if (gActiveWeaponAbility =3D=3D weaponabilityid) then weaponabilityid =3D=
 0 end
+	Send_AOSCommand_WeaponAbility(weaponabilityid)
+end
+
+-- send from server via kPacket_Generic_SubCommand_Ability_Icon
+function EndWeaponAbility ()
+	print("##### WeaponAbility end")
+	if (gReActivateWeaponAbility and gActiveWeaponAbility ~=3D 0) then -- war=
ning : manacost is much higher if used more often than every 3s
+		Send_AOSCommand_WeaponAbility(gActiveWeaponAbility)
+	else
+		gActiveWeaponAbility =3D 0
+		UpdateWeaponAbilityIcons()
+	end
+end
+
+-- icon hueing
+function UpdateWeaponAbilityIcons ()
+	for weaponabilityid,widget in pairs(gWeaponAbilityIcons) do =

+		if (widget:IsAlive()) then =

+			widget.gfx_main:ChangeParams({hue=3D(weaponabilityid =3D=3D gActiveWeap=
onAbility) and gQuickCastClickedHue or gQuickCastNormalHue})
+		end
+	end
+end
+
 =

 --[[
 objectId,primaryAbility,secondaryAbility,primaryId,secondaryId

Modified: trunk/lua/net/net.world.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.world.lua (original)
+++ trunk/lua/net/net.world.lua Tue Oct 14 20:45:06 2008
@@ -10,7 +10,7 @@
 	local seasonchange =3D input:PopNetUint8()
 	printdebug("net",sprintf("NET: Game_Season id: %i season: %i seasonchange=
: %i\n",id,season,seasonchange))
 =

-	print("season change",season,gSeasonIDs[season])
+	--~ print("season change",season,gSeasonIDs[season])
 	if (seasonchange =3D=3D 1) then
 		gSeasonSetting =3D season
 	elseif (gSeasonSetting ~=3D season) then

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Tue Oct 14 20:45:06 2008
@@ -276,6 +276,9 @@
 	if (self and self.stats) then
 		-- update values
 		=

+		local oldcur =3D self.stats.curMana or 0
+		local oldmax =3D self.stats.maxMana or 0
+		=

 		if self.stats.curMana then
 			-- if there was a change, plop a text
 			local old =3D self.stats.curMana
@@ -292,6 +295,7 @@
 		end
 =

 		self:NotifyListener("Mobile_UpdateStats")
+		NotifyListener("Mobile_UpdateMana",self,oldcur,oldmax,curvalue,maxvalue)
 		self:Update()
 	end
 end

Modified: trunk/lua/widgets/widget.widget.uoquickcasticon.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.widget.uoquickcasticon.lua (original)
+++ trunk/lua/widgets/widget.widget.uoquickcasticon.lua Tue Oct 14 20:45:06=
 2008
@@ -12,8 +12,7 @@
 glQuickCastHotkeys =3D {}
 =

 -- creates a quickcast button at the given position
-function CreateQuickCastButton (x,y,name,fun,gumpid,changecolor)
-	changecolor =3D changecolor or false
+function CreateQuickCastButton (x,y,name,fun,gumpid)
 	if x < 0 then x =3D 0 end
 	if y < 0 then y =3D 0 end
 	=

@@ -22,16 +21,6 @@
 	-- layout
 	if gumpid then
 		dialog =3D GetDesktopWidget():CreateChild("UOQuickCastIcon",{x=3Dx,y=3Dy=
,fun=3Dfun,name=3Dname,gumpid=3Dgumpid})
-		if changecolor then =

-			dialog.changecolor =3D true
-			RegisterListener("Hook_Deactivate_Ability", function() =

-				if dialog and dialog:IsAlive() then =

-					dialog.gfx_main:ChangeParams({hue=3DgQuickCastNormalHue})
-				else
-					return true
-				end
-			end)
-		end
 	else
 		-- simple text button
 		local quickskillGump =3D gQuickskillGump
@@ -97,9 +86,6 @@
 end
 =

 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_click_double	() =

-	if self.changecolor then
-		self.gfx_main:ChangeParams({hue=3DgQuickCastClickedHue})
-	end
 	self.params.fun() =

 end
 function gWidgetPrototype.UOQuickCastIcon:on_mouse_left_down			() self:Bri=
ngToFront() self:StartMouseMove() end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Tue Oct 14 20:45:06 2008
@@ -137,11 +137,23 @@
 RegisterListener("Hook_Packet_Text_Unicode",	function (serial,plaintext)  =
-- kPacket_Text_Unicode
 	local r,g,b =3D 1,1,0 -- yellow
 	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
+	--~ print("Hook_Packet_Text_Unicode",serial,plaintext) =

 end)
 RegisterListener("Hook_Packet_Text",			function (serial,plaintext)  -- kPa=
cket_Text
 	local r,g,b =3D 1,1,0 -- yellow
 	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
-end)
+	--~ print("Hook_Packet_Text",serial,plaintext) =

+end)
+
+RegisterListener("Mobile_UpdateMana",			function (mobile,oldcur,oldmax,cur=
value,maxvalue)
+	local serial =3D mobile.serial
+	local delta =3D curvalue - oldcur =

+	if (delta =3D=3D 1 or delta =3D=3D 0) then return end
+	local r,g,b =3D 0,0,1 -- blue
+	SpellBarRiseTextOnMob(serial,r,g,b,sprintf("%+d",delta))
+	--~ print("manaused",serial,used) =

+end)
+
 =

 	--~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_T=
ext_Unicode
 RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum) =




From no-reply at zwischenwelt.org  Tue Oct 14 20:50:57 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 18:50:57 -0000
Subject: [Iris-commit] [IRIS] r2571 - in /trunk/lua: lib.cursor.lua
	lib.mousepick.lua
Message-ID: <20081014185057.ED9EF1C1865A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 14 20:50:57 2008
New Revision: 2571

Log:
no more CancelTargetMode when no mouse hit

Modified:
    trunk/lua/lib.cursor.lua
    trunk/lua/lib.mousepick.lua

Modified: trunk/lua/lib.cursor.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.cursor.lua (original)
+++ trunk/lua/lib.cursor.lua Tue Oct 14 20:50:57 2008
@@ -126,7 +126,10 @@
 function CompleteTargetMode (hitobject)
 	if (not hitobject) then
 		MainMousePick()
-		if (not gMousePickFoundHit) then CancelTargetMode() return end
+		if (not gMousePickFoundHit) then =

+			--~ CancelTargetMode() -- not desirable, e.g. [m tele  for gm travellin=
g, clicking skybox under loading block..
+			return =

+		end
 		hitobject =3D gMousePickFoundHit
 	end
 	=

@@ -176,4 +179,5 @@
 	end
 	=

 	CleanupTargetMode()
+	return true
 end

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Tue Oct 14 20:50:57 2008
@@ -143,8 +143,7 @@
 	=

 	if (gTestNoClick) then return end
 	if (IsTargetModeActive()) then =

-		CompleteTargetMode() -- see net/net.cursor.lua
-		gbMouseLastLeftDownWasTarget =3D true
+		if (CompleteTargetMode()) then gbMouseLastLeftDownWasTarget =3D true end=
 -- see net/net.cursor.lua
 	end
 end
 =




From no-reply at zwischenwelt.org  Tue Oct 14 21:34:45 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 19:34:45 -0000
Subject: [Iris-commit] [IRIS] r2572 - in /trunk: data/config.lua.dist
 lua/net/net.aoscommand.lua lua/net/net.other.lua
Message-ID: <20081014200004.36CAC1C1865D@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 14 21:34:45 2008
New Revision: 2572

Log:
added config gReActivateWeaponAbilityInterval to reactivate weapon abilitie=
s automatically

Modified:
    trunk/data/config.lua.dist
    trunk/lua/net/net.aoscommand.lua
    trunk/lua/net/net.other.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Tue Oct 14 21:34:45 2008
@@ -492,3 +492,4 @@
 -- gDisabledPlugins.hudenemylist =3D true
 =

 gAlwaysRun =3D false
+-- gReActivateWeaponAbilityInterval =3D 3100  -- don't reactivate if nil

Modified: trunk/lua/net/net.aoscommand.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.aoscommand.lua (original)
+++ trunk/lua/net/net.aoscommand.lua Tue Oct 14 21:34:45 2008
@@ -88,15 +88,18 @@
 =

 =

 gWeaponAbilityIcons =3D {}
-gActiveWeaponAbility =3D nil
+gActiveWeaponAbility =3D 0
+gLastSelectedWeaponAbility =3D 0
+gLastWeaponAbilityClearT =3D 0
 =

 -- should only be called by ToggleWeaponAbility
 function Send_AOSCommand_WeaponAbility	(weaponabilityid)
 	local mobile_serial =3D GetPlayerSerial()
 	if (not mobile_serial) then return end
-	print("##### WeaponAbility send",weaponabilityid)
+	--~ print("##### WeaponAbility send",floor(Client_GetTicks()/1000),weapon=
abilityid)
 	Send_AOSCommand(kPacket_AOS_Command_WeaponAbilityRequest, mobile_serial, =
weaponabilityid)
 	gActiveWeaponAbility =3D weaponabilityid
+	gLastSelectedWeaponAbility =3D weaponabilityid
 	UpdateWeaponAbilityIcons()
 end
 =

@@ -108,14 +111,24 @@
 =

 -- send from server via kPacket_Generic_SubCommand_Ability_Icon
 function EndWeaponAbility ()
-	print("##### WeaponAbility end")
-	if (gReActivateWeaponAbility and gActiveWeaponAbility ~=3D 0) then -- war=
ning : manacost is much higher if used more often than every 3s
-		Send_AOSCommand_WeaponAbility(gActiveWeaponAbility)
-	else
-		gActiveWeaponAbility =3D 0
-		UpdateWeaponAbilityIcons()
+	--~ print("##### WeaponAbility  end",floor(Client_GetTicks()/1000))
+	gActiveWeaponAbility =3D 0
+	gLastWeaponAbilityClearT =3D Client_GetTicks()
+	UpdateWeaponAbilityIcons()
+end
+
+
+RegisterStepper(function ()
+	-- warning : manacost is much higher if used more often than every 3s
+	if (not gReActivateWeaponAbilityInterval) then return end
+	if (gActiveWeaponAbility ~=3D 0) then return end
+	if (gLastSelectedWeaponAbility =3D=3D 0) then return end
+	local t =3D Client_GetTicks()
+	if (t - gLastWeaponAbilityClearT > gReActivateWeaponAbilityInterval) then
+		gLastWeaponAbilityClearT =3D t
+		Send_AOSCommand_WeaponAbility(gLastSelectedWeaponAbility)
 	end
-end
+end)
 =

 -- icon hueing
 function UpdateWeaponAbilityIcons ()

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Tue Oct 14 21:34:45 2008
@@ -403,6 +403,7 @@
 =

 -- sends iris specific infos to the server, in response to kPacket_Generic=
_SubCommand_IrisInfo
 function Send_IrisInfo()
+	print("Send_IrisInfo")
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Generic_Command)
 	out:PushNetUint16(0x06)



From no-reply at zwischenwelt.org  Tue Oct 14 21:56:22 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 19:56:22 -0000
Subject: [Iris-commit] [IRIS] r2573 - /trunk/plugins/lib.spellbar.lua
Message-ID: <20081014200004.61DF41C18422@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 14 21:56:18 2008
New Revision: 2573

Log:
spellbar messages

Modified:
    trunk/plugins/lib.spellbar.lua

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Tue Oct 14 21:56:18 2008
@@ -127,12 +127,7 @@
 	if (gCurrentRenderer ~=3D Renderer2D) then return end
 	Renderer2D:HUDFX_AddRisingTextOnMob(GetMobile(serial),text,r,g,b) -- see =
2d.hudfx.lua
 end
-
-kSpellBar_Msg_AlreadyCasting	=3D 502642 	-- You are already casting a spel=
l.
-kSpellBar_Msg_Fizzle			=3D 502632	-- The spell fizzles.
-kSpellBar_Msg_Disturbed			=3D 500641 	-- Your concentration is disturbed, =
thus ruining thy spell.
-kSpellBar_Msg_NoMana			=3D 502625 	-- Insufficient mana for this spell.
-kSpellBar_Msg_TooManyFollowers	=3D 1049645	-- You have too many followers =
to summon that creature.       =

+     =

 =

 RegisterListener("Hook_Packet_Text_Unicode",	function (serial,plaintext)  =
-- kPacket_Text_Unicode
 	local r,g,b =3D 1,1,0 -- yellow
@@ -153,18 +148,41 @@
 	SpellBarRiseTextOnMob(serial,r,g,b,sprintf("%+d",delta))
 	--~ print("manaused",serial,used) =

 end)
-
-
-	--~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_T=
ext_Unicode
-RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum) =

-	local r,g,b =3D 1,0,0 -- red
-	if (text_messagenum =3D=3D kSpellBar_Msg_AlreadyCasting		) then SpellBarR=
iseTextOnMob(GetPlayerSerial(),r,g,b,"already casting"		) end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Fizzle				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),r,g,b,"fizzle"				) SpellBarInterrupt() end
-	if (text_messagenum =3D=3D kSpellBar_Msg_Disturbed			) then SpellBarRiseT=
extOnMob(GetPlayerSerial(),r,g,b,"disturbed"			) SpellBarInterrupt() end
-	if (text_messagenum =3D=3D kSpellBar_Msg_NoMana				) then SpellBarRiseTex=
tOnMob(GetPlayerSerial(),r,g,b,"no mana"				) SpellBarInterrupt() end
-	if (text_messagenum =3D=3D kSpellBar_Msg_TooManyFollowers	) then SpellBar=
RiseTextOnMob(GetPlayerSerial(),r,g,b,"too many followers"	) SpellBarInterr=
upt() end
-	--~ print("Hook_Packet_Localized_Text",serial,plaintext,text_messagenum) =

-end)
+	=

+
+gSpellbarShortMessages =3D {}
+gSpellbarShortMessages[502642 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"already cast=
ing"	}-- You are already casting a spell.	=

+
+gSpellbarShortMessages[500946 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"cannot cast =
in town",bInterrupt=3Dtrue} -- You cannot cast this in town!							=

+gSpellbarShortMessages[502632 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"fizzle"				,=
bInterrupt=3Dtrue} -- The spell fizzles.										=

+gSpellbarShortMessages[500641 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"disturbed"		=
	,bInterrupt=3Dtrue} -- Your concentration is disturbed, thus ruining thy s=
pell.	=

+gSpellbarShortMessages[502625 ] =3D {r=3D1,g=3D0,b=3D0,txt=3D"no mana"			,=
bInterrupt=3Dtrue} -- Insufficient mana for this spell.						=

+gSpellbarShortMessages[1049645] =3D {r=3D1,g=3D0,b=3D0,txt=3D"too many fol=
lowers"	,bInterrupt=3Dtrue} -- You have too many followers to summon that c=
reature.  	   =

+
+-- weapon specials
+gSpellbarShortMessages[1060163] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"PARABL=
OW"			}--~ You deliver a paralyzing blow!  =

+gSpellbarShortMessages[1061923] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"alread=
y frozen"	}--~ The target is already frozen.   =

+gSpellbarShortMessages[1070804] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"para-r=
esist"		}--~ Your target resists paralysis.  =

+gSpellbarShortMessages[1060849] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"alread=
y unarmed"	}--~ Your target is already unarmed! =

+gSpellbarShortMessages[1060092] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"DISARM=
"			}--~ You disarm their weapon!        =

+
+-- other system messages
+gSpellbarShortMessages[500112] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
n"			} -- You are now under the protection of the town guards. =

+gSpellbarShortMessages[500113] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

+
+
+
+--~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_Te=
xt_Unicode
+RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum)
+	local short =3D gSpellbarShortMessages[text_messagenum]
+	if (short) then
+		SpellBarRiseTextOnMob(GetPlayerSerial(),short.r,short.g,short.b,short.tx=
t)
+		if (short.bInterrupt) then SpellBarInterrupt() end
+	end
+	if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet_Loc=
alized_Text",serial,plaintext,text_messagenum) end
+end)
+
+
 =

 	=

 --[[



From no-reply at zwischenwelt.org  Tue Oct 14 22:22:13 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 14 Oct 2008 20:22:13 -0000
Subject: [Iris-commit] [IRIS] r2574 - /trunk/lua/lib.desktop.lua
Message-ID: <20081014202214.007141C1865A@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 14 22:22:13 2008
New Revision: 2574

Log:
fixed desktop-checkpos for weaponability icons

Modified:
    trunk/lua/lib.desktop.lua

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Oct 14 22:22:13 2008
@@ -30,7 +30,8 @@
 	open =3D function(x,y,param) CreateQuickCastButtonWeaponability(x,y,param=
) end, =

 	checkpos =3D function(e, widget) =

 		local d =3D widget.dialog
-		if d and d.weaponabilityid and d.weaponabilityid =3D=3D e.param then
+		local id =3D d and d.weaponabilityid or widget.weaponabilityid
+		if id =3D=3D e.param then
 			e.x,e.y =3D widget:GetPos() =

 			return true
 		end



From no-reply at zwischenwelt.org  Wed Oct 15 03:03:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 01:03:11 -0000
Subject: [Iris-commit] [IRIS] r2575 - in /trunk/lua: lib.2d.dynamic.lua
 lib.2d.mobile.lua lib.macrolist.lua net/net.other.lua obj/obj.mobile.lua
 widgets/widget.uoquickcasticon.lua
 widgets/widget.widget.uoquickcasticon.lua
Message-ID: <20081015010311.710A71C18656@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 03:03:10 2008
New Revision: 2575

Log:
config option for hiding non-human corpses, a few hooks for detecting mobna=
me in text messages, healthbars are no longer closed when mobile is out of =
sight, 2d:mobileequipment only drawn for real human forms, not for all anim=
s in that detail level (lich,wraith..), added MacroCmd_Item_UseByArtID

Added:
    trunk/lua/widgets/widget.uoquickcasticon.lua
      - copied, changed from r2571, trunk/lua/widgets/widget.widget.uoquick=
casticon.lua
Removed:
    trunk/lua/widgets/widget.widget.uoquickcasticon.lua
Modified:
    trunk/lua/lib.2d.dynamic.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.other.lua
    trunk/lua/obj/obj.mobile.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Wed Oct 15 03:03:10 2008
@@ -66,7 +66,6 @@
 		local sortty =3D yloc-byloc
 		local sorttz =3D zloc
 		local bVisible =3D (not (zloc and iBlendOutMinZ and iBlendOutMaxZ)) or (=
zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ)
-		=

 	=

 		if (bVisible) then
 			-- corpse
@@ -76,8 +75,13 @@
 				local iDirAdd,bMirrorX =3D GetAnimDirAdd(DirWrap(item.corpsedir))  -- =
some param ? last known dir ?
 				=

 				local bodyid =3D item.amount
-				table.insert(parts,{bodyid,item.hue,13}) -- fallback=3D13=3Devortex
-				-- TODO : later : add clothing&equip for human corpses ?
+				local hiddenCorpse =3D false
+				if (gHideCorpses and (not self:MobileHasVisibleEquip(bodyid))) then hi=
ddenCorpse =3D true end
+				=

+				if (not hiddenCorpse) then =

+					table.insert(parts,{bodyid,item.hue,13}) -- fallback=3D13=3Devortex
+					-- TODO : later : add clothing&equip for human corpses ?
+				end
 				=

 				for k,v in pairs(parts) do =

 					local iModelID,iHue,iFallBackModel =3D unpack(v)

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Wed Oct 15 03:03:10 2008
@@ -44,6 +44,11 @@
 	end
 end
 =

+function Renderer2D:MobileHasVisibleEquip		(mobile_artid) =

+	return 	mobile_artid =3D=3D 400 or mobile_artid =3D=3D 401 or
+			mobile_artid =3D=3D 744 or mobile_artid =3D=3D 745 -- vamp form
+end
+
 function Renderer2D:UpdateMobileGfx				(mobile) =

 	local spriteblock =3D mobile.gfx2d
 	if (not spriteblock) then return end
@@ -63,8 +68,9 @@
 	=

 	if (mobile.artid ~=3D 402 and
 		mobile.artid ~=3D 403) then table.insert(parts,{mobile.artid,mobile.hue,=
13}) end -- fallback=3D13=3Devortex  402=3Dghost
+		=

 	--~ print("######### mobart",mobile.artid)
-	if (Anim_GetModelCategory(mobile.artid) =3D=3D 3) then -- only humans hav=
e equip
+	if (self:MobileHasVisibleEquip(mobile.artid)) then -- only humans have eq=
uip
 		for index,layer in pairs(gLayerOrder) do =

 			local item =3D GetMobileEquipmentItem(mobile,layer)
 			if (item) then =


Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Wed Oct 15 03:03:10 2008
@@ -143,6 +143,16 @@
 	for k,item in pairs(backpack_container:GetContent()) do =

 		local name =3D GetStaticTileTypeName(item.artid)
 		if (name and string.find(name,itemnamepart)) then
+			Send_DoubleClick(item.serial)
+			return true
+		end
+	end
+end
+function MacroCmd_Item_UseByArtID	(artid) -- equals easyuo type
+	local backpack_container =3D GetPlayerBackPackContainer()
+	if (not backpack_container) then return end
+	for k,item in pairs(backpack_container:GetContent()) do =

+		if (item.artid =3D=3D artid) then
 			Send_DoubleClick(item.serial)
 			return true
 		end

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Wed Oct 15 03:03:10 2008
@@ -523,6 +523,7 @@
 	if (mobilespeaker) then mobilespeaker:DisplayTextOverHead(string.gsub(tex=
t_message,"<br>","\n"),Uo16Color2Rgb(text_color)) end
 	-- TODO : text_item ?!?
 	NotifyListener("Hook_Packet_Text",mobile_serial,plaintext)
+	NotifyListener("Hook_MobName",mobile_serial,text_charname)
 end
 =

 =

@@ -617,6 +618,7 @@
 	end
 	JournalAddText(name,plaintext)
 	NotifyListener("Hook_Text",name,plaintext)
+	NotifyListener("Hook_MobName",data.speaker_serial,name)
 	=

 	--~ print("kPacket_Localized_Text_Plus_String")
 	--~ for k,v in pairs(data) do print("++",k,v) end
@@ -678,6 +680,7 @@
 	=

 	NotifyListener("Hook_Text",text_charname,plaintext)
 	NotifyListener("Hook_Packet_Localized_Text",text_item_serial,plaintext,te=
xt_messagenum)
+	NotifyListener("Hook_MobName",text_item_serial,plaintext,text_messagenum)
 	=

 	-- print("###",text_item_serial,text_item_model,text_type,text_color,text=
_charname,text_params,text_terminator)
 end
@@ -741,6 +744,7 @@
 	NotifyListener("Hook_Text",unitext_name,unitext_message)
 	=

 	NotifyListener("Hook_Packet_Text_Unicode",mobile_serial,unitext_message)
+	NotifyListener("Hook_MobName",mobile_serial,unitext_name)
 =

 	-- check if player -> then show text over player head
 	local mobilespeaker=3DGetMobile(mobile_serial)

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Wed Oct 15 03:03:10 2008
@@ -351,7 +351,7 @@
 	NotifyListener("Hook_Object_DestroyMobile",self)
 	=

 	-- destroy Status Gump from NPC
-	CloseHealthbar(self)
+	--~ CloseHealthbar(self)
 	=

 	self:DestroyContent() -- warning, triggers self:Update()
 	=




From no-reply at zwischenwelt.org  Wed Oct 15 04:40:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 02:40:36 -0000
Subject: [Iris-commit] [IRIS] r2576 - in /trunk: data/config.lua.dist
 lua/net.walk.lua lua/net/net.partysystem.lua lua/obj/obj.mobile.lua
 lua/widgets/widget.uotext.lua plugins/lib.spellbar.lua plugins/moblist.lua
Message-ID: <20081015024037.3C97F1C1865A@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 04:40:35 2008
New Revision: 2576

Log:
started work on moblist

Added:
    trunk/plugins/moblist.lua
Modified:
    trunk/data/config.lua.dist
    trunk/lua/net.walk.lua
    trunk/lua/net/net.partysystem.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/widgets/widget.uotext.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/data/config.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/config.lua.dist (original)
+++ trunk/data/config.lua.dist Wed Oct 15 04:40:35 2008
@@ -493,3 +493,7 @@
 =

 gAlwaysRun =3D false
 -- gReActivateWeaponAbilityInterval =3D 3100  -- don't reactivate if nil
+
+gFriendlyGuildTags =3D {} -- gFriendlyGuildTags =3D {"[ABC]","[DEF]"} -- u=
sed by moblist plugin
+
+gDisabledPlugins.moblist =3D true

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Wed Oct 15 04:40:35 2008
@@ -231,12 +231,13 @@
 =

 =

 -- Accept Movement Request and or Resync
--- TODO : change player notoriety <- check if this is needed
 function gPacketHandler.kPacket_Accept_Movement_Resync_Request() -- 0x22
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local iSeqNum =3D input:PopNetUint8()
-	local player_status_or_notoriety =3D input:PopNetUint8()  -- correct use =
unknown
+	local player_notoriety =3D input:PopNetUint8()
+	local playermobile =3D GetPlayerMobile()
+	if (playermobile) then playermobile:SetNotoriety(player_notoriety) end --=
 fast notoriety update
 	=

 	local request =3D gWalkRequests[iSeqNum]
 	=


Modified: trunk/lua/net/net.partysystem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.partysystem.lua (original)
+++ trunk/lua/net/net.partysystem.lua Wed Oct 15 04:40:35 2008
@@ -11,11 +11,19 @@
 =

 gPartySystemHandler =3D {}
 gPartySystemMemberList =3D {}
+gPartySystemMemberListByID =3D {}
 =

 function PartySystem_UpdateMemberList (memberlist)
 	gPartySystemMemberList =3D memberlist
+	gPartySystemMemberListByID =3D {}
+	for k,serial in pairs(gPartySystemMemberList) do gPartySystemMemberListBy=
ID[serial] =3D true end
 	PartyListDialog_Rebuild()
-end
+	NotifyListener("Hook_UpdatePartyMemberList")
+end
+
+function IsMobileInParty		(serial) return gPartySystemMemberListByID[seria=
l] end
+function IsMobilePartyLeader	(serial) return gPartySystemMemberList[1] =3D=
=3D serial end
+
 function	PartySendAccept () =

 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Generic_Command)

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Wed Oct 15 04:40:35 2008
@@ -69,7 +69,7 @@
 	=

 	mobile.content =3D {}
 	mobile.stats =3D {}
-	mobile.serial =3D 0		=

+	mobile.serial =3D serial		=

 	mobile.artid =3D 0		=

 	mobile.xloc =3D 0
 	mobile.yloc =3D 0
@@ -108,6 +108,8 @@
 =

 =

 function gMobilePrototype:UpdateContent () self.bEquipmentChanged =3D true=
 self:Update() end
+
+function gMobilePrototype:SetNotoriety(notoriety) self.notoriety =3D notor=
iety end -- also written by other means, don't use for notify, only used fo=
r walk-ack
 =

 function gMobilePrototype:RequestEquipToolTips ()
 	for index,layer in pairs(gLayerOrder) do =


Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Wed Oct 15 04:40:35 2008
@@ -57,6 +57,7 @@
 	local col =3D self.params.default_black and col_black or col_white
 	if (self.params.hue) then local r,g,b =3D gHueLoader:GetColor(self.params=
.hue,31) col =3D {r=3Dr,g=3Dg,b=3Db} end
 	if (self.params.col) then col =3D self.params.col end
+	if (self.params.fontid) then fontid =3D self.params.fontid end
 	=

 	local glyphlist =3D self.glyphlist
 	local plaintext =3D bIsUniCode and UnicodeToPlainText_KeepLength(uohtml) =
or uohtml

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Wed Oct 15 04:40:35 2008
@@ -168,7 +168,7 @@
 =

 -- other system messages
 gSpellbarShortMessages[500112] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
n"			} -- You are now under the protection of the town guards. =

-gSpellbarShortMessages[500113] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

+gSpellbarShortMessages[500113] =3D {r=3D0.5,g=3D0,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

 =

 =

 =




From no-reply at zwischenwelt.org  Wed Oct 15 14:39:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 12:39:41 -0000
Subject: [Iris-commit] [IRIS] r2577 - in /trunk: data/config.lua.dist
	lua/config_declarations.lua
Message-ID: <20081015123941.A7F531C186AC@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 14:39:40 2008
New Revision: 2577

Log:
config.lua.dist no longer used, moved to lua/config_declarations.lua

Removed:
    trunk/data/config.lua.dist
Modified:
    trunk/lua/config_declarations.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Wed Oct 15 14:39:40 2008
@@ -481,6 +481,20 @@
 gConfig:DeclareBoolean("gShowHealthBarOverEveryMobile", "gui", "healthbar =
over mobile", 'TODO', false)
 =

 =

+
+
+-- port me to new config system ! (or extend system for complex stuff)
+
+
+
+gAlwaysRun =3D false
+-- gReActivateWeaponAbilityInterval =3D 3100  -- don't reactivate if nil
+gDisabledPlugins.moblist =3D true
+gFriendlyGuildTags =3D {} -- gFriendlyGuildTags =3D {"[ABC]","[DEF]"} -- u=
sed by moblist plugin
+gEnableWalkLog =3D false
+
+
+
 -- compatibility stuff for old config system via global varibles
 =

 -- import all vars into global scope that they can be accesses as used



From no-reply at zwischenwelt.org  Wed Oct 15 17:20:18 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 15:20:18 -0000
Subject: [Iris-commit] [IRIS] r2578 - /trunk/screenshots/
Message-ID: <20081015152018.A88041C18799@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 17:20:18 2008
New Revision: 2578

Log:
screenshot dir : added svn ignore for video files

Modified:
    trunk/screenshots/   (props changed)



From no-reply at zwischenwelt.org  Wed Oct 15 18:48:17 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 16:48:17 -0000
Subject: [Iris-commit] [IRIS] r2579 - in /trunk: lua/lib.2d.mousepick.lua
	plugins/moblist.lua
Message-ID: <20081015164817.9D4391524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 18:48:16 2008
New Revision: 2579

Log:
moblist starts to work

Modified:
    trunk/lua/lib.2d.mousepick.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Wed Oct 15 18:48:16 2008
@@ -91,6 +91,8 @@
 		local data =3D GetMouseHitObject(false)
 		local artid =3D data and data.artid
 		if (artid) then hitinfo =3D hitinfo..sprintf("artid=3D0x%04x=3D%d(%s),",=
artid,artid,GetStaticTileTypeName(artid) or "") end
+		local hue =3D data and data.hue
+		if (hue) then hitinfo =3D hitinfo..sprintf("hue=3D%d,",hue) end
 		local xloc,yloc,zloc =3D GetMouseHitTileCoords()
 		if (xloc) then
 			local bx,by =3D floor(xloc/8),floor(yloc/8)

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Wed Oct 15 18:48:16 2008
@@ -1,9 +1,20 @@
 =

 if (not gDisabledPlugins.moblist) then =

 =

-kMobList_MaxCat =3D 3
 kMobList_CatW =3D 100
-kMobList_CatItemH =3D 24
+kMobList_CatItemH =3D 20
+kMobList_CatItemBarH =3D 5
+kMobList_CatDist =3D 4
+
+kMobList_Healer_Text =3D " the wandering healer"
+kMobList_Escort_Text =3D " the seeker of adventure"
+
+kMobListCat_Self	=3D 1
+kMobListCat_Friends	=3D 2
+kMobListCat_Players	=3D 3
+kMobListCat_Pets	=3D 4
+kMobListCat_Rest	=3D 5
+kMobList_MaxCat 	=3D kMobListCat_Rest
 =

 RegisterWidgetClass("UOMobList")
 RegisterWidgetClass("UOMobListItem")
@@ -17,12 +28,12 @@
 	local vw,vh =3D GetViewportSize()
 	self:SetPos(vw-kMobList_CatW,230)
 	=

-	RegisterListener("Hook_HUDStep",function () self:Step() end)
-	RegisterListener("Hook_MobName",function (serial,name,clilocid) self:MobN=
ame(serial,name,clilocid) end) -- from several text/speak packets..
-	RegisterListener("Hook_ToolTipUpdate",function (serial) self:ToolTipUpdat=
e(serial) end)
-	RegisterListener("Hook_Object_CreateMobile", function (mobile) self:AddMo=
b(mobile) end)
-	RegisterListener("Hook_Object_DestroyMobile",function (mobile) self:Remov=
eMob(mobile) end)
-	RegisterListener("Hook_UpdatePartyMemberList",function () self:RecalcCat(=
) end)
+	RegisterListener("Hook_HUDStep",				function () 		self:Step() end)
+	RegisterListener("Hook_MobName",				function (serial,name,clilocid) self:=
MobName(serial,name,clilocid) end) -- from several text/speak packets..
+	RegisterListener("Hook_ToolTipUpdate",			function (serial)	self:ToolTipUp=
date(serial) end)
+	RegisterListener("Hook_Object_CreateMobile",	function (mobile)	self:AddMo=
b(mobile) end)
+	RegisterListener("Hook_Object_DestroyMobile",	function (mobile)	self:Remo=
veMob(mobile) end)
+	RegisterListener("Hook_UpdatePartyMemberList",	function ()			self:RecalcC=
at() end)
 end
 =

 function gWidgetPrototype.UOMobList:ToolTipUpdate		(serial)
@@ -61,9 +72,9 @@
 		for item,v in pairs(self.items) do item:ReGroup(self.catgroup) end
 		-- reposition groups
 		local y =3D 0
-		self.catgroup[1]:SetPos(0,y) y =3D y + kMobList_CatItemH * self.catgroup=
[1].itemcount
-		self.catgroup[2]:SetPos(0,y) y =3D y + kMobList_CatItemH * self.catgroup=
[2].itemcount
-		self.catgroup[3]:SetPos(0,y) y =3D y + kMobList_CatItemH * self.catgroup=
[3].itemcount
+		for k,group in ipairs(self.catgroup) do =

+			group:SetPos(0,y) y =3D y + kMobList_CatItemH * group.itemcount + ((gro=
up.itemcount > 0) and kMobList_CatDist or 0)
+		end
 	end
 	for item,v in pairs(self.items) do item:Step() end
 end
@@ -78,6 +89,20 @@
 	self.moblist =3D params.moblist
 	self.text =3D self:CreateChild("UOText",{x=3D0,y=3D0,text=3D"",col=3D{r=
=3D1,g=3D1,b=3D1},fontid=3D2,bold=3Dtrue})
 	self.text:SetIgnoreBBoxHit(false)
+	=

+	local mobile =3D params.mobile
+	local w,h =3D kMobList_CatW,kMobList_CatItemBarH
+	local xoff,yoff =3D 0,kMobList_CatItemH-kMobList_CatItemBarH
+	self.fillw =3D w
+	self.fillh =3D h
+	=

+	local paramb =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),w,h, xoff,yoff, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, fals=
e, false)
+	local paramf =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),w,h, xoff,yoff, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, fals=
e, false)
+	paramb.r,paramb.g,paramb.b =3D GetNotorietyColor(mobile.notoriety)
+	paramf.r,paramf.g,paramf.b =3D 0,0.5,1
+	self.border	=3D self:CreateChild("Image",{gfxparam_init=3Dparamb})
+	self.fill	=3D self:CreateChild("Image",{gfxparam_init=3Dparamf,bVertexBuf=
ferDynamic=3Dtrue})
+	=

 	self:UpdateName()
 	self:RecalcCat()
 end
@@ -93,12 +118,28 @@
 	text =3D string.gsub(text," %[","%[") -- move guildtag closer
 	text =3D string.gsub(text,"^Lord","")
 	text =3D string.gsub(text,"^Lady","")
-	text =3D string.gsub(text,"^a","")
+	text =3D string.gsub(text,"^an ","")
+	text =3D string.gsub(text,"^a ","")
 	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
 	text =3D string.gsub(text,"[ \t]+$","") -- remove trailing spaces
+	=

+	-- npcs friends
+	self.bIsNPC =3D false =

+	if (StringContains(text,kMobList_Healer_Text)) then self.bIsNPC =3D true =
text =3D "[HEALER]"..string.gsub(text,kMobList_Healer_Text,"") end
+	if (StringContains(text,kMobList_Escort_Text)) then self.bIsNPC =3D true =
text =3D "[ESCORT]"..string.gsub(text,kMobList_Escort_Text,"") end
+	=

 	self.old_text =3D text
+	=

+	-- check friends
 	self.bIsFriendlyGuild =3D false
 	for k,guildtag in pairs(gFriendlyGuildTags) do if (StringContains(text,gu=
ildtag)) then self.bIsFriendlyGuild =3D true break end end
+	=

+	-- check pets
+	self.bIsPet =3D StringContains(text,"(summoned)") or StringContains(text,=
"(tame)")
+	local mobile =3D self.mobile
+	if (mobile.artid =3D=3D 574 and mobile.hue =3D=3D 0) then self.bIsPet =3D=
 true end -- blade spirit
+	if (mobile.artid =3D=3D 164 and mobile.hue =3D=3D 0) then self.bIsPet =3D=
 true end -- energy vortex
+	=

 	self:UpdateNameGfx()
 	self:RecalcCat()
 end
@@ -115,14 +156,21 @@
 	if (self.old_notoriety ~=3D mobile.notoriety) then =

 		self.old_notoriety  =3D mobile.notoriety
 		self:UpdateNameGfx()
+		-- todo : update bar-background color ? not visible when full hp ?
 	end
+	=

+	-- poison... color !
+	local f_hp =3D mobile.stats and ((mobile.stats.curHits or 0) / (mobile.st=
ats.maxHits or 1)) or 0
+	self.fill:SetSize(max(0,min(1,f_hp)) * self.fillw,self.fillh)
 end
 =

 function gWidgetPrototype.UOMobListItem:RecalcCat ()
-	if (self.namecliloc) then self:SetCat(3) return end
 	local serial =3D self.serial
-	if (GetPlayerSerial() =3D=3D serial or IsMobileInParty(serial) or self.bI=
sFriendlyGuild) then self:SetCat(1) return end
-	self:SetCat(2)
+	if (GetPlayerSerial() =3D=3D serial) then						return self:SetCat(kMobLis=
tCat_Self) end
+	if (IsMobileInParty(serial) or self.bIsFriendlyGuild) then	return self:Se=
tCat(kMobListCat_Friends) end
+	if (self.bIsPet) then										return self:SetCat(kMobListCat_Pets) end
+	if (self.namecliloc or self.bIsNPC) then 					return self:SetCat(kMobList=
Cat_Rest) end
+	return self:SetCat(kMobListCat_Players)
 end
 =

 function gWidgetPrototype.UOMobListItem:SetCat (cat)



From no-reply at zwischenwelt.org  Wed Oct 15 19:54:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 17:54:32 -0000
Subject: [Iris-commit] [IRIS] r2580 - /trunk/bin/iris2.exe
Message-ID: <20081015175434.73DCA1524030@zwischenwelt.org>

Author: sience
Date: Wed Oct 15 19:54:31 2008
New Revision: 2580

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Wed Oct 15 19:57:10 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 17:57:10 -0000
Subject: [Iris-commit] [IRIS] r2581 - /trunk/lua/gui/gui.paperdoll.lua
Message-ID: <20081015175711.076FE1C181D5@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 19:57:07 2008
New Revision: 2581

Log:
fixed npc paperdoll openstatus

Modified:
    trunk/lua/gui/gui.paperdoll.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Wed Oct 15 19:57:07 2008
@@ -133,8 +133,7 @@
  -- status
  [0]	=3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 1) then
-				widget.gfx:SetMaterial(widget.mat_pressed)
-				OpenHealthbar(widget.dialog.uoPaperdoll.mobile)
+				OpenHealthbar(widget:GetDialog().uoPaperdoll.mobile)
 			end
 		  end
 }



From no-reply at zwischenwelt.org  Wed Oct 15 21:23:17 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 19:23:17 -0000
Subject: [Iris-commit] [IRIS] r2582 - in /trunk: lua/lib.spellinfo.lua
 lua/main.lua plugins/lib.spellbar.lua
Message-ID: <20081015192317.83A571C181B8@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 21:23:17 2008
New Revision: 2582

Log:
spell-powerword/mantra recognition

Added:
    trunk/lua/lib.spellinfo.lua
Modified:
    trunk/lua/main.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Wed Oct 15 21:23:17 2008
@@ -58,6 +58,7 @@
 dofile(libpath .. "lib.macrolist.lua")
 dofile(libpath .. "lib.walking3.lua")
 dofile(libpath .. "lib.spellbooks.lua")
+dofile(libpath .. "lib.spellinfo.lua")
 dofile(libpath .. "lib.speech.lua")
 dofile(libpath .. "lib.granny.lua")
 dofile(libpath .. "lib.bodygfx.lua")

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Wed Oct 15 21:23:17 2008
@@ -136,6 +136,8 @@
 end)
 RegisterListener("Hook_Packet_Text",			function (serial,plaintext)  -- kPa=
cket_Text
 	local r,g,b =3D 1,1,0 -- yellow
+	local spellname =3D GetSpellNameFromMantra(plaintext)
+	if (spellname) then plaintext =3D spellname r,g,b =3D 0.5,0.5,0.5 end
 	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
 	--~ print("Hook_Packet_Text",serial,plaintext) =

 end)



From no-reply at zwischenwelt.org  Wed Oct 15 22:22:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 20:22:41 -0000
Subject: [Iris-commit] [IRIS] r2583 - in /trunk: lua/lib.2d.hudfx.lua
 lua/lib.2d.renderer.lua lua/lib.3d.renderer.lua lua/main.lua
 plugins/moblist.lua
Message-ID: <20081015202241.A086D1C18799@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 22:22:38 2008
New Revision: 2583

Log:
moblist : click to mark current target, shown on screen

Modified:
    trunk/lua/lib.2d.hudfx.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/main.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.2d.hudfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.hudfx.lua (original)
+++ trunk/lua/lib.2d.hudfx.lua Wed Oct 15 22:22:38 2008
@@ -23,20 +23,6 @@
 function Renderer2D:HUDFX_Destroy (hudfx)
 	if (hudfx.gfx) then hudfx.gfx:Destroy() hudfx.gfx =3D nil end
 	Renderer2D.gHUDFXList[hudfx] =3D nil
-end
-
-
-function Renderer2D:UOPosToPixelPos (xloc,yloc,zloc)
-	return self:LocalPosToPixelPos(self:UOPosToLocal(xloc,yloc,zloc*kRenderer=
2D_ZScale))
-end
-
-function Renderer2D:LocalPosToPixelPos (x,y,z)
-	local bIsInFront,px,py =3D ProjectPos(x,y,z)
-	if (bIsInFront) then =

-		local viewport =3D GetMainViewport()
-		local vw,vh =3D viewport:GetActualWidth(),viewport:GetActualHeight()
-		return floor((1+px)*vw*0.5 + 0.5),floor((1-py)*vh*0.5 + 0.5)
-	end
 end
 =

 function Renderer2D:HUDFX_Step (hudfx,t)

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Wed Oct 15 22:22:38 2008
@@ -176,6 +176,17 @@
 			 (z or 0)
 end
 =

+-- returns px,py,bIsInFront
+function Renderer2D:UOPosToPixelPos (xloc,yloc,zloc)
+	return self:LocalPosToPixelPos(self:UOPosToLocal(xloc,yloc,zloc*kRenderer=
2D_ZScale))
+end
+
+-- returns px,py,bIsInFront
+function Renderer2D:LocalPosToPixelPos (x,y,z)
+	local bIsInFront,px,py =3D ProjectPos(x,y,z)
+	return floor((1+px)*gViewportW*0.5 + 0.5),floor((1-py)*gViewportH*0.5 + 0=
.5),bIsInFront
+end
+
 function Renderer2D:InitLocalCam				(x,y,z) end -- ??? offline mode ?
 function Renderer2D:ChangeCamMode				() end
 function Renderer2D:SelectMobile				() end

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Oct 15 22:22:38 2008
@@ -157,6 +157,17 @@
 	return	-(xlocal + 8*self.giMapOriginX * self.ROBMAP_CHUNK_SIZE),
 			ylocal + 8*self.giMapOriginY * self.ROBMAP_CHUNK_SIZE,
 			(zlocal or 0) - self.gZ_Factor
+end
+
+-- returns px,py,bIsInFront
+function Renderer3D:UOPosToPixelPos (xloc,yloc,zloc)
+	return self:LocalPosToPixelPos(self:UOPosToLocal(xloc,yloc,zloc*0.1))
+end
+
+-- returns px,py,bIsInFront
+function Renderer3D:LocalPosToPixelPos (x,y,z)
+	local bIsInFront,px,py =3D ProjectPos(x,y,z)
+	return floor((1+px)*gViewportW*0.5 + 0.5),floor((1-py)*gViewportH*0.5 + 0=
.5),bIsInFront
 end
 =

 -- param and result in DEGREES

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Wed Oct 15 22:22:38 2008
@@ -342,6 +342,7 @@
 	InitArtFilter()
 	=

 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
+	gViewportW,gViewportH =3D GetViewportSize()
 	--~ Client_USleep(1000/30)
 =

 	NotifyListener("Hook_PreLoad")

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Wed Oct 15 22:22:38 2008
@@ -24,6 +24,8 @@
 	self.items =3D {}
 	self.catgroup =3D {}
 	for i=3D1,kMobList_MaxCat do self.catgroup[i] =3D self:CreateChild("Group=
") end
+	=

+	self.gfx_maintarget =3D gRootWidget.tooltip:CreateChild("UOText",{x=3D0,y=
=3D0,text=3D"",col=3D{r=3D1,g=3D0,b=3D0},bold=3Dtrue})
 	=

 	local vw,vh =3D GetViewportSize()
 	self:SetPos(vw-kMobList_CatW,230)
@@ -63,6 +65,19 @@
 =

 function gWidgetPrototype.UOMobList:RecalcCat ()
 	for item,v in pairs(self.items) do item:RecalcCat() end
+end
+
+function gWidgetPrototype.UOMobList:SetMainTarget (serial,name)
+	if (serial =3D=3D 0 or serial =3D=3D GetPlayerSerial()) then serial =3D n=
il end
+	self.maintarget_serial =3D serial
+	print("UOMobList:SetMainTarget",serial,name)
+	local gfx =3D self.gfx_maintarget
+	if (self.maintarget_serial) then
+		gfx:SetVisible(true)
+		gfx:SetText(name)
+	else
+		gfx:SetVisible(false)
+	end
 end
 =

 function gWidgetPrototype.UOMobList:Step ()
@@ -77,6 +92,33 @@
 		end
 	end
 	for item,v in pairs(self.items) do item:Step() end
+	=

+	=

+	-- maintarget text : update position on screen
+	if (self.maintarget_serial) then
+		local mobile =3D GetMobile(self.maintarget_serial)
+		local xloc,yloc,zloc
+		local bInRange =3D true
+		if (mobile) then =

+			xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
+			self.maintarget_last_xloc =3D xloc
+			self.maintarget_last_yloc =3D yloc
+			self.maintarget_last_zloc =3D zloc
+		else
+			bInRange =3D false
+			xloc =3D self.maintarget_last_xloc
+			yloc =3D self.maintarget_last_yloc
+			zloc =3D self.maintarget_last_zloc
+		end
+		local zadd =3D 10
+		local gfx =3D self.gfx_maintarget
+		local px,py =3D gCurrentRenderer:UOPosToPixelPos(xloc,yloc,zloc+zadd)
+		local w,h =3D gfx:GetSize()
+		local minx,miny,maxx,maxy =3D 0,64,gViewportW-200,gViewportH-32
+		local x =3D max(minx,min(maxx-w,px or 0))
+		local y =3D max(miny,min(maxy-h,py or 0))
+		gfx:SetPos(x,y)
+	end
 end
 =

 -- ***** ***** ***** ***** ***** UOMobListItem
@@ -98,7 +140,7 @@
 	=

 	local paramb =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),w,h, xoff,yoff, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, fals=
e, false)
 	local paramf =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),w,h, xoff,yoff, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, fals=
e, false)
-	paramb.r,paramb.g,paramb.b =3D GetNotorietyColor(mobile.notoriety)
+	paramb.r,paramb.g,paramb.b =3D 1,0,0
 	paramf.r,paramf.g,paramf.b =3D 0,0.5,1
 	self.border	=3D self:CreateChild("Image",{gfxparam_init=3Dparamb})
 	self.fill	=3D self:CreateChild("Image",{gfxparam_init=3Dparamf,bVertexBuf=
ferDynamic=3Dtrue})
@@ -151,6 +193,10 @@
 	self.text:SetText(self.old_text)
 end
 =

+function gWidgetPrototype.UOMobListItem:SetSelfAsMainTarget ()
+	self.moblist:SetMainTarget(self.serial,self.old_text or "???")
+end
+
 function gWidgetPrototype.UOMobListItem:Step ()
 	local mobile =3D self.mobile
 	if (self.old_notoriety ~=3D mobile.notoriety) then =

@@ -188,6 +234,10 @@
 	group.itemcount =3D group.itemcount + 1
 end
 =

+
+function gWidgetPrototype.UOMobListItem:on_mouse_left_down	() self:SetSelf=
AsMainTarget() end
+
+
 -- ***** ***** ***** ***** ***** rest
 =

 RegisterListener("Hook_PostLoad",function () gMobList =3D GetDesktopWidget=
():CreateChild("UOMobList") end)



From no-reply at zwischenwelt.org  Wed Oct 15 22:40:43 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 20:40:43 -0000
Subject: [Iris-commit] [IRIS] r2584 - /trunk/plugins/moblist.lua
Message-ID: <20081015204043.6F4271C18799@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 22:40:40 2008
New Revision: 2584

Log:
moblist : hp-bar colored to show poison and mortal

Modified:
    trunk/plugins/moblist.lua

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Wed Oct 15 22:40:40 2008
@@ -141,7 +141,6 @@
 	local paramb =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),w,h, xoff,yoff, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, fals=
e, false)
 	local paramf =3D MakeSpritePanelParam_BorderPartMatrix(GetPlainTextureGUI=
Mat("simplebutton.png"),w,h, xoff,yoff, 0,0, 4,8,4, 4,8,4, 32,32, 1,1, fals=
e, false)
 	paramb.r,paramb.g,paramb.b =3D 1,0,0
-	paramf.r,paramf.g,paramf.b =3D 0,0.5,1
 	self.border	=3D self:CreateChild("Image",{gfxparam_init=3Dparamb})
 	self.fill	=3D self:CreateChild("Image",{gfxparam_init=3Dparamf,bVertexBuf=
ferDynamic=3Dtrue})
 	=

@@ -205,7 +204,16 @@
 		-- todo : update bar-background color ? not visible when full hp ?
 	end
 	=

-	-- poison... color !
+	-- healthbar color
+	local r,g,b =3D 0,0.5,1 -- blue
+	if (TestBit(mobile.flag,kMobileFlag_Poisoned)		)	then r,g,b =3D 0,0.5,0 e=
nd
+	if (TestBit(mobile.flag,kMobileFlag_GoldenHealth)	)	then r,g,b =3D 1,1,0 =
end
+	local gfxparam =3D self.fill.params.gfxparam_init
+	gfxparam.r =3D r =

+	gfxparam.g =3D g =

+	gfxparam.b =3D b =

+
+	-- healthbar size
 	local f_hp =3D mobile.stats and ((mobile.stats.curHits or 0) / (mobile.st=
ats.maxHits or 1)) or 0
 	self.fill:SetSize(max(0,min(1,f_hp)) * self.fillw,self.fillh)
 end



From no-reply at zwischenwelt.org  Wed Oct 15 23:39:02 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 21:39:02 -0000
Subject: [Iris-commit] [IRIS] r2585 - in /trunk: lua/lib.spellbooks.lua
 plugins/lib.spellbar.lua plugins/moblist.lua
Message-ID: <20081015213902.534261524030@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 15 23:39:02 2008
New Revision: 2585

Log:
moblist : line from player to target, casttime calc fixed for ninjistu and =
bushido(instant)

Modified:
    trunk/lua/lib.spellbooks.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Wed Oct 15 23:39:02 2008
@@ -389,6 +389,9 @@
 -- bProtectionBuffActive : see IsBuffActive_Protection() IsBuffActive_Esse=
nceOfWind()
 -- see also RunUO-2.0-SVN/Scripts/Spells/Base/Spell.cs:647:	public virtual=
 TimeSpan GetCastDelay()
 function GetSpellCastTime (spellid,fc,bBuffActive_Protection,bBuffActive_E=
ssenceOfWind)
+	local spellbookid =3D GetSpellBookIDBySpellID(spellid)
+	if (spellbookid =3D=3D NinjitsuSpellbook) then return 0 end
+	if (spellbookid =3D=3D BushidoSpellbook) then return 0 end
 	--~ TODO : fcmax =3D 2 ,   (castskill=3Dchiv&&magery<70):fcmax=3D4
 	--~ TODO : if( EssenceOfWindSpell.IsDebuffed( m_Caster ) ) fc -=3D Essenc=
eOfWindSpell.GetFCMalus( m_Caster );
 	fc =3D min(fc or 0,2)

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Wed Oct 15 23:39:02 2008
@@ -65,7 +65,7 @@
 	local casttime		=3D GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Pr=
otection(),IsBuffActive_EssenceOfWind()) + kSpellTimeLatency
 	print("spellbar:Hook_SendSpell",spellid,spellname,spellcircle,casttime,Sm=
artDump(equipprop))
 	SpellBarRiseTextOnMob(GetPlayerSerial(),1,1,1,spellname)
-	SpellBarStart(casttime)	=

+	if (casttime > 0) then SpellBarStart(casttime) end
 	--~ SpellBarRiseTextOnMob(GetPlayerSerial(),1,1,1,sprintf("%s(%d,%d)%s",s=
pellname,spellcircle,spellid,IsMageSpell(spellid) and "mage" or "")) =

 end)
 =

@@ -171,7 +171,13 @@
 -- other system messages
 gSpellbarShortMessages[500112] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
n"			} -- You are now under the protection of the town guards. =

 gSpellbarShortMessages[500113] =3D {r=3D0.5,g=3D0,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

-
+gSpellbarShortMessages[501942] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"locatio=
n blocked"	} -- That location is blocked.           =

+
+--[[
+Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091
+Hook_Packet_Localized_Text      4294967295      You inflict a Death Strike=
 upon your opponent!  1063094  (different message for 2nd..)
+Hook_Packet_Localized_Text      4294967295      You missed your opponent w=
ith a Death Strike.   1070779  =

+]]--
 =

 =

 --~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_Te=
xt_Unicode

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Wed Oct 15 23:39:02 2008
@@ -26,6 +26,7 @@
 	for i=3D1,kMobList_MaxCat do self.catgroup[i] =3D self:CreateChild("Group=
") end
 	=

 	self.gfx_maintarget =3D gRootWidget.tooltip:CreateChild("UOText",{x=3D0,y=
=3D0,text=3D"",col=3D{r=3D1,g=3D0,b=3D0},bold=3Dtrue})
+	self.gfx_maintarget_line =3D gRootWidget.tooltip:CreateChild("LineList",{=
matname=3D"BaseWhiteNoLighting",bDynamic=3Dtrue,r=3D1,g=3D0,b=3D0})
 	=

 	local vw,vh =3D GetViewportSize()
 	self:SetPos(vw-kMobList_CatW,230)
@@ -71,12 +72,15 @@
 	if (serial =3D=3D 0 or serial =3D=3D GetPlayerSerial()) then serial =3D n=
il end
 	self.maintarget_serial =3D serial
 	print("UOMobList:SetMainTarget",serial,name)
-	local gfx =3D self.gfx_maintarget
+	local gfx  =3D self.gfx_maintarget
+	local gfx2 =3D self.gfx_maintarget_line
 	if (self.maintarget_serial) then
 		gfx:SetVisible(true)
+		gfx2:SetVisible(true)
 		gfx:SetText(name)
 	else
 		gfx:SetVisible(false)
+		gfx2:SetVisible(false)
 	end
 end
 =

@@ -111,13 +115,19 @@
 			zloc =3D self.maintarget_last_zloc
 		end
 		local zadd =3D 10
-		local gfx =3D self.gfx_maintarget
-		local px,py =3D gCurrentRenderer:UOPosToPixelPos(xloc,yloc,zloc+zadd)
+		local gfx  =3D self.gfx_maintarget
+		local gfx2 =3D self.gfx_maintarget_line
+		local px,py =3D gCurrentRenderer:UOPosToPixelPos(xloc,yloc,zloc)
 		local w,h =3D gfx:GetSize()
-		local minx,miny,maxx,maxy =3D 0,64,gViewportW-200,gViewportH-32
-		local x =3D max(minx,min(maxx-w,px or 0))
-		local y =3D max(miny,min(maxy-h,py or 0))
+		local minx,miny,maxx,maxy =3D 0,64,gViewportW-160,gViewportH-32
+		local x =3D max(minx,min(maxx-w,(px or 0)-0.5*w))
+		local y =3D max(miny,min(maxy-h,(py or 0)))
 		gfx:SetPos(x,y)
+		local f =3D 0.5 -- bigger -> longer line
+		local fi =3D 1 - f
+		local x2 =3D max(minx,min(maxx-w,(px or 0)))*fi + f*gViewportW*0.5
+		local y2 =3D max(miny,min(maxy-h,(py or 0)))*fi + f*gViewportH*0.5
+		gfx2:SetLineList({{x2,y2,0,x,y,0}})
 	end
 end
 =




From no-reply at zwischenwelt.org  Thu Oct 16 00:35:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 22:35:58 -0000
Subject: [Iris-commit] [IRIS] r2586 - in /trunk: lua/lib.macrolist.lua
	plugins/moblist.lua
Message-ID: <20081015223558.AABC81C18780@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 16 00:35:57 2008
New Revision: 2586

Log:
added timeout for MacroCmd_TargetLast

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Oct 16 00:35:57 2008
@@ -73,17 +73,48 @@
 	gMacroLastTargetMemory =3D {}
 	for k,v in pairs(hitobject) do gMacroLastTargetMemory[k] =3D v end
 end
-
-function MacroCmd_TargetLast	(completefun) 		-- repeat the last target	=

+function MacroSetLastTarget (serial)
+	local mobile =3D GetMobile(serial)
+	if (mobile) then gMacroLastTargetMemory =3D { hittype=3DkMousePickHitType=
_Mobile, mobile=3Dmobile } return end
+	local dynamic =3D GetDynamic(serial)
+	if (dynamic) then gMacroLastTargetMemory =3D { hittype=3DkMousePickHitTyp=
e_Dynamic, dynamic=3Dmobile } return end
+end
+
+function MacroCmd_LastTargetVisible ()
+	if (not gMacroLastTargetMemory) then return end
+	if (gMacroLastTargetMemory.hittype =3D=3D kMousePickHitType_Mobile) then
+		local mobile =3D GetMobile(gMacroLastTargetMemory.mobile.serial)
+		return mobile ~=3D nil
+	end
+	if (gMacroLastTargetMemory.hittype =3D=3D kMousePickHitType_Dynamic) then
+		local dynamic =3D GetDynamic(gMacroLastTargetMemory.dynamic.serial)
+		return dynamic ~=3D nil
+	end
+end
+
+-- timeout in ms, defaults to 30 seconds
+function MacroCmd_TargetLast	(completefun,timeout) 		-- repeat the last ta=
rget	=

+	timeout =3D timeout or 30000
 	if (gMacroTargetLastRunning) then return end
+	if (not gMacroLastTargetMemory) then return end
+	=

 	gMacroTargetLastRunning =3D true
-	RegisterListener("Hook_TargetMode_Start",function () =

+	local listener =3D RegisterListener("Hook_TargetMode_Start",function () =

 			if (gMacroLastTargetMemory) then CompleteTargetMode(gMacroLastTargetMem=
ory) end
 			gMacroTargetLastRunning =3D false
 			if (completefun) then completefun() end
 			return true
 		end)
-end
+	if (timeout) then =

+		InvokeLater(timeout,function ()
+				if (not gMacroTargetLastRunning) then return end
+				UnregisterListener("Hook_TargetMode_Start",listener)
+				gMacroTargetLastRunning =3D false
+				print("MacroCmd_TargetLast timeout")
+			end)
+	end
+end
+
 =

 function MacroCmd_TargetGround	(x,y,z, completefun)
 	if (gMacroWaitForTargetActive) then return end
@@ -148,11 +179,13 @@
 		end
 	end
 end
-function MacroCmd_Item_UseByArtID	(artid) -- equals easyuo type
+
+-- hue can be nil for any
+function MacroCmd_Item_UseByArtID	(artid,hue) -- equals easyuo type
 	local backpack_container =3D GetPlayerBackPackContainer()
 	if (not backpack_container) then return end
 	for k,item in pairs(backpack_container:GetContent()) do =

-		if (item.artid =3D=3D artid) then
+		if (item.artid =3D=3D artid and (hue =3D=3D nil or hue =3D=3D item.hue))=
 then
 			Send_DoubleClick(item.serial)
 			return true
 		end

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Thu Oct 16 00:35:57 2008
@@ -78,6 +78,7 @@
 		gfx:SetVisible(true)
 		gfx2:SetVisible(true)
 		gfx:SetText(name)
+		MacroSetLastTarget(serial)
 	else
 		gfx:SetVisible(false)
 		gfx2:SetVisible(false)
@@ -135,6 +136,7 @@
 =

 function gWidgetPrototype.UOMobListItem:Init (parentwidget,params)
 	self:InitAsGroup(parentwidget,params)
+	self:SetIgnoreBBoxHit(false)
 	self:SetConsumeChildHit(true)
 	self.serial =3D params.serial
 	self.mobile =3D params.mobile



From no-reply at zwischenwelt.org  Thu Oct 16 00:37:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 15 Oct 2008 22:37:42 -0000
Subject: [Iris-commit] [IRIS] r2587 - /trunk/data/mymacros.lua.dist
Message-ID: <20081015223742.66F8F1C18780@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 16 00:37:42 2008
New Revision: 2587

Log:
a few sample macros as comments in .dist

Modified:
    trunk/data/mymacros.lua.dist

Modified: trunk/data/mymacros.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/mymacros.lua.dist (original)
+++ trunk/data/mymacros.lua.dist Thu Oct 16 00:37:42 2008
@@ -77,3 +77,23 @@
 SetMacro("del",			function() MacroCmd_Say("[remove") end)
 SetMacro("home",		function() MacroCmd_Say("[tele") end)
 SetMacro("end",			function() MacroCmd_Say("[get z") end)
+
+--[[
+SetMacro("F1",	function() MacroCmd_Item_UseByArtID(3852) end)	-- greater h=
ealth
+SetMacro("F2",	function() MacroCmd_Item_UseByArtID(3847) end)	-- greater c=
ure
+SetMacro("F3",	function() MacroCmd_Item_UseByArtID(3851) end)	-- total ref=
resh
+SetMacro("F4",	function() if (MacroCmd_LastTargetVisible() and MacroCmd_It=
em_UseByArtID(10229)) then MacroCmd_TargetLast(nil,1000) end end) -- fukija
+--~ SetMacro("F4",	function() if (MacroCmd_LastTargetVisible() and MacroCm=
d_Item_UseByArtID(3853)) then MacroCmd_TargetLast(nil,1000) end end) -- exp=
lo pot
+
+SetMacro("alt+a",	function() MacroCmd_Skill("Spirit Speak") end)
+SetMacro("alt+s",	function() MacroCmd_Spell("Greater Heal") end)
+SetMacro("alt+d",	function() MacroCmd_Spell("Arch Cure") end)
+SetMacro("alt+1",	function() MacroCmd_Spell("Magic Arrow") end)
+SetMacro("alt+2",	function() MacroCmd_Spell("Fire Ball") end)
+SetMacro("alt+3",	function() MacroCmd_Spell("FlameStrike") end)
+SetMacro("alt+4",	function() MacroCmd_Spell("Energy Bolt") end)
+SetMacro("alt+C",	function() MacroCmd_Spell("Wither") end)
+SetMacro("alt+T",	function() MacroCmd_Spell("Teleport") end)
+SetMacro("alt+Z",	function() MacroCmd_Spell("Invisibility") end)
+SetMacro("alt+X",	function() MacroCmd_Spell("Meteor Swarm") end)
+]]--



From no-reply at zwischenwelt.org  Thu Oct 16 02:07:18 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 16 Oct 2008 00:07:18 -0000
Subject: [Iris-commit] [IRIS] r2588 - in /trunk: lua/lib.2d.mobile.lua
 plugins/lib.spellbar.lua plugins/moblist.lua
Message-ID: <20081016010011.3067B1524030@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 16 02:07:18 2008
New Revision: 2588

Log:
moblist : fixed sorting. 2d mobile gfx : fixed invisible ghost

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Thu Oct 16 02:07:18 2008
@@ -45,7 +45,8 @@
 end
 =

 function Renderer2D:MobileHasVisibleEquip		(mobile_artid) =

-	return 	mobile_artid =3D=3D 400 or mobile_artid =3D=3D 401 or
+	return 	mobile_artid =3D=3D 400 or mobile_artid =3D=3D 401 or -- human
+			mobile_artid =3D=3D 402 or mobile_artid =3D=3D 403 or -- ghost
 			mobile_artid =3D=3D 744 or mobile_artid =3D=3D 745 -- vamp form
 end
 =


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Thu Oct 16 02:07:18 2008
@@ -187,7 +187,7 @@
 		SpellBarRiseTextOnMob(GetPlayerSerial(),short.r,short.g,short.b,short.tx=
t)
 		if (short.bInterrupt) then SpellBarInterrupt() end
 	end
-	if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet_Loc=
alized_Text",serial,plaintext,text_messagenum) end
+	--~ if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet=
_Localized_Text",serial,plaintext,text_messagenum) end
 end)
 =

 =


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Thu Oct 16 02:07:18 2008
@@ -2,12 +2,16 @@
 if (not gDisabledPlugins.moblist) then =

 =

 kMobList_CatW =3D 100
-kMobList_CatItemH =3D 20
+kMobList_CatItemH =3D 16
 kMobList_CatItemBarH =3D 5
-kMobList_CatDist =3D 4
+kMobList_CatItemBarYOff =3D 4
+kMobList_CatDist =3D 0
 =

 kMobList_Healer_Text =3D " the wandering healer"
 kMobList_Escort_Text =3D " the seeker of adventure"
+
+kMobNotoriety_Green =3D 2 -- friend (necro familiar,pets)
+kMobNotoriety_Red =3D 6 -- murderer (summons,evortex)
 =

 kMobListCat_Self	=3D 1
 kMobListCat_Friends	=3D 2
@@ -143,10 +147,11 @@
 	self.moblist =3D params.moblist
 	self.text =3D self:CreateChild("UOText",{x=3D0,y=3D0,text=3D"",col=3D{r=
=3D1,g=3D1,b=3D1},fontid=3D2,bold=3Dtrue})
 	self.text:SetIgnoreBBoxHit(false)
+	self.bNameUnknown =3D true
 	=

 	local mobile =3D params.mobile
 	local w,h =3D kMobList_CatW,kMobList_CatItemBarH
-	local xoff,yoff =3D 0,kMobList_CatItemH-kMobList_CatItemBarH
+	local xoff,yoff =3D 0,kMobList_CatItemH+kMobList_CatItemBarYOff-kMobList_=
CatItemBarH
 	self.fillw =3D w
 	self.fillh =3D h
 	=

@@ -161,47 +166,53 @@
 end
 =

 function gWidgetPrototype.UOMobListItem:UpdateName(name,clilocid)
-	if (name) then self.lowname =3D name self.namecliloc =3D clilocid end
+	if (name) then self.lowname =3D name end
+	if (clilocid) then self.namecliloc =3D clilocid end
 	local tooltip =3D AosToolTip_GetText(self.serial)
-	local text =3D tooltip or self.lowname or "unknown"
-	if (self.old_fulltext =3D=3D text) then return end
-	self.old_fulltext =3D text
-	text =3D string.gsub(text,"\n.*","") -- only keep first line
-	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
-	text =3D string.gsub(text," %[","%[") -- move guildtag closer
-	text =3D string.gsub(text,"^Lord","")
-	text =3D string.gsub(text,"^Lady","")
-	text =3D string.gsub(text,"^an ","")
-	text =3D string.gsub(text,"^a ","")
-	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
-	text =3D string.gsub(text,"[ \t]+$","") -- remove trailing spaces
-	=

-	-- npcs friends
-	self.bIsNPC =3D false =

-	if (StringContains(text,kMobList_Healer_Text)) then self.bIsNPC =3D true =
text =3D "[HEALER]"..string.gsub(text,kMobList_Healer_Text,"") end
-	if (StringContains(text,kMobList_Escort_Text)) then self.bIsNPC =3D true =
text =3D "[ESCORT]"..string.gsub(text,kMobList_Escort_Text,"") end
-	=

-	self.old_text =3D text
-	=

-	-- check friends
-	self.bIsFriendlyGuild =3D false
-	for k,guildtag in pairs(gFriendlyGuildTags) do if (StringContains(text,gu=
ildtag)) then self.bIsFriendlyGuild =3D true break end end
-	=

-	-- check pets
-	self.bIsPet =3D StringContains(text,"(summoned)") or StringContains(text,=
"(tame)")
-	local mobile =3D self.mobile
-	if (mobile.artid =3D=3D 574 and mobile.hue =3D=3D 0) then self.bIsPet =3D=
 true end -- blade spirit
-	if (mobile.artid =3D=3D 164 and mobile.hue =3D=3D 0) then self.bIsPet =3D=
 true end -- energy vortex
-	=

-	self:UpdateNameGfx()
+	local text =3D tooltip or self.lowname
+	self.bNameUnknown =3D false
+	if (not text) then self.bNameUnknown =3D true text =3D "unknown" end
+	local bNameUpdate =3D false
+	if (self.old_fulltext ~=3D text) then =

+		self.old_fulltext =3D text
+		bNameUpdate =3D true
+		text =3D string.gsub(text,"\n.*","") -- only keep first line
+		text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
+		text =3D string.gsub(text," %[","%[") -- move guildtag closer
+		text =3D string.gsub(text,"^Lord","")
+		text =3D string.gsub(text,"^Lady","")
+		text =3D string.gsub(text,"^an ","")
+		text =3D string.gsub(text,"^a ","")
+		text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
+		text =3D string.gsub(text,"[ \t]+$","") -- remove trailing spaces
+		=

+		-- npcs friends
+		self.bIsNPC =3D false =

+		if (StringContains(text,kMobList_Healer_Text)) then self.bIsNPC =3D true=
 text =3D "[HEALER]"..string.gsub(text,kMobList_Healer_Text,"") end
+		if (StringContains(text,kMobList_Escort_Text)) then self.bIsNPC =3D true=
 text =3D "[ESCORT]"..string.gsub(text,kMobList_Escort_Text,"") end
+		=

+		self.old_text =3D text
+		=

+		-- check friends
+		self.bIsFriendlyGuild =3D false
+		for k,guildtag in pairs(gFriendlyGuildTags) do if (StringContains(text,g=
uildtag)) then self.bIsFriendlyGuild =3D true break end end
+		if (StringContains(text,"hazk")) then print("ghaz:",self.bIsFriendlyGuil=
d) end
+		=

+		-- check pets
+		self.bIsPet =3D StringContains(text,"(summoned)") or StringContains(text=
,"(tame)")
+		local mobile =3D self.mobile
+		if (mobile.artid =3D=3D 574 and mobile.hue =3D=3D 0) then self.bIsPet =
=3D true end -- blade spirit
+		if (mobile.artid =3D=3D 164 and mobile.hue =3D=3D 0) then self.bIsPet =
=3D true end -- energy vortex
+	end
 	self:RecalcCat()
+	if (bNameUpdate) then self:UpdateNameGfx() end
 end
 =

 function gWidgetPrototype.UOMobListItem:UpdateNameGfx()
 	local mobile =3D self.mobile
 	local r,g,b =3D GetNotorietyColor(mobile.notoriety)
 	self.text.params.col =3D {r=3Dr,g=3Dg,b=3Db}
-	self.text:SetText(self.old_text)
+	self.text:SetText(self.old_text) -- .." "..self.cat
 end
 =

 function gWidgetPrototype.UOMobListItem:SetSelfAsMainTarget ()
@@ -212,6 +223,7 @@
 	local mobile =3D self.mobile
 	if (self.old_notoriety ~=3D mobile.notoriety) then =

 		self.old_notoriety  =3D mobile.notoriety
+		self:RecalcCat()
 		self:UpdateNameGfx()
 		-- todo : update bar-background color ? not visible when full hp ?
 	end
@@ -231,11 +243,15 @@
 end
 =

 function gWidgetPrototype.UOMobListItem:RecalcCat ()
-	local serial =3D self.serial
+	local serial =3D self.serial	=

+	if (self.bNameUnknown) then 								return self:SetCat(kMobListCat_Rest) =
end
 	if (GetPlayerSerial() =3D=3D serial) then						return self:SetCat(kMobLis=
tCat_Self) end
 	if (IsMobileInParty(serial) or self.bIsFriendlyGuild) then	return self:Se=
tCat(kMobListCat_Friends) end
-	if (self.bIsPet) then										return self:SetCat(kMobListCat_Pets) end
+	if (self.bIsPet) then										return self:SetCat(kMobListCat_Pets) end =

+	if (self.namecliloc and self.mobile.notoriety =3D=3D kMobNotoriety_Green)=
 then return self:SetCat(kMobListCat_Pets) end =

+	if (self.namecliloc and self.mobile.notoriety =3D=3D kMobNotoriety_Red) t=
hen return self:SetCat(kMobListCat_Pets) end =

 	if (self.namecliloc or self.bIsNPC) then 					return self:SetCat(kMobList=
Cat_Rest) end
+	if (self.mobile.notoriety =3D=3D kMobNotoriety_Green) then 	return self:S=
etCat(kMobListCat_Friends) end =

 	return self:SetCat(kMobListCat_Players)
 end
 =

@@ -243,6 +259,7 @@
 	if (self.cat =3D=3D cat) then return end
 	self.cat =3D cat
 	self.params.moblist.bNeedsReGroup =3D true
+	self:UpdateNameGfx()
 end
 =

 function gWidgetPrototype.UOMobListItem:ReGroup (catgrouplist)



From no-reply at zwischenwelt.org  Thu Oct 16 14:36:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 16 Oct 2008 12:36:19 -0000
Subject: [Iris-commit] [IRIS] r2589 - /trunk/lua/net/net.other.lua
Message-ID: <20081016123619.91F171C18799@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 16 14:36:16 2008
New Revision: 2589

Log:
added hooks for Hook_OpenServersideGump OpenPopupMenu

Modified:
    trunk/lua/net/net.other.lua

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Thu Oct 16 14:36:16 2008
@@ -231,6 +231,7 @@
 		end
 		=

 		DisplayPopupMenu(popupmenu) -- see net.popup.lua
+		NotifyListener("Hook_OpenPopupMenu",popupmenu)	=

 	end
 =

 	-- enable diff files for felucca,trammel,ilshenar,malas
@@ -916,7 +917,8 @@
 		printdebug("gump",sprintf("newgump.textline[%d](len=3D%d)=3D\n",i,textle=
n),newgump.textline[i])
 	end
 =

-	GumpParser(newgump)
+	local dialog =3D GumpParser(newgump)
+	NotifyListener("Hook_OpenServersideGump",dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data)	=

 end
 =

 function UniCodeDualPop (fifo,number_of_unicode_chars)
@@ -1006,7 +1008,8 @@
 		local unknownterminator=3Dinput:PopNetUint32()
 	end
 =

-	GumpParser(newgump)
+	local dialog =3D GumpParser(newgump)
+	NotifyListener("Hook_OpenServersideGump",dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data,true)	=

 end
 =

 =




From no-reply at zwischenwelt.org  Thu Oct 16 19:15:23 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 16 Oct 2008 17:15:23 -0000
Subject: [Iris-commit] [IRIS] r2590 - in /trunk: lua/ lua/net/ lua/obj/
	lua/widgets/ plugins/
Message-ID: <20081016180003.675441C18428@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 16 19:15:21 2008
New Revision: 2590

Log:
fixed drop on container/autostack by server, gold-lootscript (tokuchamp), i=
mproved moblist a bit (red-human-enemies : ronins,cannibals,brigards..)

Added:
    trunk/plugins/loot.lua
Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/lib.uodragdrop.lua
    trunk/lua/net/net.dynamic.lua
    trunk/lua/net/net.uodragdrop.lua
    trunk/lua/obj/obj.container.lua
    trunk/lua/obj/obj.player.lua
    trunk/lua/widgets/widget.uocontaineritem.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Thu Oct 16 19:15:21 2008
@@ -490,6 +490,7 @@
 gAlwaysRun =3D false
 -- gReActivateWeaponAbilityInterval =3D 3100  -- don't reactivate if nil
 gDisabledPlugins.moblist =3D true
+gDisabledPlugins.loot =3D true
 gFriendlyGuildTags =3D {} -- gFriendlyGuildTags =3D {"[ABC]","[DEF]"} -- u=
sed by moblist plugin
 gEnableWalkLog =3D false
 =


Modified: trunk/lua/lib.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uodragdrop.lua (original)
+++ trunk/lua/lib.uodragdrop.lua Thu Oct 16 19:15:21 2008
@@ -364,6 +364,9 @@
 			local targettiletype =3D {}
 			targettiletype =3D GetStaticTileType(gMousePickFoundHit.item.artid)
 =

+			x =3D 0xffff
+			y =3D 0xffff
+			z =3D 0
 			target =3D gMousePickFoundHit.item.serial =

 			--[[
 			-- if the item beneath has the same artid and stackable, try to stack t=
hem
@@ -408,6 +411,11 @@
 		=

 		-- todo : stack ?
 		Send_Drop_Object(item.serial,x-kSecureTradeContainerPos_LeftX,y-kSecureT=
radeContainerPos_LeftY,z,target)
+	elseif (gMousePickFoundHit and =

+			gMousePickFoundHit.hittype =3D=3D kMousePickHitType_PaperdollItem and =

+			gMousePickFoundHit.item and gMousePickFoundHit.item.layer =3D=3D kLayer=
_Backpack) then =

+		-- drop on packpack in paperdoll
+		Send_Drop_Object_AutoStack(item.serial,gMousePickFoundHit.item.serial)
 	elseif (dialog_under_mouse and dialog_under_mouse.uoPaperdoll) then
 		-- drop on paperdoll
 		local paperdoll =3D dialog_under_mouse.uoPaperdoll
@@ -451,6 +459,7 @@
 		=

 		if (iSerial and iSerial ~=3D 0) then =

 			-- drop on mobile,dynamic etc =

+			print("drop on mobile,dynamic etc ")
 			printdebug("dragdrop","MouseUpUODragDrop: drop on worlobject : ",item.s=
erial,item.amount,x,y,z,iSerial)
 			Send_Drop_Object(item.serial,x,y,z,iSerial)
 		else

Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Thu Oct 16 19:15:21 2008
@@ -112,6 +112,7 @@
 		CreateOrUpdateDynamic(dynamicdata)
 	end
 	if (iLastSerial) then Update_Spellbook(iLastSerial) end
+	NotifyListener("Hook_Container_Contents",iLastSerial)
 end
 =

 -- This is sent by the server to add/update a single item to a container. =
(response to player dragdrop)

Modified: trunk/lua/net/net.uodragdrop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.uodragdrop.lua (original)
+++ trunk/lua/net/net.uodragdrop.lua Thu Oct 16 19:15:21 2008
@@ -19,16 +19,20 @@
 	out:SendPacket()
 end
 =

+
+function Send_Drop_Object_AutoStack (serial,containerid) Send_Drop_Object(=
serial,0xffff,0xffff,0,containerid) end
+
 -- This is sent by the client when the player drops an item. 0x08
 -- containerid =3D 0xFFFFFFFF  when the container is the ground
 function Send_Drop_Object(serial,x,y,z,containerid)
+	--~ print("Send_Drop_Object",_TRACEBACK())
 	printdebug("net","NET: Send_Drop_Object:",sprintf("0x%08x",serial),x,y,z,=
containerid)
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Drop_Object)
 	out:PushNetUint32(serial)
-	out:PushNetUint16(x)
-	out:PushNetUint16(y)
-	out:PushInt8(z) -- SIGNED !!
+	out:PushNetUint16(x) -- 0xffff for autostack
+	out:PushNetUint16(y) -- 0xffff for autostack
+	out:PushInt8(z) -- SIGNED !!   -- 0 for autostack
 	if (ClientVersionIsPost6017()) then out:PushInt8(0) end
 	out:PushNetUint32(containerid)
 	out:SendPacket()

Modified: trunk/lua/obj/obj.container.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.container.lua (original)
+++ trunk/lua/obj/obj.container.lua Thu Oct 16 19:15:21 2008
@@ -103,7 +103,7 @@
 	if (not container.dialog) then container.dialog =3D CreateUOContainerDial=
og(container) end
 	gLastDebugContainer =3D container
 	RefreshContainerItemWidgets(container)
-	NotifyListener("Hook_OpenContainer",container.dialog,container.serial)
+	NotifyListener("Hook_OpenContainer",container.dialog,container.serial,con=
tainerdata.gumpid)
 end
 =

 -- packet handlers for containers (chests, drawers, inventory..)

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Thu Oct 16 19:15:21 2008
@@ -27,6 +27,13 @@
 	end
 end
 =

+-- returns cur,max
+function GetPlayerWeight ()
+	local playermobile =3D GetPlayerMobile()
+	local stats =3D playermobile and playermobile.stats
+	if (stats) then return stats.curWeight,stats.maxWeight end
+end
+
 function IsPlayerGhost ()
 	local playermobile =3D GetPlayerMobile()
 	return playermobile and playermobile.bIsGhost
@@ -47,6 +54,8 @@
 	local mobile =3D GetPlayerMobile()
 	return mobile and mobile.name
 end
+
+function GetPlayerBackPackSerial () return gPlayerBackPack and gPlayerBack=
Pack.serial end
 =

 function GetPlayerBackPackContainer ()
 	if (not gPlayerBackPack) then return end -- not yet received from server

Modified: trunk/lua/widgets/widget.uocontaineritem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uocontaineritem.lua (original)
+++ trunk/lua/widgets/widget.uocontaineritem.lua Thu Oct 16 19:15:21 2008
@@ -27,7 +27,8 @@
 		self.gfx_stackside	=3D self:CreateChild("UOImage",{x=3D5,y=3D5,gump_id=
=3Dgump_id,art_id=3Dart_id,hue=3Ditem.hue})
 	end
 	=

-	self:SetPos(item.xloc,item.yloc + (item.gumpyoffset or 0))
+	local maxx,maxy =3D 200,200
+	self:SetPos(min(maxx,item.xloc),min(maxy,item.yloc + (item.gumpyoffset or=
 0)))
 	=

 	if (gTooltipSupport and self) then
 		self.tooltip_offx =3D kUOToolTippOffX

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Thu Oct 16 19:15:21 2008
@@ -172,6 +172,8 @@
 gSpellbarShortMessages[500112] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
n"			} -- You are now under the protection of the town guards. =

 gSpellbarShortMessages[500113] =3D {r=3D0.5,g=3D0,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

 gSpellbarShortMessages[501942] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"locatio=
n blocked"	} -- That location is blocked.           =

+gSpellbarShortMessages[500119] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"mustwai=
t"			} -- You must wait to perform another action.     =

+gSpellbarShortMessages[500446] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"too far=
"			} -- That is too far away.  =

 =

 --[[
 Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091
@@ -187,7 +189,11 @@
 		SpellBarRiseTextOnMob(GetPlayerSerial(),short.r,short.g,short.b,short.tx=
t)
 		if (short.bInterrupt) then SpellBarInterrupt() end
 	end
-	--~ if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet=
_Localized_Text",serial,plaintext,text_messagenum) end
+	if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet_Loc=
alized_Text",serial,plaintext,text_messagenum) end
+	if (serial ~=3D 0xFFFFFFFF) then
+		local r,g,b =3D 1,1,0 -- yellow
+		SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
+	end
 end)
 =

 =


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Thu Oct 16 19:15:21 2008
@@ -166,8 +166,7 @@
 end
 =

 function gWidgetPrototype.UOMobListItem:UpdateName(name,clilocid)
-	if (name) then self.lowname =3D name end
-	if (clilocid) then self.namecliloc =3D clilocid end
+	if (name and (not self.lowname)) then self.lowname =3D name self.nameclil=
oc =3D clilocid end
 	local tooltip =3D AosToolTip_GetText(self.serial)
 	local text =3D tooltip or self.lowname
 	self.bNameUnknown =3D false
@@ -244,14 +243,18 @@
 =

 function gWidgetPrototype.UOMobListItem:RecalcCat ()
 	local serial =3D self.serial	=

+	local mobile =3D self.mobile
 	if (self.bNameUnknown) then 								return self:SetCat(kMobListCat_Rest) =
end
 	if (GetPlayerSerial() =3D=3D serial) then						return self:SetCat(kMobLis=
tCat_Self) end
 	if (IsMobileInParty(serial) or self.bIsFriendlyGuild) then	return self:Se=
tCat(kMobListCat_Friends) end
 	if (self.bIsPet) then										return self:SetCat(kMobListCat_Pets) end =

-	if (self.namecliloc and self.mobile.notoriety =3D=3D kMobNotoriety_Green)=
 then return self:SetCat(kMobListCat_Pets) end =

-	if (self.namecliloc and self.mobile.notoriety =3D=3D kMobNotoriety_Red) t=
hen return self:SetCat(kMobListCat_Pets) end =

-	if (self.namecliloc or self.bIsNPC) then 					return self:SetCat(kMobList=
Cat_Rest) end
-	if (self.mobile.notoriety =3D=3D kMobNotoriety_Green) then 	return self:S=
etCat(kMobListCat_Friends) end =

+	if (self.namecliloc) then
+		if (mobile.notoriety =3D=3D kMobNotoriety_Green) then return self:SetCat=
(kMobListCat_Pets) end =

+		local bIsHuman =3D mobile.artid =3D=3D 400 or mobile.artid =3D=3D 401  -=
- red humands like brigards,cannibals,ronins,ninjas...
+		if (mobile.notoriety =3D=3D kMobNotoriety_Red and (not bIsHuman)) then r=
eturn self:SetCat(kMobListCat_Pets) end -- evortex,undead..
+	end
+	if (self.namecliloc or self.bIsNPC) then 			return self:SetCat(kMobListCa=
t_Rest) end
+	if (mobile.notoriety =3D=3D kMobNotoriety_Green) then 	return self:SetCat=
(kMobListCat_Friends) end =

 	return self:SetCat(kMobListCat_Players)
 end
 =




From no-reply at zwischenwelt.org  Thu Oct 16 20:20:27 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 16 Oct 2008 18:20:27 -0000
Subject: [Iris-commit] [IRIS] r2591 - in /trunk: lua/lib.2d.mousepick.lua
 lua/lib.macrolist.lua lua/lib.mousepick.lua lua/main.lua
 lua/widgets/widget.uocontainer.lua plugins/loot.lua
Message-ID: <20081016182027.7F4C31C18799@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 16 20:20:26 2008
New Revision: 2591

Log:
loot-helper : callback for when packback full, macrolist : finditem helpers=
, container-backpane mousepick fix, mymacros now executed AFTER plugins, to=
 allow using plugin functions during macro setup

Modified:
    trunk/lua/lib.2d.mousepick.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.mousepick.lua
    trunk/lua/main.lua
    trunk/lua/widgets/widget.uocontainer.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Thu Oct 16 20:20:26 2008
@@ -105,8 +105,11 @@
 		if (o.hittype =3D=3D kMousePickHitType_Mobile 			) then hitinfo =3D hiti=
nfo.."mobile" end
 		if (o.hittype =3D=3D kMousePickHitType_ContainerItem 	) then hitinfo =3D=
 hitinfo.."containeritem" end
 		if (o.hittype =3D=3D kMousePickHitType_PaperdollItem 	) then hitinfo =3D=
 hitinfo.."paperdollitem" end
-		if (o.hittype =3D=3D kMousePickHitType_Container 		) then hitinfo =3D hi=
tinfo.."container" end
 		if (o.hittype =3D=3D kMousePickHitType_Ground 			) then hitinfo =3D hiti=
nfo.."ground" end
+		if (o.hittype =3D=3D kMousePickHitType_Container 		) then =

+			hitinfo =3D hitinfo..sprintf("container(id=3D0x%08x)",o.container and o=
.container.serial or 0) =

+			--~ print(sprintf("container(id=3D0x%08x)",o.container and o.container.=
serial or 0))
+		end
 	end
 	Client_SetBottomLine(hitinfo)
 end

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Oct 16 20:20:26 2008
@@ -168,26 +168,31 @@
 end
 =

 =

-function MacroCmd_Item_UseByName	(itemnamepart)
-	local backpack_container =3D GetPlayerBackPackContainer()
-	if (not backpack_container) then return end
-	for k,item in pairs(backpack_container:GetContent()) do =

-		local name =3D GetStaticTileTypeName(item.artid)
+function MacroCmd_Item_Use	(item) if (item) then Send_DoubleClick(item.ser=
ial) return item end end
+
+function MacroCmd_Item_UseByName	(itemnamepart)	return MacroCmd_Item_Use(M=
acroCmd_Item_FindByName(itemnamepart)) end
+function MacroCmd_Item_UseByArtID	(artid,hue)		return MacroCmd_Item_Use(Ma=
croCmd_Item_FindByArtID(artid,hue)) end
+
+-- container defaults to player-backpack
+function MacroCmd_Item_FindByName	(itemnamepart,container)
+	container =3D container or GetPlayerBackPackContainer()
+	if (not container) then return end
+	for k,item in pairs(container:GetContent()) do =

+		local name =3D AosToolTip_GetText(item.serial) or GetStaticTileTypeName(=
item.artid)
 		if (name and string.find(name,itemnamepart)) then
-			Send_DoubleClick(item.serial)
-			return true
-		end
-	end
-end
-
+			return item
+		end
+	end
+end
+
+-- container defaults to player-backpack
 -- hue can be nil for any
-function MacroCmd_Item_UseByArtID	(artid,hue) -- equals easyuo type
-	local backpack_container =3D GetPlayerBackPackContainer()
-	if (not backpack_container) then return end
-	for k,item in pairs(backpack_container:GetContent()) do =

+function MacroCmd_Item_FindByArtID	(artid,hue,container) -- equals easyuo =
type
+	container =3D container or GetPlayerBackPackContainer()
+	if (not container) then return end
+	for k,item in pairs(container:GetContent()) do =

 		if (item.artid =3D=3D artid and (hue =3D=3D nil or hue =3D=3D item.hue))=
 then
-			Send_DoubleClick(item.serial)
-			return true
+			return item
 		end
 	end
 end

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Thu Oct 16 20:20:26 2008
@@ -60,6 +60,11 @@
 			gMousePickFoundHit =3D {}
 			gMousePickFoundHit.hittype =3D kMousePickHitType_Container
 			gMousePickFoundHit.container =3D widget.dialog.uoContainer
+			gMousePickFoundHit.is2DHit =3D true
+		elseif widget.uoContainer then
+			gMousePickFoundHit =3D {}
+			gMousePickFoundHit.hittype =3D kMousePickHitType_Container
+			gMousePickFoundHit.container =3D widget.uoContainer
 			gMousePickFoundHit.is2DHit =3D true
 		elseif widget.mobile then
 			local mobile =3D widget.mobile

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct 16 20:20:26 2008
@@ -134,21 +134,23 @@
 --###        MACROS           ###
 --###############################
 =

-dofile(gMacroPathFallback)
-
-if (file_exists(gMacroPath)) then
-	-- execute local config
-	dofile(gMacroPath)
-else
-	-- no local config file, copy dist config
-	local fp =3D io.open(gMacroPath,"w")
-	fp:write("-- this is your local macro file, here you can configure your m=
acro commands\n")
-	for line in io.lines(gMacroPathFallback) do =

-		if (not string.find(line,"DO NOT EDIT THIS FILE DIRECTLY")) then =

-			fp:write(line.."\n") =

-		end =

-	end
-	fp:close()
+function LoadMacros ()
+	dofile(gMacroPathFallback)
+
+	if (file_exists(gMacroPath)) then
+		-- execute local config
+		dofile(gMacroPath)
+	else
+		-- no local config file, copy dist config
+		local fp =3D io.open(gMacroPath,"w")
+		fp:write("-- this is your local macro file, here you can configure your =
macro commands\n")
+		for line in io.lines(gMacroPathFallback) do =

+			if (not string.find(line,"DO NOT EDIT THIS FILE DIRECTLY")) then =

+				fp:write(line.."\n") =

+			end =

+		end
+		fp:close()
+	end
 end
 =

 --###############################
@@ -308,6 +310,7 @@
 	=

 	LoadPlugins_Iris()
 	LoadWidgets(gIrisWidgetDir)
+	LoadMacros()
 	NotifyListener("Hook_PluginsLoaded")
 	=

 	gMyTicks =3D Client_GetTicks()

Modified: trunk/lua/widgets/widget.uocontainer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uocontainer.lua (original)
+++ trunk/lua/widgets/widget.uocontainer.lua Thu Oct 16 20:20:26 2008
@@ -17,6 +17,7 @@
 	self.params			=3D params
 	self.uoContainer	=3D container
 	self.backpane		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dcont=
ainer.gumpid})
+	self.backpane.uoContainer =3D container
 	self.items 			=3D self:CreateChild("Group") -- for sub-widgets
 	=

 	local x,y =3D GetDesktopElementPosition("container",container.serial)

Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Thu Oct 16 20:20:26 2008
@@ -1,14 +1,21 @@
+-- TODO : detect server rejects item move (wait for object-to-object or ob=
ject destroy message of the item being moved?)
 =

 if (not gDisabledPlugins.loot) then =

+
+function LootSetBackPackFullCallBack (fun) gLootBPFullCallBack =3D fun end
 =

 kCorpseContainerGumpID =3D 9
 kLootArtID_Gold =3D 3823
 kLoot_GoldWeight =3D 20/1000 -- 1000gold =3D 20 stones
+-- artid=3D3791,3794,...(not corpse-art-id) : bones after animate undead
 =

 gAutoLootNextT =3D 0
 gAutoLootInterval =3D 750
 =

-gLoot_TrashCorpseTypes =3D { 35,36 } --lizzardmen
+gLoot_TrashCorpseTypes =3D { =

+	35,36,  --lizzardmen
+	240, -- kappa
+	}
 gLoot_TrashCorpseTypesByID =3D {}
 for k,v in pairs(gLoot_TrashCorpseTypes) do gLoot_TrashCorpseTypesByID[v] =
=3D true end
 =

@@ -87,6 +94,7 @@
 			local w =3D ceil(item.amount * kLoot_GoldWeight)
 			if (curw and maxw and curw + w > maxw) then
 				SpellBarRiseTextOnMob(GetPlayerSerial(),1,0.5,0,"backpack full!")
+				if (gLootBPFullCallBack) then gLootBPFullCallBack() end
 				LootCancel() -- don't hide this corpse
 				return
 			else



From no-reply at zwischenwelt.org  Thu Oct 16 20:24:21 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 16 Oct 2008 18:24:21 -0000
Subject: [Iris-commit] [IRIS] r2592 - /trunk/lua/lib.macrolist.lua
Message-ID: <20081016182421.2CA761C1870E@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 16 20:24:20 2008
New Revision: 2592

Log:
avoid macros while textfields active (gui2), or consumed by other means

Modified:
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Oct 16 20:24:20 2008
@@ -338,7 +338,7 @@
 end
 =

 RegisterListener("keydown",function (keycode,char,bConsumed) =

-	if (not gActiveEditText) then TriggerMacros(keycode) end
+	if (not bConsumed) then TriggerMacros(keycode) end
 end)
 =

 =




From no-reply at zwischenwelt.org  Fri Oct 17 01:32:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 16 Oct 2008 23:32:36 -0000
Subject: [Iris-commit] [IRIS] r2593 - /trunk/plugins/loot.lua
Message-ID: <20081017000005.487271C18780@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 17 01:32:36 2008
New Revision: 2593

Log:
improved loothelper a bit

Modified:
    trunk/plugins/loot.lua

Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Fri Oct 17 01:32:36 2008
@@ -8,6 +8,8 @@
 kLootArtID_Gold =3D 3823
 kLoot_GoldWeight =3D 20/1000 -- 1000gold =3D 20 stones
 -- artid=3D3791,3794,...(not corpse-art-id) : bones after animate undead
+
+gLootFinishedCorpses =3D {}
 =

 gAutoLootNextT =3D 0
 gAutoLootInterval =3D 750
@@ -27,22 +29,23 @@
 =

 =

 function FindNearbyCorpse (maxdist)
+	local res
 	maxdist =3D maxdist or 2
 	local xloc,yloc =3D GetPlayerPos()
 	for k,dynamic in pairs(GetDynamicList()) do =

-		if (DynamicIsInWorld(dynamic) and =

-			dynamic.artid_base =3D=3D kCorpseDynamicArtID and =

-			abs(dynamic.xloc-xloc) + abs(dynamic.yloc-yloc) <=3D maxdist) then =

-			if (gLoot_TrashCorpseTypesByID[dynamic.amount]) then
+		if (DynamicIsInWorld(dynamic) and dynamic.artid_base =3D=3D kCorpseDynam=
icArtID) then =

+			if (gLoot_TrashCorpseTypesByID[dynamic.amount] or gLootFinishedCorpses[=
dynamic.serial]) then
 				LootHideCorpse(dynamic)
-			else
-				return dynamic
+			elseif (abs(dynamic.xloc-xloc) + abs(dynamic.yloc-yloc) <=3D maxdist) t=
hen
+				res =3D dynamic
 			end
 		end
 	end
+	return res
 end
 =

 function LootHideCorpse (dynamic) =

+	gLootFinishedCorpses[dynamic.serial] =3D true
 	dynamic:Destroy()
 	--~ gCurrentRenderer:RemoveDynamicItem(corpse) -- hide corpse =

 end



From no-reply at zwischenwelt.org  Fri Oct 17 19:58:51 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 17 Oct 2008 17:58:51 -0000
Subject: [Iris-commit] [IRIS] r2594 - in /trunk: lua/lib.equipment.lua
 lua/lib.macrolist.lua lua/lib.spellbooks.lua lua/main.lua
 lua/net/net.object.lua plugins/lib.spellbar.lua plugins/loot.lua
Message-ID: <20081017175851.5B0BD1C18354@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 17 19:58:50 2008
New Revision: 2594

Log:
loot : switched from manhatten to euklidean dist, spellbar: generalised equ=
ip-fc-analysis and casttime calc and moved to libs, added Hook_Spell_Interr=
upt, added a few utils for macros (dismount,dress/equip,findmob)

Added:
    trunk/lua/lib.equipment.lua
Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.spellbooks.lua
    trunk/lua/main.lua
    trunk/lua/net/net.object.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Fri Oct 17 19:58:50 2008
@@ -167,6 +167,33 @@
 	LoadMap(gMapIndex)
 end
 =

+function MacroCmd_Dress (dresslist)
+	for k,serial in pairs(dresslist) do MacroCmd_EquipItem(serial) end
+end
+
+function MacroCmd_EquipItem (serial)
+	local item =3D GetDynamic(serial)
+	if (not item) then return end
+	if (item.iContainerSerial =3D=3D GetPlayerSerial()) then return end -- al=
ready equipped
+	local layer =3D GetPaperdollLayerFromTileType(item.artid)
+	print("MacroCmd_EquipItem",serial,item.amount,layer)
+	Send_Take_Object(item.serial,item.amount)
+	Send_Equip_Item_Request(item.serial,layer,GetPlayerSerial())
+	return true
+end
+
+function MacroCmd_IsMounted ()
+	local playermobile =3D GetPlayerMobile()
+	return playermobile and GetMobileEquipmentItem(playermobile,kLayer_Mount)
+end
+function MacroCmd_Dismount ()
+	if (MacroCmd_IsMounted()) then Send_DoubleClick(GetPlayerSerial()) return=
 true end -- todo : check if mounted
+end
+
+function MacroCmd_RiseText (r,g,b,text,serial)
+	serial =3D serial or GetPlayerSerial()
+	if (SpellBarRiseTextOnMob) then SpellBarRiseTextOnMob(serial,r,g,b,text) =
end
+end
 =

 function MacroCmd_Item_Use	(item) if (item) then Send_DoubleClick(item.ser=
ial) return item end end
 =

@@ -195,6 +222,21 @@
 			return item
 		end
 	end
+end
+
+function MacroCmd_FindNearestMobByName (namepart)
+	local founddist,foundmob
+	local xloc,yloc =3D GetPlayerPos()
+	for k,mobile in pairs(GetMobileList()) do =

+		local dist =3D dist2(xloc,yloc,mobile.xloc,mobile.yloc)
+		if ((not founddist) or dist < founddist) then =

+			if (StringContains(AosToolTip_GetText(mobile.serial) or mobile.name,nam=
epart)) then
+				founddist =3D dist
+				foundmob =3D mobile
+			end
+		end
+	end
+	return foundmob
 end
 =

 -- set itemserial =3D 0 to clear
@@ -226,11 +268,12 @@
 	Send_Request_SkillUse(skillid)
 end
 =

-function MacroCmd_Spell					(spellname)
+function MacroCmd_Spell					(spellname,target)
 	if (not gInGameStarted) then return end
 	local spellid =3D GetSpellIDByName(spellname)
 	if (not spellid) then return MacroErrorNameMismatch("MacroCmd_Spell",spel=
lname,gSpellIDByName) end
 	Send_Spell(spellid)
+	--~ if (target) then        TODO
 end
 =

 =


Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Fri Oct 17 19:58:50 2008
@@ -408,6 +408,18 @@
 =

 gMagerySpellMana =3D { 4, 6, 9, 11, 14, 20, 40, 50 }
 =

+-- uses GetEquipProps() for player
+-- you should add kSpellTimeLatency for network
+function GetSpellCastTimeForPlayer (spellid)
+	local equipprop =3D GetEquipProps()
+	return GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Protection(),Is=
BuffActive_EssenceOfWind())
+end
+
+gSpellInterruptMessages =3D { [500946 ]=3Dtrue,[502632 ]=3Dtrue,[500641 ]=
=3Dtrue,[502625 ]=3Dtrue,[1049645]=3Dtrue, } -- notintown,fizz,disturbed,no=
mana,toomanyfollowers
+RegisterListener("Hook_Packet_Localized_Text",function (serial,plaintext,t=
ext_messagenum) =

+	if (gSpellInterruptMessages[text_messagenum]) then NotifyListener("Hook_S=
pell_Interrupt",serial,plaintext,text_messagenum) end
+end)
+
 =

 --[[
 		public virtual TimeSpan GetCastDelay()

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Fri Oct 17 19:58:50 2008
@@ -57,6 +57,7 @@
 dofile(libpath .. "lib.cliloc.lua")
 dofile(libpath .. "lib.macrolist.lua")
 dofile(libpath .. "lib.walking3.lua")
+dofile(libpath .. "lib.equipment.lua")
 dofile(libpath .. "lib.spellbooks.lua")
 dofile(libpath .. "lib.spellinfo.lua")
 dofile(libpath .. "lib.speech.lua")

Modified: trunk/lua/net/net.object.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.object.lua (original)
+++ trunk/lua/net/net.object.lua Fri Oct 17 19:58:50 2008
@@ -2,6 +2,7 @@
 -- see also lib.packet.lua and lib.protocol.lua
 =

 function Send_DoubleClick (iSerial)
+	print("Send_DoubleClick",sprintf("0x%08x",iSerial))
 	printdebug("net",sprintf("NET: Send_DoubleClick: 0x%08x\n",iSerial))
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Double_Click)
@@ -18,6 +19,7 @@
 end
 =

 function Send_SingleClick (iSerial)
+	print("Send_SingleClick",sprintf("0x%08x",iSerial))
 	printdebug("net",sprintf("NET: Send_SingleClick: 0x%08x\n",iSerial))
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Single_Click)

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Fri Oct 17 19:58:50 2008
@@ -1,41 +1,8 @@
 -- displays a spellbar over the head of a char
 =

 if (not gDisabledPlugins.spellbar) then =

-gSpellBarEquipPropCache =3D nil
-gSpellBarEquipmentSerials =3D {}
 kSpellTimeLatency =3D 150
 =

--- returns proparr=3D{fc=3D?,fcr=3D?}
-function GetSpellBarEquipProps ()
-	if (gSpellBarEquipPropCache) then return gSpellBarEquipPropCache end
-	local propsum =3D {}
-	gSpellBarEquipPropCache =3D propsum
-	gSpellBarEquipmentSerials =3D {}
-	local mobile =3D GetPlayerMobile()
-	for index,layer in pairs(gLayerOrder) do =

-		local item =3D GetMobileEquipmentItem(mobile,layer)
-		if (item) then =

-			gSpellBarEquipmentSerials[item.serial] =3D true
-			local tooltip =3D AosToolTip_GetText(item.serial)
-			if (tooltip) then =

-				local props =3D ParseProps(tooltip)
-				if (props.fcr) then propsum.fcr =3D (propsum.fcr or 0) + props.fcr end
-				if (props.fc) then propsum.fc =3D (propsum.fc or 0) + props.fc end
-				--~ print("+",tooltip and string.len(tooltip),gLayerTypeName[layer],to=
oltip) =

-			end
-		end
-	end
-	return gSpellBarEquipPropCache
-end
-
-RegisterListener("Hook_MobileEquipmentChanged",function (mobile)
-	if (not IsPlayerMobile(mobile)) then return end
-	gSpellBarEquipPropCache =3D nil
-end)
-	=

-RegisterListener("Hook_ToolTipUpdate",function (serial)
-	if (gSpellBarEquipmentSerials[serial]) then gSpellBarEquipPropCache =3D n=
il end
-end)
 =

 RegisterListener("Hook_HUDStep",function ()
 	SpellBarStep()
@@ -58,15 +25,9 @@
 	local t =3D Client_GetTicks()
 	gSpellBarLastSpellSendTime =3D t
 	gSpellBarLastSpellSendID =3D spellid
-	local spellname		=3D GetSpellNameByID(spellid)
-	local spellcircle	=3D GetSpellCircleByID(spellid)
-	local spellbookid	=3D GetSpellBookIDBySpellID(spellid)
-	local equipprop		=3D GetSpellBarEquipProps()
-	local casttime		=3D GetSpellCastTime(spellid,equipprop.fc,IsBuffActive_Pr=
otection(),IsBuffActive_EssenceOfWind()) + kSpellTimeLatency
-	print("spellbar:Hook_SendSpell",spellid,spellname,spellcircle,casttime,Sm=
artDump(equipprop))
-	SpellBarRiseTextOnMob(GetPlayerSerial(),1,1,1,spellname)
-	if (casttime > 0) then SpellBarStart(casttime) end
-	--~ SpellBarRiseTextOnMob(GetPlayerSerial(),1,1,1,sprintf("%s(%d,%d)%s",s=
pellname,spellcircle,spellid,IsMageSpell(spellid) and "mage" or "")) =

+	SpellBarRiseTextOnMob(GetPlayerSerial(),1,1,1,GetSpellNameByID(spellid))
+	local casttime =3D GetSpellCastTimeForPlayer(spellid)
+	if (casttime > 0) then SpellBarStart(casttime + kSpellTimeLatency) end
 end)
 =

 =

@@ -182,13 +143,12 @@
 ]]--
 =

 =

+RegisterListener("Hook_Spell_Interrupt",function () SpellBarInterrupt() en=
d)
+
 --~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_Te=
xt_Unicode
 RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum)
 	local short =3D gSpellbarShortMessages[text_messagenum]
-	if (short) then
-		SpellBarRiseTextOnMob(GetPlayerSerial(),short.r,short.g,short.b,short.tx=
t)
-		if (short.bInterrupt) then SpellBarInterrupt() end
-	end
+	if (short) then SpellBarRiseTextOnMob(GetPlayerSerial(),short.r,short.g,s=
hort.b,short.txt) end
 	if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet_Loc=
alized_Text",serial,plaintext,text_messagenum) end
 	if (serial ~=3D 0xFFFFFFFF) then
 		local r,g,b =3D 1,1,0 -- yellow

Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Fri Oct 17 19:58:50 2008
@@ -36,7 +36,8 @@
 		if (DynamicIsInWorld(dynamic) and dynamic.artid_base =3D=3D kCorpseDynam=
icArtID) then =

 			if (gLoot_TrashCorpseTypesByID[dynamic.amount] or gLootFinishedCorpses[=
dynamic.serial]) then
 				LootHideCorpse(dynamic)
-			elseif (abs(dynamic.xloc-xloc) + abs(dynamic.yloc-yloc) <=3D maxdist) t=
hen
+			elseif (dist2(xloc,yloc,dynamic.xloc,dynamic.yloc) <=3D maxdist) then
+			--~ elseif (abs(dynamic.xloc-xloc) + abs(dynamic.yloc-yloc) <=3D maxdis=
t) then
 				res =3D dynamic
 			end
 		end



From no-reply at zwischenwelt.org  Fri Oct 17 21:11:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 17 Oct 2008 19:11:11 -0000
Subject: [Iris-commit] [IRIS] r2595 - in /trunk: lua/lib.macrolist.lua
	plugins/moblist.lua
Message-ID: <20081017191111.444F01C1879D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 17 21:11:10 2008
New Revision: 2595

Log:
macro utils for targetqueue

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Fri Oct 17 21:11:10 2008
@@ -67,6 +67,57 @@
 	f() =

 end
 =

+
+
+
+
+
+
+
+
+
+function MacroCmd_SendTargetSerial	(serial) =

+	local mobile =3D GetMobile(serial)
+	if mobile then return CompleteTargetMode({ hittype =3D kMousePickHitType_=
Mobile,  mobile =3D mobile }) end
+	local dynamic =3D GetMobile(serial)
+	if dynamic then return CompleteTargetMode({ hittype =3D kMousePickHitType=
_Dynamic,  dynamic =3D dynamic }) end
+end
+
+-- timeout : in ms
+-- bFailBySpellInterrupt : if true, then it will be aborted if a message i=
ndicating spell interruption is received
+function MacroCmd_QueueTargetSerial		(serial,timeout,callback,bFailBySpell=
Interrupt)
+	gMacroQueuedTarget_Serial =3D serial
+	gMacroQueuedTarget_Timeout =3D Client_GetTicks() + timeout
+	gMacroQueuedTarget_CallBack =3D callback
+	gMacroQueuedTarget_FailBySpellInterrupt =3D bFailBySpellInterrupt
+	if (IsTargetModeActive()) then
+		MacroCmd_SendTargetSerial(serial)
+		MacroCmd_QueuedTargetEnd(true)
+	end
+end
+function MacroCmd_QueuedTargetEnd	(bSuccess,sFailureReason) =

+	if (gMacroQueuedTarget_CallBack) then gMacroQueuedTarget_CallBack(bSucces=
s,sFailureReason) end
+	gMacroQueuedTarget_CallBack =3D nil
+	gMacroQueuedTarget_Serial =3D nil
+	gMacroQueuedTarget_Timeout =3D nil
+	gMacroQueuedTarget_FailBySpellInterrupt =3D nil
+end
+
+RegisterStepper(function () =

+	if (gMacroQueuedTarget_Timeout and Client_GetTicks() > gMacroQueuedTarget=
_Timeout) then MacroCmd_QueuedTargetEnd(false,"timeout") end
+end)
+RegisterListener("Hook_Spell_Interrupt",	function ()
+	if (gMacroQueuedTarget_FailBySpellInterrupt) then MacroCmd_QueuedTargetEn=
d(false,"spell-interrupt") end
+end)
+RegisterListener("Hook_TargetMode_Start",	function () =

+	if (gMacroQueuedTarget_Serial) then MacroCmd_SendTargetSerial(gMacroQueue=
dTarget_Serial) MacroCmd_QueuedTargetEnd(true) end
+end)
+
+
+
+
+
+
 gMacroLastTargetMemory =3D nil
 gMacroTargetLastRunning =3D false
 function MacroRememberTarget (hitobject)
@@ -91,6 +142,7 @@
 		return dynamic ~=3D nil
 	end
 end
+
 =

 -- timeout in ms, defaults to 30 seconds
 function MacroCmd_TargetLast	(completefun,timeout) 		-- repeat the last ta=
rget	=

@@ -230,7 +282,7 @@
 	for k,mobile in pairs(GetMobileList()) do =

 		local dist =3D dist2(xloc,yloc,mobile.xloc,mobile.yloc)
 		if ((not founddist) or dist < founddist) then =

-			if (StringContains(AosToolTip_GetText(mobile.serial) or mobile.name,nam=
epart)) then
+			if (StringContains(AosToolTip_GetText(mobile.serial) or mobile.name or =
"",namepart)) then
 				founddist =3D dist
 				foundmob =3D mobile
 			end
@@ -268,12 +320,16 @@
 	Send_Request_SkillUse(skillid)
 end
 =

-function MacroCmd_Spell					(spellname,target)
+function MacroCmd_Spell					(spellname,targetserial,targetcallback,targetw=
aitadd)
 	if (not gInGameStarted) then return end
 	local spellid =3D GetSpellIDByName(spellname)
 	if (not spellid) then return MacroErrorNameMismatch("MacroCmd_Spell",spel=
lname,gSpellIDByName) end
 	Send_Spell(spellid)
-	--~ if (target) then        TODO
+	=

+	if (targetserial) then =

+		local timeout =3D GetSpellCastTimeForPlayer(spellid) + kSpellTimeLatency=
 + (targetwaitadd or 1000)
+		MacroCmd_QueueTargetSerial(targetserial,timeout,targetcallback,true) =

+	end
 end
 =

 =

@@ -350,8 +406,8 @@
 end
 =

 =

-function GetMacroKeyComboName (keycode,bCtrl,bAlt,bShift) =

-	local text =3D GetKeyName(keycode)
+function GetMacroKeyComboName (keycode,char,bCtrl,bAlt,bShift) =

+	local text =3D (keycode > 0) and GetKeyName(keycode) or ("0"..char)
 	if (bCtrl	) then text =3D "ctrl+"..text end
 	if (bAlt	) then text =3D "alt+"..text end
 	if (bShift	) then text =3D "shift+"..text end
@@ -362,11 +418,11 @@
 =

 function SetMacro (keycomboname,fun) gMacroList[string.gsub(string.lower(k=
eycomboname)," ","")] =3D fun end
 =

-function TriggerMacros (keycode) =

+function TriggerMacros (keycode,char) =

 	local bCtrl		=3D gKeyPressed[key_lcontrol]	or gKeyPressed[key_rcontrol]
 	local bAlt		=3D gKeyPressed[key_lalt]		or gKeyPressed[key_ralt]	=

 	local bShift	=3D gKeyPressed[key_lshift]	or gKeyPressed[key_rshift]
-	local name =3D GetMacroKeyComboName(keycode,bCtrl,bAlt,bShift)
+	local name =3D GetMacroKeyComboName(keycode,char,bCtrl,bAlt,bShift)
 	local macrofun =3D gMacroList[name]
 	if (gMacroPrintAllKeyCombos) then print('to use this macro keycombo : Set=
Macro("'..name..'",function() MacroCmd_Say("test") end)') end
 	if (not macrofun) then return end -- no macro mapped to this keycode
@@ -381,7 +437,7 @@
 end
 =

 RegisterListener("keydown",function (keycode,char,bConsumed) =

-	if (not bConsumed) then TriggerMacros(keycode) end
+	if (not bConsumed) then TriggerMacros(keycode,char) end
 end)
 =

 =


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Fri Oct 17 21:11:10 2008
@@ -280,6 +280,8 @@
 =

 -- ***** ***** ***** ***** ***** rest
 =

+function MobListGetMainTargetSerial() return gMobList.maintarget_serial end
+
 RegisterListener("Hook_PostLoad",function () gMobList =3D GetDesktopWidget=
():CreateChild("UOMobList") end)
 =

 end



From no-reply at zwischenwelt.org  Fri Oct 17 22:57:10 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 17 Oct 2008 20:57:10 -0000
Subject: [Iris-commit] [IRIS] r2596 - in /trunk: lua/net.walk.lua
	plugins/lib.spellbar.lua
Message-ID: <20081017205710.BBF491C1879D@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 17 22:57:10 2008
New Revision: 2596

Log:
improved walkcode to handle block packets correctly without resync-request

Modified:
    trunk/lua/net.walk.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Fri Oct 17 22:57:10 2008
@@ -174,7 +174,7 @@
 	local iFullDir =3D BitwiseOR(iDir,bRunFlag and kWalkFlag_Run or 0) -- inc=
ludes runflag
 	=

 	local playermobile =3D GetPlayerMobile()
-	WalkLog2("ExecWalkRequestIfPossible playermobile",playermobile)
+	--~ WalkLog2("ExecWalkRequestIfPossible playermobile",playermobile)
 	if (not playermobile) then return end
 	=

 	-- init request
@@ -227,6 +227,7 @@
 	out:PushNetUint8(iSeqNum)
 	out:PushNetUint32(iFastKey)
 	out:SendPacket()
+	--~ print("walk:request",sprintf("0x%04x",iFullDir),iSeqNum)
 end
 =

 =

@@ -235,6 +236,7 @@
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
 	local iSeqNum =3D input:PopNetUint8()
+	--~ print("walk:accept",iSeqNum)
 	local player_notoriety =3D input:PopNetUint8()
 	local playermobile =3D GetPlayerMobile()
 	if (playermobile) then playermobile:SetNotoriety(player_notoriety) end --=
 fast notoriety update
@@ -248,6 +250,7 @@
 		-- todo : tilefree : set last confirmed pos
 		--~ WalkLog("kPacket_Accept_Movement ok")
 	else
+		print("walk:received accept movement with unknown seqnum",iSeqNum) -- ha=
ppens while trying to walk into a private house and then to the side
 		WalkLog("kPacket_Accept_Movement UNKNOWN")
 		Send_Movement_Resync_Request()
 	end
@@ -255,15 +258,17 @@
 =

 -- reset WalkSeq. and Stack
 function ResetWalkQueue ()
-	WalkLog("ResetWalkQueue start")
+	--~ WalkLog("ResetWalkQueue start")
 	gNextWalkSequenceNumber =3D 0
 	gWalkRequests =3D {}
 	gWalkPathToGo =3D nil
-	WalkLog("ResetWalkQueue end")
-end
+	--~ WalkLog("ResetWalkQueue end")
+end
+
+gDoomedWalkRequests =3D {}
 =

 -- Block Movement Request - reset player to back to location
-function gPacketHandler.kPacket_Block_Movement()
+function gPacketHandler.kPacket_Block_Movement() -- 0x21
 	local input			=3D GetRecvFIFO()
 	local id			=3D input:PopNetUint8()
 	local seqnumber		=3D input:PopNetUint8()
@@ -272,17 +277,30 @@
 	local dir			=3D input:PopNetUint8()
 	local zloc			=3D input:PopInt8()
 =

-	WalkLog("kPacket_Block_Movement start")
-	ResetWalkQueue()
-	SetPlayerPos(xloc,yloc,zloc,dir)
-	gCurrentRenderer:NotifyPlayerTeleported()
-	=

-	Send_Accept_Block_Movement(seqnumber)
-	WalkLog("kPacket_Block_Movement end")
-end
-
+	-- usecase(idea) : player has sent  north,north,west,west  , the first tw=
o are blocked(private house), but the latter two are accepted
+	-- usecase :  request0a,request1a,block0a,request0b,request1b,block1a!!!!=
(deletes 1b)  (this is now prevented via doom list -> it's known which are =
old)
+	=

+	local doomed =3D gDoomedWalkRequests[seqnumber]
+	--~ print("walk:block",seqnumber,doomed and "doomed" or "",countarr(gDoom=
edWalkRequests))
+	if (doomed) then
+		doomed =3D doomed - 1
+		gDoomedWalkRequests[seqnumber] =3D (doomed > 0) and doomed or nil
+	else
+		-- doomcount should be zero in this case ? rarely, but not neccessarily =
if =

+		for newdoomedseqnum,request in pairs(gWalkRequests) do
+			if (newdoomedseqnum ~=3D seqnumber) then
+				gDoomedWalkRequests[newdoomedseqnum] =3D (gDoomedWalkRequests[newdoome=
dseqnum] or 0) + 1 -- server will send block-msg for those
+			end
+		end
+		ResetWalkQueue()
+		SetPlayerPos(xloc,yloc,zloc,dir)
+		gCurrentRenderer:NotifyPlayerTeleported()
+	end
+end
+
+-- original client doesn't send this, e.g. trying to walk while casting a =
spell
 -- TODO : is this the same as Send_Movement_Resync_Request ?
-function Send_Accept_Block_Movement(seqnumber)
+function Send_Accept_Block_Movement(seqnumber) -- 0x22
 	WalkLog("Send_Accept_Block_Movement",seqnumber)
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Accept_Movement_Resync_Request)
@@ -293,9 +311,13 @@
 =

 -- This Packet is send when Client thinks he is out of Sync (basicly: sequ=
ence doesn't fit)
 -- The proper response from the server is a Teleport packet kPacket_Telepo=
rt
+gEarliestNextResyncRequestTime =3D 0
 function Send_Movement_Resync_Request()
+	local t =3D Client_GetTicks()
+	if (t < gEarliestNextResyncRequestTime) then return end
+	gEarliestNextResyncRequestTime =3D t + 2000 -- server sends everything, i=
ncluding surrounding stuff
+	print("######## walk : ResyncRequest")
 	WalkLog("Send_Movement_Resync_Request")
-	-- todo : block too many resync requests by remembering gMyTicks here ?
 	ResetWalkQueue()
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Accept_Movement_Resync_Request)

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Fri Oct 17 22:57:10 2008
@@ -134,7 +134,10 @@
 gSpellbarShortMessages[500113] =3D {r=3D0.5,g=3D0,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

 gSpellbarShortMessages[501942] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"locatio=
n blocked"	} -- That location is blocked.           =

 gSpellbarShortMessages[500119] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"mustwai=
t"			} -- You must wait to perform another action.     =

-gSpellbarShortMessages[500446] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"too far=
"			} -- That is too far away.  =

+gSpellbarShortMessages[500446] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"too far=
"			} -- That is too far away. =

+ =

+gSpellbarShortMessages[501284] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"You may=
 not enter." } -- You may not enter.
+gSpellbarShortMessages[500111] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"frozen"=
 			} -- You are frozen and cannot move. =

 =

 --[[
 Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091



From no-reply at zwischenwelt.org  Fri Oct 17 23:17:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 17 Oct 2008 21:17:35 -0000
Subject: [Iris-commit] [IRIS] r2597 - /trunk/bin/iris2.exe
Message-ID: <20081017211735.F061F1C1879E@zwischenwelt.org>

Author: sience
Date: Fri Oct 17 23:17:35 2008
New Revision: 2597

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Sat Oct 18 00:12:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 17 Oct 2008 22:12:08 -0000
Subject: [Iris-commit] [IRIS] r2598 - in /trunk: lua/lib.macrolist.lua
 lua/net/net.other.lua lua/obj/obj.mobile.lua plugins/lib.spellbar.lua
Message-ID: <20081017221209.124541C1879D@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 18 00:12:08 2008
New Revision: 2598

Log:
spellbar : update-health, MacroCmd_RepeatLastSpell

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.other.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sat Oct 18 00:12:08 2008
@@ -320,6 +320,9 @@
 	Send_Request_SkillUse(skillid)
 end
 =

+function MacroCmd_RepeatLastSpell ()
+	if (gLastSpellID) then Send_Spell(gLastSpellID) end
+end
 function MacroCmd_Spell					(spellname,targetserial,targetcallback,targetw=
aitadd)
 	if (not gInGameStarted) then return end
 	local spellid =3D GetSpellIDByName(spellname)

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sat Oct 18 00:12:08 2008
@@ -1038,6 +1038,7 @@
 		print("no spellid defined")
 		return
 	end
+	gLastSpellID =3D spellid
 	NotifyListener("Hook_SendSpell",spellid,expansionflag)
 --	printf("NET: Send_SpellSelected : spellid=3D%d\n",spellid)
 	if (spellid < 10) then

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Sat Oct 18 00:12:08 2008
@@ -260,6 +260,10 @@
 function gMobilePrototype:UpdateHealth (curvalue,maxvalue)
 	-- TODO pol sends normal hp update and x/1000 hp update ???? so i ignore =
the strange one
 	if ((maxvalue ~=3D 1000) and self.stats) then
+	=

+		local oldcur =3D self.stats.curHits or 0
+		local oldmax =3D self.stats.maxHits or 0
+		=

 		if self.stats.curHits then
 			-- if there was a change, plop a text
 			local old =3D self.stats.curHits
@@ -270,6 +274,7 @@
 		self.stats.maxHits =3D maxvalue
 =

 		self:NotifyListener("Mobile_UpdateStats")
+		if (IsPlayerMobile(self)) then NotifyListener("Mobile_UpdateHealth",self=
,oldcur,oldmax,curvalue,maxvalue) end
 		self:Update()
 	end
 end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 18 00:12:08 2008
@@ -108,8 +108,16 @@
 	local delta =3D curvalue - oldcur =

 	if (delta =3D=3D 1 or delta =3D=3D 0) then return end
 	local r,g,b =3D 0,0,1 -- blue
-	SpellBarRiseTextOnMob(serial,r,g,b,sprintf("%+d",delta))
+	SpellBarRiseTextOnMob(serial,r,g,b,sprintf("   %+d",delta))
 	--~ print("manaused",serial,used) =

+end)
+RegisterListener("Mobile_UpdateHealth",			function (mobile,oldcur,oldmax,c=
urvalue,maxvalue)
+	local serial =3D mobile.serial
+	local delta =3D curvalue - oldcur =

+	if (delta > 1) then =

+		local r,g,b =3D 0,1,0 -- green
+		SpellBarRiseTextOnMob(serial,r,g,b,sprintf("      %+d",delta))
+	end
 end)
 	=

 =




From no-reply at zwischenwelt.org  Sat Oct 18 00:32:38 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 17 Oct 2008 22:32:38 -0000
Subject: [Iris-commit] [IRIS] r2599 - in /trunk: lua/lib.2d.hudfx.lua
	plugins/lib.spellbar.lua
Message-ID: <20081017223239.182ED1C1879D@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 18 00:32:38 2008
New Revision: 2599

Log:
damage rise-text a bit left, to avoid overlop with other messages

Modified:
    trunk/lua/lib.2d.hudfx.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.2d.hudfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.hudfx.lua (original)
+++ trunk/lua/lib.2d.hudfx.lua Sat Oct 18 00:32:38 2008
@@ -33,7 +33,7 @@
 		if (px) then =

 			local dur =3D hudfx.dur
 			local ft =3D min(dur,t - hudfx.startt) / dur
-			hudfx.gfx:SetPos(px,py - sqrt(ft)*hudfx.riseh)
+			hudfx.gfx:SetPos(px + hudfx.offsetx,py - sqrt(ft)*hudfx.riseh)
 		end
 	end
 end
@@ -41,11 +41,13 @@
 function Renderer2D:NotifyDamage( mobile_serial, damage) -- kPacket_Damage=
,0x0b
 	local isOnSelf =3D GetPlayerSerial() =3D=3D mobile_serial
 	local col =3D isOnSelf and self.kDamageTextCol_Self or self.kDamageTextCo=
l_Other
-	self:HUDFX_AddRisingTextOnMob(GetMobile(mobile_serial),sprintf("%d",damag=
e),unpack(col))
+	local offsetx =3D isOnSelf and -32 or 0
+	local r,g,b =3D unpack(col)
+	self:HUDFX_AddRisingTextOnMob(GetMobile(mobile_serial),sprintf("%d",damag=
e),r,g,b,offsetx)
 end
 =

 =

-function Renderer2D:HUDFX_AddRisingTextOnMob (mob,text,r,g,b,risetime,rise=
h)
+function Renderer2D:HUDFX_AddRisingTextOnMob (mob,text,r,g,b,offsetx,riset=
ime,riseh)
 	if (not mob) then return end
 	local hudfx =3D {}
 	hudfx.dur =3D risetime or 1000
@@ -57,6 +59,7 @@
 	hudfx.text =3D text
 	hudfx.mob =3D mob
 	hudfx.zadd =3D 10
+	hudfx.offsetx =3D offsetx or 0
 	=

 	local gfx =3D gRootWidget.hudfx:CreateChild("UOText",{x=3D0,y=3D0,text=3D=
text,col=3D{r=3Dr,g=3Dg,b=3Db},bold=3Dtrue})
 	=


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sat Oct 18 00:32:38 2008
@@ -111,10 +111,13 @@
 	SpellBarRiseTextOnMob(serial,r,g,b,sprintf("   %+d",delta))
 	--~ print("manaused",serial,used) =

 end)
+
+-- this is only triggered by hp-health-packet, used for magery-heal, but n=
ot used when drinking a potion -> kPacket_Mobile_Stats  "Mobile_UpdateStats"
 RegisterListener("Mobile_UpdateHealth",			function (mobile,oldcur,oldmax,c=
urvalue,maxvalue)
 	local serial =3D mobile.serial
 	local delta =3D curvalue - oldcur =

 	if (delta > 1) then =

+		print("HEAL!",delta,Client_GetTicks())
 		local r,g,b =3D 0,1,0 -- green
 		SpellBarRiseTextOnMob(serial,r,g,b,sprintf("      %+d",delta))
 	end
@@ -151,6 +154,9 @@
 Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091
 Hook_Packet_Localized_Text      4294967295      You inflict a Death Strike=
 upon your opponent!  1063094  (different message for 2nd..)
 Hook_Packet_Localized_Text      4294967295      You missed your opponent w=
ith a Death Strike.   1070779  =

+
+Hook_Packet_Localized_Text      4294967295      You are already at full he=
alth. 1049547  potion ? =

+Hook_Packet_Localized_Text      4294967295      The essence of garlic burn=
s you!        1061651   some spells in necro form
 ]]--
 =

 =




From no-reply at zwischenwelt.org  Sun Oct 19 15:59:48 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 13:59:48 -0000
Subject: [Iris-commit] [IRIS] r2600 - in /trunk/lua: lib.2d.map.lua
 lib.3d.map.lua lib.compass.lua lib.map.lua lib.mapblock.3d.terrain.lua
 lib.unifont.lua widgets/widget.uotext.lua
Message-ID: <20081019135948.D1A671524030@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 15:59:48 2008
New Revision: 2600

Log:
a few fixes to allow deactivating loaders (static,unifont)

Modified:
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.3d.map.lua
    trunk/lua/lib.compass.lua
    trunk/lua/lib.map.lua
    trunk/lua/lib.mapblock.3d.terrain.lua
    trunk/lua/lib.unifont.lua
    trunk/lua/widgets/widget.uotext.lua

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Sun Oct 19 15:59:48 2008
@@ -57,7 +57,7 @@
 =

 function Renderer2D:BlendOutLayersAbovePlayer	()
 	local x,y,z =3D GetPlayerPos()
-	if (not z or not gStaticBlockLoader or not gGroundBlockLoader) then retur=
n end
+	if (not z) then return end
 	=

 	local myLayer =3D nil
 	local bTerrainVisible =3D true

Modified: trunk/lua/lib.3d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.map.lua (original)
+++ trunk/lua/lib.3d.map.lua Sun Oct 19 15:59:48 2008
@@ -96,7 +96,7 @@
 function Renderer3D:BlendOutLayersAbovePlayer ()
 	local x,y,z =3D GetPlayerPos()
 	=

-	if (not z or not gStaticBlockLoader or not gGroundBlockLoader) then retur=
n end
+	if (not z) then return end
 	=

 	--[[
 	osi =3D wenn dach min 18z h=C3=AF=C2=BF=C2=BDher als char, dann alles von=
 zdach aufw=C3=AF=C2=BF=C2=BDrts ausblenden

Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Sun Oct 19 15:59:48 2008
@@ -192,24 +192,25 @@
 	--~ print("UpdateDetailMapCacheIfNeeded : updating....")
 	=

 	-- update image
-	local bx0,dbx =3D math.floor((xloc-kDetailMapCacheSize/2)/8),kDetailMapCa=
cheSize/8
-	local by0,dby =3D math.floor((yloc-kDetailMapCacheSize/2)/8),kDetailMapCa=
cheSize/8
-	GenerateRadarImage(gDetailMapCacheImage,bx0,by0,dbx,dby,gGroundBlockLoade=
r,gStaticBlockLoader,gRadarColorLoader)
-	gDetailMapCacheBX =3D bx0
-	gDetailMapCacheBY =3D by0
-	=

-	-- create or update texture
-	if (gDetailMapCacheTexture) then =

-		gDetailMapCacheImage:LoadToTexture(gDetailMapCacheTexture) -- update exi=
sting texture
-	else
-		gDetailMapCacheTexture =3D gDetailMapCacheImage:MakeTexture() -- generat=
e new texture
-	end
-	=

-	-- create material on first time init
-	if (not gDetailMapCacheMaterial) then
-		gDetailMapCacheMaterial =3D GetPlainTextureMat(gDetailMapCacheTexture)
-	end
-	=

+	if (gGroundBlockLoader and gStaticBlockLoader and gRadarColorLoader) then
+		local bx0,dbx =3D math.floor((xloc-kDetailMapCacheSize/2)/8),kDetailMapC=
acheSize/8
+		local by0,dby =3D math.floor((yloc-kDetailMapCacheSize/2)/8),kDetailMapC=
acheSize/8
+		GenerateRadarImage(gDetailMapCacheImage,bx0,by0,dbx,dby,gGroundBlockLoad=
er,gStaticBlockLoader,gRadarColorLoader)
+		gDetailMapCacheBX =3D bx0
+		gDetailMapCacheBY =3D by0
+		=

+		-- create or update texture
+		if (gDetailMapCacheTexture) then =

+			gDetailMapCacheImage:LoadToTexture(gDetailMapCacheTexture) -- update ex=
isting texture
+		else
+			gDetailMapCacheTexture =3D gDetailMapCacheImage:MakeTexture() -- genera=
te new texture
+		end
+		=

+		-- create material on first time init
+		if (not gDetailMapCacheMaterial) then
+			gDetailMapCacheMaterial =3D GetPlainTextureMat(gDetailMapCacheTexture)
+		end
+	end
 end
 =

 --[[
@@ -496,7 +497,7 @@
 		local bRough =3D IsRoughCompassActive()
 		=

 		-- detail compass
-		if (not bRough) then
+		if ((not bRough) and gDetailMapCacheMaterial) then
 			local xloc,yloc =3D cxloc, cyloc
 			UpdateDetailMapCacheIfNeeded(xloc,yloc)
 =


Modified: trunk/lua/lib.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.map.lua (original)
+++ trunk/lua/lib.map.lua Sun Oct 19 15:59:48 2008
@@ -63,18 +63,20 @@
 	-- statics
 	b.statics_all =3D {}
 	b.statics_bypos =3D {}
-	gStaticBlockLoader:Load(bx,by) -- following gStaticBlockLoader commands o=
perate on this loaded block
-	local iStaticCount =3D gStaticBlockLoader:Count()
+	if (gStaticBlockLoader) then gStaticBlockLoader:Load(bx,by) end -- follow=
ing gStaticBlockLoader commands operate on this loaded block
+	local iStaticCount =3D gStaticBlockLoader and gStaticBlockLoader:Count() =
or 0
 	for ty =3D 0,7 do
 	for tx =3D 0,7 do
 		b.statics_bypos[ty*10 + tx] =3D {}
 	end
 	end
-	for i =3D 0,iStaticCount-1 do
-		local iTileTypeID,tx,ty,iZ,iHue =3D gStaticBlockLoader:GetStatic(i)
-		local static =3D {zloc=3DiZ,artid=3DiTileTypeID,hue=3DiHue,tx=3Dtx,ty=3D=
ty,xloc=3Dtx+bx*8,yloc=3Dty+by*8,bx=3Dbx,by=3Dby,iBlockIndex=3Di,fBlockInde=
xRel=3Di/iStaticCount,bIsStatic=3Dtrue}
-		table.insert(b.statics_bypos[ty*10 + tx],static)
-		table.insert(b.statics_all,static)
+	if (gStaticBlockLoader) then
+		for i =3D 0,iStaticCount-1 do
+			local iTileTypeID,tx,ty,iZ,iHue =3D gStaticBlockLoader:GetStatic(i)
+			local static =3D {zloc=3DiZ,artid=3DiTileTypeID,hue=3DiHue,tx=3Dtx,ty=
=3Dty,xloc=3Dtx+bx*8,yloc=3Dty+by*8,bx=3Dbx,by=3Dby,iBlockIndex=3Di,fBlockI=
ndexRel=3Di/iStaticCount,bIsStatic=3Dtrue}
+			table.insert(b.statics_bypos[ty*10 + tx],static)
+			table.insert(b.statics_all,static)
+		end
 	end
 	=

 	-- ground

Modified: trunk/lua/lib.mapblock.3d.terrain.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mapblock.3d.terrain.lua (original)
+++ trunk/lua/lib.mapblock.3d.terrain.lua Sun Oct 19 15:59:48 2008
@@ -18,5 +18,6 @@
 =

 =

 function cMapBlock_3D_Terrain:UpdateBlendOutVisibility ()
+	print("terrain:UpdateBlendOutVisibility",Renderer3D.gbBlendOutTerrainVisi=
ble)
 	if (self.gfx_terrain) then self.gfx_terrain:SetVisible(Renderer3D.gbBlend=
OutTerrainVisible) end
 end

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Sun Oct 19 15:59:48 2008
@@ -113,6 +113,7 @@
 -- uofonts are pixelart and not scalable, so the size is fixed
 -- bold=3Doutline for uo html
 function CreateFont_UO (loader,bOutlined)
+	if (not loader) then return end
 	if (bOutlined) then =

 		if (loader.font_outlined) then return loader.font_outlined end -- cachin=
g font object, atlas is also be cached in loader
 	else

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Sun Oct 19 15:59:48 2008
@@ -72,8 +72,8 @@
 		for textchunk,tag in string.gfind(plaintext, "([^<]*)(<?[^>]*>?)") do =

 			local fontid,bold,col =3D unpack(statestack[#statestack])
 			local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
-			local fontsize =3D fontsize or font:GetDefaultFontSize()
-			if (textchunk ~=3D "") then =

+			local fontsize =3D fontsize or (font and font:GetDefaultFontSize())
+			if (textchunk ~=3D "" and font) then =

 				-- text-chunk without tags
 				if (bIsUniCode) then =

 					local len =3D #textchunk
@@ -86,7 +86,7 @@
 					glyphlist:AddText(font,fontsize,textchunk,col)
 				end
 			end
-			if (tag ~=3D "") then
+			if (tag ~=3D "" and font) then
 				readerpos =3D readerpos + #tag
 				-- html-tag
 				if (string.find(tag,"</BASEFONT")) then table.remove(statestack) end
@@ -111,11 +111,13 @@
 	else
 		-- don't parse html
 		local font =3D GetUOFont(gUniFontLoaderList[fontid],bold)
-		local fontsize =3D fontsize or font:GetDefaultFontSize()
-		if (bIsUniCode) then =

-			for k,unicode_charcode in ipairs(uohtml) do glyphlist:AddFontGlyph(font=
,fontsize,unicode_charcode,col) end
-		else
-			glyphlist:AddText(font,fontsize,uohtml,col)
+		local fontsize =3D fontsize or (font and font:GetDefaultFontSize())
+		if (font) then
+			if (bIsUniCode) then =

+				for k,unicode_charcode in ipairs(uohtml) do glyphlist:AddFontGlyph(fon=
t,fontsize,unicode_charcode,col) end
+			else
+				glyphlist:AddText(font,fontsize,uohtml,col)
+			end
 		end
 	end
 	self:UpdateGeometry()



From no-reply at zwischenwelt.org  Sun Oct 19 17:42:14 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 15:42:14 -0000
Subject: [Iris-commit] [IRIS] r2602 - in /trunk: lua/lib.compass.lua
 lua/lib.uoam.lua plugins/moblist.lua
Message-ID: <20081019160005.7D5E51524036@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 17:42:14 2008
New Revision: 2602

Log:
experimental uoam position display in moblist plugin added, compass bugfix

Modified:
    trunk/lua/lib.compass.lua
    trunk/lua/lib.uoam.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Sun Oct 19 17:42:14 2008
@@ -497,7 +497,7 @@
 		local bRough =3D IsRoughCompassActive()
 		=

 		-- detail compass
-		if ((not bRough) and gDetailMapCacheMaterial) then
+		if (not bRough) then
 			local xloc,yloc =3D cxloc, cyloc
 			UpdateDetailMapCacheIfNeeded(xloc,yloc)
 =

@@ -507,7 +507,7 @@
 			-- set material, only needed once
 			if (not mygfx.bDetailCompassMatHasBeenSet) then =

 				mygfx.bDetailCompassMatHasBeenSet =3D true
-				mygfx:SetMaterial(gDetailMapCacheMaterial) =

+				if (gDetailMapCacheMaterial) then mygfx:SetMaterial(gDetailMapCacheMat=
erial) end
 			end
 			=

 			-- prepare vars
@@ -536,7 +536,7 @@
 			-- set material, only needed once
 			if (not mygfx.bDetailCompassMatHasBeenSet) then =

 				mygfx.bDetailCompassMatHasBeenSet =3D true
-				mygfx:SetMaterial(gDetailMapCacheMultiMaterial) =

+				if (gDetailMapCacheMultiMaterial) then mygfx:SetMaterial(gDetailMapCac=
heMultiMaterial) end
 			end
 			=

 			-- prepare vars

Modified: trunk/lua/lib.uoam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoam.lua (original)
+++ trunk/lua/lib.uoam.lua Sun Oct 19 17:42:14 2008
@@ -5,12 +5,12 @@
 =

 =

 kUOAM_Facet =3D {}
-kUOAM_Facet.felu	=3D 0x66 -- MapGetMapIndex()=3D0  =

-kUOAM_Facet.tram	=3D 0x74 -- MapGetMapIndex()=3D1
-kUOAM_Facet.ilsh	=3D 0x69 -- MapGetMapIndex()=3D2  =

-kUOAM_Facet.malas	=3D 0x6D -- MapGetMapIndex()=3D3  =

-kUOAM_Facet.tokuno	=3D 0x73 -- MapGetMapIndex()=3D4  =

-
+kUOAM_Facet.felu	=3D 0x66 -- MapGetMapIndex()=3D0  116=3D =

+kUOAM_Facet.tram	=3D 0x74 -- MapGetMapIndex()=3D1  102=3D
+kUOAM_Facet.ilsh	=3D 0x69 -- MapGetMapIndex()=3D2  105=3D
+kUOAM_Facet.malas	=3D 0x6D -- MapGetMapIndex()=3D3  109=3D
+kUOAM_Facet.tokuno	=3D 0x73 -- MapGetMapIndex()=3D4  115=3D
+                                             =

 =

 gUOAMPacketTemplate_Handshake =3D {
 0x05, 0x00, 0x0b, 0x03, 0x10, 0x00, 0x00, 0x00, =


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Sun Oct 19 17:42:14 2008
@@ -26,6 +26,8 @@
 function gWidgetPrototype.UOMobList:Init (parentwidget,params)
 	self:InitAsGroup(parentwidget,params)
 	self.items =3D {}
+	self.partyWidgetList =3D {}
+	self.uoamWidgetList =3D {}
 	self.catgroup =3D {}
 	for i=3D1,kMobList_MaxCat do self.catgroup[i] =3D self:CreateChild("Group=
") end
 	=

@@ -41,6 +43,45 @@
 	RegisterListener("Hook_Object_CreateMobile",	function (mobile)	self:AddMo=
b(mobile) end)
 	RegisterListener("Hook_Object_DestroyMobile",	function (mobile)	self:Remo=
veMob(mobile) end)
 	RegisterListener("Hook_UpdatePartyMemberList",	function ()			self:RecalcC=
at() end)
+end
+
+-- triggered when uoam-data-packet is received
+function gWidgetPrototype.UOMobList:UOAMUpdate	()
+	local uoamWidgetList =3D self.uoamWidgetList
+	local uoamPosList =3D UOAM_GetOtherPositions()
+	for name,data in pairs(uoamPosList) do -- {xloc=3D?,yloc=3D?,bIsOnSameFac=
et=3D?}
+		local widget =3D uoamWidgetList[name]
+		if (not widget) then =

+			widget =3D gRootWidget.tooltip:CreateChild("UOText",{x=3D0,y=3D0,text=
=3Dname,col=3D{r=3D0,g=3D1,b=3D0},bold=3Dtrue})
+			uoamWidgetList[name] =3D widget
+		end
+		widget.xloc,widget.yloc =3D data.xloc,data.yloc
+		widget.bIsOnSameFacet =3D data.bIsOnSameFacet
+	end
+	for name,widget in pairs(uoamWidgetList) do
+		if (not uoamPosList[name]) then -- logged out
+			widget:Destroy()
+			uoamWidgetList[name] =3D nil
+		end
+	end
+end
+
+-- every frame
+function gWidgetPrototype.UOMobList:UOAMStep	()
+	for name,widget in pairs(self.uoamWidgetList) do -- {xloc=3D?,yloc=3D?,bI=
sOnSameFacet=3D?}
+		local xloc,yloc,zloc =3D widget.xloc,widget.yloc,0
+		local px,py =3D gCurrentRenderer:UOPosToPixelPos(xloc,yloc,zloc)
+		local w,h =3D widget:GetSize()
+		local minx,miny,maxx,maxy =3D 0,64,gViewportW-160,gViewportH-32
+		local x =3D max(minx,min(maxx-w,(px or 0)-0.5*w))
+		local y =3D max(miny,min(maxy-h,(py or 0)))
+		widget:SetPos(x,y)
+		if (widget.oldbIsOnSameFacet ~=3D widget.bIsOnSameFacet) then
+			widget.oldbIsOnSameFacet =3D widget.bIsOnSameFacet =

+			widget.params.col =3D widget.bIsOnSameFacet and {r=3D0,g=3D1,b=3D0} or =
{r=3D0.5,g=3D0.5,b=3D0.5}
+			widget:SetText(name)
+		end
+	end
 end
 =

 function gWidgetPrototype.UOMobList:ToolTipUpdate		(serial)
@@ -102,6 +143,8 @@
 	end
 	for item,v in pairs(self.items) do item:Step() end
 	=

+	-- uoam-name-widgets
+	self:UOAMStep()
 	=

 	-- maintarget text : update position on screen
 	if (self.maintarget_serial) then
@@ -282,7 +325,7 @@
 =

 function MobListGetMainTargetSerial() return gMobList.maintarget_serial end
 =

-RegisterListener("Hook_UOAM_PosUpdate",function () end)
+RegisterListener("Hook_UOAM_PosUpdate",function () gMobList:UOAMUpdate() e=
nd)
 RegisterListener("Hook_PostLoad",function () gMobList =3D GetDesktopWidget=
():CreateChild("UOMobList") end)
 =

 end



From no-reply at zwischenwelt.org  Sun Oct 19 17:14:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 15:14:25 -0000
Subject: [Iris-commit] [IRIS] r2601 - in /trunk: lua/lib.uoam.lua
 lua/net.walk.lua plugins/lib.spellbar.lua plugins/moblist.lua
Message-ID: <20081019160005.1A8341524030@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 17:14:25 2008
New Revision: 2601

Log:
uoam support added ingame, uoam : added facet-info support,  walk-request-t=
imeout added (resync request if stuck)

Modified:
    trunk/lua/lib.uoam.lua
    trunk/lua/net.walk.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.uoam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoam.lua (original)
+++ trunk/lua/lib.uoam.lua Sun Oct 19 17:14:25 2008
@@ -2,6 +2,15 @@
 =

 gUOAMSequenceNumber =3D 1
 gUOAMChunkPrintToggle =3D false
+
+
+kUOAM_Facet =3D {}
+kUOAM_Facet.felu	=3D 0x66 -- MapGetMapIndex()=3D0  =

+kUOAM_Facet.tram	=3D 0x74 -- MapGetMapIndex()=3D1
+kUOAM_Facet.ilsh	=3D 0x69 -- MapGetMapIndex()=3D2  =

+kUOAM_Facet.malas	=3D 0x6D -- MapGetMapIndex()=3D3  =

+kUOAM_Facet.tokuno	=3D 0x73 -- MapGetMapIndex()=3D4  =

+
 =

 gUOAMPacketTemplate_Handshake =3D {
 0x05, 0x00, 0x0b, 0x03, 0x10, 0x00, 0x00, 0x00, =

@@ -15,24 +24,73 @@
 0x2b, 0x10, 0x48, 0x60, 0x02, 0x00, 0x00, 0x00 }
 =

 gUOAMPacketTemplate_PosUpdate =3D {
-0x05, 0x00, 0x00, 0x03, 0x10, 0x00, 0x00, 0x00, =

-0x8c, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, =

-0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, =

-0x70, 0x61, 0x73, 0x73, 0x61, 0x62, 0x63, 0x64, =

-0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c, =

-0x6d, 0x6e, 0x6f, 0x00, 0x0a, 0x00, 0x02, 0x0f, =

-0x75, 0x6e, 0x61, 0x6d, 0x65, 0x61, 0x62, 0x63, =

-0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b, =

-0x6c, 0x6d, 0x6e, 0x6f, 0x70, 0x71, 0x72, 0x73, =

-0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7a, 0x41, =

-0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49, =

-0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f, 0x50, 0x51, =

-0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x00, 0x00, =

-0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, =

-0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, =

-0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x74, =

-0x78, 0x05, 0x00, 0x00, 0xfb, 0x0e, 0x00, 0x00, =

+0x05, 0x00, 0x00, 0x03, 0x10, 0x00, 0x00, 0x00,	-- 0
+0x8c, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00,	-- 8 =

+0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,	-- 16
+0x70, 0x61, 0x73, 0x73, 0x61, 0x62, 0x63, 0x64,	-- 24
+0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b, 0x6c,	-- 32
+0x6d, 0x6e, 0x6f, 0x00, 0x0a, 0x00, 0x02, 0x0f,	-- 40
+0x75, 0x6e, 0x61, 0x6d, 0x65, 0x61, 0x62, 0x63,	-- 48
+0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6a, 0x6b,	-- 56
+0x6c, 0x6d, 0x6e, 0x6f, 0x70, 0x71, 0x72, 0x73,	-- 64
+0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7a, 0x41,	-- 72
+0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49,	-- 80
+0x4a, 0x4b, 0x4c, 0x4d, 0x4e, 0x4f, 0x50, 0x51,	-- 88
+0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x00, 0x00,	-- 96
+0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	-- 104
+0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	-- 112
+0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x74,	-- 120
+0x78, 0x05, 0x00, 0x00, 0xfb, 0x0e, 0x00, 0x00,	-- 128
 0x00, 0x00, 0x00, 0x00 }
+
+
+gNextUOAMStepT =3D 0
+gUOAMToggle =3D false
+gUOAMOtherPositions =3D {}
+
+-- {[name]=3D{xloc=3D?,yloc=3D?,bIsOnSameFacet=3D?},...}
+function UOAM_GetOtherPositions () return gUOAMOtherPositions end =

+
+function UOAM_GetMyFacetByte ()
+	local mapindex =3D MapGetMapIndex()
+	if (mapindex=3D=3D0) then return kUOAM_Facet.felu	end
+	if (mapindex=3D=3D1) then return kUOAM_Facet.tram	end
+	if (mapindex=3D=3D2) then return kUOAM_Facet.ilsh	end
+	if (mapindex=3D=3D3) then return kUOAM_Facet.malas	end
+	if (mapindex=3D=3D4) then return kUOAM_Facet.tokuno	end =

+	return kUOAM_Facet.felu
+end
+
+RegisterStepper(function ()
+	if (not gUOAMName) then return end
+	if (not gInGameStarted) then return end
+	local t =3D Client_GetTicks()
+	if (t < gNextUOAMStepT) then return end
+	local xloc,yloc,zloc =3D GetPlayerPos()
+	=

+	local facetbyte =3D UOAM_GetMyFacetByte()
+	=

+	if (not xloc) then return end
+	if (not gUOAMInitDone) then
+		gUOAMInitDone =3D true
+		gUOAMConnection =3D NetConnect(gUOAMServer,gUOAMPort)
+		gUOAMSendFIFO =3D CreateFIFO()
+		gUOAMRecvFIFO =3D CreateFIFO()
+		=

+		UOAM_SendHandShake()
+		UOAM_SendPosUpdate(gUOAMName,gUOAMPass,0x00,facetbyte,xloc,yloc) =

+	end
+	=

+	--~ print("uoam-recv",FIFOHexDump(gUOAMRecvFIFO))
+	UOAM_RecvPositions(gUOAMRecvFIFO)
+	gUOAMRecvFIFO:Clear()
+	print("uoamstep",xloc,yloc,MapGetMapIndex(),gUOAMConnection:IsConnected())
+	gUOAMToggle =3D not gUOAMToggle =

+	UOAM_SendPosUpdate(gUOAMName,gUOAMPass,gUOAMToggle and 0x02 or 0x01,facet=
byte,xloc,yloc)
+	-- toggle : 0x01 for keep alive, 0x02 to poll other char positions
+	gNextUOAMStepT =3D t + 1000
+end)
+
 =

 =

 function TestUOAM ()
@@ -53,29 +111,12 @@
 	--~ TestUOAMStream()
 	--~ os.exit(0)
 =

-	gUOAMConnection =3D NetConnect(gUOAMServer,gUOAMPort)
-	gUOAMSendFIFO =3D CreateFIFO()
-	gUOAMRecvFIFO =3D CreateFIFO()
-	=

-	UOAM_SendHandShake()
-	local x,y =3D 24,24
-	UOAM_SendPosUpdate(gUOAMName,gUOAMPass,0x00,x,y) =

 	=

 	=

 	=

 	--~ FIFOPushByteArray(gUOAMSendFIFO,gUOAMPacketTemplate_Handshake2) UOAM_=
TrafficStep()
-	local bMyToggle =3D false
 	while true do
 		for y =3D 1, 4000, 100 do
-			print("step",x,y,gUOAMConnection:IsConnected())
-			bMyToggle =3D not bMyToggle =

-			UOAM_SendPosUpdate(gUOAMName,gUOAMPass,bMyToggle and 0x02 or 0x01,x,y)
-			-- toggle : 0x01 for keep alive, 0x02 to poll other char positions
-			Client_USleep(1000)
-			=

-			--~ print("uoam-recv",FIFOHexDump(gUOAMRecvFIFO))
-			UOAM_RecvPositions(gUOAMRecvFIFO)
-			gUOAMRecvFIFO:Clear()
 		end
 	end
 	=

@@ -90,6 +131,7 @@
 	=

 	os.exit(0)
 end
+
 =

 function UOAM_RecvPositions (fifo)
 	if (fifo:Size() < 36) then return end
@@ -100,6 +142,7 @@
 	local num1 =3D fifo:PeekNetUint8(24)
 	local num2 =3D fifo:PeekNetUint8(32)
 	fifo:PopRaw(36)
+	gUOAMOtherPositions =3D {}
 	for i =3D 1,num1 do =

 		if (fifo:Size() >=3D 92) then
 			local name =3D fifo:PopFilledString(64)
@@ -109,18 +152,17 @@
 			local d =3D fifo:PopUint8()
 			local e =3D fifo:PopUint8()
 			local f =3D fifo:PopUint8()
-			local g =3D fifo:PopUint8()
+			local facetbyte =3D fifo:PopUint8()
 			local x =3D fifo:PopUint32()
 			local y =3D fifo:PopUint32()
 			local z =3D fifo:PopUint32()
-			print("uoam:recv:",a,b,c,d,e,f,g,x,y,z,name)
+			print("uoam:recv:",a,b,c,d,e,f,facetbyte,x,y,z,name)
+			if (name ~=3D gUOAMName) then =

+				gUOAMOtherPositions[name] =3D {xloc=3Dx,yloc=3Dy,bIsOnSameFacet=3DUOAM=
_GetMyFacetByte() =3D=3D facetbyte}
+			end
 		end =

 	end
---~ uoam:recv:      drag    		0       0       0       0       0       0   =
    109     86      1953    0
---~ uoam:recv:      ghon    		0       0       0       0       0       0   =
    109     1649    210     0
---~ uoam:recv:      ghoniristest    0       0       0       0       0     =
  0       116     24      24      0
-
-
+	NotifyListener("Hook_UOAM_PosUpdate")
 end
 =

 function UOAM_SendHandShake ()
@@ -179,12 +221,13 @@
 	gUOAMSequenceNumber =3D gUOAMSequenceNumber + 1
 end
 =

-function UOAM_PushPosUpdateEx (fifo,seqnum,uname,upass,i22,x,y)
+function UOAM_PushPosUpdateEx (fifo,seqnum,uname,upass,i22,facet,x,y)
 	local bytes =3D gUOAMPacketTemplate_PosUpdate
 	OverwriteByteArrayPart(bytes,13,UOAM_Long2ByteArray(seqnum))
 	OverwriteByteArrayPart(bytes,23,{i22})
 	OverwriteByteArrayPart(bytes,25,StringToByteArrayZeroTerm(StrMaxLen(upass=
,19)))
 	OverwriteByteArrayPart(bytes,49,StringToByteArrayZeroTerm(StrMaxLen(uname=
,54)))
+	OverwriteByteArrayPart(bytes,128,{facet})
 	OverwriteByteArrayPart(bytes,129,UOAM_Long2ByteArray(x))
 	OverwriteByteArrayPart(bytes,133,UOAM_Long2ByteArray(y))
 	FIFOPushByteArray(fifo,bytes)

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Sun Oct 19 17:14:25 2008
@@ -44,6 +44,7 @@
 gPlayerZLoc =3D nil
 gFastWalkKeysUsed =3D false
 =

+gWalkRequestAntiStuckTimeout =3D 0 -- Client_GetTicks()
 gNextWalkRequestTime =3D 0
 gNextWalkSequenceNumber =3D 0
 gWalkRequests =3D {}
@@ -169,7 +170,17 @@
 function ExecWalkRequestIfPossible	(iDir,bRunFlag)
 	if (not Walk_RequestTimeOk()) then return end
 	if (not FastWalk_Ok()) then return end
-	if ((not gFastWalkKeysUsed) and (not WalkQueueOkForNextSend())) then retu=
rn end
+	if (not gFastWalkKeysUsed) then =

+		if (not WalkQueueOkForNextSend()) then
+			if (Client_GetTicks() > gWalkRequestAntiStuckTimeout) then
+				print("walk:walk-request-timeout,sending resync-request")
+				Send_Movement_Resync_Request()
+			else
+				return =

+			end
+		end
+	end
+	gWalkRequestAntiStuckTimeout =3D Client_GetTicks() + 2000 -- might need r=
esync
 	iDir =3D DirWrap(iDir)
 	local iFullDir =3D BitwiseOR(iDir,bRunFlag and kWalkFlag_Run or 0) -- inc=
ludes runflag
 	=

@@ -257,6 +268,7 @@
 end
 =

 -- reset WalkSeq. and Stack
+-- WARNING ! don't forget doomlist, should't always need to be cleared tho=
ugh, only on teleport ?
 function ResetWalkQueue ()
 	--~ WalkLog("ResetWalkQueue start")
 	gNextWalkSequenceNumber =3D 0
@@ -264,6 +276,7 @@
 	gWalkPathToGo =3D nil
 	--~ WalkLog("ResetWalkQueue end")
 end
+function WalkClearDoomList () gDoomedWalkRequests =3D {} end
 =

 gDoomedWalkRequests =3D {}
 =

@@ -356,6 +369,7 @@
 	UpdatePlayerBodySerial(mobiledata.serial) -- is this packet really only u=
sed for the player ??
 	=

 	ResetWalkQueue()
+	WalkClearDoomList()
 	SetPlayerPos(mobiledata.xloc,mobiledata.yloc,mobiledata.zloc,mobiledata.d=
ir) -- always call this, affects gPlayerPos
 	gCurrentRenderer:NotifyPlayerTeleported()
 	MultiTexTerrain_NotifyTeleport()

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 19 17:14:25 2008
@@ -149,6 +149,9 @@
  =

 gSpellbarShortMessages[501284] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"You may=
 not enter." } -- You may not enter.
 gSpellbarShortMessages[500111] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"frozen"=
 			} -- You are frozen and cannot move. =

+gSpellbarShortMessages[502381] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"cannot =
move!" 		} -- You cannot move!
+gSpellbarShortMessages[502382] =3D {r=3D0.0,g=3D0.5,b=3D0.0,txt=3D"can mov=
e!" 		} -- You can move!
+
 =

 --[[
 Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Sun Oct 19 17:14:25 2008
@@ -282,6 +282,7 @@
 =

 function MobListGetMainTargetSerial() return gMobList.maintarget_serial end
 =

+RegisterListener("Hook_UOAM_PosUpdate",function () end)
 RegisterListener("Hook_PostLoad",function () gMobList =3D GetDesktopWidget=
():CreateChild("UOMobList") end)
 =

 end



From no-reply at zwischenwelt.org  Sun Oct 19 18:12:12 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 16:12:12 -0000
Subject: [Iris-commit] [IRIS] r2603 - /trunk/data/profiles/gfx_ultrahigh.lua
Message-ID: <20081019161213.1BBBC1C181B8@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 18:12:11 2008
New Revision: 2603

Log:
deactivated caelum skybox in ultrahigh, as this seems to trigger crash when=
 recalling into/outside a cave

Modified:
    trunk/data/profiles/gfx_ultrahigh.lua

Modified: trunk/data/profiles/gfx_ultrahigh.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/profiles/gfx_ultrahigh.lua (original)
+++ trunk/data/profiles/gfx_ultrahigh.lua Sun Oct 19 18:12:11 2008
@@ -7,7 +7,8 @@
 gConfig:Set("gDynamicsCastShadows",true)
 gConfig:Set("gMobileCastShadows",true)
 =

-gConfig:Set("gUseCaelumSkysystem",true)
+--~ gConfig:Set("gUseCaelumSkysystem",true)  19.10 : deactivated, as this =
seems to trigger crash when recalling into/outside a cave : =

+	-- http://www.vetus-mundus.de/phpbb2/viewtopic.php?p=3D107468#107468
 =

 gConfig:Set("gArtMapLoaderType","FullFile")
 =




From no-reply at zwischenwelt.org  Sun Oct 19 18:59:22 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 16:59:22 -0000
Subject: [Iris-commit] [IRIS] r2604 - in /trunk/lua: lib.loading.lua
 obj/obj.main.lua obj/obj.mobile.lua obj/obj.player.lua
 widgets/widget.uocontainer.lua
Message-ID: <20081019165923.449FD1C18030@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 18:59:21 2008
New Revision: 2604

Log:
auto-open backpack and prevent closing backpack on invis and recall/mapchan=
ge

Modified:
    trunk/lua/lib.loading.lua
    trunk/lua/obj/obj.main.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/obj/obj.player.lua
    trunk/lua/widgets/widget.uocontainer.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Sun Oct 19 18:59:21 2008
@@ -328,7 +328,7 @@
 	=

 	-- unloading of all objects must happen immediately on change request, =

 	-- otherwise items sent after changerequest might be destroyed
-	UnloadOldMap()
+	UnloadOldMap(false,true) -- clear objects, but not player
 	=

 	-- TODO ! don't trigger mapload here, as some servers send a lot of mapch=
anges in a row
 	-- problem : loaders are needed instantly (sky,ground,static,compass)
@@ -343,11 +343,11 @@
 end
 =

 -- destroys old items, and cleans up old static,ground loaders
-function UnloadOldMap (bDoNotClearObjects)
+function UnloadOldMap (bDoNotClearObjects,bDontClearPlayer)
 	if (not gMapLoaded) then return end
 	gMapLoaded =3D false
 	-- destroy all objects
-	if (not bDoNotClearObjects) then DestroyAllObjects() end
+	if (not bDoNotClearObjects) then DestroyAllObjects(bDontClearPlayer) end
 	-- destroy old ground and static loaders
 	if (gGroundBlockLoader) then gGroundBlockLoader:Destroy() gGroundBlockLoa=
der =3D nil end
 	if (gStaticBlockLoader) then gStaticBlockLoader:Destroy() gStaticBlockLoa=
der =3D nil end

Modified: trunk/lua/obj/obj.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.main.lua (original)
+++ trunk/lua/obj/obj.main.lua Sun Oct 19 18:59:21 2008
@@ -102,9 +102,21 @@
 end
 =

 -- needed for mapchange
-function DestroyAllObjects () =

+function DestroyAllObjects (bDontClearPlayer) =

 	CancelUODragDrop()
-	for k,object in pairs(gObjectList) do object:Destroy() end
+	local playerserial =3D GetPlayerSerial()
+	local backpackserial =3D GetPlayerBackPackSerial()
+	for k,object in pairs(gObjectList) do =

+		local bDestroy =3D true
+		if (bDontClearPlayer) then
+			if (object.serial =3D=3D playerserial or =

+				object.iContainerSerial =3D=3D playerserial or =

+				(object.iContainerSerial =3D=3D backpackserial and backpackserial)) th=
en
+				bDestroy =3D false
+			end
+		end
+		if (bDestroy) then object:Destroy() end =

+	end
 end
 =

 =


Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Sun Oct 19 18:59:21 2008
@@ -152,7 +152,15 @@
 	-- full equipment overwrite
 	if (equipmentdata) then
 		self.bEquipmentUpdateInProgress =3D true -- prevent self:Update during e=
quipment update...
-		self:DestroyContent() -- destroy old equipment items
+		=

+		-- self:DestroyContent() -- destroy old equipment items  .. doesn't work=
 as expected, closes backpack when player becomes invis
+		for serial,object in pairs(self:GetContent()) do =

+			local bFound =3D false
+			for layer,dynamicdata in pairs(equipmentdata) do =

+				if (dynamicdata.serial =3D=3D object.serial) then bFound =3D true brea=
k end
+			end
+			if (not bFound) then object:Destroy() end
+		end
 =

 		for layer,dynamicdata in pairs(equipmentdata) do
 			CreateOrUpdateDynamic(dynamicdata,self)

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Sun Oct 19 18:59:21 2008
@@ -22,6 +22,7 @@
 		if ((not gPlayerBackPack) or (gPlayerBackPack.serial ~=3D backpack.seria=
l)) then
 			-- backpack item changed
 			gPlayerBackPack =3D backpack
+			if (gPlayerBackPack) then Send_DoubleClick(gPlayerBackPack.serial) end
 		end
 	-- else TODO : maybe check if backpack was removed ? must look if playeri=
d is available so far
 	end

Modified: trunk/lua/widgets/widget.uocontainer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uocontainer.lua (original)
+++ trunk/lua/widgets/widget.uocontainer.lua Sun Oct 19 18:59:21 2008
@@ -25,6 +25,11 @@
 	self:RefreshItems()
 end
 =

+--~ function gWidgetPrototype.UOContainerDialog:on_destroy ()
+	--~ local container		=3D self.uoContainer
+	--~ print("container destroy",container and container.serial,_TRACEBACK())
+--~ end
+	=

 function gWidgetPrototype.UOContainerDialog:RefreshItems ()
 	local container =3D self.uoContainer
 	--~ print("UOContainerDialog : gumpid",container.gumpid)



From no-reply at zwischenwelt.org  Sun Oct 19 19:24:04 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 17:24:04 -0000
Subject: [Iris-commit] [IRIS] r2605 - /trunk/lua/lib.macrolist.lua
Message-ID: <20081019180004.744841C181D5@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 19:24:04 2008
New Revision: 2605

Log:
extended macro find command to return a list

Modified:
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Sun Oct 19 19:24:04 2008
@@ -249,19 +249,27 @@
 =

 function MacroCmd_Item_Use	(item) if (item) then Send_DoubleClick(item.ser=
ial) return item end end
 =

-function MacroCmd_Item_UseByName	(itemnamepart)	return MacroCmd_Item_Use(M=
acroCmd_Item_FindByName(itemnamepart)) end
-function MacroCmd_Item_UseByArtID	(artid,hue)		return MacroCmd_Item_Use(Ma=
croCmd_Item_FindByArtID(artid,hue)) end
+function MacroCmd_Item_UseByName	(itemnamepart)	return MacroCmd_Item_Use(M=
acroCmd_Item_FindFirstByName(itemnamepart)) end
+function MacroCmd_Item_UseByArtID	(artid,hue)		return MacroCmd_Item_Use(Ma=
croCmd_Item_FindFirstByArtID(artid,hue)) end
+
+function MacroCmd_Item_FindFirstByName	(itemnamepart,container) local list=
 =3D MacroCmd_Item_FindByName(itemnamepart,container) return list[1] end
+function MacroCmd_Item_FindFirstByArtID	(artid,hue,container) local list =
=3D MacroCmd_Item_FindByArtID(artid,hue,container) return list[1] end
+
+-- doesn't sum stack-amount
+function MacroCmd_Item_CountByArtID	(artid,hue,container) local list =3D M=
acroCmd_Item_FindByArtID(artid,hue,container) return list and #list or 0 end
 =

 -- container defaults to player-backpack
 function MacroCmd_Item_FindByName	(itemnamepart,container)
 	container =3D container or GetPlayerBackPackContainer()
 	if (not container) then return end
+	local res =3D {}
 	for k,item in pairs(container:GetContent()) do =

 		local name =3D AosToolTip_GetText(item.serial) or GetStaticTileTypeName(=
item.artid)
 		if (name and string.find(name,itemnamepart)) then
-			return item
-		end
-	end
+			table.insert(res,item)
+		end
+	end
+	return res
 end
 =

 -- container defaults to player-backpack
@@ -269,11 +277,13 @@
 function MacroCmd_Item_FindByArtID	(artid,hue,container) -- equals easyuo =
type
 	container =3D container or GetPlayerBackPackContainer()
 	if (not container) then return end
+	local res =3D {}
 	for k,item in pairs(container:GetContent()) do =

 		if (item.artid =3D=3D artid and (hue =3D=3D nil or hue =3D=3D item.hue))=
 then
-			return item
-		end
-	end
+			table.insert(res,item)
+		end
+	end
+	return res
 end
 =

 function MacroCmd_FindNearestMobByName (namepart)



From no-reply at zwischenwelt.org  Sun Oct 19 19:59:41 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 17:59:41 -0000
Subject: [Iris-commit] [IRIS] r2606 - in /trunk/lua: lib.packet.lua
 lib.protocol.lua net/net.other.lua net/net.partysystem.lua
Message-ID: <20081019180004.D299F1C18030@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 19:59:41 2008
New Revision: 2606

Log:
added support for uo-protocol extension : 0xF0 packets, used by razor mini-=
map to query and display party member positions outside visible range

Modified:
    trunk/lua/lib.packet.lua
    trunk/lua/lib.protocol.lua
    trunk/lua/net/net.other.lua
    trunk/lua/net/net.partysystem.lua

Modified: trunk/lua/lib.packet.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packet.lua (original)
+++ trunk/lua/lib.packet.lua Sun Oct 19 19:59:41 2008
@@ -237,6 +237,7 @@
 gPacketType.kPacket_unknownDEpacket									=3D { id=3D0xDE }
 -- buff/debuff packet
 gPacketType.kPacket_BuffDebuff_System								=3D { id=3D0xDF }
+gPacketType.kPacket_ExtBundledPacket								=3D { id=3D0xF0 } -- party pos=
itions, used by razor positioning system
 =

 --[[
 gPacketType.kPacket_								=3D { id=3D0xE0 }

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Sun Oct 19 19:59:41 2008
@@ -15,9 +15,9 @@
 -- changed NecroPacketData - (0x0B oldsize=3D"0x010A" , damage packet)
 -- packet sizes from necrotoolz.sourceforge.net/kairpacketguide/index.html=
 (0 means dynamic) contains all sizes from 0x00 to 0xDB
 gNecroPacketData_ID 	=3D {  "0x00",  "0x01",  "0x02",  "0x03",  "0x04",  "=
0x05",  "0x06",  "0x07",  "0x08",  "0x09",  "0x0A",  "0x0B",  "0x0C",  "0x0=
D",  "0x0E",  "0x0F",  "0x10",  "0x11",  "0x12",  "0x13",  "0x14",  "0x15",=
  "0x16",  "0x17",  "0x18",  "0x19",  "0x1A",  "0x1B",  "0x1C",  "0x1D",  "=
0x1E",  "0x1F",  "0x20",  "0x21",  "0x22",  "0x23",  "0x24",  "0x25",  "0x2=
6",  "0x27",  "0x28",  "0x29",  "0x2A",  "0x2B",  "0x2C",  "0x2D",  "0x2E",=
  "0x2F",  "0x30",  "0x31",  "0x32",  "0x33",  "0x34",  "0x35",  "0x36",  "=
0x37",  "0x38",  "0x39",  "0x3A",  "0x3B",  "0x3C",  "0x3D",  "0x3E",  "0x3=
F",  "0x40",  "0x41",  "0x42",  "0x43",  "0x44",  "0x45",  "0x46",  "0x47",=
  "0x48",  "0x49",  "0x4A",  "0x4B",  "0x4C",  "0x4D",  "0x4E",  "0x4F",  "=
0x50",  "0x51",  "0x52",  "0x53",  "0x54",  "0x55",  "0x56",  "0x57",  "0x5=
8",  "0x59",  "0x5A",  "0x5B",  "0x5C",  "0x5D",  "0x5E",  "0x5F",  "0x60",=
  "0x61",  "0x62",  "0x63",  "0x64",  "0x65",  "0x66",  "0x67",  "0x68",  "=
0x69",  "0x6A",  "0x6B",  "0x6C",  "0x6D",  "0x6E",  "0x6F",  "0x70",  "0x7=
1",  "0x72",  "0x73",  "0x74",  "0x75",  "0x76",  "0x77",  "0x78",  "0x79",=
  "0x7A",  "0x7B",  "0x7C",  "0x7D",  "0x7E",  "0x7F",  "0x80",  "0x81",  "=
0x82",  "0x83",  "0x84",  "0x85",  "0x86",  "0x87",  "0x88",  "0x89",  "0x8=
A",  "0x8B",  "0x8C",  "0x8D",  "0x8E",  "0x8F",  "0x90",  "0x91",  "0x92",=
  "0x93",  "0x94",  "0x95",  "0x96",  "0x97",  "0x98",  "0x99",  "0x9A",  "=
0x9B",  "0x9C",  "0x9D",  "0x9E",  "0x9F",  "0xA0",  "0xA1",  "0xA2",  "0xA=
3",  "0xA4",  "0xA5",  "0xA6",  "0xA7",  "0xA8",  "0xA9",  "0xAA",  "0xAB",=
  "0xAC",  "0xAD",  "0xAE",  "0xAF",  "0xB0",  "0xB1",  "0xB2",  "0xB3",  "=
0xB4",  "0xB5",  "0xB6",  "0xB7",  "0xB8",  "0xB9",  "0xBA",  "0xBB",  "0xB=
C",  "0xBD",  "0xBE",  "0xBF",  "0xC0",  "0xC1",  "0xC2",  "0xC3",  "0xC4",=
  "0xC5",  "0xC6",  "0xC7",  "0xC8",  "0xC9",  "0xCA",  "0xCB",  "0xCC",  "=
0xCD",  "0xCE",  "0xCF",  "0xD0",  "0xD1",  "0xD2",  "0xD3",  "0xD4",  "0xD=
5",  "0xD6",  "0xD7",  "0xD8",  "0xD9",  "0xDA",  "0xDB",  "0xDC",
-"0xDD", "0xDE", "0xDF"}
+  "0xDD", "0xDE", "0xDF",  "0xF0"}
 gNecroPacketData_Size 	=3D {"0x0068","0x0005","0x0007",     "0","0x0002","=
0x0005","0x0005","0x0007","0x000E","0x0005","0x000B","0x0007",     "0","0x0=
003",     "0","0x003D","0x00D7",     "0",     "0","0x000A","0x0006","0x0009=
","0x0001",     "0",     "0",     "0",     "0","0x0025",     "0","0x0005","=
0x0004","0x0008","0x0013","0x0008","0x0003","0x001A","0x0007","0x0014","0x0=
005","0x0002","0x0005","0x0001","0x0005","0x0002","0x0002","0x0011","0x000F=
","0x000A","0x0005","0x0001","0x0002","0x0002","0x000A","0x028D",     "0","=
0x0008","0x0007","0x0009",     "0",     "0",     "0","0x0002","0x0025",    =
 "0","0x00C9",     "0",     "0","0x0229","0x02C9","0x0005",     "0","0x000B=
","0x0049","0x005D","0x0005","0x0009",     "0",     "0","0x0006","0x0002", =
    "0",     "0",     "0","0x0002","0x000C","0x0001","0x000B","0x006E","0x0=
06A",     "0",     "0","0x0004","0x0002","0x0049",     "0","0x0031","0x0005=
","0x0009","0x000F","0x000D","0x0001","0x0004",     "0","0x0015",     "0", =
    "0","0x0003","0x0009","0x0013","0x0003","0x000E",     "0","0x001C",    =
 "0","0x0005","0x0002",     "0","0x0023","0x0010","0x0011",     "0","0x0009=
",     "0","0x0002",     "0","0x000D","0x0002",     "0","0x003E",     "0","=
0x0002","0x0027","0x0045","0x0002",     "0",     "0","0x0042",     "0",    =
 "0",     "0","0x000B",     "0",     "0",     "0","0x0013","0x0041",     "0=
","0x0063",     "0","0x0009",     "0","0x0002",     "0","0x001A",     "0","=
0x0102","0x0135","0x0033",     "0",     "0","0x0003","0x0009","0x0009","0x0=
009","0x0095",     "0",     "0","0x0004",     "0",     "0","0x0005",     "0=
",     "0",     "0",     "0","0x000D",     "0",     "0",     "0",     "0", =
    "0","0x0040","0x0009",     "0",     "0","0x0003","0x0006","0x0009","0x0=
003",     "0",     "0",     "0","0x0024",     "0",     "0",     "0","0x0006=
","0x00CB","0x0001","0x0031","0x0002","0x0006","0x0006","0x0007",     "0","=
0x0001",     "0","0x004E",     "0","0x0002","0x0019",     "0",     "0",    =
 "0",     "0",     "0",     "0","0x010C",     "0",     "0","0x0009",
-"0", "0", "0"}
+     "0",    "0",    "0",     "0"}
 =

 gNecroPacketSize =3D {}
 for i =3D 1,table.getn(gNecroPacketData_ID) do =


Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sun Oct 19 19:59:41 2008
@@ -139,6 +139,58 @@
 	out:SendPacket()
 end
 =

+kPacket_ExtSubCommand_PartyQueryPos		=3D 0x00
+kPacket_ExtSubCommand_PartyPosAck		=3D 0x01
+
+-- answer : kPacket_ExtBundledPacket
+function	PartySendQueryPos () =

+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_ExtBundledPacket) -- 0xF0
+	out:PushNetUint16(4)
+	out:PushNetUint8(kPacket_ExtSubCommand_PartyQueryPos)  =

+	out:SendPacket()
+end
+
+
+-- party positon, has to be requested regularly : PartySendQueryPos
+function gPacketHandler.kPacket_ExtBundledPacket() -- 0xF0
+	local input =3D GetRecvFIFO()
+	local popped_start =3D input:GetTotalPopped()
+	local id =3D input:PopNetUint8()
+	local size =3D input:PopNetUint16()
+	local subcmd =3D input:PopNetUint8()
+	=

+	if (subcmd =3D=3D kPacket_ExtSubCommand_PartyPosAck) then
+		local partyposlist =3D {}
+		while (true) do
+			local memberpos =3D {}
+			memberpos.serial	=3D input:PopNetUint32()
+			if (memberpos.serial =3D=3D 0) then break end -- termination
+			memberpos.xloc		=3D input:PopNetUint16()
+			memberpos.yloc		=3D input:PopNetUint16()
+			memberpos.facet		=3D input:PopNetUint8() -- mapid
+			print("partypos",memberpos.serial,memberpos.xloc,memberpos.yloc,memberp=
os.facet)
+			partyposlist[memberpos.serial] =3D memberpos
+		end
+		NotifyListener("Hook_PartyPos",partyposlist)	=

+	end
+	=

+
+	-- check if all data was used
+	local used =3D input:GetTotalPopped() - popped_start
+	local rest =3D size - used
+	if (rest < 0) then
+		printf("FATAL ! kPacket_ExtBundledPacket : subcmd 0x%02x (used=3D%d size=
=3D%d) popped too much\n",subcmd,used,size)
+		print("FATAL ! kPacket_ExtBundledPacket -> forced Crash")
+		Crash()
+	end
+	if (rest > 0) then
+		printf("WARNING ! kPacket_ExtBundledPacket : subcmd 0x%02x (used=3D%d si=
ze=3D%d) popped to few\n",subcmd,used,size)
+		input:PopRaw(rest)
+	end
+end
+
+
 -- TODO : implement all subpackets
 function gPacketHandler.kPacket_Generic_Command()
 	local input =3D GetRecvFIFO()
@@ -146,7 +198,7 @@
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local subcmd =3D input:PopNetUint16()
-	--~ printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D=
%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
+	printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D%s\n=
",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
 	printdebug("net",sprintf("NET: kPacket_Generic_Command size=3D0x%04x subc=
md=3D0x%04x=3D%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd=
])))
 =

 	-- FastWalkInit : 6 keys (runuo's fifosize 0-255)

Modified: trunk/lua/net/net.partysystem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.partysystem.lua (original)
+++ trunk/lua/net/net.partysystem.lua Sun Oct 19 19:59:41 2008
@@ -8,6 +8,19 @@
 gPartySystemSubSubCmd.kPartySubCmd_AcceptInvite		=3D 8
 gPartySystemSubSubCmd.kPartySubCmd_DeclineInvite	=3D 9
 for k,v in pairs(gPartySystemSubSubCmd) do _G[k] =3D v end
+
+
+gPartyPosQueryNextT =3D 0
+gPartyPosQueryInterval =3D 1000
+RegisterStepper(function ()
+	if (not gInGameStarted) then return end
+	local t =3D Client_GetTicks()
+	if (t < gPartyPosQueryNextT) then return end
+	gPartyPosQueryNextT =3D t + gPartyPosQueryInterval
+	PartySendQueryPos()
+end)
+
+
 =

 gPartySystemHandler =3D {}
 gPartySystemMemberList =3D {}



From no-reply at zwischenwelt.org  Sun Oct 19 21:30:24 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 19:30:24 -0000
Subject: [Iris-commit] [IRIS] r2609 - in /trunk/lua: gui/gui.gumpparser.lua
 widgets/widget.uotext.lua
Message-ID: <20081019200004.287F21C18043@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 21:30:24 2008
New Revision: 2609

Log:
gumpparser added xmfhtmltok

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/widgets/widget.uotext.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sun Oct 19 21:30:24 2008
@@ -162,6 +162,12 @@
 function GumpParser_ParseToken (token,tokenformat,paramadd)
 	local res =3D paramadd and CopyArray(paramadd) or {}
 	for k,fieldname in ipairs(explode(",",tokenformat)) do
+		if (fieldname =3D=3D "[...]") then =

+			local myargs =3D {}
+			for k2=3Dk+1,#token do table.insert(myargs,token[k+1]) end
+			res.args =3D myargs
+			return res
+		end
 		if (fieldname =3D=3D "...") then return res end
 		local tokenval =3D token[k+1]
 		-- [param] is optional
@@ -188,8 +194,6 @@
 =

 kGumpParser_CommandTypes =3D {}
 kGumpParser_CommandTypes["page"]				=3D {paramformat=3D"pagenum"}
-kGumpParser_CommandTypes["xmfhtmlgump"]			=3D {paramformat=3D"x,y,width,he=
ight,cliloc_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=
=3Dtrue,html=3Dtrue}} =

-kGumpParser_CommandTypes["xmfhtmlgumpcolor"]	=3D {paramformat=3D"x,y,width=
,height,cliloc_id,background,scrollbar,hue,[ctrlname]",paramadd=3D{html=3Dt=
rue}}
 kGumpParser_CommandTypes["croppedtext"]			=3D {paramformat=3D"x,y,width,he=
ight,hue,textline_id,[ctrlname]",paramadd=3D{crop=3Dtrue}}
 kGumpParser_CommandTypes["htmlgump"]			=3D {paramformat=3D"x,y,width,heigh=
t,textline_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=3D=
true,html=3Dtrue}} =

 kGumpParser_CommandTypes["text"]				=3D {paramformat=3D"x,y,hue,textline_i=
d,[ctrlname]",paramadd=3D{bold=3Dfalse,default_black=3Dtrue}}
@@ -206,7 +210,12 @@
 kGumpParser_CommandTypes["group"]				=3D {paramformat=3D"groupnumber"}
 kGumpParser_CommandTypes["textentry"]			=3D {paramformat=3D"x,y,width,heig=
ht,hue,return_value,textline_id_default,[ctrlname]"}
 kGumpParser_CommandTypes["gumppic"]				=3D {paramformat=3D"x,y,gump_id,...=
"}
-				=

+kGumpParser_CommandTypes["xmfhtmlgump"]			=3D {paramformat=3D"x,y,width,he=
ight,cliloc_id,background,scrollbar,[ctrlname]",paramadd=3D{default_black=
=3Dtrue,html=3Dtrue}} =

+kGumpParser_CommandTypes["xmfhtmlgumpcolor"]	=3D {paramformat=3D"x,y,width=
,height,cliloc_id,background,scrollbar,hue,[ctrlname]",paramadd=3D{html=3Dt=
rue}}
+kGumpParser_CommandTypes["xmfhtmltok"]			=3D {paramformat=3D"x,y,width,hei=
ght,background,scrollbar,hue,cliloc_id,[...]",paramadd=3D{html=3Dtrue}}
+
+-- see also http://www.iris2.de/index.php/Gump_reference_(from_Pol_Forum)
+
 =

 function GumpParser_DebugDumpGump (Gumpdata)
 	-- debug dump
@@ -299,6 +308,11 @@
 		--xmfhtmlgumpcolor <x> <y> <width> <height> <cliloc_id> <background> <sc=
rollbar> <hue>
 		--Description:	background=3D0/1=3Dtransparent?  scrollbar=3D0/1=3Ddispla=
yed
 		elseif (command =3D=3D "xmfhtmlgumpcolor") then
+			widget =3D parent:CreateChild("UOText",param)
+			=

+		-- xmfhtmltok <x> <y> <width> <height> <background> <scrollbar> <hue> <c=
liloc_id> <...>
+		--~ Description: Similar to xmfhtmlgumpcolor command, but the parameter =
order is different and an additionally [argument] entry enclosed with @'s c=
an be used. With this you can specify texts that will be added to the CliLo=
c entry.
+		elseif (command =3D=3D "xmfhtmltok") then
 			widget =3D parent:CreateChild("UOText",param)
 			=

 		-- croppedtext <x> <y> <width> <height> <hue> <textline_id>

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Sun Oct 19 21:30:24 2008
@@ -26,7 +26,21 @@
 	params.text =3D nil
 	gWidgetPrototype.Text.Init(self,parentwidget,params)
 	self:SetIgnoreBBoxHit(true)
-	self:SetUOHtml(text or (params.textline_id and textlines[params.textline_=
id]) or (gClilocLoader and gClilocLoader:Get(params.cliloc_id) or "no_clilo=
c"),bParseHTML)
+	=

+	if (not text) then
+		if (params.textline_id) then text =3D textlines[params.textline_id] =

+		elseif (params.cliloc_id and gClilocLoader) then =

+			if (params.args) then =

+				text =3D ParameterizedClilocText(params.cliloc_id,params.args)
+			else
+				text =3D gClilocLoader:Get(params.cliloc_id) or "no_cliloc" =

+			end
+		end
+	end
+	=

+	=

+	=

+	self:SetUOHtml(text,bParseHTML)
 	--~ self:SetPos(params.x,params.y)
 	local xoff,yoff =3D -1,-2
 	self:SetPos(floor(params.x+xoff),floor(params.y+yoff))



From no-reply at zwischenwelt.org  Sun Oct 19 21:11:22 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 19:11:22 -0000
Subject: [Iris-commit] [IRIS] r2608 - /trunk/lua/gui/gui.gumpparser.lua
Message-ID: <20081019200004.1A2121C18020@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 21:11:22 2008
New Revision: 2608

Log:
gumpparser fix (error in warning output)

Modified:
    trunk/lua/gui/gui.gumpparser.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Sun Oct 19 21:11:22 2008
@@ -417,7 +417,8 @@
 		=

 		-- UNKNOWN...
 		else
-			printdebug("gump","UNKNOWN Generic Gump Command: "..strjoin(bToken))
+			print("UNKNOWN Generic Gump Command: "..strjoin(",",bToken))
+			printdebug("gump","UNKNOWN Generic Gump Command: "..strjoin(",",bToken))
 		end
 		=

 		if (param and param.ctrlname) then dialog.controls[param.ctrlname] =3D w=
idget end



From no-reply at zwischenwelt.org  Sun Oct 19 21:05:29 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 19:05:29 -0000
Subject: [Iris-commit] [IRIS] r2607 - in /trunk: lua/net/net.other.lua
 lua/net/net.partysystem.lua plugins/moblist.lua
Message-ID: <20081019200003.F21051C1807F@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 21:05:28 2008
New Revision: 2607

Log:
moblist : code to show party member position

Modified:
    trunk/lua/net/net.other.lua
    trunk/lua/net/net.partysystem.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sun Oct 19 21:05:28 2008
@@ -169,10 +169,10 @@
 			memberpos.xloc		=3D input:PopNetUint16()
 			memberpos.yloc		=3D input:PopNetUint16()
 			memberpos.facet		=3D input:PopNetUint8() -- mapid
-			print("partypos",memberpos.serial,memberpos.xloc,memberpos.yloc,memberp=
os.facet)
+			--~ print("partypos",memberpos.serial,memberpos.xloc,memberpos.yloc,mem=
berpos.facet)
 			partyposlist[memberpos.serial] =3D memberpos
 		end
-		NotifyListener("Hook_PartyPos",partyposlist)	=

+		NotifyListener("Hook_PartyPos",partyposlist) -- {[serial]=3D{serial=3D?,=
xloc=3D?,yloc=3D?,facet=3D?},...}
 	end
 	=

 =

@@ -191,6 +191,12 @@
 end
 =

 =

+
+
+
+
+
+
 -- TODO : implement all subpackets
 function gPacketHandler.kPacket_Generic_Command()
 	local input =3D GetRecvFIFO()
@@ -198,7 +204,7 @@
 	local id =3D input:PopNetUint8()
 	local size =3D input:PopNetUint16()
 	local subcmd =3D input:PopNetUint16()
-	printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D%s\n=
",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
+	--~ printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D=
%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
 	printdebug("net",sprintf("NET: kPacket_Generic_Command size=3D0x%04x subc=
md=3D0x%04x=3D%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd=
])))
 =

 	-- FastWalkInit : 6 keys (runuo's fifosize 0-255)

Modified: trunk/lua/net/net.partysystem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.partysystem.lua (original)
+++ trunk/lua/net/net.partysystem.lua Sun Oct 19 21:05:28 2008
@@ -26,6 +26,19 @@
 gPartySystemMemberList =3D {}
 gPartySystemMemberListByID =3D {}
 =

+gPartyMemberPosList =3D {} -- Hook_PartyPos -- {[serial]=3D{serial=3D?,xlo=
c=3D?,yloc=3D?,facet=3D?},...}  , 0xF0 packet, protocol extension
+RegisterListener("Hook_PartyPos", function (partyposlist) gPartyMemberPosL=
ist =3D partyposlist end)
+
+-- can see party members not in sightrange using 0xF0 packet
+-- returns xloc,yloc,iFacet,bIsOnSameFacet      =

+function PartySystem_GetMemberPos (serial)
+	local mapindex =3D MapGetMapIndex()
+	local pos =3D gPartyMemberPosList[serial]
+	if (pos) then return pos.xloc,pos.yloc,pos.facet,pos.facet=3D=3Dmapindex =
end
+	local mob =3D GetMobile(serial)
+	if (mob) then return mob.xloc,mob.yloc,mapindex,true end
+end
+
 function PartySystem_UpdateMemberList (memberlist)
 	gPartySystemMemberList =3D memberlist
 	gPartySystemMemberListByID =3D {}
@@ -34,8 +47,10 @@
 	NotifyListener("Hook_UpdatePartyMemberList")
 end
 =

-function IsMobileInParty		(serial) return gPartySystemMemberListByID[seria=
l] end
-function IsMobilePartyLeader	(serial) return gPartySystemMemberList[1] =3D=
=3D serial end
+
+function IsMobileInParty		(serial)	return gPartySystemMemberListByID[seria=
l] end
+function IsMobilePartyLeader	(serial)	return gPartySystemMemberList[1] =3D=
=3D serial end
+function GetPartyMemberList		() 			return gPartySystemMemberListByID end -=
- {[serial]=3Dtrue,...}
 =

 function	PartySendAccept () =

 	local out =3D GetSendFIFO()

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Sun Oct 19 21:05:28 2008
@@ -39,11 +39,61 @@
 	=

 	RegisterListener("Hook_HUDStep",				function () 		self:Step() end)
 	RegisterListener("Hook_MobName",				function (serial,name,clilocid) self:=
MobName(serial,name,clilocid) end) -- from several text/speak packets..
-	RegisterListener("Hook_ToolTipUpdate",			function (serial)	self:ToolTipUp=
date(serial) end)
+	RegisterListener("Hook_ToolTipUpdate",			function (serial)	self:ToolTipUp=
date(serial) self:UpdatePartyNameTooltip(serial) end)
 	RegisterListener("Hook_Object_CreateMobile",	function (mobile)	self:AddMo=
b(mobile) end)
 	RegisterListener("Hook_Object_DestroyMobile",	function (mobile)	self:Remo=
veMob(mobile) end)
-	RegisterListener("Hook_UpdatePartyMemberList",	function ()			self:RecalcC=
at() end)
-end
+	RegisterListener("Hook_UpdatePartyMemberList",	function ()			self:RecalcC=
at() self:UpdatePartyMemberList() end)
+	RegisterListener("Hook_UOAM_PosUpdate",			function () 		self:UOAMUpdate()=
 end)
+end
+
+function gWidgetPrototype.UOMobList:UpdatePartyNameTooltip	(serial)
+	local widget =3D self.partyWidgetList[serial]
+	if (not widget) then return end
+	widget.name =3D MobListShortenName(AosToolTip_GetText(serial) or "???")
+	widget:SetText(widget.name)
+end
+
+function gWidgetPrototype.UOMobList:UpdatePartyMemberList	()
+	local partylist =3D GetPartyMemberList() -- {[serial]=3Dtrue,...}
+	local partyWidgetList =3D self.partyWidgetList
+	for serial,v in pairs(partylist) do
+		local widget =3D partyWidgetList[serial]
+		if ((not widget) and serial ~=3D GetPlayerSerial()) then
+			local name =3D MobListShortenName(AosToolTip_GetText(serial) or "???")
+			widget =3D gRootWidget.tooltip:CreateChild("UOText",{x=3D0,y=3D0,text=
=3Dname,col=3D{r=3D0,g=3D1,b=3D0},bold=3Dtrue})
+			widget.name =3D name
+			partyWidgetList[serial] =3D widget
+		end
+	end
+	for serial,widget in pairs(partyWidgetList) do
+		if (not partylist[serial]) then -- left party
+			widget:Destroy()
+			partyWidgetList[serial] =3D nil =

+		end
+	end
+end
+
+function gWidgetPrototype.UOMobList:StepPartyMarkers	()
+	for serial,widget in pairs(self.partyWidgetList) do
+		local xloc,yloc,iFacet,bIsOnSameFacet =3D PartySystem_GetMemberPos(seria=
l)
+		local zloc =3D 0
+		=

+		if (xloc) then
+			local px,py =3D gCurrentRenderer:UOPosToPixelPos(xloc,yloc,zloc)
+			local w,h =3D widget:GetSize()
+			local minx,miny,maxx,maxy =3D 0,64,gViewportW-160,gViewportH-32
+			local x =3D max(minx,min(maxx-w,(px or 0)-0.5*w))
+			local y =3D max(miny,min(maxy-h,(py or 0)))
+			widget:SetPos(x,y)
+		end
+		if (widget.oldbIsOnSameFacet ~=3D bIsOnSameFacet) then
+			widget.oldbIsOnSameFacet =3D bIsOnSameFacet =

+			widget.params.col =3D bIsOnSameFacet and {r=3D0,g=3D1,b=3D0} or {r=3D0.=
5,g=3D0.5,b=3D0.5}
+			widget:SetText(widget.name)
+		end
+	end
+end
+
 =

 -- triggered when uoam-data-packet is received
 function gWidgetPrototype.UOMobList:UOAMUpdate	()
@@ -78,7 +128,7 @@
 		widget:SetPos(x,y)
 		if (widget.oldbIsOnSameFacet ~=3D widget.bIsOnSameFacet) then
 			widget.oldbIsOnSameFacet =3D widget.bIsOnSameFacet =

-			widget.params.col =3D widget.bIsOnSameFacet and {r=3D0,g=3D1,b=3D0} or =
{r=3D0.5,g=3D0.5,b=3D0.5}
+			widget.params.col =3D widget.bIsOnSameFacet and {r=3D0,g=3D0.5,b=3D0} o=
r {r=3D0.5,g=3D0.5,b=3D0.5}
 			widget:SetText(name)
 		end
 	end
@@ -145,6 +195,7 @@
 	=

 	-- uoam-name-widgets
 	self:UOAMStep()
+	self:StepPartyMarkers()
 	=

 	-- maintarget text : update position on screen
 	if (self.maintarget_serial) then
@@ -208,6 +259,19 @@
 	self:RecalcCat()
 end
 =

+function MobListShortenName (text) -- AosToolTip_GetText(self.serial)
+	text =3D string.gsub(text,"\n.*","") -- only keep first line
+	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
+	text =3D string.gsub(text," %[","%[") -- move guildtag closer
+	text =3D string.gsub(text,"^Lord","")
+	text =3D string.gsub(text,"^Lady","")
+	text =3D string.gsub(text,"^an ","")
+	text =3D string.gsub(text,"^a ","")
+	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
+	text =3D string.gsub(text,"[ \t]+$","") -- remove trailing spaces
+	return text
+end
+
 function gWidgetPrototype.UOMobListItem:UpdateName(name,clilocid)
 	if (name and (not self.lowname)) then self.lowname =3D name self.nameclil=
oc =3D clilocid end
 	local tooltip =3D AosToolTip_GetText(self.serial)
@@ -218,15 +282,8 @@
 	if (self.old_fulltext ~=3D text) then =

 		self.old_fulltext =3D text
 		bNameUpdate =3D true
-		text =3D string.gsub(text,"\n.*","") -- only keep first line
-		text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
-		text =3D string.gsub(text," %[","%[") -- move guildtag closer
-		text =3D string.gsub(text,"^Lord","")
-		text =3D string.gsub(text,"^Lady","")
-		text =3D string.gsub(text,"^an ","")
-		text =3D string.gsub(text,"^a ","")
-		text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
-		text =3D string.gsub(text,"[ \t]+$","") -- remove trailing spaces
+		local fulltext =3D text
+		text =3D MobListShortenName(text)
 		=

 		-- npcs friends
 		self.bIsNPC =3D false =

@@ -241,7 +298,7 @@
 		if (StringContains(text,"hazk")) then print("ghaz:",self.bIsFriendlyGuil=
d) end
 		=

 		-- check pets
-		self.bIsPet =3D StringContains(text,"(summoned)") or StringContains(text=
,"(tame)")
+		self.bIsPet =3D StringContains(fulltext,"(summoned)") or StringContains(=
fulltext,"(tame)")
 		local mobile =3D self.mobile
 		if (mobile.artid =3D=3D 574 and mobile.hue =3D=3D 0) then self.bIsPet =
=3D true end -- blade spirit
 		if (mobile.artid =3D=3D 164 and mobile.hue =3D=3D 0) then self.bIsPet =
=3D true end -- energy vortex
@@ -324,8 +381,7 @@
 -- ***** ***** ***** ***** ***** rest
 =

 function MobListGetMainTargetSerial() return gMobList.maintarget_serial end
-
-RegisterListener("Hook_UOAM_PosUpdate",function () gMobList:UOAMUpdate() e=
nd)
+		=

 RegisterListener("Hook_PostLoad",function () gMobList =3D GetDesktopWidget=
():CreateChild("UOMobList") end)
 =

 end



From no-reply at zwischenwelt.org  Sun Oct 19 23:47:20 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 21:47:20 -0000
Subject: [Iris-commit] [IRIS] r2610 - in /trunk: lua/lib.2d.mobile.lua
 lua/lib.uoids.lua lua/net/net.dynamic.lua lua/net/net.login.lua
 lua/net/net.mobile.lua lua/net/net.other.lua lua/obj/obj.mobile.lua
 lua/obj/obj.player.lua plugins/lib.spellbar.lua
Message-ID: <20081019214721.104131C1879F@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 19 23:47:20 2008
New Revision: 2610

Log:
text-msg : recognize name/label type and prevent popping up text for animal=
s/monsters,  mobile : zombie system to prevent desync with server in case o=
f server:destroy not being send because mob is outside inner update range

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/net/net.dynamic.lua
    trunk/lua/net/net.login.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/net/net.other.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/obj/obj.player.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Sun Oct 19 23:47:20 2008
@@ -2,6 +2,10 @@
 -- TODO : Equipconv.def ?
 =

 -- main updater, create, position ...
+function Renderer2D:MobileSetVisible			(mobile,bVisible) =

+	if (mobile.gfx2d) then mobile.gfx2d:SetVisible(bVisible) end
+end
+
 function Renderer2D:UpdateMobile				(mobile) =

 	local gfx =3D mobile.gfx2d
 	if (not gfx) then

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Sun Oct 19 23:47:20 2008
@@ -303,17 +303,20 @@
 gCharCreateSkillIDs["Spellweaving"]				=3D 54
 =

 =

-kMessageType =3D {}
-kMessageType.Regular	=3D hex2num("0x00")
-kMessageType.System		=3D hex2num("0x01")
-kMessageType.Emote		=3D hex2num("0x02")
-kMessageType.Label		=3D hex2num("0x06")
-kMessageType.Focus		=3D hex2num("0x07")
-kMessageType.Whisper	=3D hex2num("0x08")
-kMessageType.Yell		=3D hex2num("0x09")
-kMessageType.Spell		=3D hex2num("0x0A")
-kMessageType.Encoded	=3D hex2num("0xC0")
-
+kTextType_Normal			=3D 0x00
+kTextType_System			=3D 0x01 -- Broadcast/System =

+kTextType_Emote				=3D 0x02
+kTextType_Label				=3D 0x06 -- after singleclick on mob
+kTextType_Corner			=3D 0x07 -- Message/Corner With Name  (lower-left corne=
r?) Focus?
+kTextType_Whisper			=3D 0x08
+kTextType_Yell				=3D 0x09 =

+kTextType_Spell				=3D 0x0A
+kTextType_Guild				=3D 0x0D -- Guild Chat =

+kTextType_Alliance			=3D 0x0E -- Alliance Chat =

+kTextType_CommandPrompt		=3D 0x0F -- Command Prompts ???
+kTextType_Encoded			=3D 0xC0 -- flag set if chat contains keywords from sp=
eech.mul ?
+	=

+	=

 -- skill ids and stuff
 glSkillNames =3D {	=

 	[1] 	=3D "Alchemy",

Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Sun Oct 19 23:47:20 2008
@@ -56,6 +56,8 @@
 	dynamicdata.xloc =3D input:PopNetUint16() --only use lowest significant 1=
5 bits)
 	dynamicdata.yloc =3D input:PopNetUint16()
 =

+	=

+	=

 	if (TestBit(dynamicdata.xloc,hex2num("0x8000"))) then
 		dynamicdata.dir =3D input:PopNetUint8()
 	else	=

@@ -83,6 +85,10 @@
 	dynamicdata.yloc		=3D BitwiseAND(dynamicdata.yloc,hex2num("0x3fff"))
 	dynamicdata.iContainerSerial =3D 0
 =

+	local xloc,yloc =3D GetPlayerPos()
+	local dist =3D dist2(xloc,yloc,dynamicdata.xloc,dynamicdata.yloc)
+	if (dist > gDestroyObjectDist) then print("kPacket_Show_Item : dist >=3D =
",dist,xloc,yloc,dynamicdata.xloc,dynamicdata.yloc) end
+	=

 	CreateOrUpdateDynamic(dynamicdata)
 end
 =


Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Sun Oct 19 23:47:20 2008
@@ -252,6 +252,7 @@
 	Send_ClientLanguage(gLanguage or "ENU")
 	Send_UnknownCommand()
 	Send_UnknownSE()
+	--~ Send_UpdateRangeRequest(gDestroyObjectDist)
 =

 	StartInGame()
 	=


Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Sun Oct 19 23:47:20 2008
@@ -14,11 +14,16 @@
 	mobiledata.flag			=3D input:PopNetUint8()
 	mobiledata.notoriety	=3D input:PopNetUint8()
 	=

+	local xloc,yloc =3D GetPlayerPos()
+	local dist =3D dist2(xloc,yloc,mobiledata.xloc,mobiledata.yloc)
+	if (dist > gDestroyObjectDist) then print("kPacket_Naked_MOB : dist >=3D =
",dist) end
+	=

 	if (mobiledata.serial =3D=3D 0x001b5369) then
 		printdebug("corpse","CORPSECODE kPacket_Naked_MOB",mobiledata.artid,mobi=
ledata.flag,mobiledata.notoriety)
 	end
 	=

-	CreateOrUpdateMobile(mobiledata)
+	local mobile =3D CreateOrUpdateMobile(mobiledata)
+	if (mobile) then mobile:NoZombie() end
 end
 =

 -- Equipped_MOB packet (0x78)

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Sun Oct 19 23:47:20 2008
@@ -471,6 +471,23 @@
 	out:SendPacket()
 end
 =

+-- answered by kPacket_Change_Update_Range from server
+function Send_UpdateRangeRequest(range)	-- 0xC8
+	print("Send_UpdateRangeRequest",range)
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Change_Update_Range)
+	out:PushNetUint8(range)
+	out:SendPacket()
+end
+
+function gPacketHandler.kPacket_Change_Update_Range ()	-- 0xC8
+	local input =3D GetRecvFIFO()
+	local id =3D input:PopNetUint8()
+	local range =3D input:PopNetUint8()
+	print("######## kPacket_Change_Update_Range",range)
+	SetUpDateRange(range)
+end
+
 -- Tracking Arrow
 function gPacketHandler.kPacket_TrackingArrow ()	-- 0xba
 	local input =3D GetRecvFIFO()
@@ -579,7 +596,7 @@
 	=

 	-- check if player -> then show text over player head
 	local mobilespeaker=3DGetMobile(mobile_serial)
-	if (mobilespeaker) then mobilespeaker:DisplayTextOverHead(string.gsub(tex=
t_message,"<br>","\n"),Uo16Color2Rgb(text_color)) end
+	if (mobilespeaker) then mobilespeaker:NoZombie() mobilespeaker:DisplayTex=
tOverHead(string.gsub(text_message,"<br>","\n"),Uo16Color2Rgb(text_color)) =
end
 	-- TODO : text_item ?!?
 	NotifyListener("Hook_Packet_Text",mobile_serial,plaintext)
 	NotifyListener("Hook_MobName",mobile_serial,text_charname)
@@ -640,6 +657,7 @@
 	data.speaker_name		=3D input:PopFilledString(30)	=

 	size =3D size - 49
 	=

+	local mobile =3D GetMobile(data.speaker_serial) if (mobile) then mobile:N=
oZombie() end
 	-- flags : (0x02 is unknown, 0x04 signals the message doesn't move on scr=
een) =

 	=

 	=

@@ -708,21 +726,14 @@
 	local show_below =3D true	-- display as fadeline
 	local show_journal =3D true	-- display in journal
 	=

-	if text_type =3D=3D 0x00 then	-- regular
-	elseif text_type =3D=3D 0x01 then	-- system
-	elseif text_type =3D=3D 0x02 then	-- emote
-	elseif text_type =3D=3D 0x06 then	-- label
+	local mobile =3D GetMobile(text_item_serial) if (mobile) then mobile:NoZo=
mbie() end
+	=

+	if text_type =3D=3D kTextType_Label then	-- label
 		show_journal =3D false
 		if GetMobile(text_item_serial) then
 			Mobile_SetName(text_item_serial, text_charname, plaintext)
 			show_below =3D false
 		end
-	elseif text_type =3D=3D 0x07 then	-- focus
-	elseif text_type =3D=3D 0x08 then	-- whisper
-	elseif text_type =3D=3D 0x09 then	-- yell
-	elseif text_type =3D=3D 0x0A then	-- spell
-	elseif text_type =3D=3D 0xC0 then	-- encoded
-	else	-- unknown
 	end
 	=

 	if show_below then
@@ -738,7 +749,7 @@
 	end
 	=

 	NotifyListener("Hook_Text",text_charname,plaintext)
-	NotifyListener("Hook_Packet_Localized_Text",text_item_serial,plaintext,te=
xt_messagenum)
+	NotifyListener("Hook_Packet_Localized_Text",text_item_serial,plaintext,te=
xt_messagenum,text_type)
 	NotifyListener("Hook_MobName",text_item_serial,plaintext,text_messagenum)
 	=

 	-- print("###",text_item_serial,text_item_model,text_type,text_color,text=
_charname,text_params,text_terminator)
@@ -764,10 +775,12 @@
 	unitext_message =3D UnicodeFix(unitext_message)
 =

 	local r,g,b =3D 1,1,1
-	if unitext_type =3D=3D hex2num("0x00") then r,g,b =3D 1,1,1 end	-- 0x00 -=
 Normal =

-	if unitext_type =3D=3D hex2num("0x01") then r,g,b =3D 0,0,1 end	-- 0x01 -=
 Broadcast/System =

-	if unitext_type =3D=3D hex2num("0x02") then r,g,b =3D 0,1,0 end	-- 0x02 -=
 Emote =

-	if unitext_type =3D=3D hex2num("0x06") then =

+	=

+	=

+	if unitext_type =3D=3D kTextType_Normal then r,g,b =3D 1,1,1 end
+	if unitext_type =3D=3D kTextType_System then r,g,b =3D 0,0,1 end
+	if unitext_type =3D=3D kTextType_Emote then r,g,b =3D 0,1,0 end
+	if unitext_type =3D=3D kTextType_Label then =

 		show_journal =3D false =

 		if GetMobile(mobile_serial) then
 			show_below =3D false =

@@ -775,13 +788,13 @@
 			r,g,b =3D 1,1,1 =

 		end
 	end	-- 0x06 - System/Lower Corner, label?
-	if unitext_type =3D=3D hex2num("0x07") then r,g,b =3D 1,0,0 end	-- 0x07 -=
 Message/Corner With Name =

-	if unitext_type =3D=3D hex2num("0x07") then r,g,b =3D 1,1,1 end	-- 0x08 -=
 Whisper =

-	if unitext_type =3D=3D hex2num("0x07") then r,g,b =3D 1,1,1 end	-- 0x09 -=
 Yell =

-	if unitext_type =3D=3D hex2num("0x07") then r,g,b =3D 0,1,1 end	-- 0x0A -=
 Spell =

-	if unitext_type =3D=3D hex2num("0x07") then r,g,b =3D 0,1,0 end	-- 0x0D -=
 Guild Chat =

-	if unitext_type =3D=3D hex2num("0x07") then r,g,b =3D 0,1,0 end	-- 0x0E -=
 Alliance Chat =

-	if unitext_type =3D=3D hex2num("0x07") then r,g,b =3D 1,0,1 end	-- 0x0F -=
 Command Prompts	=

+	if unitext_type =3D=3D kTextType_Corner			 	 then r,g,b =3D 1,0,0 end	=

+	if unitext_type =3D=3D kTextType_Whisper			 then r,g,b =3D 1,1,1 end	=

+	if unitext_type =3D=3D kTextType_Yell				 then r,g,b =3D 1,1,1 end	=

+	if unitext_type =3D=3D kTextType_Spell				 then r,g,b =3D 0,1,1 end	=

+	if unitext_type =3D=3D kTextType_Guild				 then r,g,b =3D 0,1,0 end	 =

+	if unitext_type =3D=3D kTextType_Alliance			 then r,g,b =3D 0,1,0 end	=

+	if unitext_type =3D=3D kTextType_CommandPrompt		 then r,g,b =3D 1,0,1 end=
		=

 	=

 	if unitext_hue then r,g,b =3D Uo16Color2Rgb(unitext_hue) end
 	=

@@ -802,11 +815,12 @@
 	=

 	NotifyListener("Hook_Text",unitext_name,unitext_message)
 	=

-	NotifyListener("Hook_Packet_Text_Unicode",mobile_serial,unitext_message)
+	NotifyListener("Hook_Packet_Text_Unicode",mobile_serial,unitext_message,u=
nitext_type)
 	NotifyListener("Hook_MobName",mobile_serial,unitext_name)
 =

 	-- check if player -> then show text over player head
 	local mobilespeaker=3DGetMobile(mobile_serial)
+	if (mobilespeaker) then mobilespeaker:NoZombie() end
 	if (mobilespeaker and show_below) then mobilespeaker:DisplayTextOverHead(=
string.gsub(unitext_message,"<br>","\n"),Uo16Color2Rgb(unitext_hue)) end
 end
 =

@@ -1168,7 +1182,7 @@
 	local bEncoded		=3D keywordcount > 0
 	local hue			=3D hex2num("0x34")
 	local font			=3D 0 -- ignored by runuo 1
-	local msgtype		=3D kMessageType.Regular + (bEncoded and kMessageType.Enco=
ded or 0)
+	local msgtype		=3D kTextType_Normal + (bEncoded and kTextType_Encoded or =
0)
 	local packetlen		=3D 1+2+1+2+2+4+ (bEncoded and (2+0+ascilen) or (ascilen=
*2))
 	for i =3D 0,keywordcount-1 do packetlen =3D packetlen + ((math.mod(i,2) =
=3D=3D 0) and 1 or 2) end -- calc packetlength for encoding
 	=


Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Sun Oct 19 23:47:20 2008
@@ -111,6 +111,34 @@
 =

 function gMobilePrototype:SetNotoriety(notoriety) self.notoriety =3D notor=
iety end -- also written by other means, don't use for notify, only used fo=
r walk-ack
 =

+-- see gMobileZombieDist  (hide to prevent desync with server for dead mob=
s)
+function gMobilePrototype:NoZombie	() self:SetZombie(false) end -- mark as=
 alive, triggered by chat/label or naked-mob/mob-move
+function gMobilePrototype:SetZombie	(bZombie,t)
+	t =3D t or Client_GetTicks()
+	--~ print("mobile:SetZombie",self.serial,bZombie,((self.iZombieClickCount=
 or 0) >=3D 1 and bZombie) and "KILLED" or "")
+	if (self.bZombie ~=3D bZombie) then =

+		self.bZombie =3D bZombie
+		if (not bZombie) then self.iZombieClickCount =3D 0 end
+		gCurrentRenderer:MobileSetVisible(self,not bZombie)
+	end
+	if (bZombie and t > (self.iZombieNextNameClick or 0)) then
+		local oldclickc =3D self.iZombieClickCount or 0
+		if (oldclickc >=3D 1) then =

+			self:Destroy() -- click timeout -> kill
+		else
+			self.iZombieClickCount =3D oldclickc + 1
+			self.iZombieNextNameClick =3D t + 3000
+			Send_SingleClick(self.serial)
+		end
+	end
+end
+
+function gMobilePrototype:GetSqDistToPos (xloc,yloc)
+	local dx =3D self.xloc - xloc
+	local dy =3D self.yloc - yloc
+	return dx*dx + dy*dy
+end
+
 function gMobilePrototype:RequestEquipToolTips ()
 	for index,layer in pairs(gLayerOrder) do =

 		local item =3D GetMobileEquipmentItem(self,layer)

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Sun Oct 19 23:47:20 2008
@@ -1,11 +1,19 @@
 -- stuff concerning player (body,backpack,equipment...)
 -- see also net.mobile.lua net.paperdoll.lua net.container.lua
 =

-gDestroyObjectDist =3D 40 -- TODO : adjust when requesting a different vie=
wdist from server
+gMobileZombieDist =3D 17 -- if mobile is furhter away from player than thi=
s, then the mobile might be a zombie (dead on server, but still in client c=
ache)
+gMobileZombieDistSquare =3D gMobileZombieDist*gMobileZombieDist
+gDestroyObjectDist =3D 30 -- TODO : adjust when requesting a different vie=
wdist from server
 gDestroyObjectDistSquare =3D gDestroyObjectDist*gDestroyObjectDist
 =

 gPlayerBodySerial =3D 0
 gPlayerBackPack =3D false
+
+function SetUpDateRange (range)
+	-- doesn't work as it should, server sends 18, but if we set it to 18, pa=
rts of dynamic cities go missing
+	--~ gDestroyObjectDist =3D range =

+	--~ gDestroyObjectDistSquare =3D range * range
+end
 =

 function IsPlayerMobile (mobile) =

 	return mobile and (mobile.serial =3D=3D gPlayerBodySerial)
@@ -133,6 +141,7 @@
 =

 -- destroy objects outside view range
 function DestroyObjectsFarFromPlayer (player_xloc,player_yloc)
+	local t =3D Client_GetTicks()
 	-- dynamics
 	for k,dynamic in pairs(GetDynamicList()) do =

 		if (DynamicIsInWorld(dynamic) and IsObjectFarEnoughToDestroy(dynamic.xlo=
c,dynamic.yloc,player_xloc,player_yloc)) then
@@ -141,8 +150,11 @@
 	end
 	-- mobiles
 	for k,mobile in pairs(GetMobileList()) do =

-		if (IsObjectFarEnoughToDestroy(mobile.xloc,mobile.yloc,player_xloc,playe=
r_yloc)) then
-			DestroyObjectBySerial(mobile.serial) =

+		local dist =3D mobile:GetSqDistToPos(player_xloc,player_yloc)
+		if (dist > gDestroyObjectDistSquare) then
+			DestroyObjectBySerial(mobile.serial)
+		elseif (dist > gMobileZombieDistSquare) then =

+			mobile:SetZombie(true,t)
 		end =

 	end
 end

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Sun Oct 19 23:47:20 2008
@@ -90,7 +90,7 @@
 end
      =

 =

-RegisterListener("Hook_Packet_Text_Unicode",	function (serial,plaintext)  =
-- kPacket_Text_Unicode
+RegisterListener("Hook_Packet_Text_Unicode",	function (serial,plaintext,te=
xttype)  -- kPacket_Text_Unicode
 	local r,g,b =3D 1,1,0 -- yellow
 	SpellBarRiseTextOnMob(serial,r,g,b,plaintext)
 	--~ print("Hook_Packet_Text_Unicode",serial,plaintext) =

@@ -166,7 +166,8 @@
 RegisterListener("Hook_Spell_Interrupt",function () SpellBarInterrupt() en=
d)
 =

 --~ NotifyListener("Hook_Text",unitext_name,unitext_message) -- kPacket_Te=
xt_Unicode
-RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum)
+RegisterListener("Hook_Packet_Localized_Text",	function (serial,plaintext,=
text_messagenum,texttype)
+	if (texttype =3D=3D kTextType_Label) then return end
 	local short =3D gSpellbarShortMessages[text_messagenum]
 	if (short) then SpellBarRiseTextOnMob(GetPlayerSerial(),short.r,short.g,s=
hort.b,short.txt) end
 	if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet_Loc=
alized_Text",serial,plaintext,text_messagenum) end



From no-reply at zwischenwelt.org  Mon Oct 20 00:09:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 22:09:19 -0000
Subject: [Iris-commit] [IRIS] r2611 - in /trunk/lua: config_declarations.lua
	net/net.object.lua
Message-ID: <20081019220919.898C11524030@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 00:09:19 2008
New Revision: 2611

Log:
enabled moblist by default

Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/net/net.object.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Mon Oct 20 00:09:19 2008
@@ -489,7 +489,8 @@
 =

 gAlwaysRun =3D false
 -- gReActivateWeaponAbilityInterval =3D 3100  -- don't reactivate if nil
-gDisabledPlugins.moblist =3D true
+gDisabledPlugins.hudenemylist =3D true -- obsolete ? not quite, moblist st=
ill needs code to summarize
+gDisabledPlugins.moblist =3D false
 gDisabledPlugins.loot =3D true
 gFriendlyGuildTags =3D {} -- gFriendlyGuildTags =3D {"[ABC]","[DEF]"} -- u=
sed by moblist plugin
 gEnableWalkLog =3D false

Modified: trunk/lua/net/net.object.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.object.lua (original)
+++ trunk/lua/net/net.object.lua Mon Oct 20 00:09:19 2008
@@ -19,7 +19,7 @@
 end
 =

 function Send_SingleClick (iSerial)
-	print("Send_SingleClick",sprintf("0x%08x",iSerial))
+	--~ print("Send_SingleClick",sprintf("0x%08x",iSerial))
 	printdebug("net",sprintf("NET: Send_SingleClick: 0x%08x\n",iSerial))
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Single_Click)



From no-reply at zwischenwelt.org  Mon Oct 20 01:10:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 19 Oct 2008 23:10:55 -0000
Subject: [Iris-commit] [IRIS] r2612 - in /trunk/lua: lib.uoam.lua
 net/net.dynamic.lua net/net.login.lua net/net.mobile.lua obj/obj.mobile.lua
 obj/obj.player.lua widgets/widget.uotext.lua
Message-ID: <20081019231055.A64961524030@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 01:10:55 2008
New Revision: 2612

Log:
fixed mobile update range dist calc, mobile-zombie system probably no longe=
r needed

Modified:
    trunk/lua/lib.uoam.lua
    trunk/lua/net/net.dynamic.lua
    trunk/lua/net/net.login.lua
    trunk/lua/net/net.mobile.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/lua/obj/obj.player.lua
    trunk/lua/widgets/widget.uotext.lua

Modified: trunk/lua/lib.uoam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoam.lua (original)
+++ trunk/lua/lib.uoam.lua Mon Oct 20 01:10:55 2008
@@ -84,7 +84,7 @@
 	--~ print("uoam-recv",FIFOHexDump(gUOAMRecvFIFO))
 	UOAM_RecvPositions(gUOAMRecvFIFO)
 	gUOAMRecvFIFO:Clear()
-	print("uoamstep",xloc,yloc,MapGetMapIndex(),gUOAMConnection:IsConnected())
+	if (gEnableUOAMDebug) then print("uoamstep",xloc,yloc,MapGetMapIndex(),gU=
OAMConnection:IsConnected()) end
 	gUOAMToggle =3D not gUOAMToggle =

 	UOAM_SendPosUpdate(gUOAMName,gUOAMPass,gUOAMToggle and 0x02 or 0x01,facet=
byte,xloc,yloc)
 	-- toggle : 0x01 for keep alive, 0x02 to poll other char positions
@@ -156,7 +156,7 @@
 			local x =3D fifo:PopUint32()
 			local y =3D fifo:PopUint32()
 			local z =3D fifo:PopUint32()
-			print("uoam:recv:",a,b,c,d,e,f,facetbyte,x,y,z,name)
+			if (gEnableUOAMDebug) then print("uoam:recv:",a,b,c,d,e,f,facetbyte,x,y=
,z,name) end
 			if (name ~=3D gUOAMName) then =

 				gUOAMOtherPositions[name] =3D {xloc=3Dx,yloc=3Dy,bIsOnSameFacet=3DUOAM=
_GetMyFacetByte() =3D=3D facetbyte}
 			end

Modified: trunk/lua/net/net.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.dynamic.lua (original)
+++ trunk/lua/net/net.dynamic.lua Mon Oct 20 01:10:55 2008
@@ -86,8 +86,8 @@
 	dynamicdata.iContainerSerial =3D 0
 =

 	local xloc,yloc =3D GetPlayerPos()
-	local dist =3D dist2(xloc,yloc,dynamicdata.xloc,dynamicdata.yloc)
-	if (dist > gDestroyObjectDist) then print("kPacket_Show_Item : dist >=3D =
",dist,xloc,yloc,dynamicdata.xloc,dynamicdata.yloc) end
+	local dist =3D dist2max(xloc,yloc,dynamicdata.xloc,dynamicdata.yloc)
+	if (dist > gUpdateRange_DynamicDestroy) then print("kPacket_Show_Item : d=
ist >=3D ",dist,xloc,yloc,dynamicdata.xloc,dynamicdata.yloc) end
 	=

 	CreateOrUpdateDynamic(dynamicdata)
 end

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Mon Oct 20 01:10:55 2008
@@ -252,7 +252,7 @@
 	Send_ClientLanguage(gLanguage or "ENU")
 	Send_UnknownCommand()
 	Send_UnknownSE()
-	--~ Send_UpdateRangeRequest(gDestroyObjectDist)
+	--~ Send_UpdateRangeRequest(gUpdateRange_Base)
 =

 	StartInGame()
 	=


Modified: trunk/lua/net/net.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.mobile.lua (original)
+++ trunk/lua/net/net.mobile.lua Mon Oct 20 01:10:55 2008
@@ -15,8 +15,8 @@
 	mobiledata.notoriety	=3D input:PopNetUint8()
 	=

 	local xloc,yloc =3D GetPlayerPos()
-	local dist =3D dist2(xloc,yloc,mobiledata.xloc,mobiledata.yloc)
-	if (dist > gDestroyObjectDist) then print("kPacket_Naked_MOB : dist >=3D =
",dist) end
+	local dist =3D dist2max(xloc,yloc,mobiledata.xloc,mobiledata.yloc)
+	if (dist > gUpdateRange_MobileDestroy) then print("kPacket_Naked_MOB : di=
st >=3D ",dist) end
 	=

 	if (mobiledata.serial =3D=3D 0x001b5369) then
 		printdebug("corpse","CORPSECODE kPacket_Naked_MOB",mobiledata.artid,mobi=
ledata.flag,mobiledata.notoriety)
@@ -217,6 +217,7 @@
 =

 	--printf("NET : kPacket_Mobile_Stats mobile=3D0x%08x name=3D%s\n",mobiles=
erial,stats.name)
 	=

+	local mobile =3D GetMobile(mobileserial) if (mobile) then mobile:NoZombie=
() end
 	Mobile_UpdateStats(mobileserial,stats)
 end
 =


Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Mon Oct 20 01:10:55 2008
@@ -111,26 +111,27 @@
 =

 function gMobilePrototype:SetNotoriety(notoriety) self.notoriety =3D notor=
iety end -- also written by other means, don't use for notify, only used fo=
r walk-ack
 =

--- see gMobileZombieDist  (hide to prevent desync with server for dead mob=
s)
+-- see gUpdateRange_MobileZombie  (hide to prevent desync with server for =
dead mobs)
 function gMobilePrototype:NoZombie	() self:SetZombie(false) end -- mark as=
 alive, triggered by chat/label or naked-mob/mob-move
 function gMobilePrototype:SetZombie	(bZombie,t)
-	t =3D t or Client_GetTicks()
-	--~ print("mobile:SetZombie",self.serial,bZombie,((self.iZombieClickCount=
 or 0) >=3D 1 and bZombie) and "KILLED" or "")
-	if (self.bZombie ~=3D bZombie) then =

-		self.bZombie =3D bZombie
-		if (not bZombie) then self.iZombieClickCount =3D 0 end
-		gCurrentRenderer:MobileSetVisible(self,not bZombie)
-	end
-	if (bZombie and t > (self.iZombieNextNameClick or 0)) then
-		local oldclickc =3D self.iZombieClickCount or 0
-		if (oldclickc >=3D 1) then =

-			self:Destroy() -- click timeout -> kill
-		else
-			self.iZombieClickCount =3D oldclickc + 1
-			self.iZombieNextNameClick =3D t + 3000
-			Send_SingleClick(self.serial)
-		end
-	end
+	--~ t =3D t or Client_GetTicks()
+	--~ -- print("mobile:SetZombie",self.serial,bZombie,((self.iZombiePingCou=
nt or 0) >=3D 1 and bZombie) and "KILLED" or "")
+	--~ if (self.bZombie ~=3D bZombie) then =

+		--~ self.bZombie =3D bZombie
+		--~ if (not bZombie) then self.iZombiePingCount =3D 0 end
+		--~ gCurrentRenderer:MobileSetVisible(self,not bZombie)
+	--~ end
+	--~ if (bZombie and t > (self.iZombieNextPing or 0)) then
+		--~ local oldpingc =3D self.iZombiePingCount or 0
+		--~ if (oldpingc >=3D 1) then =

+			--~ self:Destroy() -- click timeout -> kill
+		--~ else
+			--~ self.iZombiePingCount =3D oldpingc + 1
+			--~ self.iZombieNextPing =3D t + 3000
+			--~ Send_SingleClick(self.serial)
+			--~ -- Send_ClientQuery(gRequest_States,self.serial)
+		--~ end
+	--~ end
 end
 =

 function gMobilePrototype:GetSqDistToPos (xloc,yloc)

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Mon Oct 20 01:10:55 2008
@@ -1,19 +1,22 @@
 -- stuff concerning player (body,backpack,equipment...)
 -- see also net.mobile.lua net.paperdoll.lua net.container.lua
 =

-gMobileZombieDist =3D 17 -- if mobile is furhter away from player than thi=
s, then the mobile might be a zombie (dead on server, but still in client c=
ache)
-gMobileZombieDistSquare =3D gMobileZombieDist*gMobileZombieDist
-gDestroyObjectDist =3D 30 -- TODO : adjust when requesting a different vie=
wdist from server
-gDestroyObjectDistSquare =3D gDestroyObjectDist*gDestroyObjectDist
+gUpdateRange_Base =3D 18 -- runuo2 update range is hardcoded to 18, leave =
a bit of tolerance for walking  (dist=3Dmax(dx,dy))
+gUpdateRange_Add_DynamicDestroy	=3D 17 -- multisize
+gUpdateRange_Add_MobileDestroy	=3D 0
+gUpdateRange_Add_MobileZombie	=3D 0
 =

 gPlayerBodySerial =3D 0
 gPlayerBackPack =3D false
 =

 function SetUpDateRange (range)
-	-- doesn't work as it should, server sends 18, but if we set it to 18, pa=
rts of dynamic cities go missing
-	--~ gDestroyObjectDist =3D range =

-	--~ gDestroyObjectDistSquare =3D range * range
+	gUpdateRange_Base =3D range
+	-- not usually used, update range hardcoded to 18 on runuo2-svn, nothing =
else accepted
+	gUpdateRange_DynamicDestroy	=3D range + gUpdateRange_Add_DynamicDestroy -=
- bigger than update range : big items like multis
+	gUpdateRange_MobileDestroy	=3D range + gUpdateRange_Add_MobileDestroy	=

+	gUpdateRange_MobileZombie	=3D range + gUpdateRange_Add_MobileZombie -- if=
 mobile is furhter away from player than this, then the mobile might be a z=
ombie (dead on server, but still in client cache)
 end
+SetUpDateRange(gUpdateRange_Base)
 =

 function IsPlayerMobile (mobile) =

 	return mobile and (mobile.serial =3D=3D gPlayerBodySerial)
@@ -133,27 +136,27 @@
 end
 function PlayerHasMount () return PlayerGetMount() ~=3D nil end
 =

-function IsObjectFarEnoughToDestroy (xloc,yloc,player_xloc,player_yloc)
-	local dx =3D xloc - player_xloc
-	local dy =3D yloc - player_yloc
-	return dx*dx + dy*dy > gDestroyObjectDistSquare
+function IsOutsideRange (xloc,yloc,xloc2,yloc2,range)
+	return abs(xloc - xloc2) > range or abs(yloc - yloc2) > range
 end
 =

 -- destroy objects outside view range
 function DestroyObjectsFarFromPlayer (player_xloc,player_yloc)
 	local t =3D Client_GetTicks()
+	local range_destroy =3D gUpdateRange_DynamicDestroy
 	-- dynamics
 	for k,dynamic in pairs(GetDynamicList()) do =

-		if (DynamicIsInWorld(dynamic) and IsObjectFarEnoughToDestroy(dynamic.xlo=
c,dynamic.yloc,player_xloc,player_yloc)) then
+		if (DynamicIsInWorld(dynamic) and IsOutsideRange(dynamic.xloc,dynamic.yl=
oc,player_xloc,player_yloc,range_destroy)) then
 			DestroyObjectBySerial(dynamic.serial) =

 		end =

 	end
 	-- mobiles
+	local range_destroy	=3D gUpdateRange_MobileDestroy
+	local range_zombie	=3D gUpdateRange_MobileZombie
 	for k,mobile in pairs(GetMobileList()) do =

-		local dist =3D mobile:GetSqDistToPos(player_xloc,player_yloc)
-		if (dist > gDestroyObjectDistSquare) then
+		if (IsOutsideRange(mobile.xloc,mobile.yloc,player_xloc,player_yloc,range=
_destroy)) then
 			DestroyObjectBySerial(mobile.serial)
-		elseif (dist > gMobileZombieDistSquare) then =

+		elseif (IsOutsideRange(mobile.xloc,mobile.yloc,player_xloc,player_yloc,r=
ange_zombie)) then =

 			mobile:SetZombie(true,t)
 		end =

 	end

Modified: trunk/lua/widgets/widget.uotext.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotext.lua (original)
+++ trunk/lua/widgets/widget.uotext.lua Mon Oct 20 01:10:55 2008
@@ -37,7 +37,7 @@
 			end
 		end
 	end
-	=

+	text =3D text or ""
 	=

 	=

 	self:SetUOHtml(text,bParseHTML)



From no-reply at zwischenwelt.org  Mon Oct 20 02:03:01 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 20 Oct 2008 00:03:01 -0000
Subject: [Iris-commit] [IRIS] r2613 - in /trunk/lua: gui/gui.gumpparser.lua
 lib.macrolist.lua widgets/widget.gumpdialog.lua
Message-ID: <20081020000301.736991524030@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 02:03:00 2008
New Revision: 2613

Log:
macrolist : added MacroCmd_NextGumpContaining(searchtext,timeout,callback) =
and gump:SendClick(relx,rely)

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/widgets/widget.gumpdialog.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Mon Oct 20 02:03:00 2008
@@ -278,6 +278,7 @@
 	=

 	for k,command_chunk in pairs(command_chunks) do =

 		local command,bToken,param =3D unpack(command_chunk)
+		if (param and param.cliloc_id) then dialog:MarkUsedCliloc(param.cliloc_i=
d) end
 		------------------------------------------------------------------------=
--------------------
 		if (command =3D=3D "") then -- no word in line
 		elseif (command =3D=3D "noclose") then

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Oct 20 02:03:00 2008
@@ -104,7 +104,11 @@
 end
 =

 RegisterStepper(function () =

-	if (gMacroQueuedTarget_Timeout and Client_GetTicks() > gMacroQueuedTarget=
_Timeout) then MacroCmd_QueuedTargetEnd(false,"timeout") end
+	local t =3D Client_GetTicks()
+	if (gMacroQueuedTarget_Timeout and t > gMacroQueuedTarget_Timeout) then M=
acroCmd_QueuedTargetEnd(false,"timeout") end
+	for data,v in pairs(gMacroGumpWaiters) do
+		if (t > data.timeout) then data.callback() gMacroGumpWaiters[data] =3D n=
il end
+	end
 end)
 RegisterListener("Hook_Spell_Interrupt",	function ()
 	if (gMacroQueuedTarget_FailBySpellInterrupt) then MacroCmd_QueuedTargetEn=
d(false,"spell-interrupt") end
@@ -112,7 +116,21 @@
 RegisterListener("Hook_TargetMode_Start",	function () =

 	if (gMacroQueuedTarget_Serial) then MacroCmd_SendTargetSerial(gMacroQueue=
dTarget_Serial) MacroCmd_QueuedTargetEnd(true) end
 end)
-
+RegisterListener("Hook_TargetMode_Start",	function () =

+	if (gMacroQueuedTarget_Serial) then MacroCmd_SendTargetSerial(gMacroQueue=
dTarget_Serial) MacroCmd_QueuedTargetEnd(true) end
+end)
+RegisterListener("Hook_OpenServersideGump",	function (dialog,playerid,dial=
ogId,Length_Data)	=

+	for data,v in pairs(gMacroGumpWaiters) do
+		if ((not data.search) or dialog:Search(data.search)) then data.callback(=
dialog) gMacroGumpWaiters[data] =3D nil end
+	end
+end)
+
+gMacroGumpWaiters =3D {} =

+-- callback(dialog) or callback(nil) for timeout
+function MacroCmd_NextGumpContaining (search,timeout,callback) =

+	if (not callback) then return end
+	gMacroGumpWaiters[{search=3Dsearch,timeout=3DClient_GetTicks()+(timeout o=
r 1000),callback=3Dcallback}] =3D true
+end
 =

 =

 =


Modified: trunk/lua/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.gumpdialog.lua (original)
+++ trunk/lua/widgets/widget.gumpdialog.lua Mon Oct 20 02:03:00 2008
@@ -20,7 +20,8 @@
 	self.uo_check	=3D {} -- for return-message
 	self.uo_text	=3D {} -- for return-message
 	self.radiogroups =3D {} -- see widget.uoradiobutton.lua
-	self.pages		=3D {}
+	self.pages			=3D {}
+	self.usedClilocs	=3D {}
 	self.Gumpdata	=3D params.Gumpdata
 	=

 	-- set gumpposition
@@ -35,6 +36,31 @@
 	end
 end
 =

+function gWidgetPrototype.GumpDialog:SendClick		(relx,rely)
+	local x,y =3D self:GetPos()
+	local widget =3D self:GetWidgetUnderPos(x+relx,y+rely) =

+	if (not widget) then return end
+	GUI_TriggerWidgetEventCallback(widget,"button_click") =

+end
+function gWidgetPrototype.GumpDialog:MarkUsedCliloc		(cliloc_id)
+	if (cliloc_id) then self.usedClilocs[cliloc_id] =3D true end
+end
+function gWidgetPrototype.GumpDialog:Search		(search)
+	local gumpdata =3D self.Gumpdata
+	if (not gumpdata) then return end
+	if (gumpdata.Data) then
+		print("GumpDialog:Search main",search,gumpdata.Data)
+		if (StringContains(gumpdata.Data,search)) then return true end
+	end
+	if (gumpdata.textline) then =

+		for k,line in pairs(gumpdata.textline) do print("GumpDialog:Search line"=
,search,line) if (StringContains(line,search)) then return true end end
+	end
+	if (gClilocLoader) then
+		for cliloc_id,v in pairs(self.usedClilocs) do
+			if (StringContains(gClilocLoader:Get(cliloc_id),search)) then return tr=
ue end
+		end
+	end
+end
 function gWidgetPrototype.GumpDialog:GetCtrlByName	(name) return self.cont=
rols[name] end -- see gumpparser
 =

 function gWidgetPrototype.GumpDialog:GetDialog	() return self end -- overr=
ide, normaly parent:GetDialog(), so this ends recursion



From no-reply at zwischenwelt.org  Mon Oct 20 02:31:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 20 Oct 2008 00:31:32 -0000
Subject: [Iris-commit] [IRIS] r2614 - in /trunk/lua: lib.macrolist.lua
	net/net.other.lua
Message-ID: <20081020003132.7B4571524030@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 02:31:32 2008
New Revision: 2614

Log:
added support for bandageself macro 0xBF 0x2C

Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/net/net.other.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Oct 20 02:31:32 2008
@@ -53,6 +53,7 @@
 =

 function MacroCmd_Say					(text)	if (gInGameStarted) then SendChat(text) e=
nd end
 function MacroCmd_NextCamMode			()		gCurrentRenderer:ChangeCamMode() end
+function MacroCmd_BandageSelf			()		SendBandageSelf() end
 function MacroCmd_Quit					()		Terminate() end
 function MacroCmd_RepeatLastChat		()		if (gInGameStarted) then ChatLine_Re=
peatLast() end end
 function MacroCmd_RepeatLastDoubleClick	()		if (gInGameStarted) then Repea=
tLastDoubleClick() end end

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Mon Oct 20 02:31:32 2008
@@ -51,6 +51,26 @@
 ]]--
 gGenericSubCommands.kPacket_Generic_SubCommand_BandageTarget		=3D hex2num(=
"0x2C")	-- Client -> Server packet,For use with the new Bandage Self client=
 macro. Introduced in 5.0.4x
 =

+function SendBandageSelf (bandageid) return SendBandageCommand(bandageid,G=
etPlayerSerial()) end
+function SendBandageCommand (bandageid,targetid) =

+	if (not bandageid) then
+		local bandage =3D MacroCmd_Item_FindFirstByArtID(3617,0) -- find bandage=
 in backpack
+		if (not bandage) then return end
+		bandageid =3D bandage.serial
+	end
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_Generic_Command)
+	out:PushNetUint16(0x0D) -- packet size
+	out:PushNetUint16(kPacket_Generic_SubCommand_BandageTarget) -- 2C
+	out:PushNetUint32(bandageid)
+	out:PushNetUint32(targetid)
+	out:SendPacket()
+	-- 0000   BF 00 0D 00 2C 41 3D BC  CD 00 0D BA 5B            ....,A=3D...=
..[
+	-- kPacket_Generic_SubCommand_BandageTarget=3D0x2D : bandages=3D0x413dbcc=
d targetid=3D0x000dba5b
+	return true
+end
+
+
 --[[
 --new sincec KR
 gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse =3D he=
x2num("0x2F")	-- BF.2F - KR House Menu Gump Response



From no-reply at zwischenwelt.org  Mon Oct 20 18:19:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 20 Oct 2008 16:19:59 -0000
Subject: [Iris-commit] [IRIS] r2615 - in /trunk/lua: lib.compass.lua
	lib.macrolist.lua
Message-ID: <20081020161959.E8C841C1844F@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 18:19:59 2008
New Revision: 2615

Log:
gui hidden toggle

Modified:
    trunk/lua/lib.compass.lua
    trunk/lua/lib.macrolist.lua

Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Mon Oct 20 18:19:59 2008
@@ -431,6 +431,15 @@
 	end
 end
 =

+
+RegisterListener("Hook_GUI_Hidden",function (bHidden) =

+	if (gIrisCompassDialog) then
+		gIrisCompassDialog.bDoUpdate =3D not bHidden
+		gIrisCompassDialog:SetVisible(gIrisCompassDialog.bDoUpdate)
+		if (gIrisCompassDialog.radar) then gIrisCompassDialog.radar:SetVisible( =
gIrisCompassDialog.bDoUpdate ) end
+	end
+end)
+
 -- returns the relative position in px (from the compass center) of a give=
n uo location in tiles
 function GetRelativeCompasUOPositionInPx	(xloc, yloc)
 	local angle, cxloc, cyloc =3D gCurrentRenderer:GetCompassInfo()

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Oct 20 18:19:59 2008
@@ -68,7 +68,7 @@
 	f() =

 end
 =

-
+function MacroCmd_ToggleHideGUI () GuiToggleHide() end
 =

 =

 =




From no-reply at zwischenwelt.org  Mon Oct 20 18:24:23 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 20 Oct 2008 16:24:23 -0000
Subject: [Iris-commit] [IRIS] r2616 - in /trunk: data/mymacros.lua.dist
	lua/lib.macrolist.lua
Message-ID: <20081020162423.B6F371C1844F@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 18:24:22 2008
New Revision: 2616

Log:
MacroCmd_ToggleHideGUI : added renderone frame to allow instant effect, new=
 default macro : alt+v to make screenshot without gui

Modified:
    trunk/data/mymacros.lua.dist
    trunk/lua/lib.macrolist.lua

Modified: trunk/data/mymacros.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/mymacros.lua.dist (original)
+++ trunk/data/mymacros.lua.dist Mon Oct 20 18:24:22 2008
@@ -46,6 +46,7 @@
 SetMacro("shift+f12",	function() MacroCmd_GridScreenshot() end)
 SetMacro("f12",			function() FadeLineToggleShowAll() end)
 SetMacro("v",			function() MacroCmd_Screenshot() end)
+SetMacro("alt+v",		function() MacroCmd_ToggleHideGUI() MacroCmd_Screenshot=
() MacroCmd_ToggleHideGUI() end)
 SetMacro("x",			function() MacroCmd_CamChangeZoom( 1) end)
 SetMacro("y",			function() MacroCmd_CamChangeZoom(-1) end)
 SetMacro("wheelup",		function() MacroCmd_CamChangeZoom( 0.3) end)

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Mon Oct 20 18:24:22 2008
@@ -68,7 +68,7 @@
 	f() =

 end
 =

-function MacroCmd_ToggleHideGUI () GuiToggleHide() end
+function MacroCmd_ToggleHideGUI () GuiToggleHide() Client_RenderOneFrame()=
 end
 =

 =

 =




From no-reply at zwischenwelt.org  Mon Oct 20 19:49:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 20 Oct 2008 17:49:34 -0000
Subject: [Iris-commit] [IRIS] r2618 - in /trunk/lua: lib.filepath.lua
 lib.loading.lua lib.uoanim.lua main.lua
Message-ID: <20081020180005.DA3D61C1844F@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 19:49:34 2008
New Revision: 2618

Log:
added code to handle missing anim4.mul and similar(pre-ml), moved uopath au=
todetect to avoid confusing output when overriden by config

Modified:
    trunk/lua/lib.filepath.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.uoanim.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.filepath.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.filepath.lua (original)
+++ trunk/lua/lib.filepath.lua Mon Oct 20 19:49:34 2008
@@ -1,7 +1,7 @@
 -- utils for working with filepaths
 =

--- detect UOPath
-if (not gUOPath) then
+
+function AutoDetectUOPath () =

 	gUOPath =3D GetUOPath(path)
 	if (gUOPath) then
 		if (string.find(gUOPath,"\\Client.exe")) then
@@ -11,7 +11,7 @@
 		elseif (string.find(gUOPath,"\\uotd.exe")) then
 			gUOPath=3Dstring.sub(gUOPath,0,string.find(gUOPath,"\\uotd.exe"))
 		end
-		print(gUOPath)
+		print("auto-detected uo path:",gUOPath)
 	else
 		gUOPath =3D "../uo/"
 	end

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Mon Oct 20 19:49:34 2008
@@ -192,11 +192,12 @@
 		LoadingProfile("init AnimLoader")
 		gAnimLoader =3D {}
 		-- old : gAnimFile,gAnimidxFile =

-		gAnimLoader[1] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim.idx") ),CorrectPath( Addfilepath("anim.mul") ))		=

-		gAnimLoader[2] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim2.idx") ),CorrectPath( Addfilepath("anim2.mul") ))		=

-		gAnimLoader[3] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim3.idx") ),CorrectPath( Addfilepath("anim3.mul") ))		=

-		gAnimLoader[4] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim4.idx") ),CorrectPath( Addfilepath("anim4.mul") ))		=

-		gAnimLoader[5] =3D CreateAnimLoader(gAnimLoaderType,200,200,CorrectPath(=
 Addfilepath("anim5.idx") ),CorrectPath( Addfilepath("anim5.mul") ))		=

+		local path
+		path =3D CorrectPath( Addfilepath("anim.idx" ) ) if (file_exists(path)) =
then gAnimLoader[1] =3D CreateAnimLoader(gAnimLoaderType,200,200,path,Corre=
ctPath( Addfilepath("anim.mul" ) )) end	=

+		path =3D CorrectPath( Addfilepath("anim2.idx") ) if (file_exists(path)) =
then gAnimLoader[2] =3D CreateAnimLoader(gAnimLoaderType,200,200,path,Corre=
ctPath( Addfilepath("anim2.mul") )) end		=

+		path =3D CorrectPath( Addfilepath("anim3.idx") ) if (file_exists(path)) =
then gAnimLoader[3] =3D CreateAnimLoader(gAnimLoaderType,200,200,path,Corre=
ctPath( Addfilepath("anim3.mul") )) end		=

+		path =3D CorrectPath( Addfilepath("anim4.idx") ) if (file_exists(path)) =
then gAnimLoader[4] =3D CreateAnimLoader(gAnimLoaderType,200,200,path,Corre=
ctPath( Addfilepath("anim4.mul") )) end		=

+		path =3D CorrectPath( Addfilepath("anim5.idx") ) if (file_exists(path)) =
then gAnimLoader[5] =3D CreateAnimLoader(gAnimLoaderType,200,200,path,Corre=
ctPath( Addfilepath("anim5.mul") )) end		=

 	end
 	if (gAnimDataLoaderType) then
 		LoadingProfile("init AnimDataLoader")

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Mon Oct 20 19:49:34 2008
@@ -213,7 +213,8 @@
 	local n =3D iRealID..","..iLoaderIndex
 	local o =3D gAnimFrameCountCache[n] =

 	if (o ~=3D nil) then return o end
-	local o =3D gAnimLoader[iLoaderIndex or 1]:GetNumberOfFrames(iRealID)
+	local loader =3D gAnimLoader[iLoaderIndex or 1]
+	local o =3D loader and loader:GetNumberOfFrames(iRealID)
 	gAnimFrameCountCache[n] =3D o or false
 	return o
 end
@@ -324,8 +325,10 @@
 =

 --- returns pImage,iWidth,iHeight,iCenterX,iCenterY,iFrames
 function ExportAnimFrameToImage (iRealID,iFrame,iHue,iLoaderIndex)
+	local loader =3D gAnimLoader[iLoaderIndex or 1]
+	if (not loader) then return end
 	local pImage =3D CreateImage()
-	local bSuccess,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D gAnimLoader[i=
LoaderIndex or 1]:ExportToImage(pImage,iRealID,iFrame,gHueLoader,iHue)
+	local bSuccess,iWidth,iHeight,iCenterX,iCenterY,iFrames =3D loader:Export=
ToImage(pImage,iRealID,iFrame,gHueLoader,iHue)
 	if (not bSuccess) then pImage:Destroy() return end
 	return pImage,iWidth,iHeight,iCenterX,iCenterY,iFrames
 end
@@ -336,7 +339,8 @@
 	local n =3D iRealID..","..iFrame..","..iLoaderIndex
 	local o =3D gAnimFrameBitMaskCache[n]
 	if (o ~=3D nil) then return o end
-	o =3D gAnimLoader[iLoaderIndex]:CreateBitMask(iRealID,iFrame)
+	local loader =3D gAnimLoader[iLoaderIndex]
+	o =3D loader and loader:CreateBitMask(iRealID,iFrame)
 	gAnimFrameBitMaskCache[n] =3D o
 	return o
 end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Oct 20 19:49:34 2008
@@ -290,6 +290,8 @@
 =

 --- main function, when it returns, the program ends
 function Main ()
+	-- detect UOPath
+	if (not gUOPath) then AutoDetectUOPath() end
 	if (ClientVersionIsPost6017()) then =

 		local errmsg =3D "FATAL, gClientVersion >=3D 6.0.1.7 not supported yet (=
protocol changes), cur version =3D "..tostring(GetClientVersionAsNumber())
 		-- see http://iris2.de/index.php/Clientversion_6.0.1.7_and_later



From no-reply at zwischenwelt.org  Mon Oct 20 19:25:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 20 Oct 2008 17:25:34 -0000
Subject: [Iris-commit] [IRIS] r2617 - /trunk/lua/main.lua
Message-ID: <20081020180005.CF6D41C185EA@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 19:25:34 2008
New Revision: 2617

Log:
no granny model check if 2d mode is active

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Oct 20 19:25:34 2008
@@ -258,7 +258,7 @@
 		end
 	end
 	-- check for character(granny) models
-	if (not file_exists( CorrectGrannyPath(gGrannyConfigFile) )) then
+	if (gCurrentRenderer =3D=3D Renderer3D and (not file_exists( CorrectGrann=
yPath(gGrannyConfigFile) ))) then
 		FatalErrorMessage(sprintf("iris2 could not find character models in your=
 uo dir\n please install AOS or ML (see README)"))
 	end
 end



From no-reply at zwischenwelt.org  Mon Oct 20 20:21:24 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 20 Oct 2008 18:21:24 -0000
Subject: [Iris-commit] [IRIS] r2619 - /trunk/lua/obj/obj.mobile.lua
Message-ID: <20081020182124.872AF1C185DD@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 20 20:21:24 2008
New Revision: 2619

Log:
mobile model update on bodyid change (animal form...)

Modified:
    trunk/lua/obj/obj.mobile.lua

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Mon Oct 20 20:21:24 2008
@@ -199,6 +199,12 @@
 	=

 	local bIsPlayer =3D self.serial =3D=3D gPlayerBodySerial
 =

+	-- formchange
+	if (self.oldartid ~=3D self.artid) then
+		self.oldartid =3D self.artid
+		self.bEquipmentChanged =3D true
+	end
+	=

 	-- if something related to equipment might have changed =

 	-- this can also have happened if equipmentdata=3Dnil, e.g. when an equip=
ment item was destroyed directly
 	-- maybe only in UpdateContent and/or if equipmentdata is set ?



From no-reply at zwischenwelt.org  Tue Oct 21 17:18:21 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 21 Oct 2008 15:18:21 -0000
Subject: [Iris-commit] [IRIS] r2620 - /trunk/lua/lib.mousepick.lua
Message-ID: <20081021151821.BDCB31C185B2@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 21 17:18:21 2008
New Revision: 2620

Log:
send single click

Modified:
    trunk/lua/lib.mousepick.lua

Modified: trunk/lua/lib.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mousepick.lua (original)
+++ trunk/lua/lib.mousepick.lua Tue Oct 21 17:18:21 2008
@@ -168,6 +168,8 @@
 			printdebug("net",sprintf("IrisContextMenuClick: serial=3D0x%08x\n",iSer=
ial))
 			Send_PopupRequest(iSerial) =

 			gLastRightClickSerial =3D iSerial
+			=

+			Send_SingleClick(iSerial) -- needs to be sent for pre-aos shard, trigge=
rs description sent, as there's no tooltip there
 		end
 =

 		--~ local iSerial =3D GetMouseHitSerial()



From no-reply at zwischenwelt.org  Tue Oct 21 17:25:26 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 21 Oct 2008 15:25:26 -0000
Subject: [Iris-commit] [IRIS] r2621 - in /trunk/lua: lib.desktop.lua
	widgets/widget.uocontainer.lua
Message-ID: <20081021152526.24D0D1C185B2@zwischenwelt.org>

Author: hagish
Date: Tue Oct 21 17:25:25 2008
New Revision: 2621

Log:
healthbar and container store position and open state

Modified:
    trunk/lua/lib.desktop.lua
    trunk/lua/widgets/widget.uocontainer.lua

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Oct 21 17:25:25 2008
@@ -101,15 +101,18 @@
 gDesktopElementFactory.healthbar =3D {
 	open =3D function(x,y,param) OpenHealthbar(GetMobile(param),x,y) end, =

 	checkpos =3D function(e, widget) =

-		local d =3D widget.dialog
-		local p =3D gHealthbarDialogs[e.param]
-		if p and d and p =3D=3D d then e.x,e.y =3D widget:GetPos() return true e=
nd
-	end,
-}
-RegisterListener("Hook_CloseHealthbar",function(dialog,serial) RemoveDeskt=
opElement("healthbar",serial) SaveDesktop() end)
-RegisterListener("Hook_OpenHealthbar",function(dialog,serial) =

-	if dialog and dialog.rootwidget and dialog.rootwidget.gfx then
-		local x,y =3D dialog:GetPos()
+		local serial =3D (widget.mobile and widget.mobile.serial) or 0
+		if e.param =3D=3D serial then e.x,e.y =3D widget:GetPos() return true end
+	end,
+}
+RegisterListener("Hook_CloseHealthbar",function(widget,serial) =

+	RemoveDesktopElement("healthbar",serial) =

+	SaveDesktop() =

+end)
+RegisterListener("Hook_OpenHealthbar",function(widget,serial) =

+	local serial =3D widget.mobile.serial
+	if widget and serial then
+		local x,y =3D widget:GetPos()
 		ReplaceDesktopElement("healthbar",x,y,serial) 	=

 		SaveDesktop()
 	end
@@ -120,15 +123,19 @@
 gDesktopElementFactory.container =3D {
 	open =3D function(x,y,param) OpenContainer(param,x,y) end, =

 	checkpos =3D function(e, widget) =

-		local d =3D widget.dialog
-		local p =3D GetContainer(e.param)
-		if p and p.dialog and d and p.dialog =3D=3D d then e.x,e.y =3D widget.gf=
x:GetPos() return true end
-	end,
-}
-RegisterListener("Hook_CloseContainer",function(dialog,serial) RemoveDeskt=
opElement("container",serial) SaveDesktop() end)
-RegisterListener("Hook_OpenContainer",function(dialog,serial) =

-	if dialog and dialog.rootwidget and dialog.rootwidget.gfx then
-		local x,y =3D dialog.rootwidget.gfx:GetPos()
+		local serial =3D (widget.uoContainer and widget.uoContainer.serial) or 0
+		if e.param =3D=3D serial then e.x,e.y =3D widget:GetPos() return true end
+	end,
+}
+RegisterListener("Hook_CloseContainer",function(widget) =

+	local serial =3D widget.uoContainer.serial
+	RemoveDesktopElement("container",serial) =

+	SaveDesktop() =

+end)
+RegisterListener("Hook_OpenContainer",function(widget) =

+	local serial =3D widget.uoContainer.serial
+	if widget and serial then
+		local x,y =3D widget:GetPos()
 		ReplaceDesktopElement("container",x,y,serial) 	=

 		SaveDesktop()
 	end
@@ -254,6 +261,20 @@
 end
 =

 RegisterListener("Gui_StopMouseMoveWidget",function(widget,x,y) -- new gui=
 system
+	local nx,ny =3D widget:GetPos()
+	print("Gui_StopMouseMoveWidget",widget,x,y,nx,ny)
+	for k,v in pairs(gDesktop) do
+		if gDesktopElementFactory[v.name] and gDesktopElementFactory[v.name].che=
ckpos then
+			if gDesktopElementFactory[v.name].checkpos(v,widget) then =

+				print("REPLACE",nx,ny)
+				ReplaceDesktopElementIn(v.name,nx,ny,v.param,gDesktopPositions)
+				SaveDesktop() =

+			end
+		end
+	end
+end)
+
+RegisterListener("Gui_StopMoveDialog",function(widget,x,y) -- old gui syst=
em
 	for k,v in pairs(gDesktop) do
 		if gDesktopElementFactory[v.name] and gDesktopElementFactory[v.name].che=
ckpos then
 			if gDesktopElementFactory[v.name].checkpos(v,widget) then =

@@ -264,17 +285,6 @@
 	end
 end)
 =

-RegisterListener("Gui_StopMoveDialog",function(widget,x,y) -- old gui syst=
em
-	for k,v in pairs(gDesktop) do
-		if gDesktopElementFactory[v.name] and gDesktopElementFactory[v.name].che=
ckpos then
-			if gDesktopElementFactory[v.name].checkpos(v,widget) then =

-				ReplaceDesktopElementIn(v.name,x,y,v.param,gDesktopPositions)
-				SaveDesktop() =

-			end
-		end
-	end
-end)
-
 RegisterListener("Hook_StartInGame",function() =

 	gSelectedShardName =3D gSelectedShardName or "unknown"
 	gSelectedCharName =3D gSelectedCharName or "unknown"

Modified: trunk/lua/widgets/widget.uocontainer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uocontainer.lua (original)
+++ trunk/lua/widgets/widget.uocontainer.lua Tue Oct 21 17:25:25 2008
@@ -23,6 +23,8 @@
 	local x,y =3D GetDesktopElementPosition("container",container.serial)
 	self:SetPos(x or 200,y or 100)
 	self:RefreshItems()
+	=

+	NotifyListener("Hook_OpenContainer",self)
 end
 =

 --~ function gWidgetPrototype.UOContainerDialog:on_destroy ()
@@ -44,4 +46,7 @@
 function gWidgetPrototype.UOContainerDialog:on_mouse_left_down	() self:Bri=
ngToFront() self:StartMouseMove() end
 function gWidgetPrototype.UOContainerDialog:on_mouse_right_down	() self:Cl=
ose() end
 =

-function gWidgetPrototype.UOContainerDialog:Close	() CloseContainer(self.u=
oContainer.serial) end -- triggers destroy
+function gWidgetPrototype.UOContainerDialog:Close	() =

+	NotifyListener("Hook_CloseContainer",self)
+	CloseContainer(self.uoContainer.serial) =

+end -- triggers destroy



From no-reply at zwischenwelt.org  Tue Oct 21 19:05:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 21 Oct 2008 17:05:49 -0000
Subject: [Iris-commit] [IRIS] r2622 - /trunk/data/mymacros.lua.dist
Message-ID: <20081021170549.CCD461C185B2@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 21 19:05:49 2008
New Revision: 2622

Log:
corrected mousewheel zoom

Modified:
    trunk/data/mymacros.lua.dist

Modified: trunk/data/mymacros.lua.dist
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/mymacros.lua.dist (original)
+++ trunk/data/mymacros.lua.dist Tue Oct 21 19:05:49 2008
@@ -49,8 +49,8 @@
 SetMacro("alt+v",		function() MacroCmd_ToggleHideGUI() MacroCmd_Screenshot=
() MacroCmd_ToggleHideGUI() end)
 SetMacro("x",			function() MacroCmd_CamChangeZoom( 1) end)
 SetMacro("y",			function() MacroCmd_CamChangeZoom(-1) end)
-SetMacro("wheelup",		function() MacroCmd_CamChangeZoom( 0.3) end)
-SetMacro("wheeldown",	function() MacroCmd_CamChangeZoom(-0.3) end)
+SetMacro("wheelup",		function() MacroCmd_CamChangeZoom(-0.3) end)
+SetMacro("wheeldown",	function() MacroCmd_CamChangeZoom( 0.3) end)
 =

 SetMacro("g",			function() MacroCmd_RepeatLastChat() end)
 SetMacro("h",			function() MacroCmd_RepeatLastDoubleClick() end)



From no-reply at zwischenwelt.org  Wed Oct 22 01:48:57 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 21 Oct 2008 23:48:57 -0000
Subject: [Iris-commit] [IRIS] r2623 - in /trunk:
 lua/widgets/widget.uotooltip.lua plugins/lib.spellbar.lua
 plugins/moblist.lua
Message-ID: <20081021234857.857911C18476@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 22 01:48:56 2008
New Revision: 2623

Log:
small adjustments

Modified:
    trunk/lua/widgets/widget.uotooltip.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Wed Oct 22 01:48:56 2008
@@ -42,6 +42,10 @@
 	gfxparams.xoff =3D l-borderl
 	gfxparams.yoff =3D t-bordert
 	local w,h =3D r-l,b-t
+	if (w < 0 or w > 1000) then print("uotooltip : w out of bounds",w) end
+	if (h < 0 or h > 1000) then print("uotooltip : h out of bounds",h) end
+	w =3D min(300,max(0,w))
+	h =3D min(300,max(0,h))
 	gfxparams.w =3D borderl+w+borderr
 	gfxparams.h =3D bordert+h+borderb
 	self.spritepanel:Update(gfxparams)

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Wed Oct 22 01:48:56 2008
@@ -144,14 +144,17 @@
 gSpellbarShortMessages[500112] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
n"			} -- You are now under the protection of the town guards. =

 gSpellbarShortMessages[500113] =3D {r=3D0.5,g=3D0,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

 gSpellbarShortMessages[501942] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"locatio=
n blocked"	} -- That location is blocked.           =

-gSpellbarShortMessages[500119] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"mustwai=
t"			} -- You must wait to perform another action.     =

+gSpellbarShortMessages[500119] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"mustwai=
t-a"		} -- You must wait to perform another action.     =

+gSpellbarShortMessages[500118] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"mustwai=
t-s"		} -- You must wait a few moments to use another skill.  =

 gSpellbarShortMessages[500446] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"too far=
"			} -- That is too far away. =

  =

 gSpellbarShortMessages[501284] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"You may=
 not enter." } -- You may not enter.
 gSpellbarShortMessages[500111] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"frozen"=
 			} -- You are frozen and cannot move. =

 gSpellbarShortMessages[502381] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"cannot =
move!" 		} -- You cannot move!
 gSpellbarShortMessages[502382] =3D {r=3D0.0,g=3D0.5,b=3D0.0,txt=3D"can mov=
e!" 		} -- You can move!
-
+gSpellbarShortMessages[1060160] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"bleed"=
 			} -- You are bleeding!  (serial=3D0xfff)
+gSpellbarShortMessages[1060757] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"bleeds=
tart" 		} -- You are bleeding profusely  (serial=3Dself=3D899675)
+gSpellbarShortMessages[1060167] =3D {r=3D0.0,g=3D0.5,b=3D0.0,txt=3D"bleeds=
top" 		} -- The bleeding wounds have healed, you are no longer bleeding!
 =

 --[[
 Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091
@@ -170,7 +173,8 @@
 	if (texttype =3D=3D kTextType_Label) then return end
 	local short =3D gSpellbarShortMessages[text_messagenum]
 	if (short) then SpellBarRiseTextOnMob(GetPlayerSerial(),short.r,short.g,s=
hort.b,short.txt) end
-	if ((not short) and serial =3D=3D 0xFFFFFFFF) then print("Hook_Packet_Loc=
alized_Text",serial,plaintext,text_messagenum) end
+	if (not short) then print("Hook_Packet_Localized_Text",serial,plaintext,t=
ext_messagenum) end
+	-- and serial =3D=3D 0xFFFFFFFF
 	if (serial ~=3D 0xFFFFFFFF) then
 		local r,g,b =3D 1,1,0 -- yellow
 		SpellBarRiseTextOnMob(serial,r,g,b,plaintext)

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Wed Oct 22 01:48:56 2008
@@ -375,7 +375,7 @@
 end
 =

 =

-function gWidgetPrototype.UOMobListItem:on_mouse_left_down	() self:SetSelf=
AsMainTarget() end
+function gWidgetPrototype.UOMobListItem:on_mouse_left_down	() if (gKeyPres=
sed[key_lcontrol]) then self:SetSelfAsMainTarget() end end
 =

 =

 -- ***** ***** ***** ***** ***** rest



From no-reply at zwischenwelt.org  Wed Oct 22 19:45:23 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 17:45:23 -0000
Subject: [Iris-commit] [IRIS] r2624 - /trunk/lua/lib.spellbooks.lua
Message-ID: <20081022174523.2B6351C1863F@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 22 19:45:22 2008
New Revision: 2624

Log:
mage spellbook fix for pol servers

Modified:
    trunk/lua/lib.spellbooks.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Wed Oct 22 19:45:22 2008
@@ -80,6 +80,7 @@
 ]]--
 =

 MageSpellbook			=3D hex2num("0x0EFA")
+MageSpellbook2			=3D hex2num("0xFFFF") -- used by pol, mapped to MageSpell=
book
 NecroSpellbook			=3D hex2num("0x2253")
 ChivalrySpellbook		=3D hex2num("0x2252") --dialog.gumpid =3D hex2num("0x2B=
01")
 BushidoSpellbook		=3D hex2num("0x238C") --dialog.gumpid =3D hex2num("0x2B0=
7")
@@ -125,6 +126,7 @@
 	=

 	ignore_available_flags =3D false
 }
+gSpellBooks[MageSpellbook2]	=3D gSpellBooks[MageSpellbook]
 =

 gSpellBooks[NecroSpellbook]	=3D {
 	name		=3D"Necromancer",



From no-reply at zwischenwelt.org  Wed Oct 22 22:02:13 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 20:02:13 -0000
Subject: [Iris-commit] [IRIS] r2625 - in /trunk/lua: lib.net.lua
 lib.packetvideo.lua lib.protocol.lua main.lua net.walk.lua
Message-ID: <20081022200213.514031C1863F@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 22 22:02:13 2008
New Revision: 2625

Log:
packetvideo experiments

Added:
    trunk/lua/lib.packetvideo.lua
Modified:
    trunk/lua/lib.net.lua
    trunk/lua/lib.protocol.lua
    trunk/lua/main.lua
    trunk/lua/net.walk.lua

Modified: trunk/lua/lib.net.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.net.lua (original)
+++ trunk/lua/lib.net.lua Wed Oct 22 22:02:13 2008
@@ -16,9 +16,10 @@
 end
 =

 function GetSendFIFO () return gSendFifo end
-function GetRecvFIFO () return gRecvFifo end
+function GetRecvFIFO () return gRecvFifoOverride or gRecvFifo end
 =

 function NetSendPacket ()
+	if (PacketVideo_BlockSend(gSendFifo)) then return end
 	LogOutgoingPacket(gSendFifo,gSendFifo:Size()) =

 	NetTrafficStep()
 end

Modified: trunk/lua/lib.protocol.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.protocol.lua (original)
+++ trunk/lua/lib.protocol.lua Wed Oct 22 22:02:13 2008
@@ -62,8 +62,14 @@
 		if iPacketSize <=3D 0 then
 			print("WARNING : HandlePackets -> forced Crash")
 			Crash()
-		end
+		end	=

 		=

+		HandlePacket(input,iId,iPacketSize)
+	end
+end
+
+function HandlePacket (input,iId,iPacketSize)
+	gRecvFifoOverride =3D input
 		local popped_start =3D input:GetTotalPopped()
 		LogIncomingPacket(input,iPacketSize) -- log packet
 		=

@@ -90,15 +96,15 @@
 			if (unusedlen < 0 and input.HackRestore) then input:HackRestore(-unused=
len) end
 			=

 		end
-		-- TODO : cScripting::GetSingletonPtr()->LuaCall("ProtocolPacketRecvHand=
ler","i",cmd);	=

-	end
+		-- TODO : cScripting::GetSingletonPtr()->LuaCall("ProtocolPacketRecvHand=
ler","i",cmd);
+	gRecvFifoOverride =3D nil
 end
 =

 -- Packet Logging --------------------------------------------------------=
---
 =

 gPacketLogInit =3D true
-function LogOutgoingPacket (fifo,len) LogPacket(fifo,len,"Client") end
-function LogIncomingPacket (fifo,len) LogPacket(fifo,len,"Server") end
+function LogOutgoingPacket (fifo,len) PacketVideo_LogSend(fifo,len) LogPac=
ket(fifo,len,"Client") end
+function LogIncomingPacket (fifo,len) PacketVideo_LogRecv(fifo,len) LogPac=
ket(fifo,len,"Server") end
 function LogPacket (fifo,len,direction) =

 	if (not gLogPackets or not (len > 0)) then return end
 	local cmd =3D fifo:PeekNetUint8(0)

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Wed Oct 22 22:02:13 2008
@@ -91,6 +91,7 @@
 dofile(libpath .. "lib.uoanim.lua")
 dofile(libpath .. "lib.uotooltip.lua")
 dofile(libpath .. "lib.blendout.lua")
+dofile(libpath .. "lib.packetvideo.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Wed Oct 22 22:02:13 2008
@@ -112,6 +112,7 @@
 	mobile.zloc =3D zloc
 	mobile.dir =3D fulldir
 	mobile:Update()
+	PacketVideo_LogPlayerPos(xloc,yloc,zloc,fulldir)
 	=

 	-- handle position update
 	gCurrentRenderer:BlendOutLayersAbovePlayer()



From no-reply at zwischenwelt.org  Wed Oct 22 22:32:51 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 20:32:51 -0000
Subject: [Iris-commit] [IRIS] r2626 - in /trunk: bin/iris2.exe
	lua/lib.3d.dynamic.lua
Message-ID: <20081022203251.1A7AF1C1863F@zwischenwelt.org>

Author: sience
Date: Wed Oct 22 22:32:50 2008
New Revision: 2626

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe
    trunk/lua/lib.3d.dynamic.lua

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Wed Oct 22 22:32:50 2008
@@ -269,7 +269,7 @@
 		multi.staticGeometry:Destroy() =

 		multi.staticGeometry =3D nil
 	end
-	]]
+	]]--
 end
 =

 -- multi / house =




From no-reply at zwischenwelt.org  Wed Oct 22 23:20:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 21:20:44 -0000
Subject: [Iris-commit] [IRIS] r2627 - /trunk/lua/lib.packetvideo.lua
Message-ID: <20081022212044.A3DD11C1863F@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 22 23:20:44 2008
New Revision: 2627

Log:
packetvideo load/save working

Modified:
    trunk/lua/lib.packetvideo.lua

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Wed Oct 22 23:20:44 2008
@@ -11,24 +11,34 @@
 kPacketVideoChunkType_Pos	=3D 3
 =

 gPacketVideoKnownBlockSend =3D {}
-gPacketVideoKnownBlockSend[kPacket_Single_Click] =3D true
 gPacketVideoKnownBlockSend[kPacket_ExtBundledPacket] =3D true -- request p=
arty pos
+gPacketVideoKnownBlockSend[kPacket_Generic_Command] =3D true -- ??
+gPacketVideoKnownBlockSend[kPacket_Take_Object] =3D true -- looter
+gPacketVideoKnownBlockSend[kPacket_Double_Click] =3D true -- looter
+gPacketVideoKnownBlockSend[kPacket_Single_Click] =3D true -- mobname reque=
st
 =

 gPacketVideoNoPlaybackPackets =3D {}
 gPacketVideoNoPlaybackPackets[kPacket_Ping] =3D true
 gPacketVideoNoPlaybackPackets[kPacket_Accept_Movement_Resync_Request] =3D =
true
 gPacketVideoNoPlaybackPackets[kPacket_Block_Movement] =3D true
+gPacketVideoNoPlaybackPackets[kPacket_Target] =3D true
+
+gPacketVideoFileName =3D "../myvid.ipv"
 =

 =

-
-
-function PacketVideo_Recording_Start() PacketVideo_ClearData() gPacketVide=
oRecording =3D true end
+function PacketVideo_Recording_Start() =

+	gPacketVideoFileName =3D "../myvid."..(os.time() or Client_GetTicks()).."=
.ipv"
+	PacketVideo_ClearData() =

+	gPacketVideoRecording =3D true =

+end
 function PacketVideo_Recording_End() gPacketVideoRecording =3D false end
 =

 =

 function PacketVideo_Playback() =

 	if (not gPacketVideoData[1]) then return end
 	job.create(function()
+		local oldpos =3D {gPlayerXLoc,gPlayerYLoc,gPlayerZLoc,gPlayerDir}
+		local oldfacet =3D MapGetMapIndex()
 		print("### packetvideo playback start",#gPacketVideoData)
 		gPacketVideoPlaybackRunning =3D true
 		local playback_start_t =3D Client_GetTicks()
@@ -36,15 +46,16 @@
 		for k,chunk in pairs(gPacketVideoData) do
 			local t =3D Client_GetTicks()
 			local framet =3D chunk.t - record_start_t + playback_start_t
-			print("### packetvideo playback step, wait=3D",framet,chunk.chunktype)
+			--~ print("### packetvideo playback step, wait=3D",framet,chunk.chunkty=
pe)
 			if (framet > t) then job.wait(framet-t) end
 			=

 			if (chunk.chunktype =3D=3D kPacketVideoChunkType_Recv) then
-				local iId =3D chunk.data:PeekNetUint8(0)
+				local headlen =3D 1+4+4
+				local iId =3D chunk.data:PeekNetUint8(headlen)
 				if (not gPacketVideoNoPlaybackPackets[iId]) then =

 					local fifo =3D CreateFIFO()
-					fifo:PushFIFOPartRaw(chunk.data)
-					print("playback packet",chunk.data:Size(),fifo:Size())
+					fifo:PushFIFOPartRaw(chunk.data,headlen)
+					--~ print("playback packet",chunk.data:Size(),fifo:Size())
 					local iPacketSize =3D fifo:Size()
 					HandlePacket(fifo,iId,iPacketSize)
 					fifo:Destroy()
@@ -57,12 +68,23 @@
 		end
 		gPacketVideoPlaybackRunning =3D false
 		print("### packetvideo playback end")
+		MapChangeRequest(oldfacet)
+		SetPlayerPos(unpack(oldpos)) =

+		Send_Movement_Resync_Request()
 	end)
 end
 =

 =

 =

-
+RegisterListener("Hook_StartInGame",function ()
+	local pv =3D gCommandLineSwitches["-pv"]
+	if (not pv) then return end
+	local filename =3D gCommandLineArguments[pv+1]
+	if (filename) then =

+		PacketVideo_Load(filename)
+		--~ PacketVideo_Playback()
+	end
+end)
 =

 -- ***** ***** ***** ***** ***** hooks
 =

@@ -73,24 +95,84 @@
 	gPacketVideoData =3D {} =

 end
 =

+function MyPeek32	(fifo,offset)
+	-- should be fifo:PeekNetUint32(1)
+	return	fifo:PeekNetUint8(offset+0) +
+			fifo:PeekNetUint8(offset+1)*256 +
+			fifo:PeekNetUint8(offset+2)*256*256 +
+			fifo:PeekNetUint8(offset+3)*256*256*256 =

+end
+
+function PacketVideo_Load	(filename)
+	PacketVideo_ClearData()
+	local fifo =3D CreateFIFO()
+	fifo:ReadFromFile(filename)
+	print("### packetvideo load",filename,fifo:Size())
+	while fifo:Size() > 0 do
+		local ctype	=3D fifo:PeekNetUint8(0)
+		local t		=3D MyPeek32(fifo,1)
+		local hex =3D ""
+		for i=3D0,1+4+4 do hex =3D hex .. sprintf("%02x ",fifo:PeekNetUint8(i)) =
end
+		--~ print("pv load step",ctype,t,fifo:PeekNetUint32(1+4),hex)
+		if (ctype =3D=3D kPacketVideoChunkType_Recv or =

+			ctype =3D=3D kPacketVideoChunkType_Send) then
+			local len	=3D MyPeek32(fifo,1+4)
+			local data =3D CreateFIFO()
+			data:PushFIFOPartRaw(fifo,0,len+1+4+4)
+			table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3Ddata})
+			fifo:PopRaw(1+4+4+len)
+		elseif (ctype =3D=3D kPacketVideoChunkType_Pos) then
+			fifo:PopRaw(1+4)
+			local xloc		=3D fifo:PopNetUint16()
+			local yloc		=3D fifo:PopNetUint16()
+			local zloc		=3D fifo:PopNetInt16()
+			local fulldir	=3D fifo:PopNetUint8()
+			table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{xloc,ylo=
c,zloc,fulldir}})
+		end      =

+	end
+	fifo:Destroy()
+end
+
 function PacketVideo_LogRecv(fifo,len)
 	if (not gPacketVideoRecording) then return end
+	local ctype =3D kPacketVideoChunkType_Recv
+	local t =3D Client_GetTicks()
 	local data =3D CreateFIFO()
+	data:PushUint8(ctype)
+	data:PushUint32(t)
+	data:PushUint32(len)
 	data:PushFIFOPartRaw(fifo,0,len)
-	assert(data:Size() =3D=3D len)
-	table.insert(gPacketVideoData,{chunktype=3DkPacketVideoChunkType_Recv,t=
=3DClient_GetTicks(),data=3Ddata})
+	table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3Ddata})
+	if (gPacketVideoFileName) then data:AppendToFile(gPacketVideoFileName) end
 end
 =

 function PacketVideo_LogSend(fifo,len)
 	if (not gPacketVideoRecording) then return end
+	local ctype =3D kPacketVideoChunkType_Send
+	local t =3D Client_GetTicks()
 	local data =3D CreateFIFO()
+	data:PushUint8(ctype)
+	data:PushUint32(t)
+	data:PushUint32(len)
 	data:PushFIFOPartRaw(fifo,0,len)
-	table.insert(gPacketVideoData,{chunktype=3DkPacketVideoChunkType_Send,t=
=3DClient_GetTicks(),data=3Ddata})
+	table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3Ddata})
+	if (gPacketVideoFileName) then data:AppendToFile(gPacketVideoFileName) end
 end
 =

 function PacketVideo_LogPlayerPos(xloc,yloc,zloc,fulldir)
 	if (not gPacketVideoRecording) then return end
-	table.insert(gPacketVideoData,{chunktype=3DkPacketVideoChunkType_Pos,t=3D=
Client_GetTicks(),data=3D{xloc,yloc,zloc,fulldir}})
+	local ctype =3D kPacketVideoChunkType_Pos
+	local t =3D Client_GetTicks()
+	local data =3D CreateFIFO()
+	data:PushUint8(ctype)
+	data:PushUint32(t)
+	data:PushNetUint16(xloc)
+	data:PushNetUint16(yloc)
+	data:PushNetInt16(zloc)
+	data:PushNetUint8(fulldir)
+	table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{xloc,yloc,=
zloc,fulldir}})
+	if (gPacketVideoFileName) then data:AppendToFile(gPacketVideoFileName) end
+	data:Destroy()
 end
 =

 function PacketVideo_BlockSend(fifo) =




From no-reply at zwischenwelt.org  Wed Oct 22 23:38:15 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 21:38:15 -0000
Subject: [Iris-commit] [IRIS] r2628 - in /trunk/lua: lib.3d.mousepick.lua
 lib.3d.renderer.lua lib.packetvideo.lua
Message-ID: <20081022213816.1A2F21C18451@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 22 23:38:15 2008
New Revision: 2628

Log:
minor fixes for packet video playback

Modified:
    trunk/lua/lib.3d.mousepick.lua
    trunk/lua/lib.3d.renderer.lua
    trunk/lua/lib.packetvideo.lua

Modified: trunk/lua/lib.3d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.mousepick.lua (original)
+++ trunk/lua/lib.3d.mousepick.lua Wed Oct 22 23:38:15 2008
@@ -65,7 +65,7 @@
 	=

 	=

 	-- terrain
-	if self.map3d_spawners and self.map3d_spawners.terrain and Renderer3D.gbB=
lendOutTerrainVisible then
+	if self.map3d_spawners and self.map3d_spawners.terrain and Renderer3D.gbB=
lendOutTerrainVisible and gGroundBlockLoader then
 		self.map3d_spawners.terrain:ForAllBlocks(function(block)
 			if block.gfx_terrain and block.gfx_terrain:IsAlive() then
 				local x,y,w,h =3D block:GetAABB()

Modified: trunk/lua/lib.3d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.renderer.lua (original)
+++ trunk/lua/lib.3d.renderer.lua Wed Oct 22 23:38:15 2008
@@ -513,21 +513,23 @@
 		-- add stepper to handle effect movement
 		=

 		local m =3D GetMobile(effect.sourceserial)
-		local dx,dy,dz =3D self:UOPosToLocal(m.xloc + relx,m.yloc + rely,m.zloc =
* 0.1 + relz)
-		local px,py,pz =3D self:UOPosToLocal(effect.current_locx + relx,effect.c=
urrent_locy + rely,effect.current_locz * 0.1 + relz)
-		=

-		RegisterStepper(function()
-			if not effect or not effect.gfx:IsAlive() then
-				-- i am dead so stop this
-				return true
-			end
+		if (m) then =

+			local dx,dy,dz =3D self:UOPosToLocal(m.xloc + relx,m.yloc + rely,m.zloc=
 * 0.1 + relz)
+			local px,py,pz =3D self:UOPosToLocal(effect.current_locx + relx,effect.=
current_locy + rely,effect.current_locz * 0.1 + relz)
 			=

-			local m =3D GetMobile(effect.sourceserial)
-			if m then
-				local dx,dy,dz =3D self:UOPosToLocal(m.xloc + relx,m.yloc + rely,m.zlo=
c * 0.1 + relz)
-				effect.gfx:SetPosition(dx,dy,dz)
-			end
-		end)
+			RegisterStepper(function()
+				if not effect or not effect.gfx:IsAlive() then
+					-- i am dead so stop this
+					return true
+				end
+				=

+				local m =3D GetMobile(effect.sourceserial)
+				if m then
+					local dx,dy,dz =3D self:UOPosToLocal(m.xloc + relx,m.yloc + rely,m.zl=
oc * 0.1 + relz)
+					effect.gfx:SetPosition(dx,dy,dz)
+				end
+			end)
+		end
 	end
 	=

 	return true

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Wed Oct 22 23:38:15 2008
@@ -64,6 +64,7 @@
 			elseif (chunk.chunktype =3D=3D kPacketVideoChunkType_Pos) then
 				local xloc,yloc,zloc,fulldir =3D unpack(chunk.data)
 				SetPlayerPos(xloc,yloc,zloc,fulldir) =

+				if (gCurrentRenderer =3D=3D Renderer3D) then gCurrentRenderer:NotifyPl=
ayerTeleported() end
 			end
 		end
 		gPacketVideoPlaybackRunning =3D false



From no-reply at zwischenwelt.org  Thu Oct 23 00:09:39 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 22:09:39 -0000
Subject: [Iris-commit] [IRIS] r2629 - /trunk/lua/lib.spellbooks.lua
Message-ID: <20081022220939.AF9961C18451@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 00:09:39 2008
New Revision: 2629

Log:
fixed spellcasttime-calc bug

Modified:
    trunk/lua/lib.spellbooks.lua

Modified: trunk/lua/lib.spellbooks.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.spellbooks.lua (original)
+++ trunk/lua/lib.spellbooks.lua Thu Oct 23 00:09:39 2008
@@ -287,19 +287,21 @@
 gSpellCircleByID =3D {}
 gSpellBookIDBySpellID =3D {}
 for spellbookid,spellbookdata in pairs(gSpellBooks) do
-	local startindex =3D spellbookdata.startindex
-	local circlesize =3D table.getn(spellbookdata.spells[1])
-	for circle,spelllist in pairs(spellbookdata.spells) do
-		for spellindex,myspellname in pairs(spelllist) do
-			local spellid					=3D spellindex + startindex + (circle-1)*circlesize
-			gSpellIDByName[myspellname]		=3D spellid
-			gSpellNameByID[spellid]			=3D myspellname
-			gSpellCircleByID[spellid]		=3D circle
-			gSpellBookIDBySpellID[spellid]	=3D spellbookid
-			--~ local regs =3D spellbookdata.spell_reags[circle][spellindex]
-			--~ local regtxt =3D ""
-			--~ for k,v in pairs(regs) do regtxt =3D regtxt .. tostring(spellbookda=
ta.reagenz[v]) .. "," end
-			--~ print("spell",gSpellBookNameByID[spellbookid],spellid,myspellname,r=
egtxt)
+	if (spellbookid ~=3D MageSpellbook2) then =

+		local startindex =3D spellbookdata.startindex
+		local circlesize =3D table.getn(spellbookdata.spells[1])
+		for circle,spelllist in pairs(spellbookdata.spells) do
+			for spellindex,myspellname in pairs(spelllist) do
+				local spellid					=3D spellindex + startindex + (circle-1)*circlesize
+				gSpellIDByName[myspellname]		=3D spellid
+				gSpellNameByID[spellid]			=3D myspellname
+				gSpellCircleByID[spellid]		=3D circle
+				gSpellBookIDBySpellID[spellid]	=3D spellbookid
+				--~ local regs =3D spellbookdata.spell_reags[circle][spellindex]
+				--~ local regtxt =3D ""
+				--~ for k,v in pairs(regs) do regtxt =3D regtxt .. tostring(spellbookd=
ata.reagenz[v]) .. "," end
+				--~ print("spell",gSpellBookNameByID[spellbookid],spellid,myspellname,=
regtxt)
+			end
 		end
 	end
 end



From no-reply at zwischenwelt.org  Thu Oct 23 01:33:26 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 23:33:26 -0000
Subject: [Iris-commit] [IRIS] r2630 - in /trunk/lua: lib.3d.dynamic.lua
 obj/obj.dynamic.lua obj/obj.main.lua
Message-ID: <20081022233326.BDA401C185FF@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 01:33:26 2008
New Revision: 2630

Log:
fixed multi cleanup in 2d (walkbug)

Modified:
    trunk/lua/lib.3d.dynamic.lua
    trunk/lua/obj/obj.dynamic.lua
    trunk/lua/obj/obj.main.lua

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Thu Oct 23 01:33:26 2008
@@ -578,7 +578,6 @@
 	if (dynamic.multi) then
 		printdebug("multi", sprintf("Multi destroyed with ARTID",dynamic.artid,v=
ardump(dynamic)) )
 		--~ Renderer3D:RebuildChunkAtUOPos(dynamic.xloc,dynamic.yloc)
-		gMultis[dynamic.multi] =3D nil =

 		Renderer3D:DestroyMultiGraphic(dynamic.serial)
 	end
 	=


Modified: trunk/lua/obj/obj.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.dynamic.lua (original)
+++ trunk/lua/obj/obj.dynamic.lua Thu Oct 23 01:33:26 2008
@@ -176,6 +176,11 @@
 	=

 	gDynamics[self.serial] =3D nil
 	DynamicRemoveFromPosCache(self)
+	=

+	-- remove multi entry
+	if (self.multi) then
+		gMultis[self.multi] =3D nil =

+	end
 	=

 	CleanupObject(self)
 end

Modified: trunk/lua/obj/obj.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.main.lua (original)
+++ trunk/lua/obj/obj.main.lua Thu Oct 23 01:33:26 2008
@@ -117,6 +117,7 @@
 		end
 		if (bDestroy) then object:Destroy() end =

 	end
+	gMultis =3D {} -- clear multi-list, used by walk, compass etc...
 end
 =

 =




From no-reply at zwischenwelt.org  Thu Oct 23 01:41:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 22 Oct 2008 23:41:44 -0000
Subject: [Iris-commit] [IRIS] r2631 - /trunk/lua/net.walk.lua
Message-ID: <20081022234144.9A98F1C1863F@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 01:41:44 2008
New Revision: 2631

Log:
walk-resync improvement

Modified:
    trunk/lua/net.walk.lua

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Thu Oct 23 01:41:44 2008
@@ -170,6 +170,7 @@
 -- internal, don't call directly, no check for walkable, only checks for t=
ime
 function ExecWalkRequestIfPossible	(iDir,bRunFlag)
 	if (not Walk_RequestTimeOk()) then return end
+	if (gResyncRequestActive and gMyTicks < gResyncRequestActive + 1000) then=
 return end
 	if (not FastWalk_Ok()) then return end
 	if (not gFastWalkKeysUsed) then =

 		if (not WalkQueueOkForNextSend()) then
@@ -331,6 +332,7 @@
 	if (t < gEarliestNextResyncRequestTime) then return end
 	gEarliestNextResyncRequestTime =3D t + 2000 -- server sends everything, i=
ncluding surrounding stuff
 	print("######## walk : ResyncRequest")
+	gResyncRequestActive =3D t
 	WalkLog("Send_Movement_Resync_Request")
 	ResetWalkQueue()
 	local out =3D GetSendFIFO()
@@ -365,6 +367,9 @@
 	--mobiledata.dir
 	--mobiledata.zloc
 	=

+	gResyncRequestActive =3D false
+	print("walk:teleport/resynced")
+	=

 	WalkLog("NotifyTeleport start")
 	CreateOrUpdateMobile(mobiledata)
 	UpdatePlayerBodySerial(mobiledata.serial) -- is this packet really only u=
sed for the player ??



From no-reply at zwischenwelt.org  Thu Oct 23 03:24:56 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 01:24:56 -0000
Subject: [Iris-commit] [IRIS] r2632 - in /trunk/lua: lib.uoids.lua
	net/net.other.lua
Message-ID: <20081023012456.E744A1C18476@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 03:24:55 2008
New Revision: 2632

Log:
charcreate : fixed blacksmith skillid, sendchat : option to deactivate spee=
chmul (pol shards), zero termination for strings

Modified:
    trunk/lua/lib.uoids.lua
    trunk/lua/net/net.other.lua

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Thu Oct 23 03:24:55 2008
@@ -253,7 +253,7 @@
 gCharCreateSkillIDs["Arms Lore"]				=3D 4
 gCharCreateSkillIDs["Parrying"]					=3D 5
 gCharCreateSkillIDs["Begging"]					=3D 6
-gCharCreateSkillIDs["Blacksmithing"]			=3D 7
+gCharCreateSkillIDs["Blacksmith"]				=3D 7
 gCharCreateSkillIDs["Bowcraft/Fletching"]		=3D 8
 gCharCreateSkillIDs["Peacemaking"]				=3D 9
 gCharCreateSkillIDs["Camping"]					=3D 10

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Thu Oct 23 03:24:55 2008
@@ -1200,10 +1200,11 @@
 	local keywords		=3D SpeechParseKeywords(ascistr)
 	local keywordcount	=3D table.getn(keywords)
 	local bEncoded		=3D keywordcount > 0
+	if (gNoSpeechKeyWords) then bEncoded =3D false end -- pre aos pol shards =
? (cloudstrive/zulu)
 	local hue			=3D hex2num("0x34")
 	local font			=3D 0 -- ignored by runuo 1
 	local msgtype		=3D kTextType_Normal + (bEncoded and kTextType_Encoded or =
0)
-	local packetlen		=3D 1+2+1+2+2+4+ (bEncoded and (2+0+ascilen) or (ascilen=
*2))
+	local packetlen		=3D 1+2+1+2+2+4+ (bEncoded and (2+0+ascilen+1) or (ascil=
en*2+2))
 	for i =3D 0,keywordcount-1 do packetlen =3D packetlen + ((math.mod(i,2) =
=3D=3D 0) and 1 or 2) end -- calc packetlength for encoding
 	=

 	local out =3D GetSendFIFO()
@@ -1228,9 +1229,13 @@
 				out:PushNetUint16(value)
 			end
 		end
+		print("#sendchat,encoded",gLanguage)
 		out:PushFilledString(ascistr, ascilen)  -- utf8
+		out:PushNetUint8(0) -- zero terminate
 	else =

+		print("#sendchat,plain",gLanguage)
 		out:PushFilledUnicodeString(ascistr, ascilen) -- unicode, 16 bit per let=
ter
+		out:PushNetUint16(0) -- zero terminate
 	end
 	=

 	out:SendPacket()



From no-reply at zwischenwelt.org  Thu Oct 23 03:53:27 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 01:53:27 -0000
Subject: [Iris-commit] [IRIS] r2633 - in /trunk/lua: lib.objectpicker.lua
	main.lua
Message-ID: <20081023015328.A107D1C1863F@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 03:53:26 2008
New Revision: 2633

Log:
started implementing object picker

Added:
    trunk/lua/lib.objectpicker.lua
Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct 23 03:53:26 2008
@@ -92,6 +92,7 @@
 dofile(libpath .. "lib.uotooltip.lua")
 dofile(libpath .. "lib.blendout.lua")
 dofile(libpath .. "lib.packetvideo.lua")
+dofile(libpath .. "lib.objectpicker.lua")
 =

 dofile(libpath .. "gui/gui.main.lua")
 dofile(libpath .. "obj/obj.main.lua")



From no-reply at zwischenwelt.org  Thu Oct 23 04:47:58 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 02:47:58 -0000
Subject: [Iris-commit] [IRIS] r2634 - /trunk/lua/lib.objectpicker.lua
Message-ID: <20081023024759.5AC1F1C1863F@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 04:47:58 2008
New Revision: 2634

Log:
implemented 0xAB and 0xAC(String_Query + response) for pre-aos, but respons=
e doesn't seem to work yet

Modified:
    trunk/lua/lib.objectpicker.lua

Modified: trunk/lua/lib.objectpicker.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.objectpicker.lua (original)
+++ trunk/lua/lib.objectpicker.lua Thu Oct 23 04:47:58 2008
@@ -86,3 +86,82 @@
 	out:PushNetUint16(hue)
 	out:SendPacket()
 end
+
+
+
+
+--~ gPacketType.kPacket_String_Query									=3D { id=3D0xAB }
+--~ gPacketType.kPacket_String_Response									=3D { id=3D0xAC }
+-- text entry dialog ? comes at the end of pre-aos crafter gump ?
+-- response =3D 0xAC
+function gPacketHandler.kPacket_String_Query() -- 0xAB
+	local input =3D GetRecvFIFO()
+	local popped_start =3D input:GetTotalPopped()
+	local id =3D input:PopNetUint8()
+	local size =3D input:PopNetUint16()
+	local data =3D {}
+	data.id			=3D input:PopNetUint32()
+	data.parentid	=3D input:PopNetUint8()
+	data.buttonid	=3D input:PopNetUint8()
+	data.textlen	=3D input:PopNetUint16() -- ??? not quite sure about the mea=
ning, but one byte was too few
+	data.text		=3D input:PopFilledString(data.textlen)
+	--~ local datalenleft2 =3D size-1-2-4-1-1-1-data.textlen
+	--~ for i=3D0,datalenleft2-1 do local v =3D input:PeekNetUint8(i) print("=
+",i,v,sprintf("%c",v)) end
+	=

+	data.cancel		=3D input:PopNetUint8() -- (0=3Ddisable, 1=3Denable)
+	data.style		=3D input:PopNetUint8() -- (0=3Ddisable, 1=3Dnormal, 2=3Dnume=
rical)
+	data.format		=3D input:PopNetUint32() -- (if style 1, max text len, if st=
yle2, max numeric value)
+	data.text2len	=3D input:PopNetUint8()
+	=

+	data.datalenleft =3D size-1-2-4-1-1-2-data.textlen-1-1-4-1
+	data.text2		=3D (data.datalenleft > 0) and input:PopFilledString(data.dat=
alenleft) or ""
+	HandleStringQuery(data)
+	--~ print("kPacket_String_Query",SmartDump(data))
+	--[[
+	kPacket_String_Query    {
+		datalenleft=3D2
+		id=3D0x00039bcb
+		parentid=3D0
+		buttonid=3D0
+		textlen=3D24=3D0x18
+		text=3D"How many loops? [0-100]"
+		cancel=3D1
+		style=3D1
+		format=3D4
+		text2=3D""
+		text2len=3D0
+		}
+	]]--
+end
+
+function HandleStringQuery (data)
+	print("HandleStringQuery",data.id,data.parentid,data.buttonid)
+	local rows =3D {
+		{ {data.text} },
+		{ {type=3D"EditText",controlname=3D"entry",w=3D200,h=3D24,text=3Ddata.te=
xt2} },
+		{ {"OK",function (widget) =

+				local txt =3D widget.dialog.controls["entry"]:GetText() or ""
+				print("HandleStringQuery",txt)
+				Send_String_Query_Response(data.id,data.parentid,data.buttonid,txt)
+				widget.dialog:Destroy()
+			end} },
+		}
+	local dialog =3D guimaker.MakeTableDlg(rows,100,100,false,true,gGuiDefaul=
tStyleSet,"window")
+end
+
+-- response to 0xAB
+function Send_String_Query_Response (id,mytype,myidx,response) -- 0xAC
+	local responselen =3D string.len(response)
+	local out =3D GetSendFIFO()
+	out:PushNetUint8(kPacket_String_Response)
+	out:PushNetUint16(responselen+3+1+1+4+2+1)
+	out:PushNetUint32(id)
+	out:PushNetUint8(mytype)
+	out:PushNetUint8(myidx)
+	out:PushNetUint8(0) -- unknown
+	out:PushNetUint8(0) -- unknown
+	out:PushNetUint8(0) -- unknown
+	out:PushFilledString(response,responselen)
+	out:SendPacket()
+	-- doesn't seemt to work yet =3D(
+end



From no-reply at zwischenwelt.org  Thu Oct 23 15:29:54 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 13:29:54 -0000
Subject: [Iris-commit] [IRIS] r2635 - /trunk/lua/lib.packetvideo.lua
Message-ID: <20081023132954.D18631C18476@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 15:29:54 2008
New Revision: 2635

Log:
packetvideo : log map index at start of recording

Modified:
    trunk/lua/lib.packetvideo.lua

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Thu Oct 23 15:29:54 2008
@@ -9,6 +9,7 @@
 kPacketVideoChunkType_Recv	=3D 1
 kPacketVideoChunkType_Send	=3D 2
 kPacketVideoChunkType_Pos	=3D 3
+kPacketVideoChunkType_Map	=3D 4
 =

 gPacketVideoKnownBlockSend =3D {}
 gPacketVideoKnownBlockSend[kPacket_ExtBundledPacket] =3D true -- request p=
arty pos
@@ -22,6 +23,7 @@
 gPacketVideoNoPlaybackPackets[kPacket_Accept_Movement_Resync_Request] =3D =
true
 gPacketVideoNoPlaybackPackets[kPacket_Block_Movement] =3D true
 gPacketVideoNoPlaybackPackets[kPacket_Target] =3D true
+gPacketVideoNoPlaybackPackets[kPacket_Open_Container] =3D true
 =

 gPacketVideoFileName =3D "../myvid.ipv"
 =

@@ -30,6 +32,8 @@
 	gPacketVideoFileName =3D "../myvid."..(os.time() or Client_GetTicks()).."=
.ipv"
 	PacketVideo_ClearData() =

 	gPacketVideoRecording =3D true =

+	PacketVideo_LogMap(MapGetMapIndex())
+	PacketVideo_LogPlayerPos(gPlayerXLoc,gPlayerYLoc,gPlayerZLoc,gPlayerDir)
 end
 function PacketVideo_Recording_End() gPacketVideoRecording =3D false end
 =

@@ -65,6 +69,9 @@
 				local xloc,yloc,zloc,fulldir =3D unpack(chunk.data)
 				SetPlayerPos(xloc,yloc,zloc,fulldir) =

 				if (gCurrentRenderer =3D=3D Renderer3D) then gCurrentRenderer:NotifyPl=
ayerTeleported() end
+			elseif (chunk.chunktype =3D=3D kPacketVideoChunkType_Map) then
+				local mapindex =3D unpack(chunk.data)
+				MapChangeRequest(mapindex)
 			end
 		end
 		gPacketVideoPlaybackRunning =3D false
@@ -72,6 +79,7 @@
 		MapChangeRequest(oldfacet)
 		SetPlayerPos(unpack(oldpos)) =

 		Send_Movement_Resync_Request()
+		Send_ClientQuery(gRequest_States,GetPlayerSerial())
 	end)
 end
 =

@@ -129,6 +137,10 @@
 			local zloc		=3D fifo:PopNetInt16()
 			local fulldir	=3D fifo:PopNetUint8()
 			table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{xloc,ylo=
c,zloc,fulldir}})
+		elseif (ctype =3D=3D kPacketVideoChunkType_Map) then
+			fifo:PopRaw(1+4)
+			local mapindex	=3D fifo:PopNetUint8()
+			table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{mapindex=
}})
 		end      =

 	end
 	fifo:Destroy()
@@ -176,6 +188,19 @@
 	data:Destroy()
 end
 =

+function PacketVideo_LogMap(mapindex)
+	if (not gPacketVideoRecording) then return end
+	local ctype =3D kPacketVideoChunkType_Map
+	local t =3D Client_GetTicks()
+	local data =3D CreateFIFO()
+	data:PushUint8(ctype)
+	data:PushUint32(t)
+	data:PushNetUint8(mapindex)
+	table.insert(gPacketVideoData,{chunktype=3Dctype,t=3Dt,data=3D{mapindex}})
+	if (gPacketVideoFileName) then data:AppendToFile(gPacketVideoFileName) end
+	data:Destroy()
+end
+
 function PacketVideo_BlockSend(fifo) =

 	if (not gPacketVideoPlaybackRunning) then return false end
 	local iId =3D fifo:PeekNetUint8(0) or 0



From no-reply at zwischenwelt.org  Thu Oct 23 17:15:02 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 15:15:02 -0000
Subject: [Iris-commit] [IRIS] r2636 - in /trunk/lua: lib.3d.walksmooth.lua
 lib.packetvideo.lua lib.tilefreewalk.lua main.lua obj/obj.mobile.lua
Message-ID: <20081023151502.52B791C18635@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 17:15:01 2008
New Revision: 2636

Log:
a few small fixes so packetvideos can be played in offline mode

Modified:
    trunk/lua/lib.3d.walksmooth.lua
    trunk/lua/lib.packetvideo.lua
    trunk/lua/lib.tilefreewalk.lua
    trunk/lua/main.lua
    trunk/lua/obj/obj.mobile.lua

Modified: trunk/lua/lib.3d.walksmooth.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.walksmooth.lua (original)
+++ trunk/lua/lib.3d.walksmooth.lua Thu Oct 23 17:15:01 2008
@@ -97,8 +97,10 @@
 end
 =

 function Renderer3D:NotifyPlayerTeleported ()
-	gTileFreeWalk:NotifyPlayerMobileTeleport(GetPlayerMobile())
-	self:WalkSmoothReset(GetPlayerMobile())
+	local playermobile =3D GetPlayerMobile() =

+	if (not playermobile) then return end
+	gTileFreeWalk:NotifyPlayerMobileTeleport(playermobile)
+	self:WalkSmoothReset(playermobile)
 end
 =

 -- used when teleported

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Thu Oct 23 17:15:01 2008
@@ -34,6 +34,7 @@
 	gPacketVideoRecording =3D true =

 	PacketVideo_LogMap(MapGetMapIndex())
 	PacketVideo_LogPlayerPos(gPlayerXLoc,gPlayerYLoc,gPlayerZLoc,gPlayerDir)
+	Send_ClientQuery(gRequest_States,GetPlayerSerial())
 end
 function PacketVideo_Recording_End() gPacketVideoRecording =3D false end
 =

@@ -68,7 +69,10 @@
 			elseif (chunk.chunktype =3D=3D kPacketVideoChunkType_Pos) then
 				local xloc,yloc,zloc,fulldir =3D unpack(chunk.data)
 				SetPlayerPos(xloc,yloc,zloc,fulldir) =

-				if (gCurrentRenderer =3D=3D Renderer3D) then gCurrentRenderer:NotifyPl=
ayerTeleported() end
+				if (gCurrentRenderer =3D=3D Renderer3D) then =

+					gCurrentRenderer:NotifyPlayerTeleported() =

+					gTileFreeWalk:SetPosFromPacketVideo(xloc,yloc,zloc,fulldir)
+				end
 			elseif (chunk.chunktype =3D=3D kPacketVideoChunkType_Map) then
 				local mapindex =3D unpack(chunk.data)
 				MapChangeRequest(mapindex)

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Thu Oct 23 17:15:01 2008
@@ -75,8 +75,7 @@
 	self.mbActive =3D false
 end
 =

-function gTileFreeWalk:Init ()
-	if (gCurrentRenderer ~=3D Renderer3D) then return end
+function gTileFreeWalk:PreInit ()
 	self.pathpoints =3D {}
 	self.debugmarkers =3D {}
 	self.debugmarkergroups =3D {}
@@ -87,6 +86,10 @@
 	self.pos_clientside =3D {0,0,0}
 	self.pos_lastconfirmed =3D {0,0,0}
 	self.pos_lastrequested =3D {0,0,0}
+end
+
+function gTileFreeWalk:Init ()
+	if (gCurrentRenderer ~=3D Renderer3D) then return end
 	self:SetPos_All(self:LocalToUOPos(0,0,0))
 	=

 	self.mbActive =3D true
@@ -538,6 +541,12 @@
 	self:SetPos_LastConfirmed(self:UOPosToLocal(xloc,yloc,zloc))
 end
 =

+function gTileFreeWalk:SetPosFromPacketVideo(xloc,yloc,zloc,fulldir)
+	local dir =3D DirWrap(fulldir)
+	self.movedirx,self.movediry =3D norm2(GetDirXLocal(dir),GetDirYLocal(dir))
+	gTileFreeWalk:SetPos_All(xloc,yloc,zloc)
+	gTileFreeWalk:UpdateClientPosMarker()
+end
 =

 function gTileFreeWalk:Impl_SetToPlayerPos (mobile)
 	self.movedirx,self.movediry =3D norm2(GetDirXLocal(gPlayerDir),GetDirYLoc=
al(gPlayerDir))
@@ -894,3 +903,5 @@
 	gWalkPathToGo =3D {{x=3Dx,y=3Dy,z=3D0}}
 	gWalkPathToGoSlow =3D slow
 end
+
+gTileFreeWalk:PreInit()

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct 23 17:15:01 2008
@@ -342,6 +342,7 @@
 =

 	-- maybe we should check here if in offline or online mode!?
 	InitNet()
+	InitMobileMethodWrappers()
 =

 	LoadingProfile("init basic gui")
 	CreateIrisLogo()

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Thu Oct 23 17:15:01 2008
@@ -43,10 +43,7 @@
 	return gMobiles[mobile_or_serial] -- look up by serial
 end
 =

--- constructor, don't call directly, use CreateOrUpdateMobile() instead
-function InitializeMobile	(serial)
-	assert(serial ~=3D 0)
-	=

+function InitMobileMethodWrappers ()
 	-- create method wrapppers, e.g. Mobile_UpdateFlags(serial) calls mobile:=
UpdateFlags()
 	if (not gbMobileMethodWrappersInitialized) then =

 		gbMobileMethodWrappersInitialized =3D true
@@ -58,6 +55,12 @@
 			end
 		end
 	end
+end
+
+-- constructor, don't call directly, use CreateOrUpdateMobile() instead
+function InitializeMobile	(serial)
+	assert(serial ~=3D 0)
+	InitMobileMethodWrappers()
 	=

 	-- create base object and register in mobile-list
 	local mobile =3D InitializeObject(serial)



From no-reply at zwischenwelt.org  Thu Oct 23 18:35:40 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 16:35:40 -0000
Subject: [Iris-commit] [IRIS] r2637 - in /trunk: lua/net/net.partysystem.lua
	plugins/moblist.lua
Message-ID: <20081023163540.72F441C18635@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 18:35:37 2008
New Revision: 2637

Log:
a few improvements with uoam and party position display

Modified:
    trunk/lua/net/net.partysystem.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/net/net.partysystem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.partysystem.lua (original)
+++ trunk/lua/net/net.partysystem.lua Thu Oct 23 18:35:37 2008
@@ -33,10 +33,10 @@
 -- returns xloc,yloc,iFacet,bIsOnSameFacet      =

 function PartySystem_GetMemberPos (serial)
 	local mapindex =3D MapGetMapIndex()
+	local mob =3D GetMobile(serial)
+	if (mob) then return mob.xloc,mob.yloc,mapindex,true end
 	local pos =3D gPartyMemberPosList[serial]
 	if (pos) then return pos.xloc,pos.yloc,pos.facet,pos.facet=3D=3Dmapindex =
end
-	local mob =3D GetMobile(serial)
-	if (mob) then return mob.xloc,mob.yloc,mapindex,true end
 end
 =

 function PartySystem_UpdateMemberList (memberlist)

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Thu Oct 23 18:35:37 2008
@@ -49,7 +49,7 @@
 function gWidgetPrototype.UOMobList:UpdatePartyNameTooltip	(serial)
 	local widget =3D self.partyWidgetList[serial]
 	if (not widget) then return end
-	widget.name =3D MobListShortenName(AosToolTip_GetText(serial) or "???")
+	widget.name =3D MobListShortenName(AosToolTip_GetText(serial) or "???+")
 	widget:SetText(widget.name)
 end
 =

@@ -59,7 +59,7 @@
 	for serial,v in pairs(partylist) do
 		local widget =3D partyWidgetList[serial]
 		if ((not widget) and serial ~=3D GetPlayerSerial()) then
-			local name =3D MobListShortenName(AosToolTip_GetText(serial) or "???")
+			local name =3D MobListShortenName(AosToolTip_GetText(serial) or "???#")
 			widget =3D gRootWidget.tooltip:CreateChild("UOText",{x=3D0,y=3D0,text=
=3Dname,col=3D{r=3D0,g=3D1,b=3D0},bold=3Dtrue})
 			widget.name =3D name
 			partyWidgetList[serial] =3D widget
@@ -76,7 +76,7 @@
 function gWidgetPrototype.UOMobList:StepPartyMarkers	()
 	for serial,widget in pairs(self.partyWidgetList) do
 		local xloc,yloc,iFacet,bIsOnSameFacet =3D PartySystem_GetMemberPos(seria=
l)
-		local zloc =3D 0
+		local zloc =3D gPlayerZLoc or 0
 		=

 		if (xloc) then
 			local px,py =3D gCurrentRenderer:UOPosToPixelPos(xloc,yloc,zloc)
@@ -119,7 +119,7 @@
 -- every frame
 function gWidgetPrototype.UOMobList:UOAMStep	()
 	for name,widget in pairs(self.uoamWidgetList) do -- {xloc=3D?,yloc=3D?,bI=
sOnSameFacet=3D?}
-		local xloc,yloc,zloc =3D widget.xloc,widget.yloc,0
+		local xloc,yloc,zloc =3D widget.xloc,widget.yloc,(gPlayerZLoc or 0)
 		local px,py =3D gCurrentRenderer:UOPosToPixelPos(xloc,yloc,zloc)
 		local w,h =3D widget:GetSize()
 		local minx,miny,maxx,maxy =3D 0,64,gViewportW-160,gViewportH-32
@@ -224,8 +224,10 @@
 		gfx:SetPos(x,y)
 		local f =3D 0.5 -- bigger -> longer line
 		local fi =3D 1 - f
-		local x2 =3D max(minx,min(maxx-w,(px or 0)))*fi + f*gViewportW*0.5
-		local y2 =3D max(miny,min(maxy-h,(py or 0)))*fi + f*gViewportH*0.5
+		local x =3D max(minx,min(maxx,(px or 0)))
+		local y =3D max(miny,min(maxy,(py or 0)))
+		local x2 =3D x*fi + f*gViewportW*0.5
+		local y2 =3D y*fi + f*gViewportH*0.5
 		gfx2:SetLineList({{x2,y2,0,x,y,0}})
 	end
 end



From no-reply at zwischenwelt.org  Thu Oct 23 18:57:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 16:57:03 -0000
Subject: [Iris-commit] [IRIS] r2638 - /trunk/lua/lib.2d.mousepick.lua
Message-ID: <20081023165704.963061C1865A@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 18:57:02 2008
New Revision: 2638

Log:
disabled tooltip for container backpane

Modified:
    trunk/lua/lib.2d.mousepick.lua

Modified: trunk/lua/lib.2d.mousepick.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mousepick.lua (original)
+++ trunk/lua/lib.2d.mousepick.lua Thu Oct 23 18:57:02 2008
@@ -13,6 +13,7 @@
 	if (not gKeyPressed[key_mouse_right]) then
 		serial =3D GetMouseHitSerial(true) -- executes mousepick
 		if (serial =3D=3D 0) then serial =3D nil end
+		if (gMousePickFoundHit and gMousePickFoundHit.hittype =3D=3D kMousePickH=
itType_Container) then serial =3D nil end -- backpane
 	end
 	=

 	StartUOToolTipAtMouse_Serial(serial)



From no-reply at zwischenwelt.org  Thu Oct 23 20:09:06 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 18:09:06 -0000
Subject: [Iris-commit] [IRIS] r2639 - in /trunk: lua/gui/gui.paperdoll.lua
 lua/lib.macrolist.lua lua/lib.packetvideo.lua lua/obj/obj.player.lua
 plugins/moblist.lua
Message-ID: <20081023180906.E249D1C18451@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 20:09:04 2008
New Revision: 2639

Log:
paperdoll : fixed warmode button coloring, MobListSetMainTargetSerial(seria=
l), MacroCmd_FindNearestMob()

Modified:
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.packetvideo.lua
    trunk/lua/obj/obj.player.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Thu Oct 23 20:09:04 2008
@@ -76,7 +76,6 @@
  [7]	=3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 1) then
 				Send_CombatMode(IsWarModeActive() and gWarmode_Normal or gWarmode_Comb=
at)
-				UpdatePaperdollWarPeaceButton()
 			end
 		  end,
  -- status
@@ -151,7 +150,14 @@
 =

 gPaperdolls =3D {}
 =

-function UpdatePaperdollWarPeaceButton(widget)
+RegisterListener("Hook_WarmodeChange",function () UpdatePaperdollWarPeaceB=
utton() end)
+
+function GetPaperDoll (serial) return serial and gPaperdolls[serial] end
+
+function UpdatePaperdollWarPeaceButton()
+	local paperdoll =3D GetPaperDoll(GetPlayerSerial())
+	local dialog =3D paperdoll and paperdoll.dialog
+	local widget =3D dialog and dialog.controls["btnpeace"]
 	if (widget) then
 		if (IsWarModeActive()) then
 			widget:SetButtonGumpIDs(0x7E8,0x7E9,0x7EA) -- normal,pressed,over
@@ -374,8 +380,7 @@
 	end
 =

 	-- visually change the Peace/Warmode Button when opening the Paperdoll wh=
en in combat mode
-	local widget =3D dialog.controls["btnpeace"]
-	UpdatePaperdollWarPeaceButton(widget)
+	UpdatePaperdollWarPeaceButton()
 =

 	-- update paperdoll name and color
 	--~ local r,g,b =3D GetNotorietyColor(paperdoll.mobile and paperdoll.mobi=
le.notoriety or 0)

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Thu Oct 23 20:09:04 2008
@@ -310,8 +310,8 @@
 	local xloc,yloc =3D GetPlayerPos()
 	for k,mobile in pairs(GetMobileList()) do =

 		local dist =3D dist2(xloc,yloc,mobile.xloc,mobile.yloc)
-		if ((not founddist) or dist < founddist) then =

-			if (StringContains(AosToolTip_GetText(mobile.serial) or mobile.name or =
"",namepart)) then
+		if (((not founddist) or dist < founddist) and (not IsPlayerMobile(mobile=
))) then =

+			if ((not namepart) or StringContains(AosToolTip_GetText(mobile.serial) =
or mobile.name or "",namepart)) then
 				founddist =3D dist
 				foundmob =3D mobile
 			end
@@ -319,6 +319,8 @@
 	end
 	return foundmob
 end
+
+function MacroCmd_FindNearestMob () return MacroCmd_FindNearestMobByName()=
 end
 =

 -- set itemserial =3D 0 to clear
 -- itemserial defaults to the serial of the item currently under the mouse

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Thu Oct 23 20:09:04 2008
@@ -27,6 +27,10 @@
 =

 gPacketVideoFileName =3D "../myvid.ipv"
 =

+
+function PacketVideo_Recording_Toggle() =

+	if (gPacketVideoRecording) then PacketVideo_Recording_End() else PacketVi=
deo_Recording_Start() end
+end
 =

 function PacketVideo_Recording_Start() =

 	gPacketVideoFileName =3D "../myvid."..(os.time() or Client_GetTicks()).."=
.ipv"

Modified: trunk/lua/obj/obj.player.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.player.lua (original)
+++ trunk/lua/obj/obj.player.lua Thu Oct 23 20:09:04 2008
@@ -111,6 +111,7 @@
 		JournalAddText("","You go into War!")
 		--printf("NET: kPacket_SetPlayerWarmode id: 0x%02x gWarmode: combat\n",i=
d)
 	end
+	NotifyListener("Hook_WarmodeChange",IsWarModeActive())
 	HealthBarSetWarMode()
 end
 =


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Thu Oct 23 20:09:04 2008
@@ -172,6 +172,7 @@
 	if (self.maintarget_serial) then
 		gfx:SetVisible(true)
 		gfx2:SetVisible(true)
+		name =3D name or MobListShortenName(AosToolTip_GetText(serial) or "???")
 		gfx:SetText(name)
 		MacroSetLastTarget(serial)
 	else
@@ -383,6 +384,7 @@
 -- ***** ***** ***** ***** ***** rest
 =

 function MobListGetMainTargetSerial() return gMobList.maintarget_serial end
+function MobListSetMainTargetSerial(serial) gMobList:SetMainTarget(serial)=
 end
 		=

 RegisterListener("Hook_PostLoad",function () gMobList =3D GetDesktopWidget=
():CreateChild("UOMobList") end)
 =




From no-reply at zwischenwelt.org  Thu Oct 23 21:44:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 19:44:42 -0000
Subject: [Iris-commit] [IRIS] r2640 - /trunk/lua/gui/gui.chat.lua
Message-ID: <20081023194442.75C681C18476@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 21:44:42 2008
New Revision: 2640

Log:
more chat tabs

Modified:
    trunk/lua/gui/gui.chat.lua

Modified: trunk/lua/gui/gui.chat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.chat.lua (original)
+++ trunk/lua/gui/gui.chat.lua Thu Oct 23 21:44:42 2008
@@ -18,6 +18,9 @@
 gGuiChatChannelFilter =3D {
 	default =3D ".+",
 	public =3D "<Public>",
+	trades =3D "<Trades>",
+	guild =3D "<Guild>",
+	ally =3D "<Alliance>",
 	newbies =3D "<Newbies>",
 	pvp =3D "<PvP>",
 	system =3D "System:",



From no-reply at zwischenwelt.org  Thu Oct 23 23:10:52 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 21:10:52 -0000
Subject: [Iris-commit] [IRIS] r2641 - in /trunk: installdeps.ubuntu.sh
	lua/main.lua
Message-ID: <20081023211053.05AE11C18635@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 23:10:52 2008
New Revision: 2641

Log:
added nvidia-cg-toolkit to installed deps, added gMaxFPS option

Modified:
    trunk/installdeps.ubuntu.sh
    trunk/lua/main.lua

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Thu Oct 23 23:10:52 2008
@@ -1,4 +1,4 @@
 #!/bin/bash
-DEPS=3D"liblua50-dev liblualib50-dev libalut-dev libopenal-dev libvorbisfi=
le3 libvorbis-dev libogg-dev libboost-dev libboost-thread-dev libogre14 lib=
ogre-dev libois-dev g++ gcc"
+DEPS=3D"nvidia-cg-toolkit liblua50-dev liblualib50-dev libalut-dev libopen=
al-dev libvorbisfile3 libvorbis-dev libogg-dev libboost-dev libboost-thread=
-dev libogre14 libogre-dev libois-dev g++ gcc"
 echo apt-get install $DEPS
 sudo apt-get install $DEPS

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct 23 23:10:52 2008
@@ -456,6 +456,13 @@
 =

 	Client_RenderOneFrame()
 	Client_USleep(1) -- just 1 millisecond, but gives other processes a chanc=
e to do something
+	if (gMaxFPS) then =

+		local t =3D Client_GetTicks()
+		local iMinTimeBetweenFrames =3D 1000/gMaxFPS
+		local iTimeSinceLastFrame =3D gLastFrameTime and (t - gLastFrameTime) or=
 iMinTimeBetweenFrames
+		gLastFrameTime =3D t
+		if (iMinTimeBetweenFrames > iTimeSinceLastFrame) then Client_USleep(iMin=
TimeBetweenFrames - iTimeSinceLastFrame) end =

+	end
 end
 =

 -- exports data if some commandline parameters are set



From no-reply at zwischenwelt.org  Thu Oct 23 23:41:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 21:41:25 -0000
Subject: [Iris-commit] [IRIS] r2642 - /trunk/lua/main.lua
Message-ID: <20081023214125.4F8981C18635@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 23 23:41:24 2008
New Revision: 2642

Log:
improved maxfps waiting

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct 23 23:41:24 2008
@@ -455,13 +455,15 @@
 	NotifyListener("Hook_PreRenderOneFrame")
 =

 	Client_RenderOneFrame()
-	Client_USleep(1) -- just 1 millisecond, but gives other processes a chanc=
e to do something
+	=

 	if (gMaxFPS) then =

 		local t =3D Client_GetTicks()
 		local iMinTimeBetweenFrames =3D 1000/gMaxFPS
 		local iTimeSinceLastFrame =3D gLastFrameTime and (t - gLastFrameTime) or=
 iMinTimeBetweenFrames
-		gLastFrameTime =3D t
-		if (iMinTimeBetweenFrames > iTimeSinceLastFrame) then Client_USleep(iMin=
TimeBetweenFrames - iTimeSinceLastFrame) end =

+		Client_USleep(max(1,iMinTimeBetweenFrames - iTimeSinceLastFrame))
+		gLastFrameTime =3D Client_GetTicks()
+	else
+		Client_USleep(1) -- just 1 millisecond, but gives other processes a chan=
ce to do something
 	end
 end
 =




From no-reply at zwischenwelt.org  Fri Oct 24 01:20:03 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 23 Oct 2008 23:20:03 -0000
Subject: [Iris-commit] [IRIS] r2643 - in /trunk/lua: lib.2d.map.lua
 lib.2d.mobile.lua lib.2d.renderer.lua lib.unifont.lua lib.uoanim.lua
 net.walk.lua
Message-ID: <20081023232003.91F281C18635@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 24 01:20:02 2008
New Revision: 2643

Log:
2d : mobile walk animation

Modified:
    trunk/lua/lib.2d.map.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.unifont.lua
    trunk/lua/lib.uoanim.lua
    trunk/lua/net.walk.lua

Modified: trunk/lua/lib.2d.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.map.lua (original)
+++ trunk/lua/lib.2d.map.lua Fri Oct 24 01:20:02 2008
@@ -96,7 +96,6 @@
 end
 =

 function Renderer2D:MapStep		()
-	self:MobileTestStep()
 	local t =3D Client_GetTicks()
 	local x,y,z =3D self:GetCamPos()
 	for k,spawner in pairs(self.map2d_spawners) do spawner:Step(t,x,y,z) end

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Fri Oct 24 01:20:02 2008
@@ -1,5 +1,7 @@
 -- mobiles (animals,players,monsters,npcs..)
 -- TODO : Equipconv.def ?
+
+Renderer2D.gStepMobiles =3D {}
 =

 -- main updater, create, position ...
 function Renderer2D:MobileSetVisible			(mobile,bVisible) =

@@ -12,9 +14,18 @@
 		local spriteblock =3D cUOSpriteBlock:New()
 		mobile.gfx2d =3D spriteblock
 	end
+	if (mobile.xloc ~=3D mobile.r2d_lastxloc or
+		mobile.yloc ~=3D mobile.r2d_lastyloc) then
+		mobile.r2d_lastxloc =3D mobile.xloc
+		mobile.r2d_lastyloc =3D mobile.yloc
+		mobile.r2d_lastmoved =3D gMyTicks
+	end
 	self:UpdateMobileGfx(mobile)
 end =

 =

+function Renderer2D:MobileStepOne(mobile)
+	self:UpdateMobileGfx(mobile)
+end
 =

 =

 function My2DMobileDebug (a)
@@ -58,6 +69,14 @@
 	local spriteblock =3D mobile.gfx2d
 	if (not spriteblock) then return end
 	spriteblock:Clear()
+	=

+	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
+	=

+	local fTimeSinceLastMove =3D gMyTicks - (mobile.r2d_lastmoved or 0)
+	local bRun =3D true
+	local iMoveInterval =3D WalkGetIntervalEx(mount,mobile.artid,bRun)
+	local bMoving =3D fTimeSinceLastMove <=3D iMoveInterval + 50
+	self.gStepMobiles[mobile] =3D bMoving and (gMyTicks + 10) or (gMyTicks + =
500)
 =

 	local xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
 	local tx,ty,tz,iIndex,fIndexRel =3D 0,0,0,0
@@ -67,7 +86,6 @@
 	local parts =3D {}
 	local iDirAdd,bMirrorX =3D GetAnimDirAdd(DirWrap(mobile.dir))
 	=

-	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
 	--~ table.insert(parts,{self:GetMobileMountModelAndHue(mobile)}) -- kLaye=
r_Mount
 	if (mount) then table.insert(parts,{gMountTranslate2D[mount.artid],mount.=
hue,gStandardHorse}) end
 	=

@@ -98,10 +116,16 @@
 			iIndex =3D iIndex + 1 =

 			fIndexRel =3D 200 * (1 - 1/iIndex) -- dirty hack to avoid zbuffer flick=
er
 			=

-			local iAnimID =3D gMy2DMobileDebugAnim or ( Anim_GetIdleAnim(iModelID,i=
LoaderIndex,mount) + iDirAdd )
-			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID,iLoaderIndex),iLoaderIndex) or 1000
+			local iAnimID =3D		bMoving and	(Anim_GetMoveAnim(iModelID,iLoaderIndex,=
mount,bRun) + iDirAdd) or
+											(Anim_GetIdleAnim(iModelID,iLoaderIndex,mount) + iDirAdd)
+			=

+			if (gMy2DMobileDebugAnim) then iAnimID =3D gMy2DMobileDebugAnim end
+			=

+			=

+			local iFrameCount =3D Anim2D_GetFrameCount(Anim_GetRealID(iModelID,iAni=
mID,iLoaderIndex),iLoaderIndex) or 1
 			if (iFrameCount < 1) then iFrameCount =3D 1 end
-			local iFrame =3D floor((gMy2DDebugFrame or 0) / 15) % iFrameCount
+			--~ local iFrame =3D floor((gMy2DDebugFrame or 0) / 15) % iFrameCount
+			local iFrame =3D (floor(gMyTicks/100)) % iFrameCount
 			local iFallBackAnim =3D iFallBackModel and Anim_GetIdleAnim(iFallBackMo=
del,1)
 			spriteblock:AddAnimModel(tx,ty,tz,iModelID,iHue,iLoaderIndex,iFallBackM=
odel,iFallBackAnim,iAnimID,iFrame,bMirrorX,CalcSortBonus(nil,sorttx,sortty,=
sorttz,fIndexRel,4),mobile) =

 		end
@@ -112,7 +136,10 @@
 	mobile.gfx2d:SetPosition(x,y,z)
 end
 =

-function Renderer2D:DestroyMobileGfx			(mobile) if (mobile.gfx2d) then mob=
ile.gfx2d:Destroy() mobile.gfx2d =3D nil end end
+function Renderer2D:DestroyMobileGfx			(mobile) =

+	if (mobile.gfx2d) then mobile.gfx2d:Destroy() mobile.gfx2d =3D nil end
+	self.gStepMobiles[mobile] =3D nil
+end
 =

 function Renderer2D:CreateMobileGfx				(mobile) self:UpdateMobile(mobile) =
end	=

 =

@@ -121,12 +148,19 @@
 function Renderer2D:MobileAnimStep				() end -- from mainstep
 function Renderer2D:MobileStartServerSideAnim	(animdata) end
 =

-function Renderer2D:MobileTestStep()
-	local playermobile =3D GetPlayerMobile()
+
+function Renderer2D:MobileStep()
+	local curt =3D gMyTicks
+	for mobile,t in pairs(self.gStepMobiles) do =

+		if (curt >=3D t) then self:MobileStepOne(mobile) end
+	end
+	=

+	--~ local playermobile =3D GetPlayerMobile()
 	--~ print("playermobile.dir",playermobile and DirWrap(playermobile.dir)) =

 	--~ gMy2DDebugFrame =3D floor(gMy2DDebugFrame or 0) + 1
 	--~ Renderer2D:UpdateMobileGfx(GetPlayerMobile())
-	if true then return end
+	--~ if true then return end
+	=

 	=

 	--~ local iRealID =3D Anim_GetRealID(iModelID,iAnimID,iLoaderIndex) =

 	--~ local o =3D gfx.animinfo   =3D GetAnimDataInfo(iModelID) -- o.miFrame=
s,o.miUnknown,o.miCount,o.miFrameInterval,o.miFrameStart

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Oct 24 01:20:02 2008
@@ -135,6 +135,7 @@
 =

 	self:EffectAnimStep() -- should be after player pos is updated, for effec=
ts moving with player
 	self:MapStep()
+	self:MobileStep()
 	self:HUDFX_MainStep()
 	self:Dynamics_MainStep()
 	self:MousePickStep()

Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Fri Oct 24 01:20:02 2008
@@ -148,7 +148,7 @@
 		local res	=3D {}
 		local uvw, uvh =3D u1-u0,v1-v0
 		res.matname	=3D matname
-		res.xmove	=3D w - overlapx*s + xoff*s
+		res.xmove	=3D ceil(w - overlapx*s + xoff*s)
 		res.xoff	=3D xoff
 		res.yoff	=3D yoff - 1*self.defaultlineh
 		res.w	=3D w

Modified: trunk/lua/lib.uoanim.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoanim.lua (original)
+++ trunk/lua/lib.uoanim.lua Fri Oct 24 01:20:02 2008
@@ -281,8 +281,15 @@
 	if (iModelID < high			) then return  5 end
 	if (iModelID < high + low	) then return 10 end
 	return bHasMount and 125 or 20  -- Human
-	--~ return 20 -- Human
-end
+end
+function Anim_GetMoveAnim (iModelID,iLoaderIndex,bHasMount,bRun)
+	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
+	if (iModelID < high			) then return  0 end
+	if (iModelID < high + low	) then return bRun and 5 or 0 end
+	return bHasMount and (bRun and 120 or 115) or (bRun and 5 or 0)  -- Human
+end
+
+
 function Anim_GetCorpseAnim (iModelID,iLoaderIndex)
 	local high,low =3D unpack(gUOAnimRealIDCatBoundsByLoaderIndex[iLoaderInde=
x])
 	if (iModelID < high			) then return bForward and 15 or 10 end
@@ -464,7 +471,7 @@
 -- iAnimID : 100- gethit/flinch/pain
 -- iAnimID : 105- die backwards
 -- iAnimID : 110- die forwards
--- iAnimID : 115- mount-wal
+-- iAnimID : 115- mount-walk
 -- iAnimID : 120- mount-run
 -- iAnimID : 125- mount-idle
 -- iAnimID : 130- mount-attack-swing?

Modified: trunk/lua/net.walk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net.walk.lua (original)
+++ trunk/lua/net.walk.lua Fri Oct 24 01:20:02 2008
@@ -161,6 +161,11 @@
 								and	(	bRunFlag and gWalkTimeout_MountRunningSpeed	or gWalkTimeout_=
MountMovingSpeed) or =

 									(	bRunFlag and gWalkTimeout_RunningSpeed		or gWalkTimeout_MovingS=
peed)
 end
+function WalkGetIntervalEx (bHasMount,iBodyID,bRunFlag)
+	return	( bHasMount or gIncreasedMovementSpeedBodyIDs[iBodyID] )
+								and	(	bRunFlag and gWalkTimeout_MountRunningSpeed	or gWalkTimeout_=
MountMovingSpeed) or =

+									(	bRunFlag and gWalkTimeout_RunningSpeed		or gWalkTimeout_MovingS=
peed)
+end
 =

 -- returns false if the walk queue is full and the next request should wait
 function WalkQueueOkForNextSend ()



From no-reply at zwischenwelt.org  Fri Oct 24 02:56:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 00:56:44 -0000
Subject: [Iris-commit] [IRIS] r2644 - in /trunk: lua/net/net.other.lua
	plugins/lib.spellbar.lua
Message-ID: <20081024005644.AE1821C18635@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 24 02:56:44 2008
New Revision: 2644

Log:
a few notes and removed debug output

Modified:
    trunk/lua/net/net.other.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Fri Oct 24 02:56:44 2008
@@ -1229,7 +1229,6 @@
 				out:PushNetUint16(value)
 			end
 		end
-		print("#sendchat,encoded",gLanguage)
 		out:PushFilledString(ascistr, ascilen)  -- utf8
 		out:PushNetUint8(0) -- zero terminate
 	else =


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Fri Oct 24 02:56:44 2008
@@ -157,12 +157,25 @@
 gSpellbarShortMessages[1060167] =3D {r=3D0.0,g=3D0.5,b=3D0.0,txt=3D"bleeds=
top" 		} -- The bleeding wounds have healed, you are no longer bleeding!
 =

 --[[
+
+Hook_Packet_Localized_Text      4294967295      You feel yourself resistin=
g magical energy.     501783
+Hook_Packet_Localized_Text      4294967295      You begin applying the ban=
dages.        500956
+Hook_Packet_Localized_Text      4294967295      Your Blood Oath has been b=
roken.        1061620
+Hook_Packet_Localized_Text      4294967295      You fall off of your mount=
 and take damage!     1060083
+Hook_Packet_Localized_Text      4294967295      You are still too dazed fr=
om being knocked off your mount to ride!      1040024
+Hook_Packet_Localized_Text      4294967295      You feel your life force b=
eing stolen away!     1070848
+Hook_Packet_Localized_Text      4294967295      You have cured the target =
of all poisons!       1010058
+Hook_Packet_Localized_Text      4294967295      You are already at full he=
alth. 1049547  potion ? =

+Hook_Packet_Localized_Text      4294967295      The essence of garlic burn=
s you!        1061651   some spells in necro form
+
+Hook_Packet_Localized_Text      899675  		* You begin to feel pain through=
out your body! *        1042861
+Hook_Packet_Localized_Text      407630  		* The poison seems to have no ef=
fect. * 1005534
+Hook_Packet_Localized_Text      326218  * Otsu is wracked with extreme pai=
n. *  1042864
+
 Hook_Packet_Localized_Text      4294967295      You prepare to hit your op=
ponent with a Death Strike.   1063091
 Hook_Packet_Localized_Text      4294967295      You inflict a Death Strike=
 upon your opponent!  1063094  (different message for 2nd..)
 Hook_Packet_Localized_Text      4294967295      You missed your opponent w=
ith a Death Strike.   1070779  =

 =

-Hook_Packet_Localized_Text      4294967295      You are already at full he=
alth. 1049547  potion ? =

-Hook_Packet_Localized_Text      4294967295      The essence of garlic burn=
s you!        1061651   some spells in necro form
 ]]--
 =

 =




From no-reply at zwischenwelt.org  Fri Oct 24 17:14:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 15:14:19 -0000
Subject: [Iris-commit] [IRIS] r2645 - in /trunk: lua/gui/gui.gumpparser.lua
 lua/lib.2d.renderer.lua lua/lib.uoids.lua lua/net/net.other.lua
 lua/widgets/widget.gumpdialog.lua plugins/lib.spellbar.lua
Message-ID: <20081024151420.280171C18451@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 24 17:14:19 2008
New Revision: 2645

Log:
tracking arror debug output, fixed skillname discordance

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/lib.2d.renderer.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/net/net.other.lua
    trunk/lua/widgets/widget.gumpdialog.lua
    trunk/plugins/lib.spellbar.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Fri Oct 24 17:14:19 2008
@@ -16,6 +16,7 @@
 end
 =

 kGumpParser_DebugDump =3D false
+--~ kGumpParser_DebugDump =3D true
 =

 function GumpParserTest ()
 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size

Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Oct 24 17:14:19 2008
@@ -119,10 +119,10 @@
 	=

 	-- TODO : self:CombatGuiStep() ?
 	local xloc,yloc,zloc =3D GetPlayerPos()
-	if (xloc) then self:SetCamPos(xloc,yloc,zloc) end
+	if (xloc and (not g2DCamMove)) then self:SetCamPos(xloc,yloc,zloc) end
 	=

 	-- keyboard move cam
-	local bKeyBoardMoveCam =3D bOfflineMode
+	local bKeyBoardMoveCam =3D g2DCamMove or bOfflineMode
 	if (bKeyBoardMoveCam) then
 		local dt =3D math.min(Renderer2D.kGoodTicksBetweenFrames/1000,gSecondsSi=
nceLastFrame)
 		local curticks =3D Client_GetTicks()

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Fri Oct 24 17:14:19 2008
@@ -261,7 +261,7 @@
 gCharCreateSkillIDs["Cartography"]				=3D 12
 gCharCreateSkillIDs["Cooking"]					=3D 13
 gCharCreateSkillIDs["Detecting Hidden"]			=3D 14
-gCharCreateSkillIDs["Discordance/Enticement"]	=3D 15
+gCharCreateSkillIDs["Discordance"]				=3D 15
 gCharCreateSkillIDs["Evaluate Intelligence"]	=3D 16
 gCharCreateSkillIDs["Healing"]					=3D 17
 gCharCreateSkillIDs["Fishing"]					=3D 18

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Fri Oct 24 17:14:19 2008
@@ -512,9 +512,15 @@
 function gPacketHandler.kPacket_TrackingArrow ()	-- 0xba
 	local input =3D GetRecvFIFO()
 	local id =3D input:PopNetUint8()
-	local arrow_active =3D input:PopNetUint8()
-	local arrow_xloc =3D input:PopNetUint16()
-	local arrow_yloc =3D input:PopNetUint16()
+	local arrow_active =3D input:PopNetUint8() -- 1:on 0:off(x=3Dy=3D-1)
+	local arrow_xloc =3D input:PopNetInt16()
+	local arrow_yloc =3D input:PopNetInt16()
+	=

+	local dx =3D arrow_xloc - (gPlayerXLoc or 0)
+	local dy =3D arrow_yloc - (gPlayerYLoc or 0)
+	=

+	if (arrow_active ~=3D 0) then print("TrackingArrow",dx,dy,"pos=3D",arrow_=
xloc,arrow_yloc) end
+	=

 =

 	printdebug("net",sprintf("NET: Trackingarrow is ON xLoc=3D0x%04x yLoc=3D0=
x%04x\n",arrow_xloc,arrow_yloc))
 =

@@ -972,6 +978,7 @@
 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_Attack)
 	out:PushNetUint32(mobile_serial)
+	gLastAttackedMobileSerial =3D mobile_serial
 	printdebug("net", sprintf("NET: Attack -> serial=3D0x%08x\n",mobile_seria=
l) )
 end
 =


Modified: trunk/lua/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.gumpdialog.lua (original)
+++ trunk/lua/widgets/widget.gumpdialog.lua Fri Oct 24 17:14:19 2008
@@ -49,7 +49,7 @@
 	local gumpdata =3D self.Gumpdata
 	if (not gumpdata) then return end
 	if (gumpdata.Data) then
-		print("GumpDialog:Search main",search,gumpdata.Data)
+		--~ print("GumpDialog:Search main",search,gumpdata.Data)
 		if (StringContains(gumpdata.Data,search)) then return true end
 	end
 	if (gumpdata.textline) then =


Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Fri Oct 24 17:14:19 2008
@@ -144,8 +144,8 @@
 gSpellbarShortMessages[500112] =3D {r=3D0,g=3D0.5,b=3D0,txt=3D"goardzone o=
n"			} -- You are now under the protection of the town guards. =

 gSpellbarShortMessages[500113] =3D {r=3D0.5,g=3D0,b=3D0,txt=3D"goardzone o=
ff"			} -- You have left the protection of the town guards.     =

 gSpellbarShortMessages[501942] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"locatio=
n blocked"	} -- That location is blocked.           =

-gSpellbarShortMessages[500119] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"mustwai=
t-a"		} -- You must wait to perform another action.     =

-gSpellbarShortMessages[500118] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"mustwai=
t-s"		} -- You must wait a few moments to use another skill.  =

+gSpellbarShortMessages[500119] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"actionw=
ait"		} -- You must wait to perform another action.     =

+gSpellbarShortMessages[500118] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"skillwa=
it"		} -- You must wait a few moments to use another skill.  =

 gSpellbarShortMessages[500446] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"too far=
"			} -- That is too far away. =

  =

 gSpellbarShortMessages[501284] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"You may=
 not enter." } -- You may not enter.
@@ -157,6 +157,9 @@
 gSpellbarShortMessages[1060167] =3D {r=3D0.0,g=3D0.5,b=3D0.0,txt=3D"bleeds=
top" 		} -- The bleeding wounds have healed, you are no longer bleeding!
 =

 --[[
+
+Hook_Packet_Localized_Text      4294967295      You begin to move quietly.=
      502730
+
 =

 Hook_Packet_Localized_Text      4294967295      You feel yourself resistin=
g magical energy.     501783
 Hook_Packet_Localized_Text      4294967295      You begin applying the ban=
dages.        500956



From no-reply at zwischenwelt.org  Fri Oct 24 18:48:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 16:48:32 -0000
Subject: [Iris-commit] [IRIS] r2646 - /trunk/lua/lib.debugmenu.lua
Message-ID: <20081024164832.8E9971C18451@zwischenwelt.org>

Author: hagish
Date: Fri Oct 24 18:48:30 2008
New Revision: 2646

Log:
bugfix: bg images overlaps debug

Modified:
    trunk/lua/lib.debugmenu.lua

Modified: trunk/lua/lib.debugmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.debugmenu.lua (original)
+++ trunk/lua/lib.debugmenu.lua Fri Oct 24 18:48:30 2008
@@ -684,7 +684,8 @@
 end
 =

 function StartDebugMenu ()
-
+	DestroyIfAlive(gMenuBgImage)
+	gMenuBgImage =3D nil
 =

 	if (false) then
 		gDebugMenuModelTable =3D {}



From no-reply at zwischenwelt.org  Fri Oct 24 20:31:08 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 18:31:08 -0000
Subject: [Iris-commit] [IRIS] r2647 - in /trunk: lua/gui/gui.helper.lua
 lua/lib.granny.lua lua/lib.sound.iris.lua lua/lib.tilefreewalk.lua
 lua/net/net.other.lua lua/net/net.sound.lua
 lua/widgets/widget.gumpdialog.lua plugins/lib.spellbar.lua
 plugins/moblist.lua
Message-ID: <20081024183108.65E2F1C18631@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 24 20:31:07 2008
New Revision: 2647

Log:
kPacket_Text_Entry and a few small adjustments

Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.granny.lua
    trunk/lua/lib.sound.iris.lua
    trunk/lua/lib.tilefreewalk.lua
    trunk/lua/net/net.other.lua
    trunk/lua/net/net.sound.lua
    trunk/lua/widgets/widget.gumpdialog.lua
    trunk/plugins/lib.spellbar.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Fri Oct 24 20:31:07 2008
@@ -101,6 +101,8 @@
 	=

 		if (gUnicodeTextEntryRequest) then =

 			Send_Unicode_Text_Entry(curtext) =

+		elseif (gPlaintextTextEntryRequest) then =

+			Send_Plain_Text_Entry(curtext) =

 		else
 			Send_UnicodeSpeech(curtext) =

 		end

Modified: trunk/lua/lib.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.granny.lua (original)
+++ trunk/lua/lib.granny.lua Fri Oct 24 20:31:07 2008
@@ -187,6 +187,7 @@
 end
 =

 function IsBodyIDHuman (bodyid) =

+	if (bodyid =3D=3D 987) then return true end -- gm
 	local modelinfo =3D GetGrannyModelInfo(bodyid)
 	return modelinfo and modelinfo.typeid =3D=3D kAnimTypeID_Human
 end

Modified: trunk/lua/lib.sound.iris.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.sound.iris.lua (original)
+++ trunk/lua/lib.sound.iris.lua Fri Oct 24 20:31:07 2008
@@ -3,11 +3,13 @@
 =

 -- same like lugre:SoundPlayEffect but written for UO specific sound.mul
 function SoundPlayEffect_UO (x,y,z,effect)
+	print("SoundPlayEffect_UO",x,y,z,effect,gSoundLoader,gUseEffect,gSoundSys=
tem)
 	if gSoundLoader then
 		if gUseEffect and gSoundSystem then
 			printdebug("sound",sprintf("SoundPlayEffect(%f,%f,%f,%i)\n",x,y,z,effec=
t))
 			FlushSoundEffects()
 			local e =3D CreateSoundSource3DFromEffect(gSoundSystem,gSoundLoader,x,y=
,z,effect)
+			print("soundcreated",e)
 			if e then
 				e.file =3D "uosound:"..effect
 				e:SetMinMaxDistance(50,100000)

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Fri Oct 24 20:31:07 2008
@@ -8,7 +8,7 @@
 kFreeWalkMouseSlowArea =3D 70
 kFreeWalkOptimizeTimeout =3D 100
  =

-kTileFreeTestMobile =3D {artid=3D400,hue=3D33780, content=3D{
+kTileFreeTestMobile =3D {artid=3D987,hue=3D33780, content=3D{ -- artid=3D4=
00:human 987=3Dgmrobe
 		{artid=3D3932,animid=3D631},{artid=3D7028},
 		{artid=3D5137,animid=3D529},{artid=3D9797,animid=3D682},
 		{artid=3D5140,animid=3D530},{artid=3D5136,animid=3D528},

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Fri Oct 24 20:31:07 2008
@@ -666,6 +666,38 @@
 	out:SendPacket()
 end
 =

+
+-- response =3D 0x9a as well
+function gPacketHandler.kPacket_Text_Entry () -- 0x9a =

+	local input =3D GetRecvFIFO()
+	local id	=3D input:PopNetUint8()	-- 1
+	local size	=3D input:PopNetUint16()	-- 2
+	local data =3D {}
+	data.player_serial		=3D input:PopNetUint32() -- pol:objectID
+	data.message_id			=3D input:PopNetUint32() -- pol:prompt#
+	data.reply				=3D input:PopNetUint32() -- pol:0=3Drequest/esc, 1=3Dreply
+	gPlaintextTextEntryRequest =3D data
+	size =3D size - 15
+	input:PopRaw(size) -- 10 zero-bytes usually
+end
+
+
+function Send_Plain_Text_Entry (text) =

+	local out =3D GetSendFIFO()
+	local textlen =3D string.len(text)
+	local size =3D 1 + 2 + 4 + 4 + 4 + textlen + 1
+	out:PushNetUint8(kPacket_Text_Entry)
+	out:PushNetUint16(size)
+	out:PushNetUint32(gPlaintextTextEntryRequest.player_serial)
+	out:PushNetUint32(gPlaintextTextEntryRequest.message_id)
+	out:PushNetUint32(1)
+	out:PushFilledString(text,textlen)
+	out:PushNetUint8(0) -- zero termination
+	gPlaintextTextEntryRequest =3D nil -- clear request
+	print("Send_Plain_Text_Entry",text)
+	out:SendPacket()
+end
+
 -- aka Cliloc Message Affix  : see also http://docs.polserver.com/packets/=
index.php?Packet=3D0xCC
 -- e.g. skilltrainer npc says how much gold he wants
 function gPacketHandler.kPacket_Localized_Text_Plus_String () -- 0xCC

Modified: trunk/lua/net/net.sound.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.sound.lua (original)
+++ trunk/lua/net/net.sound.lua Fri Oct 24 20:31:07 2008
@@ -10,7 +10,8 @@
 	local y =3D input:PopNetUint16()
 	local z =3D input:PopNetUint16()
 	printdebug("sound",sprintf("NET: kPacket_Sound: effect: %i singular: %i x=
: %i y: %i z: %i\n",effect,singular,x,y,z))
-	SoundPlayEffect_UO(x,y,z * 0.1,effect)
+	=

+	if (not gUseDisableUOSounds) then SoundPlayEffect_UO(x,y,z * 0.1,effect) =
end
 	=

 	gSoundCounter =3D gSoundCounter or {}
 	gSoundCounter[effect] =3D (gSoundCounter[effect] or 0) + 1

Modified: trunk/lua/widgets/widget.gumpdialog.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.gumpdialog.lua (original)
+++ trunk/lua/widgets/widget.gumpdialog.lua Fri Oct 24 20:31:07 2008
@@ -53,7 +53,10 @@
 		if (StringContains(gumpdata.Data,search)) then return true end
 	end
 	if (gumpdata.textline) then =

-		for k,line in pairs(gumpdata.textline) do print("GumpDialog:Search line"=
,search,line) if (StringContains(line,search)) then return true end end
+		for k,line in pairs(gumpdata.textline) do =

+			print("GumpDialog:Search line",search,line) =

+			if (StringContains(line,search)) then return true end =

+		end
 	end
 	if (gClilocLoader) then
 		for cliloc_id,v in pairs(self.usedClilocs) do

Modified: trunk/plugins/lib.spellbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/lib.spellbar.lua (original)
+++ trunk/plugins/lib.spellbar.lua Fri Oct 24 20:31:07 2008
@@ -148,6 +148,8 @@
 gSpellbarShortMessages[500118] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"skillwa=
it"		} -- You must wait a few moments to use another skill.  =

 gSpellbarShortMessages[500446] =3D {r=3D0.5,g=3D0.5,b=3D0.5,txt=3D"too far=
"			} -- That is too far away. =

  =

+gSpellbarShortMessages[1019043] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"!!shov=
e-invis!!" } -- Being perfectly rested, you shove something invisible out o=
f the way.
+
 gSpellbarShortMessages[501284] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"You may=
 not enter." } -- You may not enter.
 gSpellbarShortMessages[500111] =3D {r=3D0.5,g=3D0.0,b=3D0.0,txt=3D"frozen"=
 			} -- You are frozen and cannot move. =

 gSpellbarShortMessages[502381] =3D {r=3D1.0,g=3D0.0,b=3D0.0,txt=3D"cannot =
move!" 		} -- You cannot move!
@@ -158,6 +160,7 @@
 =

 --[[
 =

+Hook_Packet_Localized_Text      4294967295      Being perfectly rested, yo=
u shove them out of the way.  1019042
 Hook_Packet_Localized_Text      4294967295      You begin to move quietly.=
      502730
 =

 =


Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Fri Oct 24 20:31:07 2008
@@ -363,6 +363,7 @@
 =

 function gWidgetPrototype.UOMobListItem:SetCat (cat)
 	if (self.cat =3D=3D cat) then return end
+	if (cat =3D=3D kMobListCat_Players) then NotifyListener("Hook_Moblist_New=
Player",self.mobile,self.old_text) end
 	self.cat =3D cat
 	self.params.moblist.bNeedsReGroup =3D true
 	self:UpdateNameGfx()



From no-reply at zwischenwelt.org  Fri Oct 24 20:39:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 18:39:55 -0000
Subject: [Iris-commit] [IRIS] r2648 - in /trunk/lua:
	filter/filter.granny.lua lib.3d.dynamic.lua
Message-ID: <20081024183956.143911C18451@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 24 20:39:55 2008
New Revision: 2648

Log:
workaround for mongbat corpse

Modified:
    trunk/lua/filter/filter.granny.lua
    trunk/lua/lib.3d.dynamic.lua

Modified: trunk/lua/filter/filter.granny.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.granny.lua (original)
+++ trunk/lua/filter/filter.granny.lua Fri Oct 24 20:39:55 2008
@@ -37,9 +37,11 @@
 gGrannyFilter[778]	=3D{grannyid=3D16}
 gGrannyFilter[292]	=3D{grannyid=3D220}
 gGrannyFilter[970]	=3D{grannyid=3D402}
-gGrannyFilter[780]	=3D{grannyid=3D779}	-- a bog thing (too big scale)
-gGrannyFilter[311]	=3D{grannyid=3D310}	-- seg fault when loading (first on=
 uodemise/trantor)
+gGrannyFilter[780]	=3D{grannyid=3D779}	-- a bog thing (too big scale)   (7=
79=3Dplantman)
+gGrannyFilter[311]	=3D{grannyid=3D310}	-- seg fault when loading (first on=
 uodemise/trantor)   (310=3Dwitchwoman)
 =

+gGrannyCorpseFilter =3D {}
+gGrannyCorpseFilter[39] =3D {newid=3D779} -- (779=3Dplantman)
 --[[
 -- wrong animations - but raw model is displayed correct, so no animation =
should be played
 gGrannyFilter[46]	=3D{animbroken}	-- mf_dragon_rust ( Completely broken )

Modified: trunk/lua/lib.3d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.3d.dynamic.lua (original)
+++ trunk/lua/lib.3d.dynamic.lua Fri Oct 24 20:39:55 2008
@@ -289,6 +289,10 @@
 function Renderer3D:AddCorpseItem( item )
 	printdebug("corpse","AddDynamicItem corpse",item.amount)
 	local bodyid =3D item.amount
+	=

+	local filter =3D gGrannyCorpseFilter[bodyid]
+	if (filter and filter.newid) then bodyid =3D filter.newid end
+	=

 	local hue =3D item.hue
 	local equip =3D {}
 	local bMoving,bTurning,bWarMode,bRunFlag =3D false,false,false,false



From no-reply at zwischenwelt.org  Fri Oct 24 22:20:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 20:20:42 -0000
Subject: [Iris-commit] [IRIS] r2649 - in /trunk: lua/lib.2d.mobile.lua
 lua/obj/obj.mobile.lua plugins/loot.lua
Message-ID: <20081024202043.1988B1C18631@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 24 22:20:42 2008
New Revision: 2649

Log:
mobile equipment change (humans) : tooltips for equipment are automatically=
 requested if not already available, 2d : mobile anims use direction-run fl=
ag, lootplugin : added support for gargoyle tools

Modified:
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/obj/obj.mobile.lua
    trunk/plugins/loot.lua

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Fri Oct 24 22:20:42 2008
@@ -73,7 +73,7 @@
 	local mount	=3D mobile:GetEquipmentAtLayer(kLayer_Mount)
 	=

 	local fTimeSinceLastMove =3D gMyTicks - (mobile.r2d_lastmoved or 0)
-	local bRun =3D true
+	local bRun =3D TestBit(mobile.dir or 0,0x80)
 	local iMoveInterval =3D WalkGetIntervalEx(mount,mobile.artid,bRun)
 	local bMoving =3D fTimeSinceLastMove <=3D iMoveInterval + 50
 	self.gStepMobiles[mobile] =3D bMoving and (gMyTicks + 10) or (gMyTicks + =
500)

Modified: trunk/lua/obj/obj.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/obj/obj.mobile.lua (original)
+++ trunk/lua/obj/obj.mobile.lua Fri Oct 24 22:20:42 2008
@@ -214,7 +214,8 @@
 	if (self.bEquipmentChanged) then
 		self.bEquipmentChanged =3D false
 		NotifyListener("Hook_MobileEquipmentChanged",self)
-		if (bIsPlayer) then PlayerBackpackItemUpdated() self:RequestEquipToolTip=
s() end
+		if (bIsPlayer) then PlayerBackpackItemUpdated() end
+		self:RequestEquipToolTips()
 		local paperdoll =3D gPaperdolls[self.serial]
 		if (paperdoll) then RebuildPaperdoll(paperdoll) end
 		=


Modified: trunk/plugins/loot.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/loot.lua (original)
+++ trunk/plugins/loot.lua Fri Oct 24 22:20:42 2008
@@ -8,6 +8,17 @@
 kLootArtID_Gold =3D 3823
 kLoot_GoldWeight =3D 20/1000 -- 1000gold =3D 20 stones
 -- artid=3D3791,3794,...(not corpse-art-id) : bones after animate undead
+
+
+function LootEvaluateItem (item)
+	if (item.artid =3D=3D 5110 and item.hue =3D=3D 2419) then return true end=
 -- gargy knife
+	if (item.artid =3D=3D 3718 and item.hue =3D=3D 2419) then return true end=
 -- gargy pickaxe
+	if (item.artid =3D=3D 3909 and item.hue =3D=3D 2419) then return true end=
 -- gargy axe
+end
+
+
+
+
 =

 gLootFinishedCorpses =3D {}
 =

@@ -25,7 +36,6 @@
 	gAutoLoot =3D not gAutoLoot
 	SpellBarRiseTextOnMob(GetPlayerSerial(),0,1,0,"autoloot:"..(gAutoLoot and=
 "ON" or "off"))
 end
-
 =

 =

 function FindNearbyCorpse (maxdist)
@@ -92,8 +102,15 @@
 	local container =3D GetContainer(serial)
 	if (not container) then return end
 	if (container.gumpid ~=3D kCorpseContainerGumpID) then return end
+	local takeitem
 	for k,item in pairs(container:GetContent()) do =

-		if (item.artid =3D=3D kLootArtID_Gold) then
+		if (item.artid =3D=3D kLootArtID_Gold and (not gDisableLootGold) and (no=
t takeitem)) then takeitem =3D item end
+		if (LootEvaluateItem(item)) then takeitem =3D item end
+	end
+	=

+	if (takeitem) then
+		local item =3D takeitem
+		if (takeitem =3D=3D kLootArtID_Gold) then
 			local curw,maxw =3D GetPlayerWeight()
 			local w =3D ceil(item.amount * kLoot_GoldWeight)
 			if (curw and maxw and curw + w > maxw) then
@@ -107,9 +124,12 @@
 				Send_Take_Object(item.serial,item.amount)
 				Send_Drop_Object_AutoStack(item.serial,GetPlayerBackPackSerial())
 			end
-			break
+		else =

+			SpellBarRiseTextOnMob(GetPlayerSerial(),1,0.5,0,GetStaticTileTypeName(i=
tem.artid) or "???")
+			Send_Take_Object(item.serial,item.amount)
+			Send_Drop_Object_AutoStack(item.serial,GetPlayerBackPackSerial())
 		end
-	end
+	end =

 	LootCleanup()
 end)
 =




From no-reply at zwischenwelt.org  Fri Oct 24 23:11:18 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 21:11:18 -0000
Subject: [Iris-commit] [IRIS] r2650 - in /trunk/lua: lib.2d.hudfx.lua
 lib.2d.mobile.lua lib.2d.renderer.lua
Message-ID: <20081024211118.56DD11C18631@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 24 23:11:17 2008
New Revision: 2650

Log:
2d : smoothwalk

Modified:
    trunk/lua/lib.2d.hudfx.lua
    trunk/lua/lib.2d.mobile.lua
    trunk/lua/lib.2d.renderer.lua

Modified: trunk/lua/lib.2d.hudfx.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.hudfx.lua (original)
+++ trunk/lua/lib.2d.hudfx.lua Fri Oct 24 23:11:17 2008
@@ -29,7 +29,8 @@
 	if (t > hudfx.endt) then self:HUDFX_Destroy(hudfx) return end
 	if (hudfx.mob and hudfx.gfx) then
 		local mobile =3D hudfx.mob
-		local px,py =3D self:UOPosToPixelPos(mobile.xloc,mobile.yloc,mobile.zloc=
+hudfx.zadd)
+		local xloc,yloc,zloc =3D self:GetExactMobilePos(mobile)
+		local px,py =3D self:UOPosToPixelPos(xloc,yloc,zloc+hudfx.zadd)
 		if (px) then =

 			local dur =3D hudfx.dur
 			local ft =3D min(dur,t - hudfx.startt) / dur

Modified: trunk/lua/lib.2d.mobile.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.mobile.lua (original)
+++ trunk/lua/lib.2d.mobile.lua Fri Oct 24 23:11:17 2008
@@ -2,6 +2,7 @@
 -- TODO : Equipconv.def ?
 =

 Renderer2D.gStepMobiles =3D {}
+Renderer2D.gStepMobilesSmoothWalk =3D {}
 =

 -- main updater, create, position ...
 function Renderer2D:MobileSetVisible			(mobile,bVisible) =

@@ -15,13 +16,59 @@
 		mobile.gfx2d =3D spriteblock
 	end
 	if (mobile.xloc ~=3D mobile.r2d_lastxloc or
-		mobile.yloc ~=3D mobile.r2d_lastyloc) then
-		mobile.r2d_lastxloc =3D mobile.xloc
-		mobile.r2d_lastyloc =3D mobile.yloc
+		mobile.yloc ~=3D mobile.r2d_lastyloc or
+		mobile.zloc ~=3D mobile.r2d_lastzloc) then
+		mobile.r2d_lastxloc2 =3D mobile.r2d_lastxloc
+		mobile.r2d_lastyloc2 =3D mobile.r2d_lastyloc
+		mobile.r2d_lastzloc2 =3D mobile.r2d_lastzloc
+		mobile.r2d_lastxloc  =3D mobile.xloc
+		mobile.r2d_lastyloc  =3D mobile.yloc
+		mobile.r2d_lastzloc  =3D mobile.zloc
 		mobile.r2d_lastmoved =3D gMyTicks
+		mobile.r2d_iMoveInterval =3D WalkGetIntervalEx(mobile:GetEquipmentAtLaye=
r(kLayer_Mount),mobile.artid,TestBit(mobile.dir or 0,0x80))
+		local bSmoothWalk =3D mobile.r2d_lastxloc2 and dist2(	mobile.r2d_lastxlo=
c2,
+															mobile.r2d_lastyloc2,
+															mobile.r2d_lastxloc,
+															mobile.r2d_lastyloc) <=3D 2
+		mobile.r2d_bSmoothWalk =3D bSmoothWalk
+		self.gStepMobilesSmoothWalk[mobile] =3D bSmoothWalk or nil
 	end
 	self:UpdateMobileGfx(mobile)
-end =

+end
+
+
+
+function Renderer2D:GetExactMobilePos (mobile)
+	if (not mobile) then return end
+	if (mobile.gfx2d and mobile.gfx2d.exactxloc) then
+		return	mobile.gfx2d.exactxloc,
+				mobile.gfx2d.exactyloc,
+				mobile.gfx2d.exactzloc
+	end
+	return	mobile.xloc,
+			mobile.yloc,
+			mobile.zloc
+end
+
+function Renderer2D:UpdateMobilePos			(mobile) =

+	if (not mobile.gfx2d) then return end
+	local xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
+	local t
+	if (mobile.r2d_bSmoothWalk) then
+		t =3D (gMyTicks - mobile.r2d_lastmoved) / mobile.r2d_iMoveInterval
+		if (t >=3D 1) then t =3D 1 self.gStepMobilesSmoothWalk[mobile] =3D nil e=
nd
+		local it =3D 1 - t
+		xloc =3D mobile.r2d_lastxloc2*it + xloc*t
+		yloc =3D mobile.r2d_lastyloc2*it + yloc*t
+		zloc =3D mobile.r2d_lastzloc2*it + zloc*t
+	end    =

+	--~ print("UpdateMobilePos",t)
+	mobile.gfx2d.exactxloc =3D xloc
+	mobile.gfx2d.exactyloc =3D yloc
+	mobile.gfx2d.exactzloc =3D zloc
+	local x,y,z =3D self:UOPosToLocal(xloc,yloc,zloc*kRenderer2D_ZScale)
+	mobile.gfx2d:SetPosition(x,y,z)
+end
 =

 function Renderer2D:MobileStepOne(mobile)
 	self:UpdateMobileGfx(mobile)
@@ -74,8 +121,7 @@
 	=

 	local fTimeSinceLastMove =3D gMyTicks - (mobile.r2d_lastmoved or 0)
 	local bRun =3D TestBit(mobile.dir or 0,0x80)
-	local iMoveInterval =3D WalkGetIntervalEx(mount,mobile.artid,bRun)
-	local bMoving =3D fTimeSinceLastMove <=3D iMoveInterval + 50
+	local bMoving =3D fTimeSinceLastMove <=3D (mobile.r2d_iMoveInterval or 20=
0) + 50
 	self.gStepMobiles[mobile] =3D bMoving and (gMyTicks + 10) or (gMyTicks + =
500)
 =

 	local xloc,yloc,zloc =3D mobile.xloc,mobile.yloc,mobile.zloc
@@ -131,14 +177,13 @@
 		end
 	end
 	spriteblock:Build(Renderer2D.kSpriteBaseMaterial,false)
-	=

-	local x,y,z =3D self:UOPosToLocal(mobile.xloc,mobile.yloc,mobile.zloc*kRe=
nderer2D_ZScale)
-	mobile.gfx2d:SetPosition(x,y,z)
+	self:UpdateMobilePos(mobile)
 end
 =

 function Renderer2D:DestroyMobileGfx			(mobile) =

 	if (mobile.gfx2d) then mobile.gfx2d:Destroy() mobile.gfx2d =3D nil end
 	self.gStepMobiles[mobile] =3D nil
+	self.gStepMobilesSmoothWalk[mobile] =3D nil
 end
 =

 function Renderer2D:CreateMobileGfx				(mobile) self:UpdateMobile(mobile) =
end	=

@@ -154,6 +199,7 @@
 	for mobile,t in pairs(self.gStepMobiles) do =

 		if (curt >=3D t) then self:MobileStepOne(mobile) end
 	end
+	for mobile,v in pairs(self.gStepMobilesSmoothWalk) do self:UpdateMobilePo=
s(mobile) end
 	=

 	--~ local playermobile =3D GetPlayerMobile()
 	--~ print("playermobile.dir",playermobile and DirWrap(playermobile.dir)) =


Modified: trunk/lua/lib.2d.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.renderer.lua (original)
+++ trunk/lua/lib.2d.renderer.lua Fri Oct 24 23:11:17 2008
@@ -118,8 +118,11 @@
 	end
 	=

 	-- TODO : self:CombatGuiStep() ?
+	self:MobileStep() -- bevore cam pos so cam is exactly on player
 	local xloc,yloc,zloc =3D GetPlayerPos()
-	if (xloc and (not g2DCamMove)) then self:SetCamPos(xloc,yloc,zloc) end
+	if (xloc and (not g2DCamMove)) then =

+		self:SetCamPos(self:GetExactMobilePos(GetPlayerMobile())) -- after Mobil=
eStep so cam is exactly on player
+	end
 	=

 	-- keyboard move cam
 	local bKeyBoardMoveCam =3D g2DCamMove or bOfflineMode
@@ -135,7 +138,6 @@
 =

 	self:EffectAnimStep() -- should be after player pos is updated, for effec=
ts moving with player
 	self:MapStep()
-	self:MobileStep()
 	self:HUDFX_MainStep()
 	self:Dynamics_MainStep()
 	self:MousePickStep()



From no-reply at zwischenwelt.org  Sat Oct 25 00:13:44 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 24 Oct 2008 22:13:44 -0000
Subject: [Iris-commit] [IRIS] r2651 - /trunk/lua/lib.2d.cam.lua
Message-ID: <20081024221344.C26911C1844F@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 25 00:13:44 2008
New Revision: 2651

Log:
fix for packetvideo

Modified:
    trunk/lua/lib.2d.cam.lua

Modified: trunk/lua/lib.2d.cam.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.cam.lua (original)
+++ trunk/lua/lib.2d.cam.lua Sat Oct 25 00:13:44 2008
@@ -96,6 +96,7 @@
 function Renderer2D:GetCamPos () return self.fCamPosXLoc,self.fCamPosYLoc,=
self.fCamPosZLoc end
 =

 function Renderer2D:SetCamPos (xloc,yloc,zloc)
+	if (not xloc) then return end
 	self.fCamPosXLoc =3D xloc
 	self.fCamPosYLoc =3D yloc
 	self.fCamPosZLoc =3D zloc or 0



From no-reply at zwischenwelt.org  Sat Oct 25 02:58:31 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 25 Oct 2008 00:58:31 -0000
Subject: [Iris-commit] [IRIS] r2652 - in /trunk: INSTALL lua/lib.unifont.lua
Message-ID: <20081025005832.1A4221C185FF@zwischenwelt.org>

Author: ghoulsblade
Date: Sat Oct 25 02:58:31 2008
New Revision: 2652

Log:
fontdump option for debug, added a few notes to INSTALL

Modified:
    trunk/INSTALL
    trunk/lua/lib.unifont.lua

Modified: trunk/INSTALL
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/INSTALL (original)
+++ trunk/INSTALL Sat Oct 25 02:58:31 2008
@@ -1,3 +1,8 @@
+the info in here might be obsolete, see also http://iris2.de/index.php/Bui=
lding_From_Source
+
+
+
+
 =3D=3D linux binary =3D=3D
 many thanks to aliverius for providing a linux binary for iris !
 =

@@ -24,10 +29,17 @@
 to start the compiled executable run
 ./start.sh 				in main directory =

 	=

+=3D=3D=3D to use ogre 1.6.* (shoggoth) instead of 1.4.* =3D=3D=3D
+   * in lugre folder: patch -p0 < patches/shoggoth.patch
+   * in data folder: patch -p0 < shoggoth_patch
+   =

+   =

 =3D=3D=3D linux cmake =3D=3D=3D
 =

 ./cmake.sh
 thanks to btbn ( btbn { at } btbn dotty de ) for setting this up =3D)
+
+
 =

 =

 =


Modified: trunk/lua/lib.unifont.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.unifont.lua (original)
+++ trunk/lua/lib.unifont.lua Sat Oct 25 02:58:31 2008
@@ -75,6 +75,8 @@
 		gUniFontLastTextureAtlas.texname =3D gUniFontLastTextureAtlas:MakeTextur=
e() -- generate new texture
 		gUniFontLastTextureAtlas.matname =3D GetPlainTextureGUIMat(gUniFontLastT=
extureAtlas.texname)
 	end
+	=

+	if (gUODumpFontImage) then local img =3D LoadImageFromTexture(GetTexture(=
gUniFontLastTextureAtlas.matname)) img:SaveAsFile("../font_"..gUniFontLastT=
extureAtlas.matname..".png") end
 	=

 	-- return info about the allocated area for this glyph
 	return gUniFontLastTextureAtlas.matname,l,t,r,b



From no-reply at zwischenwelt.org  Sat Oct 25 15:00:15 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 25 Oct 2008 13:00:15 -0000
Subject: [Iris-commit] [IRIS] r2653 - in /trunk: lua/config_declarations.lua
 lua/gui/gui.helper.lua lua/main.lua scripts/stats.gnuplot
Message-ID: <20081025130016.248611C18476@zwischenwelt.org>

Author: hagish
Date: Sat Oct 25 15:00:14 2008
New Revision: 2653

Log:
its possible to log statistics into a file. to enable this you need to put

gConfig:Set("gLogStatsToFile",true)

into your config.lua file.
if you have gnuplot and imagemagick installed (linux) you can view the stat=
s as a plot with this macro

SetMacro("ctrl+p",	function() =

	os.execute("gnuplot < ../scripts/stats.gnuplot")
end)	-- display stats


Added:
    trunk/scripts/stats.gnuplot
Modified:
    trunk/lua/config_declarations.lua
    trunk/lua/gui/gui.helper.lua
    trunk/lua/main.lua

Modified: trunk/lua/config_declarations.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/config_declarations.lua (original)
+++ trunk/lua/config_declarations.lua Sat Oct 25 15:00:14 2008
@@ -477,10 +477,11 @@
 gConfig:DeclareBoolean("gIgnoreGlobalLightLevel", "gfx", "ignore global li=
ght", 'if this is true the world is always day bright', false)
 =

 gConfig:DeclareBoolean("gUseWaterShader", "gfx", "water shader", 'TODO', f=
alse)
+gConfig:DeclareBoolean("gWaterAsGroundTiles", "gfx", "water as ground tile=
s", 'TODO', false)
 =

 gConfig:DeclareBoolean("gShowHealthBarOverEveryMobile", "gui", "healthbar =
over mobile", 'TODO', false)
 =

-
+gConfig:DeclareBoolean("gLogStatsToFile", "debug", "log stats to file", 'd=
umps statistical informations into stats.dat', false)
 =

 =

 -- port me to new config system ! (or extend system for complex stuff)

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Sat Oct 25 15:00:14 2008
@@ -33,14 +33,45 @@
 	gLoadingStateIcon.spritepanel:Update(MakeSpritePanelParam_Mod_AnimSimple(=
w,h,tilew,tileh,f))
 end
 =

+function DisplayMemoryUsageFormatHelper(x)
+	x =3D x or 0
+	if x > 1024*1024 then
+		return sprintf("%0.1fmb",x/1024/1024)
+	elseif x > 1024 then
+		return sprintf("%0.1fkb",x/1024)
+	else =

+		return x.."b"
+	end
+end
+
 gMemStats_NextUpdate =3D 0
 function DisplayMemoryUsage (memoryusage)
 	if (gHideMemoryUsage) then return end
 	if (gMyTicks > gMemStats_NextUpdate) then
 		gMemStats_NextUpdate =3D gMyTicks + 1000
-		local mem_dyn =3D gcinfo()
-		mem_dyn =3D mem_dyn or 0
-		local text =3D sprintf("%5.1ffps %0.1fmb %dt %db OGRE | %0.fmb LUA | %i =
j %i l",OgreAvgFPS(),memoryusage / 1024 / 1024, OgreTriangleCount(), OgreBa=
tchCount(), mem_dyn / 1024, job.count(), giShowLoading)
+		=

+		local mem_dyn =3D gcinfo() or 0
+		local b =3D OgreBatchCount()
+		local t =3D OgreTriangleCount()
+		local j =3D job.count()
+		local l =3D giShowLoading
+		local fps =3D OgreAvgFPS()
+		=

+		if gConfig:Get("gLogStatsToFile") then
+			-- write to file
+			local fp =3D io.open("stats.dat","a")
+			if (fp) then
+				fp:write(gMyTicks.."\t"..fps.."\t"..b.."\t"..t.."\t"..memoryusage.."\t=
"..mem_dyn.."\t"..j.."\t"..l.."\n")
+				fp:close()
+			end
+		end
+					=

+		local text =3D sprintf("%5.1ffps %dt %db gfx | %s OGRE %s LUA mem | %i j=
 %i l",
+			fps, t, b, =

+			DisplayMemoryUsageFormatHelper(memoryusage),
+			DisplayMemoryUsageFormatHelper(mem_dyn), =

+			j, l
+		)
 		if (not gMemoryUsageField) then
 			local vw,vh =3D GetViewportSize()
 			local w,h =3D 0,12

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Sat Oct 25 15:00:14 2008
@@ -375,6 +375,10 @@
 	=

 	if (gCommandLineSwitches["-fonttest"]) then FontTest() end
 =

+	if gConfig:Get("gLogStatsToFile") then
+		os.remove("stats.dat")
+	end
+
 	-- mainloop
 	while (Client_IsAlive()) do =

 		MainStep() =




From no-reply at zwischenwelt.org  Sat Oct 25 16:21:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 25 Oct 2008 14:21:42 -0000
Subject: [Iris-commit] [IRIS] r2654 - in /trunk: lua/gui/gui.helper.lua
 scripts/stats.gnuplot scripts/stats_ogre.gnuplot
Message-ID: <20081025142142.6FBD61C18476@zwischenwelt.org>

Author: hagish
Date: Sat Oct 25 16:21:41 2008
New Revision: 2654

Log:
extended ogre stats

Added:
    trunk/scripts/stats_ogre.gnuplot
Modified:
    trunk/lua/gui/gui.helper.lua
    trunk/scripts/stats.gnuplot

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Sat Oct 25 16:21:41 2008
@@ -50,18 +50,39 @@
 	if (gMyTicks > gMemStats_NextUpdate) then
 		gMemStats_NextUpdate =3D gMyTicks + 1000
 		=

-		local mem_dyn =3D gcinfo() or 0
+		local mem_dyn =3D (collectgarbage("count") or 0) * 1024
 		local b =3D OgreBatchCount()
 		local t =3D OgreTriangleCount()
 		local j =3D job.count()
 		local l =3D giShowLoading
 		local fps =3D OgreAvgFPS()
-		=

+	=

 		if gConfig:Get("gLogStatsToFile") then
 			-- write to file
 			local fp =3D io.open("stats.dat","a")
 			if (fp) then
-				fp:write(gMyTicks.."\t"..fps.."\t"..b.."\t"..t.."\t"..memoryusage.."\t=
"..mem_dyn.."\t"..j.."\t"..l.."\n")
+				fp:write(
+					-- 0
+					gMyTicks.."\t"..
+					fps.."\t"..
+					b.."\t"..
+					t.."\t"..
+					memoryusage.."\t"..
+					-- 5
+					mem_dyn.."\t"..
+					j.."\t"..
+					l.."\t"..
+					OgreMemoryUsage("compositor").."\t"..
+					OgreMemoryUsage("font").."\t"..
+					-- 10
+					OgreMemoryUsage("gpuprogram").."\t"..
+					OgreMemoryUsage("highlevelgpuprogram").."\t"..
+					OgreMemoryUsage("material").."\t"..
+					OgreMemoryUsage("mesh").."\t"..
+					OgreMemoryUsage("skeleton").."\t"..
+					-- 15
+					OgreMemoryUsage("texture").."\n"
+				)
 				fp:close()
 			end
 		end

Modified: trunk/scripts/stats.gnuplot
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/scripts/stats.gnuplot (original)
+++ trunk/scripts/stats.gnuplot Sat Oct 25 16:21:41 2008
@@ -13,7 +13,7 @@
 set grid x y
 set lmargin 10.
 =

-set multiplot layout 7,1 scale 0.9,1.1
+set multiplot layout 7,1 scale 1,1
 =

 plot "stats.dat" using 2 with lines title "fps"
 plot "stats.dat" using 3 with lines title "batches"



From no-reply at zwischenwelt.org  Sun Oct 26 00:37:46 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sat, 25 Oct 2008 22:37:46 -0000
Subject: [Iris-commit] [IRIS] r2655 - /trunk/lua/lib.tilefreewalk.lua
Message-ID: <20081025223746.89EB61C18476@zwischenwelt.org>

Author: ghoulsblade
Date: Sun Oct 26 00:37:45 2008
New Revision: 2655

Log:
fixed offline anim, accidentally changed for debug

Modified:
    trunk/lua/lib.tilefreewalk.lua

Modified: trunk/lua/lib.tilefreewalk.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.tilefreewalk.lua (original)
+++ trunk/lua/lib.tilefreewalk.lua Sun Oct 26 00:37:45 2008
@@ -8,7 +8,7 @@
 kFreeWalkMouseSlowArea =3D 70
 kFreeWalkOptimizeTimeout =3D 100
  =

-kTileFreeTestMobile =3D {artid=3D987,hue=3D33780, content=3D{ -- artid=3D4=
00:human 987=3Dgmrobe
+kTileFreeTestMobile =3D {artid=3D400,hue=3D33780, content=3D{ -- artid=3D4=
00:human 987=3Dgmrobe
 		{artid=3D3932,animid=3D631},{artid=3D7028},
 		{artid=3D5137,animid=3D529},{artid=3D9797,animid=3D682},
 		{artid=3D5140,animid=3D530},{artid=3D5136,animid=3D528},



From no-reply at zwischenwelt.org  Sun Oct 26 19:21:19 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Sun, 26 Oct 2008 18:21:19 -0000
Subject: [Iris-commit] [IRIS] r2656 - /trunk/lua/filter/filter.art.lua
Message-ID: <20081026182119.A338D1C1855D@zwischenwelt.org>

Author: hagish
Date: Sun Oct 26 19:21:18 2008
New Revision: 2656

Log:
bugfix: wrong translation of roof parts

Modified:
    trunk/lua/filter/filter.art.lua

Modified: trunk/lua/filter/filter.art.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/filter/filter.art.lua (original)
+++ trunk/lua/filter/filter.art.lua Sun Oct 26 19:21:18 2008
@@ -83,44 +83,44 @@
 gArtFilter[3345]=3D{maptoid=3D3341,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 =

 -- ceramic roof blue
-gArtFilter[9157]=3D{maptoid=3D9155,rotation=3D"x:0,y:0,z:-180",xadd=3D-1,y=
add=3D1,zadd=3D0}
-gArtFilter[9153]=3D{maptoid=3D9155,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,ya=
dd=3D0,zadd=3D0}
+gArtFilter[9157]=3D{maptoid=3D9155,rotation=3D"x:0,y:0,z:-180",xadd=3D1,ya=
dd=3D1,zadd=3D0}
+gArtFilter[9153]=3D{maptoid=3D9155,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
 gArtFilter[9159]=3D{maptoid=3D9155,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 =

-gArtFilter[9158]=3D{maptoid=3D9156,rotation=3D"x:0,y:0,z:-180",xadd=3D-1,y=
add=3D1,zadd=3D0}
-gArtFilter[9154]=3D{maptoid=3D9156,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,ya=
dd=3D0,zadd=3D0}
+gArtFilter[9158]=3D{maptoid=3D9156,rotation=3D"x:0,y:0,z:-180",xadd=3D1,ya=
dd=3D1,zadd=3D0}
+gArtFilter[9154]=3D{maptoid=3D9156,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
 gArtFilter[9160]=3D{maptoid=3D9156,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 =

 gArtFilter[9161]=3D{maptoid=3D9163,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
-gArtFilter[9165]=3D{maptoid=3D9163,rotation=3D"x:0,y:0,z:-180",xadd=3D-1,y=
add=3D1,zadd=3D0}
-gArtFilter[9167]=3D{maptoid=3D9163,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,ya=
dd=3D0,zadd=3D0}
+gArtFilter[9165]=3D{maptoid=3D9163,rotation=3D"x:0,y:0,z:-180",xadd=3D1,ya=
dd=3D1,zadd=3D0}
+gArtFilter[9167]=3D{maptoid=3D9163,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
 =

 gArtFilter[9162]=3D{maptoid=3D9164,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
-gArtFilter[9166]=3D{maptoid=3D9164,rotation=3D"x:0,y:0,z:180",xadd=3D-1,ya=
dd=3D1,zadd=3D0}
-gArtFilter[9168]=3D{maptoid=3D9164,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,ya=
dd=3D0,zadd=3D0}
-
-gArtFilter[9171]=3D{maptoid=3D9170,rotation=3D"x:0,y:0,z:180",xadd=3D-1,ya=
dd=3D1,zadd=3D0}
+gArtFilter[9166]=3D{maptoid=3D9164,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
+gArtFilter[9168]=3D{maptoid=3D9164,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
+
+gArtFilter[9171]=3D{maptoid=3D9170,rotation=3D"x:0,y:0,z:180",xadd=3D1,yad=
d=3D1,zadd=3D0}
 =

 gArtFilter[9152]=3D{maptoid=3D9170,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
-gArtFilter[9151]=3D{maptoid=3D9170,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,ya=
dd=3D0,zadd=3D0}
+gArtFilter[9151]=3D{maptoid=3D9170,rotation=3D"x:0,y:0,z:-90",xadd=3D1,yad=
d=3D0,zadd=3D0}
 gArtFilter[9150]=3D{maptoid=3D9169,rotation=3D"x:0,y:0,z:90",xadd=3D0,yadd=
=3D1,zadd=3D0}
 =

 -- ceramic roof yellow
-gArtFilter[10491]=3D{maptoid=3D10489,rotation=3D"x:0,y:0,z:-180",xadd=3D-1=
,yadd=3D1,zadd=3D0}
-gArtFilter[10487]=3D{maptoid=3D10489,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,=
yadd=3D0,zadd=3D0}
+gArtFilter[10491]=3D{maptoid=3D10489,rotation=3D"x:0,y:0,z:-180",xadd=3D1,=
yadd=3D1,zadd=3D0}
+gArtFilter[10487]=3D{maptoid=3D10489,rotation=3D"x:0,y:0,z:-90",xadd=3D1,y=
add=3D0,zadd=3D0}
 gArtFilter[10493]=3D{maptoid=3D10489,rotation=3D"x:0,y:0,z:90",xadd=3D0,ya=
dd=3D1,zadd=3D0}
 =

-gArtFilter[10490]=3D{maptoid=3D10488,rotation=3D"x:0,y:0,z:-180",xadd=3D-1=
,yadd=3D1,zadd=3D0}
-gArtFilter[10486]=3D{maptoid=3D10488,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,=
yadd=3D0,zadd=3D0}
+gArtFilter[10490]=3D{maptoid=3D10488,rotation=3D"x:0,y:0,z:-180",xadd=3D1,=
yadd=3D1,zadd=3D0}
+gArtFilter[10486]=3D{maptoid=3D10488,rotation=3D"x:0,y:0,z:-90",xadd=3D1,y=
add=3D0,zadd=3D0}
 gArtFilter[10492]=3D{maptoid=3D10488,rotation=3D"x:0,y:0,z:90",xadd=3D0,ya=
dd=3D1,zadd=3D0}
 =

 gArtFilter[10495]=3D{maptoid=3D10497,rotation=3D"x:0,y:0,z:90",xadd=3D0,ya=
dd=3D1,zadd=3D0}
-gArtFilter[10499]=3D{maptoid=3D10497,rotation=3D"x:0,y:0,z:180",xadd=3D-1,=
yadd=3D1,zadd=3D0}
-gArtFilter[10501]=3D{maptoid=3D10497,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,=
yadd=3D0,zadd=3D0}
+gArtFilter[10499]=3D{maptoid=3D10497,rotation=3D"x:0,y:0,z:180",xadd=3D1,y=
add=3D1,zadd=3D0}
+gArtFilter[10501]=3D{maptoid=3D10497,rotation=3D"x:0,y:0,z:-90",xadd=3D1,y=
add=3D0,zadd=3D0}
 =

 gArtFilter[10494]=3D{maptoid=3D10496,rotation=3D"x:0,y:0,z:90",xadd=3D0,ya=
dd=3D1,zadd=3D0}
-gArtFilter[10498]=3D{maptoid=3D10496,rotation=3D"x:0,y:0,z:-180",xadd=3D-1=
,yadd=3D1,zadd=3D0}
-gArtFilter[10500]=3D{maptoid=3D10496,rotation=3D"x:0,y:0,z:-90",xadd=3D-1,=
yadd=3D0,zadd=3D0}
+gArtFilter[10498]=3D{maptoid=3D10496,rotation=3D"x:0,y:0,z:-180",xadd=3D1,=
yadd=3D1,zadd=3D0}
+gArtFilter[10500]=3D{maptoid=3D10496,rotation=3D"x:0,y:0,z:-90",xadd=3D1,y=
add=3D0,zadd=3D0}
 =

 =

 -- stained glass windows brock wall stuff



From no-reply at zwischenwelt.org  Mon Oct 27 02:25:50 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 27 Oct 2008 01:25:50 -0000
Subject: [Iris-commit] [IRIS] r2658 - in /trunk: lua/lib.charcreate.lua
 lua/lib.mainmenu.lua lua/lib.uoids.lua lua/net/net.login.lua
 obsolete.startbinary.sh startbinary.sh
Message-ID: <20081027012551.128441C1855D@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 27 02:25:49 2008
New Revision: 2658

Log:
skillchecks, charcreate hook ...

Added:
    trunk/obsolete.startbinary.sh
      - copied unchanged from r2657, trunk/startbinary.sh
Removed:
    trunk/startbinary.sh
Modified:
    trunk/lua/lib.charcreate.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/net/net.login.lua

Modified: trunk/lua/lib.charcreate.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.charcreate.lua (original)
+++ trunk/lua/lib.charcreate.lua Mon Oct 27 02:25:49 2008
@@ -26,7 +26,7 @@
 	chardata.str =3D template.stats["Str"]
 	chardata.dex =3D template.stats["Dex"]
 	chardata.int =3D template.stats["Int"]
-
+	if (MyCharCreateHack) then MyCharCreateHack(chardata) end
 	Send_CharCreate(chardata)
 	return true
 end

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Mon Oct 27 02:25:49 2008
@@ -63,7 +63,7 @@
 		{	{type=3D"Label",		text=3D"Character Creation"} },
 		=

 		{	{type=3D"Label",		text=3D"Name:"},
-			{type=3D"EditText",	w=3D300,h=3D16,text=3D"IrisTestChar",controlname=3D=
"nameinput"}  },
+			{type=3D"EditText",	w=3D300,h=3D16,text=3D"",controlname=3D"nameinput"}=
  }, -- "IrisTestChar"
 			=

 		{	{type=3D"Button",onLeftClick=3DMyCreateChar,chartemplate=3Dtemplate,ch=
arslot=3Dslot,text=3D"Create Character"},
 			{type=3D"Label",	text=3D"(iris does not support all the options for cha=
r creation yet,\n"..
@@ -280,7 +280,7 @@
 	local autologin_charname
 	if (gCommandLineSwitches["-co"]) then autologin_charname =3D gCommandLine=
Arguments[gCommandLineSwitches["-co"]+2] end -- autologin
 	for k,v in pairs(charlist.chars) do if (v.name ~=3D "") then
-		if (v.name =3D=3D autologin_charname) then =

+		if (v.name =3D=3D autologin_charname or autologin_charname =3D=3D "1") t=
hen =

 			local iCharNum =3D k
 			Send_Character_Select(iCharNum,gGameServerAccount)
 			gSelectedCharName =3D v.name

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Mon Oct 27 02:25:49 2008
@@ -293,14 +293,14 @@
 gCharCreateSkillIDs["Lumberjacking"]			=3D 44
 gCharCreateSkillIDs["Mining"]					=3D 45
 gCharCreateSkillIDs["Meditation"]				=3D 46
-gCharCreateSkillIDs["Stealth"]					=3D 47
-gCharCreateSkillIDs["Remove Trap"]				=3D 48
+gCharCreateSkillIDs["Stealth"]					=3D 47 -- not possible to set > 0 at ch=
arcreate !!!!
+gCharCreateSkillIDs["Remove Trap"]				=3D 48 -- not possible to set > 0 at=
 charcreate !!!!
 gCharCreateSkillIDs["Necromancy"]				=3D 49
 gCharCreateSkillIDs["Focus"]					=3D 50
 gCharCreateSkillIDs["Chivalry"]					=3D 51
 gCharCreateSkillIDs["Bushido"]					=3D 52
 gCharCreateSkillIDs["Ninjitsu"]					=3D 53
-gCharCreateSkillIDs["Spellweaving"]				=3D 54
+gCharCreateSkillIDs["Spellweaving"]				=3D 54 -- not possible to set > 0 a=
t charcreate !!!!
 =

 =

 kTextType_Normal			=3D 0x00

Modified: trunk/lua/net/net.login.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.login.lua (original)
+++ trunk/lua/net/net.login.lua Mon Oct 27 02:25:49 2008
@@ -366,6 +366,19 @@
 =

 -- send characterselect to gameserver
 function Send_CharCreate(chardata)
+	local skillid =3D gCharCreateSkillIDs["Stealth"]
+	assert(	chardata.skill1 ~=3D skillid and
+			chardata.skill2 ~=3D skillid and
+			chardata.skill3 ~=3D skillid,"Stealth skill not allowed at charcreate")
+	local skillid =3D gCharCreateSkillIDs["Remove Trap"]
+	assert(	chardata.skill1 ~=3D skillid and
+			chardata.skill2 ~=3D skillid and
+			chardata.skill3 ~=3D skillid,"Remove Trap skill not allowed at charcrea=
te")
+	local skillid =3D gCharCreateSkillIDs["Spellweaving"]
+	assert(	chardata.skill1 ~=3D skillid and
+			chardata.skill2 ~=3D skillid and
+			chardata.skill3 ~=3D skillid,"Spellweaving skill not allowed at charcre=
ate")
+			=

 	local out =3D GetSendFIFO()
 	out:PushNetUint8(kPacket_CharacterCreation)
 	out:PushNetUint32(hex2num("0xedededed"))



From no-reply at zwischenwelt.org  Mon Oct 27 02:30:13 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 27 Oct 2008 01:30:13 -0000
Subject: [Iris-commit] [IRIS] r2659 - /trunk/installdeps.ubuntu.sh
Message-ID: <20081027013013.89DFC1C1855D@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 27 02:30:13 2008
New Revision: 2659

Log:
added ccache to dependency install script

Modified:
    trunk/installdeps.ubuntu.sh

Modified: trunk/installdeps.ubuntu.sh
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/installdeps.ubuntu.sh (original)
+++ trunk/installdeps.ubuntu.sh Mon Oct 27 02:30:13 2008
@@ -1,4 +1,4 @@
 #!/bin/bash
-DEPS=3D"nvidia-cg-toolkit liblua50-dev liblualib50-dev libalut-dev libopen=
al-dev libvorbisfile3 libvorbis-dev libogg-dev libboost-dev libboost-thread=
-dev libogre14 libogre-dev libois-dev g++ gcc"
+DEPS=3D"nvidia-cg-toolkit ccache liblua50-dev liblualib50-dev libalut-dev =
libopenal-dev libvorbisfile3 libvorbis-dev libogg-dev libboost-dev libboost=
-thread-dev libogre14 libogre-dev libois-dev g++ gcc"
 echo apt-get install $DEPS
 sudo apt-get install $DEPS



From no-reply at zwischenwelt.org  Mon Oct 27 15:43:36 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 27 Oct 2008 14:43:36 -0000
Subject: [Iris-commit] [IRIS] r2660 - in /trunk/lua: gui/gui.gumpparser.lua
 gui/gui.paperdoll.lua lib.gump.samples.lua lib.uoids.lua main.lua
 net/net.other.lua widgets/widget.uobutton.lua widgets/widget.uotooltip.lua
Message-ID: <20081027144337.1E4841C18424@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 27 15:43:36 2008
New Revision: 2660

Log:
virtue gump buttons now functional

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.paperdoll.lua
    trunk/lua/lib.gump.samples.lua
    trunk/lua/lib.uoids.lua
    trunk/lua/main.lua
    trunk/lua/net/net.other.lua
    trunk/lua/widgets/widget.uobutton.lua
    trunk/lua/widgets/widget.uotooltip.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Mon Oct 27 15:43:36 2008
@@ -221,6 +221,7 @@
 function GumpParser_DebugDumpGump (Gumpdata)
 	-- debug dump
 	if (1 =3D=3D 1 and (not Clientsidemode)) then =

+		print(GetStackTrace())
 		print("\n\n##### GUMP #####\n\n\""..Gumpdata.Data.."\",\n\ntextline=3D{"=
) =

 		for k,v in pairs(Gumpdata.textline or {}) do print("["..k.."]=3D\""..v..=
"\",") end =

 		print("},")
@@ -260,6 +261,7 @@
 		=

 		if (command =3D=3D "gumppic") then -- special format, optional hue=3D123
 			if (bToken[5] =3D=3D "hue") then param.hue =3D bToken[6] end
+			if (bToken[7] =3D=3D "class") then param.uoclass =3D bToken[8] param.uo=
num =3D k end -- "VirtueGumpItem"
 			if (bClientSideMode) then param.ctrlname =3D bToken[5] end
 		end
 		=

@@ -355,11 +357,15 @@
 		elseif (command =3D=3D "resizepic") then
 			widget =3D parent:CreateChild("UOImage",param)
 			=

-		--gumppic <x> <y> <gump_id> [hue=3D353]
+		--gumppic <x> <y> <gump_id> [hue=3D353] [class=3DVirtueGumpItem]  --> pa=
ram.uoclass param.uonum
 		--Description:  Adds a graphic to the gump, where <id> ist the graphic i=
d of an item.
 		--				Optionaly there is a color parameter. =

 		elseif (command =3D=3D "gumppic") then
-			widget =3D parent:CreateChild("UOImage",param)
+			if (param.uoclass) then =

+				widget =3D parent:CreateChild("UOButton",param)
+			else
+				widget =3D parent:CreateChild("UOImage",param)
+			end
 =

 		--gumppictiled <x> <y> <width> <height> <gump_id>
 		--Description:  Similar to GumpPic, but the gumppic is tiled to the give=
n <height> and <width>.

Modified: trunk/lua/gui/gui.paperdoll.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.paperdoll.lua (original)
+++ trunk/lua/gui/gui.paperdoll.lua Mon Oct 27 15:43:36 2008
@@ -51,9 +51,7 @@
  -- virtues
  [2]	=3D function (widget,mousebutton)
 			if (mousebutton =3D=3D 1) then
-				local playermobile =3D GetPlayerMobile()
-				--warning ! playerserial might be wrong here, usually this param is th=
e gump-serial"
-				GumpReturnMsg(playermobile.serial, hex2num("0x000001CD"), hex2num("0x0=
0000001"), nil, hex2num("0x00000001"), playermobile.serial)
+				GumpReturnMsg(GetPlayerSerial(),kGumpTypeVirtue,1,nil,1, GetPlayerSeri=
al()) -- special case
 			end
 		  end,
  -- quit

Modified: trunk/lua/lib.gump.samples.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.gump.samples.lua (original)
+++ trunk/lua/lib.gump.samples.lua Mon Oct 27 15:43:36 2008
@@ -1,6 +1,24 @@
 -- a few recorded example gumps for testing
 =

 =

+
+kGumpSample_VirtueGump =3D {
+	Data=3D"{ page 0 }{ gumppic 30 40 104 }{ page 1 }"..
+	"{ gumppic  61  71 108 hue=3D2402 class=3DVirtueGumpItem }"..
+	"{ gumppic 123  46 112 hue=3D32 class=3DVirtueGumpItem }"..
+	"{ gumppic 187  70 107 hue=3D2402 class=3DVirtueGumpItem }"..
+	"{ gumppic  35 135 110 hue=3D42 class=3DVirtueGumpItem }"..
+	"{ gumppic 211 133 105 hue=3D2402 class=3DVirtueGumpItem }"..
+	"{ gumppic  61 195 111 hue=3D2402 class=3DVirtueGumpItem }"..
+	"{ gumppic 186 195 109 hue=3D2402 class=3DVirtueGumpItem }"..
+	"{ gumppic 121 221 106 hue=3D2402 class=3DVirtueGumpItem }"..
+	"{ button 57 269 2027 2027 1 0 1 }"..
+	"{ button 186 269 2071 2071 1 0 2 }",
+	textline=3D{
+	},
+	textline_unicode=3D{
+	},
+}
 =

 kGumpSample_PM =3D {
 	Data=3D"{ resizepic 0 0 5120 300 255 }{ htmlgump 0 10 300 21 0 0 0 }{ gum=
ppic 30 12 57 }{ gumppic 240 12 59 }{ gumppictiled 30 30 240 21 3004 }{ tex=
tentry 30 30 240 21 1152 7442 1 }{ gumppictiled 20 60 260 150 3004 }{ texte=
ntry 20 60 260 150 1152 13108 1 }{ button 50 225 9704 9705 1 0 13956 }{ gum=
ppic 140 225 9026 hue=3D1152 }{ button 144 229 10006 10006 1 0 10659 }{ htm=
lgump 215 225 50 21 2 0 0 }{ button 200 228 10006 10006 1 0 14175 }{ page 0=
 }{ gumppic 300 255 10460 hue=3D903 }{ button 310 259 2362 2362 1 0 7310 }{=
 button 310 270 2360 2360 1 0 19710 }{ button 295 257 9766 9767 1 0 145 }{ =
button 319 257 9762 9763 1 0 5685 }{ button 295 268 9766 9767 1 0 10529 }{ =
button 319 268 9762 9763 1 0 13966 }",

Modified: trunk/lua/lib.uoids.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoids.lua (original)
+++ trunk/lua/lib.uoids.lua Mon Oct 27 15:43:36 2008
@@ -18,6 +18,9 @@
 -- base body gump ids
 kGumpBaseId_Male	=3D 50000
 kGumpBaseId_Female	=3D 60000
+
+kGumpTypeVirtue =3D 0x000001CD
+kGumpClassName_VirtueGumpItem =3D "VirtueGumpItem"
 =

 gMaxHueValue =3D 2999 -- hues.mul has only 2999 values
 gMaxArtValue =3D hex2num("0xbfff")

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Mon Oct 27 15:43:36 2008
@@ -18,7 +18,7 @@
 gInGameStarted =3D false
 gNet_State =3D false
 =

-
+function GetStackTrace () return _TRACEBACK() end
 =

 --###############################
 --###     OTHER LUA FILES     ###

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Mon Oct 27 15:43:36 2008
@@ -964,10 +964,13 @@
 	out:PushNetUint32(playerserial)
 	out:PushNetUint32(gumptypeid)
 	out:PushNetUint32(ret_value)
+	=

 	--print("GumpReturnMsg player,gump,retval:",playerserial,gumptypeid,ret_v=
alue)
-	=

+	--~ printf("###### 0xB1 0x%04x 0x%08x 0x%08x 0x%08x\n",packetlen,playerse=
rial,gumptypeid,ret_value)
+	--~ 0000   B1 00 0F 00 0D BA 5B 00  00 01 CD 00 00 00 70      ......[....=
...p   -- virtue request (valor, 70 =3D gumpid of image)
 	=

 	if (params) then
+		--~ print("param",params)
 		out:PushNetUint32(table.getn(params.switches))	--switchcount
 		for k,v in pairs(params.switches) do =

 			out:PushNetUint32(v) =

@@ -983,6 +986,7 @@
 			--print("GumpReturnMsg text:",v.id,len,v.text)
 		end
 	else
+		--~ print("noparam",switchcount,textcount)
 		if (switchcount and textcount) then
 			out:PushNetUint32(switchcount)	--switchcount
 			out:PushNetUint32(textcount)	--textcount

Modified: trunk/lua/widgets/widget.uobutton.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uobutton.lua (original)
+++ trunk/lua/widgets/widget.uobutton.lua Mon Oct 27 15:43:36 2008
@@ -12,7 +12,15 @@
 	self:SetIgnoreBBoxHit(true)
 	=

 	self.params			=3D params
-	self:SetButtonGumpIDs(params.gump_id_normal,params.gump_id_pressed)
+	if (params.uoclass) then -- from gumppic : params.uoclass params.uonum Vi=
rtueGumpItem
+		--~ print("UOButton with uoclass,uonum",params.uoclass,params.uonum)
+		params.gump_id_normal	=3D params.gump_id
+		params.gump_id_pressed	=3D params.gump_id
+		params.quit				=3D 0
+		params.page_id			=3D 0
+		params.return_value		=3D params.gump_id
+	end
+	self:SetButtonGumpIDs(params.gump_id_normal,params.gump_id_pressed,params=
.gump_id_pressed,params.hue)
 	if (params.art_id) then
 		self.gfx_icon =3D self:CreateChild("UOImage",{x=3Dparams.art_x,y=3Dparam=
s.art_y,art_id=3Dparams.art_id,hue=3Dparams.hue})
 	end
@@ -20,11 +28,11 @@
 	self:UpdateGfx()
 end
 =

-function gWidgetPrototype.UOButton:SetButtonGumpIDs		(gump_id_normal,gump_=
id_pressed,gump_id_over) =

+function gWidgetPrototype.UOButton:SetButtonGumpIDs		(gump_id_normal,gump_=
id_pressed,gump_id_over,hue) =

 	if (self.gfx_normal) then self.gfx_normal:Destroy() end
 	if (self.gfx_pressed) then self.gfx_pressed:Destroy() end
-	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dgu=
mp_id_normal})
-	self.gfx_pressed	=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dgu=
mp_id_pressed})
+	self.gfx_normal		=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dgu=
mp_id_normal,hue=3Dhue})
+	self.gfx_pressed	=3D self:CreateChild("UOImage",{x=3D0,y=3D0,gump_id=3Dgu=
mp_id_pressed,hue=3Dhue})
 	self:UpdateGfx()
 end
 =

@@ -42,6 +50,11 @@
 function gWidgetPrototype.UOButton:GetReturnVal	() return self.params.retu=
rn_value end
 =

 function gWidgetPrototype.UOButton:on_button_click	()
+	if (self.params.uoclass =3D=3D kGumpClassName_VirtueGumpItem) then
+		GumpReturnMsg(GetPlayerSerial(),kGumpTypeVirtue,self.params.return_value=
) -- send virtue request
+		return =

+	end
+				=

 	local dialog =3D self:GetDialog()
 	local page_id =3D self.params.page_id
 	local return_value =3D self.params.return_value

Modified: trunk/lua/widgets/widget.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uotooltip.lua (original)
+++ trunk/lua/widgets/widget.uotooltip.lua Mon Oct 27 15:43:36 2008
@@ -44,8 +44,8 @@
 	local w,h =3D r-l,b-t
 	if (w < 0 or w > 1000) then print("uotooltip : w out of bounds",w) end
 	if (h < 0 or h > 1000) then print("uotooltip : h out of bounds",h) end
-	w =3D min(300,max(0,w))
-	h =3D min(300,max(0,h))
+	--~ w =3D min(500,max(0,w))
+	--~ h =3D min(500,max(0,h))
 	gfxparams.w =3D borderl+w+borderr
 	gfxparams.h =3D bordert+h+borderb
 	self.spritepanel:Update(gfxparams)



From no-reply at zwischenwelt.org  Mon Oct 27 17:19:55 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Mon, 27 Oct 2008 16:19:55 -0000
Subject: [Iris-commit] [IRIS] r2661 - /trunk/lua/lib.packetvideo.lua
Message-ID: <20081027161955.8E36D1C18424@zwischenwelt.org>

Author: ghoulsblade
Date: Mon Oct 27 17:19:55 2008
New Revision: 2661

Log:
packetvideo playback speed config (gPacketVideoSpeedFactor)

Modified:
    trunk/lua/lib.packetvideo.lua

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Mon Oct 27 17:19:55 2008
@@ -5,6 +5,8 @@
 gPacketVideoRecording =3D false
 gPacketVideoRecording =3D false
 gPacketVideoPlaybackRunning =3D false
+
+gPacketVideoSpeedFactor =3D 1 =

 =

 kPacketVideoChunkType_Recv	=3D 1
 kPacketVideoChunkType_Send	=3D 2
@@ -48,15 +50,29 @@
 	job.create(function()
 		local oldpos =3D {gPlayerXLoc,gPlayerYLoc,gPlayerZLoc,gPlayerDir}
 		local oldfacet =3D MapGetMapIndex()
-		print("### packetvideo playback start",#gPacketVideoData)
+		local lastframet
+		local lastrealt
+		local lastwaitrealt
+		print("### packetvideo playback start",#gPacketVideoData,gPacketVideoSpe=
edFactor)
 		gPacketVideoPlaybackRunning =3D true
 		local playback_start_t =3D Client_GetTicks()
 		local record_start_t =3D gPacketVideoData[1].t
+		local forcedwaitinterval =3D 500 -- to ensure that something is visible,=
 even if the processor is totally busy
+		nextforcedwaitt =3D Client_GetTicks() + forcedwaitinterval
 		for k,chunk in pairs(gPacketVideoData) do
-			local t =3D Client_GetTicks()
-			local framet =3D chunk.t - record_start_t + playback_start_t
+			local realt =3D Client_GetTicks()
+			--~ local framet =3D chunk.t - record_start_t + playback_start_t
 			--~ print("### packetvideo playback step, wait=3D",framet,chunk.chunkty=
pe)
-			if (framet > t) then job.wait(framet-t) end
+			--~ if (framet > t) then job.wait(framet-t) end
+			local framet =3D chunk.t
+			if (lastframet) then =

+				local wait1 =3D (framet - lastframet)
+				local wait2 =3D floor(wait1 / gPacketVideoSpeedFactor)
+				if (lastrealt) then wait2 =3D wait2 - (realt - lastrealt) end
+				if (wait2 > 5 or realt > nextforcedwaitt) then job.wait(wait2) nextfor=
cedwaitt =3D realt + forcedwaitinterval end
+			end
+			lastframet =3D framet
+			lastrealt =3D realt
 			=

 			if (chunk.chunktype =3D=3D kPacketVideoChunkType_Recv) then
 				local headlen =3D 1+4+4



From no-reply at zwischenwelt.org  Tue Oct 28 14:58:22 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 28 Oct 2008 13:58:22 -0000
Subject: [Iris-commit] [IRIS] r2662 - /trunk/lua/lib.buff.lua
Message-ID: <20081028135822.63B491C18647@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 28 14:58:21 2008
New Revision: 2662

Log:
buff icon load fail check

Modified:
    trunk/lua/lib.buff.lua

Modified: trunk/lua/lib.buff.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.buff.lua (original)
+++ trunk/lua/lib.buff.lua Tue Oct 28 14:58:21 2008
@@ -95,6 +95,7 @@
 	end
 	--~ local w,h =3D GetArtSize(iArtID,hueid)
 	local w,h =3D GetGumpSize(iGumpID,hueid)
+	if (not w) then return end
 	local widget =3D guimaker.MakePlane(parent,mat,x,y,w,h)
 	local tw,th =3D texsize(w),texsize(h)
 	widget.gfx:SetUV(0,0,w/tw,h/th)



From no-reply at zwischenwelt.org  Tue Oct 28 15:11:42 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 28 Oct 2008 14:11:42 -0000
Subject: [Iris-commit] [IRIS] r2663 - in /trunk/data/models:
 materials/textures.material models/to_016000/mdl_015119.mesh
Message-ID: <20081028141142.36EFB1C18648@zwischenwelt.org>

Author: hagish
Date: Tue Oct 28 15:11:41 2008
New Revision: 2663

Log:
new model: osterhead (i dont think this is the correct name)

Added:
    trunk/data/models/models/to_016000/mdl_015119.mesh   (with props)
Modified:
    trunk/data/models/materials/textures.material

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Tue Oct 28 15:11:41 2008
@@ -5998,3 +5998,8 @@
 { =

 	set_texture_alias MainTexture tex_runestone.png
 }
+
+material tex_osterhead : tex_base =

+{ =

+	set_texture_alias MainTexture tex_osterhead.png
+}



From no-reply at zwischenwelt.org  Tue Oct 28 16:33:00 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 28 Oct 2008 15:33:00 -0000
Subject: [Iris-commit] [IRIS] r2664 - in /trunk: lua/lib.desktop.lua
 lua/lib.packetvideo.lua lua/lib.uotooltip.lua plugins/moblist.lua
Message-ID: <20081028153300.482B01C18648@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 28 16:32:59 2008
New Revision: 2664

Log:
small changes

Modified:
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.packetvideo.lua
    trunk/lua/lib.uotooltip.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Oct 28 16:32:59 2008
@@ -261,6 +261,7 @@
 end
 =

 RegisterListener("Gui_StopMouseMoveWidget",function(widget,x,y) -- new gui=
 system
+	if (not widget:IsAlive()) then return end
 	local nx,ny =3D widget:GetPos()
 	print("Gui_StopMouseMoveWidget",widget,x,y,nx,ny)
 	for k,v in pairs(gDesktop) do

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Tue Oct 28 16:32:59 2008
@@ -41,6 +41,7 @@
 	PacketVideo_LogMap(MapGetMapIndex())
 	PacketVideo_LogPlayerPos(gPlayerXLoc,gPlayerYLoc,gPlayerZLoc,gPlayerDir)
 	Send_ClientQuery(gRequest_States,GetPlayerSerial())
+	Send_Movement_Resync_Request()
 end
 function PacketVideo_Recording_End() gPacketVideoRecording =3D false end
 =

@@ -57,8 +58,9 @@
 		gPacketVideoPlaybackRunning =3D true
 		local playback_start_t =3D Client_GetTicks()
 		local record_start_t =3D gPacketVideoData[1].t
-		local forcedwaitinterval =3D 500 -- to ensure that something is visible,=
 even if the processor is totally busy
-		nextforcedwaitt =3D Client_GetTicks() + forcedwaitinterval
+		local forcedwaitinterval =3D 250 -- to ensure that something is visible,=
 even if the processor is totally busy
+		local nextforcedwaitt =3D Client_GetTicks() + forcedwaitinterval
+		local minwait =3D 5
 		for k,chunk in pairs(gPacketVideoData) do
 			local realt =3D Client_GetTicks()
 			--~ local framet =3D chunk.t - record_start_t + playback_start_t
@@ -69,7 +71,10 @@
 				local wait1 =3D (framet - lastframet)
 				local wait2 =3D floor(wait1 / gPacketVideoSpeedFactor)
 				if (lastrealt) then wait2 =3D wait2 - (realt - lastrealt) end
-				if (wait2 > 5 or realt > nextforcedwaitt) then job.wait(wait2) nextfor=
cedwaitt =3D realt + forcedwaitinterval end
+				if (wait2 > minwait or realt > nextforcedwaitt) then =

+					job.wait(max(1,wait2)) =

+					nextforcedwaitt =3D realt + forcedwaitinterval =

+				end
 			end
 			lastframet =3D framet
 			lastrealt =3D realt

Modified: trunk/lua/lib.uotooltip.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uotooltip.lua (original)
+++ trunk/lua/lib.uotooltip.lua Tue Oct 28 16:32:59 2008
@@ -97,6 +97,12 @@
 function AosToolTip_SetHash (serial,hash) gAosToolTipHash[serial] =3D hash=
 end
 function AosToolTip_SetText (serial,text) gAosToolTipText[serial] =3D text=
 end
 =

+function ClearAosToolTip () -- might be good every 10 minutes ? should aut=
omatically rerequest mobile equipment tooltips ?
+	gAosToolTipHash =3D {}
+	gAosToolTipText =3D {}
+	gAosToolTipRequested =3D {}
+end
+
 -- Newer packet as of late 2004.
 -- Is now used on OSI to handle the Revision of Tooltips instead of the or=
iginal 0xBF methods it appears.
 -- server sends these automatically when a new object appears, doesn't hav=
e to be requested

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Tue Oct 28 16:32:59 2008
@@ -164,7 +164,7 @@
 end
 =

 function gWidgetPrototype.UOMobList:SetMainTarget (serial,name)
-	if (serial =3D=3D 0 or serial =3D=3D GetPlayerSerial()) then serial =3D n=
il end
+	if (serial =3D=3D 0 or serial =3D=3D GetPlayerSerial() or serial =3D=3D s=
elf.maintarget_serial) then serial =3D nil end
 	self.maintarget_serial =3D serial
 	print("UOMobList:SetMainTarget",serial,name)
 	local gfx  =3D self.gfx_maintarget



From no-reply at zwischenwelt.org  Tue Oct 28 17:16:25 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 28 Oct 2008 16:16:25 -0000
Subject: [Iris-commit] [IRIS] r2665 - in /trunk/lua: gui/gui.gumpparser.lua
 gui/gui.healthbar.lua gui/gui.menubar.lua lib.compass.lua lib.desktop.lua
 lib.iris_atlasgroup.lua lib.loading.lua lib.map.lua lib.null.renderer.lua
 lib.terrain.multitex.lua net/net.other.lua
Message-ID: <20081028161625.DE7E81C18648@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 28 17:16:25 2008
New Revision: 2665

Log:
a few checks for norender mode

Modified:
    trunk/lua/gui/gui.gumpparser.lua
    trunk/lua/gui/gui.healthbar.lua
    trunk/lua/gui/gui.menubar.lua
    trunk/lua/lib.compass.lua
    trunk/lua/lib.desktop.lua
    trunk/lua/lib.iris_atlasgroup.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.map.lua
    trunk/lua/lib.null.renderer.lua
    trunk/lua/lib.terrain.multitex.lua
    trunk/lua/net/net.other.lua

Modified: trunk/lua/gui/gui.gumpparser.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.gumpparser.lua (original)
+++ trunk/lua/gui/gui.gumpparser.lua Tue Oct 28 17:16:25 2008
@@ -11,6 +11,7 @@
 dofile(libpath .. "lib.gump.samples.lua")
 =

 function GumpParser (Gumpdata, Clientsidemode)
+	if (gNoRender) then return end
 	if ((not Clientsidemode) or Gumpdata.bSupportsGuiSys2) then return GumpPa=
rser_New(Gumpdata, Clientsidemode) end
 	return GumpParser_Old(Gumpdata, Clientsidemode)
 end

Modified: trunk/lua/gui/gui.healthbar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.healthbar.lua (original)
+++ trunk/lua/gui/gui.healthbar.lua Tue Oct 28 17:16:25 2008
@@ -130,6 +130,7 @@
 function OpenHealthbar (mobile,x,y)
 --	if true then return end
 	=

+	if gNoRender then return end
 	if mobile =3D=3D nil then return end
 	=

 	-- try to read position from desktop infos

Modified: trunk/lua/gui/gui.menubar.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.menubar.lua (original)
+++ trunk/lua/gui/gui.menubar.lua Tue Oct 28 17:16:25 2008
@@ -87,6 +87,7 @@
 =

 gMenuBarDialog =3D nil
 function OpenMenuBar()
+	if (gNoRender) then return end
    if not(gMenuBarDialog) then
       local dialog =3D GumpParser( menubarGump, true )
 =


Modified: trunk/lua/lib.compass.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.compass.lua (original)
+++ trunk/lua/lib.compass.lua Tue Oct 28 17:16:25 2008
@@ -143,7 +143,7 @@
 -- param : compass-center-pos (player or cam)
 function UpdateDetailMapCacheIfNeeded (xloc,yloc)
 	-- update detail multis if needed
-	if gDetailMultiNeedsUpdate and Client_GetTicks() - gDetailMultiLastUpdate=
 > gDetailMultiUpdateTimeout then
+	if gRadarColorLoader and gDetailMultiNeedsUpdate and Client_GetTicks() - =
gDetailMultiLastUpdate > gDetailMultiUpdateTimeout then
 		-- print("update compass detail multis...")
 		=

 		gDetailMultiNeedsUpdate =3D false

Modified: trunk/lua/lib.desktop.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.desktop.lua (original)
+++ trunk/lua/lib.desktop.lua Tue Oct 28 17:16:25 2008
@@ -226,6 +226,7 @@
 =

 -- create/open/reposition then current desktop, use this after teleport or=
 similar events
 function ReopenDesktop()
+	if (gNoRender) then return end
 	-- print(luadump("gDesktop",gDesktop))
 	for k,v in pairs(gDesktop) do
 		OpenDesktopElement(v.name,v.x,v.y,v.param)

Modified: trunk/lua/lib.iris_atlasgroup.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.iris_atlasgroup.lua (original)
+++ trunk/lua/lib.iris_atlasgroup.lua Tue Oct 28 17:16:25 2008
@@ -19,7 +19,7 @@
 function LoadGump	(basemat,gump_id,hue) =

 	--~ if (true) then return "BaseWhiteNoLighting",0,0,1,1,22,22,nil end -- =
TODO =

 	local matname,u0,v0,uvw,uvh,origw,origh =3D gAtlasGroup_Gump:LoadMat(base=
mat,gump_id,hue)
-	local bitmask =3D gAtlasGroup_Gump.bitmasks[gump_id]
+	local bitmask =3D matname and gAtlasGroup_Gump.bitmasks and gAtlasGroup_G=
ump.bitmasks[gump_id]
 	return matname,u0,v0,uvw,uvh,origw,origh,bitmask
 end
 =

@@ -33,6 +33,7 @@
 =

 -- returns img
 function gAtlasGroup_Gump:LoadImpl (gump_id,hue)
+	if (not gGumpLoader) then return end
 	local img =3D CreateImage()
 	local bSuccess =3D gGumpLoader:ExportToImage(img,gump_id,gHueLoader,hue o=
r 0)
 	if (not self.bitmasks) then self.bitmasks =3D {} end

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Tue Oct 28 17:16:25 2008
@@ -188,9 +188,9 @@
 	LoadBodyDef(		CorrectPath( Addfilepath("Body.def") ))
 	LoadBodyConfDef(	CorrectPath( Addfilepath("Bodyconv.def") ))
 	LoadEquipConvDef(	CorrectPath( Addfilepath("Equipconv.def") ))
+	gAnimLoader =3D {}
 	if (gAnimLoaderType) then
 		LoadingProfile("init AnimLoader")
-		gAnimLoader =3D {}
 		-- old : gAnimFile,gAnimidxFile =

 		local path
 		path =3D CorrectPath( Addfilepath("anim.idx" ) ) if (file_exists(path)) =
then gAnimLoader[1] =3D CreateAnimLoader(gAnimLoaderType,200,200,path,Corre=
ctPath( Addfilepath("anim.mul" ) )) end	=


Modified: trunk/lua/lib.map.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.map.lua (original)
+++ trunk/lua/lib.map.lua Tue Oct 28 17:16:25 2008
@@ -25,8 +25,8 @@
 function MapGetBlockStatics	(bx,by)		return MapGetCacheBlock(bx,by).static=
s_all end =

 =

 -- returns tiletype,z       xloc,yloc in absolute tilecoords
-function GetGroundAtAbsPos (xloc,yloc) local g =3D MapGetGround(xloc,yloc)=
 return g.iTileType,g.zloc end
-function GetGroundZAtAbsPos (xloc,yloc) local g =3D MapGetGround(xloc,yloc=
) return g.zloc end
+function GetGroundAtAbsPos (xloc,yloc) local g =3D MapGetGround(xloc,yloc)=
 if (g) then return g.iTileType,g.zloc end end
+function GetGroundZAtAbsPos (xloc,yloc) local g =3D MapGetGround(xloc,yloc=
) if (g) then return g.zloc end end
 =

 -- returns an array,  {{artid=3D?,zloc=3D?,hue=3D?},...}
 function GetStaticsAtAbsPos (xloc,yloc) return MapGetStatics(xloc,yloc) end
@@ -81,6 +81,7 @@
 	=

 	-- ground
 	b.ground =3D {}
+	if (gGroundBlockLoader) then
 	for ty =3D 0,7 do
 	for tx =3D 0,7 do
 		local iTileType,zloc =3D gGroundBlockLoader:GetTile(bx,by,tx,ty)  -- TOD=
O : season translation ??? iTranstile	=

@@ -90,6 +91,7 @@
 		b.ground[ty*10 + tx] =3D {iTileType=3DiTileType,zloc=3Dzloc,bIgnoredByWa=
lk=3DbIgnoredByWalk,flags=3DGetGroundTileType(iTileType).miFlags}
 	end
 	end
+	end
 	=

 	return b
 end

Modified: trunk/lua/lib.null.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.null.renderer.lua (original)
+++ trunk/lua/lib.null.renderer.lua Tue Oct 28 17:16:25 2008
@@ -2,7 +2,7 @@
 =

 gRendererList[ "RendererNull" ] =3D RendererNull
 =

-function RendererNull_Print(...) print("<NULL>",...) end
+function RendererNull_Print(...) --[[ print("<NULL>",...) ]] end
 function RendererNull_PrintOften(...) --[[ print("<NULL>",...) ]] end
 =

 function RendererNull:DeInit () RendererNull_Print("DeInit") end
@@ -63,3 +63,4 @@
 =

 function RendererNull:NotifyHPChange				(mobile, value) end
 function RendererNull:NotifyManaChange			(mobile, value) end
+function RendererNull:ClearMapCache			() end

Modified: trunk/lua/lib.terrain.multitex.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.terrain.multitex.lua (original)
+++ trunk/lua/lib.terrain.multitex.lua Tue Oct 28 17:16:25 2008
@@ -364,6 +364,7 @@
 =

 =

 function MakeMultiTexTerrainGfx(bx,by,zunit) =

+	if (not gGroundBlockLoader) then return end
 	zunit =3D zunit or 0.1
 	local gfx =3D CreateRootGfx3D()
 	gfx.bx =3D bx

Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Tue Oct 28 17:16:25 2008
@@ -1143,7 +1143,7 @@
 		local unknownterminator=3Dinput:PopNetUint32()
 	end
 =

-	local dialog =3D GumpParser(newgump)
+	local dialog =3D (not gNoRender) and GumpParser(newgump)
 	NotifyListener("Hook_OpenServersideGump",dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data,true)	=

 end
 =




From no-reply at zwischenwelt.org  Tue Oct 28 18:23:15 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 28 Oct 2008 17:23:15 -0000
Subject: [Iris-commit] [IRIS] r2666 - in /trunk/lua: gui/gui.chat.lua
 gui/gui.helper.lua lib.cursor.lua lib.loading.lua lib.mainmenu.lua main.lua
Message-ID: <20081028172315.B700A1C1828F@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 28 18:23:15 2008
New Revision: 2666

Log:
gNoRender and gNoOgre mode to start without window

Modified:
    trunk/lua/gui/gui.chat.lua
    trunk/lua/gui/gui.helper.lua
    trunk/lua/lib.cursor.lua
    trunk/lua/lib.loading.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/main.lua

Modified: trunk/lua/gui/gui.chat.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.chat.lua (original)
+++ trunk/lua/gui/gui.chat.lua Tue Oct 28 18:23:15 2008
@@ -96,6 +96,7 @@
 end
 =

 function GuiInitChat	()
+	if (gNoRender) then return end
 	-- destroy already existing chat gui stuff
 	if gGuiChatIcon or gGuiChatTabpane then
 		GuiDestroyChat()

Modified: trunk/lua/gui/gui.helper.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/gui/gui.helper.lua (original)
+++ trunk/lua/gui/gui.helper.lua Tue Oct 28 18:23:15 2008
@@ -4,6 +4,7 @@
 function NotifyLoadingStart() giShowLoading =3D giShowLoading + 1 end
 function NotifyLoadingEnd() giShowLoading =3D giShowLoading - 1 end
 function DisplayLoadingState ()
+	if (gNoRender) then return end
 	-- parameters
 	local w =3D 128
 	local h =3D 16
@@ -112,6 +113,7 @@
 =

 -- iris logo
 function CreateIrisLogo ()
+	if (gNoRender) then return end
 	if (gTestNoIrisLogo) then return end
 	gDialog_IrisLogo =3D guimaker.MyCreateDialog()
 	local widget =3D guimaker.MakePlane(gDialog_IrisLogo,"irislogo",-128,-128=
,256,256)
@@ -120,7 +122,7 @@
 =

 function ToggleLogo ()
 	gShowIrisLogo =3D not gShowIrisLogo =

-	gDialog_IrisLogo:SetVisible(gShowIrisLogo)
+	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(gShowIrisLogo) end
 end
 =

 -- text-line at the bottom of screen (readonly, used for mousepicking debu=
g text and for info during loading)

Modified: trunk/lua/lib.cursor.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.cursor.lua (original)
+++ trunk/lua/lib.cursor.lua Tue Oct 28 18:23:15 2008
@@ -22,6 +22,7 @@
 kCursorIndex_Mark		=3D 15 -- mark (needle/pin, probably for boat-course-pl=
otting)
 =

 function SetUOCursor (iIndex) =

+	if (gNoRender) then return end
 	if (gHideUOCursor) then return end
 	iIndex =3D math.mod(iIndex,16)
 	local isFirst =3D not gui.cursorGfx2D

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Tue Oct 28 18:23:15 2008
@@ -231,6 +231,7 @@
 =

 -- ------------------------------------------------------------------
 function PreLoadInit	()
+	if (gNoRender) then return end
 	local vp =3D GetMainViewport()
 	local w =3D vp:GetActualWidth()
 	local h =3D vp:GetActualHeight()
@@ -241,11 +242,13 @@
 end
 =

 function PreLoadDone	()
+	if (gNoRender) then return end
 	gPreloadBar:Destroy()
 	gPreloadBar =3D nil
 end
 =

 function PreLoadUpdate	(p)
+	if (gNoRender) then return end
 	local vp =3D GetMainViewport()
 	local w =3D vp:GetActualWidth()
 	local h =3D vp:GetActualHeight()

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Tue Oct 28 18:23:15 2008
@@ -35,7 +35,7 @@
 	GuiAddChatLine("connecting to shard '"..shardname.."' on "..gLoginServerI=
P..":"..gLoginServerPort)
 	=

 	-- todo : move to gui ?
-	gDialog_IrisLogo:SetVisible(false)
+	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
 	ChatLine_Init()	=

 	=

 	gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServerS=
eed)
@@ -91,7 +91,7 @@
 local function StartOfflineMode (postxt)
 	if (gOfflineModeMapIndex) then MapChangeRequest(gOfflineModeMapIndex) end
 	=

-	gDialog_IrisLogo:SetVisible(false)
+	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
 =

 	gStartGameWithoutNetwork =3D true
 	MultiTexTerrain_NotifyMapChange()
@@ -331,18 +331,20 @@
 end
 =

 function StartMainMenu ()
-	local vp =3D GetMainViewport()
-	local w =3D vp:GetActualWidth()
-	local h =3D vp:GetActualHeight()
-	local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPlainT=
extureGUIMat("menu_bg.jpg"), 1024, 768)
-	gMenuBgImage =3D GetDesktopWidget():CreateChild("Image",{gfxparam_init=3D=
gfxparam_init})
-	gMenuBgImage:SetPos(0,0)
-	gMenuBgImage:SetSize(w,h)
-	RegisterListener("Hook_StartInGame"	,function () =

-		DestroyIfAlive(gMenuBgImage)
-		gMenuBgImage =3D nil
-	end)
-	gDialog_IrisLogo:SetVisible(false)
+	if (not gNoRender) then =

+		local vp =3D GetMainViewport()
+		local w =3D vp:GetActualWidth()
+		local h =3D vp:GetActualHeight()
+		local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPlain=
TextureGUIMat("menu_bg.jpg"), 1024, 768)
+		gMenuBgImage =3D GetDesktopWidget():CreateChild("Image",{gfxparam_init=
=3Dgfxparam_init})
+		gMenuBgImage:SetPos(0,0)
+		gMenuBgImage:SetSize(w,h)
+		RegisterListener("Hook_StartInGame"	,function () =

+			DestroyIfAlive(gMenuBgImage)
+			gMenuBgImage =3D nil
+		end)
+		if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
+	end
 =

 	if (gTestNoMainMenu) then return end
 	if (gCommandLineSwitches["-meshload"]) then StartMeshLoaderTest() end -- =
journaltest
@@ -399,7 +401,9 @@
 		end } })
 =

 =

+	if (not gNoRender) then =

 	if (not(gMainMenuDialog)) then
 		gMainMenuDialog =3D guimaker.MakeTableDlg(rows,10,10,false,true,gGuiDefa=
ultStyleSet,"window") =

 	end
-end
+	end
+end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Tue Oct 28 18:23:15 2008
@@ -322,8 +322,10 @@
 	=

 	LoadingProfile("initializing Ogre",true)
 	gPreOgreTime =3D gLoadingProfileLastTime
-	if (not InitOgre("Iris2",gOgrePluginPathOverride or lugre_detect_ogre_plu=
gin_path(),"../bin/")) then Exit() end
-	CollectOgreResLocs()
+	if (not gNoOgre) then
+		if (not InitOgre("Iris2",gOgrePluginPathOverride or lugre_detect_ogre_pl=
ugin_path(),"../bin/")) then Exit() end
+		CollectOgreResLocs()
+	end
 	SetCursorBaseOffset(0,0)
 	=

 	------------------------------------------ obsolete, just for testing ---=
--------------------------------
@@ -441,7 +443,7 @@
 	if (gInGameStarted) then
 		StepUODragDrop()
 		UpdateCompass()
-		DisplayMemoryUsage(OgreMemoryUsage("all"))
+		if (not gNoOgre) then DisplayMemoryUsage(OgreMemoryUsage("all")) end
 		DisplayLoadingState()
 		PingStep()
 		gCurrentRenderer:MainStep()



From no-reply at zwischenwelt.org  Tue Oct 28 19:18:34 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Tue, 28 Oct 2008 18:18:34 -0000
Subject: [Iris-commit] [IRIS] r2667 - in /trunk: lua/lib.packetvideo.lua
	videos/
Message-ID: <20081028181834.40A551C18647@zwischenwelt.org>

Author: ghoulsblade
Date: Tue Oct 28 19:18:33 2008
New Revision: 2667

Log:
added videos dir for packetvideos

Added:
    trunk/videos/   (with props)
Modified:
    trunk/lua/lib.packetvideo.lua

Modified: trunk/lua/lib.packetvideo.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.packetvideo.lua (original)
+++ trunk/lua/lib.packetvideo.lua Tue Oct 28 19:18:33 2008
@@ -27,7 +27,9 @@
 gPacketVideoNoPlaybackPackets[kPacket_Target] =3D true
 gPacketVideoNoPlaybackPackets[kPacket_Open_Container] =3D true
 =

-gPacketVideoFileName =3D "../myvid.ipv"
+gPacketVideoFileName_folderpath	=3D "../videos/"
+gPacketVideoFileName_prefix		=3D gPacketVideoFileName_folderpath.."myvid."
+gPacketVideoFileName_postfix	=3D ".ipv"
 =

 =

 function PacketVideo_Recording_Toggle() =

@@ -35,7 +37,7 @@
 end
 =

 function PacketVideo_Recording_Start() =

-	gPacketVideoFileName =3D "../myvid."..(os.time() or Client_GetTicks()).."=
.ipv"
+	gPacketVideoFileName =3D gPacketVideoFileName_prefix..(os.time() or Clien=
t_GetTicks())..gPacketVideoFileName_postfix
 	PacketVideo_ClearData() =

 	gPacketVideoRecording =3D true =

 	PacketVideo_LogMap(MapGetMapIndex())
@@ -142,6 +144,9 @@
 end
 =

 function PacketVideo_Load	(filename)
+	local filename2 =3D gPacketVideoFileName_folderpath .. filename
+	if (file_exists(filename2)) then filename =3D filename2 end
+
 	PacketVideo_ClearData()
 	local fifo =3D CreateFIFO()
 	fifo:ReadFromFile(filename)



From no-reply at zwischenwelt.org  Wed Oct 29 18:41:43 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 29 Oct 2008 17:41:43 -0000
Subject: [Iris-commit] [IRIS] r2668 - in /trunk/lua: lib.macrolist.lua
 lib.uoutils.lua net/net.extended.lua net/net.generic.lua net/net.gump.lua
 net/net.main.lua net/net.other.lua net/net.text.lua
 widgets/widget.uoquickcasticon.lua
Message-ID: <20081029174144.390E01C18638@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 29 18:41:43 2008
New Revision: 2668

Log:
split net.other.lua into a few seperate files

Added:
    trunk/lua/net/net.extended.lua
    trunk/lua/net/net.generic.lua
    trunk/lua/net/net.gump.lua
    trunk/lua/net/net.text.lua
Modified:
    trunk/lua/lib.macrolist.lua
    trunk/lua/lib.uoutils.lua
    trunk/lua/net/net.main.lua
    trunk/lua/net/net.other.lua
    trunk/lua/widgets/widget.uoquickcasticon.lua

Modified: trunk/lua/lib.macrolist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.macrolist.lua (original)
+++ trunk/lua/lib.macrolist.lua Wed Oct 29 18:41:43 2008
@@ -276,6 +276,13 @@
 =

 -- doesn't sum stack-amount
 function MacroCmd_Item_CountByArtID	(artid,hue,container) local list =3D M=
acroCmd_Item_FindByArtID(artid,hue,container) return list and #list or 0 end
+function MacroCmd_Item_SumByArtID	(artid,hue,container) -- does sum stack
+	local list =3D MacroCmd_Item_FindByArtID(artid,hue,container) =

+	if (not list) then return 0 end
+	local c =3D 0
+	for k,item in pairs(list) do c =3D c + item.amount end
+	return c
+end
 =

 -- container defaults to player-backpack
 function MacroCmd_Item_FindByName	(itemnamepart,container)

Modified: trunk/lua/lib.uoutils.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoutils.lua (original)
+++ trunk/lua/lib.uoutils.lua Wed Oct 29 18:41:43 2008
@@ -67,3 +67,22 @@
 	text =3D string.gsub(text,"\223","ss")
 	return text
 end
+
+
+function UniCodeDualPop (fifo,number_of_unicode_chars)
+	--~ return input:PopUnicodeString(textlen) -- old, only asci part , TODO =
: see also PopUnicodeLEString
+	local ascipart =3D ""
+	local unicode_charcodes =3D {}
+	for i =3D 1,number_of_unicode_chars do
+		local head =3D fifo:PopUint8()
+		local data =3D fifo:PopUint8()
+		if (head ~=3D 0) then
+			ascipart =3D ascipart .. "?" .. (data ~=3D 0 and string.format("%c",dat=
a) or "")
+		else
+			ascipart =3D ascipart .. string.format("%c",data)
+		end
+		table.insert(unicode_charcodes,head*256 + data)
+	end
+	return ascipart,unicode_charcodes
+end
+

Modified: trunk/lua/net/net.main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.main.lua (original)
+++ trunk/lua/net/net.main.lua Wed Oct 29 18:41:43 2008
@@ -14,6 +14,10 @@
 dofile(libpath .. "net/net.aoscommand.lua")
 dofile(libpath .. "net/net.cursor.lua")
 dofile(libpath .. "net/net.other.lua")
+dofile(libpath .. "net/net.text.lua")
+dofile(libpath .. "net/net.generic.lua")
+dofile(libpath .. "net/net.gump.lua")
+dofile(libpath .. "net/net.extended.lua")
 dofile(libpath .. "net/net.securetrade.lua")
 dofile(libpath .. "net/net.trade.lua")
 =


Modified: trunk/lua/net/net.other.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.other.lua (original)
+++ trunk/lua/net/net.other.lua Wed Oct 29 18:41:43 2008
@@ -1,100 +1,8 @@
 -- packet handlers for all other packets that don't fit into the other cat=
egories
 -- see also lib.packet.lua and lib.protocol.lua
 -- see also net.popup.lua
-
-gGenericSubCommands =3D {}
-gGenericSubCommands.kPacket_Generic_SubCommand_FastWalkInit			=3D 0x01
-gGenericSubCommands.kPacket_Generic_SubCommand_FastWalkAddKey		=3D 0x02
-gGenericSubCommands.kPacket_Generic_SubCommand_CloseGenericGump		=3D 0x04
-gGenericSubCommands.kPacket_Generic_SubCommand_Screensize			=3D 0x05
-gGenericSubCommands.kPacket_Generic_SubCommand_PartySystem			=3D 0x06
-gGenericSubCommands.kPacket_Generic_SubCommand_QuestArrow			=3D 0x07
-gGenericSubCommands.kPacket_Generic_SubCommand_MapChange			=3D 0x08
-gGenericSubCommands.kPacket_Generic_SubCommand_DisarmRequest		=3D 0x09
-gGenericSubCommands.kPacket_Generic_SubCommand_AOSTooltip			=3D 0x10
---(0x0A) Sent by using the client Wrestle Stun Macro key in Options.
---This is no longer used since AoS was introduced. The Macro selection tha=
t used it was removed.
-gGenericSubCommands.kPacket_Generic_SubCommand_Wrestling_Stun		=3D 0x0A
-gGenericSubCommands.kPacket_Generic_SubCommand_ClientLanguage		=3D 0x0B	--=
 Client sends Client-language to Server
-gGenericSubCommands.kPacket_Generic_SubCommand_CloseStatus			=3D 0x0C
-gGenericSubCommands.kPacket_Generic_SubCommand_3DClientAction		=3D 0x0E	--=
 Client Sent. Server responds with Play Animation packets.
-gGenericSubCommands.kPacket_Generic_SubCommand_PopupRequest			=3D 0x13	-- =
Client -> Server packet
-gGenericSubCommands.kPacket_Generic_SubCommand_DisplayPopup			=3D 0x14
-gGenericSubCommands.kPacket_Generic_SubCommand_PopupEntrySelect		=3D 0x15
-gGenericSubCommands.kPacket_Generic_SubCommand_CodexOfWisdom		=3D 0x17
-gGenericSubCommands.kPacket_Generic_SubCommand_EnableMapDiff		=3D 0x18
-gGenericSubCommands.kPacket_Generic_SubCommand_ExtendedStats		=3D 0x19
-gGenericSubCommands.kPacket_Generic_SubCommand_ExtendedStats2		=3D 0x1A
-gGenericSubCommands.kPacket_Generic_SubCommand_NewSpellbook			=3D 0x1B	-- =
Create New Spellbook
-gGenericSubCommands.kPacket_Generic_SubCommand_SpellSelected		=3D 0x1C	-- =
Client -> Server packet ! Doppelclick auf Spell
-gGenericSubCommands.kPacket_Generic_SubCommand_RevisionCustomHouse	=3D 0x1=
D	-- Sends a house Revision number for handling client multi cache.
-															-- If revision is newer than what client has it asks for th=
e new multi packets to cache it.
-gGenericSubCommands.kPacket_Generic_SubCommand_HouseSerial			=3D 0x1E
-gGenericSubCommands.kPacket_Generic_SubCommand_Ability_Icon			=3D 0x21	-- =
nodata just (bf 00 05 21) , used together with weapon abilities / combat sk=
ills
-gGenericSubCommands.kPacket_Generic_SubCommand_OldDamage			=3D 0x22	-- Don=
e!
-gGenericSubCommands.kPacket_Generic_SubCommand_UnknownSE			=3D 0x24	-- Cli=
ent -> Server packet
-gGenericSubCommands.kPacket_Generic_SubCommand_EnableSESpellIcons	=3D 0x25
-gGenericSubCommands.kPacket_Generic_SubCommand_SpeedMode			=3D 0x26
-gGenericSubCommands.kPacket_Generic_SubCommand_NewRaceGender		=3D 0x2A
-gGenericSubCommands.kPacket_Generic_SubCommand_IrisInfo				=3D 0xA0 -- iri=
s-special, for iris aware servers
---[[
--race_gender-packet
-Client -> Server =

-BYTE 	0xBF =

-WORD 	Length ( 15 ) =

-WORD 	Subcommand - 0x2A =

-WORD 	BodyHue =

-WORD 	HairId =

-WORD 	HairHue =

-WORD 	BeardId =

-WORD 	BeardHue
-]]--
-gGenericSubCommands.kPacket_Generic_SubCommand_BandageTarget		=3D hex2num(=
"0x2C")	-- Client -> Server packet,For use with the new Bandage Self client=
 macro. Introduced in 5.0.4x
-
-function SendBandageSelf (bandageid) return SendBandageCommand(bandageid,G=
etPlayerSerial()) end
-function SendBandageCommand (bandageid,targetid) =

-	if (not bandageid) then
-		local bandage =3D MacroCmd_Item_FindFirstByArtID(3617,0) -- find bandage=
 in backpack
-		if (not bandage) then return end
-		bandageid =3D bandage.serial
-	end
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(0x0D) -- packet size
-	out:PushNetUint16(kPacket_Generic_SubCommand_BandageTarget) -- 2C
-	out:PushNetUint32(bandageid)
-	out:PushNetUint32(targetid)
-	out:SendPacket()
-	-- 0000   BF 00 0D 00 2C 41 3D BC  CD 00 0D BA 5B            ....,A=3D...=
..[
-	-- kPacket_Generic_SubCommand_BandageTarget=3D0x2D : bandages=3D0x413dbcc=
d targetid=3D0x000dba5b
-	return true
-end
-
-
---[[
---new sincec KR
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse =3D he=
x2num("0x2F")	-- BF.2F - KR House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_defaul=
t =3D hex2num("0x63")	--BF.2F.63 - KR Default House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_pubpri=
v =3D hex2num("0x65")	--BF.2F.65 - KR Change Public/Private House Menu Gump=
 Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_conver=
t =3D hex2num("0x66")	--BF.2F.66 - KR Convert into the customizable House M=
enu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_reloca=
te=3D hex2num("0x68")	--BF.2F.68 - KR Relocate Moving Crate House Menu Gump=
 Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_sign	=
=3D hex2num("0x69")	--BF.2F.69 - KR Change Sign House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_hanger=
	=3D hex2num("0x6A")	--BF.2F.6A - KR Change Sign Hanger House Menu Gump Res=
ponse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_post	=
=3D hex2num("0x6B")	--BF.2F.6B - KR Change Sign Post House Menu Gump Respon=
se
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_founda=
tion=3D hex2num("0x6C")	--BF.2F.6C - KR Change Foundation Style House Menu =
Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_rename=
	=3D hex2num("0x6D")	--BF.2F.6D - KR Rename House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_demoli=
sh=3D hex2num("0x6E")	--BBF.2F.6E - KR Demolish House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_trade	=
=3D hex2num("0x6F")	--BF.2F.6F - KR Trade House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_primar=
y	=3D hex2num("0x70")	--BF.2F.70 - KR Make Primary House Menu Gump Response
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_coowne=
r	=3D hex2num("0x71")	--BF.2F.71 - KR Change To Co-Owner House Menu Gump Re=
sponse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_friend=
	=3D hex2num("0x72")	--BF.2F.72 - KR Change To Friend House Menu Gump Respo=
nse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_access=
	=3D hex2num("0x73")	--BF.2F.73 - KR Change To Access House Menu Gump Respo=
nse
-gGenericSubCommands.kPacket_Generic_SubCommand_KR_HouseGumpResponse_primar=
y	=3D hex2num("0x74")	--BF.2F.74 - KR Ban House Menu Gump Response
---a.s.o. to BF.2F.80
-gGenericSubCommands.kPacket_Generic_SubCommand_TargetbyResource		=3D hex2n=
um("0x30")	---BF.30 - KR Target By Resource Macro
-]]--
-gGenericSubCommandNamesByID =3D {}
-for k,v in pairs(gGenericSubCommands) do _G[k] =3D v gGenericSubCommandNam=
esByID[v] =3D k end
+-- see also net.generic.lua
+-- see also net.extended.lua
 =

 gActWarmode =3D 0
 		=

@@ -117,379 +25,8 @@
 	--print("PingPong")
 end
 =

--- triggers -- which came from kPacket_Generic_SubCommand_DisplayPopup
-function Send_PopupRequest (serial)
-	--- if there is already one open, close it
-	if gPopupMenu ~=3D nil then gPopupMenu:Close() end
-	gRunningPopupRequestTimeOut =3D gMyTicks + kRunningPopupRequestTimeOutInt=
erval
-
-	gPopupMenuSavedPosX,gPopupMenuSavedPosY =3D GetMousePos() -- TODO : maybe=
 save mousepos at the time of contextrequest ?
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(hex2num("0x09")) -- packet size
-	out:PushNetUint16(kPacket_Generic_SubCommand_PopupRequest) -- Popup Reque=
st Sub-Command
-	out:PushNetUint32(serial) -- Popup Request Sub-Command
-	out:SendPacket()
-end
-
--- sends kPacket_Generic_SubCommand_PopupEntrySelect after the user has ch=
oosen an answer to the popup
--- which came from kPacket_Generic_SubCommand_DisplayPopup
--- see also SendPopupChoice() from old iris
-function Send_PopupAnswer (popupserial,entrytag)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(hex2num("0x0B")) -- packet size
-	out:PushNetUint16(kPacket_Generic_SubCommand_PopupEntrySelect) -- Popup R=
equest Sub-Command
-	out:PushNetUint32(popupserial)
-	out:PushNetUint16(entrytag)
-	out:SendPacket()
-end
-
--- sends the server the lock state of one stat
--- stat (0=3Dstr, 1=3Ddex, 2=3Dint)
--- lockstate (0=3Dup, 1=3Ddown, 2=3Dlocked)
-function Send_StatsLockState(stat, lockstate)
-	-- print("DEBUG","Send_StatsLockState",stat,lockstate)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(7)
-	out:PushNetUint16(kPacket_Generic_SubCommand_ExtendedStats2)
-	out:PushNetUint8(stat)
-	out:PushNetUint8(lockstate)
-	out:SendPacket()
-end
-
-kPacket_ExtSubCommand_PartyQueryPos		=3D 0x00
-kPacket_ExtSubCommand_PartyPosAck		=3D 0x01
-
--- answer : kPacket_ExtBundledPacket
-function	PartySendQueryPos () =

-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_ExtBundledPacket) -- 0xF0
-	out:PushNetUint16(4)
-	out:PushNetUint8(kPacket_ExtSubCommand_PartyQueryPos)  =

-	out:SendPacket()
-end
-
-
--- party positon, has to be requested regularly : PartySendQueryPos
-function gPacketHandler.kPacket_ExtBundledPacket() -- 0xF0
-	local input =3D GetRecvFIFO()
-	local popped_start =3D input:GetTotalPopped()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local subcmd =3D input:PopNetUint8()
-	=

-	if (subcmd =3D=3D kPacket_ExtSubCommand_PartyPosAck) then
-		local partyposlist =3D {}
-		while (true) do
-			local memberpos =3D {}
-			memberpos.serial	=3D input:PopNetUint32()
-			if (memberpos.serial =3D=3D 0) then break end -- termination
-			memberpos.xloc		=3D input:PopNetUint16()
-			memberpos.yloc		=3D input:PopNetUint16()
-			memberpos.facet		=3D input:PopNetUint8() -- mapid
-			--~ print("partypos",memberpos.serial,memberpos.xloc,memberpos.yloc,mem=
berpos.facet)
-			partyposlist[memberpos.serial] =3D memberpos
-		end
-		NotifyListener("Hook_PartyPos",partyposlist) -- {[serial]=3D{serial=3D?,=
xloc=3D?,yloc=3D?,facet=3D?},...}
-	end
-	=

-
-	-- check if all data was used
-	local used =3D input:GetTotalPopped() - popped_start
-	local rest =3D size - used
-	if (rest < 0) then
-		printf("FATAL ! kPacket_ExtBundledPacket : subcmd 0x%02x (used=3D%d size=
=3D%d) popped too much\n",subcmd,used,size)
-		print("FATAL ! kPacket_ExtBundledPacket -> forced Crash")
-		Crash()
-	end
-	if (rest > 0) then
-		printf("WARNING ! kPacket_ExtBundledPacket : subcmd 0x%02x (used=3D%d si=
ze=3D%d) popped to few\n",subcmd,used,size)
-		input:PopRaw(rest)
-	end
-end
-
-
-
-
-
-
-
-
--- TODO : implement all subpackets
-function gPacketHandler.kPacket_Generic_Command()
-	local input =3D GetRecvFIFO()
-	local popped_start =3D input:GetTotalPopped()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local subcmd =3D input:PopNetUint16()
-	--~ printf("NET: kPacket_Generic_Command size=3D0x%04x subcmd=3D0x%04x=3D=
%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd]))
-	printdebug("net",sprintf("NET: kPacket_Generic_Command size=3D0x%04x subc=
md=3D0x%04x=3D%s\n",size,subcmd,tostring(gGenericSubCommandNamesByID[subcmd=
])))
-
-	-- FastWalkInit : 6 keys (runuo's fifosize 0-255)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_FastWalkInit) then -- 0x01
-		local keys =3D {}
-		for i =3D 1,6 do table.insert(keys,input:PopNetUint32()) end
-		FastWalk_Init(keys)
-	end
-
-	-- FastWalkAddKey
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_FastWalkAddKey) then
-		FastWalk_PushKey(input:PopNetUint32())
-	end
-
-	--Subcommand 4: "Close Generic Gump" =

-	--BYTE[4] dialogID // which gump to destroy (second ID in 0xB0 packet) =

-	--BYTE[4] buttonId // response buttonID for packet 0xB1
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_CloseGenericGump) then -- 0x=
04
-		local dialogId =3D input:PopNetUint32()
-		local buttonId =3D (size >=3D 5+4+4) and input:PopNetUint32() or 0
-		local playermobile =3D GetPlayerMobile()
-		CloseServerSideGump(playermobile.serial,dialogId,buttonId)
-		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_CloseGenericGu=
mp (0xbf sub=3D0x04)"))
-	end
-
-	-- Party System
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_PartySystem) then -- 0x06
-		HandlePartySystemMessage(input,size)
-	end
-
-	-- Quest Arrow (mobile)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_QuestArrow) then --0x07
-		-- TODO: check ... specification is: byte - Right Click (1=3Dyes, 0=3Dno)
-		for i =3D 0, size-6 do
-			local temp =3D input:PopNetUint8()
-			print("NET (todo): 0xbf Quest_Arrow subcmd 0x07: "..temp)
-		end
-	end
-
-	-- Map Change
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_MapChange) then -- 0x08
-		local mapid =3D input:PopNetUint8()
-		MapChangeRequest(mapid)
-	end
-
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_CloseStatus) then	--0x0C
-		local mobilestatus_serial =3D input:PopNetUint8()
-		CloseHealthbar(mobilestatus_serial)
-	end
-
-	-- AOSTooltip
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_AOSTooltip) then -- 0x10
-		local objserial =3D input:PopNetUint32()
-		local listID =3D input:PopNetUint32()
-		printdebug("net", sprintf("0xbf sub: kPacket_Generic_SubCommand_AOSToolt=
ip objserial=3D0x%08x listID=3D0x%08x\n",
-									objserial,listID) )
-		Send_AosToolTipRequest(objserial)
-	end
-
-	-- display popup
-	-- TODO : check if PopUp is already opened - use a popuplist with serials=
 !?
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_DisplayPopup) then -- 0x14
-		local popupmenu =3D {}
-		popupmenu.unknown		=3D input:PopNetUint16() -- always 0x0001
-		popupmenu.serial		=3D input:PopNetUint32()
-		popupmenu.numentries	=3D input:PopNetUint8() -- Number of entries in the=
 popup
-		popupmenu.entries		=3D {}
-		for i =3D 1, popupmenu.numentries do =

-			local entry =3D {}
-			entry.popupmenu =3D popupmenu
-			entry.tag		=3D input:PopNetUint16() -- Entry Tag (this will be returned=
 by the client on selection)
-			entry.textid	=3D input:PopNetUint16() -- ID is the file number for intl=
oc#.language e.g intloc6.enu and the index into that
-			entry.text 		=3D GetPopupEntryText(entry.textid) or "unknown"
-			entry.flags		=3D input:PopNetUint16() -- 0x01 =3D locked, 0x02 =3D arro=
w, 0x20 =3D color
-			if (TestBit(entry.flags,kPopupEntryFlag_Color)) then
-				entry.color	=3D input:PopNetUint16() =

-				-- rgb 1555 color (ex, 0 =3D transparent, 0x8000 =3D solid black, 0x1F=
 =3D blue, 0x3E0 =3D green, 0x7C00 =3D red)
-			else
-				entry.color	=3D 0
-			end
-			popupmenu.entries[i] =3D entry
-		end
-		=

-		DisplayPopupMenu(popupmenu) -- see net.popup.lua
-		NotifyListener("Hook_OpenPopupMenu",popupmenu)	=

-	end
-
-	-- enable diff files for felucca,trammel,ilshenar,malas
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableMapDiff) then -- 0x18
-		local mapnumbers =3D input:PopNetUint32()
-		local myEnableDiff =3D {}
-		for i =3D 0, mapnumbers-1 do
-			myEnableDiff[i] =3D {}
-			myEnableDiff[i].iNumPatchesMap 		=3D input:PopNetUint32() -- Number of =
map patches in this map
-			myEnableDiff[i].iNumPatchesStatic	=3D input:PopNetUint32() -- Number of=
 static patches in this map
-		end
-		EnableDiff(myEnableDiff) -- see lib.diff.lua
-	end
-	=

-	-- States LockInfo	-- bonded status
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_ExtendedStats) then -- 0x19
-		local party_cmd =3D input:PopNetUint8()
-		--~ print("kPacket_Generic_SubCommand_ExtendedStats",party_cmd)
-		if (party_cmd =3D=3D hex2num("0x00")) then
-			local party_serial =3D input:PopNetUint32()
-			local party_value  =3D input:PopNetUint8()
-			--printf("NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x p=
arty_value: 0x%02x\n",party_cmd,party_serial,party_value)
-		end
-		-- statlock info
-		--[[
-			sent by server SERVER
-			Subcommand: 0x19: Extended stats
-			BYTE[1] type // always 2 ? never seen other value
-			BYTE[4] serial
-			BYTE[1] unknown // always 0 ?
-			BYTE[1] lockBits // Bits: XXSS DDII (s=3Dstrength, d=3Ddex, i=3Dint), 0=
 =3D up, 1 =3D down, 2 =3D locked
-		]]--
-		if (party_cmd =3D=3D hex2num("0x02")) then
-			local serial =3D input:PopNetUint32()
-			local value  =3D input:PopNetUint8()
-			local lockflags  =3D input:PopNetUint8()
-			local int =3D BitwiseAND(BitwiseSHR(lockflags, 0), 3)
-			local dex =3D BitwiseAND(BitwiseSHR(lockflags, 2), 3)
-			local str =3D BitwiseAND(BitwiseSHR(lockflags, 4), 3)
-			=

-			local mobile =3D GetMobile(serial)
-			if mobile then
-				mobile:UpdateStatsLockState(str, dex, int)
-			else
-				print("NET: got statsLockStats from unknown mobile", serial, str, dex,=
 int)
-			end
-			=

-			-- printf("NET: States LockInfo party_cmd: 0x%02x party_serial: 0x%08x =
party_value: 0x%02x party_lockflags: 0x%02x\n",party_cmd,party_serial,party=
_value,party_lockflags)
-		end
-		if (party_cmd =3D=3D hex2num("0x1a")) then
-			local party_stattype  =3D input:PopNetUint8()
-			local party_lockvalue  =3D input:PopNetUint8()
-			--printf("NET: States LockInfo party_cmd: 0x%02x party_stattype: 0x%02x=
 party_lockvalue: 0x%02x\n",party_cmd,party_stattype,party_lockvalue)
-		end
-	end
-
-	-- first bit of first byte =3D spell #1, second bit of first byte =3D spe=
ll #2, first bit of second byte =3D spell #8, etc
-	-- Create Spellbook Container
-	-- matix 0xff030000
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_NewSpellbook) then -- 0x1B
-		local spellbook =3D {}
-		spellbook.old=3Dfalse
-		spellbook.matrix =3D {}
-		spellbook.unknown =3D input:PopNetUint16()
-		spellbook.serial =3D input:PopNetUint32()
-		spellbook.itemid =3D input:PopNetUint16()
-		spellbook.scrolloffset =3D input:PopNetUint16()	-- 1=3D=3Dregular, 101=
=3Dnecro, 201=3Dpaladin, 401=3Dbushido, 501=3Dninjitsu, 601=3Dspellweaving
-		spellbook.matrix[1] =3D input:PopNetUint8()
-		spellbook.matrix[2] =3D input:PopNetUint8()
-		spellbook.matrix[3] =3D input:PopNetUint8()
-		spellbook.matrix[4] =3D input:PopNetUint8()
-		spellbook.matrix[5] =3D input:PopNetUint8()
-		spellbook.matrix[6] =3D input:PopNetUint8()
-		spellbook.matrix[7] =3D input:PopNetUint8()
-		spellbook.matrix[8] =3D input:PopNetUint8()
-		print("kPacket_Generic_SubCommand_NewSpellbook",spellbook.scrolloffset,s=
pellbook.unknown,spellbook.serial,spellbook.itemid)
-		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_NewSpellbook s=
erial=3D0x%08x itemId=3D0x%04x offset=3D0x%04x\n",
-								spellbook.serial, spellbook.itemid, spellbook.scrolloffset))
-		Open_Spellbook(spellbook)
-	end
-
-	--Enable/Disable SE Spell Icons
-	--OnCastSuccessful(spellid), OnEffectEnd (spellid), ClearCurrentMove, Cle=
arAllMoves, SetCurrentMove
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_EnableSESpellIcons) then -- =
0x25
-		local temp =3D input:PopNetUint8()		--always 1
-		local abilityID =3D input:PopNetUint8()	--abilityID
-		local active =3D input:PopNetUint8()		--0/1 On/Off
-		printf("ABILITY\tSE Spell Icons abilityID: 0x%02x active: 0x%02x\n", abi=
lityID, active)
-	end
-
-	-- Subcommand 0x21: (AOS) weapon-Ability icon confirm/end.  see also Send=
_AOSCommand_WeaponAbility
-	-- Note: no data, just (bf 00 05 21) =

-	if (subcmd =3D=3D kPacket_Generic_SubCommand_Ability_Icon) then	-- 0x21
-		EndWeaponAbility()
-		NotifyListener("Hook_Deactivate_Ability")
-	end
-
-	-- Receives a CustomHouse Serial & Revision Hash Number
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_RevisionCustomHouse) then	--=
 0x1D
-		local customhouseserial =3D input:PopNetUint32()
-		local customhouserevision =3D input:PopNetUint32()
-		printdebug("net",sprintf("NET: kPacket_Generic_SubCommand_RevisionCustom=
House customhouseserial=3D0x%08x customhouserevision=3D0x%08x\n",
-								customhouseserial, customhouserevision))
-
-		local dyn =3D GetDynamic(customhouseserial)
-		-- check if houserevision exists
-		if (dyn) then
-			if (dyn.customhouserevision) then
-				-- compare new_houserevisiont with old_houserevision, if different cha=
nge to new
-				if (customhouserevision~=3Ddyn.customhouserevision) then
-					Send_CustomHouseRevision(customhouseserial)
-					printdebug("net",sprintf("NET: old-customhouse -> request new revisio=
n\n"))
-				end
-			else
-				Send_CustomHouseRevision(customhouseserial)
-				printdebug("net",sprintf("NET: old-customhouse -> request new revision=
\n"))
-			end
-		end
-	end
-
-	-- old-damage receive packet	(not used by RunUO?)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_OldDamage)	then	-- 0x22
-		local olddamage_temp  =3D input:PopNetUint8()	-- always 1	?
-		local olddamage_serial =3D input:PopNetUint32()
-		local olddamage_amount =3D input:PopNetUint8()
---		printf("NET: Generic_SubCommand_OldDamage: mobile-serial: 0x%08x Damag=
e_Amount: %i\n",olddamage_serial,olddamage_amount)
-		if (olddamage_serial =3D=3D gPlayerBodySerial) then
-			GuiAddChatLine(sprintf("%s",olddamage_amount).." Damage received")
-		else
-			GuiAddChatLine(sprintf("%s",olddamage_amount).." Damage done")
-		end
-		=

-		-- show fading damage over the mobile
-		-- TODO totally untested
-		gCurrentRenderer:NotifyDamage(olddamage_serial,olddamage_amount)
-	end
-
-	--Speed Mode: 0x0 =3D Normal movement, 0x1 =3D Fast movement, 0x2 =3D Slo=
w movement, 0x3 and above =3D Hybrid movement
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_SpeedMode) then -- 0x26
-		local speedboost =3D input:PopNetUint8()	--0/1 On/Off
-		--printf("NET: Speed Mode	Speedboost: %i\n",speedboost)
-	end
-	=

-	--nerw Race/Gender packet (since Elfes) Lenght (7bytes)
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_NewRaceGender) then -- 0x2a
-		local player_gender =3D input:PopNetUint8()
-		local player_race =3D input:PopNetUint8()
---		printf("NET: Gender: %s Race: %s\n", gGender[player_gender], gRace[pla=
yer_race])
-	end
-	=

-	-- iris info request, only sent by iris aware servers
-	if (subcmd =3D=3D kPacket_Generic_SubCommand_IrisInfo) then
-		Send_IrisInfo()
-	end
-
-	-- check if all data was used
-	local used =3D input:GetTotalPopped() - popped_start
-	local rest =3D size - used
-	if (rest < 0) then
-		printf("FATAL ! kPacket_Generic_Command : subcmd 0x%02x (used=3D%d size=
=3D%d) popped too much\n",subcmd,used,size)
-		print("FATAL ! kPacket_Generic_Command -> forced Crash")
-		Crash()
-	end
-	if (rest > 0) then
-		printf("WARNING ! kPacket_Generic_Command : subcmd 0x%02x (used=3D%d siz=
e=3D%d) popped to few\n",subcmd,used,size)
-		input:PopRaw(rest)
-	end
-end
-
-
--- sends iris specific infos to the server, in response to kPacket_Generic=
_SubCommand_IrisInfo
-function Send_IrisInfo()
-	print("Send_IrisInfo")
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Command)
-	out:PushNetUint16(0x06)
-	out:PushNetUint16(kPacket_Generic_SubCommand_IrisInfo) -- 0x00A0
-	out:PushNetUint8(0x01)
-	out:SendPacket()
-end
+
+
 =

 -- answered by kPacket_Change_Update_Range from server
 function Send_UpdateRangeRequest(range)	-- 0xC8
@@ -532,31 +69,6 @@
 end
 =

 =

-
--- request profile 0xB8
-function Send_RequestCharacterProfile()
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Character_Profile)
-	out:PushNetUint16(8)
-	out:PushNetUint8(0)
-	out:PushNetUint32(GetPlayerSerial())
-	out:SendPacket()
-end
-
-
--- servers answer to Send_RequestCharacterProfile() 0xB8
-function gPacketHandler.kPacket_Character_Profile () -- 0xB8
-	local input =3D GetRecvFIFO()
-	local id		=3D input:PopNetUint8()
-	local size		=3D input:PopNetUint16()
-	local data =3D {}
-	data.serial	=3D input:PopNetUint32()
-	data.title,size =3D FIFO_PopZeroTerminatedString(input,size)
-	data.pstatic_plaintext,data.pstatic_unicodebytearr,size =3D FIFO_PopZeroT=
erminatedUnicode(input,size) -- static profile (can't be edited)
-	data.p_plaintext,data.p_unicodebytearr,size =3D FIFO_PopZeroTerminatedUni=
code(input,size) -- profile (can be edited)
-	print("kPacket_Character_Profile : todo:nice gump")
-	GuiAddChatLine ("Character Profile:"..data.title..","..data.pstatic_plain=
text..","..data.p_plaintext)
-end
 =

 =

 --[[
@@ -591,297 +103,6 @@
 								map_serial, map_cmd, map_plot_state, map_plot_x, map_plot_y) )
 end
 =

--- Text (Speech) receive 0x1C
--- Pol use thi spacket to send names when you single click on items or NPC=
s. OSI's method uses 0xC1
--- TODO : handle System messages
-function gPacketHandler.kPacket_Text ()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local mobile_serial =3D input:PopNetUint32()
-	local text_item_model =3D input:PopNetUint16() -- model ? artid ?
-	local text_type =3D input:PopNetUint8()
-	local text_color =3D input:PopNetUint16()
-	local text_font =3D input:PopNetUint16()
-	local text_charname =3D input:PopFilledString(30)
-	local text_message =3D input:PopFilledString(size-44)
-	=

-	Mobile_NameHint(mobile_serial,text_item_model,text_charname,text_message)
-
-	-- check if System Message
-	if (mobile_serial =3D=3D hex2num("0xffffffff") and text_item_model =3D=3D=
 hex2num("0xffff")) then
-		printdebug("net",sprintf("NET: System Message %s:%s\n",text_charname,tex=
t_message) )
-	end
-
-	printdebug("net",sprintf("NET: Text id: 0x%08x model id: 0x%08x Message: =
%s\n",mobile_serial,text_item_model,text_message) )
-	local plaintext =3D string.gsub(text_message,"<br>","\n")
-	plaintext =3D UnicodeFix(plaintext)
-	GuiAddChatLine(sprintf("%s: %s",text_charname,plaintext)) -- TODO : color=
,font,...
-	JournalAddText(text_charname,plaintext)
-	NotifyListener("Hook_Text",text_charname,plaintext)
-	=

-	-- check if player -> then show text over player head
-	local mobilespeaker=3DGetMobile(mobile_serial)
-	if (mobilespeaker) then mobilespeaker:NoZombie() mobilespeaker:DisplayTex=
tOverHead(string.gsub(text_message,"<br>","\n"),Uo16Color2Rgb(text_color)) =
end
-	-- TODO : text_item ?!?
-	NotifyListener("Hook_Packet_Text",mobile_serial,plaintext)
-	NotifyListener("Hook_MobName",mobile_serial,text_charname)
-end
-
-
--- server requests text entry 0xC2, e.g. rename rune
-function gPacketHandler.kPacket_Unicode_Text_Entry ()
-	local input =3D GetRecvFIFO()
-	local id	=3D input:PopNetUint8()	-- 1
-	local size	=3D input:PopNetUint16()	-- 2
-	local data =3D {}
-	data.player_serial		=3D input:PopNetUint32()
-	data.message_id			=3D input:PopNetUint32()
-	gUnicodeTextEntryRequest =3D data
-	size =3D size - 11
-	input:PopRaw(size) -- 10 zero-bytes usually
-	print("kPacket_Unicode_Text_Entry request")
-end
-
-
--- 0xC2, like the request, see above
--- TODO : real unicode support
-function Send_Unicode_Text_Entry (text)
-	local out =3D GetSendFIFO()
-	local textlen =3D string.len(text)
-	local unicode_bytelen =3D textlen*2
-	local size =3D 1 + 2 + 4 + 4 + 4 + 3 + unicode_bytelen + 1
-	out:PushNetUint8(kPacket_Unicode_Text_Entry)
-	out:PushNetUint16(size)
-	out:PushNetUint32(gUnicodeTextEntryRequest.player_serial)
-	out:PushNetUint32(gUnicodeTextEntryRequest.message_id)
-	out:PushNetUint32(1)
-	out:PushFilledString(gLanguage or "ENU",3)
-	for i =3D 1 , textlen do
-		out:PushNetUint16(string.byte(text,i))
-	end
-	out:PushNetUint8(0) -- zero termination ??
-	gUnicodeTextEntryRequest =3D nil -- clear request
-	print("Send_Unicode_Text_Entry",text)
-	out:SendPacket()
-end
-
-
--- response =3D 0x9a as well
-function gPacketHandler.kPacket_Text_Entry () -- 0x9a =

-	local input =3D GetRecvFIFO()
-	local id	=3D input:PopNetUint8()	-- 1
-	local size	=3D input:PopNetUint16()	-- 2
-	local data =3D {}
-	data.player_serial		=3D input:PopNetUint32() -- pol:objectID
-	data.message_id			=3D input:PopNetUint32() -- pol:prompt#
-	data.reply				=3D input:PopNetUint32() -- pol:0=3Drequest/esc, 1=3Dreply
-	gPlaintextTextEntryRequest =3D data
-	size =3D size - 15
-	input:PopRaw(size) -- 10 zero-bytes usually
-end
-
-
-function Send_Plain_Text_Entry (text) =

-	local out =3D GetSendFIFO()
-	local textlen =3D string.len(text)
-	local size =3D 1 + 2 + 4 + 4 + 4 + textlen + 1
-	out:PushNetUint8(kPacket_Text_Entry)
-	out:PushNetUint16(size)
-	out:PushNetUint32(gPlaintextTextEntryRequest.player_serial)
-	out:PushNetUint32(gPlaintextTextEntryRequest.message_id)
-	out:PushNetUint32(1)
-	out:PushFilledString(text,textlen)
-	out:PushNetUint8(0) -- zero termination
-	gPlaintextTextEntryRequest =3D nil -- clear request
-	print("Send_Plain_Text_Entry",text)
-	out:SendPacket()
-end
-
--- aka Cliloc Message Affix  : see also http://docs.polserver.com/packets/=
index.php?Packet=3D0xCC
--- e.g. skilltrainer npc says how much gold he wants
-function gPacketHandler.kPacket_Localized_Text_Plus_String () -- 0xCC
-	local input =3D GetRecvFIFO()
-	local id				=3D input:PopNetUint8()	-- 1
-	local size				=3D input:PopNetUint16()	-- 2
-	local data =3D {}
-	data.speaker_serial		=3D input:PopNetUint32()	-- 4 (0xffff for system mes=
sage)
-	data.speaker_body		=3D input:PopNetUint16()	-- 2 (0xff for system message)
-	data.speaker_align		=3D input:PopNetUint8()	-- 1 type (6 - lower left, 7 =
on player)
-	data.hue				=3D input:PopNetUint16()	-- 2
-	data.font				=3D input:PopNetUint16()	-- 2
-	data.cliloc_id			=3D input:PopNetUint32()	-- 4
-	data.flags				=3D input:PopNetUint8() 	-- 1
-	data.speaker_name		=3D input:PopFilledString(30)	=

-	size =3D size - 49
-	=

-	local mobile =3D GetMobile(data.speaker_serial) if (mobile) then mobile:N=
oZombie() end
-	-- flags : (0x02 is unknown, 0x04 signals the message doesn't move on scr=
een) =

-	=

-	=

-	local affixlen =3D size
-	for i =3D 0,size-1 do if (input:PeekNetUint8(i) =3D=3D 0) then affixlen =
=3D i + 1 break end end -- search zero terminator
-	=

-	data.affixlen		=3D affixlen	=

-	data.text_affix		=3D input:PopFilledString(affixlen) --  null terminated	=

-	size =3D size - affixlen
-	data.paramlen		=3D size	=

-	=

-	--~ BYTE[?]*2] arguments; // _big-endian_ unicode string, tabs ('\t') sep=
erate arguments, see 0xC1 for argument example
-	data.text_params	=3D (size >=3D 2) and input:PopUnicodeString(size / 2) o=
r ""
-	data.text_base 		=3D gClilocLoader and gClilocLoader:Get(data.cliloc_id) =
or ("unknown_cliloc_"..data.cliloc_id)
-	data.plaintext 		=3D ParameterizedClilocText(data.cliloc_id,strsplit("\t"=
,data.text_params))
-	=

-	if (TestBit(data.flags,0x01)) then
-		data.plaintext =3D data.text_affix .. data.plaintext  -- prepend
-	else =

-		data.plaintext =3D data.plaintext .. data.text_affix  -- appended
-	end
-	=

-	-- todo : this is a hack to get unicode somewhat readable, no real unicod=
e support
-	data.plaintext =3D UnicodeFix(data.plaintext)
-	=

-	-- output
-	=

-	local name =3D data.speaker_name
-	local plaintext =3D data.plaintext
-	=

-	if string.len(name) > 0 then =

-		GuiAddChatLine(sprintf("%s: %s",name,plaintext)) -- TODO : color,font,...
-	else
-		GuiAddChatLine(plaintext) -- TODO : color,font,...
-	end
-	JournalAddText(name,plaintext)
-	NotifyListener("Hook_Text",name,plaintext)
-	NotifyListener("Hook_MobName",data.speaker_serial,name)
-	=

-	--~ print("kPacket_Localized_Text_Plus_String")
-	--~ for k,v in pairs(data) do print("++",k,v) end
-end
-
-
--- Predefined Message (localized Message) 0xC1
-function gPacketHandler.kPacket_Localized_Text ()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local text_item_serial =3D input:PopNetUint32() -- (0xffffffff for system=
 message)
-	local text_item_model =3D input:PopNetUint16() -- (0xffff for system mess=
age)
-	local text_type =3D input:PopNetUint8() -- see "Text types" in lib.uoids.=
lua
-	local text_color =3D input:PopNetUint16()
-	local text_font =3D input:PopNetUint16()
-	local text_messagenum =3D input:PopNetUint32()
-	local text_charname =3D input:PopFilledString(30)
-	local text_params =3D input:PopUnicodeLEString((size - 48 - 2)/2)	--littl=
e-endian_ unicode string, tabs ('\t') seperate the arguments. Null Terminat=
ed 0x0000
-	local text_terminator =3D input:PopNetUint16() -- probably the seperator =
unicode char for text_params, "\t" is hardcoded below, string.char(math.flo=
or(terminator)/256)
-	=

-	local plaintext =3D string.gsub(ParameterizedClilocText(text_messagenum,s=
trsplit("\t",text_params)),"<br>","\n")
-	--~ print("kPacket_Localized_Text",plaintext)
-	=

-	-- TODO : Display as TOOLTIP !
-	plaintext =3D UnicodeFix(plaintext)
-	=

-	local show_below =3D true	-- display as fadeline
-	local show_journal =3D true	-- display in journal
-	=

-	local mobile =3D GetMobile(text_item_serial) if (mobile) then mobile:NoZo=
mbie() end
-	=

-	if text_type =3D=3D kTextType_Label then	-- label
-		show_journal =3D false
-		if GetMobile(text_item_serial) then
-			Mobile_SetName(text_item_serial, text_charname, plaintext)
-			show_below =3D false
-		end
-	end
-	=

-	if show_below then
-		if string.len(text_charname) > 0 then =

-			GuiAddChatLine(sprintf("%s: %s",text_charname,plaintext)) -- TODO : col=
or,font,...
-		else
-			GuiAddChatLine(plaintext) -- TODO : color,font,...
-		end
-	end
-	=

-	if show_journal then
-		JournalAddText(text_charname,plaintext)
-	end
-	=

-	NotifyListener("Hook_Text",text_charname,plaintext)
-	NotifyListener("Hook_Packet_Localized_Text",text_item_serial,plaintext,te=
xt_messagenum,text_type)
-	NotifyListener("Hook_MobName",text_item_serial,plaintext,text_messagenum)
-	=

-	-- print("###",text_item_serial,text_item_model,text_type,text_color,text=
_charname,text_params,text_terminator)
-end
-
---server response packet for kPacket_Speech_Unicode (0xAD)
-function gPacketHandler.kPacket_Text_Unicode()
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local unitext_size =3D input:PopNetUint16()
-	local mobile_serial =3D input:PopNetUint32()
-	local unitext_item_model =3D input:PopNetUint16()
-	local unitext_type =3D input:PopNetUint8()
-	local unitext_hue =3D input:PopNetUint16()	=

-	local unitext_font =3D input:PopNetUint16()
-	local unitext_lang =3D input:PopNetUint32()
-	local unitext_name =3D input:PopFilledString(30)
-	local unitext_message,unitext_message_unicode_charcodes =3D UniCodeDualPo=
p(input,(unitext_size-48)/2)
-
-	local show_below =3D true	-- display as fadeline
-	local show_journal =3D true	-- display in journal
-	=

-	unitext_message =3D UnicodeFix(unitext_message)
-
-	local r,g,b =3D 1,1,1
-	=

-	=

-	if unitext_type =3D=3D kTextType_Normal then r,g,b =3D 1,1,1 end
-	if unitext_type =3D=3D kTextType_System then r,g,b =3D 0,0,1 end
-	if unitext_type =3D=3D kTextType_Emote then r,g,b =3D 0,1,0 end
-	if unitext_type =3D=3D kTextType_Label then =

-		show_journal =3D false =

-		if GetMobile(mobile_serial) then
-			show_below =3D false =

-			Mobile_NameHint(mobile_serial,unitext_item_model,unitext_name,unitext_m=
essage)
-			r,g,b =3D 1,1,1 =

-		end
-	end	-- 0x06 - System/Lower Corner, label?
-	if unitext_type =3D=3D kTextType_Corner			 	 then r,g,b =3D 1,0,0 end	=

-	if unitext_type =3D=3D kTextType_Whisper			 then r,g,b =3D 1,1,1 end	=

-	if unitext_type =3D=3D kTextType_Yell				 then r,g,b =3D 1,1,1 end	=

-	if unitext_type =3D=3D kTextType_Spell				 then r,g,b =3D 0,1,1 end	=

-	if unitext_type =3D=3D kTextType_Guild				 then r,g,b =3D 0,1,0 end	 =

-	if unitext_type =3D=3D kTextType_Alliance			 then r,g,b =3D 0,1,0 end	=

-	if unitext_type =3D=3D kTextType_CommandPrompt		 then r,g,b =3D 1,0,1 end=
		=

-	=

-	if unitext_hue then r,g,b =3D Uo16Color2Rgb(unitext_hue) end
-	=

-	-- brighten up the color
-	local h,s,v =3D ColorRGB2HSV(r,g,b)
-	v =3D math.min(1,v + gFontDefs["Chat"].brigth)
-	s =3D math.max(0,s - gFontDefs["Chat"].brigth/2)
-	r,g,b =3D ColorHSV2RGB(h,s,v)
-	=

-	printdebug("net",sprintf("NET: UnicodeText speakerid: %i name: %s txtsize=
: %i msg: %s\n",mobile_serial,unitext_name,(unitext_size-48)/2,unitext_mess=
age) )
-
-	if show_below then =

-		GuiAddChatLine(unitext_name..": "..string.gsub(unitext_message,"<br>","\=
n"),{r,g,b,1}) -- TODO : unicode
-	end
-	if show_journal then
-		JournalAddText(unitext_name,unitext_message)
-	end
-	=

-	NotifyListener("Hook_Text",unitext_name,unitext_message)
-	=

-	NotifyListener("Hook_Packet_Text_Unicode",mobile_serial,unitext_message,u=
nitext_type)
-	NotifyListener("Hook_MobName",mobile_serial,unitext_name)
-
-	-- check if player -> then show text over player head
-	local mobilespeaker=3DGetMobile(mobile_serial)
-	if (mobilespeaker) then mobilespeaker:NoZombie() end
-	if (mobilespeaker and show_below) then mobilespeaker:DisplayTextOverHead(=
string.gsub(unitext_message,"<br>","\n"),Uo16Color2Rgb(unitext_hue)) end
-end
-
 -- TODO : question : ghoulsblade : is this only for combat ? sience: don't=
 know -> verify
 -- currently we use this for the warmode target system
 -- Target current Mobile
@@ -919,86 +140,6 @@
 	printf("NET: (ignored): kPacket_Server_Change: "..vardump2(serverchange).=
."\n")
 end
 =

---TODO : implement switches
---[[
-Generic Gump Choice
-______________________________________
-BYTE[1]	ID (B1)
-BYTE[2]	-Packet Size
-BYTE[4]	-Gump Serial		--?? gumpserial (first Id in 0xb0)  (mislabled as pl=
ayerserial sometimes...)
-BYTE[4]	-Gump ID			--?? gumptypeid (second Id in 0xb0)
-BYTE[4]	-Button ID			--which button pressed or 0 if closed
-BYTE[4]	-Switches Count		--(response info for radio buttons and checkboxes=
, any switches listed here are switched on)
-
-loop	-Switch
-BYTE[4]	-Switch ID
-endloop -Switch
-
-BYTE[4]	-Text Entry Count	--response info for textentries
-
-loop	-Text Entry
-BYTE[2]	-Text Entry ID
-BYTE[2]	-Text Entry Length
-BYTE[length*2] Unicode text (not nullterminated)
-endloop	-Text Entry
-
-BYTE[4]	-Switches Count (Only if Gump ID =3D 461)
-BYTE[4]	-Beheld Serial (Only if (Gump ID =3D 461 && Button ID =3D 1 && Swi=
tches Count > 0))
-]]--
-
---table: switches: 10940BA0 returnmessage: 108
-
---TODO : readout checkboxes,radiobuttons and edit text fields
-function GumpReturnMsg(playerserial, gumptypeid, ret_value, params, switch=
count, textcount)	-- len 0x17
-	local packetlen =3D 23	--(1 + 2 + 4*5) size for empty params
-	if (params) then
-		packetlen =3D packetlen + 4 * table.getn(params.switches)
-		for k,v in pairs(params.texts) do =

-			packetlen =3D packetlen + 2 + 2 + 2*string.len(v.text) -- 2*stringsize =
because of unicode
-		end
-	end
-
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Generic_Gump_Trigger) -- 0xB1
-	out:PushNetUint16(packetlen)
-	out:PushNetUint32(playerserial)
-	out:PushNetUint32(gumptypeid)
-	out:PushNetUint32(ret_value)
-	=

-	--print("GumpReturnMsg player,gump,retval:",playerserial,gumptypeid,ret_v=
alue)
-	--~ printf("###### 0xB1 0x%04x 0x%08x 0x%08x 0x%08x\n",packetlen,playerse=
rial,gumptypeid,ret_value)
-	--~ 0000   B1 00 0F 00 0D BA 5B 00  00 01 CD 00 00 00 70      ......[....=
...p   -- virtue request (valor, 70 =3D gumpid of image)
-	=

-	if (params) then
-		--~ print("param",params)
-		out:PushNetUint32(table.getn(params.switches))	--switchcount
-		for k,v in pairs(params.switches) do =

-			out:PushNetUint32(v) =

-			--print("GumpReturnMsg switch:",v) =

-		end
-		=

-		out:PushNetUint32(table.getn(params.texts))	--textcount
-		for k,v in pairs(params.texts) do =

-			local len =3D string.len(v.text)
-			out:PushNetUint16(v.id) =

-			out:PushNetUint16(len) =

-			out:PushFilledUnicodeString(v.text,len)
-			--print("GumpReturnMsg text:",v.id,len,v.text)
-		end
-	else
-		--~ print("noparam",switchcount,textcount)
-		if (switchcount and textcount) then
-			out:PushNetUint32(switchcount)	--switchcount
-			out:PushNetUint32(textcount)	--textcount
-		else
-			out:PushNetUint32(0)	--switchcount
-			out:PushNetUint32(0)	--textcount
-		end
-	end
-
-	out:SendPacket()
-end
-
 -- send combat request to server, triggers kPacket_SetPlayerWarmode
 function Send_CombatMode(iWarMode)
 	local out =3D GetSendFIFO()
@@ -1018,134 +159,6 @@
 	printdebug("net", sprintf("NET: Attack -> serial=3D0x%08x\n",mobile_seria=
l) )
 end
 =

--- Generic Gump
-function gPacketHandler.kPacket_Generic_Gump ()	--0xB0
-	local input =3D GetRecvFIFO()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local newgump =3D {}
-	newgump.playerid =3D input:PopNetUint32()
-	newgump.dialogId =3D input:PopNetUint32()
-	newgump.x =3D input:PopNetUint32()
-	newgump.y =3D input:PopNetUint32()
-	newgump.Length_Data =3D input:PopNetUint16() -- TODO : special case if th=
is is 0xffff ?
-	=

-	if (1 + 2 + 4*4 + 2 + newgump.Length_Data > size) then =

-		printf("NET: broken kPacket_Generic_Gump packet, gumplen =3D 0x%08x\n",n=
ewgump.Length_Data)
-		print("FATAL ! kPacket_Generic_Gump -> forced Crash")
-		Crash()
-	end
-	=

-	newgump.Data =3D input:PopFilledString(newgump.Length_Data) -- includes z=
ero terminator
-	newgump.numTextLines =3D input:PopNetUint16()
-
-	for k,v in pairs(newgump) do printdebug("gump",sprintf("newgump.%s =3D ",=
k),v) end
-	=

-	local textlen =3D 0
-	newgump.textline =3D {}
-	newgump.textline_unicode =3D {}
-	--Index 0 because Serverside Gump Commands use this Index as textline ref=
erences
-	for i =3D 0,newgump.numTextLines-1 do
-		textlen =3D input:PopNetUint16() -- =3D number_of_unicode_chars
-		printdebug("gump","reading text line ",i," with length ",textlen)
-		newgump.textline[i],newgump.textline_unicode[i] =3D UniCodeDualPop(input=
,textlen)
-		printdebug("gump",sprintf("newgump.textline[%d](len=3D%d)=3D\n",i,textle=
n),newgump.textline[i])
-	end
-
-	local dialog =3D GumpParser(newgump)
-	NotifyListener("Hook_OpenServersideGump",dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data)	=

-end
-
-function UniCodeDualPop (fifo,number_of_unicode_chars)
-	--~ return input:PopUnicodeString(textlen) -- old, only asci part , TODO =
: see also PopUnicodeLEString
-	local ascipart =3D ""
-	local unicode_charcodes =3D {}
-	for i =3D 1,number_of_unicode_chars do
-		local head =3D fifo:PopUint8()
-		local data =3D fifo:PopUint8()
-		if (head ~=3D 0) then
-			ascipart =3D ascipart .. "?" .. (data ~=3D 0 and string.format("%c",dat=
a) or "")
-		else
-			ascipart =3D ascipart .. string.format("%c",data)
-		end
-		table.insert(unicode_charcodes,head*256 + data)
-	end
-	return ascipart,unicode_charcodes
-end
-
-
--- compressed Gump
-function gPacketHandler.kPacket_Compressed_Gump ()	--0xDD
-	local input =3D GetRecvFIFO()
-	local popped_start =3D input:GetTotalPopped()
-	local id =3D input:PopNetUint8()
-	local size =3D input:PopNetUint16()
-	local newgump =3D {}
-
-	newgump.playerid =3D input:PopNetUint32()
-	newgump.dialogId =3D input:PopNetUint32()
-	newgump.x =3D input:PopNetUint32()
-	newgump.y =3D input:PopNetUint32()
-
-	newgump.Length_CompressedData =3D input:PopNetUint32() - 4
-	newgump.Length_Data =3D input:PopNetUint32()
-
-	printdebug("net",sprintf("NET: Length_CompressedData=3D%d Length_Uncompre=
ssedData=3D%d\n",newgump.Length_CompressedData,newgump.Length_Data))
-
-	if (28 + newgump.Length_CompressedData > size) then =

-		printf("NET: BROKEN - kPacket_Compressed_Gump packet, compressed gumplen=
 =3D 0x%08x\n",newgump.Length_CompressedData)
-		print("Error: Server Sends bad Compressed Gumpdata ! Please report.")
-		print("FATAL ! kPacket_Compressed_Gump -> forced Crash")
-		Crash()
-	end
-
-	--- Data Part ---
-	local decompressed =3D CreateFIFO()
-	-- pop and decompress data into decompress fifo
-	input:PeekDecompressIntoFifo(newgump.Length_CompressedData,newgump.Length=
_Data,decompressed)
-	-- skip compressed part (peeked)
-	input:PopRaw(newgump.Length_CompressedData)
-	newgump.Data =3D decompressed:PopFilledString(decompressed:Size())
-	-- and clear the decompress fifo for later usage
-	decompressed:Clear()
-	=

-	-- WARNING  strange -4 on compression ahead (see runuo2 source)
-	--- Textlines Part ---
-	newgump.numTextLines =3D input:PopNetUint32()
-
-	if (newgump.numTextLines ~=3D 0) then
-		newgump.Length_CompressedTextLines =3D input:PopNetUint32() - 4
-		newgump.Length_TextLines =3D input:PopNetUint32()
-	=

-		-- pop and decompress data into decompress fifo
-		input:PeekDecompressIntoFifo(newgump.Length_CompressedTextLines,newgump.=
Length_TextLines,decompressed)
-		-- skip compressed part (peeked)
-		input:PopRaw(newgump.Length_CompressedTextLines)
-		=

-		-- print gumpdata
-		for k,v in pairs(newgump) do printdebug("gump",sprintf("newgump.%s =3D "=
,k),v) end
-		=

-		local textlen =3D 0
-		newgump.textline =3D {}
-		newgump.textline_unicode =3D {}
-		--Index 0 because Serverside Gump Commands use this Index as textline re=
ferences
-		for i =3D 0,newgump.numTextLines-1 do
-			textlen =3D decompressed:PopNetUint16()
-			printdebug("gump","reading text line ",i," with length ",textlen)
-			newgump.textline[i],newgump.textline_unicode[i] =3D UniCodeDualPop(deco=
mpressed,textlen)
-			printdebug("gump",sprintf("newgump.textline[%d](len=3D%d)=3D\n",i,textl=
en),newgump.textline[i])
-		end
-	end
-
-	decompressed:Destroy()
-
-	if ( (input:Size() >=3D 4) and (input:GetTotalPopped()-popped_start < siz=
e) ) then
-		local unknownterminator=3Dinput:PopNetUint32()
-	end
-
-	local dialog =3D (not gNoRender) and GumpParser(newgump)
-	NotifyListener("Hook_OpenServersideGump",dialog,newgump.playerid,newgump.=
dialogId,newgump.Length_Data,true)	=

-end
 =

 =

 -- rename a mobile
@@ -1216,120 +229,3 @@
 ]]--
 end
 =

--- TODO : at first check speech.mul keywords and send them to server
-function Send_Speech(speech)
-	if not speech then print("unknown speech=3D",speech) return end
-	local speechlen =3D string.len(speech)
-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Speech)
-	out:PushNetUint16(speechlen+8+1)
-	out:PushNetUint8(0)
-	out:PushNetUint16(10)
-	out:PushNetUint16(3)
-	out:PushFilledString(speech, speechlen)
-	out:PushNetUint8(0)			-- add a Null-Terminator to sendstring
-	out:SendPacket()
-	printf("NET: Send_Speech : speech=3D%s\n",speech)
-end
-
--- kPacket_Speech_Unicode 0xAD
--- see runuo1 sourcecode ./Network/PacketHandlers.cs:1176: UnicodeSpeech  =
  for details of encoding/decoding
--- see also lib.speech.lua for  SpeechParseKeywords
-function Send_UnicodeSpeech (ascistr, mode, huecolor, font)	-- (0xAD)
-	--print("Send_UnicodeSpeech",gSpeechLoader,ascistr, mode, huecolor, font)
-	if not ascistr then print("Send_UnicodeSpeech:missing text") return end
-	=

-	local ascilen		=3D string.len(ascistr)
-	local keywords		=3D SpeechParseKeywords(ascistr)
-	local keywordcount	=3D table.getn(keywords)
-	local bEncoded		=3D keywordcount > 0
-	if (gNoSpeechKeyWords) then bEncoded =3D false end -- pre aos pol shards =
? (cloudstrive/zulu)
-	local hue			=3D hex2num("0x34")
-	local font			=3D 0 -- ignored by runuo 1
-	local msgtype		=3D kTextType_Normal + (bEncoded and kTextType_Encoded or =
0)
-	local packetlen		=3D 1+2+1+2+2+4+ (bEncoded and (2+0+ascilen+1) or (ascil=
en*2+2))
-	for i =3D 0,keywordcount-1 do packetlen =3D packetlen + ((math.mod(i,2) =
=3D=3D 0) and 1 or 2) end -- calc packetlength for encoding
-	=

-	local out =3D GetSendFIFO()
-	out:PushNetUint8(kPacket_Speech_Unicode)
-	out:PushNetUint16(packetlen)
-	out:PushNetUint8(msgtype)
-	out:PushNetUint16(hue)
-	out:PushNetUint16(font)
-	out:PushFilledString(gLanguage or "ENU", 4)
-	=

-	if (bEncoded) then
-		local count	=3D keywordcount -- should be in [0,50]
-		local hold	=3D BitwiseAND(BitwiseSHR(keywords[1],8),hex2num("0xf")) -- s=
hould be in [0,0xF]
-		local value	=3D BitwiseSHL(keywordcount,4) + hold
-		out:PushNetUint16(value)
-		for i =3D 0,keywordcount-1 do
-			if (math.mod(i,2) =3D=3D 0) then
-				out:PushNetUint8(BitwiseAND(keywords[i+1],hex2num("0xff")))
-			else
-				local hold	=3D BitwiseAND(BitwiseSHR(keywords[i+2] or 0,8),hex2num("0x=
f")) -- should be in [0,0xF]
-				local value	=3D BitwiseSHL(keywords[i+1],4) + hold
-				out:PushNetUint16(value)
-			end
-		end
-		out:PushFilledString(ascistr, ascilen)  -- utf8
-		out:PushNetUint8(0) -- zero terminate
-	else =

-		print("#sendchat,plain",gLanguage)
-		out:PushFilledUnicodeString(ascistr, ascilen) -- unicode, 16 bit per let=
ter
-		out:PushNetUint16(0) -- zero terminate
-	end
-	=

-	out:SendPacket()
-end =

-
-
---[[
-Packet ID: 0xAD
-Packet Name: Unicode/Ascii speech request
-
-BYTE[1] cmd
-BYTE[2] length
-BYTE[1] Type
-BYTE[2] Color
-BYTE[2] Font
-BYTE[4] Language (Null Terminated)
-=C2=B7 =C2=93enu=C2=93 - United States English
-=C2=B7 =C2=93des=C2=94 - German Swiss
-=C2=B7 =C2=93dea=C2=94 - German Austria
-=C2=B7 =C2=93deu=C2=94 - German Germany
-=C2=B7 ... for a complete list see langcode.iff
-
-if (Type & 0xc0)
-=C2=B7 BYTE[1,5] Number of distinct Trigger words (NUMWORDS). 12 Bit numbe=
r, Byte #13 =3D Bit 11=C2=854 of NUMWORDS, Hi-Nibble of Byte #14 (Bit 7=C2=
=854) =3D Bit 0=C2=853 of NUMWORDS
-=C2=B7 BYTE[1,5] Index to speech.mul. 12 Bit number, Low Nibble of Byte #1=
4 (Bits 3=C2=850) =3D Bits 11..8 of Index, Byte #15 =3D Bits 7=C2=850 of In=
dex
-=C2=B7 UNKNOWNS =3D ( (NUMWORDS div 2) *3 ) + (NUMWORDS % 2) =C2=96 1. div=
 =3D Integeger division, % =3D modulo operation, NUMWORDS >=3D 1. examples:=
 UNKNOWNS(1)=3D0, UNKNOWNS(2)=3D2, UNKNOWNS(3)=3D3, UNKNOWNS(4)=3D5, UNKNOW=
NS(5)=3D6, UNKNOWNS(6)=3D8, UNKNOWNS(7)=3D9, UNKNOWNS(8)=3D11, UNKNOWNS(9)=
=3D12
-=C2=B7 BYTE[UNKNOWNS] Idea behind this is getting speech parsing load clie=
nt side.
-				 Thus this contains data OSI server use for easier parsing. It=C2=92s =
client side hardcoded and exact details are unkown.
-=C2=B7 BYTE[?] Ascii Msg =C2=96 Null Terminated(blockSize =C2=96 (15+UNKNO=
WNS) )
-
-else
-=C2=B7 BYTE[?][2] Unicode Msg - Null Terminated (blockSize - 12)
-
-Notes
-For pre 2.0.7 clients Type is always < 0xc0. Uox based emus convert post 2=
.0.7 data of this packet to pre 2.0.7 data if Type >=3D0xc0.
-
-(different view of it)
-If Mode&0xc0 then there are keywords (from speech.mul) present.
-Keywords:
-The first 12 bits =3D the number of keywords present. The keywords are inc=
luded right after this, each one is 12 bits also.
-The keywords are padded to the closest byte. For example, if there are 2 k=
eywords, it will take up 5 bytes. 12bits for the number, and 12 bits for ea=
ch keyword. 12+12+12=3D36. Which will be padded 4 bits to 40 bits or 5 byte=
s.
-
-The various types of text is as follows:
-0x00 - Normal
-0x01 - Broadcast/System
-0x02 - Emote
-0x06 - System/Lower Corner
-0x07 - Message/Corner With Name
-0x08 - Whisper
-0x09 - Yell
-0x0A - Spell
-0x0D - Guild Chat
-0x0E - Alliance Chat
-0x0F - Command Prompts
-]]--

Modified: trunk/lua/widgets/widget.uoquickcasticon.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/widgets/widget.uoquickcasticon.lua (original)
+++ trunk/lua/widgets/widget.uoquickcasticon.lua Wed Oct 29 18:41:43 2008
@@ -55,6 +55,7 @@
 		dialog.on_mouse_left_click_double =3D function (widget) fun() end
 	end
 	=

+	dialog.debugname =3D sprintf("CreateQuickCastButton(%s,%s,%s,%s,%s)",tost=
ring(x),tostring(y),tostring(name),tostring(fun),tostring(gumpid))..tostrin=
g(GetStackTrace())
 	glQuickCastDialog[dialog] =3D true
 	dialog:BringToFront()
 	return dialog



From no-reply at zwischenwelt.org  Wed Oct 29 23:04:35 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Wed, 29 Oct 2008 22:04:35 -0000
Subject: [Iris-commit] [IRIS] r2669 - /trunk/lua/lib.loading.lua
Message-ID: <20081029220435.7AC361C1809A@zwischenwelt.org>

Author: ghoulsblade
Date: Wed Oct 29 23:04:34 2008
New Revision: 2669

Log:
using map0 as fallback if there is no map1 : old,unpached ML clients7

Modified:
    trunk/lua/lib.loading.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Wed Oct 29 23:04:34 2008
@@ -385,6 +385,7 @@
 	local mapfilename		=3D gMaps[index].mapfilename
 	local staidxfilename	=3D gMaps[index].staidxfilename
 	local staticfilename	=3D gMaps[index].staticfilename
+	=

 =

 	-- only relevant for pre 6.0.0 UO Clients
 	local sta_diff_lookup	=3D gMaps[index].sta_diff_lookup
@@ -397,9 +398,15 @@
 		if (not gInitialMapLoaded) then LoadingProfile("init GroundblockLoader")=
 end
 		profile:StartSection("ground")
 		=

+		-- map 1 not there in old ml (4.0.11c, fresh install without patch), use=
 map 0 instead
+		local finalmappath =3D CorrectPath( Addfilepath(mapfilename) )
+		if ((not finalmappath) or (not file_exists(finalmappath))) then =

+			finalmappath =3D CorrectPath( Addfilepath(gMaps[0].mapfilename) ) =

+		end
+	=

 		print("Loading Map id "..index)
 		print("Loading Map name "..name)
-		print("Loading Map terrain "..mapfilename)
+		print("Loading Map terrain "..finalmappath)
 		--- use diff files?
 		if map_diff_lookup and map_diff_data =

 			and file_exists(CorrectPath( Addfilepath(map_diff_lookup) )) and file_e=
xists(CorrectPath( Addfilepath(map_diff_data) )) then
@@ -407,10 +414,10 @@
 			print("Loading Map map_diff_lookup "..map_diff_lookup)
 			print("Loading Map map_diff_data "..map_diff_data)
 			print("Applying Map diff files")
-			gGroundBlockLoader =3D CreateGroundBlockLoaderWithDiff(gGroundBlockLoad=
erType,mapheight,CorrectPath( Addfilepath(mapfilename) ),
+			gGroundBlockLoader =3D CreateGroundBlockLoaderWithDiff(gGroundBlockLoad=
erType,mapheight,finalmappath,
 				CorrectPath( Addfilepath(map_diff_lookup) ), CorrectPath( Addfilepath(=
map_diff_data) ))
 		else
-			gGroundBlockLoader =3D CreateGroundBlockLoader(gGroundBlockLoaderType,m=
apheight,CorrectPath( Addfilepath(mapfilename) ))
+			gGroundBlockLoader =3D CreateGroundBlockLoader(gGroundBlockLoaderType,m=
apheight,finalmappath)
 		end
 	end
 		=

@@ -418,8 +425,18 @@
 		if (not gInitialMapLoaded) then LoadingProfile("init StaticBlockLoader")=
 end
 		profile:StartSection("static")
 		=

-		print("Loading Static static idx "..staidxfilename)
-		print("Loading Static static "..staticfilename)
+		-- map 1 not there in old ml (4.0.11c, fresh install without patch), use=
 map 0 instead
+		local finalpath_staidx =3D CorrectPath( Addfilepath(staidxfilename) )
+		local finalpath_static =3D CorrectPath( Addfilepath(staticfilename) )
+		if ((not finalpath_staidx) or (not file_exists(finalpath_staidx))) then =

+			finalpath_staidx =3D CorrectPath( Addfilepath(gMaps[0].staidxfilename) =
) =

+		end
+		if ((not finalpath_static) or (not file_exists(finalpath_static))) then =

+			finalpath_static =3D CorrectPath( Addfilepath(gMaps[0].staticfilename) =
) =

+		end
+		=

+		print("Loading Static static idx "..finalpath_staidx)
+		print("Loading Static static "..finalpath_static)
 		--- use diff files?
 		if(sta_diff_lookup and sta_diff_idx and sta_diff_data)
 			and file_exists(CorrectPath( Addfilepath(sta_diff_lookup) )) and file_e=
xists(CorrectPath( Addfilepath(sta_diff_idx) )) =

@@ -429,10 +446,10 @@
 			print("Loading Static sta_diff_idx "..sta_diff_idx)
 			print("Loading Static sta_diff_data "..sta_diff_data)
 			print("Applying Static diff files")
-			gStaticBlockLoader =3D CreateStaticBlockLoaderWithDiff(gStaticBlockLoad=
erType,mapheight,CorrectPath( Addfilepath(staidxfilename) ),CorrectPath( Ad=
dfilepath(staticfilename) ),
+			gStaticBlockLoader =3D CreateStaticBlockLoaderWithDiff(gStaticBlockLoad=
erType,mapheight,finalpath_staidx,finalpath_static,
 				CorrectPath( Addfilepath(sta_diff_lookup) ),CorrectPath( Addfilepath(s=
ta_diff_idx) ),CorrectPath( Addfilepath(sta_diff_data) ))
 		else =

-			gStaticBlockLoader =3D CreateStaticBlockLoader(gStaticBlockLoaderType,m=
apheight,CorrectPath( Addfilepath(staidxfilename) ),CorrectPath( Addfilepat=
h(staticfilename) ))
+			gStaticBlockLoader =3D CreateStaticBlockLoader(gStaticBlockLoaderType,m=
apheight,finalpath_staidx,finalpath_static)
 		end
 	end
 =




From no-reply at zwischenwelt.org  Thu Oct 30 12:08:11 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 30 Oct 2008 11:08:11 -0000
Subject: [Iris-commit] [IRIS] r2670 - in /trunk/data/models:
 materials/textures.material models/to_004000/mdl_003180.mesh
 textures/tex_osterhead.png textures/tex_pumpkin.png
Message-ID: <20081030110812.474ED1C18650@zwischenwelt.org>

Author: hagish
Date: Thu Oct 30 12:08:10 2008
New Revision: 2670

Log:
new model pumpkin

Added:
    trunk/data/models/models/to_004000/mdl_003180.mesh   (with props)
    trunk/data/models/textures/tex_osterhead.png   (with props)
    trunk/data/models/textures/tex_pumpkin.png   (with props)
Modified:
    trunk/data/models/materials/textures.material

Modified: trunk/data/models/materials/textures.material
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/data/models/materials/textures.material (original)
+++ trunk/data/models/materials/textures.material Thu Oct 30 12:08:10 2008
@@ -6003,3 +6003,8 @@
 { =

 	set_texture_alias MainTexture tex_osterhead.png
 }
+
+material tex_pumpkin : tex_base =

+{ =

+	set_texture_alias MainTexture tex_pumpkin.png
+}



From no-reply at zwischenwelt.org  Thu Oct 30 18:31:57 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 30 Oct 2008 17:31:57 -0000
Subject: [Iris-commit] [IRIS] r2671 - in /trunk: lua/lib.uoutils.lua
 lua/net/net.partysystem.lua plugins/moblist.lua
Message-ID: <20081030173157.7B5071C18651@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 30 18:31:56 2008
New Revision: 2671

Log:
partychat : use mobile tooltip for name, works also when mobile out of sigh=
t.. set the partchat color to green so it's better hilighted against system=
 messages

Modified:
    trunk/lua/lib.uoutils.lua
    trunk/lua/net/net.partysystem.lua
    trunk/plugins/moblist.lua

Modified: trunk/lua/lib.uoutils.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.uoutils.lua (original)
+++ trunk/lua/lib.uoutils.lua Thu Oct 30 18:31:56 2008
@@ -86,3 +86,16 @@
 	return ascipart,unicode_charcodes
 end
 =

+function UOShortenName (text) -- AosToolTip_GetText(self.serial)
+	text =3D string.gsub(text,"\n.*","") -- only keep first line
+	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
+	text =3D string.gsub(text," %[","%[") -- move guildtag closer
+	text =3D string.gsub(text,"^Lord","")
+	text =3D string.gsub(text,"^Lady","")
+	text =3D string.gsub(text,"^an ","")
+	text =3D string.gsub(text,"^a ","")
+	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
+	text =3D string.gsub(text,"[ \t]+$","") -- remove trailing spaces
+	return text
+end
+

Modified: trunk/lua/net/net.partysystem.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.partysystem.lua (original)
+++ trunk/lua/net/net.partysystem.lua Thu Oct 30 18:31:56 2008
@@ -1,3 +1,4 @@
+gPartyChatColor =3D {0,1,0,1}
 gPartySystemSubSubCmd =3D {}
 gPartySystemSubSubCmd.kPartySubCmd_AddMembers		=3D 1
 gPartySystemSubSubCmd.kPartySubCmd_RemoveMembers	=3D 2
@@ -42,7 +43,7 @@
 function PartySystem_UpdateMemberList (memberlist)
 	gPartySystemMemberList =3D memberlist
 	gPartySystemMemberListByID =3D {}
-	for k,serial in pairs(gPartySystemMemberList) do gPartySystemMemberListBy=
ID[serial] =3D true end
+	for k,serial in pairs(gPartySystemMemberList) do AosToolTip_GetText(seria=
l) gPartySystemMemberListByID[serial] =3D true end
 	PartyListDialog_Rebuild()
 	NotifyListener("Hook_UpdatePartyMemberList")
 end
@@ -182,10 +183,11 @@
 	local speakerID =3D input:PopNetUint32()
 	size =3D size - 4
 	local mobile =3D GetMobile(speakerID)
-	local name =3D mobile and mobile.name or ("unknown"..speakerID)
+	local name =3D AosToolTip_GetText(speakerID) or (mobile and mobile.name) =
or ("unknown"..speakerID)
+	name =3D UOShortenName(name)
 	print("partysystem:test message",speakerID,name, input, size)
 	local plaintext,unicodebytearr,size =3D FIFO_PopZeroTerminatedUnicode(inp=
ut,size)
-	GuiAddChatLine ("["..name.."]: "..plaintext)
+	GuiAddChatLine("["..name.."]: "..plaintext,gPartyChatColor)
 end =

 =

 -- thanks to surcouf =3D)

Modified: trunk/plugins/moblist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/plugins/moblist.lua (original)
+++ trunk/plugins/moblist.lua Thu Oct 30 18:31:56 2008
@@ -262,18 +262,7 @@
 	self:RecalcCat()
 end
 =

-function MobListShortenName (text) -- AosToolTip_GetText(self.serial)
-	text =3D string.gsub(text,"\n.*","") -- only keep first line
-	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
-	text =3D string.gsub(text," %[","%[") -- move guildtag closer
-	text =3D string.gsub(text,"^Lord","")
-	text =3D string.gsub(text,"^Lady","")
-	text =3D string.gsub(text,"^an ","")
-	text =3D string.gsub(text,"^a ","")
-	text =3D string.gsub(text,"^[ \t]+","") -- remove leading spaces
-	text =3D string.gsub(text,"[ \t]+$","") -- remove trailing spaces
-	return text
-end
+function MobListShortenName (text) return UOShortenName(text) end
 =

 function gWidgetPrototype.UOMobListItem:UpdateName(name,clilocid)
 	if (name and (not self.lowname)) then self.lowname =3D name self.nameclil=
oc =3D clilocid end



From no-reply at zwischenwelt.org  Thu Oct 30 19:51:13 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 30 Oct 2008 18:51:13 -0000
Subject: [Iris-commit] [IRIS] r2672 - in /trunk: include/data_gump.h
	src/data_gump.cpp
Message-ID: <20081030185158.0B6571C18651@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 30 19:51:05 2008
New Revision: 2672

Log:
64 bit fix-attempt for gump crash

Modified:
    trunk/include/data_gump.h
    trunk/src/data_gump.cpp

Modified: trunk/include/data_gump.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/include/data_gump.h (original)
+++ trunk/include/data_gump.h Thu Oct 30 19:51:05 2008
@@ -5,12 +5,12 @@
 	cGump();
 	int	GetWidth	();
 	int	GetHeight	();
-	template <class _T> void Decode(short *pBuffer, const int iPitch, _T& fil=
ter, short* ColorTable) { PROFILE	//< decodes the gump image into a pixelbu=
ffer (1short/pixel), pitch=3DLength of a surface scanline in bytes
+	template <class _T> void Decode(int16 *pBuffer, const int iPitch, _T& fil=
ter, int16* ColorTable) { PROFILE	//< decodes the gump image into a pixelbu=
ffer (1int16/pixel), pitch=3DLength of a surface scanline in bytes
 		int w =3D GetWidth();
 		int h =3D GetHeight();
 		int	iBufferSize =3D iPitch*GetHeight();
 =

-		long *LookupList =3D (long *)mpRawData;
+		int32 *LookupList =3D (int32 *)mpRawData;
 		char *pStart =3D mpRawData;
 			=

 		for(int Y =3D 0; Y < h; Y++) {
@@ -22,12 +22,12 @@
 			}
 =

 			int X =3D 0;
-			short *Value	=3D (short *)(pStart + LookupList[Y]*4);
-			short *Run		=3D (short *)(pStart + LookupList[Y]*4 + 2);
+			int16 *Value	=3D (int16 *)(pStart + LookupList[Y]*4);
+			int16 *Run		=3D (int16 *)(pStart + LookupList[Y]*4 + 2);
 			for(int i =3D 0; i < Size; i++) {
 				if (*Value > 0) {
 					for(int j =3D 0; j < *Run; j++) {
-						SecureWrite( (short *)(((char*)(pBuffer + X)) + Y*iPitch), filter( *=
Value, ColorTable ), pBuffer, iBufferSize, "cGump::Decode", miID );
+						SecureWrite( (int16 *)(((char*)(pBuffer + X)) + Y*iPitch), filter( *=
Value, ColorTable ), pBuffer, iBufferSize, "cGump::Decode", miID );
 						X++;
 					}
 				} else {

Modified: trunk/src/data_gump.cpp
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/src/data_gump.cpp (original)
+++ trunk/src/data_gump.cpp Thu Oct 30 19:51:05 2008
@@ -35,7 +35,7 @@
 	if (gump =3D=3D 0) return;
 	int iImgW =3D gump->GetWidth();
 	int iImgH =3D gump->GetHeight();
-	short *pImgRaw =3D new short[iImgW*iImgH] ;
+	int16 *pImgRaw =3D new int16[iImgW*iImgH] ;
 	memset(pImgRaw,0,2*iImgW*iImgH);
 	cSetHighBitFilter Filter;
 	gump->Decode(pImgRaw,iImgW*2,Filter,0);
@@ -58,12 +58,12 @@
 		while (iTexW < iImgW) iTexW <<=3D 1;
 		while (iTexH < iImgH) iTexH <<=3D 1;
 	}
-	short *pImgRaw =3D new short[iTexW*iTexH] ;
+	int16 *pImgRaw =3D new int16[iTexW*iTexH] ;
 	memset(pImgRaw,0,2*iTexW*iTexH);
 	if( iHue && pHueLoader ) {
 		bool PartialHue =3D (iHue & 0x8000);
 		iHue =3D iHue & 0x7FFF;
-		short* ColorTable =3D pHueLoader->GetHue( iHue-1 )->GetColors();
+		int16* ColorTable =3D pHueLoader->GetHue( iHue-1 )->GetColors();
 =

 		if (PartialHue) {
 			cPartialHueFilter Filter;
@@ -103,11 +103,11 @@
 	if (gump =3D=3D 0) return false;
 	int iImgW =3D gump->GetWidth();
 	int iImgH =3D gump->GetHeight();
-	short *pImgRaw =3D new short[iImgW*iImgH] ;
+	int16 *pImgRaw =3D new int16[iImgW*iImgH] ;
 	memset(pImgRaw,0,2*iImgW*iImgH);
 	if( iHue && pHueLoader ) {
 		bool PartialHue =3D (iHue & 0x8000);
-		short* ColorTable =3D pHueLoader->GetHue( (iHue & 0x7FFF)-1 )->GetColors=
();
+		int16* ColorTable =3D pHueLoader->GetHue( (iHue & 0x7FFF)-1 )->GetColors=
();
 =

 		if (PartialHue) {
 			cPartialHueFilter Filter;



From no-reply at zwischenwelt.org  Thu Oct 30 23:14:20 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 30 Oct 2008 22:14:20 -0000
Subject: [Iris-commit] [IRIS] r2673 - /trunk/lua/main.lua
Message-ID: <20081030221420.9241E1C18632@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 30 23:14:20 2008
New Revision: 2673

Log:
main test

Modified:
    trunk/lua/main.lua

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct 30 23:14:20 2008
@@ -292,6 +292,7 @@
 =

 --- main function, when it returns, the program ends
 function Main ()
+	print("bla1")
 	-- detect UOPath
 	if (not gUOPath) then AutoDetectUOPath() end
 	if (ClientVersionIsPost6017()) then =

@@ -303,7 +304,9 @@
 	local luaversion =3D string.sub(_VERSION, 5, 7)
 	print("Lua version : "..luaversion)
 	=

+	print("bla2")
 	HandleCommandLine()
+	print("bla3")
 	=

 	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end
 =

@@ -313,20 +316,28 @@
 	=

 	CheckUODir()
 	=

+	print("bla4")
 	LoadPlugins_Iris()
+	print("bla5")
 	LoadWidgets(gIrisWidgetDir)
+	print("bla6")
 	LoadMacros()
+	print("bla7")
 	NotifyListener("Hook_PluginsLoaded")
+	print("bla8")
 	=

 	gMyTicks =3D Client_GetTicks()
 	=

 	LoadingProfile("initializing Ogre",true)
+	print("bla9")
 	gPreOgreTime =3D gLoadingProfileLastTime
 	if (not gNoOgre) then
 		if (not InitOgre("Iris2",gOgrePluginPathOverride or lugre_detect_ogre_pl=
ugin_path(),"../bin/")) then Exit() end
 		CollectOgreResLocs()
 	end
+	print("bla10")
 	SetCursorBaseOffset(0,0)
+	print("bla11")
 	=

 	------------------------------------------ obsolete, just for testing ---=
--------------------------------
 	-- Lua test because Lua50 should not be compiled full-optimized with VS20=
05 Express (maybe also other compilers)
@@ -342,25 +353,36 @@
 	if (gCommandLineSwitches["-gumptest"]) then GumpParserTest() end
 	-------------------------------------------------------------------------=
---------------------------------
 =

+	print("bla12")
 	-- maybe we should check here if in offline or online mode!?
 	InitNet()
+	print("bla13")
 	InitMobileMethodWrappers()
+	print("bla14")
 =

 	LoadingProfile("init basic gui")
+	print("bla15")
 	CreateIrisLogo()
+	print("bla16")
 =

 	InitFallBacks()
+	print("bla17")
 	InitArtFilter()
+	print("bla18")
 	=

 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
 	gViewportW,gViewportH =3D GetViewportSize()
+	print("bla19")
 	--~ Client_USleep(1000/30)
 =

 	NotifyListener("Hook_PreLoad")
+	print("bla20")
 	PreLoad()
 	=

+	print("bla21")
 	InvokeExporters()
 =

+	print("bla22")
 	MainMenuFinishedPreLoading()
 	=

 	-- set fadelines font
@@ -369,10 +391,13 @@
 	gFadeLineH =3D gFadeLineTextH
 	gFadeLineOffY =3D 30 + gFadeLineTextH
 =

+	print("bla23")
 	BindGeneralKeys()
 =

+	print("bla24")
 	NotifyListener("Hook_PostLoad")
 =

+	print("bla25")
 	StartMainMenu()
 	=

 	if (gCommandLineSwitches["-fonttest"]) then FontTest() end
@@ -381,6 +406,7 @@
 		os.remove("stats.dat")
 	end
 =

+	print("bla26")
 	-- mainloop
 	while (Client_IsAlive()) do =

 		MainStep() =




From no-reply at zwischenwelt.org  Thu Oct 30 23:26:32 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 30 Oct 2008 22:26:32 -0000
Subject: [Iris-commit] [IRIS] r2674 - in /trunk/lua: lib.null.renderer.lua
	main.lua
Message-ID: <20081030222632.6E8821C18651@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 30 23:26:32 2008
New Revision: 2674

Log: (empty)

Modified:
    trunk/lua/lib.null.renderer.lua
    trunk/lua/main.lua

Modified: trunk/lua/lib.null.renderer.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.null.renderer.lua (original)
+++ trunk/lua/lib.null.renderer.lua Thu Oct 30 23:26:32 2008
@@ -64,3 +64,4 @@
 function RendererNull:NotifyHPChange				(mobile, value) end
 function RendererNull:NotifyManaChange			(mobile, value) end
 function RendererNull:ClearMapCache			() end
+function RendererNull:AddEffect			() end

Modified: trunk/lua/main.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/main.lua (original)
+++ trunk/lua/main.lua Thu Oct 30 23:26:32 2008
@@ -292,7 +292,6 @@
 =

 --- main function, when it returns, the program ends
 function Main ()
-	print("bla1")
 	-- detect UOPath
 	if (not gUOPath) then AutoDetectUOPath() end
 	if (ClientVersionIsPost6017()) then =

@@ -304,9 +303,7 @@
 	local luaversion =3D string.sub(_VERSION, 5, 7)
 	print("Lua version : "..luaversion)
 	=

-	print("bla2")
 	HandleCommandLine()
-	print("bla3")
 	=

 	if (gCommandLineSwitches["-profile"]) then StartGlobalProfiler() end
 =

@@ -316,28 +313,20 @@
 	=

 	CheckUODir()
 	=

-	print("bla4")
 	LoadPlugins_Iris()
-	print("bla5")
 	LoadWidgets(gIrisWidgetDir)
-	print("bla6")
 	LoadMacros()
-	print("bla7")
 	NotifyListener("Hook_PluginsLoaded")
-	print("bla8")
 	=

 	gMyTicks =3D Client_GetTicks()
 	=

 	LoadingProfile("initializing Ogre",true)
-	print("bla9")
 	gPreOgreTime =3D gLoadingProfileLastTime
 	if (not gNoOgre) then
 		if (not InitOgre("Iris2",gOgrePluginPathOverride or lugre_detect_ogre_pl=
ugin_path(),"../bin/")) then Exit() end
 		CollectOgreResLocs()
 	end
-	print("bla10")
 	SetCursorBaseOffset(0,0)
-	print("bla11")
 	=

 	------------------------------------------ obsolete, just for testing ---=
--------------------------------
 	-- Lua test because Lua50 should not be compiled full-optimized with VS20=
05 Express (maybe also other compilers)
@@ -353,36 +342,25 @@
 	if (gCommandLineSwitches["-gumptest"]) then GumpParserTest() end
 	-------------------------------------------------------------------------=
---------------------------------
 =

-	print("bla12")
 	-- maybe we should check here if in offline or online mode!?
 	InitNet()
-	print("bla13")
 	InitMobileMethodWrappers()
-	print("bla14")
 =

 	LoadingProfile("init basic gui")
-	print("bla15")
 	CreateIrisLogo()
-	print("bla16")
 =

 	InitFallBacks()
-	print("bla17")
 	InitArtFilter()
-	print("bla18")
 	=

 	Client_RenderOneFrame() -- first frame rendered with ogre, needed for ini=
t of viewport size
 	gViewportW,gViewportH =3D GetViewportSize()
-	print("bla19")
 	--~ Client_USleep(1000/30)
 =

 	NotifyListener("Hook_PreLoad")
-	print("bla20")
 	PreLoad()
 	=

-	print("bla21")
 	InvokeExporters()
 =

-	print("bla22")
 	MainMenuFinishedPreLoading()
 	=

 	-- set fadelines font
@@ -391,13 +369,10 @@
 	gFadeLineH =3D gFadeLineTextH
 	gFadeLineOffY =3D 30 + gFadeLineTextH
 =

-	print("bla23")
 	BindGeneralKeys()
 =

-	print("bla24")
 	NotifyListener("Hook_PostLoad")
 =

-	print("bla25")
 	StartMainMenu()
 	=

 	if (gCommandLineSwitches["-fonttest"]) then FontTest() end
@@ -406,7 +381,6 @@
 		os.remove("stats.dat")
 	end
 =

-	print("bla26")
 	-- mainloop
 	while (Client_IsAlive()) do =

 		MainStep() =




From no-reply at zwischenwelt.org  Thu Oct 30 23:36:49 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 30 Oct 2008 22:36:49 -0000
Subject: [Iris-commit] [IRIS] r2675 - /trunk/lua/net/net.text.lua
Message-ID: <20081030223649.A23F51C18651@zwischenwelt.org>

Author: ghoulsblade
Date: Thu Oct 30 23:36:49 2008
New Revision: 2675

Log:
Hook_Text : added serial

Modified:
    trunk/lua/net/net.text.lua

Modified: trunk/lua/net/net.text.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/net/net.text.lua (original)
+++ trunk/lua/net/net.text.lua Thu Oct 30 23:36:49 2008
@@ -26,7 +26,7 @@
 	plaintext =3D UnicodeFix(plaintext)
 	GuiAddChatLine(sprintf("%s: %s",text_charname,plaintext)) -- TODO : color=
,font,...
 	JournalAddText(text_charname,plaintext)
-	NotifyListener("Hook_Text",text_charname,plaintext)
+	NotifyListener("Hook_Text",text_charname,plaintext,mobile_serial)
 	=

 	-- check if player -> then show text over player head
 	local mobilespeaker=3DGetMobile(mobile_serial)
@@ -160,7 +160,7 @@
 		GuiAddChatLine(plaintext) -- TODO : color,font,...
 	end
 	JournalAddText(name,plaintext)
-	NotifyListener("Hook_Text",name,plaintext)
+	NotifyListener("Hook_Text",name,plaintext,data.speaker_serial)
 	NotifyListener("Hook_MobName",data.speaker_serial,name)
 	=

 	--~ print("kPacket_Localized_Text_Plus_String")
@@ -214,7 +214,7 @@
 		JournalAddText(text_charname,plaintext)
 	end
 	=

-	NotifyListener("Hook_Text",text_charname,plaintext)
+	NotifyListener("Hook_Text",text_charname,plaintext,text_item_serial)
 	NotifyListener("Hook_Packet_Localized_Text",text_item_serial,plaintext,te=
xt_messagenum,text_type)
 	NotifyListener("Hook_MobName",text_item_serial,plaintext,text_messagenum)
 	=

@@ -279,7 +279,7 @@
 		JournalAddText(unitext_name,unitext_message)
 	end
 	=

-	NotifyListener("Hook_Text",unitext_name,unitext_message)
+	NotifyListener("Hook_Text",unitext_name,unitext_message,mobile_serial)
 	=

 	NotifyListener("Hook_Packet_Text_Unicode",mobile_serial,unitext_message,u=
nitext_type)
 	NotifyListener("Hook_MobName",mobile_serial,unitext_name)



From no-reply at zwischenwelt.org  Fri Oct 31 00:10:51 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Thu, 30 Oct 2008 23:10:51 -0000
Subject: [Iris-commit] [IRIS] r2676 - /trunk/lua/lib.2d.dynamic.lua
Message-ID: <20081030231051.8D5FB1C18651@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 31 00:10:50 2008
New Revision: 2676

Log:
sprite add fail check for 2d dynamic

Modified:
    trunk/lua/lib.2d.dynamic.lua

Modified: trunk/lua/lib.2d.dynamic.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.2d.dynamic.lua (original)
+++ trunk/lua/lib.2d.dynamic.lua Fri Oct 31 00:10:50 2008
@@ -187,9 +187,11 @@
 		local fIndexRel =3D k / totalpartnum
 		if (zloc >=3D iBlendOutMinZ and zloc <=3D iBlendOutMaxZ) then
 			local sprite =3D spriteblock:AddArtSprite(tx,ty,tz,iTileTypeID,iHue,Cal=
cSortBonus(iTileTypeID,sorttx,sortty,sorttz,fIndexRel,1),item)
-			sprite.xloc =3D xloc -- mousepicking
-			sprite.yloc =3D yloc
-			sprite.zloc =3D zloc
+			if (sprite) then
+				sprite.xloc =3D xloc -- mousepicking
+				sprite.yloc =3D yloc
+				sprite.zloc =3D zloc
+			end
 		end
 	end
 	spriteblock:Build(Renderer2D.kSpriteBaseMaterial)



From no-reply at zwischenwelt.org  Fri Oct 31 01:55:59 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 31 Oct 2008 00:55:59 -0000
Subject: [Iris-commit] [IRIS] r2677 - /trunk/bin/iris2.exe
Message-ID: <20081031005559.4B9371C18651@zwischenwelt.org>

Author: sience
Date: Fri Oct 31 01:55:58 2008
New Revision: 2677

Log:
-new win32 binary

Modified:
    trunk/bin/iris2.exe

Modified: trunk/bin/iris2.exe
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
Binary files - no diff available.



From no-reply at zwischenwelt.org  Fri Oct 31 23:54:07 2008
From: no-reply at zwischenwelt.org (no-reply at zwischenwelt.org)
Date: Fri, 31 Oct 2008 22:54:07 -0000
Subject: [Iris-commit] [IRIS] r2678 - /trunk/lua/lib.loading.lua
Message-ID: <20081031225412.55ABC1C18403@zwischenwelt.org>

Author: ghoulsblade
Date: Fri Oct 31 23:54:05 2008
New Revision: 2678

Log:
don't preload meshes for 2d mode, to save vram

Modified:
    trunk/lua/lib.loading.lua

Modified: trunk/lua/lib.loading.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.loading.lua (original)
+++ trunk/lua/lib.loading.lua Fri Oct 31 23:54:05 2008
@@ -299,7 +299,7 @@
 	local left =3D 70
 	local to =3D 16085
 =

-	if gPreloadStaticMesh then
+	if gPreloadStaticMesh and gCurrentRenderer =3D=3D Renderer3D then
 		LoadingProfile("preload static meshes")
 		=

 		for i =3D 0,to do



