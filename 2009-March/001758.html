<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Iris-commit] [IRIS] r2956 - in /trunk/lua: lib.mainmenu.accountlist.lua lib.mainmenu.background.lua lib.mainmenu.charcreate.lua lib.mainmenu.charlist.lua lib.mainmenu.lua lib.mainmenu.old.lua lib.mainmenu.shardlist.lua lib.shardlist.lua
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/iris-commit/2009-March/index.html" >
   <LINK REL="made" HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2956%20-%20in%20/trunk/lua%3A%0A%20lib.mainmenu.accountlist.lua%20lib.mainmenu.background.lua%0A%20lib.mainmenu.charcreate.lua%20lib.mainmenu.charlist.lua%20lib.mainmenu.lua%0A%20lib.mainmenu.old.lua%20lib.mainmenu.shardlist.lua%20lib.shardlist.lua&In-Reply-To=%3C20090314020007.D5B8A1524034%40zwischenwelt.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001756.html">
   <LINK REL="Next"  HREF="001757.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Iris-commit] [IRIS] r2956 - in /trunk/lua: lib.mainmenu.accountlist.lua lib.mainmenu.background.lua lib.mainmenu.charcreate.lua lib.mainmenu.charlist.lua lib.mainmenu.lua lib.mainmenu.old.lua lib.mainmenu.shardlist.lua lib.shardlist.lua</H1>
    <B>no-reply at zwischenwelt.org</B> 
    <A HREF="mailto:iris-commit%40lists.berlios.de?Subject=Re%3A%20%5BIris-commit%5D%20%5BIRIS%5D%20r2956%20-%20in%20/trunk/lua%3A%0A%20lib.mainmenu.accountlist.lua%20lib.mainmenu.background.lua%0A%20lib.mainmenu.charcreate.lua%20lib.mainmenu.charlist.lua%20lib.mainmenu.lua%0A%20lib.mainmenu.old.lua%20lib.mainmenu.shardlist.lua%20lib.shardlist.lua&In-Reply-To=%3C20090314020007.D5B8A1524034%40zwischenwelt.org%3E"
       TITLE="[Iris-commit] [IRIS] r2956 - in /trunk/lua: lib.mainmenu.accountlist.lua lib.mainmenu.background.lua lib.mainmenu.charcreate.lua lib.mainmenu.charlist.lua lib.mainmenu.lua lib.mainmenu.old.lua lib.mainmenu.shardlist.lua lib.shardlist.lua">no-reply at zwischenwelt.org
       </A><BR>
    <I>Sat Mar 14 02:24:52 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001756.html">[Iris-commit] [IRIS] r2954 - /trunk/lua/lib.mainmenu.accountlist.lua
</A></li>
        <LI>Next message: <A HREF="001757.html">[Iris-commit] [IRIS] r2957 - /tools/installer/Iris_Setup.iss
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1758">[ date ]</a>
              <a href="thread.html#1758">[ thread ]</a>
              <a href="subject.html#1758">[ subject ]</a>
              <a href="author.html#1758">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: sience
Date: Sat Mar 14 02:24:51 2009
New Revision: 2956

Log:
-lib.mainmenu.old.lua moved to tools/attic
-small menu bugfix if connect fails
-some prints disabled
-some obsolete things removed

Removed:
    trunk/lua/lib.mainmenu.old.lua
Modified:
    trunk/lua/lib.mainmenu.accountlist.lua
    trunk/lua/lib.mainmenu.background.lua
    trunk/lua/lib.mainmenu.charcreate.lua
    trunk/lua/lib.mainmenu.charlist.lua
    trunk/lua/lib.mainmenu.lua
    trunk/lua/lib.mainmenu.shardlist.lua
    trunk/lua/lib.shardlist.lua

Modified: trunk/lua/lib.mainmenu.accountlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.accountlist.lua (original)
+++ trunk/lua/lib.mainmenu.accountlist.lua Sat Mar 14 02:24:51 2009
@@ -1,90 +1,90 @@
-
-function MainMenu_AccountList_Start ()
-	print(&quot;################################&quot;)
-	print(&quot;MainMenu_AccountList_Start&quot;)
-	MainMenuStopAllMenus()
-	gRememberPassword =3D gRegistrySlow:Get(&quot;gRememberPassword&quot;)
-	=

-	-- clear auto-login if returning to this menu from somewhere else
-	gAutoLoginCharID =3D nil
-	gAutoLoginCharName =3D nil
-	=

-	local rows =3D {}
-	-- manual input
-	local fun_login_manual =3D function () =

-									local user =3D gMainMenuDialog_AccountList:GetEditText(&quot;i_user&quot;)
-									local pass =3D gMainMenuDialog_AccountList:GetEditText(&quot;i_pass&quot;)
-									MainMenu_SendLogin(user,pass) =

-								end
-	table.insert(rows,{		{&quot;Username&quot;},{&quot;Password&quot;},
-						})
-	table.insert(rows,{		{type=3D&quot;EditText&quot;,w=3D128,h=3D16,text=3D&quot;&quot;,controln=
ame=3D&quot;i_user&quot;,nextcontrolname=3D&quot;i_pass&quot;},
-							{type=3D&quot;EditText&quot;,w=3D 64,h=3D16,text=3D&quot;&quot;,controlname=3D&quot;i_pass&quot;,=
nextcontrolname=3D&quot;i_pass1&quot;,onReturn=3Dfun_login_manual,bPassWordStyle=3Dtr=
ue},
-							{&quot;&gt;&quot;,fun_login_manual},
-						})
-	=

-	-- saved charlists
-	local lastpassedit
-	local charlists =3D SortedArrayFromAssocTable(ShardMemoryGetList(&quot;charlis=
t&quot;) or {},function (a,b) return a.gLoginname &lt; b.gLoginname end)
-	charlists =3D FilterArray(charlists,function (charlist) return	charlist.g=
LoginServerIP		=3D=3D gLoginServerIP and =

-																	charlist.gLoginServerPort	=3D=3D gLoginServerPort end)
-	for charlist_idx,charlist in pairs(charlists) do
-		-- list chars in slotorder
-		local mychars =3D {}
-		for i=3D0,20 do if (charlist[i]) then table.insert(mychars,{id=3Di,name=
=3Dcharlist[i]}) else break end end
-		--~ table.sort(mychars,function (a,b) return a.name &lt; b.name end) -- sor=
t by name
-		table.sort(mychars,function (a,b) return a.id &lt; b.id end) -- sort by cha=
rslot, same as in original client charlist
-		=

-		local user =3D charlist.gLoginname or &quot;???&quot;
-		local pass =3D MainMenu_GetStoredPassword(gLoginServerIP,gLoginServerPor=
t,user)
-		=

-		-- one line per non-empty char-slot
-		local bHadFirstChar =3D false
-		local ctrlname_pass =3D &quot;i_pass&quot;..charlist_idx
-		local ctrlname_passnext =3D &quot;i_pass&quot;..(charlist_idx + 1)
-		local fun_mylogin =3D function () MainMenu_SendLogin(user,gMainMenuDialo=
g_AccountList:GetEditText(ctrlname_pass)) end
-		lastpassedit =3D {type=3D&quot;EditText&quot;,w=3D64,h=3D16,text=3D(pass or &quot;&quot;),on=
Return=3Dfun_mylogin,controlname=3Dctrlname_pass,nextcontrolname=3Dctrlname=
_passnext,bPassWordStyle=3Dtrue}
-		local baserow =3D {	{user},
-							lastpassedit,
-							{&quot;&gt;&quot;,fun_mylogin},
-						}
-		for k,char in ipairs(mychars) do =

-			if (char.name ~=3D &quot;&quot;) then
-				local buttontext =3D &quot;#&quot;..k..&quot;:&quot;..char.name
-				local fun_char =3D function () MainMenu_SendLoginAndChar(user,gMainMen=
uDialog_AccountList:GetEditText(ctrlname_pass),char.id,char.name) end
-				=

-				local myrow =3D bHadFirstChar and {{&quot;&quot;},{&quot;&quot;},{&quot;&quot;}} or baserow
-				bHadFirstChar =3D true
-				=

-				table.insert(myrow,{char.name,fun_char})
-				table.insert(myrow,{&quot;3D&quot;,function () gCurrentRenderer =3D Renderer3D f=
un_char() end})
-				table.insert(myrow,{&quot;2D&quot;,function () gCurrentRenderer =3D Renderer2D f=
un_char() end})
-				table.insert(rows,myrow)
-			end
-		end
-		-- if it was a fresh account with no chars yet, or charlist is unknown, =
list the login anyway
-		if (not bHadFirstChar) then table.insert(rows,baserow) end
-	end
-	if (lastpassedit) then lastpassedit.nextcontrolname =3D &quot;i_user&quot; end
-	=

-	local fun_getpwsign =3D function () return gRememberPassword and &quot;X&quot; or &quot;=
 &quot; end
-	local fun_pw =3D function (widget) =

-		gRememberPassword =3D not gRememberPassword
-		gRegistrySlow:Set(&quot;gRememberPassword&quot;,gRememberPassword)
-		widget.AutoScaledButton_text.gfx:SetText(fun_getpwsign())
-		print(&quot;save pw&quot;,widget,gRememberPassword)
-	end
-	table.insert(rows,{{&quot;Back&quot;,MainMenu_AccountList_Back},{&quot;  save PW&quot;},{fun_=
getpwsign(),fun_pw}})
-	gMainMenuDialog_AccountList =3D MainMenu_MakeTableDlg(rows)
-end
-
-function MainMenu_AccountList_Back ()
-	MainMenuResetNetwork()
-	MainMenu_ShardList_Start()
-end
-function MainMenu_AccountList_Stop ()
-	if (gMainMenuDialog_AccountList) then =

-		gMainMenuDialog_AccountList:Destroy() =

-		gMainMenuDialog_AccountList =3D nil
-	end
-end
+
+function MainMenu_AccountList_Start ()
+--  print(&quot;################################&quot;)
+--  print(&quot;MainMenu_AccountList_Start&quot;)
+    MainMenuStopAllMenus()
+    gRememberPassword =3D gRegistrySlow:Get(&quot;gRememberPassword&quot;)
+    =

+    -- clear auto-login if returning to this menu from somewhere else
+    gAutoLoginCharID =3D nil
+    gAutoLoginCharName =3D nil
+    =

+    local rows =3D {}
+    -- manual input
+    local fun_login_manual =3D function () =

+                                    local user =3D gMainMenuDialog_Account=
List:GetEditText(&quot;i_user&quot;)
+                                    local pass =3D gMainMenuDialog_Account=
List:GetEditText(&quot;i_pass&quot;)
+                                    MainMenu_SendLogin(user,pass) =

+                                end
+    table.insert(rows,{     {&quot;Username&quot;},{&quot;Password&quot;},
+                        })
+    table.insert(rows,{     {type=3D&quot;EditText&quot;,w=3D128,h=3D16,text=3D&quot;&quot;,co=
ntrolname=3D&quot;i_user&quot;,nextcontrolname=3D&quot;i_pass&quot;},
+                            {type=3D&quot;EditText&quot;,w=3D 64,h=3D16,text=3D&quot;&quot;,co=
ntrolname=3D&quot;i_pass&quot;,nextcontrolname=3D&quot;i_pass1&quot;,onReturn=3Dfun_login_manua=
l,bPassWordStyle=3Dtrue},
+                            {&quot;&gt;&quot;,fun_login_manual},
+                        })
+    =

+    -- saved charlists
+    local lastpassedit
+    local charlists =3D SortedArrayFromAssocTable(ShardMemoryGetList(&quot;char=
list&quot;) or {},function (a,b) return a.gLoginname &lt; b.gLoginname end)
+    charlists =3D FilterArray(charlists,function (charlist) return    char=
list.gLoginServerIP     =3D=3D gLoginServerIP and =

+                                                                    charli=
st.gLoginServerPort   =3D=3D gLoginServerPort end)
+    for charlist_idx,charlist in pairs(charlists) do
+        -- list chars in slotorder
+        local mychars =3D {}
+        for i=3D0,20 do if (charlist[i]) then table.insert(mychars,{id=3Di=
,name=3Dcharlist[i]}) else break end end
+        --~ table.sort(mychars,function (a,b) return a.name &lt; b.name end) =
-- sort by name
+        table.sort(mychars,function (a,b) return a.id &lt; b.id end) -- sort =
by charslot, same as in original client charlist
+        =

+        local user =3D charlist.gLoginname or &quot;???&quot;
+        local pass =3D MainMenu_GetStoredPassword(gLoginServerIP,gLoginSer=
verPort,user)
+        =

+        -- one line per non-empty char-slot
+        local bHadFirstChar =3D false
+        local ctrlname_pass =3D &quot;i_pass&quot;..charlist_idx
+        local ctrlname_passnext =3D &quot;i_pass&quot;..(charlist_idx + 1)
+        local fun_mylogin =3D function () MainMenu_SendLogin(user,gMainMen=
uDialog_AccountList:GetEditText(ctrlname_pass)) end
+        lastpassedit =3D {type=3D&quot;EditText&quot;,w=3D64,h=3D16,text=3D(pass or =
&quot;&quot;),onReturn=3Dfun_mylogin,controlname=3Dctrlname_pass,nextcontrolname=3Dct=
rlname_passnext,bPassWordStyle=3Dtrue}
+        local baserow =3D {   {user},
+                            lastpassedit,
+                            {&quot;&gt;&quot;,fun_mylogin},
+                        }
+        for k,char in ipairs(mychars) do =

+            if (char.name ~=3D &quot;&quot;) then
+                local buttontext =3D &quot;#&quot;..k..&quot;:&quot;..char.name
+                local fun_char =3D function () MainMenu_SendLoginAndChar(u=
ser,gMainMenuDialog_AccountList:GetEditText(ctrlname_pass),char.id,char.nam=
e) end
+                =

+                local myrow =3D bHadFirstChar and {{&quot;&quot;},{&quot;&quot;},{&quot;&quot;}} or base=
row
+                bHadFirstChar =3D true
+                =

+                table.insert(myrow,{char.name,fun_char})
+                table.insert(myrow,{&quot;3D&quot;,function () gCurrentRenderer =3D =
Renderer3D fun_char() end})
+                table.insert(myrow,{&quot;2D&quot;,function () gCurrentRenderer =3D =
Renderer2D fun_char() end})
+                table.insert(rows,myrow)
+            end
+        end
+        -- if it was a fresh account with no chars yet, or charlist is unk=
nown, list the login anyway
+        if (not bHadFirstChar) then table.insert(rows,baserow) end
+    end
+    if (lastpassedit) then lastpassedit.nextcontrolname =3D &quot;i_user&quot; end
+    =

+    local fun_getpwsign =3D function () return gRememberPassword and &quot;X&quot; o=
r &quot; &quot; end
+    local fun_pw =3D function (widget) =

+        gRememberPassword =3D not gRememberPassword
+        gRegistrySlow:Set(&quot;gRememberPassword&quot;,gRememberPassword)
+        widget.AutoScaledButton_text.gfx:SetText(fun_getpwsign())
+--      print(&quot;save pw&quot;,widget,gRememberPassword)
+    end
+    table.insert(rows,{{&quot;Back&quot;,MainMenu_AccountList_Back},{&quot;  save PW&quot;},{f=
un_getpwsign(),fun_pw}})
+    gMainMenuDialog_AccountList =3D MainMenu_MakeTableDlg(rows)
+end
+
+function MainMenu_AccountList_Back ()
+    MainMenuResetNetwork()
+    MainMenu_ShardList_Start()
+end
+function MainMenu_AccountList_Stop ()
+    if (gMainMenuDialog_AccountList) then =

+        gMainMenuDialog_AccountList:Destroy() =

+        gMainMenuDialog_AccountList =3D nil
+    end
+end

Modified: trunk/lua/lib.mainmenu.background.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.background.lua (original)
+++ trunk/lua/lib.mainmenu.background.lua Sat Mar 14 02:24:51 2009
@@ -1,41 +1,23 @@
-
-RegisterListener(&quot;Hook_StartInGame&quot;,function () MainMenu_Background_Stop()=
 end)
-
-function MainMenu_Background_Start ()
-	if (gNoRender) then return end
-	local vp =3D GetMainViewport()
-	local w =3D vp:GetActualWidth()
-	local h =3D vp:GetActualHeight()
-	local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPlainT=
extureGUIMat(&quot;menu_bg.jpg&quot;), 1024, 768)
-	if (gMenuBgImage) then gMenuBgImage:Destroy() end
-	gMenuBgImage =3D GetDesktopWidget():CreateChild(&quot;Image&quot;,{gfxparam_init=3D=
gfxparam_init})
-	gMenuBgImage:SetPos(0,0)
-	gMenuBgImage:SetSize(w,h)
-	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-	=

-	-- start menu sound
-	SoundPlayMusicById(8)
-end
-
-function MainMenu_Background_Stop ()
-	DestroyIfAlive(gMenuBgImage)
-	gMenuBgImage =3D nil
-end
-
---[[
--- old, wasn't used anymore
-local function SetMainMenuCam (roth,rotv)
-	local cam =3D GetMainCam()
-	cam:SetFOVy(gfDeg2Rad*45)
-	cam:SetNearClipDistance(0.5) -- old : 1
-	cam:SetFarClipDistance(2000) -- ogre defaul : 100000
-	cam:SetProjectionType(kCamera_PT_PERSPECTIVE) -- perspective
-	local w1,x1,y1,z1 =3D Quaternion.fromAngleAxis(gfDeg2Rad * 90.0,1,0,0)
-	local w2,x2,y2,z2 =3D Quaternion.fromAngleAxis(roth,0,1,0)	=

-	local w3,x3,y3,z3 =3D Quaternion.fromAngleAxis(rotv,1,0,0)
-	local w4,x4,y4,z4 =3D Quaternion.Mul(w1,x1,y1,z1, w2,x2,y2,z2)
-	=

-	local w,x,y,z =3D Quaternion.Mul(w4,x4,y4,z4, w3,x3,y3,z3)
-	GetMainCam():SetRot(w,x,y,z)	=

-end
-]]--
+
+RegisterListener(&quot;Hook_StartInGame&quot;,function () MainMenu_Background_Stop()=
 end)
+
+function MainMenu_Background_Start ()
+    if (gNoRender) then return end
+    local vp =3D GetMainViewport()
+    local w =3D vp:GetActualWidth()
+    local h =3D vp:GetActualHeight()
+    local gfxparam_init =3D MakeSpritePanelParam_SingleSpriteSimple(GetPla=
inTextureGUIMat(&quot;menu_bg.jpg&quot;), 1024, 768)
+    if (gMenuBgImage) then gMenuBgImage:Destroy() end
+    gMenuBgImage =3D GetDesktopWidget():CreateChild(&quot;Image&quot;,{gfxparam_init=
=3Dgfxparam_init})
+    gMenuBgImage:SetPos(0,0)
+    gMenuBgImage:SetSize(w,h)
+    if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
+    =

+    -- start menu sound
+    SoundPlayMusicById(8)
+end
+
+function MainMenu_Background_Stop ()
+    DestroyIfAlive(gMenuBgImage)
+    gMenuBgImage =3D nil
+end

Modified: trunk/lua/lib.mainmenu.charcreate.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.charcreate.lua (original)
+++ trunk/lua/lib.mainmenu.charcreate.lua Sat Mar 14 02:24:51 2009
@@ -1,281 +1,281 @@
--- kPacket_CharacterCreation -- 0x00
-function MainMenu_CharCreate_Start ()
-	local forbiddenskills =3D {	gCharCreateSkillIDs[&quot;Stealth&quot;],
-								gCharCreateSkillIDs[&quot;Remove Trap&quot;],
-								gCharCreateSkillIDs[&quot;Spellweaving&quot;], } -- can't choose from those =
at charcreate
-	=

-	print(&quot;########################&quot;)
-	print(&quot;MainMenu_CharCreate_Start&quot;,freeslot)
-	MainMenuStopAllMenus()
-
-	gCharCreateData =3D {}
-	gCharCreateDataEnums =3D {}
-	=

-	local skilllist =3D {}
-	for skillid,name in pairs(glSkillNames) do =

-		if (not in_array(skillid-1,forbiddenskills)) then =

-			table.insert(skilllist,{id=3Dskillid-1,name=3Dname})
-		end
-	end
-	skilllist =3D SortedArrayFromAssocTable(skilllist,function (a,b) return a=
.name &lt; b.name end)
-	=

-	local sexlist =3D {	{id=3D0,name=3D&quot;Human/Male&quot;},
-						{id=3D1,name=3D&quot;Human/Female&quot;},
-						{id=3D2,name=3D&quot;Elf/Male&quot;},
-						{id=3D3,name=3D&quot;Elf/Female&quot;},
-						}
-	gCharCreateDataEnums[&quot;sex&quot;] =3D sexlist
-		=

-	local rows =3D {}
-	table.insert(rows,{{&quot;Create character&quot;}})
-	table.insert(rows,{{&quot;Name:&quot;},			{&quot;&quot;},	{type=3D&quot;EditText&quot;,w=3D128,h=3D16,t=
ext=3D&quot;&quot;,controlname=3D&quot;name&quot;}})
-	table.insert(rows,{{&quot;Race/Gender:&quot;},	{&quot;&quot;},	{sexlist[1].name,function (w) =
MainMenu_CharCreate_Choose(w) end,controlname=3D&quot;sex&quot;}})
-	=

-	=

-	-- lock stats
-	gCharCreateStatLock =3D {}
-	function MyCheck (valfield) return {&quot; &quot;,function (widget) =

-		gCharCreateStatLock[valfield] =3D not gCharCreateStatLock[valfield]
-		widget.AutoScaledButton_text.gfx:SetText(gCharCreateStatLock[valfield] a=
nd &quot;L&quot; or &quot;&quot;)
-		end} end
-		=

-	-- generic value add/sub
-	function MyAddNumCtrl (valfield,rules,row) =

-		table.insert(row,{&quot;-10&quot;,function () MyModValue(valfield,rules,-10) end})
-		table.insert(row,{&quot;-1&quot;,	function () MyModValue(valfield,rules,-1) end})
-		table.insert(row,{&quot;+1&quot;,	function () MyModValue(valfield,rules, 1) end})
-		table.insert(row,{&quot;+10&quot;,function () MyModValue(valfield,rules, 10) end})
-		return row =

-	end
-	function MyModValue (valfield,rules,wantedadd) =

-		local curval =3D gCharCreateData[valfield]
-		local newval =3D math.max(rules.min,math.min(rules.max,curval+wantedadd))
-		wantedadd =3D newval - curval
-		if (wantedadd =3D=3D 0) then return end
-		=

-		local realadd =3D 0
-		for k,other in pairs(rules.fields) do =

-			if (other ~=3D valfield and (not gCharCreateStatLock[other])) then
-				local otherold =3D gCharCreateData[other]
-				local othernew =3D math.max(rules.min,math.min(rules.max,otherold - wa=
ntedadd))
-				MainMenu_CharCreate_SetValue(other,othernew)
-				local diff =3D othernew - otherold -- if i want to add, this is negati=
ve
-				realadd =3D realadd - diff
-				wantedadd =3D wantedadd + diff
-			end
-		end
-		if (realadd =3D=3D 0) then return end
-		=

-		gCharCreateData.prof =3D 0
-		MainMenu_CharCreate_SetValue(valfield,curval + realadd)
-	end
-	=

-	-- 3 stats
-	local rules =3D {min=3D10,max=3D60,sum=3D80,fields=3D{&quot;str&quot;,&quot;dex&quot;,&quot;int&quot;}}
-	gCharCreateData.str =3D 60
-	gCharCreateData.dex =3D 10
-	gCharCreateData.int =3D 10
-	local valfield=3D&quot;str&quot; table.insert(rows,MyAddNumCtrl(valfield,rules,{{&quot;S=
tr:&quot;},{&quot;&quot;..gCharCreateData[valfield],controlname=3Dvalfield},{&quot;&quot;},MyCheck(v=
alfield)}))
-	local valfield=3D&quot;dex&quot; table.insert(rows,MyAddNumCtrl(valfield,rules,{{&quot;D=
ex:&quot;},{&quot;&quot;..gCharCreateData[valfield],controlname=3Dvalfield},{&quot;&quot;},MyCheck(v=
alfield)}))
-	local valfield=3D&quot;int&quot; table.insert(rows,MyAddNumCtrl(valfield,rules,{{&quot;I=
nt:&quot;},{&quot;&quot;..gCharCreateData[valfield],controlname=3Dvalfield},{&quot;&quot;},MyCheck(v=
alfield)}))
-	=

-	-- 3 skills
-	local rules =3D {min=3D0,max=3D50,sum=3D100,fields=3D{&quot;skill1value&quot;,&quot;skil=
l2value&quot;,&quot;skill3value&quot;}}
-	gCharCreateData.skill1value =3D 50
-	gCharCreateData.skill2value =3D 50
-	gCharCreateData.skill3value =3D 0
-	for i =3D 1,3 do =

-		local valfield1 =3D &quot;skill&quot;..i
-		local valfield2 =3D &quot;skill&quot;..i..&quot;value&quot;
-		gCharCreateDataEnums[valfield1] =3D skilllist
-		table.insert(rows,MyAddNumCtrl(valfield2,rules,{	{&quot;Skill&quot;..i..&quot;:&quot;},
-							{&quot;&quot;..gCharCreateData[valfield2],controlname=3Dvalfield2},
-							{&quot;---&quot;,function (w) gCharCreateData.prof =3D 0 MainMenu_CharCreate_=
Choose(w,2) end,controlname=3Dvalfield1},
-							MyCheck(valfield2),
-						}))
-	end
-	=

-	--[[
-	-- stats : min=3D10,max=3D60,sum=3D80
-	-- skill : min=3D0,max=3D50,sum=3D100
-	newChar.Hue =3D newChar.Race.ClipSkinHue( args.Hue &amp; 0x3FFF ) | 0x8000;
-	if( race.ValidateHair( newChar, args.HairID ) )
-	newChar.HairHue =3D race.ClipHairHue( args.HairHue &amp; 0x3FFF );
-	if( race.ValidateFacialHair( newChar, args.BeardID ) )
-	newChar.FacialHairHue =3D race.ClipHairHue( args.BeardHue &amp; 0x3FFF );
-			int hue =3D Utility.ClipDyedHue( shirtHue &amp; 0x3FFF );
-			int hue =3D Utility.ClipDyedHue( pantsHue &amp; 0x3FFF );
-			=

-			public static int ClipDyedHue( int hue ) {
-				if ( hue &lt; 2 ) return 2;
-				else if ( hue &gt; 1001 ) return 1001;
-				else return hue;
-			}
-			=

-			public override bool human:ValidateHair( bool female, int itemID ) {
-				if( itemID =3D=3D 0 ) return true;
-				if( (female &amp;&amp; itemID =3D=3D 0x2048) || (!female &amp;&amp; itemID =3D=3D 0x20=
46 ) ) return false;	//Buns &amp; Receeding Hair
-				if( itemID &gt;=3D 0x203B &amp;&amp; itemID &lt;=3D 0x203D ) return true;
-				if( itemID &gt;=3D 0x2044 &amp;&amp; itemID &lt;=3D 0x204A ) return true;
-				return false;
-			}
-			public override bool elf:ValidateHair( bool female, int itemID )
-			{
-				if( itemID =3D=3D 0 ) return true;
-				if( (female &amp;&amp; (itemID =3D=3D 0x2FCD || itemID =3D=3D 0x2FBF)) || (!fe=
male &amp;&amp; (itemID =3D=3D 0x2FCC || itemID =3D=3D 0x2FD0)) ) return false;
-				if( itemID &gt;=3D 0x2FBF &amp;&amp; itemID &lt;=3D 0x2FC2 ) return true;
-				if( itemID &gt;=3D 0x2FCC &amp;&amp; itemID &lt;=3D 0x2FD1 ) return true;
-				return false;
-			}
-			public override bool human:ValidateFacialHair( bool female, int itemID =
) {
-				if( itemID =3D=3D 0 ) return true;
-				if( female ) return false;
-				if( itemID &gt;=3D 0x203E &amp;&amp; itemID &lt;=3D 0x2041 ) return true;
-				if( itemID &gt;=3D 0x204B &amp;&amp; itemID &lt;=3D 0x204D ) return true;
-				return false;
-			}
-			public override bool elf:ValidateFacialHair( bool female, int itemID ) {
-				return (itemID =3D=3D 0);
-			}
-			=

-		public override int human:ClipHairHue( int hue )
-		{
-			if( hue &lt; 1102 ) return 1102;
-			else if( hue &gt; 1149 ) return 1149;
-			else return hue;
-		}
-		public override int elf:ClipHairHue( int hue )
-		{
-				{
-					0x034, 0x035, 0x036, 0x037, 0x038, 0x039, 0x058, 0x08E,
-					0x08F, 0x090, 0x091, 0x092, 0x101, 0x159, 0x15A, 0x15B,
-					0x15C, 0x15D, 0x15E, 0x128, 0x12F, 0x1BD, 0x1E4, 0x1F3,
-					0x207, 0x211, 0x239, 0x251, 0x26C, 0x2C3, 0x2C9, 0x31D,
-					0x31E, 0x31F, 0x320, 0x321, 0x322, 0x323, 0x324, 0x325,
-					0x326, 0x369, 0x386, 0x387, 0x388, 0x389, 0x38A, 0x59D,
-					0x6B8, 0x725, 0x853
-				}
-			for( int i =3D 0; i &lt; m_HairHues.Length; i++ )
-				if( m_HairHues[i] =3D=3D hue )
-					return hue;
-			return m_HairHues[0];
-		}
-	]]--
-	=

-	--[[
-	table.insert(rows,{{&quot;SkinColor:&quot;},			{&quot;&quot;},	{&quot;&quot;,function (w) MainMenu_Char=
Create_ChooseColor(w) end,controlname=3D&quot;skinColor&quot;}})
-	table.insert(rows,{{&quot;HairColor:&quot;},			{&quot;&quot;},	{&quot;&quot;,function (w) MainMenu_Char=
Create_ChooseColor(w) end,controlname=3D&quot;hairColor&quot;}})
-	table.insert(rows,{{&quot;BeardColor:&quot;},			{&quot;&quot;},	{&quot;&quot;,function (w) MainMenu_Cha=
rCreate_ChooseColor(w) end,controlname=3D&quot;facialHairColor&quot;}})
-	table.insert(rows,{{&quot;ShirtColor:&quot;},			{&quot;&quot;},	{&quot;&quot;,function (w) MainMenu_Cha=
rCreate_ChooseColor(w) end,controlname=3D&quot;shirtColor&quot;}})
-	table.insert(rows,{{&quot;PantsColor:&quot;},			{&quot;&quot;},	{&quot;&quot;,function (w) MainMenu_Cha=
rCreate_ChooseColor(w) end,controlname=3D&quot;pantsColor&quot;}})
-	=

-	local hairlist =3D {&quot;none&quot;}
-	local beardlist =3D {&quot;none&quot;}
-	local citylist =3D {&quot;none&quot;}
-	=

-	table.insert(rows,{{&quot;Hair:&quot;},				{&quot;&quot;},	{hairlist[1],function (w) MainMenu=
_CharCreate_Choose(w) end,controlname=3D&quot;hairStyle&quot;}})
-	table.insert(rows,{{&quot;Beard:&quot;},				{&quot;&quot;},	{hairlist[1],function (w) MainMen=
u_CharCreate_Choose(w) end,controlname=3D&quot;facialHair&quot;}})
-	-- uogamers: 0=3Dyew,1=3Dminoc,2=3Dbrit,3=3Dmoonglow,4=3Dtrinsik,5=3DMagi=
ncia,6=3Djhelom,7=3Dscara,8=3Dvesper,9=3Docclo
-	]]--
-	=

-	-- starting city
-	local citylist =3D SortedArrayFromAssocTable(gCities,function (a,b) retur=
n a.i &lt; b.i end)
-	for k,city in pairs(citylist) do citylist[k] =3D {id=3Dcity.index,name=3D=
city.name..&quot;:&quot;..city.tavern} end
-	local valfield =3D &quot;location&quot;
-	gCharCreateDataEnums[valfield] =3D citylist
-	table.insert(rows,{{&quot;Location:&quot;},			{&quot;&quot;},	{citylist[1].name,function (w) =
MainMenu_CharCreate_Choose(w) end,controlname=3Dvalfield}})
-	=

-	=

-	table.insert(rows,{{&quot;Create Char&quot;,MainMenu_CharCreate_Submit}})
-	table.insert(rows,{{&quot;&quot;}})
-	local templates =3D GetCharCreationTemplates() -- see lib.charcreate.lua =
:<i> uo/Prof.txt =
</I>
-	local validtemplates =3D {&quot;Samurai&quot;, &quot;Ninja&quot;, &quot;Paladin&quot;,&quot;Necromancer&quot;, &quot;W=
arrior&quot;,&quot;Mage&quot;,&quot;Blacksmith&quot;}
-	for k2,template in pairs(templates) do
-		print(&quot;chartemplate&quot;,template.Name,in_array(template.Name,validtemplates=
))
-		if (in_array(template.Name,validtemplates)) then
-			table.insert(rows,{{&quot;&quot;},{&quot;&quot;},{&quot;Template:&quot;..template.Name,function () =

-					for k,v in pairs(CharCreateTemplateMod_GetValues(template)) do MainMe=
nu_CharCreate_SetValue(k,v) end
-				end}})
-		end
-	end
-	table.insert(rows,{{&quot;&quot;}})
-	table.insert(rows,{{&quot;Back&quot;,MainMenu_CharCreate_Back}})
-	gMainMenuDialog_CharCreate =3D MainMenu_MakeTableDlg(rows) =

-end
-
-
--- utils
-
-function MainMenu_CharCreate_SetValue (valfield,value)
-	gCharCreateData[valfield] =3D value
-	local widget =3D gMainMenuDialog_CharCreate.controls[valfield]
-	local enum =3D gCharCreateDataEnums[valfield]
-	print(&quot;MainMenu_CharCreate_SetValue&quot;,valfield,value,enum,widget)
-	if (not widget) then return end
-	if (enum) then =

-		-- chooser button
-		for k,v in pairs(gCharCreateDataEnums[valfield]) do
-			if (v.id =3D=3D value) then
-				widget.AutoScaledButton_text.gfx:SetText(v.name)
-			end
-		end
-	else =

-		-- text
-		widget.gfx:SetText(&quot;&quot;..value)
-	end
-end
-
-function MainMenu_CharCreate_Choose (widget,cols)
-	MainMenu_CharCreate_Choose_Stop()
-	local rows =3D {}
-	local lastrow
-	local valfield =3D widget.controlname
-	cols =3D cols or 1
-	for k,v in pairs(gCharCreateDataEnums[valfield]) do =

-		local item =3D {v.name,function ()
-					print(&quot;MainMenu_CharCreate_Choose&quot;,v.id,v.name)
-					MainMenu_CharCreate_SetValue(valfield,v.id)
-					MainMenu_CharCreate_Choose_Stop()
-					end}
-		if (math.mod(k-1,cols) =3D=3D 0) then
-			lastrow =3D {item}
-			table.insert(rows,lastrow)
-		else
-			table.insert(lastrow,item)
-		end
-	end
-	table.insert(rows,{{&quot;Cancel&quot;,MainMenu_CharCreate_Choose_Stop}})
-	gMainMenuDialog_CharCreate_Choose =3D MainMenu_MakeTableDlg(rows,300,10) =

-end
-function MainMenu_CharCreate_Choose_Stop ()
-	if (gMainMenuDialog_CharCreate_Choose) then =

-		gMainMenuDialog_CharCreate_Choose:Destroy() =

-		gMainMenuDialog_CharCreate_Choose =3D nil
-	end
-end
-
--- rest =

-
-function MainMenu_CharCreate_Back ()
-	MainMenu_CharList_Start()
-end
- =

-function MainMenu_CharCreate_Stop () =

-	if (gMainMenuDialog_CharCreate) then =

-		gMainMenuDialog_CharCreate:Destroy() =

-		gMainMenuDialog_CharCreate =3D nil
-	end
-end
-
-function MainMenu_CharCreate_Submit ()
-	-- TODO
-	print(&quot;##########################&quot;)
-	print(&quot;MainMenu_CharCreate_Submit&quot;)
-	gCharCreateData.slot =3D MainMenu_CharCreate_GetFreeSlot()
-	gCharCreateData.name =3D gMainMenuDialog_CharCreate:GetEditText(&quot;name&quot;)
-	for k,v in pairs(gCharCreateData) do print(k,v) end
-	local chardata =3D CreateSampleCharData()
-	for k,v in pairs(gCharCreateData) do chardata[k] =3D v end
-	Send_CharCreate(chardata)
-	MainMenu_CharCreate_Stop()
-end
+-- kPacket_CharacterCreation -- 0x00
+function MainMenu_CharCreate_Start ()
+    local forbiddenskills =3D {   gCharCreateSkillIDs[&quot;Stealth&quot;],
+                                gCharCreateSkillIDs[&quot;Remove Trap&quot;],
+                                gCharCreateSkillIDs[&quot;Spellweaving&quot;], } -- =
can't choose from those at charcreate
+    =

+--  print(&quot;########################&quot;)
+--  print(&quot;MainMenu_CharCreate_Start&quot;,freeslot)
+    MainMenuStopAllMenus()
+
+    gCharCreateData =3D {}
+    gCharCreateDataEnums =3D {}
+    =

+    local skilllist =3D {}
+    for skillid,name in pairs(glSkillNames) do =

+        if (not in_array(skillid-1,forbiddenskills)) then =

+            table.insert(skilllist,{id=3Dskillid-1,name=3Dname})
+        end
+    end
+    skilllist =3D SortedArrayFromAssocTable(skilllist,function (a,b) retur=
n a.name &lt; b.name end)
+    =

+    local sexlist =3D {   {id=3D0,name=3D&quot;Human/Male&quot;},
+                        {id=3D1,name=3D&quot;Human/Female&quot;},
+                        {id=3D2,name=3D&quot;Elf/Male&quot;},
+                        {id=3D3,name=3D&quot;Elf/Female&quot;},
+                        }
+    gCharCreateDataEnums[&quot;sex&quot;] =3D sexlist
+        =

+    local rows =3D {}
+    table.insert(rows,{{&quot;Create character&quot;}})
+    table.insert(rows,{{&quot;Name:&quot;},           {&quot;&quot;},   {type=3D&quot;EditText&quot;,w=
=3D128,h=3D16,text=3D&quot;&quot;,controlname=3D&quot;name&quot;}})
+    table.insert(rows,{{&quot;Race/Gender:&quot;},    {&quot;&quot;},   {sexlist[1].name,funct=
ion (w) MainMenu_CharCreate_Choose(w) end,controlname=3D&quot;sex&quot;}})
+    =

+    =

+    -- lock stats
+    gCharCreateStatLock =3D {}
+    function MyCheck (valfield) return {&quot; &quot;,function (widget) =

+        gCharCreateStatLock[valfield] =3D not gCharCreateStatLock[valfield]
+        widget.AutoScaledButton_text.gfx:SetText(gCharCreateStatLock[valfi=
eld] and &quot;L&quot; or &quot;&quot;)
+        end} end
+        =

+    -- generic value add/sub
+    function MyAddNumCtrl (valfield,rules,row) =

+        table.insert(row,{&quot;-10&quot;,function () MyModValue(valfield,rules,-10)=
 end})
+        table.insert(row,{&quot;-1&quot;, function () MyModValue(valfield,rules,-1) =
end})
+        table.insert(row,{&quot;+1&quot;, function () MyModValue(valfield,rules, 1) =
end})
+        table.insert(row,{&quot;+10&quot;,function () MyModValue(valfield,rules, 10)=
 end})
+        return row =

+    end
+    function MyModValue (valfield,rules,wantedadd) =

+        local curval =3D gCharCreateData[valfield]
+        local newval =3D math.max(rules.min,math.min(rules.max,curval+want=
edadd))
+        wantedadd =3D newval - curval
+        if (wantedadd =3D=3D 0) then return end
+        =

+        local realadd =3D 0
+        for k,other in pairs(rules.fields) do =

+            if (other ~=3D valfield and (not gCharCreateStatLock[other])) =
then
+                local otherold =3D gCharCreateData[other]
+                local othernew =3D math.max(rules.min,math.min(rules.max,o=
therold - wantedadd))
+                MainMenu_CharCreate_SetValue(other,othernew)
+                local diff =3D othernew - otherold -- if i want to add, th=
is is negative
+                realadd =3D realadd - diff
+                wantedadd =3D wantedadd + diff
+            end
+        end
+        if (realadd =3D=3D 0) then return end
+        =

+        gCharCreateData.prof =3D 0
+        MainMenu_CharCreate_SetValue(valfield,curval + realadd)
+    end
+    =

+    -- 3 stats
+    local rules =3D {min=3D10,max=3D60,sum=3D80,fields=3D{&quot;str&quot;,&quot;dex&quot;,&quot;int=
&quot;}}
+    gCharCreateData.str =3D 60
+    gCharCreateData.dex =3D 10
+    gCharCreateData.int =3D 10
+    local valfield=3D&quot;str&quot; table.insert(rows,MyAddNumCtrl(valfield,rules,{=
{&quot;Str:&quot;},{&quot;&quot;..gCharCreateData[valfield],controlname=3Dvalfield},{&quot;&quot;},MyChec=
k(valfield)}))
+    local valfield=3D&quot;dex&quot; table.insert(rows,MyAddNumCtrl(valfield,rules,{=
{&quot;Dex:&quot;},{&quot;&quot;..gCharCreateData[valfield],controlname=3Dvalfield},{&quot;&quot;},MyChec=
k(valfield)}))
+    local valfield=3D&quot;int&quot; table.insert(rows,MyAddNumCtrl(valfield,rules,{=
{&quot;Int:&quot;},{&quot;&quot;..gCharCreateData[valfield],controlname=3Dvalfield},{&quot;&quot;},MyChec=
k(valfield)}))
+    =

+    -- 3 skills
+    local rules =3D {min=3D0,max=3D50,sum=3D100,fields=3D{&quot;skill1value&quot;,&quot;s=
kill2value&quot;,&quot;skill3value&quot;}}
+    gCharCreateData.skill1value =3D 50
+    gCharCreateData.skill2value =3D 50
+    gCharCreateData.skill3value =3D 0
+    for i =3D 1,3 do =

+        local valfield1 =3D &quot;skill&quot;..i
+        local valfield2 =3D &quot;skill&quot;..i..&quot;value&quot;
+        gCharCreateDataEnums[valfield1] =3D skilllist
+        table.insert(rows,MyAddNumCtrl(valfield2,rules,{    {&quot;Skill&quot;..i..&quot;=
:<i>&quot;},
</I>+                            {&quot;&quot;..gCharCreateData[valfield2],controlname=3D=
valfield2},
+                            {&quot;---&quot;,function (w) gCharCreateData.prof =3D 0=
 MainMenu_CharCreate_Choose(w,2) end,controlname=3Dvalfield1},
+                            MyCheck(valfield2),
+                        }))
+    end
+    =

+    --[[
+    -- stats : min=3D10,max=3D60,sum=3D80
+    -- skill : min=3D0,max=3D50,sum=3D100
+    newChar.Hue =3D newChar.Race.ClipSkinHue( args.Hue &amp; 0x3FFF ) | 0x8000;
+    if( race.ValidateHair( newChar, args.HairID ) )
+    newChar.HairHue =3D race.ClipHairHue( args.HairHue &amp; 0x3FFF );
+    if( race.ValidateFacialHair( newChar, args.BeardID ) )
+    newChar.FacialHairHue =3D race.ClipHairHue( args.BeardHue &amp; 0x3FFF );
+            int hue =3D Utility.ClipDyedHue( shirtHue &amp; 0x3FFF );
+            int hue =3D Utility.ClipDyedHue( pantsHue &amp; 0x3FFF );
+            =

+            public static int ClipDyedHue( int hue ) {
+                if ( hue &lt; 2 ) return 2;
+                else if ( hue &gt; 1001 ) return 1001;
+                else return hue;
+            }
+            =

+            public override bool human:ValidateHair( bool female, int item=
ID ) {
+                if( itemID =3D=3D 0 ) return true;
+                if( (female &amp;&amp; itemID =3D=3D 0x2048) || (!female &amp;&amp; itemID=
 =3D=3D 0x2046 ) ) return false;  //Buns &amp; Receeding Hair
+                if( itemID &gt;=3D 0x203B &amp;&amp; itemID &lt;=3D 0x203D ) return true;
+                if( itemID &gt;=3D 0x2044 &amp;&amp; itemID &lt;=3D 0x204A ) return true;
+                return false;
+            }
+            public override bool elf:ValidateHair( bool female, int itemID=
 )
+            {
+                if( itemID =3D=3D 0 ) return true;
+                if( (female &amp;&amp; (itemID =3D=3D 0x2FCD || itemID =3D=3D 0x2F=
BF)) || (!female &amp;&amp; (itemID =3D=3D 0x2FCC || itemID =3D=3D 0x2FD0)) ) retur=
n false;
+                if( itemID &gt;=3D 0x2FBF &amp;&amp; itemID &lt;=3D 0x2FC2 ) return true;
+                if( itemID &gt;=3D 0x2FCC &amp;&amp; itemID &lt;=3D 0x2FD1 ) return true;
+                return false;
+            }
+            public override bool human:ValidateFacialHair( bool female, in=
t itemID ) {
+                if( itemID =3D=3D 0 ) return true;
+                if( female ) return false;
+                if( itemID &gt;=3D 0x203E &amp;&amp; itemID &lt;=3D 0x2041 ) return true;
+                if( itemID &gt;=3D 0x204B &amp;&amp; itemID &lt;=3D 0x204D ) return true;
+                return false;
+            }
+            public override bool elf:ValidateFacialHair( bool female, int =
itemID ) {
+                return (itemID =3D=3D 0);
+            }
+            =

+        public override int human:ClipHairHue( int hue )
+        {
+            if( hue &lt; 1102 ) return 1102;
+            else if( hue &gt; 1149 ) return 1149;
+            else return hue;
+        }
+        public override int elf:ClipHairHue( int hue )
+        {
+                {
+                    0x034, 0x035, 0x036, 0x037, 0x038, 0x039, 0x058, 0x08E,
+                    0x08F, 0x090, 0x091, 0x092, 0x101, 0x159, 0x15A, 0x15B,
+                    0x15C, 0x15D, 0x15E, 0x128, 0x12F, 0x1BD, 0x1E4, 0x1F3,
+                    0x207, 0x211, 0x239, 0x251, 0x26C, 0x2C3, 0x2C9, 0x31D,
+                    0x31E, 0x31F, 0x320, 0x321, 0x322, 0x323, 0x324, 0x325,
+                    0x326, 0x369, 0x386, 0x387, 0x388, 0x389, 0x38A, 0x59D,
+                    0x6B8, 0x725, 0x853
+                }
+            for( int i =3D 0; i &lt; m_HairHues.Length; i++ )
+                if( m_HairHues[i] =3D=3D hue )
+                    return hue;
+            return m_HairHues[0];
+        }
+    ]]--
+    =

+    --[[
+    table.insert(rows,{{&quot;SkinColor:&quot;},          {&quot;&quot;},   {&quot;&quot;,function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D&quot;skinColor&quot;}})
+    table.insert(rows,{{&quot;HairColor:&quot;},          {&quot;&quot;},   {&quot;&quot;,function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D&quot;hairColor&quot;}})
+    table.insert(rows,{{&quot;BeardColor:&quot;},         {&quot;&quot;},   {&quot;&quot;,function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D&quot;facialHairColor&quot;}})
+    table.insert(rows,{{&quot;ShirtColor:&quot;},         {&quot;&quot;},   {&quot;&quot;,function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D&quot;shirtColor&quot;}})
+    table.insert(rows,{{&quot;PantsColor:&quot;},         {&quot;&quot;},   {&quot;&quot;,function (w) M=
ainMenu_CharCreate_ChooseColor(w) end,controlname=3D&quot;pantsColor&quot;}})
+    =

+    local hairlist =3D {&quot;none&quot;}
+    local beardlist =3D {&quot;none&quot;}
+    local citylist =3D {&quot;none&quot;}
+    =

+    table.insert(rows,{{&quot;Hair:&quot;},               {&quot;&quot;},   {hairlist[1],funct=
ion (w) MainMenu_CharCreate_Choose(w) end,controlname=3D&quot;hairStyle&quot;}})
+    table.insert(rows,{{&quot;Beard:&quot;},              {&quot;&quot;},   {hairlist[1],funct=
ion (w) MainMenu_CharCreate_Choose(w) end,controlname=3D&quot;facialHair&quot;}})
+    -- uogamers: 0=3Dyew,1=3Dminoc,2=3Dbrit,3=3Dmoonglow,4=3Dtrinsik,5=3DM=
agincia,6=3Djhelom,7=3Dscara,8=3Dvesper,9=3Docclo
+    ]]--
+    =

+    -- starting city
+    local citylist =3D SortedArrayFromAssocTable(gCities,function (a,b) re=
turn a.i &lt; b.i end)
+    for k,city in pairs(citylist) do citylist[k] =3D {id=3Dcity.index,name=
=3Dcity.name..&quot;:&quot;..city.tavern} end
+    local valfield =3D &quot;location&quot;
+    gCharCreateDataEnums[valfield] =3D citylist
+    table.insert(rows,{{&quot;Location:&quot;},           {&quot;&quot;},   {citylist[1].name,=
function (w) MainMenu_CharCreate_Choose(w) end,controlname=3Dvalfield}})
+    =

+    =

+    table.insert(rows,{{&quot;Create Char&quot;,MainMenu_CharCreate_Submit}})
+    table.insert(rows,{{&quot;&quot;}})
+    local templates =3D GetCharCreationTemplates() -- see lib.charcreate.l=
ua : uo/Prof.txt =

+    local validtemplates =3D {&quot;Samurai&quot;, &quot;Ninja&quot;, &quot;Paladin&quot;,&quot;Necromancer&quot;,=
 &quot;Warrior&quot;,&quot;Mage&quot;,&quot;Blacksmith&quot;}
+    for k2,template in pairs(templates) do
+--      print(&quot;chartemplate&quot;,template.Name,in_array(template.Name,validtem=
plates))
+        if (in_array(template.Name,validtemplates)) then
+            table.insert(rows,{{&quot;&quot;},{&quot;&quot;},{&quot;Template:&quot;..template.Name,funct=
ion () =

+                    for k,v in pairs(CharCreateTemplateMod_GetValues(templ=
ate)) do MainMenu_CharCreate_SetValue(k,v) end
+                end}})
+        end
+    end
+    table.insert(rows,{{&quot;&quot;}})
+    table.insert(rows,{{&quot;Back&quot;,MainMenu_CharCreate_Back}})
+    gMainMenuDialog_CharCreate =3D MainMenu_MakeTableDlg(rows) =

+end
+
+
+-- utils
+
+function MainMenu_CharCreate_SetValue (valfield,value)
+    gCharCreateData[valfield] =3D value
+    local widget =3D gMainMenuDialog_CharCreate.controls[valfield]
+    local enum =3D gCharCreateDataEnums[valfield]
+--  print(&quot;MainMenu_CharCreate_SetValue&quot;,valfield,value,enum,widget)
+    if (not widget) then return end
+    if (enum) then =

+        -- chooser button
+        for k,v in pairs(gCharCreateDataEnums[valfield]) do
+            if (v.id =3D=3D value) then
+                widget.AutoScaledButton_text.gfx:SetText(v.name)
+            end
+        end
+    else =

+        -- text
+        widget.gfx:SetText(&quot;&quot;..value)
+    end
+end
+
+function MainMenu_CharCreate_Choose (widget,cols)
+    MainMenu_CharCreate_Choose_Stop()
+    local rows =3D {}
+    local lastrow
+    local valfield =3D widget.controlname
+    cols =3D cols or 1
+    for k,v in pairs(gCharCreateDataEnums[valfield]) do =

+        local item =3D {v.name,function ()
+--                  print(&quot;MainMenu_CharCreate_Choose&quot;,v.id,v.name)
+                    MainMenu_CharCreate_SetValue(valfield,v.id)
+                    MainMenu_CharCreate_Choose_Stop()
+                    end}
+        if (math.mod(k-1,cols) =3D=3D 0) then
+            lastrow =3D {item}
+            table.insert(rows,lastrow)
+        else
+            table.insert(lastrow,item)
+        end
+    end
+    table.insert(rows,{{&quot;Cancel&quot;,MainMenu_CharCreate_Choose_Stop}})
+    gMainMenuDialog_CharCreate_Choose =3D MainMenu_MakeTableDlg(rows,300,1=
0) =

+end
+function MainMenu_CharCreate_Choose_Stop ()
+    if (gMainMenuDialog_CharCreate_Choose) then =

+        gMainMenuDialog_CharCreate_Choose:Destroy() =

+        gMainMenuDialog_CharCreate_Choose =3D nil
+    end
+end
+
+-- rest =

+
+function MainMenu_CharCreate_Back ()
+    MainMenu_CharList_Start()
+end
+ =

+function MainMenu_CharCreate_Stop () =

+    if (gMainMenuDialog_CharCreate) then =

+        gMainMenuDialog_CharCreate:Destroy() =

+        gMainMenuDialog_CharCreate =3D nil
+    end
+end
+
+function MainMenu_CharCreate_Submit ()
+    -- TODO
+--  print(&quot;##########################&quot;)
+--  print(&quot;MainMenu_CharCreate_Submit&quot;)
+    gCharCreateData.slot =3D MainMenu_CharCreate_GetFreeSlot()
+    gCharCreateData.name =3D gMainMenuDialog_CharCreate:GetEditText(&quot;name&quot;)
+    for k,v in pairs(gCharCreateData) do print(k,v) end
+    local chardata =3D CreateSampleCharData()
+    for k,v in pairs(gCharCreateData) do chardata[k] =3D v end
+    Send_CharCreate(chardata)
+    MainMenu_CharCreate_Stop()
+end

Modified: trunk/lua/lib.mainmenu.charlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.charlist.lua (original)
+++ trunk/lua/lib.mainmenu.charlist.lua Sat Mar 14 02:24:51 2009
@@ -1,132 +1,132 @@
-
--- for k,char in ipairs(mychars) do  char.id,char.name
-function MainMenu_GetSortedCharlist (charlist)
-	charlist =3D charlist or gShardCharlist
-	local mychars =3D {}
-	for i=3D0,20 do if (charlist.chars[i]) then table.insert(mychars,{id=3Di,=
name=3Dcharlist.chars[i].name}) else break end end
-	--~ table.sort(mychars,function (a,b) return a.name &lt; b.name end) -- sort=
 by name
-	table.sort(mychars,function (a,b) return a.id &lt; b.id end) -- sort by char=
slot, same as in original client charlist
-	return mychars
-end
-function MainMenu_CharCreate_GetFreeSlot ()
-	local mychars =3D MainMenu_GetSortedCharlist()
-	for k,char in ipairs(mychars) do if (char.name =3D=3D &quot;&quot;) then return cha=
r.id end end
-end
- =

-function MainMenu_CharList_Start () =

-	print(&quot;########################&quot;)
-	print(&quot;MainMenu_CharList_Start&quot;)
-	MainMenuStopAllMenus()
-	=

-	local rows =3D {}
-	=

-	local mychars =3D MainMenu_GetSortedCharlist()
-	=

-	local bFreeSlotAvailable =3D false
-	local bAllSlotsEmpty =3D true
-	for k,char in ipairs(mychars) do
-		print(&quot;charlist:&quot;,k,char,char.name)
-		=

-		if (char.name =3D=3D &quot;&quot;) then =

-			bFreeSlotAvailable =3D true
-		else
-			bAllSlotsEmpty =3D false
-			=

-			local fun_char =3D function () MainMenu_SendSelectChar(char.id) end =

-			table.insert(rows,{	{char.name,fun_char},
-								{&quot;3D&quot;,function () gCurrentRenderer =3D Renderer3D fun_char() end},
-								{&quot;2D&quot;,function () gCurrentRenderer =3D Renderer2D fun_char() end}
-								})
-		end
-		--~ Send_Character_Select(char.id,gGameServerAccount)
-		--~ gSelectedCharName =3D char.name
-	end
-	=

-	if (bFreeSlotAvailable) then table.insert(rows,{{&quot;Create New Character&quot;,M=
ainMenu_CharCreate_Start}}) end
-	if (not bAllSlotsEmpty) then table.insert(rows,{{&quot;Delete Character&quot;,MainM=
enu_CharDelete_Start}}) end
-	table.insert(rows,{{&quot;Back&quot;,MainMenu_AccountList_Back}})
-	gMainMenuDialog_CharList =3D MainMenu_MakeTableDlg(rows) =

-end
-
-
--- char delete
-
-function MainMenu_CharDelete_Start ()
-	local rows =3D {}
-	table.insert(rows,{{&quot;Delete Character:&quot;}})
-	table.insert(rows,{{&quot;(NOT YET IMPLEMENTED)&quot;}})
-	for k,char in ipairs(MainMenu_GetSortedCharlist()) do
-		if (char.name ~=3D &quot;&quot;) then
-			local fun_char =3D function () MainMenu_DeleteChar(char.id,char.name) M=
ainMenu_CharDelete_Stop() end
-			table.insert(rows,{	{char.name,fun_char}, })
-		end
-	end
-	table.insert(rows,{{&quot;&quot;}})
-	table.insert(rows,{{&quot;Cancel&quot;,MainMenu_CharDelete_Stop}})
-	-- TODO : not yet implemented
-	-- send delete request, handle failure 0x85, handle charlist update  0x86
-	MainMenu_CharDelete_Stop()
-	gMainMenuDialog_CharDelete =3D MainMenu_MakeTableDlg(rows) =

-end
-
-function MainMenu_CharDelete_Stop ()
-	if (gMainMenuDialog_CharDelete) then =

-		gMainMenuDialog_CharDelete:Destroy()
-		gMainMenuDialog_CharDelete =3D nil
-	end
-end
-
-function MainMenu_DeleteChar (slot,name)
-	print(&quot;MainMenu_DeleteChar : TODO : delete char&quot;,slot,name)
-	-- todo : if implemented, remove (NOT YET IMPLEMENTED) in MainMenu_CharDe=
lete_Start
-end
-
---[[
-chardelete-request + success :
-	18:49:03.3879: Client -&gt; Server 0x83 (Length: 39)	kPacket_Account_Delete_=
Character
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.........
-	0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G..l.
-	0020   00 00 01 0A 00 02 0F                               .......
-
-
-	18:49:03.4681: Server -&gt; Client 0x86 (Length: 304)	kPacket_All_Characters=
 (not kPacket_Character_List 0xA9)
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   86 01 30 05 47 68 6F 6E  69 6E 00 00 00 00 00 00   ..0.Ghonin......
-	rest zeroes...
-	=

-chardelete-request + fail :
-	18:38:01.3192: Client -&gt; Server 0x83 (Length: 39)
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.........
-	0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G..l.
-	0020   00 00 00 0A 00 02 0F                               .......
-	=

-	18:38:03.9330: Server -&gt; Client 0x85 (Length: 2)	kPacket_Delete_Character=
_Failed
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   85 03                                              ..
-
-	18:38:03.9330: Server -&gt; Client 0x86 (Length: 304)	kPacket_All_Characters=
 (not kPacket_Character_List 0xA9)
-			0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
-		   -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
-	0000   86 01 30 05 42 6F 6D 62  00 00 00 00 00 00 00 00   ..0.Bomb........
-	rest zeroes...
-]]--
-
--- acc list =

-
-function MainMenu_CharList_Back ()
-	MainMenuResetNetwork()
-	MainMenu_AccountList_Start()
-end
-
-function MainMenu_CharList_Stop () =

-	if (gMainMenuDialog_CharList) then =

-		gMainMenuDialog_CharList:Destroy() =

-		gMainMenuDialog_CharList =3D nil
-	end
-end
+
+-- for k,char in ipairs(mychars) do  char.id,char.name
+function MainMenu_GetSortedCharlist (charlist)
+    charlist =3D charlist or gShardCharlist
+    local mychars =3D {}
+    for i=3D0,20 do if (charlist.chars[i]) then table.insert(mychars,{id=
=3Di,name=3Dcharlist.chars[i].name}) else break end end
+    --~ table.sort(mychars,function (a,b) return a.name &lt; b.name end) -- s=
ort by name
+    table.sort(mychars,function (a,b) return a.id &lt; b.id end) -- sort by c=
harslot, same as in original client charlist
+    return mychars
+end
+function MainMenu_CharCreate_GetFreeSlot ()
+    local mychars =3D MainMenu_GetSortedCharlist()
+    for k,char in ipairs(mychars) do if (char.name =3D=3D &quot;&quot;) then return =
char.id end end
+end
+ =

+function MainMenu_CharList_Start () =

+--  print(&quot;########################&quot;)
+--  print(&quot;MainMenu_CharList_Start&quot;)
+    MainMenuStopAllMenus()
+    =

+    local rows =3D {}
+    =

+    local mychars =3D MainMenu_GetSortedCharlist()
+    =

+    local bFreeSlotAvailable =3D false
+    local bAllSlotsEmpty =3D true
+    for k,char in ipairs(mychars) do
+--      print(&quot;charlist:&quot;,k,char,char.name)
+        =

+        if (char.name =3D=3D &quot;&quot;) then =

+            bFreeSlotAvailable =3D true
+        else
+            bAllSlotsEmpty =3D false
+            =

+            local fun_char =3D function () MainMenu_SendSelectChar(char.id=
) end =

+            table.insert(rows,{ {char.name,fun_char},
+                                {&quot;3D&quot;,function () gCurrentRenderer =3D Ren=
derer3D fun_char() end},
+                                {&quot;2D&quot;,function () gCurrentRenderer =3D Ren=
derer2D fun_char() end}
+                                })
+        end
+        --~ Send_Character_Select(char.id,gGameServerAccount)
+        --~ gSelectedCharName =3D char.name
+    end
+    =

+    if (bFreeSlotAvailable) then table.insert(rows,{{&quot;Create New Character=
&quot;,MainMenu_CharCreate_Start}}) end
+    if (not bAllSlotsEmpty) then table.insert(rows,{{&quot;Delete Character&quot;,Ma=
inMenu_CharDelete_Start}}) end
+    table.insert(rows,{{&quot;Back&quot;,MainMenu_AccountList_Back}})
+    gMainMenuDialog_CharList =3D MainMenu_MakeTableDlg(rows) =

+end
+
+
+-- char delete
+
+function MainMenu_CharDelete_Start ()
+    local rows =3D {}
+    table.insert(rows,{{&quot;Delete Character:&quot;}})
+    table.insert(rows,{{&quot;(NOT YET IMPLEMENTED)&quot;}})
+    for k,char in ipairs(MainMenu_GetSortedCharlist()) do
+        if (char.name ~=3D &quot;&quot;) then
+            local fun_char =3D function () MainMenu_DeleteChar(char.id,cha=
r.name) MainMenu_CharDelete_Stop() end
+            table.insert(rows,{ {char.name,fun_char}, })
+        end
+    end
+    table.insert(rows,{{&quot;&quot;}})
+    table.insert(rows,{{&quot;Cancel&quot;,MainMenu_CharDelete_Stop}})
+    -- TODO : not yet implemented
+    -- send delete request, handle failure 0x85, handle charlist update  0=
x86
+    MainMenu_CharDelete_Stop()
+    gMainMenuDialog_CharDelete =3D MainMenu_MakeTableDlg(rows) =

+end
+
+function MainMenu_CharDelete_Stop ()
+    if (gMainMenuDialog_CharDelete) then =

+        gMainMenuDialog_CharDelete:Destroy()
+        gMainMenuDialog_CharDelete =3D nil
+    end
+end
+
+function MainMenu_DeleteChar (slot,name)
+    print(&quot;MainMenu_DeleteChar : TODO : delete char&quot;,slot,name)
+    -- todo : if implemented, remove (NOT YET IMPLEMENTED) in MainMenu_Cha=
rDelete_Start
+end
+
+--[[
+chardelete-request + success :
+    18:49:03.3879: Client -&gt; Server 0x83 (Length: 39)   kPacket_Account_De=
lete_Character
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.....=
....
+    0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G=
..l.
+    0020   00 00 01 0A 00 02 0F                               .......
+
+
+    18:49:03.4681: Server -&gt; Client 0x86 (Length: 304)  kPacket_All_Charac=
ters (not kPacket_Character_List 0xA9)
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   86 01 30 05 47 68 6F 6E  69 6E 00 00 00 00 00 00   ..0.Ghonin..=
....
+    rest zeroes...
+    =

+chardelete-request + fail :
+    18:38:01.3192: Client -&gt; Server 0x83 (Length: 39)
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   83 EC 8E 42 7E F0 6A AE  00 15 02 00 00 00 00 00   ...B~.j.....=
....
+    0010   00 FC 8E 42 7E 00 00 00  00 93 84 47 00 F8 6C 00   ...B~......G=
..l.
+    0020   00 00 00 0A 00 02 0F                               .......
+    =

+    18:38:03.9330: Server -&gt; Client 0x85 (Length: 2)    kPacket_Delete_Cha=
racter_Failed
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   85 03                                              ..
+
+    18:38:03.9330: Server -&gt; Client 0x86 (Length: 304)  kPacket_All_Charac=
ters (not kPacket_Character_List 0xA9)
+            0  1  2  3  4  5  6  7   8  9  A  B  C  D  E  F
+           -- -- -- -- -- -- -- --  -- -- -- -- -- -- -- --
+    0000   86 01 30 05 42 6F 6D 62  00 00 00 00 00 00 00 00   ..0.Bomb....=
....
+    rest zeroes...
+]]--
+
+-- acc list =

+
+function MainMenu_CharList_Back ()
+    MainMenuResetNetwork()
+    MainMenu_AccountList_Start()
+end
+
+function MainMenu_CharList_Stop () =

+    if (gMainMenuDialog_CharList) then =

+        gMainMenuDialog_CharList:Destroy() =

+        gMainMenuDialog_CharList =3D nil
+    end
+end

Modified: trunk/lua/lib.mainmenu.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.lua (original)
+++ trunk/lua/lib.mainmenu.lua Sat Mar 14 02:24:51 2009
@@ -1,258 +1,258 @@
--- handles the menu before starting the game
-
-dofile(libpath .. &quot;lib.mainmenu.background.lua&quot;)
-dofile(libpath .. &quot;lib.mainmenu.shardlist.lua&quot;)
-dofile(libpath .. &quot;lib.mainmenu.accountlist.lua&quot;)
-dofile(libpath .. &quot;lib.mainmenu.charlist.lua&quot;)
-dofile(libpath .. &quot;lib.mainmenu.charcreate.lua&quot;)
-
-dofile(libpath .. &quot;lib.offlinemode.lua&quot;)
-dofile(libpath .. &quot;lib.debugmenu.lua&quot;)
-
-
-function StartMainMenu	() =

-	SetUOCursor(0)
-	if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
-	ChatLine_Init()	=

-	if (MainMenuCommandLine()) then return end
-	MainMenu_Background_Start()
-	MainMenu_ShardList_Start()
-end
-function StepMainMenu	() end
-
-function MainMenuStopAllMenus	() =

-	MainMenu_ShardList_Stop()
-	MainMenu_AccountList_Stop()
-	MainMenu_ServerList_Stop()
-	MainMenu_CharList_Stop()
-	MainMenu_CharCreate_Stop()
-end
-
-function MainMenuResetNetwork () =

-	NetDisconnect()
-	gHuffmanDecode =3D false
-end
-
-
-
--- ***** ***** ***** ***** ***** commandline
-
-function MainMenuCommandLine ()
-	for shardname,shard in pairs(gShardList) do shard.gShardName =3D shardnam=
e end
-	if (gTestNoMainMenu) then return end
-	if (gCommandLineSwitches[&quot;-meshload&quot;]) then StartMeshLoaderTest() end -- =
journaltest
-	if (gCommandLineSwitches[&quot;-jt&quot;]) then ToggleJournal() return true end -- =
journaltest
-	if (gCommandLineSwitches[&quot;-mt&quot;]) then ToggleMacroList() return true end -=
- macrolist-test
-	if (gCommandLineSwitches[&quot;-so&quot;]) then StartOfflineMode(gCommandLineArgume=
nts[gCommandLineSwitches[&quot;-so&quot;]+1]) return true end -- start in offline mode
-	if (gCommandLineSwitches[&quot;-sd&quot;]) then StartDebugMenu() return true end --=
 start in debug mode
-	if (gCommandLineSwitches[&quot;-co&quot;]) then =

-		local name =3D gCommandLineArguments[gCommandLineSwitches[&quot;-co&quot;]+1]
-		local shard =3D gShardList[name]
-		if (shard) then =

-			gAutoLoginCharName =3D gCommandLineArguments[gCommandLineSwitches[&quot;-co&quot;=
]+2]
-			=

-			-- if charname specified, and shard hasn't full login already, search k=
nown charlists and passwords
-			if (gAutoLoginCharName and (((shard.gLoginname or &quot;&quot;) =3D=3D &quot;&quot;) or ((s=
hard.gPassword or &quot;&quot;) =3D=3D &quot;&quot;))) then =

-				print(&quot;autologin...searching for charname:&quot;,gAutoLoginCharName)
-				local charlists =3D FilterTable(ShardMemoryGetList(&quot;charlist&quot;),functio=
n (charlist) return	=

-																	charlist.gLoginServerIP		=3D=3D shard.gLoginServerIP and =

-																	charlist.gLoginServerPort	=3D=3D shard.gLoginServerPort e=
nd)
-				for k,charlist in pairs(charlists) do =

-					for i=3D0,20 do =

-						--~ print(&quot;..&quot;,charlist[i])
-						if (not charlist[i]) then break end
-						if (string.lower(charlist[i]) =3D=3D string.lower(gAutoLoginCharName=
)) then
-							gAutoLoginCharName =3D charlist[i]
-							gLoginname =3D charlist.gLoginname
-							gPassword =3D MainMenu_GetStoredPassword(shard.gLoginServerIP,shard=
.gLoginServerPort,gLoginname)
-							print(&quot;found&quot;,gAutoLoginCharName,gLoginname)
-						end
-					end
-				end
-			end
-			MainMenu_SelectShard(shard)
-			return true
-		end
-	end -- connect to shard
-end
-
--- ***** ***** ***** ***** ***** Shardfilter
-
-function LoadShardfilter (filterfilepath)
-	if (filterfilepath) then
-		if (file_exists(gMainWorkingDir..filterfilepath) ) then
-			print(&quot;Load custom shard-specific Filter: &quot;..gMainWorkingDir..filterfil=
epath)
-			dofile(gMainWorkingDir..filterfilepath)
-		else
-			print(&quot;Shard-specific Filter not found: &quot;..gMainWorkingDir..filterfilep=
ath)
-		end
-	end
-end
-
--- ***** ***** ***** ***** ***** actions and events
-
-function MainMenu_SelectShard (shard)
-	print(&quot;MainMenu_SelectShard&quot;,shard,shard.gShardName)
-	MainMenuStopAllMenus()
-	=

-	LoadShardfilter(shard.gCustomArtFilterFilePath) -- todo : revert on error=
 or back-button ?
-	=

-	-- load global config from shard
-	for k,v in pairs(shard) do _G[k] =3D v end
-	=

-	if (shard.gStartGameWithoutNetwork =3D=3D true) then
-		StartOfflineMode()
-	elseif(shard.gStartInDebugMode =3D=3D true) then
-		StartDebugMenu()
-	else
-		if (gLoginname and gLoginname ~=3D &quot;&quot; and gPassword and gPassword ~=3D &quot;=
&quot;) then MainMenu_SendLogin(gLoginname,gPassword) return end
-		MainMenu_AccountList_Start()
-	end
-end
-
--- answered by MainMenuShowServerList
-function MainMenu_SendLogin (user,pass)
-	print(&quot;##################################&quot;)
-	print(&quot;MainMenu_SendLogin&quot;,user)
-	MainMenuStopAllMenus()
-	GuiAddChatLine(&quot;connecting to shard Login-Server on &quot;..gLoginServerIP..&quot;:=
&quot;..gLoginServerPort..&quot; with user &quot;..user)
-
-	-- init net
-	gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServerS=
eed)
-	if (not gNet_State) then =

-		local text =3D &quot;connecting to shard on &quot;..gLoginServerIP..&quot;:&quot;..gLoginSer=
verPort..&quot; FAILED !&quot;
-		GuiAddChatLine(text)
-		PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
-		MainMenu_AccountList_Start()
-		return
-	end
-	=

-	Send_Account_Login_Request(user,pass) -- 0x80 kPacket_Account_Login_Reque=
st
-end
-
-function MainMenu_SendLoginAndChar (user,pass,charid,charname)
-	print(&quot;##################################&quot;)
-	print(&quot;MainMenu_SendLoginAndChar&quot;,user,charid,charname)
-	gAutoLoginCharID =3D charid
-	gAutoLoginCharName =3D charname
-	MainMenu_SendLogin(user,pass)
-end	=

-
-function MainMenu_GetStoredPassword(host,port,user)
-	-- stored passwords
-	local pass =3D GetStoredPassword(host,port,user)
-	if (pass and pass ~=3D &quot;&quot;) then return pass end
-	-- shard configs
-	for k,shard in pairs(gShardList) do =

-		if (shard.gLoginname =3D=3D user and
-			shard.gLoginServerIP =3D=3D host and
-			shard.gLoginServerPort =3D=3D port and
-			shard.gPassword and shard.gPassword ~=3D &quot;&quot;) then return shard.gPasswor=
d end
-	end
-end
-
-function MainMenuLoginRejected	(msg)
-	print(&quot;##################################&quot;)
-	print(&quot;MainMenuLoginRejected&quot;)
-	MainMenuResetNetwork()
-	MainMenu_AccountList_Start()
-	PlainMessageBox(msg)
-end
-	=

-function MainMenuShowServerList	(serverlist)	=

-	print(&quot;##################################&quot;)
-	print(&quot;MainMenuShowServerList&quot;)
-	MainMenuStopAllMenus()
-	=

-	-- if there is only once choice, select it immediately
-	if (countarr(serverlist.servers) =3D=3D 1) then
-		local k,v =3D next(serverlist.servers)
-		MainMenu_SendServer(v.index)
-		return
-	end
-	=

-	-- show serverlist
-	local rows =3D {}
-	for k,v in pairs(serverlist.servers) do
-		local label =3D sprintf(&quot;Choose server [%d]%s full=3D%d tz=3D%d ip=3D%s&quot;=
,v.index,v.name,v.full,v.tz,NtoA(v.ip))
-		table.insert(rows,{{label,function () MainMenu_SendServer(v.index) end}})
-	end
-	gMainMenuDialog_ServerList =3D MainMenu_MakeTableDlg(rows)
-end
-
-function MainMenu_ServerList_Stop ()
-	if (gMainMenuDialog_ServerList) then =

-		gMainMenuDialog_ServerList:Destroy() =

-		gMainMenuDialog_ServerList =3D nil
-	end
-end
-
--- answered by MainMenuShowCharList
-function MainMenu_SendServer (iServerID)
-	print(&quot;##################################&quot;)
-	print(&quot;MainMenu_SendServer&quot;,iServerID)
-	gSelectedShardName =3D gSubServerNamesByID[iServerID]
-	print(&quot;############# + + ++ +++ + +++ + +MainMenu_SendServer&quot;,iServerID,g=
SelectedShardName)
-	GuiAddChatLine(&quot;connecting to shard Game-Server &quot;..(gSelectedShardName or=
 &quot;???&quot;)..&quot; on &quot;..gLoginServerIP..&quot;:&quot;..gLoginServerPort..&quot; with user &quot;..gLog=
inname)
-	=

-	MainMenuStopAllMenus()
-	Send_GameServer_Select(iServerID or 0) -- 0xA0 kPacket_Server_Select =

-	-- answered by kPacket_Server_Redirect 0x8C, =

-	-- which calls Send_GameServer_PostLogin kPacket_Post_Login 0x91 =

-	-- answered by kPacket_Features 0xB9 and kPacket_Character_List 0xA9 whic=
h calls MainMenuShowCharList
-end
-
-function MainMenu_SendSelectChar	(charid)
-	print(&quot;##################################&quot;)
-	print(&quot;MainMenu_SendSelectChar&quot;,charid)		=

-	MainMenuStopAllMenus() =

-	PreLoadAfterManualRenderSwitch()
-	Send_Character_Select(charid,gGameServerAccount) -- 0x5D
-end
-		=

-function MainMenuShowCharList	(charlist)		=

-	print(&quot;##################################&quot;)
-	print(&quot;MainMenuShowCharList&quot;)	=

-	MainMenuStopAllMenus() =

-	=

-	gPingActive =3D true
-	gNextPingTime =3D 0
-	gShardCharlist =3D charlist
-	=

-	-- login by charslot id
-	if (gAutoLoginCharID) then MainMenu_SendSelectChar(gAutoLoginCharID) retu=
rn end
-	=

-	-- login by name (commandline)
-	if (gAutoLoginCharName) then =

-		for k,v in pairs(charlist.chars) do
-			if (v.name ~=3D &quot;&quot; and (v.name =3D=3D gAutoLoginCharName or tonumber(gA=
utoLoginCharName) =3D=3D k + 1)) then =

-				local iCharNum =3D k
-				MainMenu_SendSelectChar(iCharNum)
-				gSelectedCharName =3D v.name
-				return
-			end
-		end
-	end
-	=

-	MainMenu_CharList_Start()
-end
-
--- ***** ***** ***** ***** ***** MakeTableDlg for common styling
-
-function MainMenu_MakeTableDlg		(rows,x,y)
-	return guimaker.MakeTableDlg(rows,x or 10,y or 10,false,true,gGuiDefaultS=
tyleSet,&quot;window&quot;) =

-end
- =

--- ***** ***** ***** ***** ***** specials
-
-function MainMenu_Special_OfflineMode	() MainMenu_SelectShard({gStartGameW=
ithoutNetwork =3D true}) end
-function MainMenu_Special_DebugMode		() MainMenu_SelectShard({gStartInDebu=
gMode =3D true}) end
-function MainMenu_Special_GfxConfig		()
-	MainMenuStopAllMenus()
-	if (Client_ShowOgreConfig()) then
-		DisplayNotice(&quot;please restart iris2 for the changes to take effekt&quot;)
-		Exit() -- Terminate()  -- terminate softly is not enough, no frame can b=
e drawn since ogre::root has to be killed for fullscreen switch
-		-- todo : reinit ogre here ? might loose already loaded textures =3D(
-	end
-end
-function MainMenu_Special_Exit			() MainMenuStopAllMenus() Terminate() end
+-- handles the menu before starting the game
+
+dofile(libpath .. &quot;lib.mainmenu.background.lua&quot;)
+dofile(libpath .. &quot;lib.mainmenu.shardlist.lua&quot;)
+dofile(libpath .. &quot;lib.mainmenu.accountlist.lua&quot;)
+dofile(libpath .. &quot;lib.mainmenu.charlist.lua&quot;)
+dofile(libpath .. &quot;lib.mainmenu.charcreate.lua&quot;)
+
+dofile(libpath .. &quot;lib.offlinemode.lua&quot;)
+dofile(libpath .. &quot;lib.debugmenu.lua&quot;)
+
+
+function StartMainMenu  () =

+    SetUOCursor(0)
+    if (gDialog_IrisLogo) then gDialog_IrisLogo:SetVisible(false) end
+    ChatLine_Init() =

+    if (MainMenuCommandLine()) then return end
+    MainMenu_Background_Start()
+    MainMenu_ShardList_Start()
+end
+function StepMainMenu   () end
+
+function MainMenuStopAllMenus   () =

+    MainMenu_ShardList_Stop()
+    MainMenu_AccountList_Stop()
+    MainMenu_ServerList_Stop()
+    MainMenu_CharList_Stop()
+    MainMenu_CharCreate_Stop()
+end
+
+function MainMenuResetNetwork () =

+    NetDisconnect()
+    gHuffmanDecode =3D false
+end
+
+
+
+-- ***** ***** ***** ***** ***** commandline
+
+function MainMenuCommandLine ()
+    for shardname,shard in pairs(gShardList) do shard.gShardName =3D shard=
name end
+    if (gTestNoMainMenu) then return end
+    if (gCommandLineSwitches[&quot;-meshload&quot;]) then StartMeshLoaderTest() end =
-- journaltest
+    if (gCommandLineSwitches[&quot;-jt&quot;]) then ToggleJournal() return true end =
-- journaltest
+    if (gCommandLineSwitches[&quot;-mt&quot;]) then ToggleMacroList() return true en=
d -- macrolist-test
+    if (gCommandLineSwitches[&quot;-so&quot;]) then StartOfflineMode(gCommandLineArg=
uments[gCommandLineSwitches[&quot;-so&quot;]+1]) return true end -- start in offline =
mode
+    if (gCommandLineSwitches[&quot;-sd&quot;]) then StartDebugMenu() return true end=
 -- start in debug mode
+    if (gCommandLineSwitches[&quot;-co&quot;]) then =

+        local name =3D gCommandLineArguments[gCommandLineSwitches[&quot;-co&quot;]+1]
+        local shard =3D gShardList[name]
+        if (shard) then =

+            gAutoLoginCharName =3D gCommandLineArguments[gCommandLineSwitc=
hes[&quot;-co&quot;]+2]
+            =

+            -- if charname specified, and shard hasn't full login already,=
 search known charlists and passwords
+            if (gAutoLoginCharName and (((shard.gLoginname or &quot;&quot;) =3D=3D &quot;=
&quot;) or ((shard.gPassword or &quot;&quot;) =3D=3D &quot;&quot;))) then =

+--              print(&quot;autologin...searching for charname:&quot;,gAutoLoginChar=
Name)
+                local charlists =3D FilterTable(ShardMemoryGetList(&quot;charli=
st&quot;),function (charlist) return =

+                                                                    charli=
st.gLoginServerIP     =3D=3D shard.gLoginServerIP and =

+                                                                    charli=
st.gLoginServerPort   =3D=3D shard.gLoginServerPort end)
+                for k,charlist in pairs(charlists) do =

+                    for i=3D0,20 do =

+                        --~ print(&quot;..&quot;,charlist[i])
+                        if (not charlist[i]) then break end
+                        if (string.lower(charlist[i]) =3D=3D string.lower(=
gAutoLoginCharName)) then
+                            gAutoLoginCharName =3D charlist[i]
+                            gLoginname =3D charlist.gLoginname
+                            gPassword =3D MainMenu_GetStoredPassword(shard=
.gLoginServerIP,shard.gLoginServerPort,gLoginname)
+--                          print(&quot;found&quot;,gAutoLoginCharName,gLoginname)
+                        end
+                    end
+                end
+            end
+            MainMenu_SelectShard(shard)
+            return true
+        end
+    end -- connect to shard
+end
+
+-- ***** ***** ***** ***** ***** Shardfilter
+
+function LoadShardfilter (filterfilepath)
+    if (filterfilepath) then
+        if (file_exists(gMainWorkingDir..filterfilepath) ) then
+            print(&quot;Load custom shard-specific Filter: &quot;..gMainWorkingDir..=
filterfilepath)
+            dofile(gMainWorkingDir..filterfilepath)
+        else
+            print(&quot;Shard-specific Filter not found: &quot;..gMainWorkingDir..fi=
lterfilepath)
+        end
+    end
+end
+
+-- ***** ***** ***** ***** ***** actions and events
+
+function MainMenu_SelectShard (shard)
+--  print(&quot;MainMenu_SelectShard&quot;,shard,shard.gShardName)
+    MainMenuStopAllMenus()
+    =

+    LoadShardfilter(shard.gCustomArtFilterFilePath) -- todo : revert on er=
ror or back-button ?
+    =

+    -- load global config from shard
+    for k,v in pairs(shard) do _G[k] =3D v end
+    =

+    if (shard.gStartGameWithoutNetwork =3D=3D true) then
+        StartOfflineMode()
+    elseif(shard.gStartInDebugMode =3D=3D true) then
+        StartDebugMenu()
+    else
+        if (gLoginname and gLoginname ~=3D &quot;&quot; and gPassword and gPassword =
~=3D &quot;&quot;) then MainMenu_SendLogin(gLoginname,gPassword) return end
+        MainMenu_AccountList_Start()
+    end
+end
+
+-- answered by MainMenuShowServerList
+function MainMenu_SendLogin (user,pass)
+--  print(&quot;##################################&quot;)
+--  print(&quot;MainMenu_SendLogin&quot;,user)
+    MainMenuStopAllMenus()
+    GuiAddChatLine(&quot;connecting to shard Login-Server on &quot;..gLoginServerIP.=
.&quot;:&quot;..gLoginServerPort..&quot; with user &quot;..user)
+
+    -- init net
+    gNet_State =3D NetConnectWithKey(gLoginServerIP,gLoginServerPort,gServ=
erSeed)
+    if (not gNet_State) then =

+        local text =3D &quot;connecting to shard on &quot;..gLoginServerIP..&quot;:&quot;..gLo=
ginServerPort..&quot; FAILED !&quot;
+        GuiAddChatLine(text)
+        PlainMessageBox(text,gGuiDefaultStyleSet,gGuiDefaultStyleSet)
+        MainMenu_ShardList_Start()
+        return
+    end
+    =

+    Send_Account_Login_Request(user,pass) -- 0x80 kPacket_Account_Login_Re=
quest
+end
+
+function MainMenu_SendLoginAndChar (user,pass,charid,charname)
+--  print(&quot;##################################&quot;)
+--  print(&quot;MainMenu_SendLoginAndChar&quot;,user,charid,charname)
+    gAutoLoginCharID =3D charid
+    gAutoLoginCharName =3D charname
+    MainMenu_SendLogin(user,pass)
+end =

+
+function MainMenu_GetStoredPassword(host,port,user)
+    -- stored passwords
+    local pass =3D GetStoredPassword(host,port,user)
+    if (pass and pass ~=3D &quot;&quot;) then return pass end
+    -- shard configs
+    for k,shard in pairs(gShardList) do =

+        if (shard.gLoginname =3D=3D user and
+            shard.gLoginServerIP =3D=3D host and
+            shard.gLoginServerPort =3D=3D port and
+            shard.gPassword and shard.gPassword ~=3D &quot;&quot;) then return shard=
.gPassword end
+    end
+end
+
+function MainMenuLoginRejected  (msg)
+--  print(&quot;##################################&quot;)
+--  print(&quot;MainMenuLoginRejected&quot;)
+    MainMenuResetNetwork()
+    MainMenu_AccountList_Start()
+    PlainMessageBox(msg)
+end
+    =

+function MainMenuShowServerList (serverlist)    =

+--  print(&quot;##################################&quot;)
+--  print(&quot;MainMenuShowServerList&quot;)
+    MainMenuStopAllMenus()
+    =

+    -- if there is only once choice, select it immediately
+    if (countarr(serverlist.servers) =3D=3D 1) then
+        local k,v =3D next(serverlist.servers)
+        MainMenu_SendServer(v.index)
+        return
+    end
+    =

+    -- show serverlist
+    local rows =3D {}
+    for k,v in pairs(serverlist.servers) do
+        local label =3D sprintf(&quot;Choose server [%d]%s full=3D%d tz=3D%d ip=
=3D%s&quot;,v.index,v.name,v.full,v.tz,NtoA(v.ip))
+        table.insert(rows,{{label,function () MainMenu_SendServer(v.index)=
 end}})
+    end
+    gMainMenuDialog_ServerList =3D MainMenu_MakeTableDlg(rows)
+end
+
+function MainMenu_ServerList_Stop ()
+    if (gMainMenuDialog_ServerList) then =

+        gMainMenuDialog_ServerList:Destroy() =

+        gMainMenuDialog_ServerList =3D nil
+    end
+end
+
+-- answered by MainMenuShowCharList
+function MainMenu_SendServer (iServerID)
+--  print(&quot;##################################&quot;)
+--  print(&quot;MainMenu_SendServer&quot;,iServerID)
+    gSelectedShardName =3D gSubServerNamesByID[iServerID]
+--  print(&quot;############# + + ++ +++ + +++ + +MainMenu_SendServer&quot;,iServerI=
D,gSelectedShardName)
+    GuiAddChatLine(&quot;connecting to shard Game-Server &quot;..(gSelectedShardName=
 or &quot;???&quot;)..&quot; on &quot;..gLoginServerIP..&quot;:&quot;..gLoginServerPort..&quot; with user &quot;..g=
Loginname)
+    =

+    MainMenuStopAllMenus()
+    Send_GameServer_Select(iServerID or 0) -- 0xA0 kPacket_Server_Select =

+    -- answered by kPacket_Server_Redirect 0x8C, =

+    -- which calls Send_GameServer_PostLogin kPacket_Post_Login 0x91 =

+    -- answered by kPacket_Features 0xB9 and kPacket_Character_List 0xA9 w=
hich calls MainMenuShowCharList
+end
+
+function MainMenu_SendSelectChar    (charid)
+--  print(&quot;##################################&quot;)
+--  print(&quot;MainMenu_SendSelectChar&quot;,charid)     =

+    MainMenuStopAllMenus() =

+    PreLoadAfterManualRenderSwitch()
+    Send_Character_Select(charid,gGameServerAccount) -- 0x5D
+end
+        =

+function MainMenuShowCharList   (charlist)      =

+--  print(&quot;##################################&quot;)
+--  print(&quot;MainMenuShowCharList&quot;)   =

+    MainMenuStopAllMenus() =

+    =

+    gPingActive =3D true
+    gNextPingTime =3D 0
+    gShardCharlist =3D charlist
+    =

+    -- login by charslot id
+    if (gAutoLoginCharID) then MainMenu_SendSelectChar(gAutoLoginCharID) r=
eturn end
+    =

+    -- login by name (commandline)
+    if (gAutoLoginCharName) then =

+        for k,v in pairs(charlist.chars) do
+            if (v.name ~=3D &quot;&quot; and (v.name =3D=3D gAutoLoginCharName or to=
number(gAutoLoginCharName) =3D=3D k + 1)) then =

+                local iCharNum =3D k
+                MainMenu_SendSelectChar(iCharNum)
+                gSelectedCharName =3D v.name
+                return
+            end
+        end
+    end
+    =

+    MainMenu_CharList_Start()
+end
+
+-- ***** ***** ***** ***** ***** MakeTableDlg for common styling
+
+function MainMenu_MakeTableDlg      (rows,x,y)
+    return guimaker.MakeTableDlg(rows,x or 10,y or 10,false,true,gGuiDefau=
ltStyleSet,&quot;window&quot;) =

+end
+ =

+-- ***** ***** ***** ***** ***** specials
+
+function MainMenu_Special_OfflineMode   () MainMenu_SelectShard({gStartGam=
eWithoutNetwork =3D true}) end
+function MainMenu_Special_DebugMode     () MainMenu_SelectShard({gStartInD=
ebugMode =3D true}) end
+function MainMenu_Special_GfxConfig     ()
+    MainMenuStopAllMenus()
+    if (Client_ShowOgreConfig()) then
+        DisplayNotice(&quot;please restart iris2 for the changes to take effekt=
&quot;)
+        Exit() -- Terminate()  -- terminate softly is not enough, no frame=
 can be drawn since ogre::root has to be killed for fullscreen switch
+        -- todo : reinit ogre here ? might loose already loaded textures =
=3D(
+    end
+end
+function MainMenu_Special_Exit          () MainMenuStopAllMenus() Terminat=
e() end

Modified: trunk/lua/lib.mainmenu.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.mainmenu.shardlist.lua (original)
+++ trunk/lua/lib.mainmenu.shardlist.lua Sat Mar 14 02:24:51 2009
@@ -1,110 +1,110 @@
-
-function MainMenu_ShardList_Start () =

-	print(&quot;########################&quot;)
-	print(&quot;MainMenu_ShardList_Start&quot;)
-	MainMenuStopAllMenus()
-	=

-	-- clear login if returning to this menu from somewhere else
-	gLoginname =3D nil =

-	gPassword =3D nil =

-	gAutoLoginCharID =3D nil
-	gAutoLoginCharName =3D nil
-	=

-	-- prepare shardlist
-	for shardname,shard in pairs(gShardList) do shard.gShardName =3D shardnam=
e end
-	-- sort alphabetically
-	local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a,b)=
 return a.gShardName &lt; b.gShardName end)
-	=

-	local rows =3D {}
-	=

-	-- shards
-	for k,shard in pairs(myshardlist) do
-		local buttonname =3D shard.gShardName
-		if (shard.gLoginname and shard.gLoginname ~=3D &quot;&quot;) then buttonname =3D b=
uttonname .. &quot;:&quot; .. shard.gLoginname end
-		table.insert(rows,{{buttonname,function () MainMenu_SelectShard(shard) e=
nd}})
-	end
-	=

-	-- options
-	table.insert(rows,{{&quot;&quot;}}) -- spacer
-	table.insert(rows,{{&quot;Add Shard&quot;,		MainMenu_Special_ShardAdd}})
-	table.insert(rows,{{&quot;Remove Shard&quot;,		MainMenu_Special_ShardRemove}})
-	table.insert(rows,{{&quot;Offline Mode&quot;,		MainMenu_Special_OfflineMode}})
-	table.insert(rows,{{&quot;Debug Mode&quot;,		MainMenu_Special_DebugMode}})
-	table.insert(rows,{{&quot;Graphic Options&quot;,	MainMenu_Special_GfxConfig}})
-	table.insert(rows,{{&quot;Iris Forum&quot;,		function () OpenBrowser(&quot;<A HREF="http://iris2.=">http://iris2.=</A>
de/forums/&quot;) end}})
-	table.insert(rows,{{&quot;Exit&quot;,				MainMenu_Special_Exit}})
-	=

-	gMainMenuDialog_ShardList =3D MainMenu_MakeTableDlg(rows) =

-end
-
-function MainMenu_ShardList_Stop () =

-	if (gMainMenuDialog_ShardList) then =

-		gMainMenuDialog_ShardList:Destroy() =

-		gMainMenuDialog_ShardList =3D nil
-	end
-end
-
-
--- ***** ***** ***** ***** ***** edit shard list
-
-function MainMenu_Special_ShardAdd		() =

-	local rows =3D {}
-	table.insert(rows,{{&quot;Add Shard&quot;}})
-	table.insert(rows,{	{&quot;Name:&quot;},{type=3D&quot;EditText&quot;,	w=3D300,h=3D16,text=3D&quot;=
&quot;,controlname=3D&quot;i_name&quot;}})
-	table.insert(rows,{	{&quot;Host:&quot;},{type=3D&quot;EditText&quot;,	w=3D300,h=3D16,text=3D&quot;=
&quot;,controlname=3D&quot;i_host&quot;},
-						{&quot;Port:&quot;},{type=3D&quot;EditText&quot;,	w=3D64,h=3D16,text=3D&quot;&quot;,controlname=3D=
&quot;i_port&quot;}})
-	=

-	=

-	table.insert(rows,{{&quot;Cancel&quot;,MainMenu_Special_ShardAdd_Stop},{&quot;Ok&quot;,functi=
on ()
-			local shardname	=3D 			gMainMenuDialog_ShardAdd:GetEditText(&quot;i_name&quot;)
-			local host		=3D 			gMainMenuDialog_ShardAdd:GetEditText(&quot;i_host&quot;)
-			local port		=3D tonumber(	gMainMenuDialog_ShardAdd:GetEditText(&quot;i_port&quot;=
))
-			local shard =3D {
-				gLoginServerIP	=3Dhost,
-				gLoginServerPort=3Dport,
-				gLoginname=3D&quot;&quot;,
-				gPassword=3D&quot;&quot;,
-				}
-			gShardList[shardname] =3D shard
-			=

-			-- write xml file  (TODO : overwrite warning ?)
-			local filepath =3D GetShardConfigFilePath(shardname)
-			print(&quot;writing shard to file&quot;,shardname,host,port,filepath)
-			SimpleXMLSave(filepath,shard)
-			shard.gShardName =3D shardname
-		=

-			MainMenu_ShardList_Start()
-			MainMenu_Special_ShardAdd_Stop()
-		end}})
-	=

-	MainMenu_Special_ShardAdd_Stop()
-	gMainMenuDialog_ShardAdd =3D MainMenu_MakeTableDlg(rows,200,10)
-end
-function MainMenu_Special_ShardAdd_Stop	() =

-	if (gMainMenuDialog_ShardAdd) then gMainMenuDialog_ShardAdd:Destroy() gMa=
inMenuDialog_ShardAdd =3D nil end =

-end
-
-function MainMenu_Special_ShardRemove	()
-	local rows =3D {}
-	table.insert(rows,{{&quot;Remove Shard&quot;}})
-	local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a,b)=
 return a.gShardName &lt; b.gShardName end)	=

-	for k,shard in pairs(myshardlist) do table.insert(rows,{{shard.gShardName=
 or &quot;???&quot;,function () =

-			gShardList[shard.gShardName] =3D nil
-			=

-			-- remove xml file
-			local filepath =3D GetShardConfigFilePath(shard.gShardName)
-			local res,msg =3D os.remove(filepath)
-			print(&quot;remove shard file&quot;,filepath,res,msg)
-			=

-			MainMenu_ShardList_Start()
-			MainMenu_Special_ShardRemove_Stop()
-		end}}) end
-	table.insert(rows,{{&quot;&quot;}})
-	table.insert(rows,{{&quot;Cancel&quot;,MainMenu_Special_ShardRemove_Stop}})
-	MainMenu_Special_ShardRemove_Stop()
-	gMainMenuDialog_ShardRemove =3D MainMenu_MakeTableDlg(rows,200,10)
-end
-function MainMenu_Special_ShardRemove_Stop	() =

-	if (gMainMenuDialog_ShardRemove) then gMainMenuDialog_ShardRemove:Destroy=
() gMainMenuDialog_ShardRemove =3D nil end =

-end
-
+
+function MainMenu_ShardList_Start () =

+--  print(&quot;########################&quot;)
+--  print(&quot;MainMenu_ShardList_Start&quot;)
+    MainMenuStopAllMenus()
+    =

+    -- clear login if returning to this menu from somewhere else
+    gLoginname =3D nil =

+    gPassword =3D nil =

+    gAutoLoginCharID =3D nil
+    gAutoLoginCharName =3D nil
+    =

+    -- prepare shardlist
+    for shardname,shard in pairs(gShardList) do shard.gShardName =3D shard=
name end
+    -- sort alphabetically
+    local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a=
,b) return a.gShardName &lt; b.gShardName end)
+    =

+    local rows =3D {}
+    =

+    -- shards
+    for k,shard in pairs(myshardlist) do
+        local buttonname =3D shard.gShardName
+        if (shard.gLoginname and shard.gLoginname ~=3D &quot;&quot;) then buttonname=
 =3D buttonname .. &quot;:&quot; .. shard.gLoginname end
+        table.insert(rows,{{buttonname,function () MainMenu_SelectShard(sh=
ard) end}})
+    end
+    =

+    -- options
+    table.insert(rows,{{&quot;&quot;}}) -- spacer
+    table.insert(rows,{{&quot;Add Shard&quot;,        MainMenu_Special_ShardAdd}})
+    table.insert(rows,{{&quot;Remove Shard&quot;,     MainMenu_Special_ShardRemove}})
+    table.insert(rows,{{&quot;Offline Mode&quot;,     MainMenu_Special_OfflineMode}})
+    table.insert(rows,{{&quot;Debug Mode&quot;,       MainMenu_Special_DebugMode}})
+    table.insert(rows,{{&quot;Graphic Options&quot;,  MainMenu_Special_GfxConfig}})
+    table.insert(rows,{{&quot;Iris Forum&quot;,       function () OpenBrowser(&quot;http:=
//iris2.de/forums/&quot;) end}})
+    table.insert(rows,{{&quot;Exit&quot;,             MainMenu_Special_Exit}})
+    =

+    gMainMenuDialog_ShardList =3D MainMenu_MakeTableDlg(rows) =

+end
+
+function MainMenu_ShardList_Stop () =

+    if (gMainMenuDialog_ShardList) then =

+        gMainMenuDialog_ShardList:Destroy() =

+        gMainMenuDialog_ShardList =3D nil
+    end
+end
+
+
+-- ***** ***** ***** ***** ***** edit shard list
+
+function MainMenu_Special_ShardAdd      () =

+    local rows =3D {}
+    table.insert(rows,{{&quot;Add Shard&quot;}})
+    table.insert(rows,{ {&quot;Name:&quot;},{type=3D&quot;EditText&quot;, w=3D300,h=3D16,text=
=3D&quot;&quot;,controlname=3D&quot;i_name&quot;}})
+    table.insert(rows,{ {&quot;Host:&quot;},{type=3D&quot;EditText&quot;, w=3D300,h=3D16,text=
=3D&quot;&quot;,controlname=3D&quot;i_host&quot;},
+                        {&quot;Port:&quot;},{type=3D&quot;EditText&quot;, w=3D64,h=3D16,text=
=3D&quot;&quot;,controlname=3D&quot;i_port&quot;}})
+    =

+    =

+    table.insert(rows,{{&quot;Cancel&quot;,MainMenu_Special_ShardAdd_Stop},{&quot;Ok&quot;,fun=
ction ()
+            local shardname =3D           gMainMenuDialog_ShardAdd:GetEdit=
Text(&quot;i_name&quot;)
+            local host      =3D           gMainMenuDialog_ShardAdd:GetEdit=
Text(&quot;i_host&quot;)
+            local port      =3D tonumber( gMainMenuDialog_ShardAdd:GetEdit=
Text(&quot;i_port&quot;))
+            local shard =3D {
+                gLoginServerIP  =3Dhost,
+                gLoginServerPort=3Dport,
+                gLoginname=3D&quot;&quot;,
+                gPassword=3D&quot;&quot;,
+                }
+            gShardList[shardname] =3D shard
+            =

+            -- write xml file  (TODO : overwrite warning ?)
+            local filepath =3D GetShardConfigFilePath(shardname)
+--          print(&quot;writing shard to file&quot;,shardname,host,port,filepath)
+            SimpleXMLSave(filepath,shard)
+            shard.gShardName =3D shardname
+        =

+            MainMenu_ShardList_Start()
+            MainMenu_Special_ShardAdd_Stop()
+        end}})
+    =

+    MainMenu_Special_ShardAdd_Stop()
+    gMainMenuDialog_ShardAdd =3D MainMenu_MakeTableDlg(rows,200,10)
+end
+function MainMenu_Special_ShardAdd_Stop () =

+    if (gMainMenuDialog_ShardAdd) then gMainMenuDialog_ShardAdd:Destroy() =
gMainMenuDialog_ShardAdd =3D nil end =

+end
+
+function MainMenu_Special_ShardRemove   ()
+    local rows =3D {}
+    table.insert(rows,{{&quot;Remove Shard&quot;}})
+    local myshardlist =3D SortedArrayFromAssocTable(gShardList,function (a=
,b) return a.gShardName &lt; b.gShardName end) =

+    for k,shard in pairs(myshardlist) do table.insert(rows,{{shard.gShardN=
ame or &quot;???&quot;,function () =

+            gShardList[shard.gShardName] =3D nil
+            =

+            -- remove xml file
+            local filepath =3D GetShardConfigFilePath(shard.gShardName)
+            local res,msg =3D os.remove(filepath)
+--          print(&quot;remove shard file&quot;,filepath,res,msg)
+            =

+            MainMenu_ShardList_Start()
+            MainMenu_Special_ShardRemove_Stop()
+        end}}) end
+    table.insert(rows,{{&quot;&quot;}})
+    table.insert(rows,{{&quot;Cancel&quot;,MainMenu_Special_ShardRemove_Stop}})
+    MainMenu_Special_ShardRemove_Stop()
+    gMainMenuDialog_ShardRemove =3D MainMenu_MakeTableDlg(rows,200,10)
+end
+function MainMenu_Special_ShardRemove_Stop  () =

+    if (gMainMenuDialog_ShardRemove) then gMainMenuDialog_ShardRemove:Dest=
roy() gMainMenuDialog_ShardRemove =3D nil end =

+end
+

Modified: trunk/lua/lib.shardlist.lua
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D
--- trunk/lua/lib.shardlist.lua (original)
+++ trunk/lua/lib.shardlist.lua Sat Mar 14 02:24:51 2009
@@ -1,154 +1,136 @@
-
--- paths
-
-function GetConfigDirPath				() return gMainWorkingDir..&quot;config/&quot; end
-function GetShardListDirPath			() return GetConfigDirPath()..&quot;shards/&quot; end
-function GetShardMemoryFilePath			() return GetConfigDirPath()..&quot;shardmemo=
ry.xml&quot; end
-function GetCharFilePath				() return GetConfigDirPath()..&quot;chars/&quot;..table.=
concat({gLoginServerIP,gLoginServerPort,ShardListFileNamePartEncode(gLoginn=
ame),giGameServerID,gCharID},&quot;.&quot;)..&quot;.xml&quot; end
-function GetShardConfigFilePath 		(shardname) return GetShardListDirPath()=
..ShardListFileNamePartEncode(shardname)..&quot;.xml&quot; end
-
-function ShardListFileNamePartEncode	(x) return string.gsub(x,&quot;[^0-9a-zA-Z=
_%-%(%) ]&quot;,&quot;.&quot;) end
-
--- notes
-
-function InitShardList () =

-	LoadStoredPasswords()
-	LoadShardMemory()
-	LoadShardList()
-	--~ for shardname,shard in pairs(gShardList) do
-		--~ local filepath =3D GetShardConfigFilePath(shardname)
-		--~ print(&quot;InitShardList&quot;,shardname,shard,filepath)
-		--~ SimpleXMLSave(filepath,shard)
-	--~ end
-	--~ SimpleXML_Test()
-	--~ os.exit(0)
-end
-
-
-
-
--- ***** ***** ***** ***** ***** chars
-
-
-RegisterListener(&quot;Hook_Packet_Character_List&quot;,function (charlist) =

-	local plaincharlist =3D {serverid=3DgiGameServerID}
-	for k,v in pairs(charlist.chars) do plaincharlist[k] =3D v.name end
-	plaincharlist.gLoginServerIP =3D gLoginServerIP
-	plaincharlist.gLoginServerPort =3D gLoginServerPort
-	plaincharlist.gLoginname =3D gLoginname
-	plaincharlist.giGameServerID =3D giGameServerID
-	ShardMemorySet(&quot;charlist&quot;,table.concat({gLoginServerIP,gLoginServerPort,S=
hardListFileNamePartEncode(gLoginname),giGameServerID},&quot;:&quot;),plaincharlist)
-end)
-
-RegisterListener(&quot;Hook_Player_Full_equip&quot;,function (mobiledata,equipmentda=
ta) =

-	if (gShardListPlayerEquipAlreadySaved) then return end
-	gShardListPlayerEquipAlreadySaved =3D true
-	ShardListSavePlayerMobile()
-	RegisterIntervalStepper(30*1000,ShardListSavePlayerMobile) =

-end)
-
-RegisterListener(&quot;Hook_Player_Skills&quot;,function (skills) =

-	if (gShardListPlayerSkillAlreadySaved) then return end
-	gShardListPlayerSkillAlreadySaved =3D true
-	ShardListSavePlayerMobile()
-end)
-
--- stores body,equip,mount       todo : skills, but change too often for x=
ml
-function ShardListSavePlayerMobile ()
-	local mobile =3D GetPlayerMobile()
-	print(&quot;###ShardListSavePlayerMobile&quot;,mobile,gPlayerSkills)
-	if (not mobile) then return end
-	if (not gPlayerSkills) then return end
-	local charname =3D gCharName
-	=

-	--[[
-	-- calc and check has, no need to save if nothing changed
-	local hash =3D {mobile.artid,mobile.hue}
-	for k,layer in pairs(gLayerType) do =

-		local item =3D mobile:GetEquipmentAtLayer(layer) =

-		if (item) then table.insert(hash,item.serial) end
-	end
-	for skillid,skill in pairs(gPlayerSkills) do table.insert(hash,skill.base=
_value) end
-	hash =3D table.concat(hash,&quot;#&quot;)
-	if (hash =3D=3D gShardListSavePlayerMobile_LastHash) then return end
-	gShardListSavePlayerMobile_LastHash =3D hash
-	print(&quot;saving data...&quot;,hash)
-	]]--
-	=

-	-- save the data
-	local data =3D {	charname=3Dcharname, artid=3Dmobile.artid, hue=3Dmobile.=
hue, xloc=3Dmobile.xloc, yloc=3Dmobile.yloc, zloc=3Dmobile.zloc, map=3DgMap=
Index, equip=3D{},skills=3D{} }
-	for k,layer in pairs(gLayerType) do =

-		local item =3D mobile:GetEquipmentAtLayer(layer) =

-		if (item) then data.equip[layer] =3D {artid=3Ditem.artid,hue=3Ditem.hue}=
 end
-	end
-	for skillid,skill in pairs(gPlayerSkills) do =

-		data.skills[skillid] =3D {value=3Dskill.value,base_value=3Dskill.base_va=
lue,lockstate=3Dskill.lockstate,name=3DglSkillNames[skillid]} =

-	end
-	data.time =3D os.time()
-	data.timetext =3D os.date(&quot;%d %b %Y %H:%M&quot;,data.time) -- 10 Feb 2009 16:1=
4       %H:%M:%S
-	SimpleXMLSave(GetCharFilePath(),data)
-end
-
--- ***** ***** ***** ***** ***** shard list =

-
-function LoadShardList () =

-	local path_folder =3D GetShardListDirPath()
-	local arr_files =3D dirlist(path_folder,false,true)
-	for k,filename in pairs(arr_files) do
-		local ext =3D string.lower(string.sub(filename,-4))
-		local shardname =3D string.sub(filename,1,-5)
-		local filepath =3D path_folder .. filename
-		print(&quot;LoadShardList&quot;,shardname,filepath,ext) =

-		if (ext =3D=3D &quot;.xml&quot;) then =

-			gShardList[shardname] =3D SimpleXMLLoad(filepath)
-		end
-	end
-end
- =

--- ***** ***** ***** ***** ***** shard memory =

-
-function LoadShardMemory	() gShardMemory =3D	SimpleXMLLoad(GetShardMemoryF=
ilePath()) or {} end
-function SaveShardMemory	()					SimpleXMLSave(GetShardMemoryFilePath(),gSh=
ardMemory) end
-
-function ShardMemoryGetList	(listname) return gShardMemory[listname] end
-function ShardMemoryGet		(listname,key) =

-	local list =3D gShardMemory[listname]
-	return list and list[key]
-end
-function ShardMemorySet		(listname,key,value)
-	local list =3D gShardMemory[listname]
-	if (not list) then list =3D {} gShardMemory[listname] =3D list end
-	list[key] =3D value
-	SaveShardMemory()
-	print(&quot;ShardMemorySet&quot;,listname,key)
-end
-
--- ***** ***** ***** ***** ***** stored passwords
-
--- store password when login succeeds
-RegisterListener(&quot;Hook_Packet_Server_List&quot;,function ()
-	if (not gRememberPassword) then return end
-	SetStoredPassword(gLoginServerIP,gLoginServerPort,gLoginname,gPassword)
-end)
-gStoredPasswords =3D {}
-function GetStoredPasswordsFilePath () return GetConfigDirPath()..&quot;passwor=
ds.xml&quot; end
-function SaveStoredPasswords () 					SimpleXMLSave(GetStoredPasswordsFileP=
ath(),gStoredPasswords) end
-function LoadStoredPasswords () gStoredPasswords =3D	SimpleXMLLoad(GetStor=
edPasswordsFilePath()) or {} end
-
-function GetStoredPassword			(host,port,username) return gStoredPasswords[=
host..&quot;:&quot;..port..&quot;:&quot;..username] end
-function SetStoredPassword			(host,port,username,password) gStoredPassword=
s[host..&quot;:&quot;..port..&quot;:&quot;..username] =3D password SaveStoredPasswords() end
-function ClearStoredPassword		(host,port,username) gStoredPasswords[host..=
&quot;:&quot;..port..&quot;:&quot;..username] =3D nil SaveStoredPasswords() end
-function ClearAllStoredPasswords	() gStoredPasswords =3D {} SaveStoredPass=
words() end
-
-function TestStoredPasswords ()
-	local host,port =3D &quot;example.org&quot;,2593
-	local user1 =3D &quot;weirdguy&quot;
-	local user2 =3D &quot;somedude&quot;
-	LoadStoredPasswords()
-	--~ SetStoredPassword(host,port,user1,&quot;secret1234&quot;)
-	--~ SetStoredPassword(host,port,user2,&quot;secret5555&quot;)
-	print(user1,GetStoredPassword(host,port,user1)) --~ weirdguy        secre=
t1234
-	print(user2,GetStoredPassword(host,port,user2)) --~ somedude        secre=
t5555
-	os.exit(0)
-end
-
+
+-- paths
+
+function GetConfigDirPath               () return gMainWorkingDir..&quot;config=
/&quot; end
+function GetShardListDirPath            () return GetConfigDirPath()..&quot;sha=
rds/&quot; end
+function GetShardMemoryFilePath         () return GetConfigDirPath()..&quot;sha=
rdmemory.xml&quot; end
+function GetCharFilePath                () return GetConfigDirPath()..&quot;cha=
rs/&quot;..table.concat({gLoginServerIP,gLoginServerPort,ShardListFileNamePartEn=
code(gLoginname),giGameServerID,gCharID},&quot;.&quot;)..&quot;.xml&quot; end
+function GetShardConfigFilePath         (shardname) return GetShardListDir=
Path()..ShardListFileNamePartEncode(shardname)..&quot;.xml&quot; end
+
+function ShardListFileNamePartEncode    (x) return string.gsub(x,&quot;[^0-9a-z=
A-Z_%-%(%) ]&quot;,&quot;.&quot;) end
+
+-- notes
+
+function InitShardList () =

+    LoadStoredPasswords()
+    LoadShardMemory()
+    LoadShardList()
+    --~ for shardname,shard in pairs(gShardList) do
+        --~ local filepath =3D GetShardConfigFilePath(shardname)
+        --~ print(&quot;InitShardList&quot;,shardname,shard,filepath)
+        --~ SimpleXMLSave(filepath,shard)
+    --~ end
+    --~ SimpleXML_Test()
+    --~ os.exit(0)
+end
+
+-- ***** ***** ***** ***** ***** chars
+
+RegisterListener(&quot;Hook_Packet_Character_List&quot;,function (charlist) =

+    local plaincharlist =3D {serverid=3DgiGameServerID}
+    for k,v in pairs(charlist.chars) do plaincharlist[k] =3D v.name end
+    plaincharlist.gLoginServerIP =3D gLoginServerIP
+    plaincharlist.gLoginServerPort =3D gLoginServerPort
+    plaincharlist.gLoginname =3D gLoginname
+    plaincharlist.giGameServerID =3D giGameServerID
+    ShardMemorySet(&quot;charlist&quot;,table.concat({gLoginServerIP,gLoginServerPor=
t,ShardListFileNamePartEncode(gLoginname),giGameServerID},&quot;:&quot;),plaincharlis=
t)
+end)
+
+RegisterListener(&quot;Hook_Player_Full_equip&quot;,function (mobiledata,equipmentda=
ta) =

+    if (gShardListPlayerEquipAlreadySaved) then return end
+    gShardListPlayerEquipAlreadySaved =3D true
+    ShardListSavePlayerMobile()
+    RegisterIntervalStepper(30*1000,ShardListSavePlayerMobile) =

+end)
+
+RegisterListener(&quot;Hook_Player_Skills&quot;,function (skills) =

+    if (gShardListPlayerSkillAlreadySaved) then return end
+    gShardListPlayerSkillAlreadySaved =3D true
+    ShardListSavePlayerMobile()
+end)
+
+-- stores body,equip,mount       todo : skills, but change too often for x=
ml
+function ShardListSavePlayerMobile ()
+    local mobile =3D GetPlayerMobile()
+    print(&quot;###ShardListSavePlayerMobile&quot;,mobile,gPlayerSkills)
+    if (not mobile) then return end
+    if (not gPlayerSkills) then return end
+    local charname =3D gCharName
+    =

+    --[[
+    -- calc and check has, no need to save if nothing changed
+    local hash =3D {mobile.artid,mobile.hue}
+    for k,layer in pairs(gLayerType) do =

+        local item =3D mobile:GetEquipmentAtLayer(layer) =

+        if (item) then table.insert(hash,item.serial) end
+    end
+    for skillid,skill in pairs(gPlayerSkills) do table.insert(hash,skill.b=
ase_value) end
+    hash =3D table.concat(hash,&quot;#&quot;)
+    if (hash =3D=3D gShardListSavePlayerMobile_LastHash) then return end
+    gShardListSavePlayerMobile_LastHash =3D hash
+    print(&quot;saving data...&quot;,hash)
+    ]]--
+    =

+    -- save the data
+    local data =3D {  charname=3Dcharname, artid=3Dmobile.artid, hue=3Dmob=
ile.hue, xloc=3Dmobile.xloc, yloc=3Dmobile.yloc, zloc=3Dmobile.zloc, map=3D=
gMapIndex, equip=3D{},skills=3D{} }
+    for k,layer in pairs(gLayerType) do =

+        local item =3D mobile:GetEquipmentAtLayer(layer) =

+        if (item) then data.equip[layer] =3D {artid=3Ditem.artid,hue=3Dite=
m.hue} end
+    end
+    for skillid,skill in pairs(gPlayerSkills) do =

+        data.skills[skillid] =3D {value=3Dskill.value,base_value=3Dskill.b=
ase_value,lockstate=3Dskill.lockstate,name=3DglSkillNames[skillid]} =

+    end
+    data.time =3D os.time()
+    data.timetext =3D os.date(&quot;%d %b %Y %H:%M&quot;,data.time) -- 10 Feb 2009 1=
6:14       %H:%M:%S
+    SimpleXMLSave(GetCharFilePath(),data)
+end
+
+-- ***** ***** ***** ***** ***** shard list =

+
+function LoadShardList () =

+    local path_folder =3D GetShardListDirPath()
+    local arr_files =3D dirlist(path_folder,false,true)
+    for k,filename in pairs(arr_files) do
+        local ext =3D string.lower(string.sub(filename,-4))
+        local shardname =3D string.sub(filename,1,-5)
+        local filepath =3D path_folder .. filename
+        print(&quot;LoadShardList&quot;,shardname,filepath,ext) =

+        if (ext =3D=3D &quot;.xml&quot;) then =

+            gShardList[shardname] =3D SimpleXMLLoad(filepath)
+        end
+    end
+end
+ =

+-- ***** ***** ***** ***** ***** shard memory =

+
+function LoadShardMemory    () gShardMemory =3D   SimpleXMLLoad(GetShardMe=
moryFilePath()) or {} end
+function SaveShardMemory    ()                  SimpleXMLSave(GetShardMemo=
ryFilePath(),gShardMemory) end
+
+function ShardMemoryGetList (listname) return gShardMemory[listname] end
+function ShardMemoryGet     (listname,key) =

+    local list =3D gShardMemory[listname]
+    return list and list[key]
+end
+function ShardMemorySet     (listname,key,value)
+    local list =3D gShardMemory[listname]
+    if (not list) then list =3D {} gShardMemory[listname] =3D list end
+    list[key] =3D value
+    SaveShardMemory()
+end
+
+-- ***** ***** ***** ***** ***** stored passwords
+
+-- store password when login succeeds
+RegisterListener(&quot;Hook_Packet_Server_List&quot;,function ()
+    if (not gRememberPassword) then return end
+    SetStoredPassword(gLoginServerIP,gLoginServerPort,gLoginname,gPassword)
+end)
+gStoredPasswords =3D {}
+function GetStoredPasswordsFilePath () return GetConfigDirPath()..&quot;passwor=
ds.xml&quot; end
+function SaveStoredPasswords ()                     SimpleXMLSave(GetStore=
dPasswordsFilePath(),gStoredPasswords) end
+function LoadStoredPasswords () gStoredPasswords =3D  SimpleXMLLoad(GetSto=
redPasswordsFilePath()) or {} end
+
+function GetStoredPassword          (host,port,username) return gStoredPas=
swords[host..&quot;:&quot;..port..&quot;:&quot;..username] end
+function SetStoredPassword          (host,port,username,password) gStoredP=
asswords[host..&quot;:&quot;..port..&quot;:&quot;..username] =3D password SaveStoredPasswords()=
 end
+function ClearStoredPassword        (host,port,username) gStoredPasswords[=
host..&quot;:&quot;..port..&quot;:&quot;..username] =3D nil SaveStoredPasswords() end
+function ClearAllStoredPasswords    () gStoredPasswords =3D {} SaveStoredP=
asswords() end


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001756.html">[Iris-commit] [IRIS] r2954 - /trunk/lua/lib.mainmenu.accountlist.lua
</A></li>
	<LI>Next message: <A HREF="001757.html">[Iris-commit] [IRIS] r2957 - /tools/installer/Iris_Setup.iss
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1758">[ date ]</a>
              <a href="thread.html#1758">[ thread ]</a>
              <a href="subject.html#1758">[ subject ]</a>
              <a href="author.html#1758">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/iris-commit">More information about the Iris-commit
mailing list</a><br>
</body></html>
